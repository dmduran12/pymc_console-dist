var e=Object.defineProperty,t=(t,r,a)=>((t,r,a)=>r in t?e(t,r,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[r]=a)(t,"symbol"!=typeof r?r+"":r,a);import{j as r,r as a,X as s,c as n,x as o,d as i}from"./vendor-react-j_fHog8x.js";import{D as c,o as l,L as d}from"./xterm-Cq-DlOOL.js";import{c as u,Z as p,bi as m,bE as h,bF as g,bG as f,bH as y,bI as x,bJ as v,bK as $,bL as b,bb as w,ac as _,bM as k,a4 as C,a3 as S,aG as M,bN as j,bO as N,bP as T,bx as R,V as E,bQ as A,W as I,B as F,A as L,m as B,bR as D,bS as O,b9 as P,q as U,bT as z,bU as H,bV as q,bW as K}from"./index-C0qk1KrQ.js";import{s as W}from"./signal-scoring-CcBiRcks.js";import{h as G,c as X,D as V}from"./geo-utils-wdurNbWQ.js";import{a as Y}from"./ping-n0dCQiSz.js";import{c as J}from"./vendor-core-CmkNwW1A.js";import{P as Q,d as Z}from"./payload-decoders-0mwwNsmU.js";import{g as ee,r as te}from"./system-Dg1W4FpH.js";import{g as re,K as ae,S as se}from"./KeycapButton-DRY6aFWR.js";import{P as ne,b as oe,B as ie,a as ce}from"./PageLayout-D4lbSqRE.js";import{S as le}from"./search-B2RIKgtG.js";import{C as de}from"./chevron-right-Bv-LusFN.js";import"./maplibre-gl-b91ci4Kr.js";import"./keycap-sfx-CAsrNe23.js";const ue=u("book-open-text",[["path",{d:"M12 7v14",key:"1akyts"}],["path",{d:"M16 12h2",key:"7q9ll5"}],["path",{d:"M16 8h2",key:"msurwy"}],["path",{d:"M3 18a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h5a4 4 0 0 1 4 4 4 4 0 0 1 4-4h5a1 1 0 0 1 1 1v13a1 1 0 0 1-1 1h-6a3 3 0 0 0-3 3 3 3 0 0 0-3-3z",key:"ruj8y"}],["path",{d:"M6 12h2",key:"32wvfc"}],["path",{d:"M6 8h2",key:"30oboj"}]]),pe=u("folders",[["path",{d:"M20 5a2 2 0 0 1 2 2v7a2 2 0 0 1-2 2H9a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h2.5a1.5 1.5 0 0 1 1.2.6l.6.8a1.5 1.5 0 0 0 1.2.6z",key:"a4852j"}],["path",{d:"M3 8.268a2 2 0 0 0-1 1.738V19a2 2 0 0 0 2 2h11a2 2 0 0 0 1.732-1",key:"yxbcw3"}]]),me=u("package",[["path",{d:"M11 21.73a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73z",key:"1a0edw"}],["path",{d:"M12 22V12",key:"d0xqtd"}],["polyline",{points:"3.29 7 12 12 20.71 7",key:"ousv84"}],["path",{d:"m7.5 4.27 9 5.15",key:"1c824w"}]]);class he{constructor(){t(this,"commands",[])}register(...e){this.commands.push(...e)}find(e){let t;for(const r of this.commands)r.matches(e)&&(!t||r.name.length>t.name.length)&&(t=r);return t}all(){return this.commands}}class ge{constructor(){t(this,"aliases",[]),t(this,"params")}matches(e){const t=e.toLowerCase().trim(),r=e=>t===e||t.startsWith(e+" ");return r(this.name)||this.aliases.some(r)}argsAfterName(e){const t=e.toLowerCase().trim(),r=[this.name,...this.aliases].sort((e,t)=>t.length-e.length);for(const a of r)if(t.startsWith(a))return e.trim().slice(a.length).trim();return e.trim()}}const fe="[",ye=`${fe}0m`,xe=`${fe}1m`,ve=`${fe}2m`,$e=`${fe}3m`,be=`${fe}32m`,we=`${fe}31m`,_e=`${fe}33m`,ke=`${fe}36m`,Ce=`${fe}34m`,Se=`${fe}90m`,Me=`${fe}92m`,je=`${fe}96m`;function Ne(e,t){switch(t){case"success":return`${be}${e}${ye}`;case"error":return`${we}${e}${ye}`;case"warning":return`${_e}${e}${ye}`;case"info":return`${ke}${e}${ye}`;case"value":return`${Ce}${e}${ye}`;case"system":return`${Se}${e}${ye}`;default:return e}}function Te(e){return`${xe}${e}${ye}`}function Re(e){return`${ve}${e}${ye}`}function Ee(e){return`${Ce}${e}${ye}`}function Ae(e){return`${Se}${e}${ye}`}function Ie(e,t){return`${Se}${e}: ${ye}${Ce}${xe}${t}${ye}`}function Fe(e,t,r=22){const a=e.split(" "),s=a[0];let n=ke;return"get"===s?n=be:"set"===s&&(n=_e),`  ${a.length>1?`${n}${xe}${s}${ye} ${Ce}${a.slice(1).join(" ")}${ye}`:`${n}${xe}${e}${ye}`}${" ".repeat(Math.max(1,r-e.length))}${Se}${t}${ye}`}function Le(e){return`${xe}${Ce}${e}${ye}`}function Be(e){return`${Se}${$e}${e}${ye}`}function De(e){return`${we}${xe}‚óè${ye} ${Se}${e}${ye}`}function Oe(e){const t=e<1e3?`${e.toFixed(0)}ms`:`${(e/1e3).toFixed(1)}s`;return`${function(e){return e<1500?Me:e<4e3?be:e<8e3?_e:e<15e3?we:`${we}${xe}`}(e)}${t}${ye}`}function Pe(e){switch(e){case"excellent":return je;case"good":return be;case"fair":return _e;case"poor":return we;case"critical":return`${we}${xe}`;default:return Se}}function Ue(e,t){return`${Pe(t)}${e}${ye}`}function ze(e){return e.replace(/[\p{Emoji_Presentation}\p{Extended_Pictographic}\uFE0F\u200D]/gu,"").trim()}const He="[2K\r";function qe(e=1){return`[${e}A`}const Ke="[?1049l",We="[?25h";function Ge(e){return e.replace(/\x1b\[[0-9;]*m/g,"")}function Xe(e){return Ge(e).length}function Ve(e,t){let r=0;for(const a of e){const e=Ge(a).length;r+=0===e?1:Math.ceil(e/t)}return r}function Ye(e,t){const r=function(e){return getComputedStyle(document.documentElement).getPropertyValue(e).trim()}(e);return r||t}function Je(){const e="light"===document.documentElement.dataset.mode,t=Ye("--terminal-bg","#0d0d0d"),r=Ye("--sys-blue",m.blue);if(e){const e="#EFF0F1";return{background:e,foreground:"#111314",cursor:m.blue,cursorAccent:e,selectionBackground:`${m.blue}30`,selectionForeground:"#111314",black:"#111314",red:m.red,green:m.green,yellow:m.amber,blue:m.blue,magenta:m.purple,cyan:m.cyan,white:e,brightBlack:p[500],brightRed:m.red,brightGreen:m.green,brightYellow:m.orange,brightBlue:m.indigo,brightMagenta:m.pink,brightCyan:m.teal,brightWhite:p[600]}}const a=Ye("--text-primary","#e0e0e0"),s=r+"40",n=Ye("--sys-red",m.red),o=Ye("--sys-green",m.green),i=Ye("--sys-purple",m.purple),c=Ye("--sys-blue",m.blue),l=Ye("--sys-cyan",m.cyan),d=Ye("--text-muted",p[500]),u=Ye("--text-secondary",p[400]);return{background:t,foreground:a,cursor:r,cursorAccent:t,selectionBackground:s,selectionForeground:a,black:Ye("--bg-surface",p[900]),red:n,green:o,yellow:i,blue:c,magenta:i,cyan:l,white:a,brightBlack:d,brightRed:n,brightGreen:"#4ADE80",brightYellow:i,brightBlue:c,brightMagenta:i,brightCyan:l,brightWhite:u}}const Qe="[",Ze=`${Qe}0m`,et=`${Qe}1m`,tt=`${Qe}2m`,rt=`${Qe}34m`,at=`${Qe}90m`,st="        ",nt=[{label:"INFORMATION",entries:[{cmd:"status",desc:"Repeater status summary",alias:"st"},{cmd:"top",desc:"Live system overview (Ctrl+C to exit)",alias:"htop"},{cmd:"ver",desc:"Version info",alias:"version"},{cmd:"clock",desc:"System UTC time"},{cmd:"uptime",desc:"System uptime"},{cmd:"board",desc:"Board / platform info"},{cmd:"packets",desc:"Packet statistics"},{cmd:"stats-packets",desc:"Packet counters (firmware compat)"},{cmd:"stats-radio",desc:"Radio health stats (firmware compat)"},{cmd:"stats-core",desc:"Engine vitals (firmware compat)"}]},{label:"NETWORK",entries:[{cmd:"neighbors [sort]",desc:"Direct RF neighbors",alias:"nb",sub:"sig ¬∑ name ¬∑ rssi ¬∑ snr ¬∑ dist ¬∑ heard"},{cmd:"ping {name}",desc:"Ping neighbor (name or 0xXX)"},{cmd:"identities",desc:"List configured identities",alias:"id ids"},{cmd:"keys",desc:"Transport keys"},{cmd:"acl",desc:"ACL statistics"},{cmd:"rooms",desc:"Room statistics"}]},{label:"RADIO",entries:[{cmd:"get {param}",desc:"Read parameter"},{cmd:"set {param} {value}",desc:"Write parameter"},{cmd:"advert",desc:"Send advertisement"}]},{label:"SYSTEM",entries:[{cmd:"restart",desc:"Restart service",alias:"reboot"},{cmd:"start cap [seconds]",desc:"Start packet capture"},{cmd:"end cap",desc:"Stop capture"},{cmd:"list cap",desc:"List captures"},{cmd:"export cap [id]",desc:"Download capture"}]},{label:"TOOLS",entries:[{cmd:"convert hex {value}",desc:"Hex ‚Üí base64"},{cmd:"convert base64 {value}",desc:"Base64 ‚Üí hex"},{cmd:"clear",desc:"Clear terminal",alias:"cls"},{cmd:"help [command]",desc:"Show this help",alias:"? h"}]}],ot=[{cat:"Identity",params:["name","role","lat","lon","public.key"]},{cat:"Radio",params:["radio","freq","tx","bw","sf","cr"]},{cat:"Timing",params:["txdelay","direct.txdelay","rxdelay"]},{cat:"Repeater",params:["mode","duty","repeat","flood.max","advert.interval"]},{cat:"Advanced",params:["multi.acks","int.thresh","agc.reset.interval"]},{cat:"set only",params:["log","prv.key"]}];function it(e){return`${at}${"‚îÄ".repeat(e)}${Ze}`}function ct(e){const t=Math.max(3,e-12-8-6);return`  ${rt}${et}pymc console${Ze} ${it(t)} ${at}terminal${Ze}`}function lt(e){return`  ${at}${e}${Ze}`}function dt(e,t){const r=[],a=e.alias?`  ${tt}${e.alias}${Ze}`:"";return 4+Math.max(e.cmd.length,24)+e.desc.length+(e.alias?2+e.alias.length:0)<=t?r.push("  "+Fe(e.cmd,e.desc,24)+a):(r.push("  "+Fe(e.cmd,"",24)),r.push(st+Ae(e.desc)+a)),e.sub&&r.push(`${st}${Re("‚îî "+e.sub)}`),r}function ut(e){return e.split(" ¬∑ ").map(e=>`${rt}${e}${Ze}`).join(`${at} ¬∑ ${Ze}`)}function pt(e,t){const r=[];let a=[],s=0;for(const n of e){const e=a.length>0?3+n.length:n.length;s+e>t&&a.length>0?(r.push(a),a=[n],s=n.length):(a.push(n),s+=e)}return a.length>0&&r.push(a),r}function mt(e){const t=["",lt("GET/SET QUALIFIERS")],r=Math.max(20,e-4-13);for(const a of ot){const e=`${at}${a.cat.padEnd(13)}${Ze}`,s=pt(a.params,r),n=" ".repeat(17);t.push(`    ${e}${ut(s[0].join(" ¬∑ "))}`);for(let r=1;r<s.length;r++)t.push(`${n}${ut(s[r].join(" ¬∑ "))}`)}return t}class ht extends ge{constructor(e){super(),t(this,"name","help"),t(this,"description","Show available commands"),t(this,"aliases",["?","h"]),this.registry=e}execute({output:e,rawInput:t,cols:r}){const a=this.argsAfterName(t).toLowerCase().trim();if(a&&"help"!==a){const t=this.registry.find(a+" help")||this.registry.find(a);return t?void t.execute({output:e,rawInput:t.name+" help",args:[t.name,"help"],cols:r,signal:(new AbortController).signal}):void e.write(`Unknown command: ${Ee(a)}`,"warning")}const s=[ct(r),""];for(const n of nt){s.push(lt(n.label));for(const e of n.entries)s.push(...dt(e,r));"RADIO"===n.label&&s.push(...mt(r)),s.push("")}s.push(...function(e){return[`  ${it(Math.min(e-4,56))}`,`  ${Be("<command> help for detailed usage")}`]}(r)),e.write(s.join("\n"))}}class gt extends ge{constructor(){super(...arguments),t(this,"name","clear"),t(this,"description","Clear terminal screen"),t(this,"aliases",["cls"])}execute({output:e,rawInput:t}){"help"!==this.argsAfterName(t).toLowerCase().trim()?e.clear():e.write([Le("clear"),`  ${Ae("Clear all terminal output.")}`,"",Fe("clear","clear the screen"),"",Le("Aliases"),`  ${Ae("cls")}`].join("\n"))}}function ft(e){const t=Math.floor(e/86400),r=Math.floor(e%86400/3600),a=Math.floor(e%3600/60);return t>0?`${t}d ${r}h ${a}m`:r>0?`${r}h ${a}m`:`${a}m`}class yt extends ge{constructor(){super(...arguments),t(this,"name","status"),t(this,"description","Get repeater status summary"),t(this,"aliases",["st"])}async execute({output:e,rawInput:t}){var r,a,s;if("help"===this.argsAfterName(t).toLowerCase().trim())return void e.write([Le("status"),`  ${Ae("Show a quick summary of mode, neighbor count, and uptime.")}`,"",Fe("status","show summary"),"",Le("Aliases"),`  ${Ae("st")}`].join("\n"));const n=e.write("processing...","system");try{const t=await g(),o=(null==(a=null==(r=t.config)?void 0:r.repeater)?void 0:a.mode)||"unknown",i=Object.keys(t.neighbors||{}).length,c=Object.values(t.neighbors||{}).filter(e=>e.zero_hop).length,l=(null==(s=t.config)?void 0:s.node_name)||t.node_name||"unknown",d=ft(t.uptime_seconds||0);e.update(n,[`${Te(l)}  ${Ae("repeater")}`,"",`  ${Ie("Mode",Ee(o))}`,`  ${Ie("Neighbors",`${Ee(String(c))} direct  ${Ae(`${i} total`)}`)}`,`  ${Ie("RX / TX",`${Ee(String(t.rx_count??0))} / ${Ee(String(t.tx_count??0))}`)}`,`  ${Ie("Uptime",Ee(d))}`].join("\n"))}catch(o){e.update(n,`Error: ${o instanceof Error?o.message:"Command failed"}`,"error")}}}class xt extends ge{constructor(){super(...arguments),t(this,"name","uptime"),t(this,"description","Show system uptime")}async execute({output:e,rawInput:t}){if("help"===this.argsAfterName(t).toLowerCase().trim())return void e.write([Le("uptime"),`  ${Ae("Display how long the repeater service has been running.")}`,"",Fe("uptime","show uptime")].join("\n"));const r=e.write("processing...","system");try{const t=await g();e.update(r,Ie("Uptime",Ee(ft(t.uptime_seconds||0))))}catch(a){e.update(r,`Error: ${a instanceof Error?a.message:"Command failed"}`,"error")}}}class vt extends ge{constructor(){super(...arguments),t(this,"name","packets"),t(this,"description","Show packet statistics")}async execute({output:e,rawInput:t}){if("help"===this.argsAfterName(t).toLowerCase().trim())return void e.write([Le("packets"),`  ${Ae("Display packet counters (received, transmitted, forwarded, dropped).")}`,"",Fe("packets","show packet stats")].join("\n"));const r=e.write("processing...","system");try{const t=await g(),a=(t.rx_count??0)+(t.tx_count??0);e.update(r,[Le("Packet Stats")+`  ${Ae(`${a} total`)}`,"",`  ${Ie("Received",Ee(String(t.rx_count??0)))}`,`  ${Ie("Transmitted",Ee(String(t.tx_count??0)))}`,`  ${Ie("Forwarded",Ee(String(t.forwarded_count??0)))}`,`  ${Ie("Dropped",Ee(String(t.dropped_count??0)))}`].join("\n"))}catch(a){e.update(r,`Error: ${a instanceof Error?a.message:"Command failed"}`,"error")}}}function $t(e){return e>=1073741824?`${(e/1073741824).toFixed(1)} GB`:e>=1048576?`${(e/1048576).toFixed(0)} MB`:`${(e/1024).toFixed(0)} KB`}function bt(e){const t=Math.floor(e/86400),r=Math.floor(e%86400/3600),a=Math.floor(e%3600/60);return t>0?`${t}d ${r}h ${a}m`:r>0?`${r}h ${a}m`:`${a}m`}class wt extends ge{constructor(){super(...arguments),t(this,"name","board"),t(this,"description","Show board/platform info")}async execute({output:e,rawInput:t}){var r;if("help"===this.argsAfterName(t).toLowerCase().trim())return void e.write([Le("board"),`  ${Ae("Display platform and hardware information.")}`,"",Fe("board","show board info")].join("\n"));const a=e.write("loading...","system");try{const[t,s]=await Promise.all([f(),g()]),n=[];if(n.push(`  ${Ie("Node",Ee(s.node_name||"Unknown"))}`),n.push(`  ${Ie("Runtime",Ee(`pyMC_Repeater v${s.version||"?"}`))}`),s.core_version&&n.push(`  ${Ie("Core",Ee(s.core_version))}`),n.push(""),t.success&&t.data){const e=t.data;n.push(`  ${Ie("CPU",Ee(`${e.cpu.usage_percent.toFixed(1)}%`))}  ${Ae(`${e.cpu.count} core${e.cpu.count>1?"s":""}`)}`),e.cpu.load_avg&&n.push(`  ${Ie("Load",Ee(`${e.cpu.load_avg["1min"].toFixed(2)} / ${e.cpu.load_avg["5min"].toFixed(2)} / ${e.cpu.load_avg["15min"].toFixed(2)}`))}`);const a=Object.entries(e.temperatures||{});if(a.length>0){const e=a[0];n.push(`  ${Ie("Temp",Ee(`${e[1].toFixed(1)}¬∞C`))}${a.length>1?`  ${Ae(a.slice(1).map(([e,t])=>`${e}: ${t.toFixed(1)}¬∞C`).join(", "))}`:""}`)}n.push(""),n.push(`  ${Ie("Memory",Ee(`${$t(e.memory.used)} / ${$t(e.memory.total)}`))}  ${Ae(`${e.memory.usage_percent.toFixed(0)}%`)}`),n.push(`  ${Ie("Disk",Ee(`${$t(e.disk.used)} / ${$t(e.disk.total)}`))}  ${Ae(`${e.disk.usage_percent.toFixed(0)}%`)}`),n.push(""),(null==(r=e.system)?void 0:r.uptime)&&n.push(`  ${Ie("System uptime",Ee(bt(e.system.uptime)))}`),n.push(`  ${Ie("Service uptime",Ee(bt(s.uptime_seconds)))}`),e.network&&n.push(`  ${Ie("Net TX/RX",Ee(`${$t(e.network.bytes_sent)} / ${$t(e.network.bytes_recv)}`))}`)}else n.push(`  ${Ie("Platform",Ee("Linux"))}`),n.push(`  ${Ie("Service uptime",Ee(bt(s.uptime_seconds)))}`),n.push(`  ${Ae("Hardware stats unavailable")}`);e.update(a,n.join("\n"),"value")}catch(s){e.update(a,`Error: ${s instanceof Error?s.message:"Failed to load hardware stats"}`,"error")}}}const _t="[0m",kt="[1m",Ct="[2m",St="[36m",Mt="[96m",jt=48;function Nt(e,t,r,a){return s=>{if(s<=0)return 0;if(s>=1)return 1;let n=s;for(let t=0;t<8;t++){const t=3*(1-n)*(1-n)*n*e+3*(1-n)*n*n*r+n*n*n-s,a=3*(1-n)*(1-n)*e+6*(1-n)*n*(r-e)+3*n*n*(1-r);if(Math.abs(a)<1e-7)break;n=Math.max(0,Math.min(1,n-t/a))}return 3*(1-n)*(1-n)*n*t+3*(1-n)*n*n*a+n*n*n}}const Tt=Nt(.25,1,.5,1),Rt=Nt(.4,0,1,1);function Et(e,t){const r=e%14;return Math.sin(.45*r+.04*r*r+.25*t)}const At=[8,16,32,128],It=[1,2,4,64].map((e,t)=>e|At[t]);function Ft(e,t,r,a){a<4?e[r]|=It[a]:t[r]|=It[a-4]}function Lt(e){return e>.8?"[97m"+kt:e>.6?"[93m"+kt:e>.4?Mt+kt:e>.2?Mt:e>.08?St:St+Ct}function Bt(e,t,r){const a=new Uint8Array(jt),s=new Uint8Array(jt),n=new Float32Array(jt),o=.35*e;for(let i=0;i<jt;i++){const c=r?47-i:i;if(c>=t)continue;const l=t-c,d=Math.min(1,l/3),u=Math.min(1,c/2),p=l<5?1+.3*(1-l/5):1,m=Math.min(1,d*u*p);if(m<.04)continue;const h=1+.06*Math.sin(.7*e+.3*c),g=Et(c,o)*m*h*3.5+3.5,f=Math.abs(g-3.5)/3.5,y=l<6?1-l/6:0;n[i]=Math.min(1,.65*f+.35*y)*m;const x=Math.max(0,Math.min(7,Math.round(g)));if(g>=3.5){for(let t=3;t<=x;t++)Ft(a,s,i,t);const e=Math.round(.4*(g-3.5));for(let t=Math.max(0,3-e);t<3;t++)Ft(a,s,i,t)}else{for(let t=x;t<=4;t++)Ft(a,s,i,t);const e=Math.round(.4*(3.5-g));for(let t=5;t<=Math.min(7,4+e);t++)Ft(a,s,i,t)}}return{top:a,bot:s,heat:n}}function Dt(e,t,r){const a=new Uint8Array(jt),s=new Uint8Array(jt),n=new Float32Array(jt),o=Math.exp(.5*-t),i=Math.max(0,10-2.5*t),c=.7+.2*t;for(let l=0;l<Math.ceil(i);l++){const t=e?47-l:l;if(t<0||t>=jt)continue;const d=o*(1-l/i);if(d<.04)continue;n[t]=d;const u=Math.sin(l*c+.6*r)*d*3.5+3.5,p=Math.max(0,Math.min(7,Math.round(u)));if(u>=3.5)for(let e=3;e<=p;e++)Ft(a,s,t,e);else for(let e=p;e<=4;e++)Ft(a,s,t,e)}return{top:a,bot:s,heat:n}}function Ot(e,t){let r="",a="";for(let s=0;s<jt;s++){const n=String.fromCodePoint(10240+e[s]),o=e[s]?Lt(t[s]):"";o!==a&&(r+=o,a=o),r+=n}return r+_t}function Pt(e,t,r){const a=e%54;let s,n,o;if(a<22){const t=a/21;({top:s,bot:n,heat:o}=Bt(e,Math.round(Tt(t)*jt),!1))}else if(a<27)({top:s,bot:n,heat:o}=Dt(!0,a-22,e));else if(a<49){const t=(a-22-5)/21;({top:s,bot:n,heat:o}=Bt(e,Math.round(Rt(t)*jt),!0))}else({top:s,bot:n,heat:o}=Dt(!1,a-22-5-22,e));const i=(r/1e3).toFixed(1),c=`${Ct} ‚îÄ‚îÄ chirp ‚Üí ${_t}${kt}${t}${_t}${Ct} ‚îÄ‚îÄ ${i}s${_t}`;return[Ot(s,o),Ot(n,o),c]}function Ut(e,t){const r=Date.now();let a=0;const s=e.write(Pt(0,t,0).join("\n")),n=setInterval(()=>{a++,e.update(s,Pt(a,t,Date.now()-r).join("\n"))},50);return{id:s,stop:()=>clearInterval(n)}}class zt extends ge{constructor(){super(...arguments),t(this,"name","advert"),t(this,"description","Send repeater advertisement")}async execute({output:e,rawInput:t}){if("help"===this.argsAfterName(t).toLowerCase().trim())return void e.write([Le("advert"),`  ${Ae("Broadcast a repeater advertisement to the mesh network.")}`,"",Fe("advert","send advert now"),"",Be("Adverts announce this repeater's presence to neighbors.")].join("\n"));const r=Ut(e,"broadcast");try{const t=await y();r.stop(),t.success?e.update(r.id,`‚úì ${Ee("Advert sent")}`,"success"):e.update(r.id,`Error: ${t.error||"Failed"}`,"error")}catch(a){r.stop(),e.update(r.id,`Error: ${a instanceof Error?a.message:"Command failed"}`,"error")}}}const Ht=["sig","name","rssi","snr","dist","heard"],qt={excellent:5,good:4,fair:3,poor:2,critical:1};function Kt(e){const t=Math.floor(Date.now()/1e3-e);return t<60?`${t}s ago`:t<3600?`${Math.floor(t/60)}m ago`:t<86400?`${Math.floor(t/3600)}h ago`:`${Math.floor(t/86400)}d ago`}function Wt(e){return e<1e3?`${Math.round(e)}m`:`${(e/1e3).toFixed(1)}km`}const Gt={excellent:5,good:4,fair:3,poor:2,critical:1};function Xt(e){const t=Gt[e]??0,r=Pe(e);return(t>0?`${r}${"‚ñà".repeat(t)}${ye}`:"")+Ae("‚£ø".repeat(5-t))}function Vt(e,t=e=>e){return{text:e,color:t}}function Yt(e){return Ae("+"+e.map(e=>"-".repeat(e+2)).join("+")+"+")}function Jt(e,t){const r=e.map((e,r)=>{if(null!=e.rendered){const a=Math.max(0,t[r]-e.text.length);return" "+e.rendered+" ".repeat(a)+" "}return" "+e.color((a=e.text,s=t[r],a.length>=s?a.slice(0,s):a+" ".repeat(s-a.length)))+" ";var a,s});return Ae("|")+r.join(Ae("|"))+Ae("|")}class Qt extends ge{constructor(){super(...arguments),t(this,"name","neighbors"),t(this,"description","Show direct RF neighbors with signal stats"),t(this,"aliases",["nb","get neighbors","get neighbor"]),t(this,"params","[sig|name|rssi|snr|dist|heard]")}async execute(e){const{output:t,cols:r}=e,a=this.argsAfterName(e.rawInput).toLowerCase().trim();if("help"===a)return void this.printUsage(t);const s=Ht.includes(a)?a:null,n=t.write("processing...","system");try{const e=await g(),a=e.neighbors||{},o=Object.entries(a).filter(([,e])=>e.zero_hop);if(0===o.length){const e=Object.keys(a).length;return void t.update(n,e>0?`No direct neighbors. ${e} relayed neighbor${1!==e?"s":""} known.`:"No neighbors discovered yet.","warning")}const i=function(e){var t;const r=null==(t=e.config)?void 0:t.radio;return(null==r?void 0:r.spreading_factor)&&(null==r?void 0:r.bandwidth)?{sf:r.spreading_factor,bwHz:r.bandwidth}:null}(e),c=function(e){var t;const r=null==(t=e.config)?void 0:t.repeater;return r&&G(r.latitude,r.longitude)?{lat:r.latitude,lon:r.longitude}:null}(e),l=e.noise_floor_dbm;this.sortNeighbors(o,s,i,c,l);const d=s?`  ${Re(`sorted by ${s}`)}`:"",u=[Le(`Direct Neighbors (${o.length})`)+d,""];if(r<55)for(const[t,r]of o)u.push(...this.cardLayout(t,r,i,c,l));else{const e=r>=70&&null!=c,t=o.map(([t,r])=>this.buildRow(t,r,i,c,l,e)),a=e?["SIG","NAME","RSSI","SNR","DIST","HEARD"]:["SIG","NAME","RSSI","SNR","HEARD"],s=a.slice(1).map((e,r)=>Math.max(e.length,...t.map(e=>e[r+1].text.length))),n=5,d=s.reduce((e,t)=>e+t+3,0),p=Math.max(4,r-d-n-7),m=[n,Math.min(p,Math.max(4,...t.map(e=>e[1].text.length))),...s.slice(1)];u.push(Yt(m),...t.map(e=>Jt(e,m)),Yt(m),Jt(a.map(e=>Vt(e,Te)),m),Yt(m)),u.push(this.footer(i,l))}t.update(n,u.join("\n"))}catch(o){t.update(n,`Error: ${o instanceof Error?o.message:"Command failed"}`,"error")}}sortNeighbors(e,t,r,a,s){switch(t){case"sig":e.sort(([,e],[,t])=>(qt[this.gradeNeighbor(e,r,s)]??0)-(qt[this.gradeNeighbor(t,r,s)]??0));break;case"name":e.sort(([e,t],[r,a])=>{const s=(t.name||t.node_name||e.slice(0,8)).toLowerCase(),n=(a.name||a.node_name||r.slice(0,8)).toLowerCase();return s.localeCompare(n)});break;case"rssi":e.sort(([,e],[,t])=>(e.rssi??-999)-(t.rssi??-999));break;case"snr":e.sort(([,e],[,t])=>(e.snr??-999)-(t.snr??-999));break;case"dist":e.sort(([,e],[,t])=>(this.distTo(e,a)??1/0)-(this.distTo(t,a)??1/0));break;case"heard":e.sort(([,e],[,t])=>(e.last_seen||0)-(t.last_seen||0));break;default:e.sort(([,e],[,t])=>(t.last_seen||0)-(e.last_seen||0))}}gradeNeighbor(e,t,r){const a=null!=e.rssi?e.rssi-3.5:null,s=null!=r&&r>-100?1:0,n=W(e.snr??null,a,t,s);return(null==n?void 0:n.finalGrade)??"critical"}distTo(e,t){return t&&G(e.latitude,e.longitude)?X(t.lat,t.lon,e.latitude,e.longitude):null}buildRow(e,t,r,a,s,n){const o=this.gradeNeighbor(t,r,s),i=ze(t.name||t.node_name||e.slice(0,8))||e.slice(0,8),c=null!=t.rssi?`${t.rssi} dBm`:"-",l=null!=t.snr?`${t.snr} dB`:"-",d=t.last_seen?Kt(t.last_seen):"-",u=[(p=Xt(o),{text:"|||||",color:e=>e,rendered:p}),Vt(i,Te),Vt(c,Ee),Vt(l,Ee)];var p;if(n){const e=this.distTo(t,a);u.push(Vt(null!=e?Wt(e):"-",Re))}return u.push(Vt(d,Re)),u}cardLayout(e,t,r,a,s){const n=this.gradeNeighbor(t,r,s),o=ze(t.name||t.node_name||e.slice(0,8))||e.slice(0,8),i=null!=t.rssi?`${t.rssi}`:"-",c=null!=t.snr?`${t.snr}`:"-",l=t.last_seen?Kt(t.last_seen):"-",d=this.distTo(t,a),u=null!=d?`  ${Ae("dist")} ${Ee(Wt(d))}`:"";return[`${Xt(n)} ${Te(o)}`,`  ${Ae("rssi")} ${Ee(i)}  ${Ae("snr")} ${Ee(c)}${u}  ${Re(l)}`,""]}footer(e,t){const r=[];return e&&r.push(`SF${e.sf}/${e.bwHz>=1e3?e.bwHz/1e3+"kHz":e.bwHz+"Hz"}`),r.push("ant 3.5dBi"),null!=t&&r.push(`nf ${t}dBm`),Ae(r.join("  "))}printUsage(e){const t=[Le("neighbors"),`  ${Ae("Show direct RF neighbors with signal quality, RSSI, SNR, and distance.")}`,"",Le("Usage"),Fe("neighbors","default sort (most recent)"),Fe("neighbors sig","sort by signal grade (weakest first)"),Fe("neighbors name","sort alphabetically"),Fe("neighbors rssi","sort by RSSI (weakest first)"),Fe("neighbors snr","sort by SNR (lowest first)"),Fe("neighbors dist","sort by distance (closest first)"),Fe("neighbors heard","sort by last seen (oldest first)"),Fe("neighbors help","show this help"),"",Le("Aliases"),`  ${Ae("nb, get neighbors, get neighbor")}`,"",Be("Signal bars factor radio config, noise floor, and 3.5 dBi antenna gain."),Be("Only zero-hop (direct RF) neighbors are shown.")];e.write(t.join("\n"))}}class Zt extends ge{constructor(){super(...arguments),t(this,"name","get"),t(this,"description","Get repeater parameter"),t(this,"params","{parameter}")}async execute({output:e,rawInput:t}){const r=this.argsAfterName(t).toLowerCase().trim();if("help"===r||!r)return void e.write([Le("get"),`  ${Ae("Read a repeater configuration parameter.")}`,"",Le("Identity"),Fe("get name","node name"),Fe("get role","node role"),Fe("get public.key","public key"),"",Le("Location"),Fe("get lat","latitude"),Fe("get lon","longitude"),"",Le("Radio"),Fe("get radio","full radio summary"),Fe("get freq","frequency (MHz)"),Fe("get tx","TX power (dBm)"),Fe("get bw","bandwidth (kHz)"),Fe("get sf","spreading factor"),Fe("get cr","coding rate"),"",Le("Timing"),Fe("get af","airtime factor (pending backend)"),Fe("get txdelay","TX delay factor"),Fe("get direct.txdelay","direct TX delay"),Fe("get rxdelay","RX delay base"),"",Le("Repeater"),Fe("get mode","forward or monitor"),Fe("get flood.max","max flood hops"),Fe("get advert.interval","advert interval"),Fe("get duty","duty cycle state"),"",Le("Advanced"),Fe("get multi.acks","multi-ack count"),Fe("get int.thresh","interference threshold (dBm)"),Fe("get agc.reset.interval","AGC reset interval")].join("\n"));const a=e.write("processing...","system");try{const t=await g(),{result:s,type:n}=function(e,t){const r=t.config||{},a=r.radio||{},s=r.repeater||{},n=r.delays||{},o=r.duty_cycle||{},i=(e,t)=>({result:Ie(e,Ee(t)),type:"value"});switch(e){case"name":return i("name",r.node_name||"Unknown");case"role":return i("role","repeater");case"lat":return i("lat",null!=s.latitude?String(s.latitude):"not set");case"lon":return i("lon",null!=s.longitude?String(s.longitude):"not set");case"freq":return i("freq",a.frequency?`${(a.frequency/1e6).toFixed(3)} MHz`:"?");case"tx":return i("tx",null!=a.tx_power?`${a.tx_power} dBm`:"?");case"bw":return i("bw",a.bandwidth?a.bandwidth/1e3+" kHz":"?");case"sf":return i("sf",String(a.spreading_factor??"?"));case"cr":return i("cr",a.coding_rate?`4/${a.coding_rate}`:"?");case"radio":return a.frequency?{result:[`  ${Ie("freq",Ee(`${(a.frequency/1e6).toFixed(3)} MHz`))}`,`  ${Ie("bw",Ee(a.bandwidth/1e3+" kHz"))}`,`  ${Ie("sf",Ee(String(a.spreading_factor)))}`,`  ${Ie("cr",Ee(`4/${a.coding_rate}`))}`,`  ${Ie("tx",Ee(`${a.tx_power} dBm`))}`].join("\n"),type:"value"}:i("radio","?");case"af":case"airtime.factor":return{result:`${Ae("airtime_factor is not yet exposed by the pyMC_Repeater API.")}\n${Ae("Firmware range: 0-9. Controls airtime budget fraction.")}\n${Ae("Tracked in CLI-Alignment.md ‚Äî needs backend support.")}`,type:"warning"};case"txdelay":return i("txdelay",String(n.tx_delay_factor??"1.0"));case"direct.txdelay":return i("direct.txdelay",String(n.direct_tx_delay_factor??"0.5"));case"rxdelay":return i("rxdelay",String(n.rx_delay_base??"0.0"));case"mode":return i("mode",s.mode||"forward");case"repeat":return i("repeat","forward"===s.mode?"on":"off");case"flood.max":return i("flood.max",String(s.max_flood_hops??"3"));case"flood.advert.interval":return i("flood.advert.interval",null!=s.send_advert_interval_hours?`${s.send_advert_interval_hours}h`:"?");case"advert.interval":return i("advert.interval",null!=s.advert_interval_minutes?`${s.advert_interval_minutes}m`:"120m");case"duty":case"duty.enabled":return i("duty",o.enforcement_enabled?"on":"off");case"duty.max":return i("duty.max",null!=o.max_airtime_percent?`${o.max_airtime_percent}%`:"?");case"multi.acks":return i("multi.acks",String(s.multi_acks??"0"));case"int.thresh":return i("int.thresh",`${s.interference_threshold??-120} dBm`);case"agc.reset.interval":return i("agc.reset.interval",String(s.agc_reset_interval??"0"));case"public.key":return i("public.key",t.public_key||"not available");case"prv.key":return{result:`${Ae("Private key stored in /etc/pymc_repeater/config.yaml")}\n\n  ${Ie("view",Ee("sudo grep identity_key /etc/pymc_repeater/config.yaml"))}\n  ${Ie("set",Ee("sudo ./convert_firmware_key.sh <64-byte-hex>"))}`,type:"info"};case"guest.password":case"allow.read.only":return{result:`${Ae("Security settings not exposed via stats API.")}\n${Ae("Check /etc/pymc_repeater/config.yaml")}`,type:"warning"};default:return{result:`Unknown parameter: ${Ee(e)}\n${Ae('Run "get help" to see available parameters.')}`,type:"error"}}}(r,t);e.update(a,s,n)}catch(s){e.update(a,`Error: ${s instanceof Error?s.message:"Command failed"}`,"error")}}}class er extends ge{constructor(){super(...arguments),t(this,"name","set"),t(this,"description","Set repeater parameter"),t(this,"params","{parameter} {value}")}async execute({output:e,rawInput:t}){var r;const a=this.argsAfterName(t).split(/\s+/),s=null==(r=a[0])?void 0:r.toLowerCase(),n=a.slice(1).join(" ");if("help"===s||!s)return void e.write([Le("set"),`  ${Ae("Write a repeater configuration parameter.")}`,"",Le("Identity"),Fe("set name <name>","node name"),Fe("set lat <deg>","latitude (-90 to 90)"),Fe("set lon <deg>","longitude (-180 to 180)"),"",Le("Radio"),Fe("set freq <MHz>","frequency"),Fe("set tx <dBm>","TX power (2-22)"),Fe("set bw <kHz>","bandwidth"),Fe("set sf <5-12>","spreading factor"),Fe("set cr <5-8>","coding rate"),"",Le("Timing"),Fe("set af <0-9>","airtime factor (pending backend)"),Fe("set txdelay <0-5>","TX delay factor"),Fe("set direct.txdelay <0-5>","direct TX delay"),Fe("set rxdelay <n>","RX delay base"),"",Le("Repeater"),Fe("set mode <fwd|mon>","forward or monitor"),Fe("set flood.max <0-64>","max flood hops"),Fe("set advert.interval <m>","advert interval (min)"),Fe("set duty <on|off>","duty cycle enforcement"),Fe("set log <level>","log level"),"",Le("Advanced"),Fe("set multi.acks <n>","multi-ack count"),Fe("set int.thresh <dBm>","interference threshold"),Fe("set agc.reset.interval <n>","AGC reset interval (x4)"),"",Be("Some changes require a service restart.")].join("\n"));const o=e.write("processing...","system");try{const{result:r,type:a}=await async function(e,t,r){switch(e){case"mode":return async function(e){const t=e.toLowerCase();return"forward"!==t&&"monitor"!==t?ir('Mode must be "forward" or "monitor"'):(await b(t)).success?or(`OK - Mode set to ${t}`):ir("Failed")}(t);case"duty":return async function(e){const t="on"===e.toLowerCase()||"1"===e;return(await $(t)).success?or("OK - Duty cycle "+(t?"enabled":"disabled")):ir("Failed")}(t);case"tx":return tr("tx_power",ar(t,2,22,"TX power must be 2-22 dBm"));case"sf":return tr("spreading_factor",ar(t,5,12,"SF must be 5-12"));case"af":case"airtime.factor":return{result:"Error: airtime_factor is not yet exposed by the pyMC_Repeater API.\nFirmware range: 0-9. Tracked in CLI-Alignment.md ‚Äî needs backend support.",type:"info"};case"txdelay":return tr("tx_delay_factor",sr(t,0,5,"TX delay must be 0.0-5.0"));case"direct.txdelay":return tr("direct_tx_delay_factor",sr(t,0,5,"Direct TX delay must be 0.0-5.0"));case"rxdelay":return tr("rx_delay_base",function(e){const t=parseFloat(e);return isNaN(t)||t<0?{ok:!1,error:"Error: RX delay must be >= 0"}:{ok:!0,value:t}}(t));case"flood.max":return tr("max_flood_hops",ar(t,0,64,"Max flood hops must be 0-64"));case"log":return async function(e){const t=e.toUpperCase();if(!["DEBUG","INFO","WARNING","ERROR"].includes(t))return ir("Level must be debug, info, warning, or error");const r=await v(t);return r.success?or(`OK - Log level set to ${t}`):ir(r.error||"Failed")}(t);case"multi.acks":return tr("multi_acks",ar(t,0,255,"Multi-acks must be 0-255"));case"int.thresh":return tr("interference_threshold",ar(t,-200,0,"Interference threshold must be -200 to 0 dBm"));case"agc.reset.interval":{const e=nr(t);if(!e.ok)return ir(e.error);if(e.value<0)return ir("AGC reset interval must be >= 0");const r=4*Math.floor(e.value/4);return rr("agc_reset_interval",r,`OK - AGC reset interval set to ${r}${r!==e.value?` (rounded from ${e.value})`:""}`)}case"name":{const e=r.trim().substring(r.toLowerCase().indexOf("name")+5).trim();return e?/[\[\]\\/\\:,?*]/.test(e)?ir("Name contains invalid characters: [ ] \\ / : , ? * are not allowed"):tr("node_name",{ok:!0,value:e}):ir("Node name cannot be empty")}case"lat":return tr("latitude",sr(t,-90,90,"Latitude must be -90 to 90"));case"lon":return tr("longitude",sr(t,-180,180,"Longitude must be -180 to 180"));case"freq":{const e=sr(t,100,1e3,"Frequency must be 100-1000 MHz");return e.ok?tr("frequency",{ok:!0,value:1e6*e.value}):ir(e.error)}case"bw":{const e=[7.8,10.4,15.6,20.8,31.25,41.7,62.5,125,250,500],r=parseFloat(t);return isNaN(r)||!e.includes(r)?ir(`BW must be one of: ${e.join(", ")} kHz`):tr("bandwidth",{ok:!0,value:1e3*r})}case"cr":return tr("coding_rate",ar(t,5,8,"Coding rate must be 5-8"));case"advert.interval":{const e=nr(t);return e.ok?0!==e.value&&(e.value<1||e.value>10080)?ir("Advert interval must be 0 (off) or 1-10080 minutes"):rr("advert_interval_minutes",e.value,0===e.value?"OK - Local adverts disabled":`OK - Local advert interval set to ${e.value}m`):ir(e.error)}case"flood.advert.interval":{const e=nr(t);return e.ok?0!==e.value&&(e.value<3||e.value>168)?ir("Flood advert interval must be 0 (off) or 3-168 hours"):rr("flood_advert_interval_hours",e.value,0===e.value?"OK - Flood adverts disabled":`OK - Flood advert interval set to ${e.value}h`):ir(e.error)}case"prv.key":{const e=t.trim();return e?/^[0-9a-fA-F]+$/.test(e)?128!==e.length?ir(`Key must be 64 bytes (128 hex chars), got ${e.length} chars`):{result:`To set this key, run on the Pi:\n\n  sudo ./convert_firmware_key.sh ${e}\n\nThen restart: sudo systemctl restart pymc-repeater`,type:"info"}:ir("Private key must be a hex string"):ir("Private key cannot be empty")}default:return ir(`Unknown parameter: ${e}`)}}(s,n,t);e.update(o,r,a)}catch(i){e.update(o,`Error: ${i instanceof Error?i.message:"Command failed"}`,"error")}}}async function tr(e,t){if(!t.ok)return ir(t.error);const r=await x({[e]:t.value});if(!r.success)return ir(r.error||"Failed");let a=`OK - ${e} set to ${t.value}`;return r.restart_required&&(a+="\n‚ö† Service restart required for changes to take effect\nRun: sudo systemctl restart pymc_repeater"),or(a)}async function rr(e,t,r){const a=await x({[e]:t});if(!a.success)return ir(a.error||"Failed");let s=r;return a.restart_required&&(s+="\n‚ö† Service restart required for changes to take effect\nRun: sudo systemctl restart pymc_repeater"),or(s)}function ar(e,t,r,a){const s=parseInt(e);return isNaN(s)||s<t||s>r?{ok:!1,error:`Error: ${a}`}:{ok:!0,value:s}}function sr(e,t,r,a){const s=parseFloat(e);return isNaN(s)||s<t||s>r?{ok:!1,error:`Error: ${a}`}:{ok:!0,value:s}}function nr(e){const t=parseInt(e);return isNaN(t)?{ok:!1,error:"Error: Expected a number"}:{ok:!0,value:t}}function or(e){return{result:e,type:"success"}}function ir(e){return{result:`Error: ${e}`,type:"error"}}const cr={excellent:5,good:4,fair:3,poor:2,critical:1};class lr extends ge{constructor(){super(...arguments),t(this,"name","ping"),t(this,"description","Ping neighbor (name or 0xXX)"),t(this,"params","{target} [timeout]")}async execute({output:e,rawInput:t}){var r,a,s,n;const o=this.argsAfterName(t).trim(),i=o.split(/\s+/);if("help"===(null==(r=i[0])?void 0:r.toLowerCase()))return void e.write([Le("ping"),`  ${Ae("Send a ping to a neighbor and measure round-trip time, signal quality, and path.")}`,"",Fe("ping <name>","ping by node name"),Fe("ping 0xAB","ping by hex prefix"),Fe("ping <name> 60","ping with custom timeout (seconds)"),"",Be("Default timeout: 30s. Signal bars factor radio config and noise floor.")].join("\n"));const c=i[i.length-1],l=parseInt(c),d=i.length>1&&!isNaN(l)&&l>0,u=d?i.slice(0,-1).join(" "):o,p=d?l:30;if(!u)return void e.write([Le("ping"),`  ${Ae("Send a ping to a neighbor and measure round-trip time.")}`,"",Fe("ping <name>","ping by node name"),Fe("ping <name> 60","with custom timeout"),"",Be('Run "ping help" for full usage.')].join("\n"));const m=Ut(e,u);try{const[t,r]=await Promise.all([Y(u,p),g()]);if(m.stop(),t.success&&t.data){const o=t.data,i=null==(a=r.config)?void 0:a.radio,c=(null==i?void 0:i.spreading_factor)&&(null==i?void 0:i.bandwidth)?{sf:i.spreading_factor,bwHz:i.bandwidth}:null,l=r.noise_floor_dbm,d=null!=l&&l>-100?1:0,u=o.rssi-3.5,p=W(o.snr_db,u,c,d),h=(null==p?void 0:p.finalGrade)??"critical",g=function(e){const t=cr[e]??0,r=Pe(e);return(t>0?`${r}${"‚ñà".repeat(t)}${ye}`:"")+Ae("¬∑".repeat(5-t))}(h),f=(null==(s=o.path)?void 0:s.length)?o.path.length:0,y=(null==(n=o.path)?void 0:n.length)?o.path.join(" > "):"direct",x=h.charAt(0).toUpperCase()+h.slice(1),v=[`${g} ${Te("Reply from")} ${Ee(o.target_id)}`,"",`  ${Ie("RTT",Oe(o.rtt_ms))}`,`  ${Ie("RSSI",`${o.rssi} dBm`)}`,`  ${Ie("SNR",`${o.snr_db} dB`)}`,`  ${Ie("Path",y)}${f>0?Ae(` (${f} hop${1!==f?"s":""})`):""}`,`  ${Ie("Quality",Ue(x,h))}`],$=[];c&&$.push(`SF${c.sf}/${c.bwHz>=1e3?c.bwHz/1e3+"kHz":c.bwHz+"Hz"}`),$.push("ant 3.5dBi"),null!=l&&$.push(`nf ${l}dBm`),v.push("",Ae($.join("  "))),e.update(m.id,v.join("\n"))}else e.update(m.id,t.error||"Ping failed","error")}catch(h){m.stop(),e.update(m.id,`Error: ${h instanceof Error?h.message:"Ping failed"}`,"error")}}}class dr extends ge{constructor(){super(...arguments),t(this,"name","convert"),t(this,"description","Convert between hex and base64"),t(this,"params","hex|base64 {value}")}execute({output:e,args:t}){var r;const a=null==(r=t[1])?void 0:r.toLowerCase(),s=t.slice(2).join(" ").trim();"help"!==a&&(a||s)?"hex"===a?this.hexToBase64(e,s):"base64"===a?this.base64ToHex(e,s):e.write([Le("convert"),`  ${Ae("Convert between hex and base64 encodings.")}`,"",Fe("convert hex <hex>","hex ‚Üí base64"),Fe("convert base64 <b64>","base64 ‚Üí hex")].join("\n")):e.write([Le("convert"),`  ${Ae("Convert between hex and base64 encodings.")}`,"",Fe("convert hex <hex>","hex ‚Üí base64"),Fe("convert base64 <b64>","base64 ‚Üí hex"),"",Be("Example: convert hex 48656C6C6F")].join("\n"))}hexToBase64(e,t){if(t)if(/^[0-9a-fA-F]+$/.test(t))if(t.length%2==0)try{const r=new Uint8Array(t.length/2);for(let e=0;e<t.length;e+=2)r[e/2]=parseInt(t.substring(e,e+2),16);let a="";const s=8192;for(let e=0;e<r.length;e+=s)a+=String.fromCharCode.apply(null,Array.from(r.subarray(e,Math.min(e+s,r.length))));const n="function"==typeof globalThis.btoa?globalThis.btoa(a):Buffer.from(a,"binary").toString("base64");e.write(`  ${Ie("hex",Ee(t))}\n  ${Ie("base64",Ee(n))}`)}catch(r){e.write(`Error: Failed to convert - ${r instanceof Error?r.message:"unknown error"}`,"error")}else e.write("Error: Hex string must have even length","error");else e.write("Error: Input must be a hex string","error");else e.write("Usage: convert hex <hex-string>","error")}base64ToHex(e,t){if(t)try{const r="function"==typeof globalThis.atob?globalThis.atob(t):Buffer.from(t,"base64").toString("binary");let a="";for(let e=0;e<r.length;e++)a+=r.charCodeAt(e).toString(16).padStart(2,"0");e.write(`  ${Ie("base64",Ee(t))}\n  ${Ie("hex",Ee(a.toUpperCase()))}`)}catch(r){e.write(`Error: Invalid base64 string - ${r instanceof Error?r.message:"unknown error"}`,"error")}else e.write("Usage: convert base64 <base64-string>","error")}}function ur(){const e=new Date;return`${e.toISOString().slice(0,10)}_${e.toTimeString().slice(0,8).replace(/:/g,"-")}`}function pr(e,t){return`pymc-${e.toISOString().slice(0,10)}-${e.toTimeString().slice(0,5).replace(":","")}-${t}s.json`}const mr=J((e,t)=>({isCapturing:!1,captureStartTime:null,captureStartPacketHashes:new Set,captureTimer:null,reports:[],startCapture:r=>{const{captureTimer:a}=t();a&&clearTimeout(a),e({isCapturing:!0,captureStartTime:new Date,captureStartPacketHashes:new Set(r.map(e=>e.packet_hash))})},stopCapture:r=>{const{isCapturing:a,captureStartTime:s,captureStartPacketHashes:n,captureTimer:o}=t();if(!a||!s)return null;o&&clearTimeout(o);const i=new Date,c=Math.round((i.getTime()-s.getTime())/1e3),l=s.getTime()/1e3,d=r.filter(e=>!n.has(e.packet_hash)&&e.timestamp>=l).sort((e,t)=>e.timestamp-t.timestamp),u={id:ur(),filename:pr(s,c),startTime:s,endTime:i,durationSec:c,packetCount:d.length,packets:d,sizeBytes:500*d.length};return e(e=>({isCapturing:!1,captureStartTime:null,captureStartPacketHashes:new Set,captureTimer:null,reports:[u,...e.reports].slice(0,10)})),u},getReport:e=>t().reports.find(t=>t.id===e),_setTimer:t=>e({captureTimer:t})})),hr=()=>mr(e=>e.reports);function gr(e){var t;return(null==(t=e.match(/.{1,2}/g))?void 0:t.join(" ").toUpperCase())||""}function fr(e){return void 0===e?"UNKNOWN":S[e]??`TYPE_${e}`}function yr(e){return void 0===e?"UNKNOWN":C[e]??`ROUTE_${e}`}function xr(e,t){switch(e){case 4:return function(e){const t=[];let r=0;if(e.length>=32&&(t.push({name:"public_key",offset:r,length:32,bytes:gr(k(e.slice(r,r+32))),decoded:{value:k(e.slice(r,r+32))}}),r+=32),e.length>=r+4){const a=e.slice(r,r+4),s=a[0]|a[1]<<8|a[2]<<16|a[3]<<24;t.push({name:"timestamp",offset:r,length:4,bytes:gr(k(a)),decoded:{value:s>>>0,iso:new Date(1e3*s).toISOString()}}),r+=4}if(e.length>=r+64&&(t.push({name:"signature",offset:r,length:64,bytes:gr(k(e.slice(r,r+64))),decoded:{value:k(e.slice(r,r+64))}}),r+=64),e.length>r){const a=e[r],s=[];if(1&a&&s.push("CHAT_NODE"),2&a&&s.push("REPEATER"),3&a&&s.push("ROOM_SERVER"),16&a&&s.push("HAS_LOCATION"),128&a&&s.push("HAS_NAME"),t.push({name:"flags",offset:r,length:1,bytes:gr(k(e.slice(r,r+1))),decoded:{value:a,binary:a.toString(2).padStart(8,"0"),flags:s}}),r+=1,16&a&&e.length>=r+8){const a=e.slice(r,r+8),s=new ArrayBuffer(8);new Uint8Array(s).set(a);const n=new DataView(s),o=n.getInt32(0,!0),i=n.getInt32(4,!0);t.push({name:"location",offset:r,length:8,bytes:gr(k(a)),decoded:{lat_raw:o,lon_raw:i,latitude:o/1e6,longitude:i/1e6}}),r+=8}if(128&a&&e.length>r){const a=e.slice(r);let s=a.indexOf(0);-1===s&&(s=a.length);const n=(new TextDecoder).decode(a.slice(0,s));t.push({name:"name",offset:r,length:s+(0===a[s]?1:0),bytes:gr(k(a.slice(0,s+1))),decoded:{value:n,encoding:"utf-8",null_terminated:0===a[s]}})}}return t}(t);case 3:return function(e){if(e.length<4)return[];const t=e.slice(0,4),r=t[0]|t[1]<<8|t[2]<<16|t[3]<<24;return[{name:"crc",offset:0,length:4,bytes:gr(k(t)),decoded:{value:r>>>0,hex:(r>>>0).toString(16).toUpperCase().padStart(8,"0"),note:"CRC of the acknowledged packet (little-endian)"}}]}(t);case 9:return function(e){const t=[];if(e.length<9)return t;const r=e.slice(0,4),a=r[0]|r[1]<<8|r[2]<<16|r[3]<<24;t.push({name:"trace_tag",offset:0,length:4,bytes:gr(k(r)),decoded:{value:a>>>0,hex:(a>>>0).toString(16).toUpperCase().padStart(8,"0")}});const s=e.slice(4,8),n=s[0]|s[1]<<8|s[2]<<16|s[3]<<24;if(t.push({name:"auth_code",offset:4,length:4,bytes:gr(k(s)),decoded:{value:n>>>0}}),t.push({name:"flags",offset:8,length:1,bytes:gr(k(e.slice(8,9))),decoded:{value:e[8],binary:e[8].toString(2).padStart(8,"0")}}),e.length>9){const r=e.slice(9),a=Array.from(r).map(e=>e.toString(16).toUpperCase().padStart(2,"0"));t.push({name:"target_path",offset:9,length:r.length,bytes:gr(k(r)),decoded:{hops:a,path_string:a.join("->")}})}return t}(t);case 8:return function(e){if(0===e.length)return[];const t=Array.from(e).map(e=>e.toString(16).toUpperCase().padStart(2,"0"));return[{name:"path_hops",offset:0,length:e.length,bytes:gr(k(e)),decoded:{hops:t,path_string:t.join("->")}}]}(t);case 5:return function(e){const t=[];if(e.length<1)return t;if(t.push({name:"channel_hash",offset:0,length:1,bytes:gr(k(e.slice(0,1))),decoded:{value:e[0].toString(16).toUpperCase().padStart(2,"0")}}),e.length>13){const r=12,a=e.length-1-r;t.push({name:"ciphertext",offset:1,length:a,bytes:gr(k(e.slice(1,1+a))),decoded:{length:a,note:"Encrypted message content"}}),t.push({name:"mac",offset:1+a,length:r,bytes:gr(k(e.slice(-r))),decoded:{note:"Message authentication code"}})}return t}(t);default:return function(e){return 0===e.length?[]:[{name:"raw_data",offset:0,length:e.length,bytes:gr(k(e)),decoded:{length:e.length}}]}(t)}}function vr(e){const t=e.type??e.payload_type??0,r=e.route??e.route_type??0,a=e.raw_packet||"";let s,n=null;if(a){const t=Q.fromHex(a);if(t.success&&t.packet){const e=t.packet;try{n=Z(e)}catch{n=null}const r=_(a);let o=0;const i={offset:0,length:1,bytes:gr(a.slice(0,2)),decoded:{route_type:e.routeType,route_name:e.routeTypeName,payload_type:e.payloadType,payload_name:e.payloadTypeName,version:e.payloadVersion}};o+=1,e.hasTransportCodes()&&(o+=4);const c={offset:o,length:1,bytes:gr(k(r.slice(o,o+1))),decoded:{value:e.pathLen}};o+=1;const l=o,d=r.slice(o,o+e.pathLen),u=Array.from(e.path).map(e=>e.toString(16).toUpperCase().padStart(2,"0")),p=9===e.payloadType,m={offset:l,length:e.pathLen,bytes:gr(k(d)),decoded:{hops:u,path_string:u.length>0?u.join("->"):"(direct)",...p&&{note:"For TRACE packets, path bytes are SNR√ó4 values, not node hashes",snr_values:Array.from(e.path).map(e=>{let t=e;return t>127&&(t-=256),t/4})}}};o+=e.pathLen,s={header:i,path_length:c,path:m,payload:{offset:o,length:e.payload.length,bytes:gr(e.payloadHex),sections:xr(e.payloadType,e.payload)}}}else s=$r(e)}else s=$r(e);return{timestamp:e.timestamp,packet_hash:e.packet_hash,type:t,type_name:fr(t),route:r,route_name:yr(r),rssi:e.rssi,snr:e.snr,length:e.length??0,src_hash:e.src_hash,dst_hash:e.dst_hash,transmitted:e.transmitted,drop_reason:e.drop_reason,is_duplicate:e.is_duplicate,lbt_attempts:e.lbt_attempts,lbt_backoff_delays_ms:e.lbt_backoff_delays_ms,lbt_channel_busy:e.lbt_channel_busy,raw_packet:a,structure:s,decoded:n}}function $r(e){var t;const r=e.type??e.payload_type??0,a=e.route??e.route_type??0,s=e.original_path??e.forwarded_path??[];return{header:{offset:0,length:1,bytes:"??",decoded:{route_type:a,route_name:yr(a),payload_type:r,payload_name:fr(r),version:0}},path_length:{offset:1,length:1,bytes:s.length.toString(16).toUpperCase().padStart(2,"0"),decoded:{value:s.length}},path:{offset:2,length:s.length,bytes:s.join(" "),decoded:{hops:s,path_string:s.length>0?s.join("->"):"(direct)"}},payload:{offset:2+s.length,length:(null==(t=e.payload)?void 0:t.length)??0,bytes:e.payload??"",sections:e.payload?xr(r,_(e.payload)):[]}}}function br(e,t){const r=function(e,t){var r;return{capture:{start:e.startTime.toISOString(),end:e.endTime.toISOString(),duration_sec:e.durationSec,packet_count:e.packetCount,node_name:(null==t?void 0:t.node_name)??"unknown",local_hash:(null==t?void 0:t.local_hash)??"unknown",pymc_console_version:w,pymc_repeater_version:(null==t?void 0:t.version)??"unknown",radio_config:(null==(r=null==t?void 0:t.config)?void 0:r.radio)?{frequency:t.config.radio.frequency,tx_power:t.config.radio.tx_power,bandwidth:t.config.radio.bandwidth,spreading_factor:t.config.radio.spreading_factor}:null},packets:e.packets.map(vr)}}(e,t),a=JSON.stringify(r,null,2),s=new Blob([a],{type:"application/json"}),n=URL.createObjectURL(s),o=document.createElement("a");o.href=n,o.download=e.filename,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(n)}function wr(e){return e<1024?`${e} B`:e<1048576?`${(e/1024).toFixed(1)} KB`:`${(e/1048576).toFixed(1)} MB`}class _r extends ge{constructor(){super(...arguments),t(this,"name","cap"),t(this,"description","Packet capture (start/end/list/export)")}matches(e){const t=e.toLowerCase().trim();return"cap"===t||"cap help"===t||t.startsWith("start cap")||t.startsWith("end cap")||t.startsWith("list cap")||t.startsWith("export cap")}async execute({output:e,rawInput:t}){const r=t.toLowerCase().trim();return"cap"===r||"cap help"===r?this.showHelp(e):r.startsWith("start cap")?this.startCapture(e,r):"end cap"===r?this.endCapture(e):"list cap"===r?this.listCaptures(e):r.startsWith("export cap")?this.exportCapture(e,r):void this.showHelp(e)}showHelp(e){const t=mr.getState(),r=t.isCapturing?`\n${De('Recording in progress... use "end cap" to stop')}`:"",a=t.reports.length,s=a>0?` (${a} saved)`:"",n=[Le("Packet Capture"),"",Fe("start cap","Start capture (default: 120s)"),Fe("end cap","Stop capture early"),Fe("list cap",`List saved captures${s}`),Fe("export cap","Download capture by ID"),"",Be("Captures stored in session memory. JSON includes decoded payloads."),r].filter(Boolean);e.write(n.join("\n"))}startCapture(e,t){const r=t.slice(9).trim(),a=r?parseInt(r):120;if(isNaN(a)||a<1||a>3600)return void e.write("Error: Duration must be 1-3600 seconds","error");const s=mr.getState();if(s.isCapturing)return void e.write('Error: Capture already in progress. Use "end cap" first.',"error");const n=M.getState().packets;s.startCapture(n);let o=a;const i=e.write(De(`Capturing... ${o}s remaining`),"system"),c=setInterval(()=>{o--;const t=mr.getState();if(o>=0&&t.isCapturing){const r=M.getState().packets.filter(e=>{if(!t.captureStartTime)return!1;const r=t.captureStartTime.getTime()/1e3;return e.timestamp>=r&&!t.captureStartPacketHashes.has(e.packet_hash)}).length,a=o>0?`${o}s remaining`:"finishing...";e.update(i,De(`Capturing... ${a} (${r} captured)`),"system")}},1e3),l=setTimeout(()=>{clearInterval(c);const t=mr.getState();if(t.isCapturing){const r=M.getState().packets,a=t.stopCapture(r);a?e.write(`‚úì Capture complete!\n  Captured: ${a.packetCount} packets\n  Duration: ${a.durationSec}s\n  Size: ~${wr(a.sizeBytes)}\n\nRun \`export cap ${a.id}\` to download.`,"value"):e.write("Capture completed with no packets.","warning")}},1e3*a);s._setTimer(l)}endCapture(e){const t=mr.getState();if(!t.isCapturing)return void e.write("No capture in progress.","warning");const r=M.getState().packets,a=t.stopCapture(r);a?e.write(`‚úì Capture stopped!\n  Captured: ${a.packetCount} packets\n  Duration: ${a.durationSec}s\n  Size: ~${wr(a.sizeBytes)}\n\nRun \`export cap ${a.id}\` to download.`,"value"):e.write("Capture stopped with no packets.","warning")}listCaptures(e){const{reports:t}=mr.getState();if(0===t.length)return void e.write("No capture reports available.\nStart a capture with: start cap [seconds]","info");const r=t.map((e,t)=>`  ${t+1}. ${e.packetCount} pkts ‚Ä¢ ${e.durationSec}s ‚Ä¢ ~${wr(e.sizeBytes)} (id: ${e.id})`);e.write(`Capture Reports (${t.length}):\n${r.join("\n")}`,"info")}exportCapture(e,t){const r=t.slice(10).trim(),a=mr.getState(),s=M.getState().stats;if(!r){if(0===a.reports.length)e.write("No capture reports available.\nStart a capture with: start cap [seconds]","info");else{const t=a.reports.map((e,t)=>`  ${t+1}. ${e.id}`);e.write(`Usage: export cap <id>\n\nAvailable reports:\n${t.join("\n")}`,"info")}return}let n=a.getReport(r);if(!n){const e=parseInt(r)-1;n=a.reports[e]}n?(br(n,s),e.write(`‚úì Downloading ${n.filename}...`,"value")):e.write(`Error: Report "${r}" not found.\nUse "list cap" to see available reports.`,"error")}}class kr extends ge{constructor(){super(...arguments),t(this,"name","identities"),t(this,"description","List configured identities"),t(this,"aliases",["id","ids"])}async execute({output:e,rawInput:t}){var r;if("help"===this.argsAfterName(t).toLowerCase().trim())return void e.write([Le("identities"),`  ${Ae("List all configured repeater and room server identities.")}`,"",Fe("identities","list identities"),"",Le("Aliases"),`  ${Ae("id, ids")}`].join("\n"));const a=e.write("processing...","system");try{const t=await j();if(!t.success||!t.data)return void e.update(a,t.error||"Failed to fetch identities","error");const s=t.data,n=(null==(r=s.configured)?void 0:r.length)?s.configured:s.registered||[];if(0===n.length)return void e.update(a,"No identities configured.","warning");const o=[Le(`Identities (${n.length})`),"",...n.map((e,t)=>{var r;const a=e.name||"Unnamed",s=e.type||"unknown",n=(null==(r=e.hash)?void 0:r.slice(0,8))||"‚Äî";return`  ${Ae(`${t+1}.`)} ${Te(a)}  ${Re(s)}  ${Ee(n)}`})];e.update(a,o.join("\n"))}catch(s){e.update(a,`Error: ${s instanceof Error?s.message:"Command failed"}`,"error")}}}class Cr extends ge{constructor(){super(...arguments),t(this,"name","keys"),t(this,"description","List transport keys")}async execute({output:e,rawInput:t}){if("help"===this.argsAfterName(t).toLowerCase().trim())return void e.write([Le("keys"),`  ${Ae("List configured transport encryption keys.")}`,"",Fe("keys","list transport keys")].join("\n"));const r=e.write("processing...","system");try{const t=await ee();if(!t.success||!t.data)return void e.update(r,t.error||"Failed to fetch transport keys","error");const a=t.data;if(0===a.length)return void e.update(r,"No transport keys configured.","warning");const s=[Le(`Transport Keys (${a.length})`),"",...a.map(e=>{const t=e.parent_id?`  ${Re(`parent: ${e.parent_id}`)}`:"";return`  ${Te(e.name)}  ${Ie("flood",Ee(e.flood_policy))}${t}`})];e.update(r,s.join("\n"))}catch(a){e.update(r,`Error: ${a instanceof Error?a.message:"Command failed"}`,"error")}}}class Sr extends ge{constructor(){super(...arguments),t(this,"name","acl"),t(this,"description","Show ACL statistics")}async execute({output:e,rawInput:t}){if("help"===this.argsAfterName(t).toLowerCase().trim())return void e.write([Le("acl"),`  ${Ae("Display access control list statistics.")}`,"",Fe("acl","show ACL stats")].join("\n"));const r=e.write("processing...","system");try{const t=await re();if(!t.success||!t.data)return void e.update(r,t.error||"Failed to fetch ACL stats","error");const a=t.data,s=[Le("ACL Stats"),"",`  ${Ie("Identities",Ee(String(a.total_identities)))}`,`  ${Ie("Total clients",Ee(String(a.total_clients)))}`,`  ${Ie("Admin",Ee(String(a.admin_clients)))}`,`  ${Ie("Guest",Ee(String(a.guest_clients)))}`];if(a.by_identity_type){const e=a.by_identity_type.repeater,t=a.by_identity_type.room_server;e&&s.push(`  ${Ie("Repeater",`${Ee(String(e.count))} ids  ${Ae(`${e.clients} clients`)}`)}`),t&&s.push(`  ${Ie("Room Server",`${Ee(String(t.count))} ids  ${Ae(`${t.clients} clients`)}`)}`)}e.update(r,s.join("\n"))}catch(a){e.update(r,`Error: ${a instanceof Error?a.message:"Command failed"}`,"error")}}}class Mr extends ge{constructor(){super(...arguments),t(this,"name","rooms"),t(this,"description","Show room server statistics")}async execute({output:e,rawInput:t}){if("help"===this.argsAfterName(t).toLowerCase().trim())return void e.write([Le("rooms"),`  ${Ae("Display room server statistics and sync status.")}`,"",Fe("rooms","list rooms")].join("\n"));const r=e.write("processing...","system");try{const t=await N();if(!t.success||!t.data)return void e.update(r,t.error||"Failed to fetch room stats","error");const a=t.data.rooms||[];if(0===a.length)return void e.update(r,"No room servers configured.","warning");const s=[Le(`Rooms (${a.length})`),"",...a.map(e=>[`  ${Te(e.room_name)}`,`    ${Ie("msgs",Ee(String(e.total_messages)))}  ${Ie("clients",`${Ee(String(e.active_clients))}${Re(`/${e.total_clients}`)}`)}  ${Ie("sync",e.sync_running?Ee("running"):Re("idle"))}`]).flat()];e.update(r,s.join("\n"))}catch(a){e.update(r,`Error: ${a instanceof Error?a.message:"Command failed"}`,"error")}}}class jr extends ge{constructor(){super(...arguments),t(this,"name","restart"),t(this,"description","Restart pymc-repeater service"),t(this,"aliases",["reboot"])}async execute({output:e,rawInput:t}){if("help"===this.argsAfterName(t).toLowerCase().trim())return void e.write([Le("restart"),`  ${Ae("Restart the pymc-repeater systemd service.")}`,"",Fe("restart","restart the service"),"",Le("Aliases"),`  ${Ae("reboot")}`,"",Be("Requires polkit permissions for the web user."),Be("The page will need a manual refresh after restart.")].join("\n"));const r=e.write("Restarting service...","system");try{const t=await te(AbortSignal.timeout(8e3));if(t.success)return e.update(r,"Service restart initiated.","success"),void this.waitForService(e);const a=t.status;if(403===a||401===a)return void e.update(r,"Error: Permission denied.\n\nThe web user needs polkit permissions to restart the service.\nSee: /etc/polkit-1/localauthority/50-local.d/pymc-repeater.pkla","error");e.update(r,t.error||"Restart failed","error")}catch(a){const t=a instanceof Error?a.message:"";t.includes("ERR_NETWORK")||t.includes("ECONNRESET")||t.includes("Failed to fetch")||t.includes("abort")||t.includes("timeout")||a instanceof DOMException&&"TimeoutError"===a.name||a instanceof DOMException&&"AbortError"===a.name?(e.update(r,"Service is restarting (connection dropped).","success"),this.waitForService(e)):e.update(r,`Error: ${t||"Restart failed"}`,"error")}}waitForService(e){const t=e.write("Waiting for service...","system");let r=0,a=!1;setTimeout(()=>{const s=setInterval(async()=>{if(!a){r++,e.update(t,`Waiting for service... ${r}s`,"system");try{await fetch(`${T}/api/stats`,{signal:AbortSignal.timeout(3e3)}),a=!0,clearInterval(s),e.update(t,`Service connected. (${r+4}s)`,"success")}catch{}!a&&r>=30&&(a=!0,clearInterval(s),e.update(t,"Service did not respond within 34s. Check manually.","warning"))}},1e3)},4e3)}}const Nr="[",Tr=`${Nr}0m`,Rr=`${Nr}32m`,Er=`${Nr}33m`,Ar=`${Nr}31m`,Ir=`${Nr}36m`,Fr=`${Nr}90m`,Lr=`${Nr}1m`;function Br(e){return e>=1073741824?`${(e/1073741824).toFixed(1)}G`:e>=1048576?`${(e/1048576).toFixed(0)}M`:e>=1024?`${(e/1024).toFixed(0)}K`:`${e}B`}function Dr(e){const t=Math.floor(e/86400),r=Math.floor(e%86400/3600),a=Math.floor(e%3600/60);return t>0?`${t}d ${r}h ${a}m`:r>0?`${r}h ${a}m`:`${a}m`}function Or(e,t){const r=" ".repeat(2),a=t-2,s=[];let n="",o=0;for(const i of e){const e=Xe(i);0===o?(n=i,o=e):o+2+e<=a?(n+="  "+i,o+=2+e):(s.push(r+n),n=i,o=e)}return o>0&&s.push(r+n),s}function Pr(e,t,r,a,s){if(!e||!t)return`  ${Fr}Waiting for data‚Ä¶${Tr}`;const n=function(e,t,r){var a,s;const n=e.node_name||"unknown",o=e.version?`v${e.version}`:"",i=(null==(a=t.system)?void 0:a.uptime)?Dr(t.system.uptime):"?",c=Dr(e.uptime_seconds||0),l=Math.max(3,r-4),d=(null==(s=t.cpu.load_avg)?void 0:s["1min"].toFixed(2))??"?",u=t.cpu.load_avg?`${d} ${t.cpu.load_avg["5min"].toFixed(2)} ${t.cpu.load_avg["15min"].toFixed(2)}`:"?",p=r>=60?u:d;return[`  ${Ir}${Lr}${n}${Tr}  ${Fr}${o}${Tr}`,`  ${Fr}${"‚îÄ".repeat(l)}${Tr}`,...Or([Ie("Sys",Ee(i)),Ie("Svc",Ee(c)),Ie("Load",Ee(p))],r)]}(e,t,a),o=function(e,t){const r=Math.max(6,Math.min(30,t-15)),a=t-(15+r)-2,s=[""],n=`${e.cpu.count} core${e.cpu.count>1?"s":""}`,o=`${Br(e.memory.used)}/${Br(e.memory.total)}`,i=`${Br(e.disk.used)}/${Br(e.disk.total)}`,c=(e,t,s)=>{const n=function(e,t){const r=Math.max(0,Math.min(100,e)),a=Math.round(r/100*t),s=t-a,n=r>=90?Ar:r>=70?Er:Rr;return`[${n}${"‚ñà".repeat(a)}${Tr}${Fr}${"‚ñë".repeat(s)}${Tr}] ${n}${`${r.toFixed(1)}%`.padStart(6)}${Tr}`}(t,r),o=a>=s.length?`  ${Re(s)}`:"";return`  ${Ae(e.padEnd(4))}${n}${o}`};s.push(c("CPU",e.cpu.usage_percent,n)),s.push(c("Mem",e.memory.usage_percent,o)),s.push(c("Dsk",e.disk.usage_percent,i));const l=Object.entries(e.temperatures||{});if(l.length>0){const e=l.map(([e,t])=>{return`${Re(e+":")} ${r=t,r>=80?`${Ar}${Lr}${r.toFixed(1)}¬∞C${Tr}`:r>=60?`${Er}${r.toFixed(1)}¬∞C${Tr}`:`${Rr}${r.toFixed(1)}¬∞C${Tr}`}`;var r});s.push(...Or(e,t))}return s}(t,a),i=function(e,t){var r,a;const s=e.neighbors||{},n=Object.keys(s).length,o=Object.values(s).filter(e=>e.zero_hop).length,i=(null==(a=null==(r=e.config)?void 0:r.repeater)?void 0:a.mode)||"?",c=null!=e.noise_floor_dbm?`${e.noise_floor_dbm}dBm`:"?",l=e.duty_cycle_percent??0,d=["",`  ${Fr}MESH${Tr}`];return d.push(...Or([Ie("Mode",Ee(i)),Ie("Nbrs",`${Ee(String(o))}${Re(`/${n}`)}`),Ie("Noise",Ee(c)),Ie("Air",Ee(`${l.toFixed(1)}%`))],t)),d.push(...Or([Ie("RX",Ee(String(e.rx_count??0))),Ie("TX",Ee(String(e.tx_count??0))),Ie("FWD",Ee(String(e.forwarded_count??0))),Ie("Drop",Ee(String(e.dropped_count??0)))],t)),d.push(...Or([Ie("RX/h",Ee(String(Math.round(e.rx_per_hour??0)))),Ie("FWD/h",Ee(String(Math.round(e.forwarded_per_hour??0))))],t)),d}(e,a),c=function(e,t){if(!e.network)return[];const r=["",`  ${Fr}NET${Tr}`];return r.push(...Or([Ie("TX",Ee(Br(e.network.bytes_sent))),Ie("RX",Ee(Br(e.network.bytes_recv))),Ie("Pkt",`${Ee(String(e.network.packets_sent))}${Re("/")}${Ee(String(e.network.packets_recv))}`)],t)),r}(t,a),l=["",`  ${Fr}${(new Date).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1})}  ¬∑  Ctrl+C to exit${Tr}`],d=[...n,...o,...i,...c,...l],u=s?Ve(d,a):0,p=function(e,t,r){if(0===e.length)return[];const a=t>=50,s=t>=50?6:5,n=t>=50?6:5,o=a?7:0,i=Math.max(4,t-2-o-s-n-4),c=t>=50?8:5,l=null!=r?Math.max(0,Math.min(c,r-3)):c;if(l<=0)return[];const d=["",`  ${Fr}PROCS${Tr}`],u=(a?"PID".padEnd(o):"")+"CPU".padStart(s)+"MEM".padStart(n)+"  NAME";d.push(`  ${Re(u)}`);for(const p of e.slice(0,l)){const e=a?Re(String(p.pid).padEnd(o)):"",r=(t>=50?p.cpu_percent.toFixed(1):p.cpu_percent.toFixed(0)).padStart(s),c=(t>=50?p.memory_percent.toFixed(1):p.memory_percent.toFixed(0)).padStart(n),l=p.name.length>i?p.name.slice(0,i-1)+"‚Ä¶":p.name,u=p.cpu_percent>=50?Ar:p.cpu_percent>=20?Er:"",m=u?`${u}${r}${Tr}`:r;d.push(`  ${e}${m}${Re(c)}  ${l}`)}return d}(r,a,s?Math.max(0,s-u):void 0),m=[...d.slice(0,-l.length),...p,...l];return s&&m.length>s&&(m.length=s),m.join("\n")}class Ur extends ge{constructor(){super(...arguments),t(this,"name","top"),t(this,"description","Live system overview (Ctrl+C to exit)"),t(this,"aliases",["htop"])}async execute({output:e,rawInput:t,cols:r,signal:a}){var s,n;if("help"===this.argsAfterName(t).toLowerCase().trim())return void e.write([Le("top"),`  ${Ae("Live-updating system overview combining hardware")}`,`  ${Ae("stats, mesh metrics, and running processes.")}`,`  ${Ae("Refreshes every 3s. Press Ctrl+C to exit.")}`,"",Fe("top","start live display"),"",Le("Sections"),`  ${Ae("Header     Node name, version, uptime, load average")}`,`  ${Ae("Gauges     CPU, memory, disk usage with bar charts")}`,`  ${Ae("Mesh       Mode, neighbors, packet counts, airtime")}`,`  ${Ae("Network    TCP/IP bytes and packet counters")}`,`  ${Ae("Processes  Top 8 processes by CPU usage")}`,"",Le("Aliases"),`  ${Ae("htop")}`].join("\n"));let o=M.getState().hardwareStats,i=[],c=M.getState().stats;try{const[e,t]=await Promise.all([f(),R()]);e.success&&e.data&&(o=e.data),t.success&&t.data&&(i=t.data.processes.sort((e,t)=>t.cpu_percent-e.cpu_percent))}catch{}if(!a.aborted){null==(s=e.enterFullscreen)||s.call(e);try{const t=e.write(Pr(c,o,i,e.cols??r,e.rows));await new Promise(s=>{if(a.aborted)return void s();const n=setInterval(()=>{if(a.aborted)return clearInterval(n),void s();(async()=>{c=M.getState().stats;try{const[e,t]=await Promise.all([f(),R()]);e.success&&e.data&&(o=e.data),t.success&&t.data&&(i=t.data.processes.sort((e,t)=>t.cpu_percent-e.cpu_percent))}catch{}a.aborted||e.update(t,Pr(c,o,i,e.cols??r,e.rows))})()},3e3);a.addEventListener("abort",()=>{clearInterval(n),s()},{once:!0})})}finally{null==(n=e.exitFullscreen)||n.call(e)}}}}const zr=["DONT PANIC","C0FFEE","FEED C0DE","LOL","I CANNOT DO THAT"];function Hr(){return zr[Math.floor(Math.random()*zr.length)]}const qr=new EventTarget,Kr="shell-phrase";function Wr(e){qr.dispatchEvent(new CustomEvent(Kr,{detail:e??Hr()}))}class Gr extends ge{constructor(){super(...arguments),t(this,"name","fortune"),t(this,"description","Display a fortune on the header"),t(this,"aliases",["lol"])}execute({output:e}){const t=Hr();Wr(t),e.write(Ae(`  ${t}`))}}const Xr=new EventTarget,Vr="party-time";class Yr extends ge{constructor(){super(...arguments),t(this,"name","partytime"),t(this,"description","Party on, Garth!"),t(this,"aliases",["party","excellent","waynesworld"])}execute({output:e}){Xr.dispatchEvent(new Event(Vr)),Wr("PARTY 0N GARTH"),e.write(Ae("  SCHWING!"))}}class Jr extends ge{constructor(){super(...arguments),t(this,"name","ver"),t(this,"description","Show version info"),t(this,"aliases",["version"])}async execute({output:e,rawInput:t}){if("help"===this.argsAfterName(t).toLowerCase().trim())return void e.write([Le("ver"),`  ${Ae("Display pyMC_Repeater, core, and console version.")}`,`  ${Ae('Equivalent to firmware serial CLI "ver" command.')}`,"",Fe("ver","show version"),"",Le("Aliases"),`  ${Ae("version")}`].join("\n"));const r=e.write("processing...","system");try{const t=await g(),a="0.9.249";e.update(r,[`  ${Ie("pyMC_Repeater",Ee(`v${t.version||"?"}`))}`,`  ${Ie("pyMC_Core",Ee(t.core_version||"?"))}`,`  ${Ie("pyMC_Console",Ee(`v${a}`))}`].join("\n"),"value")}catch(a){e.update(r,`Error: ${a instanceof Error?a.message:"Command failed"}`,"error")}}}class Qr extends ge{constructor(){super(...arguments),t(this,"name","clock"),t(this,"description","Show system UTC time")}execute({output:e,rawInput:t}){if("help"===this.argsAfterName(t).toLowerCase().trim())return void e.write([Le("clock"),`  ${Ae("Display the current system UTC time.")}`,`  ${Ae('Equivalent to firmware serial CLI "clock" command.')}`,`  ${Ae("Use to verify NTP sync and correlate packet timestamps.")}`,"",Fe("clock","show UTC time")].join("\n"));const r=new Date;e.write([`  ${Ie("UTC",Ee(r.toUTCString()))}`,`  ${Ie("ISO",Ee(r.toISOString()))}`,`  ${Ie("Unix",Ee(String(Math.floor(r.getTime()/1e3))))}`].join("\n"),"value")}}class Zr extends ge{constructor(){super(...arguments),t(this,"name","stats-packets"),t(this,"description","Packet counters")}async execute({output:e,rawInput:t}){if("help"===this.argsAfterName(t).toLowerCase().trim())return void e.write([Le("stats-packets"),`  ${Ae("Display packet counters: sent, received, forwarded, dropped.")}`,`  ${Ae('Equivalent to firmware serial CLI "stats-packets" command.')}`,"",Fe("stats-packets","show packet counters")].join("\n"));const r=e.write("processing...","system");try{const t=await g(),a=t.rx_count??0,s=t.tx_count??0,n=t.forwarded_count??0,o=t.dropped_count??0,i=t.rx_per_hour??0,c=t.forwarded_per_hour??0,l=t.duplicate_cache_size??0;e.update(r,[`  ${Te("Packet Counters")}`,"",`  ${Ie("RX",Ee(String(a)))}        ${Ae(`${i.toFixed(1)}/hr`)}`,`  ${Ie("TX",Ee(String(s)))}`,`  ${Ie("Forwarded",Ee(String(n)))}  ${Ae(`${c.toFixed(1)}/hr`)}`,`  ${Ie("Dropped",Ee(String(o)))}`,"",`  ${Ie("Dup cache",Ee(String(l)))}`].join("\n"),"value")}catch(a){e.update(r,`Error: ${a instanceof Error?a.message:"Command failed"}`,"error")}}}function ea(e){return e>=6e4?`${(e/6e4).toFixed(1)}m`:e>=1e3?`${(e/1e3).toFixed(1)}s`:`${e.toFixed(0)}ms`}class ta extends ge{constructor(){super(...arguments),t(this,"name","stats-radio"),t(this,"description","Radio health stats")}async execute({output:e,rawInput:t}){var r;if("help"===this.argsAfterName(t).toLowerCase().trim())return void e.write([Le("stats-radio"),`  ${Ae("Display radio health: airtime, noise floor, duty cycle.")}`,`  ${Ae('Equivalent to firmware serial CLI "stats-radio" command.')}`,"",Fe("stats-radio","show radio stats")].join("\n"));const a=e.write("processing...","system");try{const t=await g(),s=null==(r=t.config)?void 0:r.radio,n=t.noise_floor_dbm,o=t.airtime_used_ms??0,i=t.airtime_remaining_ms??0,c=t.duty_cycle_percent??0,l=t.utilization_percent??0,d=t.total_airtime_ms??0,u=[`  ${Te("Radio Stats")}`,""];if(s){const e=s.frequency?`${(s.frequency/1e6).toFixed(3)} MHz`:"?",t=s.bandwidth?s.bandwidth/1e3+" kHz":"?";u.push(`  ${Ie("Radio",Ee(`${e}  SF${s.spreading_factor??"?"}  BW ${t}  CR 4/${s.coding_rate??"?"}  ${s.tx_power??"?"} dBm`))}`),u.push("")}u.push(`  ${Ie("Noise floor",null!=n?Ee(`${n} dBm`):Ae("N/A"))}`),u.push(`  ${Ie("Airtime used",Ee(ea(o)))}  ${Ae(`remaining: ${ea(i)}`)}`),u.push(`  ${Ie("Total airtime",Ee(ea(d)))}`),u.push(`  ${Ie("Duty cycle",Ee(`${c.toFixed(1)}%`))}`),u.push(`  ${Ie("Utilization",Ee(`${l.toFixed(1)}%`))}`),e.update(a,u.join("\n"),"value")}catch(s){e.update(a,`Error: ${s instanceof Error?s.message:"Command failed"}`,"error")}}}function ra(e){return e>=1073741824?`${(e/1073741824).toFixed(1)} GB`:e>=1048576?`${(e/1048576).toFixed(0)} MB`:`${(e/1024).toFixed(0)} KB`}class aa extends ge{constructor(){super(...arguments),t(this,"name","stats-core"),t(this,"description","Engine vitals")}async execute({output:e,rawInput:t}){if("help"===this.argsAfterName(t).toLowerCase().trim())return void e.write([Le("stats-core"),`  ${Ae("Display engine vitals: uptime, memory, CPU, queue depth.")}`,`  ${Ae('Equivalent to firmware serial CLI "stats-core" command.')}`,`  ${Ae("On firmware this shows free heap ‚Äî here we show Linux process health.")}`,"",Fe("stats-core","show core stats")].join("\n"));const r=e.write("processing...","system");try{const[t,a]=await Promise.all([g(),f()]),s=[`  ${Te("Core Stats")}`,"",`  ${Ie("Uptime",Ee(ft(t.uptime_seconds??0)))}`,`  ${Ie("Dup cache",Ee(`${t.duplicate_cache_size??0} entries`))}  ${Ae(`TTL ${t.cache_ttl??"?"}s`)}`];if(a.success&&a.data){const e=a.data;s.push(""),s.push(`  ${Ie("CPU",Ee(`${e.cpu.usage_percent.toFixed(1)}%`))}  ${Ae(`${e.cpu.count} core${e.cpu.count>1?"s":""}`)}`),e.cpu.load_avg&&s.push(`  ${Ie("Load",Ee(`${e.cpu.load_avg["1min"].toFixed(2)} / ${e.cpu.load_avg["5min"].toFixed(2)} / ${e.cpu.load_avg["15min"].toFixed(2)}`))}`),s.push(`  ${Ie("Memory",Ee(`${ra(e.memory.used)} / ${ra(e.memory.total)}`))}  ${Ae(`${e.memory.usage_percent.toFixed(0)}%`)}`);const t=Object.entries(e.temperatures||{});t.length>0&&s.push(`  ${Ie("Temp",Ee(`${t[0][1].toFixed(1)}¬∞C`))}`)}e.update(r,s.join("\n"),"value")}catch(a){e.update(r,`Error: ${a instanceof Error?a.message:"Command failed"}`,"error")}}}const sa="[",na=`${sa}0m`,oa=`${sa}1m`,ia=`${sa}2m`;function ca(e,t,r){return`${sa}38;2;${e};${t};${r}m`}function la(e,t=.08){const r=e+(Math.random()-.5)*t*2,a=Math.max(0,Math.min(.999,r));return"   . Àô',¬∑‚àô‚Å∫Àö¬∞:;~*+‚úß‚ú©√ó‚ú¥‚ñë‚ú¶‚ú∂‚ú≥oO‚ñí#%&xX‚ñì@MW8B‚ñà‚ñà‚ñà‚ñà‚ñà"[Math.floor(45*a)]}function da(){return"‚ú¶‚ú∂‚ú≥‚úß‚ú¥‚ú©√ó"[Math.floor(7*Math.random())]}const ua=[[6,4,28],[14,10,60],[30,24,105],[50,45,160],[72,70,200],[91,91,214],[150,150,245]];function pa(e){const t=Math.max(0,Math.min(1,e))*(ua.length-1),r=Math.floor(t),a=Math.min(r+1,ua.length-1),s=t-r;return ca(Math.round(ua[r][0]+(ua[a][0]-ua[r][0])*s),Math.round(ua[r][1]+(ua[a][1]-ua[r][1])*s),Math.round(ua[r][2]+(ua[a][2]-ua[r][2])*s))}const ma=ca(0,240,255),ha=ca(255,50,180),ga=ca(255,252,255),fa=ca(80,255,180),ya=ca(255,180,120),xa=`${sa}38;2;91;91;214m`;let va=null,$a=null;function ba(){va=null,$a=null}function wa(e,t){$a!==e&&(va=function(e){var t;const r=e.length,a=Math.max(...e.map(e=>e.length)),s=r/2,n=a/2,o=new Float32Array(r*a);let i=0;for(let c=0;c<r;c++)for(let r=0;r<a;r++){const l=c-s,d=.5*(r-n),u=Math.sqrt(l*l+d*d);o[c*a+r]=u," "!==((null==(t=e[c])?void 0:t[r])??" ")&&u>i&&(i=u)}return{dist:o,maxDist:i,cols:a,rows:r}}(e),$a=e);const{dist:r,maxDist:a,cols:s,rows:n}=va,o=t<14,i=t>=14&&t<26,c=t>=26,l=Math.min(1,t/14),d=i?Math.min(1,(t-14)/Math.max(1,11)):c?1:0,u=i||c?a*(1-(.3*(p=d)+p*p*p*.7)):function(e){return 1-Math.pow(1-e,3)}(l)*a;var p;const m=.72*u,h=.45*u,g=o?-.6:.9,f=[],y=n/2,x=s/2,v=t>=5&&t<=19,$=v?t<=14?(t-5)/9:1-(t-14)/5:0,b=.28*Math.sin(3.4*t)+.24*Math.sin(5.9*t)+.18*Math.sin(9.7*t)+.12*Math.sin(14.3*t),w=Math.max(.12,.55+.55*b),_=Math.sin(.85*t),k=.5-.5*_,C=(.3+2.7*(.5+.5*_))*Math.max(0,$)*w,S=(.5+3.5*k)*Math.max(0,$)*w;for(let M=0;M<n;M++){const n=e[M]||"";let o="",l="";for(let e=0;e<s;e++){const d=e<n.length?n[e]:" ",p=" "===d,f=r[M*s+e];if(v&&(C>.2||S>.3)){const r=Math.abs(M-y),a=Math.abs(e-x);if(r<C&&a<S){const s=.5*Math.sin(5.3*t+7*M+11*e)+.5,n=r<.6&&a<1,i=n&&C>.8?"‚ñà":n||s>.6?"‚ú¶":s>.3?"‚ú∂":"‚ú¥",c="‚ñà"===i?ga+oa:n||"‚ú¶"===i?(s>.5?ga:ma)+oa:(s>.65?ma:xa)+oa;c!==l&&(o+=c,l=c),o+=i;continue}}if(p)o+=" ",l="";else if(c){const e=xa+oa;e!==l&&(o+=e,l=e),o+=d}else if(i&&f>u){const e=f-u;if(e<.2*a){const t=1-e/(.2*a),r=Math.random();let s;if(t>.85){const e=(t-.85)/.15;s=ca(Math.round(190+65*e),Math.round(210+42*e),255)+oa}else if(t>.6)if(r<.1)s=ma+oa;else if(r<.16)s=ha+oa;else{const e=(t-.6)/.25;s=ca(Math.round(120+70*e),Math.round(150+60*e),255)+oa}else s=pa(.7+.3*t)+oa;s!==l&&(o+=s,l=s)}else Math.random()<.008?ya!==l&&(o+=ya,l=ya):xa!==l&&(o+=xa,l=xa);o+=d}else if(f>u)o+=" ",l="";else{const r=u-f,s=.7*Math.exp(-r/(.22*a))+.3*Math.max(0,1-r/(.55*a)),n=Math.max(0,1-Math.abs(f-m)/(.18*a)),i=Math.max(0,1-Math.abs(f-h)/(.22*a)),c=.8*Math.sin(.3*e),d=.5*Math.sin(.4*M+.15*e),p=.5*Math.sin(3*f+t*g+c)+.5,y=p*p*.5+.28*(.5*Math.sin(6.5*f+t*g*1.8+.5*c+d)+.5)+.22*(.5*Math.sin(1.3*f-t*g*.35+1.5*c+.08*M)+.5),x=t<2&&f<.35*a?.7*(1-f/(.35*a)):0,v=.52*s,$=(.3+.7*(1-s))*y*.32,b=.18*n+.1*i,w=Math.min(1,v+$+b+x);if(w<.025)o+=" ",l="";else{const e=Math.max(s,.65*n,.45*i),t=.8*w+.2*s,r=Math.random();let a;if(x>.2)a=r<.35?ga+oa:r<.55?ha+oa:r<.7?ma+oa:pa(.95)+oa;else if(e>.8)if(r<.08)a=ha+oa;else if(r<.14)a=ma+oa;else{const t=(e-.8)/.2;a=ca(Math.round(190+65*t),Math.round(210+42*t),255)+oa}else if(e>.55)if(r<.05)a=fa+oa;else{const t=(e-.55)/.25;a=ca(Math.round(110+80*t),Math.round(140+70*t),Math.round(245+10*t))+oa}else if(e>.32){const t=(e-.32)/.23;a=ca(Math.round(91+19*t),Math.round(91+49*t),Math.round(214+31*t))+(t>.5?oa:"")}else a=w<.12&&y>.65&&r<.08?ya+ia:pa(t)+(w>.4?oa:w<.12?ia:"");a!==l&&(o+=a,l=a),w>.82&&s>.7||w>.7&&n>.5&&Math.random()<.2?o+=da():o+=la(w,.02+.05*(1-w))}}}f.push(o+na)}return f}const _a=["@@@@@@@   @@@ @@@  @@@@@@@@@@    @@@@@@@  ","@@@@@@@@  @@@ @@@  @@@@@@@@@@@  @@@@@@@@  ","@@!  @@@  @@! !@@  @@! @@! @@!  !@@       ","!@!  @!@  !@! @!!  !@! !@! !@!  !@!       ","@!@@!@!    !@!@!   @!! !!@ @!@  !@!       ","!!@!!!      @!!!   !@!   ! !@!  !!!       ","!!:         !!:    !!:     !!:  :!!       ",":!:         :!:    :!:     :!:  :!:       "," ::          ::    :::     ::    ::: :::  "," :           :      :      :     :: :: :  "];class ka extends ge{constructor(){super(...arguments),t(this,"name","hello"),t(this,"description","Play the PYMC burst intro"),t(this,"aliases",["hi","intro"])}async execute({output:e,signal:t}){if(t.aborted)return;let r=0;const a=e.write(wa(_a,0).join("\n"));try{await new Promise(s=>{const n=setInterval(()=>{if(t.aborted||r>=26)return clearInterval(n),t.aborted||e.update(a,wa(_a,26).join("\n")),void s();r++,e.update(a,wa(_a,r).join("\n"))},80);t.addEventListener("abort",()=>{clearInterval(n),s()},{once:!0})})}finally{ba()}}}const Ca=J(e=>({entries:[],commandHistory:[],isInitialized:!1,addEntry:t=>{const r="undefined"!=typeof crypto&&crypto.randomUUID?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}),a={...t,id:r,timestamp:Date.now()};return e(e=>({entries:[...e.entries,a]})),r},updateEntry:(t,r)=>{e(e=>({entries:e.entries.map(e=>e.id===t?{...e,...r}:e)}))},addCommand:t=>{e(e=>({commandHistory:[...e.commandHistory,t]}))},clearEntries:()=>{e({entries:[],commandHistory:[]})},setInitialized:t=>{e({isInitialized:t})}}));function Sa({isOpen:e,onClose:t}){const a=hr(),s=M(e=>e.stats);return r.jsxs(E,{open:e,onClose:t,size:"sm",children:[r.jsx(A,{icon:r.jsx(V,{size:20}),title:"Download Captures",onClose:t}),r.jsx(I,{className:"flex flex-col gap-2",children:0===a.length?r.jsxs("div",{className:"flex flex-col items-center gap-2 py-6 text-fg-muted",children:[r.jsx(me,{className:"w-8 h-8 opacity-40"}),r.jsx("p",{className:"text-sm",children:"No captures available."})]}):a.map(e=>r.jsxs("div",{className:"flex items-center gap-3 px-4 py-3 radius-inset bg-elevated/50 border border-edge-subtle",children:[r.jsxs("div",{className:"flex-1 min-w-0",children:[r.jsx("p",{className:"type-label text-fg-primary truncate",children:e.filename}),r.jsxs("p",{className:"text-xs text-fg-muted mt-0.5",children:[e.packetCount," packets ¬∑ ",e.durationSec,"s ¬∑ ~",wr(e.sizeBytes)]})]}),r.jsx(F,{plain:!0,color:"primary",onClick:()=>(e=>{const t=a.find(t=>t.id===e);t&&br(t,s)})(e.id),title:"Download",className:"flex-shrink-0",children:r.jsx(V,{"data-slot":"icon"})})]},e.id))})]})}function Ma(){const e=hr(),[t,s]=a.useState(!1);return r.jsxs(r.Fragment,{children:[r.jsx(ae,{icon:r.jsx(pe,{size:20}),onClick:()=>s(!0),title:e.length>0?`Download captures (${e.length})`:"Captures",variant:"red",iconActiveColor:m.red}),r.jsx(Sa,{isOpen:t,onClose:()=>s(!1)})]})}const ja=[{name:"acl",description:"Access control list statistics ‚Äî identity and client counts.",body:["```","> acl","ACL Stats","","  Identities     2","  Total clients  5","  Admin          2","  Guest          3","  Repeater       1 ids  3 clients","  Room Server    1 ids  2 clients","```"],searchText:"acl access control list statistics identity client"},{name:"advert",description:"Broadcast a repeater advertisement to the mesh.",body:["```","> advert","‚úì Advert sent","```"],searchText:"advert advertisement broadcast mesh"},{name:"board",description:"Hardware and platform info ‚Äî CPU, memory, disk, temperatures, network I/O.",body:["```","> board","  Node     Local-Node","  Runtime  pyMC_Repeater v1.0.0","  Core     v1.12.0","","  CPU      12.3%  4 cores","  Load     0.42 / 0.38 / 0.35","  Temp     48.2¬∞C","","  Memory   412 MB / 664 MB  62%","  Disk     5.2 GB / 28.7 GB  18%","","  System uptime   14d 3h 22m","  Service uptime  2d 14h 32m","  Net TX/RX       128 MB / 342 MB","```"],searchText:"board hardware platform cpu memory disk temperature network"},{name:"cap",description:"Packet capture ‚Äî start, stop, list, and export captures.",body:["**Sub-commands:** `start cap [sec]` ¬∑ `end cap` ¬∑ `list cap` ¬∑ `export cap [id]`","","**`start cap [seconds]`** ‚Äî Begin capture (default 120s, max 3600):","```","> start cap","Capturing... 118s remaining (4 captured)","","‚úì Capture complete!","  Captured: 23 packets","  Duration: 120s","  Size: ~14.2 KB","```","","**`end cap`** ‚Äî Stop capture early:","```","> end cap","‚úì Capture stopped!","  Captured: 12 packets","```","","**`list cap`** ‚Äî List saved captures:","```","> list cap","Capture Reports (2):","  1. 23 pkts ‚Ä¢ 120s ‚Ä¢ ~14.2 KB (id: abc123)","  2. 12 pkts ‚Ä¢ 34s ‚Ä¢ ~7.1 KB (id: def456)","```","","**`export cap [id]`** ‚Äî Download by ID or index:","```","> export cap 1","‚úì Downloading capture-abc123.json...","```"],searchText:"cap capture packet start end list export download diagnostic"},{name:"clear",description:"Clear the terminal screen.",body:["**Alias:** `cls`","```","> clear","```"],searchText:"clear cls screen"},{name:"clock",description:"Current system UTC time. Useful for NTP sync and packet timestamp correlation.",body:["```","> clock","  UTC   Wed, 12 Feb 2026 00:01:34 GMT","  ISO   2026-02-12T00:01:34.000Z","  Unix  1770768094","```"],searchText:"clock time utc ntp unix iso timestamp"},{name:"convert",description:"Convert between hex and base64 encodings.",body:["**Usage:** `convert hex <value>` ¬∑ `convert base64 <value>`","```","> convert hex 48656C6C6F","  hex     48656C6C6F","  base64  SGVsbG8=","","> convert base64 SGVsbG8=","  base64  SGVsbG8=","  hex     48656C6C6F","```"],searchText:"convert hex base64 encoding decode"},{name:"get",description:"Read a configuration parameter.",body:[],interactive:"get",searchText:"get read config parameter name role lat lon radio freq tx bw sf cr txdelay mode duty flood advert"},{name:"help",description:"Show all commands, or detailed help for a specific command.",body:["**Alias:** `?` ¬∑ `h`","```","> help           Full command listing","> help ping      Detailed help for ping","> ping help      Same thing","```"],searchText:"help commands reference guide"},{name:"identities",description:"List all configured repeater and room server identities.",body:["**Alias:** `id` ¬∑ `ids`","```","> identities","Identities (2)","","  1. Local-Node   repeater     0A1B2C3D","  2. local-room   room_server  0E5F6A7B","```"],searchText:"identities id ids repeater room server identity"},{name:"keys",description:"List configured transport encryption keys.",body:["```","> keys","Transport Keys (1)","","  main-transport  flood: allow","```"],searchText:"keys transport encryption"},{name:"neighbors",description:"Direct RF neighbors with signal quality, RSSI, SNR, distance, and last-heard.",body:["**Alias:** `nb`","","**Sort qualifiers:** `sig` ¬∑ `name` ¬∑ `rssi` ¬∑ `snr` ¬∑ `dist` ¬∑ `heard`","```","> neighbors","Direct Neighbors (4)","","+-------+-----------+-----------+--------+-------+--------+","| ‚ñÅ‚ñÉ‚ñÖ‚ñá‚ñà | Node-1 | -87 dBm  | 8.5 dB | 2.1km | 3m ago |","| ‚ñÅ‚ñÉ‚ñÖ‚ñá. | Relay-2   | -94 dBm  | 5.2 dB | 4.8km | 1m ago |","| ‚ñÅ‚ñÉ‚ñÖ.. | Node-3   | -108 dBm | 1.0 dB | 8.3km | 5m ago |","| ‚ñÅ‚ñÉ... | Node-4  | -118 dBm | -3 dB  | 14km  | 12m ago|","+-------+-----------+-----------+--------+-------+--------+","| SIG   | NAME      | RSSI      | SNR    | DIST  | HEARD  |","+-------+-----------+-----------+--------+-------+--------+","SF11/250kHz  ant 3.5dBi  nf -112dBm","```","","- **sig** ‚Äî signal grade (weakest first)","- **name** ‚Äî alphabetical","- **rssi** ‚Äî RSSI (weakest first)","- **snr** ‚Äî SNR (lowest first)","- **dist** ‚Äî distance (closest first)","- **heard** ‚Äî last seen (oldest first)"],searchText:"neighbors nb signal rssi snr distance sort direct rf"},{name:"packets",description:"Packet counters ‚Äî received, transmitted, forwarded, dropped.",body:["```","> packets","Packet Stats  1321 total","","  Received     1284","  Transmitted  37","  Forwarded    891","  Dropped      14","```"],searchText:"packets received transmitted forwarded dropped counter"},{name:"ping",description:"Ping a neighbor by name or hex prefix. Shows RTT, signal quality, and path.",body:["**Usage:** `ping <target> [timeout]`","```","> ping Node-1","‚ñÅ‚ñÉ‚ñÖ‚ñá‚ñà Reply from Node-1","","  RTT      342ms","  RSSI     -87 dBm","  SNR      8.5 dB","  Path     direct","  Quality  Excellent","```","","Custom timeout (default 30s):","```","> ping Node-4 60","```"],searchText:"ping rtt round trip time signal quality path neighbor"},{name:"restart",description:"Restart the pymc-repeater systemd service.",body:["**Alias:** `reboot`","```","> restart","Service is restarting (connection dropped).","Waiting for service... 8s","Service connected. (12s)","```","","The terminal polls automatically until the service comes back up."],searchText:"restart reboot service systemd"},{name:"rooms",description:"Room server statistics ‚Äî message counts, active clients, sync status.",body:["```","> rooms","Rooms (1)","","  Local Room","    msgs 142  clients 3/5  sync running","```"],searchText:"rooms room server messages clients sync"},{name:"set",description:"Write a configuration parameter.",body:[],interactive:"set",searchText:"set write config parameter name lat lon freq tx bw sf cr txdelay mode duty log flood advert"},{name:"stats-core",description:"Engine vitals ‚Äî uptime, duplicate cache, CPU, memory, temperature.",body:["```","> stats-core","  Core Stats","","  Uptime     2d 14h 32m","  Dup cache  128 entries  TTL 900s","","  CPU        12.3%  4 cores","  Load       0.42 / 0.38 / 0.35","  Memory     412 MB / 664 MB  62%","  Temp       48.2¬∞C","```"],searchText:"stats core engine vitals uptime cache cpu memory temperature"},{name:"stats-packets",description:"Firmware-compatible packet counters with rates and duplicate cache depth.",body:["```","> stats-packets","  Packet Counters","","  RX         1284        22.4/hr","  TX         37","  Forwarded  891   15.2/hr","  Dropped    14","","  Dup cache  128","```"],searchText:"stats packets firmware counter rate duplicate cache"},{name:"stats-radio",description:"Radio health ‚Äî noise floor, airtime, duty cycle, and radio configuration.",body:["```","> stats-radio","  Radio Stats","","  Radio        906.875 MHz  SF11  BW 250 kHz  CR 4/5  22 dBm","","  Noise floor  -112 dBm","  Airtime used 4.2s  remaining: 55.8m","  Total airtime 1.2m","  Duty cycle   1.2%","  Utilization  0.8%","```"],searchText:"stats radio noise floor airtime duty cycle utilization"},{name:"status",description:"Quick summary of mode, neighbors, and uptime.",body:["**Alias:** `st`","```","> status","Local-Node  repeater","","  Mode       forward","  Neighbors  4 direct  12 total","  RX / TX    1284 / 37","  Uptime     2d 14h 32m","```"],searchText:"status st summary mode neighbors uptime"},{name:"top",description:"Live-updating system overview ‚Äî CPU/memory gauges, mesh counters, processes.",body:["**Alias:** `htop`","","Refreshes every 3s. Press **Ctrl+C** to exit.","```","> top","Local-Node  v1.0.0","‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ","  Sys 14d 3h 22m  Svc 2d 14h 32m  Load 0.42 0.38 0.35","","  CPU [‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë]  12.3%  4 cores","  Mem [‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë]  62.1%  412M/664M","  Dsk [‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë]  18.4%  5.2G/28.7G","  cpu_thermal: 48.2¬∞C","","  MESH","  Mode forward  Nbrs 4/12  Noise -112dBm  Air 1.2%","  RX 1284  TX 37  FWD 891  Drop 14","  RX/h 22  FWD/h 15","","  PROCS","    CPU   MEM  NAME","    8.2   3.1  python3","    2.1   1.4  cherrypy","","  14:32:08  ¬∑  Ctrl+C to exit","```","","Uses alternate screen buffer ‚Äî scrollback is preserved."],searchText:"top htop live system overview cpu memory gauges mesh processes"},{name:"uptime",description:"How long the repeater service has been running.",body:["```","> uptime","Uptime  2d 14h 32m","```"],searchText:"uptime service running duration"},{name:"ver",description:"Version info for all three components.",body:["**Alias:** `version`","```","> ver","  pyMC_Repeater  v1.0.0","  pyMC_Core      v1.12.0","  pyMC_Console   v1.0.0","```"],searchText:"ver version pymc repeater core console"}],Na=[{param:"name",category:"Identity",example:["> get name","name  Local-Node"]},{param:"role",category:"Identity",example:["> get role","role  repeater"]},{param:"lat",category:"Identity",example:["> get lat","lat  34.0522"],range:"-90 to 90"},{param:"lon",category:"Identity",example:["> get lon","lon  -118.2437"],range:"-180 to 180"},{param:"public.key",category:"Identity",example:["> get public.key","public.key  0A1B2C3D4E5F..."]},{param:"radio",category:"Radio",example:["> get radio","  freq  906.875 MHz","  bw    250 kHz","  sf    11","  cr    4/5","  tx    22 dBm"]},{param:"freq",category:"Radio",example:["> get freq","freq  906.875 MHz"],range:"100‚Äì1000 MHz"},{param:"tx",category:"Radio",example:["> get tx","tx  22 dBm"],range:"2‚Äì22 dBm"},{param:"bw",category:"Radio",example:["> get bw","bw  250 kHz"],range:"7.8‚Äì500 kHz"},{param:"sf",category:"Radio",example:["> get sf","sf  11"],range:"5‚Äì12"},{param:"cr",category:"Radio",example:["> get cr","cr  4/5"],range:"5‚Äì8"},{param:"af",category:"Timing",example:["> get af","‚ö† airtime_factor not yet exposed by pyMC_Repeater API.","  Firmware range: 0-9. Tracked in CLI-Alignment.md."],range:"0‚Äì9 (pending)"},{param:"txdelay",category:"Timing",example:["> get txdelay","txdelay  1.0"],range:"0.0‚Äì5.0"},{param:"direct.txdelay",category:"Timing",example:["> get direct.txdelay","direct.txdelay  0.5"],range:"0.0‚Äì5.0"},{param:"rxdelay",category:"Timing",example:["> get rxdelay","rxdelay  0.0"],range:"‚â• 0"},{param:"mode",category:"Repeater",example:["> get mode","mode  forward"],range:"forward / monitor"},{param:"duty",category:"Repeater",example:["> get duty","duty  on"],range:"on / off"},{param:"flood.max",category:"Repeater",example:["> get flood.max","flood.max  3"],range:"0‚Äì64"},{param:"advert.interval",category:"Repeater",example:["> get advert.interval","advert.interval  120m"],range:"0 (off) or 1‚Äì10080 min"},{param:"multi.acks",category:"Advanced",example:["> get multi.acks","multi.acks  0"],range:"0‚Äì255"},{param:"int.thresh",category:"Advanced",example:["> get int.thresh","int.thresh  -120 dBm"],range:"-200 to 0 dBm"},{param:"agc.reset.interval",category:"Advanced",example:["> get agc.reset.interval","agc.reset.interval  0"],range:"‚â• 0 (√ó4)"}],Ta=[{param:"name",category:"Identity",example:["> set name Local-Node","OK - node_name set to Local-Node"],range:"text (no [ ] \\ / : , ? *)"},{param:"lat",category:"Identity",example:["> set lat 34.0522","OK - latitude set to 34.0522"],range:"-90 to 90"},{param:"lon",category:"Identity",example:["> set lon -118.2437","OK - longitude set to -118.2437"],range:"-180 to 180"},{param:"freq",category:"Radio",example:["> set freq 906.875","OK - frequency set to 906875000"],range:"100‚Äì1000 MHz"},{param:"tx",category:"Radio",example:["> set tx 22","OK - tx_power set to 22"],range:"2‚Äì22 dBm"},{param:"bw",category:"Radio",example:["> set bw 250","OK - bandwidth set to 250000"],range:"7.8, 10.4, 15.6, 20.8, 31.25, 41.7, 62.5, 125, 250, 500 kHz"},{param:"sf",category:"Radio",example:["> set sf 11","OK - spreading_factor set to 11"],range:"5‚Äì12"},{param:"cr",category:"Radio",example:["> set cr 5","OK - coding_rate set to 5"],range:"5‚Äì8"},{param:"af",category:"Timing",example:["> set af 2","‚ö† airtime_factor not yet exposed by pyMC_Repeater API.","  Firmware range: 0-9. Needs backend support."],range:"0‚Äì9 (pending)"},{param:"txdelay",category:"Timing",example:["> set txdelay 1.0","OK - tx_delay_factor set to 1"],range:"0.0‚Äì5.0"},{param:"direct.txdelay",category:"Timing",example:["> set direct.txdelay 0.5","OK - direct_tx_delay_factor set to 0.5"],range:"0.0‚Äì5.0"},{param:"rxdelay",category:"Timing",example:["> set rxdelay 0","OK - rx_delay_base set to 0"],range:"‚â• 0"},{param:"mode",category:"Repeater",example:["> set mode forward","OK - Mode set to forward"],range:"forward / monitor"},{param:"flood.max",category:"Repeater",example:["> set flood.max 3","OK - max_flood_hops set to 3"],range:"0‚Äì64"},{param:"advert.interval",category:"Repeater",example:["> set advert.interval 120","OK - Local advert interval set to 120m"],range:"0 (off) or 1‚Äì10080 min"},{param:"duty",category:"Repeater",example:["> set duty on","OK - Duty cycle enabled"],range:"on / off"},{param:"log",category:"Repeater",example:["> set log info","OK - Log level set to INFO"],range:"debug, info, warning, error"},{param:"multi.acks",category:"Advanced",example:["> set multi.acks 0","OK - multi_acks set to 0"],range:"0‚Äì255"},{param:"int.thresh",category:"Advanced",example:["> set int.thresh -120","OK - interference_threshold set to -120"],range:"-200 to 0 dBm"},{param:"agc.reset.interval",category:"Advanced",example:["> set agc.reset.interval 8","OK - AGC reset interval set to 8"],range:"‚â• 0 (rounded to √ó4)"},{param:"prv.key",category:"Advanced",example:["> set prv.key <128-hex>","To set this key, run on the Pi:","","  sudo ./convert_firmware_key.sh <key>","","Then restart: sudo systemctl restart pymc-repeater"],range:"128-char hex (SSH only)"}];function Ra({mode:e}){const t="get"===e?Na:Ta,[s,o]=a.useState(0),i=t[s],c=a.useMemo(()=>{const e=new Map;for(const r of t){const t=e.get(r.category)||[];t.push(r),e.set(r.category,t)}return Array.from(e.entries())},[t]);return r.jsxs("div",{className:"flex flex-col gap-2",children:[r.jsx("div",{className:"flex flex-col gap-1.5",children:c.map(([e,a])=>r.jsxs("div",{className:"flex flex-wrap items-center gap-1",children:[r.jsx("span",{className:"text-xs text-fg-muted w-16 shrink-0 text-right pr-1",children:e}),a.map(e=>{const a=t.indexOf(e),i=a===s;return r.jsx("button",{onClick:()=>o(a),className:n("px-1.5 py-0.5 type-data-xs radius-badge transition-colors cursor-pointer",i?"bg-sys-blue text-fg-invert font-semibold":"bg-elevated text-fg-secondary hover:bg-elevated/80 hover:text-sys-blue"),children:e.param},e.param)})]},e))}),r.jsx("pre",{className:"px-3 py-2.5 radius-inner bg-body text-fg-secondary type-code overflow-x-auto border border-edge-subtle",children:i.example.map((e,t)=>r.jsx("div",{children:e||"¬†"},t))}),i.range&&r.jsxs("p",{className:"text-xs text-fg-muted",children:[r.jsx("span",{className:"text-fg-secondary font-medium",children:i.param})," ‚Äî ",i.range]})]})}function Ea(e,t){const a=e.split(/(\*\*[^*]+\*\*)/g);return r.jsx("span",{children:a.map((e,t)=>e.startsWith("**")&&e.endsWith("**")?r.jsx("strong",{className:"text-fg-primary font-semibold",children:e.slice(2,-2)},t):e.split(/(`[^`]+`)/g).map((e,a)=>e.startsWith("`")&&e.endsWith("`")?r.jsx("code",{className:"px-1 py-0.5 radius-badge bg-elevated text-sys-blue type-data-xs",children:e.slice(1,-1)},`${t}-${a}`):r.jsx("span",{children:e},`${t}-${a}`)))},t)}function Aa({lines:e}){const t=[];let a=0;for(;a<e.length;){const s=e[a];if("```"===s){const s=[];for(a++;a<e.length&&"```"!==e[a];)s.push(e[a]),a++;a++,t.push(r.jsx("pre",{className:"px-3 py-2.5 my-2 radius-inner bg-body text-fg-secondary type-code overflow-x-auto border border-edge-subtle",children:s.map((e,t)=>r.jsx("div",{children:e||"¬†"},t))},t.length));continue}s.trim()?s.startsWith("- ")?(t.push(r.jsxs("div",{className:"flex gap-2 text-sm text-fg-secondary pl-2 py-0.5",children:[r.jsx("span",{className:"text-fg-muted shrink-0",children:"‚Ä¢"}),r.jsx("span",{children:Ea(s.slice(2),0)})]},t.length)),a++):(t.push(r.jsx("p",{className:"text-sm text-fg-secondary py-0.5",children:Ea(s,0)},t.length)),a++):(t.push(r.jsx("div",{className:"h-1.5"},t.length)),a++)}return r.jsx(r.Fragment,{children:t})}function Ia({isOpen:e,onClose:t,onUseCommand:c}){const[l,d]=a.useState(""),u=a.useMemo(()=>{if(!l.trim())return ja;const e=l.toLowerCase();return ja.filter(t=>t.name.includes(e)||t.searchText.includes(e)||t.description.toLowerCase().includes(e))},[l]),p=l.trim().length>0;return r.jsxs(E,{open:e,onClose:t,size:"3xl",motionPlus:!0,className:"sm:min-w-[540px] md:min-w-[680px]",children:[r.jsx(A,{icon:r.jsx(ue,{size:20}),title:"Terminal Command Guide",onClose:t}),r.jsxs(I,{className:"flex flex-col gap-0 !px-0 !py-0",children:[r.jsx("div",{className:"sticky top-0 z-10 px-5 py-3 border-b border-edge-subtle bg-surface/95 backdrop-blur-sm",children:r.jsxs("div",{className:"relative",children:[r.jsx(le,{size:14,className:"absolute left-2.5 top-1/2 -translate-y-1/2 text-fg-muted"}),r.jsx("input",{type:"text",value:l,onChange:e=>d(e.target.value),placeholder:"Search commands...",className:"w-full pl-8 pr-3 py-1.5 text-sm bg-elevated border border-edge-subtle radius-inner text-fg-primary placeholder:text-fg-muted focus:outline-none focus:ring-1 focus:ring-sys-blue/50",autoFocus:!0})]})}),r.jsxs("div",{className:"overflow-y-auto px-5 py-3 h-[420px] sm:h-[520px] md:h-[600px]",children:[r.jsx(L,{mode:"popLayout",children:0===u.length?r.jsxs(B.div,{initial:{opacity:0,scale:.96},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.96},transition:{duration:O.normal,ease:D.easeOut},className:"flex flex-col items-center gap-2 py-10 text-fg-muted",children:[r.jsx(le,{className:"w-6 h-6 opacity-40"}),r.jsxs("p",{className:"text-sm",children:['No commands match "',l,'"']})]},"empty"):r.jsx(B.div,{initial:!1,className:"flex flex-col gap-1",children:r.jsx(L,{initial:!1,children:u.map(e=>r.jsx(B.div,{layout:"position",initial:{opacity:0,y:-4},animate:{opacity:1,y:0},exit:{opacity:0,y:-4},transition:P.fade,className:"min-w-0",children:r.jsx(s,{children:({open:t})=>r.jsxs("div",{className:n("radius-inner border transition-colors",t?"border-edge-subtle bg-elevated/50":"border-transparent hover:bg-elevated/30"),children:[r.jsxs("div",{className:"flex items-center w-full min-w-0",children:[r.jsxs(o,{className:"flex items-center gap-3 flex-1 min-w-0 px-3 py-2 text-left cursor-pointer",children:[r.jsx(de,{size:14,className:n("shrink-0 text-fg-muted transition-transform duration-150",t&&"rotate-90")}),r.jsx("code",{className:"text-sm font-semibold text-sys-blue font-mono shrink-0",children:e.name}),r.jsx("span",{className:"text-xs text-fg-muted truncate min-w-0",children:e.description})]}),c&&r.jsx("button",{onClick:t=>{t.stopPropagation(),c(e.name)},className:"shrink-0 mr-2 px-2 py-0.5 text-xs font-semibold uppercase tracking-wider radius-badge bg-elevated text-fg-muted hover:text-sys-blue hover:bg-elevated/80 transition-colors cursor-pointer",title:`Use "${e.name}" in terminal`,children:"use"})]}),r.jsx(i,{className:"px-3 pb-3 pt-0 pl-9",children:e.interactive?r.jsx(Ra,{mode:e.interactive}):r.jsx(Aa,{lines:e.body})})]})})},e.name))})},"list")}),r.jsx(L,{children:!p&&r.jsxs(B.div,{initial:{opacity:0,y:6},animate:{opacity:1,y:0},exit:{opacity:0,y:6},transition:{duration:O.normal,ease:D.easeOut},className:"mt-4 px-3 py-3 radius-inner border border-edge-subtle bg-elevated/30",children:[r.jsx("p",{className:"text-xs font-semibold text-fg-muted mb-2",children:"Tips"}),r.jsxs("div",{className:"flex flex-col gap-1 text-xs text-fg-muted",children:[r.jsxs("p",{children:["Type ",r.jsx("code",{className:"px-1 py-0.5 radius-badge bg-elevated text-sys-blue font-mono",children:"<command> help"})," in the terminal for detailed usage."]}),r.jsxs("p",{children:["Most commands have shorter aliases (e.g. ",r.jsx("code",{className:"px-1 py-0.5 radius-badge bg-elevated text-sys-blue font-mono",children:"st"}),", ",r.jsx("code",{className:"px-1 py-0.5 radius-badge bg-elevated text-sys-blue font-mono",children:"nb"}),", ",r.jsx("code",{className:"px-1 py-0.5 radius-badge bg-elevated text-sys-blue font-mono",children:"id"}),")."]}),r.jsxs("p",{children:["Signal bars ",r.jsx("span",{className:"font-mono",children:"‚ñÅ‚ñÉ‚ñÖ‚ñá‚ñà"})," are colored by link quality grade based on RSSI, SNR, and radio config."]}),r.jsx("p",{children:"Captures are stored in browser session only ‚Äî export before closing the tab."})]})]})})]})]})]})}function Fa({onUseCommand:e}){const[t,s]=a.useState(!1),n=e?t=>{s(!1),e(t)}:void 0;return r.jsxs(r.Fragment,{children:[r.jsx(ae,{icon:r.jsx(ue,{size:17,className:"translate-y-px"}),onClick:()=>s(!0),title:"CLI Command Guide"}),r.jsx(Ia,{isOpen:t,onClose:()=>s(!1),onUseCommand:n})]})}const La=function(){const e=new he,t=new ht(e);return e.register(t,new gt,new yt,new Jr,new Qr,new xt,new vt,new wt,new Zr,new ta,new aa,new zt,new Qt,new lr,new Zt,new er,new dr,new _r,new kr,new Cr,new Sr,new Mr,new jr,new Ur,new Gr,new Yr,new ka),e}(),Ba=La.all().flatMap(e=>[{cmd:e.name,desc:e.description,params:e.params,required:!!e.params},...e.aliases.filter(e=>e.includes(" ")).map(t=>({cmd:t,desc:e.description,params:e.params,required:!!e.params}))]);Ba.push({cmd:"start cap",desc:"Start packet capture",params:"[seconds]",required:!0},{cmd:"end cap",desc:"Stop capture"},{cmd:"list cap",desc:"List captures"},{cmd:"export cap",desc:"Download capture",params:"[id]",required:!0});const Da=["sig","name","rssi","snr","dist","heard"],Oa={get:["name","role","lat","lon","radio","freq","tx","bw","sf","cr","af","txdelay","direct.txdelay","rxdelay","mode","repeat","flood.max","flood.advert.interval","advert.interval","duty","duty.max","multi.acks","int.thresh","agc.reset.interval","public.key","prv.key"],set:["name","lat","lon","freq","tx","bw","sf","cr","af","txdelay","direct.txdelay","rxdelay","mode","repeat","flood.max","flood.advert.interval","advert.interval","duty","log","multi.acks","int.thresh","agc.reset.interval","prv.key"],convert:["hex","base64"],neighbors:Da,nb:Da,"get neighbors":Da,"get neighbor":Da,"set mode":["forward","monitor"],"set duty":["on","off"],"set repeat":["on","off"],"set tx":["10","14","17","20","22"],"set sf":["7","8","9","10","11","12"],"set bw":["125","250","500"],"set cr":["5","6","7","8"],"set af":["0.5","1.0","1.5","2.0"],"set txdelay":["0.5","0.7","1.0","1.5"],"set direct.txdelay":["0.3","0.5","0.7"],"set log":["debug","info","warning","error"],"start cap":["30","60","120","300"]},Pa=["@@@@@@@   @@@ @@@  @@@@@@@@@@    @@@@@@@  ","@@@@@@@@  @@@ @@@  @@@@@@@@@@@  @@@@@@@@  ","@@!  @@@  @@! !@@  @@! @@! @@!  !@@       ","!@!  @!@  !@! @!!  !@! !@! !@!  !@!       ","@!@@!@!    !@!@!   @!! !!@ @!@  !@!       ","!!@!!!      @!!!   !@!   ! !@!  !!!       ","!!:         !!:    !!:     !!:  :!!       ",":!:         :!:    :!:     :!:  :!:       "," ::          ::    :::     ::    ::: :::  "," :           :      :      :     :: :: :  "];function Ua(){return/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)||window.innerWidth<640}function za(){const e=U(),{addCommand:t}=Ca(),s=a.useRef(null),o=a.useRef(null),i=a.useRef(null),u=a.useRef(null),p=a.useRef(""),m=a.useRef(-1),g=a.useRef(""),f=a.useRef(!1),y=a.useRef(null),x=a.useRef(!1),v=a.useRef(!1),$=a.useRef(!1),b=a.useRef([]),w=a.useRef(()=>{}),_=z(),[k,C]=a.useState("C0dE"),[S,M]=a.useState(!1),j=a.useRef(null),N="C0dE",T=a.useCallback(e=>{j.current&&(clearInterval(j.current),j.current=null);const t=N.padEnd(7),r=t+"  "+e+"  "+t;let a=0;const s=r.length-7;M(!0),C(r.slice(0,7)),j.current=setInterval(()=>{if(a++,a>s)return clearInterval(j.current),j.current=null,M(!1),void C(N);C(r.slice(a,a+7))},280)},[]);a.useEffect(()=>{const e=function(e){const t=t=>e(t.detail);return qr.addEventListener(Kr,t),()=>qr.removeEventListener(Kr,t)}(T),t=setInterval(()=>{Math.random()<.02&&T(Hr())},45e3);return()=>{e(),clearInterval(t),j.current&&clearInterval(j.current)}},[T]);const[R,E]=a.useState(!1),A=a.useRef(null);a.useEffect(()=>{const e=(t=()=>{A.current&&clearTimeout(A.current),E(!0),A.current=setTimeout(()=>E(!1),5e3)},Xr.addEventListener(Vr,t),()=>Xr.removeEventListener(Vr,t));var t;return()=>{e(),A.current&&clearTimeout(A.current)}},[]);const[I,F]=a.useState({show:!1,options:[],selectedIndex:0,input:""}),L=a.useRef([]),B=a.useRef(0);a.useEffect(()=>{(null==e?void 0:e.neighbors)&&(b.current=Object.values(e.neighbors).map(e=>e.node_name||e.name).filter(e=>!!e).sort())},[null==e?void 0:e.neighbors]);const D=a.useCallback(()=>{var e;null==(e=o.current)||e.write(`[1;92m${H()||"user"}@pyMC${ye}: [38;2;91;91;214m$${ye} `)},[]),O=a.useCallback(()=>{const e=o.current;e&&(e.write(He),D(),e.write(p.current))},[D]),P=a.useCallback(e=>{const t=function(e,t){const r=e.toLowerCase(),a=r.trim();if(!a)return[];const s=r.length>a.length&&r.endsWith(" ");if(!a.includes(" ")&&!s)return Ba.filter(e=>e.cmd.toLowerCase().startsWith(a));const n=s?a:a.substring(0,a.lastIndexOf(" ")),o=s?"":a.substring(a.lastIndexOf(" ")+1);if("ping"===n&&t.length>0)return t.filter(e=>e.toLowerCase().startsWith(o)).slice(0,10).map(e=>({cmd:`ping ${e}`,desc:`‚Üí ${e}`}));const i=Oa[n];if(i){const e=i.filter(e=>e.toLowerCase().startsWith(o)).map(e=>({cmd:`${n} ${e}`,desc:`‚Üí ${e}`}));if(!s&&o){const t=new Set(e.map(e=>e.cmd));for(const r of Ba){const s=r.cmd.toLowerCase();s.startsWith(a)&&!t.has(s)&&(e.push(r),t.add(s))}}return e}return Ba.filter(e=>e.cmd.toLowerCase().startsWith(a))}(e,b.current);L.current=t,B.current=0;const r=t.length>0&&e.trim().length>0;F({show:r,options:t,selectedIndex:0,input:e.trim()})},[]),W=a.useCallback(()=>{L.current=[],B.current=0,F({show:!1,options:[],selectedIndex:0,input:""})},[]),G=a.useCallback(e=>{var t;const r=L.current[e];r&&(p.current=r.required?r.cmd+" ":r.cmd,O(),r.required?P(p.current):W(),null==(t=o.current)||t.focus())},[O,P,W]),X=a.useCallback(async e=>{const r=o.current;if(!r)return;const a=e.trim();if(!a)return void D();f.current=!0;const s=new AbortController;y.current=s,t(a),m.current=-1;let n=0;const i={get cols(){return r.cols},get rows(){return r.rows},write(e,t="default"){const a=("default"===t?e:Ne(e,t)).split("\n");for(const s of a)r.writeln(s);return n=Ve(a,r.cols),String(n)},update(e,t,a){if($.current)r.write("[H");else if(n>0)for(let o=0;o<n;o++)r.write(qe()),r.write(He);const s=(a?Ne(t,a):t).split("\n");if($.current){for(const e of s)r.write(e+"[K\r\n");r.write("[J")}else for(const n of s)r.writeln(n);n=Ve(s,r.cols)},clear(){r.clear(),n=0},enterFullscreen(){r.write("[?1049h[?25l"),$.current=!0,n=0},exitFullscreen(){r.write(We+Ke),$.current=!1,n=0}};r.writeln("");const c=La.find(a);if(c){const e=a.split(/\s+/);try{await c.execute({output:i,args:e,rawInput:a,cols:r.cols,signal:s.signal})}catch(l){l instanceof DOMException&&"AbortError"===l.name||i.write(`Error: ${l instanceof Error?l.message:"Command failed"}`,"error")}}else i.write(`Unknown command: ${a}\nType 'help' for available commands.`,"error");y.current=null,f.current=!1,r.writeln(""),D()},[t,D]),V=a.useCallback(e=>{const t=o.current;if(!t)return;if(!v.current)return;if(f.current){for(let r=0;r<e.length;r++)3===e.charCodeAt(r)&&y.current&&(y.current.abort(),t.writeln("^C"));return}const r=Ca.getState().commandHistory,a=e=>requestAnimationFrame(()=>{var t;return null==(t=document.querySelector(`[data-ac-index="${e}"]`))?void 0:t.scrollIntoView({block:"nearest"})});for(let s=0;s<e.length;s++){const n=e.charCodeAt(s);if(13===n){if(L.current.length>0){const e=L.current[B.current];e&&(p.current=e.cmd,O())}W();const e=p.current;p.current="",t.writeln(""),X(e);continue}if(127!==n&&8!==n)if(3!==n)if(12!==n)if(9!==n)if(27!==n)n>=32&&(p.current+=e[s],t.write(e[s]),m.current=-1,P(p.current));else{if(91===e.charCodeAt(s+1)){const t=e.charCodeAt(s+2);if(s+=2,65===t){if(L.current.length>0){const e=Math.max(B.current-1,0);B.current=e,F(t=>({...t,selectedIndex:e})),a(e)}else r.length>0&&(-1===m.current&&(g.current=p.current),m.current<r.length-1&&(m.current++,p.current=r[r.length-1-m.current]||"",O()));continue}if(66===t){if(L.current.length>0){const e=Math.min(B.current+1,L.current.length-1);B.current=e,F(t=>({...t,selectedIndex:e})),a(e)}else m.current>0?(m.current--,p.current=r[r.length-1-m.current]||"",O()):0===m.current&&(m.current=-1,p.current=g.current,O());continue}if(67===t||68===t)continue;continue}L.current.length>0&&W()}else L.current.length>0&&G(B.current);else t.clear(),W(),O();else p.current="",W(),t.writeln("^C"),D();else p.current.length>0&&(p.current=p.current.slice(0,-1),t.write("\b \b"),P(p.current))}},[W,P,G,D,O,X]);a.useEffect(()=>{w.current=V},[V]);const Y=a.useCallback(async()=>{const e=o.current;if(!e||x.current)return;x.current=!0;const t="[94m",r="[0m",a=Pa.length;try{const t=wa(Pa,0);for(const r of t)e.writeln(r);await new Promise(t=>{let r=0;const s=setInterval(()=>{if(r>=26)return clearInterval(s),void t();r++,e.write(`[${a}F`);const n=wa(Pa,r);for(const t of n)e.write(`[2K${t}\n`)},80)})}finally{ba()}e.writeln(""),e.write(Ae("‚óè Initializing terminal...")),await new Promise(e=>setTimeout(e,300)),e.write(He),e.writeln(`${t}‚úì Initializing terminal...${r}`),e.write(Ae("‚óè Connecting to repeater...")),await new Promise(e=>setTimeout(e,500)),e.write(He),"connected"===q.getState().health?e.writeln(`${t}‚úì Connected to repeater${r}`):e.writeln(`${_e}~ Connection status unknown${ye}`),e.writeln(Ae("Ready. Type 'help' for commands.")),e.writeln(""),D(),v.current=!0},[D]);a.useEffect(()=>{const e=s.current;if(!e)return;const t=new c({theme:Je(),fontFamily:'"JetBrains Mono", "IBM Plex Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace',fontSize:13,lineHeight:.65,cursorBlink:!1,cursorStyle:"underline",scrollback:1e4,convertEol:!0,allowTransparency:!0,rightClickSelectsWord:!1}),r=new l;t.loadAddon(r),t.loadAddon(new d),t.open(e),r.fit(),o.current=t,i.current=r;const a=t.onData(e=>w.current(e)),n=function(e){return h.subscribe(()=>{e.options.theme=Je()})}(t),u=new ResizeObserver(()=>{requestAnimationFrame(()=>r.fit())});return u.observe(e),Y(),Ua()||t.focus(),()=>{var e;null==(e=y.current)||e.abort(),$.current&&(t.write(We+Ke),$.current=!1),a.dispose(),n(),u.disconnect(),t.dispose(),o.current=null,i.current=null}},[]);const J=a.useCallback(e=>{const t=e.target.value;t.length>0&&(V(t),e.target.value="")},[V]),Q=a.useCallback(e=>{"Enter"===e.key?(e.preventDefault(),V("\r")):"Backspace"===e.key?(e.preventDefault(),V("")):"ArrowUp"===e.key?(e.preventDefault(),V("[A")):"ArrowDown"===e.key&&(e.preventDefault(),V("[B"))},[V]),Z=a.useCallback(()=>{var e,t;Ua()?null==(e=u.current)||e.focus():null==(t=o.current)||t.focus()},[]);a.useEffect(()=>{if(!Ua())return;const e=()=>{var e;const t=null==(e=s.current)?void 0:e.querySelector(".xterm-viewport");t&&(t.scrollTop=t.scrollHeight),requestAnimationFrame(()=>{var e;return null==(e=i.current)?void 0:e.fit()})},t=window.visualViewport;if(t){const r=()=>{t.height<.75*window.innerHeight&&e()};return t.addEventListener("resize",r),()=>t.removeEventListener("resize",r)}const r=u.current;if(r){const t=()=>setTimeout(e,300);return r.addEventListener("focus",t),()=>r.removeEventListener("focus",t)}},[]);const ee=a.useCallback(e=>{p.current=e+" ",O(),P(p.current),setTimeout(()=>{var e;null==(e=s.current)||e.click()},400)},[O,P]);return r.jsxs(ne,{children:[r.jsx(oe,{title:"Terminal",icon:r.jsx(K,{})}),r.jsx(ie,{children:r.jsxs("div",{className:"terminal-card flex flex-col gap-1.5",children:[r.jsxs("div",{className:"card-terminal-header flex-wrap",children:[r.jsx("span",{className:"seven-seg-panel",children:r.jsx(se,{text:k,minChars:7,size:24,noCycle:S})}),r.jsxs("div",{className:"header-well flex items-center gap-1 sm:order-last",children:[r.jsx(Fa,{onUseCommand:ee}),r.jsx(Ma,{})]}),r.jsx("div",{className:"card-terminal-ridge flex-1 min-w-4 sm:hidden"}),r.jsx("div",{className:"header-well self-stretch flex-col sm:order-first",children:r.jsxs("div",{className:"indicator-key"+("connected"===_?" indicator-key--active":"degraded"===_?" indicator-key--sending":""),children:[r.jsx("span",{className:"indicator-key__label",children:"ONLINE"}),r.jsx("span",{className:"indicator-key__led"})]})}),r.jsx("div",{className:"card-terminal-ridge flex-1 min-w-8 hidden sm:block"})]}),r.jsx(ce,{noPadding:!0,className:"flex flex-col flex-1 min-h-0 overflow-hidden card-terminal",onClick:Z,children:r.jsxs("div",{className:"card-terminal-well flex-1 min-h-0 flex flex-col overflow-hidden",children:[r.jsxs("div",{className:"flex-1 min-h-0 terminal-gutter relative",children:[r.jsx("div",{ref:s,className:"h-full w-full"}),R&&r.jsxs("div",{className:"absolute inset-0 z-10 flex items-center justify-center",onClick:()=>E(!1),children:[r.jsx("div",{className:"absolute inset-0 animate-[partytime-bg_5s_ease-out_forwards]",style:{background:"rgba(0,0,0,0.82)"}}),r.jsxs("div",{className:"relative z-10 animate-[partytime-crt_5s_ease-out_forwards] partytime-glow",children:[r.jsx("img",{src:"/assets/partytime.gif",alt:"No way.",className:"max-h-[60vh] max-w-[70vw] object-contain rounded"}),r.jsx("div",{className:"absolute inset-0 pointer-events-none rounded partytime-scanlines"})]})]})]}),I.show&&I.options.length>0&&r.jsxs("div",{className:"flex-shrink-0 overflow-hidden terminal-completions",style:{borderTop:"1px solid var(--terminal-border)",background:"var(--terminal-bg-input)"},children:[r.jsx("div",{className:"overflow-y-auto",style:{maxHeight:"176px"},children:I.options.map((e,t)=>{const a=t===I.selectedIndex,s=I.input.length;return r.jsxs("div",{"data-ac-index":t,onClick:()=>G(t),className:n("flex items-baseline gap-2 px-3 py-0.5 cursor-pointer transition-colors",a?"text-sys-blue":"text-fg-primary"),style:{background:a?"var(--terminal-autocomplete-hover)":void 0},onMouseEnter:e=>{a||(e.currentTarget.style.background="var(--terminal-autocomplete-hover)")},onMouseLeave:e=>{a||(e.currentTarget.style.background="")},children:[r.jsx("span",{className:"w-3 shrink-0 text-center text-sys-blue opacity-80",children:a?"‚ñ∏":""}),r.jsxs("span",{className:"min-w-0 truncate flex-1",children:[r.jsx("span",{className:"font-semibold text-sys-blue",children:e.cmd.substring(0,s)}),e.cmd.substring(s)]}),r.jsx("span",{className:"shrink-0 text-[11px] text-fg-muted pl-3",children:e.desc})]},e.cmd)})}),r.jsxs("div",{className:"flex justify-between items-center px-3 py-0.5 text-xs text-fg-muted",style:{borderTop:"1px solid var(--terminal-border)"},children:[r.jsx("span",{children:"Tab ¬∑ ‚Üë‚Üì ¬∑ Esc"}),r.jsxs("span",{children:[I.options.length," match",1!==I.options.length?"es":""]})]})]}),r.jsx("input",{ref:u,type:"text",className:"sr-only",onChange:J,onKeyDown:Q,autoComplete:"off",autoCorrect:"off",autoCapitalize:"off",spellCheck:!1,"aria-label":"Terminal input"}),r.jsxs("div",{className:"px-3 sm:px-4 py-1 flex justify-between text-xs text-fg-muted",style:{borderTop:"1px solid var(--terminal-border)"},children:[r.jsx("span",{className:"hidden sm:inline",children:"‚Üë‚Üì History ¬∑ Tab ¬∑ Esc"}),r.jsx("span",{className:"sm:hidden",children:"Terminal"}),(null==e?void 0:e.version)&&r.jsxs("span",{children:["pyMC v",e.version]})]})]})})]})})]})}export{za as default};
