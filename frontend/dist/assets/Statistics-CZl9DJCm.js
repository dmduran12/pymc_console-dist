import{c as e,j as t,H as a,I as n,e as s,S as r,k as l,J as i,K as o,N as c,R as d}from"./index-CSdhf7Y1.js";import{b as m,d as h,i as u,L as x,C as p,X as f,Y as y,T as g,j as b,e as v}from"./recharts-CGff6_7g.js";import{u as N,T as M}from"./TimeRangeSelector-CifvQwCH.js";import{u as k}from"./usePolling-9BR4yMYM.js";import{C as w,b as $,P as A,a as F,G as j,c as T}from"./PageLayout-BRt4BPq0.js";import{I as z}from"./info-vNBQjtbp.js";import{T as S}from"./triangle-alert-JEH_fId4.js";import{T as C,N as L}from"./trending-up-DsTELlWj.js";import"./maplibre-gl-DsiI67my.js";const B=e("chart-pie",[["path",{d:"M21 12c.552 0 1.005-.449.95-.998a10 10 0 0 0-8.953-8.951c-.55-.055-.998.398-.998.95v8a1 1 0 0 0 1 1z",key:"pzmjnu"}],["path",{d:"M21.21 15.89A10 10 0 1 1 8 2.83",key:"k2fpak"}]]),D=e("circle-check-big",[["path",{d:"M21.801 10A10 10 0 1 1 17 3.335",key:"yps3ct"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]]),W=e("compass",[["path",{d:"m16.24 7.76-1.804 5.411a2 2 0 0 1-1.265 1.265L7.76 16.24l1.804-5.411a2 2 0 0 1 1.265-1.265z",key:"9ktpf1"}],["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]]),E=e("hash",[["line",{x1:"4",x2:"20",y1:"9",y2:"9",key:"4lhtct"}],["line",{x1:"4",x2:"20",y1:"15",y2:"15",key:"vyu0kd"}],["line",{x1:"10",x2:"8",y1:"3",y2:"21",key:"1ggp8o"}],["line",{x1:"16",x2:"14",y1:"3",y2:"21",key:"weycgp"}]]);function R(e){return"undefined"==typeof window?"":getComputedStyle(document.documentElement).getPropertyValue(e).trim()}const P={chart1:"#71F8E5",chart2:"#39D98A",chart3:"#F9D26F",chart4:"#FF5C7A",chart5:"#B49DFF",chart6:"#60A5FA",chart7:"#F472B6",chart8:"#FB923C"};function _(){const[e,t]=m.useState(P);return m.useEffect(()=>{const e=()=>{const e={chart1:R("--chart-1")||P.chart1,chart2:R("--chart-2")||P.chart2,chart3:R("--chart-3")||P.chart3,chart4:R("--chart-4")||P.chart4,chart5:R("--chart-5")||P.chart5,chart6:R("--chart-6")||P.chart6,chart7:R("--chart-7")||P.chart7,chart8:R("--chart-8")||P.chart8};t(e)};e();const a=new MutationObserver(t=>{for(const a of t)if("data-theme"===a.attributeName){setTimeout(e,50);break}});return a.observe(document.documentElement,{attributes:!0}),()=>{a.disconnect()}},[]),e}function I(e){const t=e.match(/\(([^)]+)\)\s*$/);return t?t[1]:e.length>10?e.slice(0,10):e}function O({x:e,y:a,width:n,height:s,name:r,size:l,index:i,colors:o,depth:c,hoveredIndex:d,onHover:m,total:h}){if(1!==c)return null;const u=null!==d&&!(d===i),x=o[i%o.length],p=h>0?l/h*100:0,f=n>36&&s>20,y=n>36&&s>32,g=I(r);return t.jsxs("g",{onMouseEnter:e=>m(i,e),onMouseLeave:()=>m(null),style:{cursor:"default"},children:[t.jsx("rect",{x:e,y:a,width:n,height:s,fill:x,opacity:u?.4:1,stroke:"rgba(0,0,0,0.2)",strokeWidth:1,rx:3,style:{transition:"opacity 150ms ease"}}),f&&t.jsxs(t.Fragment,{children:[y&&t.jsxs("text",{x:e+4,y:a+s-4-11,textAnchor:"start",dominantBaseline:"auto",fill:"rgba(0,0,0,0.6)",fontSize:8,fontFamily:"'JetBrains Mono', monospace",fontWeight:500,style:{pointerEvents:"none"},children:[p.toFixed(1),"%"]}),t.jsx("text",{x:e+4,y:a+s-4,textAnchor:"start",dominantBaseline:"auto",fill:"rgba(0,0,0,0.85)",fontSize:9,fontFamily:"'JetBrains Mono', monospace",fontWeight:600,style:{pointerEvents:"none"},children:g})]})]})}function H({data:e,total:a,color:n,position:s,containerWidth:r}){if(!e||!s)return null;const l=(e.value/a*100).toFixed(1),i=r-s.x<184?Math.max(8,s.x-160-8):s.x+16;return t.jsx("div",{className:"absolute z-50 pointer-events-none",style:{left:i,top:Math.max(8,s.y-60)},children:t.jsxs("div",{className:"bg-bg-surface/95 backdrop-blur-sm border border-border-subtle rounded-lg px-3 py-2 shadow-lg min-w-[140px]",children:[t.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[t.jsx("span",{className:"w-2.5 h-2.5 rounded-sm flex-shrink-0",style:{backgroundColor:n}}),t.jsx("span",{className:"type-data-sm font-semibold text-text-primary",children:I(e.name)})]}),t.jsxs("div",{className:"space-y-0.5 type-data-xs text-text-muted",children:[t.jsxs("div",{className:"flex justify-between gap-4",children:[t.jsx("span",{children:"Count"}),t.jsx("span",{className:"text-text-primary tabular-nums font-medium",children:e.value.toLocaleString()})]}),t.jsxs("div",{className:"flex justify-between gap-4",children:[t.jsx("span",{children:"Share"}),t.jsxs("span",{className:"text-text-primary tabular-nums font-medium",children:[l,"%"]})]}),t.jsxs("div",{className:"flex justify-between gap-4",children:[t.jsx("span",{children:"Total"}),t.jsx("span",{className:"text-text-primary tabular-nums font-medium",children:a.toLocaleString()})]})]})]})})}const J=m.memo(function({data:e}){var a,n;const[s,r]=m.useState(null),[l,i]=m.useState(null),[o,c]=m.useState(0),d=m.useRef(null),x=function(){const e=_();return[e.chart1,e.chart2,e.chart3,e.chart4,e.chart5,e.chart6,e.chart7,e.chart8]}(),{treemapData:p,total:f}=m.useMemo(()=>{const t=e.reduce((e,t)=>e+t.value,0);return{treemapData:[...e].sort((e,t)=>t.value-e.value).filter(e=>t>0&&e.value/t*100>=.5).map((e,t)=>({name:e.name,size:e.value,index:t})),total:t}},[e]),y=m.useCallback((e,t)=>{if(r(e),t&&null!==e){const e=d.current;if(e){const a=e.getBoundingClientRect();c(a.width),i({x:t.clientX-a.left,y:t.clientY-a.top})}}else i(null)},[]),g=null!==s?{name:(null==(a=p[s])?void 0:a.name)??"",value:(null==(n=p[s])?void 0:n.size)??0}:null,b=null!==s?x[s%x.length]:"";return 0===e.length||0===f?t.jsx("div",{className:"h-56 flex items-center justify-center text-text-muted",children:"No packet type data available"}):t.jsxs("div",{className:"h-56 relative treemap-container",ref:d,children:[t.jsx(h,{width:"100%",height:"100%",children:t.jsx(u,{data:p,dataKey:"size",aspectRatio:4/3,stroke:"none",isAnimationActive:!1,content:t.jsx(O,{x:0,y:0,width:0,height:0,name:"",value:0,size:0,index:0,colors:x,depth:0,hoveredIndex:s,onHover:y,total:f})})}),t.jsx(H,{data:g,total:f,color:b,position:l,containerWidth:o})]})}),U={r:57,g:217,b:138},G={r:176,g:176,b:195};function K({active:e,payload:a,label:n}){if(!e||!a||0===a.length)return null;const s=a.filter(e=>null!==e.value&&void 0!==e.value);if(0===s.length)return null;const r=n?new Date(1e3*n).toLocaleString([],{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit",hour12:!1}):"";return t.jsxs("div",{className:"bg-bg-surface/95 backdrop-blur-sm border border-border-subtle rounded-lg px-3 py-2 text-sm",children:[t.jsx("div",{className:"font-medium text-text-primary mb-1 font-mono",children:r}),s.map((e,a)=>t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("div",{className:"w-3 h-0.5",style:{backgroundColor:e.color}}),t.jsxs("span",{className:"text-text-muted",children:[e.name,":"]}),t.jsxs("span",{className:"text-text-primary tabular-nums font-mono",children:[Number(e.value).toFixed(2),"%"]})]},a))]})}function X({payload:e}){return e?t.jsx("div",{className:"flex items-center gap-6 justify-center text-xs font-mono",children:e.map((e,a)=>t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("div",{className:"w-4 h-0.5",style:{backgroundColor:e.color}}),t.jsx("span",{className:"text-text-muted",children:e.value})]},a))}):null}const q=m.memo(function({samples:e,startTs:a,endTs:n,yMax:s=30}){const r=m.useRef(null),l=m.useRef(null),i=m.useMemo(()=>{if(0===e.length)return[];const t=Math.max(1,Math.floor(e.length/400)),a=[];for(let n=0;n<e.length;n+=t){const t=e[n];t&&"number"==typeof t.timestamp&&!isNaN(t.timestamp)&&a.push({timestamp:t.timestamp,rx:"number"!=typeof t.rxUtilW||isNaN(t.rxUtilW)?0:t.rxUtilW,tx:"number"!=typeof t.txUtilW||isNaN(t.txUtilW)?0:t.txUtilW})}return a},[e]),o=m.useMemo(()=>Math.max(1,Math.floor(i.length/8)),[i.length]);return m.useEffect(()=>{const t=r.current,i=l.current;if(!t||!i)return;const o=()=>{const r=t.getBoundingClientRect(),l=Math.max(1,Math.floor(r.width)),o=Math.max(1,Math.floor(r.height)),c=window.devicePixelRatio||1;i.width=Math.floor(l*c),i.height=Math.floor(o*c),i.style.width=`${l}px`,i.style.height=`${o}px`;const d=i.getContext("2d");if(!d)return;d.setTransform(c,0,0,c,0,0);const m=function(e,t,a,n){const s=Array.from({length:n},()=>({rxMax:0,txMax:0,rxHits:0,txHits:0,rxAvg:0,txAvg:0})),r=a-t;if(r<=0||n<=0)return s;const l=new Float64Array(n),i=new Float64Array(n),o=new Uint32Array(n);for(const c of e){if(c.timestamp<t||c.timestamp>a)continue;const e=Math.min(n-1,Math.max(0,Math.floor((c.timestamp-t)/r*n)));o[e]++,l[e]+=c.rxUtilW,i[e]+=c.txUtilW,c.rxUtilW>s[e].rxMax&&(s[e].rxMax=c.rxUtilW),c.txUtilW>s[e].txMax&&(s[e].txMax=c.txUtilW),c.rxUtilW>0&&s[e].rxHits++,c.txUtilW>0&&s[e].txHits++}for(let c=0;c<n;c++){const e=o[c]||1;s[c].rxAvg=l[c]/e,s[c].txAvg=i[c]/e}return s}(e,a,n,l);!function(e,t,a,n,s){const{yMax:r,tailPx:l}=s;e.clearRect(0,0,a,n);const i=a-44-8,o=n-8-40;if(i<=0||o<=0)return;const c=i/t.length,d=e=>{const t=Math.min(e,r);return 8+o*(1-t/r)},m=(t,a,n,s)=>{if(a<=0)return;const r=d(a),i=d(0),o=Math.min(l,i-r);if(e.fillStyle=`rgba(${n.r}, ${n.g}, ${n.b}, ${s})`,e.fillRect(t,r,Math.max(1,c-.5),2),o>2){const a=e.createLinearGradient(0,r+2,0,r+o);a.addColorStop(0,`rgba(${n.r}, ${n.g}, ${n.b}, ${.6*s})`),a.addColorStop(1,`rgba(${n.r}, ${n.g}, ${n.b}, 0)`),e.fillStyle=a,e.fillRect(t,r+2,Math.max(1,c-.5),o-2)}},h=(t,a,n,s)=>{if(a<=0||n<=0)return;const r=a/n,l=8+o-3;e.fillStyle=`rgba(${s.r}, ${s.g}, ${s.b}, ${.25*r})`,e.fillRect(t,l,Math.max(1,c-.5),3)},u=Math.max(...t.map(e=>e.rxHits),1),x=Math.max(...t.map(e=>e.txHits),1);for(let p=0;p<t.length;p++){const e=t[p],a=44+p*c;m(a,e.txMax,G,.5),m(a,e.rxMax,U,.7),h(a,e.txHits,x,G),h(a,e.rxHits,u,U)}}(d,m,l,o,{yMax:s,tailPx:24})},c=new ResizeObserver(o);return c.observe(t),o(),()=>c.disconnect()},[e,a,n,s]),0===e.length?t.jsx("div",{className:"h-80 flex items-center justify-center text-text-muted",children:"No traffic data available"}):t.jsxs("div",{ref:r,className:"relative h-80",children:[t.jsx("canvas",{ref:l,className:"absolute inset-0 pointer-events-none"}),t.jsx(h,{width:"100%",height:320,children:t.jsxs(x,{data:i,children:[t.jsx(p,{strokeDasharray:"3 3",stroke:"rgba(255,255,255,0.04)",vertical:!1}),t.jsx(f,{dataKey:"timestamp",type:"number",domain:[a,n],axisLine:!1,tickLine:!1,tick:{fill:"rgba(255,255,255,0.4)",fontSize:9,fontFamily:"'JetBrains Mono', monospace"},dy:8,interval:o,minTickGap:60,tickFormatter:e=>{const t=new Date(1e3*e);return(n-a)/3600>24?t.toLocaleDateString([],{month:"short",day:"numeric"})+" "+t.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hour12:!1}):t.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hour12:!1})}}),t.jsx(y,{axisLine:!1,tickLine:!1,tick:{fill:"rgba(255,255,255,0.4)",fontSize:10,fontFamily:"'JetBrains Mono', monospace"},dx:-8,width:44,tickFormatter:e=>`${e.toFixed(0)}%`,domain:[0,s]}),t.jsx(g,{content:t.jsx(K,{})}),t.jsx(b,{content:t.jsx(X,{})}),t.jsx(v,{type:"linear",dataKey:"rx",name:"RX Avg",stroke:"#39D98A",strokeWidth:1.5,strokeOpacity:.9,dot:!1,connectNulls:!1,isAnimationActive:!1}),t.jsx(v,{type:"linear",dataKey:"tx",name:"TX Avg",stroke:"#B0B0C3",strokeWidth:1.5,strokeOpacity:.8,dot:!1,connectNulls:!1,isAnimationActive:!1})]})})]})}),Y="#60A5FA",Q=["N","NE","E","SE","S","SW","W","NW"];function V(e,t,a,n){const s=(n-t)*Math.PI/180,r=e*Math.PI/180,l=a*Math.PI/180,i=Math.sin(s)*Math.cos(l),o=Math.cos(r)*Math.sin(l)-Math.sin(r)*Math.cos(l)*Math.cos(s);let c=180*Math.atan2(i,o)/Math.PI;return c=(c+360)%360,c}function Z(e,t,a,n){const s=(a-e)*Math.PI/180,r=(n-t)*Math.PI/180,l=Math.sin(s/2)*Math.sin(s/2)+Math.cos(e*Math.PI/180)*Math.cos(a*Math.PI/180)*Math.sin(r/2)*Math.sin(r/2);return 2*Math.atan2(Math.sqrt(l),Math.sqrt(1-l))*6371}function ee(e){return e>=10?"#4CFFB5":e>=7?"#39D98A":e>=4?"#7DD87D":e>=1?"#A3E635":e>=-2?"#F9D26F":e>=-5?"#FBBF24":e>=-8?"#FF8A5C":e>=-11?"#EF4444":"#B91C1C"}const te=m.memo(function({neighbors:e,localLat:a,localLon:n}){const[s,r]=m.useState(null),[l,i]=m.useState(new Set),[o,c]=m.useState(0),d=m.useRef({});m.useEffect(()=>{const e=setTimeout(()=>{c(1)},100),t=setInterval(()=>{c(e=>e+1)},1e4);return()=>{clearTimeout(e),clearInterval(t)}},[]);const{processedNeighbors:h,maxDistance:u,totalNeighbors:x}=m.useMemo(()=>{const t=[];let s=0;for(const[r,l]of Object.entries(e)){if(!l.latitude||!l.longitude||0===l.latitude||0===l.longitude)continue;const e=V(a,n,l.latitude,l.longitude),i=Z(a,n,l.latitude,l.longitude);i>s&&(s=i),t.push({hash:r.slice(0,8),name:l.node_name||l.name||"Unknown",snr:l.snr??0,rssi:l.rssi??0,bearing:e,distance:i,normalizedDistance:0,lastSeen:l.last_seen})}for(const e of t)e.normalizedDistance=s>0?.15+e.distance/s*.85:.15;return{processedNeighbors:t,maxDistance:s,totalNeighbors:t.length}},[e,a,n]);if(m.useEffect(()=>{const e=[];for(const t of h){const a=d.current[t.hash];void 0!==a&&a!==t.lastSeen&&e.push(t.hash),d.current[t.hash]=t.lastSeen}e.length>0&&(queueMicrotask(()=>{i(t=>{const a=new Set(t);return e.forEach(e=>a.add(e)),a})}),setTimeout(()=>{i(t=>{const a=new Set(t);return e.forEach(e=>a.delete(e)),a})},600))},[h]),0===a||0===n)return t.jsxs("div",{className:"flex flex-col items-center justify-center h-64 text-text-muted",children:[t.jsx(W,{className:"w-8 h-8 mb-2 opacity-50"}),t.jsx("p",{children:"Local node coordinates not configured"}),t.jsx("p",{className:"text-xs mt-1",children:"Set latitude/longitude in config to enable"})]});if(0===x)return t.jsxs("div",{className:"flex flex-col items-center justify-center h-64 text-text-muted",children:[t.jsx(W,{className:"w-8 h-8 mb-2 opacity-50"}),t.jsx("p",{children:"No neighbors with location data"})]});const p=140,f=(e,t)=>{const a=(e-90)*Math.PI/180,n=110*t;return{x:p+n*Math.cos(a),y:p+n*Math.sin(a)}};return t.jsxs("div",{className:"flex flex-col h-full",children:[t.jsxs("div",{className:"text-xs text-text-muted uppercase tracking-wide mb-2",children:[x," neighbor",1!==x?"s":""," • max ",u.toFixed(1)," km"]}),t.jsxs("div",{className:"relative h-[280px]",children:[t.jsxs("svg",{width:280,height:280,className:"mx-auto",children:[t.jsx("defs",{children:t.jsx("style",{children:`\n                @keyframes radar-pulse-scale {\n                  0% {\n                    transform: scale(0);\n                    opacity: 0.9;\n                    stroke-width: 10;\n                  }\n                  100% {\n                    transform: scale(1);\n                    opacity: 0;\n                    stroke-width: 1;\n                  }\n                }\n                @keyframes local-node-ping {\n                  0% {\n                    fill: #4CFFB5;\n                  }\n                  100% {\n                    fill: ${Y};\n                  }\n                }\n                @keyframes neighbor-blink-scale {\n                  0%, 100% {\n                    transform: scale(1);\n                    opacity: 0;\n                  }\n                  50% {\n                    transform: scale(1.3);\n                    opacity: 0.8;\n                  }\n                }\n                .radar-pulse-circle {\n                  transform-origin: center;\n                  animation: radar-pulse-scale 2000ms cubic-bezier(0.15, 0.6, 0.4, 1) forwards;\n                }\n                .local-node-ping {\n                  animation: local-node-ping 1000ms ease-out forwards;\n                }\n                .neighbor-blink-ring {\n                  transform-origin: center;\n                  animation: neighbor-blink-scale 600ms ease-out forwards;\n                }\n              `})}),[.25,.5,.75,1].map(e=>t.jsx("circle",{cx:p,cy:p,r:110*e,fill:"none",stroke:"rgba(255,255,255,0.1)",strokeWidth:1},e)),o>0&&t.jsx("circle",{cx:p,cy:p,r:110,fill:"none",stroke:"rgba(255,255,255,0.5)",strokeWidth:1.5,className:"radar-pulse-circle"},`pulse-${o}`),Q.map((e,a)=>{const n=f(45*a,1);return t.jsx("line",{x1:p,y1:p,x2:n.x,y2:n.y,stroke:"rgba(255,255,255,0.08)",strokeWidth:1},e)}),Q.map((e,a)=>{const n=f(45*a,1.12);return t.jsx("text",{x:n.x,y:n.y,textAnchor:"middle",dominantBaseline:"middle",fill:"rgba(255,255,255,0.5)",fontSize:10,fontFamily:"'JetBrains Mono', monospace",children:e},e)}),t.jsx("circle",{cx:p,cy:p,r:6,fill:Y,stroke:"rgba(255,255,255,0.3)",strokeWidth:1,className:o>0?"local-node-ping":""},`local-${o}`),h.map(e=>{const{x:a,y:n}=f(e.bearing,e.normalizedDistance),i=ee(e.snr),o=(null==s?void 0:s.hash)===e.hash,c=l.has(e.hash);return t.jsxs("g",{children:[c&&t.jsx("circle",{cx:a,cy:n,r:12,fill:"none",stroke:"rgba(255,255,255,0.9)",strokeWidth:2,className:"neighbor-blink-ring"}),o&&t.jsx("circle",{cx:a,cy:n,r:12,fill:i,opacity:.3}),t.jsx("circle",{cx:a,cy:n,r:o?8:6,fill:i,stroke:"rgba(0,0,0,0.5)",strokeWidth:1,style:{cursor:"pointer",transition:"r 0.15s"},onMouseEnter:()=>r(e),onMouseLeave:()=>r(null)})]},e.hash)})]}),s&&t.jsxs("div",{className:"absolute bg-bg-surface/95 backdrop-blur-sm border border-border-subtle rounded-lg px-3 py-2 text-sm pointer-events-none z-10",style:{left:"50%",bottom:8,transform:"translateX(-50%)"},children:[t.jsx("div",{className:"font-medium text-text-primary",children:s.name}),t.jsx("div",{className:"text-text-muted text-xs font-mono",children:s.hash}),t.jsx("div",{className:"flex gap-3 mt-1 text-xs",children:t.jsxs("span",{children:[t.jsx("span",{className:"text-text-muted",children:"SNR:"})," ",t.jsxs("span",{className:"tabular-nums",style:{color:ee(s.snr)},children:[s.snr.toFixed(1)," dB"]}),t.jsxs("span",{className:"text-text-muted ml-1",children:["(",(y=s.snr,y>=10?"Excellent":y>=7?"Very Good":y>=4?"Good":y>=1?"Fair+":y>=-2?"Fair":y>=-5?"Fair-":y>=-8?"Poor":y>=-11?"Bad":"Critical"),")"]})]})}),t.jsxs("div",{className:"flex gap-3 text-xs",children:[t.jsxs("span",{children:[t.jsx("span",{className:"text-text-muted",children:"Distance:"})," ",t.jsxs("span",{className:"tabular-nums text-text-secondary",children:[s.distance.toFixed(2)," km"]})]}),t.jsxs("span",{children:[t.jsx("span",{className:"text-text-muted",children:"Bearing:"})," ",t.jsxs("span",{className:"tabular-nums text-text-secondary",children:[s.bearing.toFixed(0),"°"]})]})]})]})]})]});var y}),ae=m.memo(function({timestamps:e,values:a,height:n=224}){const s=_(),{cells:r,stats:l,xLabels:i,yLabels:o}=m.useMemo(()=>{if(0===e.length||0===a.length)return{cells:[],stats:null,xLabels:[],yLabels:[]};const t=Math.min(360,e.length),n=Math.min(...a),s=Math.max(...a),r=.1*(s-n||1),l=n-r,i=s+r-l,o=Math.min(...e),c=Math.max(...e)-o||1,d=Array(60).fill(null).map(()=>Array(t).fill(0));for(let p=0;p<e.length;p++){const n=Math.floor((e[p]-o)/c*(t-1)),s=Math.floor((a[p]-l)/i*59),r=Math.max(0,Math.min(t-1,n)),m=Math.max(0,Math.min(59,59-s));d[m][r]++,m>0&&(d[m-1][r]+=.3),m<59&&(d[m+1][r]+=.3),r>0&&(d[m][r-1]+=.2),r<t-1&&(d[m][r+1]+=.2)}let m=0;for(let e=0;e<60;e++)for(let a=0;a<t;a++)d[e][a]>m&&(m=d[e][a]);const h=[];for(let e=0;e<60;e++)for(let a=0;a<t;a++)d[e][a]>0&&h.push({x:a,y:e,intensity:d[e][a]/m});const u=[];for(let e=0;e<=5;e++){const t=o+c*e/5;u.push({pos:e/5*100,label:new Date(1e3*t).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})}const x=[];for(let e=0;e<=4;e++){const t=l+i*e/4;x.push({pos:100*(1-e/4),label:`${Math.round(t)}`})}return{cells:h,stats:{min:n,max:s,avg:a.reduce((e,t)=>e+t,0)/a.length,cols:t,rows:60},xLabels:u,yLabels:x}},[e,a]);if(!l||0===r.length)return t.jsx("div",{className:"h-56 flex items-center justify-center text-text-muted",children:"No noise floor data available"});const c=100/l.cols,d=100/l.rows,h=s.chart1;return t.jsxs("div",{className:"relative",style:{height:n},children:[t.jsx("div",{className:"absolute left-0 top-0 bottom-6 w-8 flex flex-col justify-between text-right pr-2",children:o.map((e,a)=>t.jsx("span",{className:"type-data-xs text-text-muted tabular-nums",style:{position:"absolute",top:`${e.pos}%`,transform:"translateY(-50%)"},children:e.label},a))}),t.jsxs("div",{className:"absolute left-10 right-0 top-0 bottom-6",children:[t.jsx("svg",{className:"absolute inset-0 w-full h-full",preserveAspectRatio:"none",children:[0,25,50,75,100].map(e=>t.jsx("line",{x1:"0",y1:`${e}%`,x2:"100%",y2:`${e}%`,stroke:"rgba(255,255,255,0.06)",strokeDasharray:"3 3"},e))}),t.jsx("svg",{className:"absolute inset-0 w-full h-full",preserveAspectRatio:"none",children:r.map((e,a)=>{const n=.15+.85*e.intensity,s=50+50*e.intensity;return t.jsx("rect",{x:e.x*c+"%",y:e.y*d+"%",width:`${c+.1}%`,height:`${d+.1}%`,fill:h,opacity:n,style:{filter:e.intensity>.7?`saturate(${s}%)`:void 0}},a)})}),t.jsxs("div",{className:"absolute top-2 right-2 flex gap-3",children:[t.jsxs("span",{className:"type-data-xs text-text-muted",children:["min ",t.jsx("span",{className:"text-text-secondary tabular-nums",children:l.min.toFixed(0)})]}),t.jsxs("span",{className:"type-data-xs text-text-muted",children:["avg ",t.jsx("span",{className:"text-text-secondary tabular-nums",children:l.avg.toFixed(0)})]}),t.jsxs("span",{className:"type-data-xs text-text-muted",children:["max ",t.jsx("span",{className:"text-text-secondary tabular-nums",children:l.max.toFixed(0)})]})]})]}),t.jsx("div",{className:"absolute left-10 right-0 bottom-0 h-6 flex justify-between",children:i.map((e,a)=>t.jsx("span",{className:"type-data-xs text-text-muted tabular-nums",style:{position:"absolute",left:`${e.pos}%`,transform:"translateX(-50%)"},children:e.label},a))})]})}),ne={repeater:"var(--accent-primary)",companion:"var(--accent-tertiary)",room_server:"var(--accent-secondary)"};function se(e){if(e.contact_type){const t=e.contact_type.toLowerCase();if("repeater"===t||"rep"===t)return"repeater";if("room server"===t||"room_server"===t||"room"===t||"server"===t)return"room_server";if("companion"===t||"client"===t||"cli"===t)return"companion"}return e.is_repeater?"repeater":"companion"}const re=m.memo(function({neighbors:e}){const a=m.useMemo(()=>{const t={repeater:0,companion:0,room_server:0};for(const n of Object.values(e)){const e=se(n);t[e]=(t[e]||0)+1}const a=Object.values(t).reduce((e,t)=>e+t,0);return{items:[{label:"Repeaters",count:t.repeater,percent:0,color:ne.repeater},{label:"Companions",count:t.companion,percent:0,color:ne.companion},{label:"Room Servers",count:t.room_server,percent:0,color:ne.room_server}].map(e=>({...e,percent:a>0?e.count/a*100:0})).filter(e=>e.count>0).sort((e,t)=>t.count-e.count),total:a}},[e]);return 0===a.total?t.jsx("div",{className:"h-full flex items-center justify-center text-text-muted type-body-sm",children:"No neighbors discovered yet"}):t.jsxs("div",{className:"flex flex-col gap-3",children:[a.items.map(e=>t.jsxs("div",{className:"flex flex-col gap-1.5",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("span",{className:"type-data-sm text-text-secondary",children:e.label}),t.jsxs("span",{className:"type-data-sm text-text-muted tabular-nums",children:[e.count," ",t.jsxs("span",{className:"text-text-muted/60",children:["(",e.percent.toFixed(0),"%)"]})]})]}),t.jsx("div",{className:"h-2.5 bg-bg-elevated rounded-full overflow-hidden",children:t.jsx("div",{className:"h-full rounded-full transition-all duration-500 ease-out",style:{width:`${e.percent}%`,backgroundColor:e.color,minWidth:e.count>0?"4px":"0"}})})]},e.label)),t.jsxs("div",{className:"flex items-center justify-between pt-2 mt-1 border-t border-border-subtle",children:[t.jsx("span",{className:"type-data-xs text-text-muted",children:"Total Nodes"}),t.jsx("span",{className:"type-data-sm text-text-primary font-medium tabular-nums",children:a.total})]})]})}),le={excellent:"text-signal-excellent",good:"text-signal-good",fair:"text-signal-fair",poor:"text-signal-poor"},ie={excellent:"bg-signal-excellent/10",good:"bg-signal-good/10",fair:"bg-signal-fair/10",poor:"bg-signal-poor/10"};function oe({value:e,status:a}){const n={excellent:"bg-signal-excellent",good:"bg-signal-good",fair:"bg-signal-fair",poor:"bg-signal-poor"}[a];return t.jsx("div",{className:"w-full h-2 bg-surface-elevated rounded-full overflow-hidden",children:t.jsx("div",{className:`h-full ${n} transition-all duration-300`,style:{width:`${Math.min(100,Math.max(0,e))}%`}})})}function ce(){const e=a();if(!n())return t.jsxs(w,{size:"lg",className:"flex flex-col",children:[t.jsx($,{icon:t.jsx(E,{}),title:"Prefix Disambiguation",largeTitle:!0}),t.jsx("div",{className:"flex-1 flex items-center justify-center",children:t.jsxs("div",{className:"text-center text-text-muted",children:[t.jsx(z,{className:"w-8 h-8 mx-auto mb-2 opacity-50"}),t.jsx("p",{className:"type-data-xs",children:"No topology data available"}),t.jsx("p",{className:"type-data-xs opacity-70",children:"Run deep analysis to see stats"})]})})]});const s=(r=e.avgConfidence)>=.9?"excellent":r>=.7?"good":r>=.5?"fair":"poor";var r;const l=(i=e.collisionRate)<=10?"excellent":i<=25?"good":"poor";var i;const o="poor"===s||"poor"===l?"poor":"fair"===s||"fair"===l?"fair":"good"===s||"good"===l?"good":"excellent",c="excellent"===o||"good"===o?D:S;return t.jsxs(w,{size:"lg",className:"flex flex-col",children:[t.jsx($,{icon:t.jsx(E,{}),title:"Prefix Disambiguation",largeTitle:!0,actions:t.jsxs("div",{className:`flex items-center gap-1.5 px-2 py-1 rounded ${ie[o]}`,children:[t.jsx(c,{className:`w-3.5 h-3.5 ${le[o]}`}),t.jsx("span",{className:`type-data-xs font-medium ${le[o]}`,children:"excellent"===o?"Excellent":"good"===o?"Good":"fair"===o?"Fair":"Needs Attention"})]})}),t.jsxs("div",{className:"grid grid-cols-2 gap-4 mb-4",children:[t.jsxs("div",{children:[t.jsxs("div",{className:"flex items-baseline justify-between mb-1",children:[t.jsx("span",{className:"type-data-xs text-text-muted",children:"Avg Confidence"}),t.jsxs("span",{className:`type-data-lg font-semibold ${le[s]}`,children:[(100*e.avgConfidence).toFixed(1),"%"]})]}),t.jsx(oe,{value:100*e.avgConfidence,status:s})]}),t.jsxs("div",{children:[t.jsxs("div",{className:"flex items-baseline justify-between mb-1",children:[t.jsx("span",{className:"type-data-xs text-text-muted",children:"Collision Rate"}),t.jsxs("span",{className:`type-data-lg font-semibold ${le[l]}`,children:[e.collisionRate.toFixed(1),"%"]})]}),t.jsx(oe,{value:e.collisionRate,status:l})]})]}),t.jsxs("div",{className:"grid grid-cols-3 gap-2 mb-4 py-3 border-t border-b border-border-subtle",children:[t.jsxs("div",{className:"text-center",children:[t.jsx("div",{className:"type-data-lg font-semibold text-text-primary",children:e.totalPrefixes}),t.jsx("div",{className:"type-data-xs text-text-muted",children:"Prefixes"})]}),t.jsxs("div",{className:"text-center",children:[t.jsx("div",{className:"type-data-lg font-semibold text-signal-good",children:e.unambiguousPrefixes}),t.jsx("div",{className:"type-data-xs text-text-muted",children:"Unique"})]}),t.jsxs("div",{className:"text-center",children:[t.jsx("div",{className:"type-data-lg font-semibold "+(e.collisionPrefixes>0?"text-signal-fair":"text-text-primary"),children:e.collisionPrefixes}),t.jsx("div",{className:"type-data-xs text-text-muted",children:"Collisions"})]})]}),e.highCollisionPrefixes.length>0&&t.jsxs("div",{className:"mb-3",children:[t.jsx("div",{className:"type-data-xs text-text-muted mb-2",children:"Highest Collisions"}),t.jsx("div",{className:"flex flex-wrap gap-1.5",children:e.highCollisionPrefixes.map(({prefix:e,candidateCount:a})=>t.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-0.5 rounded bg-surface-elevated text-text-secondary type-data-xs font-mono",title:`${a} candidates match this prefix`,children:[e,t.jsxs("span",{className:"text-signal-fair",children:["×",a]})]},e))})]}),e.lowConfidencePrefixes.length>0&&t.jsx("div",{className:"mt-auto pt-3 border-t border-border-subtle",children:t.jsxs("div",{className:"flex items-start gap-2",children:[t.jsx(S,{className:"w-3.5 h-3.5 text-signal-poor mt-0.5 flex-shrink-0"}),t.jsxs("div",{children:[t.jsxs("div",{className:"type-data-xs text-signal-poor font-medium",children:[e.lowConfidencePrefixes.length," prefix",1!==e.lowConfidencePrefixes.length?"es":""," with low confidence"]}),t.jsxs("div",{className:"type-data-xs text-text-muted mt-0.5",children:[e.lowConfidencePrefixes.slice(0,5).join(", "),e.lowConfidencePrefixes.length>5&&` +${e.lowConfidencePrefixes.length-5} more`]})]})]})}),0===e.lowConfidencePrefixes.length&&0===e.collisionPrefixes&&t.jsx("div",{className:"mt-auto pt-3 border-t border-border-subtle",children:t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(D,{className:"w-3.5 h-3.5 text-signal-excellent"}),t.jsx("span",{className:"type-data-xs text-signal-excellent",children:"All prefixes uniquely identified"})]})})]})}function de(){var e,a,n,h;const u=s(),[x,p]=m.useState(null),[f,y]=m.useState(null),[g,b]=m.useState([]),[v,z]=m.useState(!0),[S,D]=m.useState(null),[E,R]=m.useState(3),P=N(E,150),_=r[P].hours,I=60*_,O=Math.ceil(60*I/10);m.useEffect(()=>{!async function(){var e;D(null);try{const[t,a,n]=await Promise.all([l(I,O),i(_),o(_)]);t.success&&t.data&&p(t.data),a.success&&a.data&&y(a.data),n.success&&(null==(e=n.data)?void 0:e.history)&&b(n.data.history)}catch(t){D(t instanceof Error?t.message:"Failed to load chart data")}finally{z(!1)}}()},[_,I,O]);const{utilSamples:H,startTs:U,endTs:G}=m.useMemo(()=>{if(!x)return{utilSamples:[],startTs:0,endTs:0};const{received:e,transmitted:t,forwarded:a,bucket_duration_seconds:n,start_time:s,end_time:r}=x,l=1e3*n,i=function(e,t){const a=new Map;for(const n of e)a.set(n.start,{...n});for(const n of t){const e=a.get(n.start);e?(e.airtime_ms+=n.airtime_ms,e.count+=n.count):a.set(n.start,{...n})}return Array.from(a.values()).sort((e,t)=>e.start-t.start)}(t,a),o=function(e,t,a){const n=new Map(e.map(e=>[e.start,e])),s=new Map(t.map(e=>[e.start,e]));return Array.from(new Set([...n.keys(),...s.keys()])).sort((e,t)=>e-t).map(e=>{const t=n.get(e),r=s.get(e);return{timestamp:e,rxUtilW:((null==t?void 0:t.airtime_ms)??0)/a*100,txUtilW:((null==r?void 0:r.airtime_ms)??0)/a*100}})}(e,i,l);return{utilSamples:o,startTs:s,endTs:r}},[x]),K=m.useMemo(()=>{switch(_){case 72:return 6e5;case 168:return 18e5;default:return 3e5}},[_]),X=m.useCallback(async()=>{try{const e=await l(I,O);e.success&&e.data&&p(e.data)}catch{}},[I,O]),Y=m.useCallback(async()=>{try{const e=await i(_);e.success&&e.data&&y(e.data)}catch{}},[_]),Q=m.useCallback(async()=>{var e;try{const t=await o(_);t.success&&(null==(e=t.data)?void 0:e.history)&&b(t.data.history)}catch{}},[_]);k(X,K,!0,!0),k(Y,K,!0,!0),k(Q,K,!0,!0);const V=m.useMemo(()=>f&&f.series?f.series.map(e=>({name:e.name,value:e.data.reduce((e,t)=>e+(t[1]??0),0)})).filter(e=>e.value>0):[],[f]),Z=m.useMemo(()=>0===g.length?{timestamps:[],values:[]}:{timestamps:g.map(e=>e.timestamp),values:g.map(e=>e.noise_floor_dbm)},[g]),ee=r[E],ne=m.useMemo(()=>0===H.length?{peak:0,mean:0}:{peak:Math.max(...H.map(e=>e.rxUtilW)),mean:H.reduce((e,t)=>e+t.rxUtilW,0)/H.length},[H]);return t.jsxs(A,{children:[t.jsx(F,{title:"Statistics",icon:t.jsx(c,{}),controls:t.jsx(M,{ranges:r,selectedIndex:E,onSelect:R})}),S&&t.jsx(w,{className:"border border-accent-red/50 bg-accent-red/10",children:t.jsx("p",{className:"text-accent-red",children:S})}),v?t.jsx(w,{className:"text-center",children:t.jsx("div",{className:"animate-pulse text-text-muted",children:"Loading statistics..."})}):t.jsxs(t.Fragment,{children:[t.jsxs(j,{children:[t.jsx(T,{lg:8,children:t.jsxs(w,{size:"lg",children:[t.jsx($,{icon:t.jsx(C,{}),title:"Airtime Utilization",badge:ee.label,largeTitle:!0,actions:t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsxs("span",{className:"type-data-xs text-text-muted",children:["Peak ",t.jsxs("span",{className:"text-text-secondary tabular-nums font-medium",children:[ne.peak.toFixed(2),"%"]})]}),t.jsxs("span",{className:"type-data-xs text-text-muted",children:["Mean ",t.jsxs("span",{className:"text-text-secondary tabular-nums font-medium",children:[ne.mean.toFixed(2),"%"]})]})]})}),t.jsx(q,{samples:H,startTs:U,endTs:G})]})}),t.jsx(T,{lg:4,children:t.jsxs(w,{size:"lg",children:[t.jsx($,{icon:t.jsx(W,{}),title:"Link Quality",largeTitle:!0}),t.jsx(te,{neighbors:(null==u?void 0:u.neighbors)??{},localLat:(null==(a=null==(e=null==u?void 0:u.config)?void 0:e.repeater)?void 0:a.latitude)??0,localLon:(null==(h=null==(n=null==u?void 0:u.config)?void 0:n.repeater)?void 0:h.longitude)??0})]})})]}),t.jsxs(j,{children:[t.jsx(T,{md:6,lg:4,children:t.jsxs(w,{size:"lg",children:[t.jsx($,{icon:t.jsx(L,{}),title:"Network Composition",largeTitle:!0}),t.jsx(re,{neighbors:(null==u?void 0:u.neighbors)??{}})]})}),t.jsx(T,{md:6,lg:4,children:t.jsxs(w,{size:"lg",children:[t.jsx($,{icon:t.jsx(B,{}),title:"Packet Types",largeTitle:!0}),V.length>0?t.jsx(J,{data:V}):t.jsx("div",{className:"h-44 flex items-center justify-center text-text-muted",children:"No packet type data available"})]})}),t.jsx(T,{md:6,lg:4,children:t.jsxs(w,{size:"lg",children:[t.jsx($,{icon:t.jsx(d,{}),title:"RF Noise Floor",largeTitle:!0,actions:t.jsx("span",{className:"type-data-xs text-text-muted",children:"dBm"})}),t.jsx(ae,{timestamps:Z.timestamps,values:Z.values,height:176})]})}),t.jsx(T,{md:6,lg:4,children:t.jsx(ce,{})})]})]})]})}export{de as default};
