import{c as e,H as t,aB as o}from"./index-rO1UlJSY.js";import{c as n,P as s}from"./geo-utils-BR5NTbzq.js";import{P as i,f as c}from"./payload-decoders-oC4oS70a.js";const a=e("hash",[["line",{x1:"4",x2:"20",y1:"9",y2:"9",key:"4lhtct"}],["line",{x1:"4",x2:"20",y1:"15",y2:"15",key:"vyu0kd"}],["line",{x1:"10",x2:"8",y1:"3",y2:"21",key:"1ggp8o"}],["line",{x1:"16",x2:"14",y1:"3",y2:"21",key:"weycgp"}]]),r=e("route",[["circle",{cx:"6",cy:"19",r:"3",key:"1kj8tv"}],["path",{d:"M9 19h8.5a3.5 3.5 0 0 0 0-7h-11a3.5 3.5 0 0 1 0-7H15",key:"1d8sl"}],["circle",{cx:"18",cy:"5",r:"3",key:"gq8acd"}]]);function f(e){if(e.contact_type){const t=e.contact_type.toLowerCase();if("repeater"===t||"rep"===t)return!0;if("companion"===t||"client"===t||"cli"===t)return!1;if("room server"===t||"room_server"===t||"room"===t||"server"===t)return!1}return!0===e.is_repeater||(e.is_repeater,!1)}function h(e){const t={};for(const[o,n]of Object.entries(e))f(n)&&(t[o]=n);return t}function d(e,t,o){const n=t.toUpperCase(),s=e.get(n);if(!s||0===s.candidates.length)return{hash:null,confidence:0};if(null==o?void 0:o.isLastHop)return{hash:s.bestMatch,confidence:s.confidence};if(1===(null==o?void 0:o.position))return{hash:s.bestMatch,confidence:s.confidence};if((null==o?void 0:o.position)&&s.bestMatchForPosition.has(o.position)){const e=s.bestMatchForPosition.get(o.position),t=Math.max(e.confidence,s.confidence);return{hash:e.hash,confidence:t}}if((null==o?void 0:o.adjacentPrefixes)&&o.adjacentPrefixes.length>0){let e=s.bestMatch,t=0;for(const n of s.candidates){let s=0;for(const e of o.adjacentPrefixes)s+=n.adjacentPrefixCounts.get(e.toUpperCase())||0;const i=n.combinedScore+s/Math.max(1,n.totalAdjacentObservations)*.3;i>t&&(t=i,e=n.hash)}return{hash:e,confidence:s.confidence}}return{hash:s.bestMatch,confidence:s.confidence}}function l(e,a){const r=new Map,f=new Map;for(const[o,n]of Object.entries(a)){const e=t(o),s=f.get(e)||[];s.push({hash:o,info:n}),f.set(e,s)}const h=new Set;for(const[t,o]of f)1===o.length?r.set(t,o[0].hash):h.add(t);if(0===h.size)return r;const d=new Map,l=Math.floor(Date.now()/1e3);for(const t of h){const e=new Map;for(const o of f.get(t)){let t=0;o.info.zero_hop&&(t+=50);const n=o.info.last_seen??0;if(n>0){const e=(l-n)/3600;t+=20*Math.exp(-e/12)}o.info.latitude&&o.info.longitude&&(0!==o.info.latitude||0!==o.info.longitude)&&(t+=5),e.set(o.hash,t)}d.set(t,e)}for(const u of e){if((u.type??u.payload_type)!==o.ADVERT)continue;if(!u.src_hash||!u.raw_packet)continue;const e=t(u.src_hash);if(!h.has(e))continue;let a;try{const e=i.fromHex(u.raw_packet);if(!e.success||!e.packet)continue;a=c(e.packet.payload)}catch{continue}if(a){if(a.latitude&&a.longitude&&(0!==a.latitude||0!==a.longitude)){const t=f.get(e),o=d.get(e);for(const e of t){if(!e.info.latitude||!e.info.longitude)continue;if(0===e.info.latitude&&0===e.info.longitude)continue;const t=n(a.latitude,a.longitude,e.info.latitude,e.info.longitude);t<s.VERY_CLOSE?o.set(e.hash,(o.get(e.hash)||0)+10):t<s.CLOSE?o.set(e.hash,(o.get(e.hash)||0)+5):t<s.FAR&&o.set(e.hash,(o.get(e.hash)||0)+1)}}if(a.name){const t=a.name.trim().toLowerCase();if(t){const o=f.get(e),n=d.get(e);for(const e of o){const o=(e.info.name||e.info.node_name||"").trim().toLowerCase();o&&o===t&&n.set(e.hash,(n.get(e.hash)||0)+15)}}}}}for(const t of h){const e=d.get(t);let o=null,n=-1/0;for(const[t,s]of e)s>n&&(n=s,o=t);o&&r.set(t,o)}return r}export{a as H,r as R,l as b,h as f,d as r};
