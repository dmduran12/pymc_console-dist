import{c as S}from"./geo-utils-BP1zBK9h.js";import{r as b,j as c}from"./vendor-react-CHg3w57L.js";import{c as N}from"./vendor-core-CgllfypI.js";import{bH as k,bI as _,av as F,dr as G,ds as P,Y as V,dt as W,_ as z}from"./index-B4woLUMa.js";import{m as B}from"./vendor-motion-CXybMqb1.js";import{a as D,bs as T,aR as Y,aa as H,bo as U,L as K}from"./vendor-icons-rRVc_l7g.js";const $={hidden:{opacity:0,scale:.9},visible:{opacity:1,scale:1,transition:{type:"spring",stiffness:400,damping:15}},exit:{opacity:0,scale:.9,transition:{duration:_.fast}}},ye={hidden:{opacity:0,y:"100%"},visible:{opacity:1,y:0,transition:{type:"spring",stiffness:400,damping:30}},exit:{opacity:0,y:"100%",transition:{duration:_.medium,ease:k.easeIn}}},q=1e-8,X=100,E=3,Z=4,v=5,J=20,Q=.001,I=.3,ee=30,te=.05,ne=.7,w=.3;function M(n,e){let t=0;for(let s=0;s<n.length;s++)t+=n[s]*e[s];return t}function se(n){return Math.sqrt(M(n,n))}function A(n){const e=se(n);if(e>0)for(let t=0;t<n.length;t++)n[t]/=e}function C(n,e){const t=M(n,e);for(let s=0;s<n.length;s++)n[s]-=t*e[s]}function ie(n,e){const t=n.length,s=new Array(t).fill(0);for(let o=0;o<t;o++)for(let a=0;a<t;a++)s[o]+=n[o][a]*e[a];return s}function oe(n){const e=Math.exp(-n/ee);return Math.max(te,e)}function ae(n,e,t,s){const o=e.length,a=new Map(e.map((r,i)=>[r,i])),u=Array(o).fill(null).map(()=>Array(o).fill(0));for(const r of n){const i=a.get(r.fromHash),l=a.get(r.toHash);if(i!==void 0&&l!==void 0&&i!==l){const g=r.strength*r.certainCount;let m=1;if(t){const x=t.get(r.fromHash),y=t.get(r.toHash);if(x&&y){const O=S(x[0],x[1],y[0],y[1])/1e3;m=oe(O)}}let f=1;if(s){const x=[r.fromHash,r.toHash].sort().join("-");f=1-(s.get(x)??0)*ne}const d=r.symmetryRatio??0,p=w+(1-w)*d,h=Math.pow(g,1-I)*Math.pow(m,I)*f*p;u[i][l]=h,u[l][i]=h}}return u}function R(n){const e=n.length,t=Array(e).fill(null).map(()=>Array(e).fill(0));for(let s=0;s<e;s++){let o=0;for(let a=0;a<e;a++)o+=n[s][a],t[s][a]=-n[s][a];t[s][s]=o}return t}function L(n){const e=n.length,t=Array(e).fill(1/Math.sqrt(e));let s=0;for(let i=0;i<e;i++){let l=0;for(let g=0;g<e;g++)l+=Math.abs(n[i][g]);s=Math.max(s,l)}const o=Array(e).fill(null).map(()=>Array(e).fill(0));for(let i=0;i<e;i++){for(let l=0;l<e;l++)o[i][l]=-n[i][l];o[i][i]=s+o[i][i]}let a=Array(e).fill(0).map((i,l)=>Math.sin(l*12.9898)*43758.5453%1-.5);C(a,t),A(a);let u=0;for(let i=0;i<X;i++){const l=ie(o,a);C(l,t);const g=M(l,l)/M(a,l);if(A(l),a=l,Math.abs(g-u)<q){const m=s-g;return{vector:a,eigenvalue:m}}u=g}const r=s-u;return{vector:a,eigenvalue:r}}function re(n,e){if(n.length<2)return 0;const t=[];for(const u of n){const r=e.get(u);r&&t.push(r)}if(t.length<2)return 0;const s=Math.min(t.length,20),o=t.length<=s?t:le(t,s);let a=0;for(let u=0;u<o.length;u++)for(let r=u+1;r<o.length;r++){const i=S(o[u][0],o[u][1],o[r][0],o[r][1])/1e3;a=Math.max(a,i)}return a}function le(n,e){if(e>=n.length)return n;const t=[],s=n.length/e;for(let o=0;o<e;o++)t.push(n[Math.floor(o*s)]);return t}function ce(n,e,t,s){const o=e.length;if(o<E)return null;const a=new Set(e),u=n.filter(d=>a.has(d.fromHash)&&a.has(d.toHash));if(u.length===0)return null;const r=ae(u,e,t,s),i=R(r),{vector:l,eigenvalue:g}=L(i);if(g<Q)return null;const m=[],f=[];for(let d=0;d<o;d++)l[d]<0?m.push(e[d]):f.push(e[d]);return m.length<v||f.length<v?null:{group0:m,group1:f,fiedlerValue:g}}function be(n,e,t,s){const o=e.length;if(o<E)return{communities:new Map([[0,e]]),nodePartitions:e.map(m=>({hash:m,community:0,fiedlerValue:0})),numCommunities:1,fiedlerValue:0,isConnected:o<=1};const a=[];let u=1/0;const r=[[e,0]];for(;r.length>0;){const[m,f]=r.shift();if((t?re(m,t):0)>J&&f<Z&&m.length>=v*2){const h=ce(n,m,t,s);if(h){u=Math.min(u,h.fiedlerValue),r.push([h.group0,f+1]),r.push([h.group1,f+1]);continue}}a.push(m)}const i=new Map,l=[],g=new Map;for(let m=0;m<a.length;m++){i.set(m,a[m]);for(const f of a[m])g.set(f,m)}for(const m of e)l.push({hash:m,community:g.get(m)??0,fiedlerValue:0});return{communities:i,nodePartitions:l,numCommunities:a.length,fiedlerValue:u===1/0?0:u,isConnected:!0}}function je(n){const e=["rgba(139, 92, 246, 0.25)","rgba(16, 185, 129, 0.25)","rgba(245, 158, 11, 0.25)","rgba(239, 68, 68, 0.25)","rgba(59, 130, 246, 0.25)","rgba(236, 72, 153, 0.25)","rgba(20, 184, 166, 0.25)","rgba(249, 115, 22, 0.25)"];return e[n%e.length]}function Me(n,e){if(e.length<E)return 0;const t=e.length,s=new Map(e.map((r,i)=>[r,i])),o=Array(t).fill(null).map(()=>Array(t).fill(0));for(const r of n){const i=s.get(r.fromHash),l=s.get(r.toHash);i!==void 0&&l!==void 0&&i!==l&&(o[i][l]=1,o[l][i]=1)}const a=R(o),{eigenvalue:u}=L(a);return Math.max(0,u)}function Ne(n){const e=["rgba(139, 92, 246, 0.6)","rgba(16, 185, 129, 0.6)","rgba(245, 158, 11, 0.6)","rgba(239, 68, 68, 0.6)","rgba(59, 130, 246, 0.6)","rgba(236, 72, 153, 0.6)","rgba(20, 184, 166, 0.6)","rgba(249, 115, 22, 0.6)"];return e[n%e.length]}function j({label:n,icon:e,status:t,detail:s}){return c.jsxs("div",{className:N("flex items-center gap-3 py-3 px-4 radius-inset transition-base",t==="active"&&"bg-sys-blue/10",t==="complete"&&"bg-sys-blue/10 ring-2 ring-inset ring-sys-blue",t==="pending"&&"opacity-40"),children:[c.jsx("div",{className:N("w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 transition-all duration-300",t==="active"&&"bg-sys-blue/20",t==="complete"&&"bg-sys-blue/20",t==="pending"&&"bg-subtle-fill"),children:t==="complete"?c.jsx(D,{className:"w-4 h-4 text-sys-blue"}):t==="active"?c.jsx(K,{className:"w-4 h-4 animate-spin text-sys-blue"}):c.jsx("span",{className:"text-fg-muted",children:e})}),c.jsxs("div",{className:"flex-1 min-w-0",children:[c.jsx("div",{className:N("text-sm font-medium transition-colors",t==="active"&&"text-sys-blue",t==="complete"&&"text-sys-blue",t==="pending"&&"text-fg-muted"),children:n}),s&&t!=="pending"&&c.jsx("div",{className:"text-xs text-fg-muted mt-0.5 truncate",children:s})]})]})}function ue({isOpen:n,onClose:e}){const{packetCacheState:t,triggerDeepAnalysis:s}=F(),o=G(),a=P(),u=t.packetCount,[r,i]=b.useState("fetching");b.useEffect(()=>{n&&s()},[n,s]),b.useEffect(()=>{if(n){if(t.isTopologyLoading)i("fetching");else if(o)i("analyzing"),setTimeout(()=>i("building"),500),setTimeout(()=>i("discovering"),1e3);else if(a>0&&!t.isTopologyLoading){i("complete");const p=setTimeout(()=>{e()},1500);return()=>clearTimeout(p)}}},[n,t.isTopologyLoading,o,a,e]);const l=r==="complete",g=t.loadProgress,m=b.useMemo(()=>{if(g&&g.target>0){const p=(g.loaded/1e3).toFixed(1),h=(g.target/1e3).toFixed(1);return`Loading... ${p}k / ${h}k packets (${g.percent}%)`}return u>0?`${u.toLocaleString()} packets loaded`:"Connecting to database..."},[g,u]),f=p=>{const h=["fetching","analyzing","building","discovering","complete"],x=h.indexOf(r),y=h.indexOf(p);return y<x?"complete":y===x?"active":"pending"},d=l?e:()=>{};return c.jsx(V,{open:n,onClose:d,size:"sm",bottomSheet:!1,children:c.jsx(W,{isLoading:!l,borderRadius:16,children:c.jsx(z,{className:"p-6 radius-card overflow-hidden",children:l?c.jsxs("div",{className:"flex flex-col items-center py-6",children:[c.jsx(B.div,{variants:$,initial:"hidden",animate:"visible",className:"w-16 h-16 rounded-full flex items-center justify-center mb-4 bg-sys-blue/20",children:c.jsx(D,{className:"w-8 h-8 text-sys-blue"})}),c.jsx("h3",{className:"type-micro text-sys-blue",children:"Ready!"}),c.jsx("button",{onClick:e,className:"mt-3 sm:hidden min-h-[44px] min-w-[44px] px-4 flex items-center justify-center text-[15px] font-medium text-sys-blue active:text-sys-blue/70 transition-base radius-inner active:bg-subtle-fill",children:"Done"})]}):c.jsxs(c.Fragment,{children:[c.jsxs("div",{className:"flex items-center gap-3 mb-5",children:[c.jsx("div",{className:"w-10 h-10 radius-inset flex items-center justify-center bg-sys-blue/15",children:c.jsx(T,{className:"w-5 h-5 text-sys-blue"})}),c.jsxs("div",{children:[c.jsx("h3",{className:"type-micro",children:"Deep Analysis"}),c.jsx("p",{className:"text-xs text-fg-muted",children:"Building mesh topology"})]})]}),c.jsxs("div",{className:"space-y-2",children:[c.jsx(j,{label:"Fetching Packets",icon:c.jsx(Y,{className:"w-4 h-4"}),status:f("fetching"),detail:m}),c.jsx(j,{label:"Analyzing Database",icon:c.jsx(H,{className:"w-4 h-4"}),status:f("analyzing"),detail:"Processing packet paths"}),c.jsx(j,{label:"Building Topology",icon:c.jsx(T,{className:"w-4 h-4"}),status:f("building"),detail:"Computing mesh edges"}),c.jsx(j,{label:"Discovering Nodes",icon:c.jsx(U,{className:"w-4 h-4"}),status:f("discovering"),detail:"Viterbi HMM ghost detection"})]}),c.jsx("p",{className:"text-xs text-fg-muted text-center mt-5",children:"This may take a few seconds..."})]})})})})}const ve=b.memo(ue);export{ve as D,je as a,be as b,Me as c,Ne as g,ye as s};
