const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-BTKkXbas.js","assets/index-DWhIzXT2.css"])))=>i.map(i=>d[i]);
import{bK as Q,bh as oe,a3 as Z,r as se,ev as ae,$ as K,es as W,ew as re,bo as k}from"./index-BTKkXbas.js";import{c as ce,m as j,i as O}from"./node-types-DCFFsZpK.js";function ee(e){if(!e||e.length<6)return null;const r=e,n=parseInt(r.slice(0,2),16);if(isNaN(n))return null;const o=n&3;let d=2;if((o===0||o===3)&&(d=10),d+2>r.length)return null;const s=parseInt(r.slice(d,d+2),16);if(isNaN(s)||(d+=2+s*2,d>=r.length))return null;const g=r.slice(d);return g.length>=38?g.slice(0,38):g}function q(e,r="name-only"){const n=e.decoded;if(!n||!n.decrypted)return null;if(n.macCorrupted)switch(r){case"strict":return null;case"name-only":return{senderName:n.senderName||null,channelName:n.channelName||null,channelHash:n.channelHash||null,text:null,corrupted:!0,decrypted:!0}}return{senderName:n.senderName||null,channelName:n.channelName||null,channelHash:n.channelHash||null,text:n.text||null,corrupted:!!n.macCorrupted,decrypted:!0}}function ie(e,r){var d;const n=new Map,o=new Map;for(const s of e){const g=s.payload_type??s.type;if(g!==Q.GRP_TXT)continue;const m=r.get(s.packet_hash);if(!((d=m==null?void 0:m.decoded)!=null&&d.decrypted)||m.decoded.macCorrupted)continue;const u=s._payloadHexPrefix??ee(s.raw_packet);u&&!n.has(u)&&n.set(u,m);const y=s.payload_length??s.length??0,t=Math.floor((s.timestamp??0)/60),_=`${g}:${y}:${t}`;o.has(_)||o.set(_,m)}return{byPayload:n,byApprox:o}}function le(e,r,n,o="name-only"){const d=e.payload_type??e.type;if(d!==Q.GRP_TXT)return null;const s=r.get(e.packet_hash);if(s)return q(s,o);const g=e._payloadHexPrefix??ee(e.raw_packet),m=(g?n.byPayload.get(g):null)??n.byApprox.get(`${d}:${e.payload_length??e.length??0}:${Math.floor((e.timestamp??0)/60)}`);return m?q(m,o):null}function de(e){return e.name||e.node_name||null}function S(e,r,n,o,d,s,g){return{hash:e,type:r,name:n,isRepeater:r==="repeater",isCompanion:r==="companion",confident:o,advertObservations:d,topologyNeighborCount:s,topologyAffinity:g}}const ne=Object.freeze(S(null,"unknown",null,!1,0,0,0)),ue=5,he={disambiguationEnabled:!0,recencyDecayHours:12,zeroHopDecayHours:72,confidenceThreshold:.6,macCorruptedPolicy:"name-only"};function pe(e){const r=new Map,n=new Map,o=new Map,d=new Map,s=new Map,g=new Map,m=new Map;for(const[t,_]of Object.entries(e)){const c=ce(_).type;r.set(t,c);const h=(t.startsWith("0x")?t.slice(2):t).toLowerCase();n.set(h,t);const v=K(t),T=de(_);let b=o.get(v);b||(b=[],o.set(v,b)),b.push({hash:t,name:T,type:c});const w=d.get(v)||{repeaters:0,others:0};if(c==="repeater"?w.repeaters++:w.others++,d.set(v,w),T){g.set(t,T);const A=T.toLowerCase(),x=m.get(A)??0,E=_.last_seen??0;(!s.has(A)||E>x)&&(s.set(A,t),m.set(A,E))}}const u=new Set,y=new Set;for(const[t,_]of d)_.repeaters>0&&_.others>0&&u.add(t),(_.repeaters>=2||_.others>=2)&&y.add(t);return{hashToType:r,pubKeyMap:n,prefixIndex:o,crossClassPrefixes:u,sameClassAmbiguous:y,nameToHash:s,hashToName:g}}function fe(e,r,n,o){const d=new Map(r),s=new Map,g=new Map,m=new Map,u=new Map,y=new Map;for(const t of e){const _=t.timestamp??0;if(t._advertSender){const c=n.get(t._advertSender)??t._advertSender,h=y.get(c);(!h||_>h.lastSeen)&&y.set(c,{lastSeen:_,name:t._advertName??(h==null?void 0:h.name)??null,nodeType:t._advertNodeType!=null?j(t._advertNodeType):(h==null?void 0:h.nodeType)??O(t.type??t.payload_type),latitude:t._advertLatitude??(h==null?void 0:h.latitude),longitude:t._advertLongitude??(h==null?void 0:h.longitude)})}else if(t.src_hash&&t.src_hash.length>8){const c=t.src_hash,h=y.get(c);h?_>h.lastSeen&&(h.lastSeen=_):y.set(c,{lastSeen:_,name:null,nodeType:O(t.type??t.payload_type)})}if(t._advertNodeType==null&&!t._advertName)continue;const N=t._advertSender;if(t._advertNodeType!=null){let c;if(N&&(c=n.get(N)),!c&&t.src_hash&&d.has(t.src_hash)&&(c=t.src_hash),c){const h=d.get(c);if(!h||h==="unknown"){const v=j(t._advertNodeType);v!=="unknown"&&d.set(c,v)}}}if(t._advertName&&N){const c=n.get(N)??N,h=t.timestamp??0,v=t._advertName.toLowerCase();if(!o.has(v)){const b=m.get(v)??0;(!s.has(v)||h>b)&&(s.set(v,c),m.set(v,h))}const T=u.get(c)??0;(!g.has(c)||h>T)&&(g.set(c,t._advertName),u.set(c,h))}}for(const[t,_]of y){const N=d.get(t);N&&N!=="unknown"&&_.nodeType==="unknown"&&(_.nodeType=N)}return{extendedHashToType:d,advertNameToHash:s,advertHashToName:g,discoveredNodes:y}}function ge(e,r,n,o,d){var y;const s=new Map,g=new Map;if(r.size===0)return{decryptedNameToHash:s,decryptedHashToName:g};const{prefixIndex:m,nameToHash:u}=n;for(const t of e){if((t.type??t.payload_type)!==ue)continue;const N=r.get(t.packet_hash);if(!((y=N==null?void 0:N.decoded)!=null&&y.decrypted)||N.decoded.macCorrupted)continue;const c=N.decoded.senderName;if(!c)continue;const h=t.src_hash;if(!h)continue;const v=K(h);let T=d.get(v);if(!T){const w=m.get(v);(w==null?void 0:w.length)===1&&(T=w[0].hash)}if(!T&&h.length>4&&(T=h),!T)continue;const b=c.toLowerCase();!u.has(b)&&!o.has(b)&&s.set(b,T),g.has(T)||g.set(T,c)}return{decryptedNameToHash:s,decryptedHashToName:g}}function me(e,r,n,o,d,s,g,m,u,y,t){var V,H,P,D,C,F,z;const _=e.src_hash,N=m==null?void 0:m.get(e.packet_hash),c=((V=N==null?void 0:N.decoded)==null?void 0:V.senderName)??null,{nameToHash:h}=r;if(!_){const i=e.type??e.payload_type,l=O(i),f=e._advertName??null;if(c){const p=c.toLowerCase(),I=h.get(p)??o.get(p)??u.get(p);if(I){const M=n.get(I)??l;return S(I,M,c,!0)}return S(null,l!=="unknown"?l:"companion",c,!1)}if(e._advertSender){const{pubKeyMap:p,hashToName:I}=r,M=p.get(e._advertSender);if(M){const B=n.get(M)??l,te=I.get(M)??d.get(M)??y.get(M)??null;return S(M,B,te,!0)}const L=d.get(e._advertSender);if(L){const B=n.get(e._advertSender)??l;return S(e._advertSender,B,L,!0)}const U=y.get(e._advertSender);if(U){const B=n.get(e._advertSender)??l;return S(e._advertSender,B,U,!0)}}if(l!=="unknown")return S(null,l,f,!1);if(e._advertNodeType!=null){const p=j(e._advertNodeType);if(p!=="unknown")return S(null,p,f,!1)}return f?S(null,"unknown",f,!1):ne}const v=e.type??e.payload_type??-1,T=e._advertSender?`${_}\0${e._advertSender}`:`${_}\0${v}\0${c??""}`,b=t.get(T);if(b)return b;const w=K(_),{pubKeyMap:A,prefixIndex:x,crossClassPrefixes:E,sameClassAmbiguous:G}=r;let a;if(e._advertSender){const i=A.get(e._advertSender);if(i){const l=n.get(i)??"unknown",f=(H=x.get(w))==null?void 0:H.find(p=>p.hash===i);a=S(i,l,(f==null?void 0:f.name)??null,!0)}else if(e._advertNodeType!=null){const l=j(e._advertNodeType);l!=="unknown"&&(a=S(e._advertSender,l,e._advertName??null,!0))}else{const l=d.get(e._advertSender);if(l){const f=n.get(e._advertSender)??O(e.type??e.payload_type);a=S(e._advertSender,f,l,!0)}}}if(!a&&c){const i=x.get(w),l=i==null?void 0:i.find(f=>{var p;return((p=f.name)==null?void 0:p.toLowerCase())===c.toLowerCase()});if(l){const f=n.get(l.hash)??l.type;a=S(l.hash,f,l.name,!0)}else{const f=c.toLowerCase(),p=h.get(f)??o.get(f)??u.get(f);if(p){const I=n.get(p)??"unknown",M=(P=x.get(K(p)))==null?void 0:P.find(L=>L.hash===p);a=S(p,I,(M==null?void 0:M.name)??c,!0)}}}if(!a&&E.has(w)){const i=O(e.type??e.payload_type);if(i!=="unknown"){const l=(D=x.get(w))==null?void 0:D.find(f=>f.type===i);l&&(a=S(l.hash,i,l.name,!0))}if(!a&&e._advertNodeType!=null){const l=j(e._advertNodeType);if(l!=="unknown"){const f=(C=x.get(w))==null?void 0:C.find(p=>p.type===l);f&&(a=S(f.hash,l,f.name,!0))}}if(!a){const l=x.get(w),f=s.get(w),p=f?l==null?void 0:l.find(L=>L.hash===f):l==null?void 0:l[0],I=p?n.get(p.hash)??p.type:"unknown",M=!!f&&!!p&&p.hash===f;a=S((p==null?void 0:p.hash)??null,I,(p==null?void 0:p.name)??null,M)}}if(!a){const i=s.get(w);if(i){const l=n.get(i)??"unknown",f=(F=x.get(w))==null?void 0:F.find(p=>p.hash===i);a=S(i,l,(f==null?void 0:f.name)??null,!0)}}if(!a&&G.has(w)){const i=(z=x.get(w))==null?void 0:z[0];a=S((i==null?void 0:i.hash)??null,(i==null?void 0:i.type)??"unknown",(i==null?void 0:i.name)??null,!1)}if(!a){const i=x.get(w);if((i==null?void 0:i.length)===1){const l=i[0];a=S(l.hash,l.type,l.name,!0)}else a=S(null,O(v),null,!1)}const R=O(v);if(R!=="unknown"&&R!==a.type&&(a=S(a.hash,R,a.name,a.confident)),a.type==="unknown"&&e._advertNodeType!=null){const i=j(e._advertNodeType);i!=="unknown"&&(a=S(a.hash,i,a.name,a.confident))}if(a.hash){const i=g.get(w);if(i){const l=i.find(f=>f.hash===a.hash);if(l){let f=0;const p=e.original_path??e.forwarded_path;if(p&&Array.isArray(p)&&p.length>0&&l.totalForwarderObservations>0){const I=new Set;for(const M of p){const L=String(M).toUpperCase().slice(0,2);L.length>=2&&L!==w&&I.add(L)}if(I.size>0){let M=0;for(const L of I)l.forwarderPrefixes.has(L)&&M++;f=M/I.size}}a=S(a.hash,a.type,a.name,a.confident,l.advertCount,l.forwarderPrefixes.size,f)}}}if(a.name===null&&a.hash){const i=r.hashToName.get(a.hash)??d.get(a.hash)??y.get(a.hash)??null;i&&(a=S(a.hash,a.type,i,a.confident,a.advertObservations,a.topologyNeighborCount,a.topologyAffinity))}return t.set(T,a),a}const ye={hashToType:new Map,pubKeyMap:new Map,prefixIndex:new Map,crossClassPrefixes:new Set,sameClassAmbiguous:new Set,nameToHash:new Map,hashToName:new Map},_e={byPayload:new Map,byApprox:new Map},$=oe((e,r)=>({config:he,neighborContext:ye,extendedHashToType:new Map,advertNameToHash:new Map,advertHashToName:new Map,resolverMap:new Map,topologyProfiles:new Map,decryptedNameToHash:new Map,decryptedHashToName:new Map,srcHashResolverMap:new Map,discoveredNodes:new Map,contentInheritanceIndex:_e,_cache:new Map,_neighborFingerprint:"",_resolverFingerprint:"",_advertScanFingerprint:"",_decodedNameFingerprint:"",_inheritanceFingerprint:"",_decodedContentVersion:0,resolveSource:n=>{const o=r();return o.config.disambiguationEnabled?me(n,o.neighborContext,o.extendedHashToType,o.advertNameToHash,o.advertHashToName,o.resolverMap,o.topologyProfiles,X,o.decryptedNameToHash,o.decryptedHashToName,o._cache):ne},getDecodedContent:n=>{const o=r(),d=Z.getState().messages;return le(n,d,o.contentInheritanceIndex,o.config.macCorruptedPolicy)},setConfig:n=>{const o={...r().config,...n};e({config:o,_cache:new Map}),Y==null||Y()},recompute:(n,o,d)=>{const s=r(),{config:g}=s,m=`${Object.keys(o).length}`;let u=s.neighborContext;m!==s._neighborFingerprint&&(u=pe(o));const y=n.length>1e5?500:n.length>1e4?200:50,t=Math.floor(n.length/y)*y,_=`${m}:${t}`;let N=s.extendedHashToType,c=s.advertNameToHash,h=s.advertHashToName,v=s.discoveredNodes;if(_!==s._advertScanFingerprint||m!==s._neighborFingerprint){const H=fe(n,u.hashToType,u.pubKeyMap,u.nameToHash);N=H.extendedHashToType,c=H.advertNameToHash,h=H.advertHashToName,v=H.discoveredNodes}const T=`${Object.keys(o).length}:${t}:${u.crossClassPrefixes.size}:${g.recencyDecayHours}:${g.zeroHopDecayHours}`;let b=s.resolverMap,w=s.topologyProfiles;if(T!==s._resolverFingerprint){const H=ae(n,o,{recencyDecayHours:g.recencyDecayHours,zeroHopDecayHours:g.zeroHopDecayHours});b=H.resolver,w=H.topologyProfiles}const A=Math.floor(d.size/20)*20,x=`${t}:${A}:${T}`;let E=s.decryptedNameToHash,G=s.decryptedHashToName;if(x!==s._decodedNameFingerprint){const H=ge(n,d,u,c,b);E=H.decryptedNameToHash,G=H.decryptedHashToName}{const H=[];for(const[P,D]of v)if(D.name===null){const C=u.hashToName.get(P)??h.get(P)??G.get(P)??null;C&&H.push([P,C])}if(H.length>0){v=new Map(v);for(const[P,D]of H){const C=v.get(P);v.set(P,{...C,name:D})}}}const a=new Map(b);for(const[H,P]of E){const D=K(P),C=u.prefixIndex.get(D);if(!C||C.length<=1)continue;const F=C.find(z=>{var i;return((i=z.name)==null?void 0:i.toLowerCase())===H});F&&a.get(D)!==F.hash&&a.set(D,F.hash)}for(const[H,P]of c){const D=K(P),C=u.prefixIndex.get(D);if(!C||C.length<=1)continue;const F=C.find(z=>{var i;return((i=z.name)==null?void 0:i.toLowerCase())===H});F&&a.get(D)!==F.hash&&a.set(D,F.hash)}const R=`${t}:${A}`;let V=s.contentInheritanceIndex;R!==s._inheritanceFingerprint&&(V=ie(n,d)),re(a),W.active&&W.emit("pipeline:disambig:recompute",{packets:n.length,neighbors:Object.keys(o).length,decoded:d.size}),e({neighborContext:u,extendedHashToType:N,advertNameToHash:c,advertHashToName:h,resolverMap:b,topologyProfiles:w,decryptedNameToHash:E,decryptedHashToName:G,srcHashResolverMap:a,discoveredNodes:v,contentInheritanceIndex:V,_cache:new Map,_neighborFingerprint:m,_resolverFingerprint:T,_advertScanFingerprint:_,_decodedNameFingerprint:x,_inheritanceFingerprint:R,_decodedContentVersion:s._decodedContentVersion+1})}}));let X=new Map,Y=null;function J(e,r){var d,s,g,m;if(!(r!=null&&r.public_key))return e;const n=r.public_key.toLowerCase(),o=n.startsWith("0x")?n.slice(2):n;for(const u of Object.keys(e))if((u.startsWith("0x")?u.slice(2):u).toLowerCase()===o)return e;return{...e,[r.public_key]:{name:r.node_name,node_name:r.node_name,contact_type:"Repeater",is_repeater:!0,last_seen:Date.now()/1e3,latitude:(s=(d=r.config)==null?void 0:d.repeater)==null?void 0:s.latitude,longitude:(m=(g=r.config)==null?void 0:g.repeater)==null?void 0:m.longitude,zero_hop:!0}}}if(typeof window<"u"){let e=function(){if(!n)return 150;const u=n.useStore.getState().packets.length;return u>1e5?1e3:u>1e4?500:150},r=function(){m&&clearTimeout(m),m=setTimeout(()=>{var c;if(m=null,!n||!o)return;const u=n.useStore.getState(),y=o.useDecodedMessagesStore.getState(),t=u.packets,_=J(((c=u.stats)==null?void 0:c.neighbors)??{},u.stats),N=y.stableMessages;$.getState().recompute(t,_,N)},e())},n=null,o=null,d=[],s,g=new Map,m=null;Y=r,setTimeout(()=>{k(()=>import("./index-BTKkXbas.js").then(u=>u.g1),__vite__mapDeps([0,1])).then(u=>{var _,N;n=u,u.useStore.subscribe(c=>{var T,b;const h=c.packets!==d,v=((T=c.stats)==null?void 0:T.neighbors)!==s;(h||v)&&(d=c.packets,s=(b=c.stats)==null?void 0:b.neighbors,r())});const y=u.useStore.getState();d=y.packets,s=(_=y.stats)==null?void 0:_.neighbors;const t=J(((N=y.stats)==null?void 0:N.neighbors)??{},y.stats);(d.length>0||Object.keys(t).length>0)&&$.getState().recompute(d,t,new Map)}),k(()=>import("./index-BTKkXbas.js").then(u=>u.g0),__vite__mapDeps([0,1])).then(u=>{o=u,X=u.useDecodedMessagesStore.getState().messages,u.useDecodedMessagesStore.subscribe(y=>{y.messages!==X&&(X=y.messages),y.stableMessages!==g&&(g=y.stableMessages,r())})})},0)}const we=$;function Te(){return $(e=>e.resolveSource)}function Se(){return $(e=>e.neighborContext)}function be(){return $(e=>e.topologyProfiles)}function He(){return $(e=>e.advertNameToHash)}function Me(){const e=$(o=>o.getDecodedContent),r=$(o=>o._decodedContentVersion),n=Z(o=>o._successCount);return se.useCallback(o=>e(o),[e,r,n])}function Ce(){return $(e=>e.config)}function xe(){return $(e=>e.srcHashResolverMap)}function Pe(){return $(e=>e.discoveredNodes)}export{he as DEFAULT_PIPELINE_CONFIG,He as useAdvertNameToHash,Pe as useDiscoveredNodes,Me as useGetDecodedContent,Se as useNeighborContext,Ce as usePipelineConfig,we as usePipelineStore,Te as useResolveSource,xe as useSrcHashResolverMap,be as useTopologyProfiles};
