var e=Object.defineProperty,t=(t,r,a)=>((t,r,a)=>r in t?e(t,r,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[r]=a)(t,"symbol"!=typeof r?r+"":r,a);import{j as r,r as a,c as s}from"./vendor-react-j_fHog8x.js";import{D as n,o,L as i}from"./xterm-Cq-DlOOL.js";import{bu as c,bv as l,bw as d,bx as u,by as p,bz as m,bA as h,bB as g,b3 as f,a7 as y,bC as v,$ as w,_ as b,aA as $,bD as x,bE as _,bF as S,K as k,bG as C,N as O,n as P,bH as j,bI as N}from"./index-Dw8YD-ih.js";import{s as T}from"./signal-scoring-CcBiRcks.js";import{h as E,c as R,D as A}from"./geo-utils-DR1wMmc7.js";import{a as I}from"./ping-D1ia5AVW.js";import{c as L}from"./vendor-core-CDNU4oKM.js";import{P as F,d as M}from"./payload-decoders--DYmFUX4.js";import{g as G,r as B}from"./system-CAe7c5zA.js";import{g as D,K as H,F as z,S as U}from"./KeycapButton-CHU89HhG.js";import{P as q,b as X,B as W,a as K}from"./PageLayout-6RwS8y6W.js";import"./maplibre-gl-b91ci4Kr.js";class V{constructor(){t(this,"commands",[])}register(...e){this.commands.push(...e)}find(e){let t;for(const r of this.commands)r.matches(e)&&(!t||r.name.length>t.name.length)&&(t=r);return t}all(){return this.commands}}class J{constructor(){t(this,"aliases",[]),t(this,"params")}matches(e){const t=e.toLowerCase().trim(),r=e=>t===e||t.startsWith(e+" ");return r(this.name)||this.aliases.some(r)}write(e,t,r){return e.write(t,r)}writeSuccess(e,t){return e.write(t,"success")}writeError(e,t){return e.write(t,"error")}writeInfo(e,t){return e.write(t,"info")}writeWarning(e,t){return e.write(t,"warning")}argsAfterName(e){const t=e.toLowerCase().trim(),r=[this.name,...this.aliases].sort((e,t)=>t.length-e.length);for(const a of r)if(t.startsWith(a))return e.trim().slice(a.length).trim();return e.trim()}}const Y="[",Q=`${Y}0m`,Z=`${Y}1m`,ee=`${Y}2m`,te=`${Y}3m`,re=`${Y}32m`,ae=`${Y}31m`,se=`${Y}33m`,ne=`${Y}36m`,oe=`${Y}34m`,ie=`${Y}90m`,ce=`${Y}92m`,le=`${Y}96m`;function de(e,t){switch(t){case"success":case"info":case"value":return`${oe}${e}${Q}`;case"error":case"system":return`${ie}${e}${Q}`;case"warning":return`${se}${e}${Q}`;default:return e}}function ue(e){return`${Z}${e}${Q}`}function pe(e){return`${ee}${e}${Q}`}function me(e){return`${oe}${e}${Q}`}function he(e){return`${oe}${e}${Q}`}function ge(e){return`${ie}${e}${Q}`}function fe(e,t){return`${ie}${e}: ${Q}${oe}${Z}${t}${Q}`}function ye(e,t,r=22){const a=e.split(" "),s=a[0];let n=ne;return"get"===s?n=re:"set"===s&&(n=se),`  ${a.length>1?`${n}${Z}${s}${Q} ${oe}${a.slice(1).join(" ")}${Q}`:`${n}${Z}${e}${Q}`}${" ".repeat(Math.max(1,r-e.length))}${ie}${t}${Q}`}function ve(e){return`${Z}${oe}${e}${Q}`}function we(e){return`${ie}${te}${e}${Q}`}const be=`${ie}$ ${Q}`;function $e(e){return`${ae}${Z}‚óè${Q} ${ie}${e}${Q}`}function xe(e){const t=e<1e3?`${e.toFixed(0)}ms`:`${(e/1e3).toFixed(1)}s`;return`${function(e){return e<1500?ce:e<4e3?re:e<8e3?se:e<15e3?ae:`${ae}${Z}`}(e)}${t}${Q}`}function _e(e,t){return`${function(e){switch(e){case"excellent":return le;case"good":return re;case"fair":return se;case"poor":return ae;case"critical":return`${ae}${Z}`;default:return ie}}(t)}${e}${Q}`}const Se=[ae,ae,se,re,le];function ke(e,t){return`${Se[t]??ie}${e}${Q}`}function Ce(e){return e.replace(/[\p{Emoji_Presentation}\p{Extended_Pictographic}\uFE0F\u200D]/gu,"").trim()}const Oe="[2K\r";function Pe(e=1){return`[${e}A`}function je(e,t){const r=function(e){return getComputedStyle(document.documentElement).getPropertyValue(e).trim()}(e);return r||t}function Ne(){const e=je("--terminal-bg","#0d0d0d"),t=je("--text-primary","#e0e0e0"),r=je("--accent-primary","#3b82f6"),a=je("--accent-primary","#3b82f6")+"40",s=je("--accent-danger","#ef4444"),n=je("--accent-success","#22c55e"),o=je("--accent-secondary","#f59e0b"),i=je("--accent-primary","#3b82f6"),c=je("--accent-tertiary","#06b6d4"),l=je("--text-muted","#666666"),d=je("--text-secondary","#a0a0a0");return{background:e,foreground:t,cursor:r,cursorAccent:e,selectionBackground:a,selectionForeground:t,black:je("--bg-surface","#1a1a1a"),red:s,green:n,yellow:o,blue:i,magenta:o,cyan:c,white:t,brightBlack:l,brightRed:s,brightGreen:n,brightYellow:o,brightBlue:i,brightMagenta:o,brightCyan:c,brightWhite:d}}const Te=[{label:"Information",commands:["status","uptime","board","packets"]},{label:"Network",commands:["neighbors","ping","identities","keys","acl","rooms"]},{label:"Radio",commands:["get","set","advert"]},{label:"System",commands:["restart","cap"]},{label:"Tools",commands:["convert","clear","help"]}];class Ee extends J{constructor(e){super(),t(this,"name","help"),t(this,"description","Show available commands"),t(this,"aliases",["?","h","get help"]),this.registry=e}execute({output:e,rawInput:t}){var r,a;const s=this.argsAfterName(t).toLowerCase().trim();if(s&&"help"!==s){const t=this.registry.find(s+" help")||this.registry.find(s);return t?void e.write([ve(t.name),`  ${ge(t.description)}`,"",t.params?ye(t.name+" "+t.params,""):ye(t.name,""),(null==(r=t.aliases)?void 0:r.length)?`  ${ge("aliases:")} ${he(t.aliases.join(", "))}`:"","",we(`Run "${t.name} help" for detailed usage.`)].filter(Boolean).join("\n")):void e.write(`Unknown command: ${he(s)}`,"warning")}const n=this.registry.all(),o=new Map(n.map(e=>[e.name,e])),i=[ve("pymc console")+"  "+ge("terminal"),""];for(const d of Te){i.push(ue(d.label));for(const e of d.commands){const t=o.get(e);if(t){const e=(null==(a=t.aliases)?void 0:a.length)?"  "+ge(t.aliases.slice(0,3).join(", ")):"";i.push(ye(t.name,t.description)+e)}}i.push("")}const c=new Set(Te.flatMap(e=>e.commands)),l=n.filter(e=>!c.has(e.name));if(l.length>0){i.push(ue("Other"));for(const e of l)i.push(ye(e.name,e.description));i.push("")}i.push(we('Type "<command> help" for detailed usage.')),i.push(we("Some MeshCore commands are not available via HTTP.")),e.write(i.join("\n"))}}class Re extends J{constructor(){super(...arguments),t(this,"name","clear"),t(this,"description","Clear terminal screen"),t(this,"aliases",["cls"])}execute({output:e,rawInput:t}){"help"!==this.argsAfterName(t).toLowerCase().trim()?e.clear():e.write([ve("clear"),`  ${ge("Clear all terminal output.")}`,"",ye("clear","clear the screen"),"",ve("Aliases"),`  ${ge("cls")}`].join("\n"))}}function Ae(e){const t=Math.floor(e/86400),r=Math.floor(e%86400/3600),a=Math.floor(e%3600/60);return t>0?`${t}d ${r}h ${a}m`:r>0?`${r}h ${a}m`:`${a}m`}class Ie extends J{constructor(){super(...arguments),t(this,"name","status"),t(this,"description","Get repeater status summary"),t(this,"aliases",["st"])}async execute({output:e,rawInput:t}){var r,a,s;if("help"===this.argsAfterName(t).toLowerCase().trim())return void e.write([ve("status"),`  ${ge("Show a quick summary of mode, neighbor count, and uptime.")}`,"",ye("status","show summary"),"",ve("Aliases"),`  ${ge("st")}`].join("\n"));const n=e.write("processing...","system");try{const t=await l(),o=(null==(a=null==(r=t.config)?void 0:r.repeater)?void 0:a.mode)||"unknown",i=Object.keys(t.neighbors||{}).length,c=Object.values(t.neighbors||{}).filter(e=>e.zero_hop).length,d=(null==(s=t.config)?void 0:s.node_name)||t.node_name||"unknown",u=Ae(t.uptime_seconds||0);e.update(n,[`${ue(d)}  ${ge("repeater")}`,"",`  ${fe("Mode",he(o))}`,`  ${fe("Neighbors",`${he(String(c))} direct  ${ge(`${i} total`)}`)}`,`  ${fe("RX / TX",`${he(String(t.rx_count??0))} / ${he(String(t.tx_count??0))}`)}`,`  ${fe("Uptime",he(u))}`].join("\n"))}catch(o){e.update(n,`Error: ${o instanceof Error?o.message:"Command failed"}`,"error")}}}class Le extends J{constructor(){super(...arguments),t(this,"name","uptime"),t(this,"description","Show system uptime")}async execute({output:e,rawInput:t}){if("help"===this.argsAfterName(t).toLowerCase().trim())return void e.write([ve("uptime"),`  ${ge("Display how long the repeater service has been running.")}`,"",ye("uptime","show uptime")].join("\n"));const r=e.write("processing...","system");try{const t=await l();e.update(r,fe("Uptime",he(Ae(t.uptime_seconds||0))))}catch(a){e.update(r,`Error: ${a instanceof Error?a.message:"Command failed"}`,"error")}}}class Fe extends J{constructor(){super(...arguments),t(this,"name","packets"),t(this,"description","Show packet statistics")}async execute({output:e,rawInput:t}){if("help"===this.argsAfterName(t).toLowerCase().trim())return void e.write([ve("packets"),`  ${ge("Display packet counters (received, transmitted, forwarded, dropped).")}`,"",ye("packets","show packet stats")].join("\n"));const r=e.write("processing...","system");try{const t=await l(),a=(t.rx_count??0)+(t.tx_count??0);e.update(r,[ve("Packet Stats")+`  ${ge(`${a} total`)}`,"",`  ${fe("Received",he(String(t.rx_count??0)))}`,`  ${fe("Transmitted",he(String(t.tx_count??0)))}`,`  ${fe("Forwarded",he(String(t.forwarded_count??0)))}`,`  ${fe("Dropped",he(String(t.dropped_count??0)))}`].join("\n"))}catch(a){e.update(r,`Error: ${a instanceof Error?a.message:"Command failed"}`,"error")}}}function Me(e){return e>=1073741824?`${(e/1073741824).toFixed(1)} GB`:e>=1048576?`${(e/1048576).toFixed(0)} MB`:`${(e/1024).toFixed(0)} KB`}function Ge(e){const t=Math.floor(e/86400),r=Math.floor(e%86400/3600),a=Math.floor(e%3600/60);return t>0?`${t}d ${r}h ${a}m`:r>0?`${r}h ${a}m`:`${a}m`}class Be extends J{constructor(){super(...arguments),t(this,"name","board"),t(this,"description","Show board/platform info")}async execute({output:e,rawInput:t}){var r;if("help"===this.argsAfterName(t).toLowerCase().trim())return void e.write([ve("board"),`  ${ge("Display platform and hardware information.")}`,"",ye("board","show board info")].join("\n"));const a=e.write("loading...","system");try{const[t,s]=await Promise.all([d(),l()]),n=[];if(n.push(`  ${fe("Node",he(s.node_name||"Unknown"))}`),n.push(`  ${fe("Runtime",he(`pyMC_Repeater v${s.version||"?"}`))}`),s.core_version&&n.push(`  ${fe("Core",he(s.core_version))}`),n.push(""),t.success&&t.data){const e=t.data;n.push(`  ${fe("CPU",he(`${e.cpu.usage_percent.toFixed(1)}%`))}  ${ge(`${e.cpu.count} core${e.cpu.count>1?"s":""}`)}`),e.cpu.load_avg&&n.push(`  ${fe("Load",he(`${e.cpu.load_avg["1min"].toFixed(2)} / ${e.cpu.load_avg["5min"].toFixed(2)} / ${e.cpu.load_avg["15min"].toFixed(2)}`))}`);const a=Object.entries(e.temperatures||{});if(a.length>0){const e=a[0];n.push(`  ${fe("Temp",he(`${e[1].toFixed(1)}¬∞C`))}${a.length>1?`  ${ge(a.slice(1).map(([e,t])=>`${e}: ${t.toFixed(1)}¬∞C`).join(", "))}`:""}`)}n.push(""),n.push(`  ${fe("Memory",he(`${Me(e.memory.used)} / ${Me(e.memory.total)}`))}  ${ge(`${e.memory.usage_percent.toFixed(0)}%`)}`),n.push(`  ${fe("Disk",he(`${Me(e.disk.used)} / ${Me(e.disk.total)}`))}  ${ge(`${e.disk.usage_percent.toFixed(0)}%`)}`),n.push(""),(null==(r=e.system)?void 0:r.uptime)&&n.push(`  ${fe("System uptime",he(Ge(e.system.uptime)))}`),n.push(`  ${fe("Service uptime",he(Ge(s.uptime_seconds)))}`),e.network&&n.push(`  ${fe("Net TX/RX",he(`${Me(e.network.bytes_sent)} / ${Me(e.network.bytes_recv)}`))}`)}else n.push(`  ${fe("Platform",he("Linux"))}`),n.push(`  ${fe("Service uptime",he(Ge(s.uptime_seconds)))}`),n.push(`  ${ge("Hardware stats unavailable")}`);e.update(a,n.join("\n"),"value")}catch(s){e.update(a,`Error: ${s instanceof Error?s.message:"Failed to load hardware stats"}`,"error")}}}class De extends J{constructor(){super(...arguments),t(this,"name","advert"),t(this,"description","Send repeater advertisement")}async execute({output:e,rawInput:t}){if("help"===this.argsAfterName(t).toLowerCase().trim())return void e.write([ve("advert"),`  ${ge("Broadcast a repeater advertisement to the mesh network.")}`,"",ye("advert","send advert now"),"",we("Adverts announce this repeater's presence to neighbors.")].join("\n"));const r=e.write("processing...","system");try{const t=await u();t.success?e.update(r,`‚úì ${he("Advert sent")}`,"success"):e.update(r,`Error: ${t.error||"Failed"}`,"error")}catch(a){e.update(r,`Error: ${a instanceof Error?a.message:"Command failed"}`,"error")}}}const He=["sig","name","rssi","snr","dist","heard"],ze={excellent:5,good:4,fair:3,poor:2,critical:1};function Ue(e){const t=Math.floor(Date.now()/1e3-e);return t<60?`${t}s ago`:t<3600?`${Math.floor(t/60)}m ago`:t<86400?`${Math.floor(t/3600)}h ago`:`${Math.floor(t/86400)}d ago`}function qe(e){return e<1e3?`${Math.round(e)}m`:`${(e/1e3).toFixed(1)}km`}const Xe=["‚ñÅ","‚ñÉ","‚ñÖ","‚ñá","‚ñà"],We={excellent:5,good:4,fair:3,poor:2,critical:1};function Ke(e){const t=We[e]??0;return Xe.slice(0,t).map((e,t)=>ke(e,t)).join("")+ge(".".repeat(5-t))}function Ve(e,t=e=>e){return{text:e,color:t}}function Je(e){return ge("+"+e.map(e=>"-".repeat(e+2)).join("+")+"+")}function Ye(e,t){const r=e.map((e,r)=>{if(null!=e.rendered){const a=Math.max(0,t[r]-e.text.length);return" "+e.rendered+" ".repeat(a)+" "}return" "+e.color((a=e.text,s=t[r],a.length>=s?a.slice(0,s):a+" ".repeat(s-a.length)))+" ";var a,s});return ge("|")+r.join(ge("|"))+ge("|")}class Qe extends J{constructor(){super(...arguments),t(this,"name","neighbors"),t(this,"description","Show direct RF neighbors with signal stats"),t(this,"aliases",["nb","get neighbors","get neighbor"]),t(this,"params","[sig|name|rssi|snr|dist|heard]")}async execute(e){const{output:t,cols:r}=e,a=this.argsAfterName(e.rawInput).toLowerCase().trim();if("help"===a)return void this.printUsage(t);const s=He.includes(a)?a:null,n=t.write("processing...","system");try{const e=await l(),a=e.neighbors||{},o=Object.entries(a).filter(([,e])=>e.zero_hop);if(0===o.length){const e=Object.keys(a).length;return void t.update(n,e>0?`No direct neighbors. ${e} relayed neighbor${1!==e?"s":""} known.`:"No neighbors discovered yet.","warning")}const i=function(e){var t;const r=null==(t=e.config)?void 0:t.radio;return(null==r?void 0:r.spreading_factor)&&(null==r?void 0:r.bandwidth)?{sf:r.spreading_factor,bwHz:r.bandwidth}:null}(e),c=function(e){var t;const r=null==(t=e.config)?void 0:t.repeater;return r&&E(r.latitude,r.longitude)?{lat:r.latitude,lon:r.longitude}:null}(e),d=e.noise_floor_dbm;this.sortNeighbors(o,s,i,c,d);const u=s?`  ${pe(`sorted by ${s}`)}`:"",p=[ve(`Direct Neighbors (${o.length})`)+u,""];if(r<55)for(const[t,r]of o)p.push(...this.cardLayout(t,r,i,c,d));else{const e=r>=70&&null!=c,t=o.map(([t,r])=>this.buildRow(t,r,i,c,d,e)),a=e?["SIG","NAME","RSSI","SNR","DIST","HEARD"]:["SIG","NAME","RSSI","SNR","HEARD"],s=a.slice(1).map((e,r)=>Math.max(e.length,...t.map(e=>e[r+1].text.length))),n=5,l=s.reduce((e,t)=>e+t+3,0),u=Math.max(4,r-l-n-7),m=[n,Math.min(u,Math.max(4,...t.map(e=>e[1].text.length))),...s.slice(1)];p.push(Je(m),...t.map(e=>Ye(e,m)),Je(m),Ye(a.map(e=>Ve(e,ue)),m),Je(m)),p.push(this.footer(i,d))}t.update(n,p.join("\n"))}catch(o){t.update(n,`Error: ${o instanceof Error?o.message:"Command failed"}`,"error")}}sortNeighbors(e,t,r,a,s){switch(t){case"sig":e.sort(([,e],[,t])=>(ze[this.gradeNeighbor(e,r,s)]??0)-(ze[this.gradeNeighbor(t,r,s)]??0));break;case"name":e.sort(([e,t],[r,a])=>{const s=(t.name||t.node_name||e.slice(0,8)).toLowerCase(),n=(a.name||a.node_name||r.slice(0,8)).toLowerCase();return s.localeCompare(n)});break;case"rssi":e.sort(([,e],[,t])=>(e.rssi??-999)-(t.rssi??-999));break;case"snr":e.sort(([,e],[,t])=>(e.snr??-999)-(t.snr??-999));break;case"dist":e.sort(([,e],[,t])=>(this.distTo(e,a)??1/0)-(this.distTo(t,a)??1/0));break;case"heard":e.sort(([,e],[,t])=>(e.last_seen||0)-(t.last_seen||0));break;default:e.sort(([,e],[,t])=>(t.last_seen||0)-(e.last_seen||0))}}gradeNeighbor(e,t,r){const a=null!=e.rssi?e.rssi-3.5:null,s=null!=r&&r>-100?1:0,n=T(e.snr??null,a,t,s);return(null==n?void 0:n.finalGrade)??"critical"}distTo(e,t){return t&&E(e.latitude,e.longitude)?R(t.lat,t.lon,e.latitude,e.longitude):null}buildRow(e,t,r,a,s,n){const o=this.gradeNeighbor(t,r,s),i=Ce(t.name||t.node_name||e.slice(0,8))||e.slice(0,8),c=null!=t.rssi?`${t.rssi} dBm`:"-",l=null!=t.snr?`${t.snr} dB`:"-",d=t.last_seen?Ue(t.last_seen):"-",u=[(p=Ke(o),{text:"|||||",color:e=>e,rendered:p}),Ve(i,ue),Ve(c,he),Ve(l,he)];var p;if(n){const e=this.distTo(t,a);u.push(Ve(null!=e?qe(e):"-",pe))}return u.push(Ve(d,pe)),u}cardLayout(e,t,r,a,s){const n=this.gradeNeighbor(t,r,s),o=Ce(t.name||t.node_name||e.slice(0,8))||e.slice(0,8),i=null!=t.rssi?`${t.rssi}`:"-",c=null!=t.snr?`${t.snr}`:"-",l=t.last_seen?Ue(t.last_seen):"-",d=this.distTo(t,a),u=null!=d?`  ${ge("dist")} ${he(qe(d))}`:"";return[`${Ke(n)} ${ue(o)}`,`  ${ge("rssi")} ${he(i)}  ${ge("snr")} ${he(c)}${u}  ${pe(l)}`,""]}footer(e,t){const r=[];return e&&r.push(`SF${e.sf}/${e.bwHz>=1e3?e.bwHz/1e3+"kHz":e.bwHz+"Hz"}`),r.push("ant 3.5dBi"),null!=t&&r.push(`nf ${t}dBm`),ge(r.join("  "))}printUsage(e){const t=[ve("neighbors"),`  ${ge("Show direct RF neighbors with signal quality, RSSI, SNR, and distance.")}`,"",ve("Usage"),ye("neighbors","default sort (most recent)"),ye("neighbors sig","sort by signal grade (weakest first)"),ye("neighbors name","sort alphabetically"),ye("neighbors rssi","sort by RSSI (weakest first)"),ye("neighbors snr","sort by SNR (lowest first)"),ye("neighbors dist","sort by distance (closest first)"),ye("neighbors heard","sort by last seen (oldest first)"),ye("neighbors help","show this help"),"",ve("Aliases"),`  ${ge("nb, get neighbors, get neighbor")}`,"",we("Signal bars factor radio config, noise floor, and 3.5 dBi antenna gain."),we("Only zero-hop (direct RF) neighbors are shown.")];e.write(t.join("\n"))}}class Ze extends J{constructor(){super(...arguments),t(this,"name","get"),t(this,"description","Get repeater parameter"),t(this,"params","{parameter}")}async execute({output:e,rawInput:t}){const r=this.argsAfterName(t).toLowerCase().trim();if("help"===r||!r)return void e.write([ve("get"),`  ${ge("Read a repeater configuration parameter.")}`,"",ve("Identity"),ye("get name","node name"),ye("get role","node role"),ye("get public.key","public key"),"",ve("Location"),ye("get lat","latitude"),ye("get lon","longitude"),"",ve("Radio"),ye("get radio","full radio summary"),ye("get freq","frequency (MHz)"),ye("get tx","TX power (dBm)"),ye("get bw","bandwidth (kHz)"),ye("get sf","spreading factor"),ye("get cr","coding rate"),"",ve("Timing"),ye("get txdelay","TX delay factor"),ye("get direct.txdelay","direct TX delay"),ye("get rxdelay","RX delay base"),"",ve("Repeater"),ye("get mode","forward or monitor"),ye("get flood.max","max flood hops"),ye("get advert.interval","advert interval"),ye("get duty","duty cycle state"),"",ve("Advanced"),ye("get multi.acks","multi-ack count"),ye("get int.thresh","interference threshold (dBm)"),ye("get agc.reset.interval","AGC reset interval")].join("\n"));const a=e.write("processing...","system");try{const t=await l(),{result:s,type:n}=function(e,t){const r=t.config||{},a=r.radio||{},s=r.repeater||{},n=r.delays||{},o=r.duty_cycle||{},i=(e,t)=>({result:fe(e,he(t)),type:"value"});switch(e){case"name":return i("name",r.node_name||"Unknown");case"role":return i("role","repeater");case"lat":return i("lat",null!=s.latitude?String(s.latitude):"not set");case"lon":return i("lon",null!=s.longitude?String(s.longitude):"not set");case"freq":return i("freq",a.frequency?`${(a.frequency/1e6).toFixed(3)} MHz`:"?");case"tx":return i("tx",null!=a.tx_power?`${a.tx_power} dBm`:"?");case"bw":return i("bw",a.bandwidth?a.bandwidth/1e3+" kHz":"?");case"sf":return i("sf",String(a.spreading_factor??"?"));case"cr":return i("cr",a.coding_rate?`4/${a.coding_rate}`:"?");case"radio":return a.frequency?{result:[`  ${fe("freq",he(`${(a.frequency/1e6).toFixed(3)} MHz`))}`,`  ${fe("bw",he(a.bandwidth/1e3+" kHz"))}`,`  ${fe("sf",he(String(a.spreading_factor)))}`,`  ${fe("cr",he(`4/${a.coding_rate}`))}`,`  ${fe("tx",he(`${a.tx_power} dBm`))}`].join("\n"),type:"value"}:i("radio","?");case"af":case"txdelay":return i("txdelay",String(n.tx_delay_factor??"1.0"));case"direct.txdelay":return i("direct.txdelay",String(n.direct_tx_delay_factor??"0.5"));case"rxdelay":return i("rxdelay",String(n.rx_delay_base??"0.0"));case"mode":return i("mode",s.mode||"forward");case"repeat":return i("repeat","forward"===s.mode?"on":"off");case"flood.max":return i("flood.max",String(s.max_flood_hops??"3"));case"flood.advert.interval":return i("flood.advert.interval",null!=s.send_advert_interval_hours?`${s.send_advert_interval_hours}h`:"?");case"advert.interval":return i("advert.interval",null!=s.advert_interval_minutes?`${s.advert_interval_minutes}m`:"120m");case"duty":case"duty.enabled":return i("duty",o.enforcement_enabled?"on":"off");case"duty.max":return i("duty.max",null!=o.max_airtime_percent?`${o.max_airtime_percent}%`:"?");case"multi.acks":return i("multi.acks",String(s.multi_acks??"0"));case"int.thresh":return i("int.thresh",`${s.interference_threshold??-120} dBm`);case"agc.reset.interval":return i("agc.reset.interval",String(s.agc_reset_interval??"0"));case"public.key":return i("public.key",t.public_key||"not available");case"prv.key":return{result:`${ge("Private key stored in /etc/pymc_repeater/config.yaml")}\n\n  ${fe("view",he("sudo grep identity_key /etc/pymc_repeater/config.yaml"))}\n  ${fe("set",he("sudo ./convert_firmware_key.sh <64-byte-hex>"))}`,type:"info"};case"guest.password":case"allow.read.only":return{result:`${ge("Security settings not exposed via stats API.")}\n${ge("Check /etc/pymc_repeater/config.yaml")}`,type:"warning"};default:return{result:`Unknown parameter: ${he(e)}\n${ge('Run "get help" to see available parameters.')}`,type:"error"}}}(r,t);e.update(a,s,n)}catch(s){e.update(a,`Error: ${s instanceof Error?s.message:"Command failed"}`,"error")}}}class et extends J{constructor(){super(...arguments),t(this,"name","set"),t(this,"description","Set repeater parameter"),t(this,"params","{parameter} {value}")}async execute({output:e,rawInput:t}){var r;const a=this.argsAfterName(t).split(/\s+/),s=null==(r=a[0])?void 0:r.toLowerCase(),n=a.slice(1).join(" ");if("help"===s||!s)return void e.write([ve("set"),`  ${ge("Write a repeater configuration parameter.")}`,"",ve("Identity"),ye("set name <name>","node name"),ye("set lat <deg>","latitude (-90 to 90)"),ye("set lon <deg>","longitude (-180 to 180)"),"",ve("Radio"),ye("set freq <MHz>","frequency"),ye("set tx <dBm>","TX power (2-22)"),ye("set bw <kHz>","bandwidth"),ye("set sf <5-12>","spreading factor"),ye("set cr <5-8>","coding rate"),"",ve("Timing"),ye("set txdelay <0-5>","TX delay factor"),ye("set direct.txdelay <0-5>","direct TX delay"),ye("set rxdelay <n>","RX delay base"),"",ve("Repeater"),ye("set mode <fwd|mon>","forward or monitor"),ye("set flood.max <0-64>","max flood hops"),ye("set advert.interval <m>","advert interval (min)"),ye("set duty <on|off>","duty cycle enforcement"),ye("set log <level>","log level"),"",ve("Advanced"),ye("set multi.acks <n>","multi-ack count"),ye("set int.thresh <dBm>","interference threshold"),ye("set agc.reset.interval <n>","AGC reset interval (x4)"),"",we("Some changes require a service restart.")].join("\n"));const o=e.write("processing...","system");try{const{result:r,type:a}=await async function(e,t,r){switch(e){case"mode":return async function(e){const t=e.toLowerCase();return"forward"!==t&&"monitor"!==t?it('Mode must be "forward" or "monitor"'):(await g(t)).success?ot(`OK - Mode set to ${t}`):it("Failed")}(t);case"duty":return async function(e){const t="on"===e.toLowerCase()||"1"===e;return(await h(t)).success?ot("OK - Duty cycle "+(t?"enabled":"disabled")):it("Failed")}(t);case"tx":return tt("tx_power",at(t,2,22,"TX power must be 2-22 dBm"));case"sf":return tt("spreading_factor",at(t,5,12,"SF must be 5-12"));case"af":case"txdelay":return tt("tx_delay_factor",st(t,0,5,"TX delay must be 0.0-5.0"));case"direct.txdelay":return tt("direct_tx_delay_factor",st(t,0,5,"Direct TX delay must be 0.0-5.0"));case"rxdelay":return tt("rx_delay_base",function(e){const t=parseFloat(e);return isNaN(t)||t<0?{ok:!1,error:"Error: RX delay must be >= 0"}:{ok:!0,value:t}}(t));case"flood.max":return tt("max_flood_hops",at(t,0,64,"Max flood hops must be 0-64"));case"log":return async function(e){const t=e.toUpperCase();if(!["DEBUG","INFO","WARNING","ERROR"].includes(t))return it("Level must be debug, info, warning, or error");const r=await m(t);return r.success?ot(`OK - Log level set to ${t}`):it(r.error||"Failed")}(t);case"multi.acks":return tt("multi_acks",at(t,0,255,"Multi-acks must be 0-255"));case"int.thresh":return tt("interference_threshold",at(t,-200,0,"Interference threshold must be -200 to 0 dBm"));case"agc.reset.interval":{const e=nt(t);if(!e.ok)return it(e.error);if(e.value<0)return it("AGC reset interval must be >= 0");const r=4*Math.floor(e.value/4);return rt("agc_reset_interval",r,`OK - AGC reset interval set to ${r}${r!==e.value?` (rounded from ${e.value})`:""}`)}case"name":{const e=r.trim().substring(r.toLowerCase().indexOf("name")+5).trim();return e?tt("node_name",{ok:!0,value:e}):it("Node name cannot be empty")}case"lat":return tt("latitude",st(t,-90,90,"Latitude must be -90 to 90"));case"lon":return tt("longitude",st(t,-180,180,"Longitude must be -180 to 180"));case"freq":{const e=st(t,100,1e3,"Frequency must be 100-1000 MHz");return e.ok?tt("frequency",{ok:!0,value:1e6*e.value}):it(e.error)}case"bw":{const e=[7.8,10.4,15.6,20.8,31.25,41.7,62.5,125,250,500],r=parseFloat(t);return isNaN(r)||!e.includes(r)?it(`BW must be one of: ${e.join(", ")} kHz`):tt("bandwidth",{ok:!0,value:1e3*r})}case"cr":return tt("coding_rate",at(t,5,8,"Coding rate must be 5-8"));case"advert.interval":{const e=nt(t);return e.ok?0!==e.value&&(e.value<1||e.value>10080)?it("Advert interval must be 0 (off) or 1-10080 minutes"):rt("advert_interval_minutes",e.value,0===e.value?"OK - Local adverts disabled":`OK - Local advert interval set to ${e.value}m`):it(e.error)}case"flood.advert.interval":{const e=nt(t);return e.ok?0!==e.value&&(e.value<3||e.value>48)?it("Flood advert interval must be 0 (off) or 3-48 hours"):rt("flood_advert_interval_hours",e.value,0===e.value?"OK - Flood adverts disabled":`OK - Flood advert interval set to ${e.value}h`):it(e.error)}case"prv.key":{const e=t.trim();return e?/^[0-9a-fA-F]+$/.test(e)?128!==e.length?it(`Key must be 64 bytes (128 hex chars), got ${e.length} chars`):{result:`To set this key, run on the Pi:\n\n  sudo ./convert_firmware_key.sh ${e}\n\nThen restart: sudo systemctl restart pymc-repeater`,type:"info"}:it("Private key must be a hex string"):it("Private key cannot be empty")}default:return it(`Unknown parameter: ${e}`)}}(s,n,t);e.update(o,r,a)}catch(i){e.update(o,`Error: ${i instanceof Error?i.message:"Command failed"}`,"error")}}}async function tt(e,t){if(!t.ok)return it(t.error);const r=await p({[e]:t.value});if(!r.success)return it(r.error||"Failed");let a=`OK - ${e} set to ${t.value}`;return r.restart_required&&(a+="\n‚ö† Service restart required for changes to take effect\nRun: sudo systemctl restart pymc_repeater"),ot(a)}async function rt(e,t,r){const a=await p({[e]:t});if(!a.success)return it(a.error||"Failed");let s=r;return a.restart_required&&(s+="\n‚ö† Service restart required for changes to take effect\nRun: sudo systemctl restart pymc_repeater"),ot(s)}function at(e,t,r,a){const s=parseInt(e);return isNaN(s)||s<t||s>r?{ok:!1,error:`Error: ${a}`}:{ok:!0,value:s}}function st(e,t,r,a){const s=parseFloat(e);return isNaN(s)||s<t||s>r?{ok:!1,error:`Error: ${a}`}:{ok:!0,value:s}}function nt(e){const t=parseInt(e);return isNaN(t)?{ok:!1,error:"Error: Expected a number"}:{ok:!0,value:t}}function ot(e){return{result:e,type:"success"}}function it(e){return{result:`Error: ${e}`,type:"error"}}const ct=["‚ñÅ","‚ñÉ","‚ñÖ","‚ñá","‚ñà"],lt={excellent:5,good:4,fair:3,poor:2,critical:1};class dt extends J{constructor(){super(...arguments),t(this,"name","ping"),t(this,"description","Ping neighbor (name or 0xXX)"),t(this,"params","{target} [timeout]")}async execute({output:e,rawInput:t}){var r,a,s,n;const o=this.argsAfterName(t).trim(),i=o.split(/\s+/);if("help"===(null==(r=i[0])?void 0:r.toLowerCase()))return void e.write([ve("ping"),`  ${ge("Send a ping to a neighbor and measure round-trip time, signal quality, and path.")}`,"",ye("ping <name>","ping by node name"),ye("ping 0xAB","ping by hex prefix"),ye("ping <name> 60","ping with custom timeout (seconds)"),"",we("Default timeout: 30s. Signal bars factor radio config and noise floor.")].join("\n"));const c=i[i.length-1],d=parseInt(c),u=i.length>1&&!isNaN(d)&&d>0,p=u?i.slice(0,-1).join(" "):o,m=u?d:30;if(!p)return void e.write([ve("ping"),`  ${ge("Send a ping to a neighbor and measure round-trip time.")}`,"",ye("ping <name>","ping by node name"),ye("ping <name> 60","with custom timeout"),"",we('Run "ping help" for full usage.')].join("\n"));const h=e.write(`Pinging ${p}.`,"system");let g=1;const f=setInterval(()=>{g=g%3+1,e.update(h,`Pinging ${p}${".".repeat(g)}`,"system")},800);try{const[t,r]=await Promise.all([I(p,m),l()]);if(clearInterval(f),t.success&&t.data){const o=t.data,i=null==(a=r.config)?void 0:a.radio,c=(null==i?void 0:i.spreading_factor)&&(null==i?void 0:i.bandwidth)?{sf:i.spreading_factor,bwHz:i.bandwidth}:null,l=r.noise_floor_dbm,d=null!=l&&l>-100?1:0,u=o.rssi-3.5,p=T(o.snr_db,u,c,d),m=(null==p?void 0:p.finalGrade)??"critical",g=function(e){const t=lt[e]??0;return ct.slice(0,t).map((e,t)=>ke(e,t)).join("")+ge(".".repeat(5-t))}(m),f=(null==(s=o.path)?void 0:s.length)?o.path.length:0,y=(null==(n=o.path)?void 0:n.length)?o.path.join(" > "):"direct",v=m.charAt(0).toUpperCase()+m.slice(1),w=[`${g} ${ue("Reply from")} ${he(o.target_id)}`,"",`  ${fe("RTT",xe(o.rtt_ms))}`,`  ${fe("RSSI",`${o.rssi} dBm`)}`,`  ${fe("SNR",`${o.snr_db} dB`)}`,`  ${fe("Path",y)}${f>0?ge(` (${f} hop${1!==f?"s":""})`):""}`,`  ${fe("Quality",_e(v,m))}`],b=[];c&&b.push(`SF${c.sf}/${c.bwHz>=1e3?c.bwHz/1e3+"kHz":c.bwHz+"Hz"}`),b.push("ant 3.5dBi"),null!=l&&b.push(`nf ${l}dBm`),w.push("",ge(b.join("  "))),e.update(h,w.join("\n"))}else e.update(h,t.error||"Ping failed","error")}catch(y){clearInterval(f),e.update(h,`Error: ${y instanceof Error?y.message:"Ping failed"}`,"error")}}}class ut extends J{constructor(){super(...arguments),t(this,"name","convert"),t(this,"description","Convert between hex and base64"),t(this,"params","hex|base64 {value}")}execute({output:e,args:t}){var r;const a=null==(r=t[1])?void 0:r.toLowerCase(),s=t.slice(2).join(" ").trim();"help"!==a&&(a||s)?"hex"===a?this.hexToBase64(e,s):"base64"===a?this.base64ToHex(e,s):e.write([ve("convert"),`  ${ge("Convert between hex and base64 encodings.")}`,"",ye("convert hex <hex>","hex ‚Üí base64"),ye("convert base64 <b64>","base64 ‚Üí hex")].join("\n")):e.write([ve("convert"),`  ${ge("Convert between hex and base64 encodings.")}`,"",ye("convert hex <hex>","hex ‚Üí base64"),ye("convert base64 <b64>","base64 ‚Üí hex"),"",we("Example: convert hex 48656C6C6F")].join("\n"))}hexToBase64(e,t){if(t)if(/^[0-9a-fA-F]+$/.test(t))if(t.length%2==0)try{const r=new Uint8Array(t.length/2);for(let e=0;e<t.length;e+=2)r[e/2]=parseInt(t.substring(e,e+2),16);let a="";const s=8192;for(let e=0;e<r.length;e+=s)a+=String.fromCharCode.apply(null,Array.from(r.subarray(e,Math.min(e+s,r.length))));const n="function"==typeof globalThis.btoa?globalThis.btoa(a):Buffer.from(a,"binary").toString("base64");e.write(`  ${fe("hex",he(t))}\n  ${fe("base64",he(n))}`)}catch(r){e.write(`Error: Failed to convert - ${r instanceof Error?r.message:"unknown error"}`,"error")}else e.write("Error: Hex string must have even length","error");else e.write("Error: Input must be a hex string","error");else e.write("Usage: convert hex <hex-string>","error")}base64ToHex(e,t){if(t)try{const r="function"==typeof globalThis.atob?globalThis.atob(t):Buffer.from(t,"base64").toString("binary");let a="";for(let e=0;e<r.length;e++)a+=r.charCodeAt(e).toString(16).padStart(2,"0");e.write(`  ${fe("base64",he(t))}\n  ${fe("hex",he(a.toUpperCase()))}`)}catch(r){e.write(`Error: Invalid base64 string - ${r instanceof Error?r.message:"unknown error"}`,"error")}else e.write("Usage: convert base64 <base64-string>","error")}}function pt(){const e=new Date;return`${e.toISOString().slice(0,10)}_${e.toTimeString().slice(0,8).replace(/:/g,"-")}`}function mt(e,t){return`pymc-${e.toISOString().slice(0,10)}-${e.toTimeString().slice(0,5).replace(":","")}-${t}s.json`}const ht=L((e,t)=>({isCapturing:!1,captureStartTime:null,captureStartPacketHashes:new Set,captureTimer:null,reports:[],startCapture:r=>{const{captureTimer:a}=t();a&&clearTimeout(a),e({isCapturing:!0,captureStartTime:new Date,captureStartPacketHashes:new Set(r.map(e=>e.packet_hash))})},stopCapture:r=>{const{isCapturing:a,captureStartTime:s,captureStartPacketHashes:n,captureTimer:o}=t();if(!a||!s)return null;o&&clearTimeout(o);const i=new Date,c=Math.round((i.getTime()-s.getTime())/1e3),l=s.getTime()/1e3,d=r.filter(e=>!n.has(e.packet_hash)&&e.timestamp>=l).sort((e,t)=>e.timestamp-t.timestamp),u={id:pt(),filename:mt(s,c),startTime:s,endTime:i,durationSec:c,packetCount:d.length,packets:d,sizeBytes:500*d.length};return e(e=>({isCapturing:!1,captureStartTime:null,captureStartPacketHashes:new Set,captureTimer:null,reports:[u,...e.reports].slice(0,10)})),u},getReport:e=>t().reports.find(t=>t.id===e),_setTimer:t=>e({captureTimer:t})})),gt=()=>ht(e=>e.reports);function ft(e){var t;return(null==(t=e.match(/.{1,2}/g))?void 0:t.join(" ").toUpperCase())||""}function yt(e){return void 0===e?"UNKNOWN":b[e]??`TYPE_${e}`}function vt(e){return void 0===e?"UNKNOWN":w[e]??`ROUTE_${e}`}function wt(e,t){switch(e){case 4:return function(e){const t=[];let r=0;if(e.length>=32&&(t.push({name:"public_key",offset:r,length:32,bytes:ft(v(e.slice(r,r+32))),decoded:{value:v(e.slice(r,r+32))}}),r+=32),e.length>=r+4){const a=e.slice(r,r+4),s=a[0]|a[1]<<8|a[2]<<16|a[3]<<24;t.push({name:"timestamp",offset:r,length:4,bytes:ft(v(a)),decoded:{value:s>>>0,iso:new Date(1e3*s).toISOString()}}),r+=4}if(e.length>=r+64&&(t.push({name:"signature",offset:r,length:64,bytes:ft(v(e.slice(r,r+64))),decoded:{value:v(e.slice(r,r+64))}}),r+=64),e.length>r){const a=e[r],s=[];if(1&a&&s.push("CHAT_NODE"),2&a&&s.push("REPEATER"),3&a&&s.push("ROOM_SERVER"),16&a&&s.push("HAS_LOCATION"),128&a&&s.push("HAS_NAME"),t.push({name:"flags",offset:r,length:1,bytes:ft(v(e.slice(r,r+1))),decoded:{value:a,binary:a.toString(2).padStart(8,"0"),flags:s}}),r+=1,16&a&&e.length>=r+8){const a=e.slice(r,r+8),s=new ArrayBuffer(8);new Uint8Array(s).set(a);const n=new DataView(s),o=n.getInt32(0,!0),i=n.getInt32(4,!0);t.push({name:"location",offset:r,length:8,bytes:ft(v(a)),decoded:{lat_raw:o,lon_raw:i,latitude:o/1e6,longitude:i/1e6}}),r+=8}if(128&a&&e.length>r){const a=e.slice(r);let s=a.indexOf(0);-1===s&&(s=a.length);const n=(new TextDecoder).decode(a.slice(0,s));t.push({name:"name",offset:r,length:s+(0===a[s]?1:0),bytes:ft(v(a.slice(0,s+1))),decoded:{value:n,encoding:"utf-8",null_terminated:0===a[s]}})}}return t}(t);case 3:return function(e){if(e.length<4)return[];const t=e.slice(0,4),r=t[0]|t[1]<<8|t[2]<<16|t[3]<<24;return[{name:"crc",offset:0,length:4,bytes:ft(v(t)),decoded:{value:r>>>0,hex:(r>>>0).toString(16).toUpperCase().padStart(8,"0"),note:"CRC of the acknowledged packet (little-endian)"}}]}(t);case 9:return function(e){const t=[];if(e.length<9)return t;const r=e.slice(0,4),a=r[0]|r[1]<<8|r[2]<<16|r[3]<<24;t.push({name:"trace_tag",offset:0,length:4,bytes:ft(v(r)),decoded:{value:a>>>0,hex:(a>>>0).toString(16).toUpperCase().padStart(8,"0")}});const s=e.slice(4,8),n=s[0]|s[1]<<8|s[2]<<16|s[3]<<24;if(t.push({name:"auth_code",offset:4,length:4,bytes:ft(v(s)),decoded:{value:n>>>0}}),t.push({name:"flags",offset:8,length:1,bytes:ft(v(e.slice(8,9))),decoded:{value:e[8],binary:e[8].toString(2).padStart(8,"0")}}),e.length>9){const r=e.slice(9),a=Array.from(r).map(e=>e.toString(16).toUpperCase().padStart(2,"0"));t.push({name:"target_path",offset:9,length:r.length,bytes:ft(v(r)),decoded:{hops:a,path_string:a.join("->")}})}return t}(t);case 8:return function(e){if(0===e.length)return[];const t=Array.from(e).map(e=>e.toString(16).toUpperCase().padStart(2,"0"));return[{name:"path_hops",offset:0,length:e.length,bytes:ft(v(e)),decoded:{hops:t,path_string:t.join("->")}}]}(t);case 5:return function(e){const t=[];if(e.length<1)return t;if(t.push({name:"channel_hash",offset:0,length:1,bytes:ft(v(e.slice(0,1))),decoded:{value:e[0].toString(16).toUpperCase().padStart(2,"0")}}),e.length>13){const r=12,a=e.length-1-r;t.push({name:"ciphertext",offset:1,length:a,bytes:ft(v(e.slice(1,1+a))),decoded:{length:a,note:"Encrypted message content"}}),t.push({name:"mac",offset:1+a,length:r,bytes:ft(v(e.slice(-r))),decoded:{note:"Message authentication code"}})}return t}(t);default:return function(e){return 0===e.length?[]:[{name:"raw_data",offset:0,length:e.length,bytes:ft(v(e)),decoded:{length:e.length}}]}(t)}}function bt(e){const t=e.type??e.payload_type??0,r=e.route??e.route_type??0,a=e.raw_packet||"";let s,n=null;if(a){const t=F.fromHex(a);if(t.success&&t.packet){const e=t.packet;try{n=M(e)}catch{n=null}const r=y(a);let o=0;const i={offset:0,length:1,bytes:ft(a.slice(0,2)),decoded:{route_type:e.routeType,route_name:e.routeTypeName,payload_type:e.payloadType,payload_name:e.payloadTypeName,version:e.payloadVersion}};o+=1,e.hasTransportCodes()&&(o+=4);const c={offset:o,length:1,bytes:ft(v(r.slice(o,o+1))),decoded:{value:e.pathLen}};o+=1;const l=o,d=r.slice(o,o+e.pathLen),u=Array.from(e.path).map(e=>e.toString(16).toUpperCase().padStart(2,"0")),p=9===e.payloadType,m={offset:l,length:e.pathLen,bytes:ft(v(d)),decoded:{hops:u,path_string:u.length>0?u.join("->"):"(direct)",...p&&{note:"For TRACE packets, path bytes are SNR√ó4 values, not node hashes",snr_values:Array.from(e.path).map(e=>{let t=e;return t>127&&(t-=256),t/4})}}};o+=e.pathLen,s={header:i,path_length:c,path:m,payload:{offset:o,length:e.payload.length,bytes:ft(e.payloadHex),sections:wt(e.payloadType,e.payload)}}}else s=$t(e)}else s=$t(e);return{timestamp:e.timestamp,packet_hash:e.packet_hash,type:t,type_name:yt(t),route:r,route_name:vt(r),rssi:e.rssi,snr:e.snr,length:e.length??0,src_hash:e.src_hash,dst_hash:e.dst_hash,transmitted:e.transmitted,drop_reason:e.drop_reason,is_duplicate:e.is_duplicate,lbt_attempts:e.lbt_attempts,lbt_backoff_delays_ms:e.lbt_backoff_delays_ms,lbt_channel_busy:e.lbt_channel_busy,raw_packet:a,structure:s,decoded:n}}function $t(e){var t;const r=e.type??e.payload_type??0,a=e.route??e.route_type??0,s=e.original_path??e.forwarded_path??[];return{header:{offset:0,length:1,bytes:"??",decoded:{route_type:a,route_name:vt(a),payload_type:r,payload_name:yt(r),version:0}},path_length:{offset:1,length:1,bytes:s.length.toString(16).toUpperCase().padStart(2,"0"),decoded:{value:s.length}},path:{offset:2,length:s.length,bytes:s.join(" "),decoded:{hops:s,path_string:s.length>0?s.join("->"):"(direct)"}},payload:{offset:2+s.length,length:(null==(t=e.payload)?void 0:t.length)??0,bytes:e.payload??"",sections:e.payload?wt(r,y(e.payload)):[]}}}function xt(e,t){const r=function(e,t){var r;return{capture:{start:e.startTime.toISOString(),end:e.endTime.toISOString(),duration_sec:e.durationSec,packet_count:e.packetCount,node_name:(null==t?void 0:t.node_name)??"unknown",local_hash:(null==t?void 0:t.local_hash)??"unknown",pymc_console_version:f,pymc_repeater_version:(null==t?void 0:t.version)??"unknown",radio_config:(null==(r=null==t?void 0:t.config)?void 0:r.radio)?{frequency:t.config.radio.frequency,tx_power:t.config.radio.tx_power,bandwidth:t.config.radio.bandwidth,spreading_factor:t.config.radio.spreading_factor}:null},packets:e.packets.map(bt)}}(e,t),a=JSON.stringify(r,null,2),s=new Blob([a],{type:"application/json"}),n=URL.createObjectURL(s),o=document.createElement("a");o.href=n,o.download=e.filename,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(n)}function _t(e){return e<1024?`${e} B`:e<1048576?`${(e/1024).toFixed(1)} KB`:`${(e/1048576).toFixed(1)} MB`}class St extends J{constructor(){super(...arguments),t(this,"name","cap"),t(this,"description","Packet capture (start/end/list/export)")}matches(e){const t=e.toLowerCase().trim();return"cap"===t||"cap help"===t||t.startsWith("start cap")||t.startsWith("end cap")||t.startsWith("list cap")||t.startsWith("export cap")}async execute({output:e,rawInput:t}){const r=t.toLowerCase().trim();return"cap"===r||"cap help"===r?this.showHelp(e):r.startsWith("start cap")?this.startCapture(e,r):"end cap"===r?this.endCapture(e):"list cap"===r?this.listCaptures(e):r.startsWith("export cap")?this.exportCapture(e,r):void this.showHelp(e)}showHelp(e){const t=ht.getState(),r=t.isCapturing?`\n${$e('Recording in progress... use "end cap" to stop')}`:"",a=t.reports.length,s=a>0?` (${a} saved)`:"",n=[ve("Packet Capture"),"",ye("start cap","Start capture (default: 120s)"),ye("end cap","Stop capture early"),ye("list cap",`List saved captures${s}`),ye("export cap","Download capture by ID"),"",we("Captures stored in session memory. JSON includes decoded payloads."),r].filter(Boolean);e.write(n.join("\n"))}startCapture(e,t){const r=t.slice(9).trim(),a=r?parseInt(r):120;if(isNaN(a)||a<1||a>3600)return void e.write("Error: Duration must be 1-300 seconds","error");const s=ht.getState();if(s.isCapturing)return void e.write('Error: Capture already in progress. Use "end cap" first.',"error");const n=$.getState().packets;s.startCapture(n);let o=a;const i=e.write($e(`Capturing... ${o}s remaining`),"system"),c=setInterval(()=>{o--;const t=ht.getState();if(o>=0&&t.isCapturing){const r=$.getState().packets.filter(e=>{if(!t.captureStartTime)return!1;const r=t.captureStartTime.getTime()/1e3;return e.timestamp>=r&&!t.captureStartPacketHashes.has(e.packet_hash)}).length,a=o>0?`${o}s remaining`:"finishing...";e.update(i,$e(`Capturing... ${a} (${r} captured)`),"system")}},1e3),l=setTimeout(()=>{clearInterval(c);const t=ht.getState();if(t.isCapturing){const r=$.getState().packets,a=t.stopCapture(r);a?e.write(`‚úì Capture complete!\n  Captured: ${a.packetCount} packets\n  Duration: ${a.durationSec}s\n  Size: ~${_t(a.sizeBytes)}\n\nRun \`export cap ${a.id}\` to download.`,"success"):e.write("Capture completed with no packets.","warning")}},1e3*a);s._setTimer(l)}endCapture(e){const t=ht.getState();if(!t.isCapturing)return void e.write("No capture in progress.","warning");const r=$.getState().packets,a=t.stopCapture(r);a?e.write(`‚úì Capture stopped!\n  Captured: ${a.packetCount} packets\n  Duration: ${a.durationSec}s\n  Size: ~${_t(a.sizeBytes)}\n\nRun \`export cap ${a.id}\` to download.`,"success"):e.write("Capture stopped with no packets.","warning")}listCaptures(e){const{reports:t}=ht.getState();if(0===t.length)return void e.write("No capture reports available.\nStart a capture with: start cap [seconds]","info");const r=t.map((e,t)=>`  ${t+1}. ${e.packetCount} pkts ‚Ä¢ ${e.durationSec}s ‚Ä¢ ~${_t(e.sizeBytes)} (id: ${e.id})`);e.write(`Capture Reports (${t.length}):\n${r.join("\n")}`,"info")}exportCapture(e,t){const r=t.slice(10).trim(),a=ht.getState(),s=$.getState().stats;if(!r){if(0===a.reports.length)e.write("No capture reports available.\nStart a capture with: start cap [seconds]","info");else{const t=a.reports.map((e,t)=>`  ${t+1}. ${e.id}`);e.write(`Usage: export cap <id>\n\nAvailable reports:\n${t.join("\n")}`,"info")}return}let n=a.getReport(r);if(!n){const e=parseInt(r)-1;n=a.reports[e]}n?(xt(n,s),e.write(`‚úì Downloading ${n.filename}...`,"success")):e.write(`Error: Report "${r}" not found.\nUse "list cap" to see available reports.`,"error")}}class kt extends J{constructor(){super(...arguments),t(this,"name","identities"),t(this,"description","List configured identities"),t(this,"aliases",["id","ids"])}async execute({output:e,rawInput:t}){var r;if("help"===this.argsAfterName(t).toLowerCase().trim())return void e.write([ve("identities"),`  ${ge("List all configured repeater and room server identities.")}`,"",ye("identities","list identities"),"",ve("Aliases"),`  ${ge("id, ids")}`].join("\n"));const a=e.write("processing...","system");try{const t=await x();if(!t.success||!t.data)return void e.update(a,t.error||"Failed to fetch identities","error");const s=t.data,n=(null==(r=s.configured)?void 0:r.length)?s.configured:s.registered||[];if(0===n.length)return void e.update(a,"No identities configured.","warning");const o=[ve(`Identities (${n.length})`),"",...n.map((e,t)=>{var r;const a=e.name||"Unnamed",s=e.type||"unknown",n=(null==(r=e.hash)?void 0:r.slice(0,8))||"‚Äî";return`  ${ge(`${t+1}.`)} ${ue(a)}  ${pe(s)}  ${he(n)}`})];e.update(a,o.join("\n"))}catch(s){e.update(a,`Error: ${s instanceof Error?s.message:"Command failed"}`,"error")}}}class Ct extends J{constructor(){super(...arguments),t(this,"name","keys"),t(this,"description","List transport keys")}async execute({output:e,rawInput:t}){if("help"===this.argsAfterName(t).toLowerCase().trim())return void e.write([ve("keys"),`  ${ge("List configured transport encryption keys.")}`,"",ye("keys","list transport keys")].join("\n"));const r=e.write("processing...","system");try{const t=await G();if(!t.success||!t.data)return void e.update(r,t.error||"Failed to fetch transport keys","error");const a=t.data;if(0===a.length)return void e.update(r,"No transport keys configured.","warning");const s=[ve(`Transport Keys (${a.length})`),"",...a.map(e=>{const t=e.parent_id?`  ${pe(`parent: ${e.parent_id}`)}`:"";return`  ${ue(e.name)}  ${fe("flood",he(e.flood_policy))}${t}`})];e.update(r,s.join("\n"))}catch(a){e.update(r,`Error: ${a instanceof Error?a.message:"Command failed"}`,"error")}}}class Ot extends J{constructor(){super(...arguments),t(this,"name","acl"),t(this,"description","Show ACL statistics")}async execute({output:e,rawInput:t}){if("help"===this.argsAfterName(t).toLowerCase().trim())return void e.write([ve("acl"),`  ${ge("Display access control list statistics.")}`,"",ye("acl","show ACL stats")].join("\n"));const r=e.write("processing...","system");try{const t=await D();if(!t.success||!t.data)return void e.update(r,t.error||"Failed to fetch ACL stats","error");const a=t.data,s=[ve("ACL Stats"),"",`  ${fe("Identities",he(String(a.total_identities)))}`,`  ${fe("Total clients",he(String(a.total_clients)))}`,`  ${fe("Admin",he(String(a.admin_clients)))}`,`  ${fe("Guest",he(String(a.guest_clients)))}`];if(a.by_identity_type){const e=a.by_identity_type.repeater,t=a.by_identity_type.room_server;e&&s.push(`  ${fe("Repeater",`${he(String(e.count))} ids  ${ge(`${e.clients} clients`)}`)}`),t&&s.push(`  ${fe("Room Server",`${he(String(t.count))} ids  ${ge(`${t.clients} clients`)}`)}`)}e.update(r,s.join("\n"))}catch(a){e.update(r,`Error: ${a instanceof Error?a.message:"Command failed"}`,"error")}}}class Pt extends J{constructor(){super(...arguments),t(this,"name","rooms"),t(this,"description","Show room server statistics")}async execute({output:e,rawInput:t}){if("help"===this.argsAfterName(t).toLowerCase().trim())return void e.write([ve("rooms"),`  ${ge("Display room server statistics and sync status.")}`,"",ye("rooms","list rooms")].join("\n"));const r=e.write("processing...","system");try{const t=await _();if(!t.success||!t.data)return void e.update(r,t.error||"Failed to fetch room stats","error");const a=t.data.rooms||[];if(0===a.length)return void e.update(r,"No room servers configured.","warning");const s=[ve(`Rooms (${a.length})`),"",...a.map(e=>[`  ${ue(e.room_name)}`,`    ${fe("msgs",he(String(e.total_messages)))}  ${fe("clients",`${he(String(e.active_clients))}${pe(`/${e.total_clients}`)}`)}  ${fe("sync",e.sync_running?he("running"):pe("idle"))}`]).flat()];e.update(r,s.join("\n"))}catch(a){e.update(r,`Error: ${a instanceof Error?a.message:"Command failed"}`,"error")}}}class jt extends J{constructor(){super(...arguments),t(this,"name","restart"),t(this,"description","Restart pymc-repeater service"),t(this,"aliases",["reboot"])}async execute({output:e,rawInput:t}){if("help"===this.argsAfterName(t).toLowerCase().trim())return void e.write([ve("restart"),`  ${ge("Restart the pymc-repeater systemd service.")}`,"",ye("restart","restart the service"),"",ve("Aliases"),`  ${ge("reboot")}`,"",we("Requires polkit permissions for the web user."),we("The page will need a manual refresh after restart.")].join("\n"));const r=e.write("Restarting service...","system");try{const t=await B(AbortSignal.timeout(8e3));if(t.success)return e.update(r,"Service restart initiated.","success"),void this.waitForService(e);const a=t.status;if(403===a||401===a)return void e.update(r,"Error: Permission denied.\n\nThe web user needs polkit permissions to restart the service.\nSee: /etc/polkit-1/localauthority/50-local.d/pymc-repeater.pkla","error");e.update(r,t.error||"Restart failed","error")}catch(a){const t=a instanceof Error?a.message:"";t.includes("ERR_NETWORK")||t.includes("ECONNRESET")||t.includes("Failed to fetch")||t.includes("abort")||t.includes("timeout")||a instanceof DOMException&&"TimeoutError"===a.name||a instanceof DOMException&&"AbortError"===a.name?(e.update(r,"Service is restarting (connection dropped).","success"),this.waitForService(e)):e.update(r,`Error: ${t||"Restart failed"}`,"error")}}waitForService(e){const t=e.write("Waiting for service...","system");let r=0,a=!1;setTimeout(()=>{const s=setInterval(async()=>{if(!a){r++,e.update(t,`Waiting for service... ${r}s`,"system");try{await fetch(`${S}/api/stats`,{signal:AbortSignal.timeout(3e3)}),a=!0,clearInterval(s),e.update(t,`Service connected. (${r+4}s)`,"success")}catch{}!a&&r>=30&&(a=!0,clearInterval(s),e.update(t,"Service did not respond within 34s. Check manually.","warning"))}},1e3)},4e3)}}const Nt=L(e=>({entries:[],commandHistory:[],isInitialized:!1,addEntry:t=>{const r="undefined"!=typeof crypto&&crypto.randomUUID?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}),a={...t,id:r,timestamp:Date.now()};return e(e=>({entries:[...e.entries,a]})),r},updateEntry:(t,r)=>{e(e=>({entries:e.entries.map(e=>e.id===t?{...e,...r}:e)}))},addCommand:t=>{e(e=>({commandHistory:[...e.commandHistory,t]}))},clearEntries:()=>{e({entries:[],commandHistory:[]})},setInitialized:t=>{e({isInitialized:t})}}));function Tt({isOpen:e,onClose:t}){const a=gt(),s=$(e=>e.stats);return r.jsxs(k,{open:e,onClose:t,size:"lg",children:[r.jsx(C,{icon:r.jsx(A,{size:20}),title:"Download Captures",onClose:t}),r.jsx(O,{children:r.jsx("div",{className:"flex flex-col gap-3",children:0===a.length?r.jsx("p",{className:"text-text-secondary",children:"No captures available."}):a.map(e=>r.jsxs("div",{className:"flex items-center justify-between p-2 rounded-md bg-bg-surface-elevated",children:[r.jsxs("div",{children:[r.jsx("p",{className:"font-semibold",children:e.filename}),r.jsxs("p",{className:"text-sm text-text-secondary",children:[e.packetCount," packets ‚Ä¢ ",e.durationSec,"s ‚Ä¢ ~",_t(e.sizeBytes)]})]}),r.jsx("button",{onClick:()=>(e=>{const t=a.find(t=>t.id===e);t&&xt(t,s)})(e.id),className:"p-2 text-text-secondary hover:text-text-primary hover:bg-bg-subtle rounded-md transition-colors",title:"Download",children:r.jsx(A,{size:18})})]},e.id))})})]})}function Et(){const e=gt(),t=e.length>0,[s,n]=a.useState(!1);return t?r.jsxs(r.Fragment,{children:[r.jsx(H,{icon:r.jsx(z,{size:20}),onClick:()=>n(!0),title:`Download captures (${e.length})`,iconActiveColor:"#E5484D",keycapSrc:"/assets/keycap-red.svg"}),r.jsx(Tt,{isOpen:s,onClose:()=>n(!1)})]}):null}const Rt=function(){const e=new V,t=new Ee(e);return e.register(t,new Re,new Ie,new Le,new Fe,new Be,new De,new Qe,new dt,new Ze,new et,new ut,new St,new kt,new Ct,new Ot,new Pt,new jt),e}(),At=new Set(["start ota","erase","reboot"]),It=["gps","sensor"],Lt=Rt.all().flatMap(e=>[{cmd:e.name,desc:e.description,params:e.params,required:!!e.params},...e.aliases.filter(e=>e.includes(" ")).map(t=>({cmd:t,desc:e.description,params:e.params,required:!!e.params}))]),Ft=new Set(Lt.map(e=>e.cmd)),Mt=[...Lt,...[{name:"get adc.multiplier",category:"get",params:[],description:"Get ADC multiplier for battery",serialOnly:!1,hasParam:!1},{name:"get advert.interval",category:"get",params:[],description:"Get local advert interval (minutes)",serialOnly:!1,hasParam:!1},{name:"get af",category:"get",params:[],description:"Get airtime factor",serialOnly:!1,hasParam:!1},{name:"get agc.reset.interval",category:"get",params:[],description:"Get AGC reset interval (seconds)",serialOnly:!1,hasParam:!1},{name:"get allow.read.only",category:"get",params:[],description:"Get read-only access setting",serialOnly:!1,hasParam:!1},{name:"get bridge.baud",category:"get",params:[],description:"Get bridge baud rate",serialOnly:!1,hasParam:!1},{name:"get bridge.channel",category:"get",params:[],description:"Get bridge channel (ESP-NOW)",serialOnly:!1,hasParam:!1},{name:"get bridge.delay",category:"get",params:[],description:"Get bridge delay (ms)",serialOnly:!1,hasParam:!1},{name:"get bridge.enabled",category:"get",params:[],description:"Get bridge enabled status",serialOnly:!1,hasParam:!1},{name:"get bridge.secret",category:"get",params:[],description:"Get bridge encryption secret",serialOnly:!1,hasParam:!1},{name:"get bridge.source",category:"get",params:[],description:"Get bridge packet source",serialOnly:!1,hasParam:!1},{name:"get bridge.type",category:"get",params:[],description:"Get bridge type (rs232/espnow/none)",serialOnly:!1,hasParam:!1},{name:"get direct.txdelay",category:"get",params:[],description:"Get direct TX delay factor",serialOnly:!1,hasParam:!1},{name:"get flood.advert.interval",category:"get",params:[],description:"Get flood advert interval (hours)",serialOnly:!1,hasParam:!1},{name:"get flood.max",category:"get",params:[],description:"Get max flood hops",serialOnly:!1,hasParam:!1},{name:"get freq",category:"get",params:[],description:"Get frequency (MHz)",serialOnly:!1,hasParam:!1},{name:"get guest.password",category:"get",params:[],description:"Get guest password",serialOnly:!1,hasParam:!1},{name:"get int.thresh",category:"get",params:[],description:"Get interference threshold",serialOnly:!1,hasParam:!1},{name:"get lat",category:"get",params:[],description:"Get latitude",serialOnly:!1,hasParam:!1},{name:"get lon",category:"get",params:[],description:"Get longitude",serialOnly:!1,hasParam:!1},{name:"get multi.acks",category:"get",params:[],description:"Get multi-ack setting",serialOnly:!1,hasParam:!1},{name:"get name",category:"get",params:[],description:"Get node name",serialOnly:!1,hasParam:!1},{name:"get prv.key",category:"get",params:[],description:"Get private key (hex)",serialOnly:!1,hasParam:!1},{name:"get public.key",category:"get",params:[],description:"Get public key (hex)",serialOnly:!1,hasParam:!1},{name:"get radio",category:"get",params:[],description:"Get radio params (freq,bw,sf,cr)",serialOnly:!1,hasParam:!1},{name:"get repeat",category:"get",params:[],description:"Get repeat/forward status (on/off)",serialOnly:!1,hasParam:!1},{name:"get role",category:"get",params:[],description:"Get device role",serialOnly:!1,hasParam:!1},{name:"get rxdelay",category:"get",params:[],description:"Get RX delay base",serialOnly:!1,hasParam:!1},{name:"get tx",category:"get",params:[],description:"Get TX power (dBm)",serialOnly:!1,hasParam:!1},{name:"get txdelay",category:"get",params:[],description:"Get TX delay factor",serialOnly:!1,hasParam:!1},{name:"gps",category:"gps",params:[],description:"Show GPS status",serialOnly:!1,hasParam:!1},{name:"gps advert",category:"gps",params:[],description:"Get/set GPS advert location policy",serialOnly:!1,hasParam:!0},{name:"gps off",category:"gps",params:[],description:"Disable GPS",serialOnly:!1,hasParam:!0},{name:"gps on",category:"gps",params:[],description:"Enable GPS",serialOnly:!1,hasParam:!0},{name:"gps setloc",category:"gps",params:[],description:"Set node location from GPS",serialOnly:!1,hasParam:!0},{name:"gps sync",category:"gps",params:[],description:"Sync time from GPS",serialOnly:!1,hasParam:!0},{name:"log",category:"logging",params:[],description:"Dump log file (serial only)",serialOnly:!0,hasParam:!1},{name:"log erase",category:"logging",params:[],description:"Erase log file",serialOnly:!1,hasParam:!0},{name:"log start",category:"logging",params:[],description:"Start packet logging",serialOnly:!1,hasParam:!0},{name:"log stop",category:"logging",params:[],description:"Stop packet logging",serialOnly:!1,hasParam:!0},{name:"neighbor.remove",category:"neighbor",params:[],description:"Remove neighbor by pubkey",serialOnly:!1,hasParam:!0},{name:"neighbors",category:"neighbor",params:[],description:"List neighbors",serialOnly:!1,hasParam:!1},{name:"get",category:"other",params:[],description:"Execute get command",serialOnly:!1,hasParam:!0},{name:"set",category:"other",params:[{name:"value",type:"float"},{name:"value",type:"int"},{name:"value",type:"int"}],description:"Execute set command",serialOnly:!1,hasParam:!0},{name:"tempradio",category:"radio",params:[{name:"value",type:"int"},{name:"value",type:"int"},{name:"value",type:"int"}],description:"Apply temporary radio params (freq bw sf cr timeout_mins)",serialOnly:!1,hasParam:!0},{name:"sensor get",category:"sensor",params:[],description:"Get sensor/custom variable value",serialOnly:!1,hasParam:!0},{name:"sensor list",category:"sensor",params:[{name:"value",type:"int"}],description:"List all sensor/custom variables",serialOnly:!1,hasParam:!0},{name:"sensor set",category:"sensor",params:[],description:"Set sensor/custom variable value",serialOnly:!1,hasParam:!0},{name:"set adc.multiplier",category:"set",params:[{name:"value",type:"float"}],description:"Set ADC multiplier",serialOnly:!1,hasParam:!0},{name:"set advert.interval",category:"set",params:[{name:"value",type:"int"},{name:"value",type:"string"}],description:"Set local advert interval (1-10080 min, 0=off)",serialOnly:!1,hasParam:!0},{name:"set af",category:"set",params:[{name:"value",type:"float"},{name:"value",type:"int"},{name:"value",type:"int"},{name:"value",type:"int"}],description:"Set airtime factor (0-9)",serialOnly:!1,hasParam:!0},{name:"set agc.reset.interval",category:"set",params:[{name:"value",type:"int"},{name:"value",type:"int"},{name:"value",type:"int"}],description:"Set AGC reset interval (seconds, rounded to 4)",serialOnly:!1,hasParam:!0},{name:"set allow.read.only",category:"set",params:[{name:"value",type:"int"}],description:"Set read-only access (on/off)",serialOnly:!1,hasParam:!0},{name:"set bridge.baud",category:"set",params:[{name:"value",type:"int"},{name:"value",type:"int"}],description:"Set bridge baud (9600-115200)",serialOnly:!1,hasParam:!0},{name:"set bridge.channel",category:"set",params:[{name:"value",type:"int"},{name:"value",type:"string"}],description:"Set bridge channel (1-14)",serialOnly:!1,hasParam:!0},{name:"set bridge.delay",category:"set",params:[{name:"value",type:"int"}],description:"Set bridge delay (0-10000 ms)",serialOnly:!1,hasParam:!0},{name:"set bridge.enabled",category:"set",params:[{name:"value",type:"int"}],description:"Enable/disable bridge",serialOnly:!1,hasParam:!0},{name:"set bridge.secret",category:"set",params:[{name:"value",type:"string"},{name:"value",type:"float"}],description:"Set bridge encryption secret",serialOnly:!1,hasParam:!0},{name:"set bridge.source",category:"set",params:[{name:"value",type:"int"}],description:"Set bridge source (rx/tx)",serialOnly:!1,hasParam:!0},{name:"set direct.txdelay",category:"set",params:[{name:"value",type:"float"},{name:"value",type:"int"}],description:"Set direct TX delay factor",serialOnly:!1,hasParam:!0},{name:"set flood.advert.interval",category:"set",params:[{name:"value",type:"int"},{name:"value",type:"int"}],description:"Set flood advert interval (3-48 hours, 0=off)",serialOnly:!1,hasParam:!0},{name:"set flood.max",category:"set",params:[{name:"value",type:"int"},{name:"value",type:"float"}],description:"Set max flood hops (0-64)",serialOnly:!1,hasParam:!0},{name:"set freq",category:"set",params:[{name:"value",type:"float"},{name:"value",type:"int"}],description:"Set frequency MHz (serial only, reboot required)",serialOnly:!0,hasParam:!0},{name:"set guest.password",category:"set",params:[{name:"value",type:"string"}],description:"Set guest password",serialOnly:!1,hasParam:!0},{name:"set int.thresh",category:"set",params:[{name:"value",type:"int"},{name:"value",type:"int"},{name:"value",type:"int"}],description:"Set interference threshold",serialOnly:!1,hasParam:!0},{name:"set lat",category:"set",params:[{name:"value",type:"float"},{name:"value",type:"float"},{name:"value",type:"float"}],description:"Set latitude",serialOnly:!1,hasParam:!0},{name:"set lon",category:"set",params:[{name:"value",type:"float"},{name:"value",type:"float"},{name:"value",type:"float"}],description:"Set longitude",serialOnly:!1,hasParam:!0},{name:"set multi.acks",category:"set",params:[{name:"value",type:"int"},{name:"value",type:"int"}],description:"Set multi-ack (0/1)",serialOnly:!1,hasParam:!0},{name:"set name",category:"set",params:[{name:"value",type:"string"},{name:"value",type:"int"}],description:"Set node name",serialOnly:!1,hasParam:!0},{name:"set prv.key",category:"set",params:[{name:"value",type:"string"}],description:"Set private key (hex, restart required)",serialOnly:!1,hasParam:!0},{name:"set radio",category:"set",params:[{name:"value",type:"int"},{name:"value",type:"int"}],description:"Set radio params (freq bw sf cr)",serialOnly:!1,hasParam:!0},{name:"set repeat",category:"set",params:[{name:"value",type:"int"},{name:"value",type:"int"}],description:"Set repeat/forward (on/off)",serialOnly:!1,hasParam:!0},{name:"set rxdelay",category:"set",params:[{name:"value",type:"float"},{name:"value",type:"float"}],description:"Set RX delay base",serialOnly:!1,hasParam:!0},{name:"set tx",category:"set",params:[{name:"value",type:"int"},{name:"value",type:"float"}],description:"Set TX power (dBm)",serialOnly:!1,hasParam:!0},{name:"set txdelay",category:"set",params:[{name:"value",type:"float"},{name:"value",type:"int"}],description:"Set TX delay factor",serialOnly:!1,hasParam:!0},{name:"stats-core",category:"stats",params:[],description:"Show core statistics (serial only)",serialOnly:!0,hasParam:!1},{name:"stats-packets",category:"stats",params:[],description:"Show packet statistics (serial only)",serialOnly:!0,hasParam:!1},{name:"stats-radio",category:"stats",params:[],description:"Show radio statistics (serial only)",serialOnly:!0,hasParam:!1},{name:"advert",category:"system",params:[],description:"Send self advertisement",serialOnly:!1,hasParam:!1},{name:"board",category:"system",params:[],description:"Show board/manufacturer name",serialOnly:!1,hasParam:!1},{name:"clear stats",category:"system",params:[],description:"Reset statistics counters",serialOnly:!1,hasParam:!0},{name:"clock",category:"system",params:[{name:"value",type:"int"}],description:"Display current time",serialOnly:!1,hasParam:!0},{name:"clock sync",category:"system",params:[],description:"Sync clock from sender timestamp",serialOnly:!1,hasParam:!0},{name:"password",category:"system",params:[{name:"value",type:"string"}],description:"Change admin password",serialOnly:!1,hasParam:!0},{name:"reboot",category:"system",params:[],description:"Reboot the device",serialOnly:!1,hasParam:!1},{name:"start ota",category:"system",params:[{name:"value",type:"int"}],description:"Start OTA firmware update",serialOnly:!1,hasParam:!0},{name:"time",category:"system",params:[{name:"value",type:"int"}],description:"Set time to epoch seconds",serialOnly:!1,hasParam:!0},{name:"ver",category:"system",params:[],description:"Show firmware version and build date",serialOnly:!1,hasParam:!1}].filter(e=>!(e.serialOnly||At.has(e.name)||It.some(t=>e.name.startsWith(t))||Ft.has(e.name))).map(e=>({cmd:e.name,desc:e.description,params:e.hasParam?"{value}":void 0,required:e.hasParam}))],Gt={"set mode":["forward","monitor"],"set duty":["on","off"],"set repeat":["on","off"],"set tx":["10","14","17","20","22"],"set sf":["7","8","9","10","11","12"],"set bw":["125","250","500"],"set af":["0.5","1.0","1.5","2.0"],"set txdelay":["0.5","0.7","1.0","1.5"],"set direct.txdelay":["0.3","0.5","0.7"],"set log":["debug","info","warning"],"start cap":["30","60","120","300"]};function Bt(){return/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)||window.innerWidth<640}function Dt(){const e=P(),{addCommand:t}=Nt(),l=a.useRef(null),d=a.useRef(null),u=a.useRef(null),p=a.useRef(null),m=a.useRef(""),h=a.useRef(-1),g=a.useRef(""),f=a.useRef(!1),y=a.useRef(!1),v=a.useRef([]),w=a.useRef(()=>{}),b=j(),[$,x]=a.useState({show:!1,options:[],selectedIndex:0,input:""}),_=a.useRef([]),S=a.useRef(0);a.useEffect(()=>{(null==e?void 0:e.neighbors)&&(v.current=Object.values(e.neighbors).map(e=>e.node_name||e.name).filter(e=>!!e).sort())},[null==e?void 0:e.neighbors]);const k=a.useCallback(()=>{var e;null==(e=d.current)||e.write(be)},[]),C=a.useCallback(()=>{const e=d.current;e&&(e.write(Oe),k(),e.write(m.current))},[k]),O=a.useCallback(e=>{const t=function(e,t){const r=e.trim().toLowerCase();if(!r)return[];const a=Mt.filter(e=>e.cmd.toLowerCase().startsWith(r));if(a.length>0)return a;if(r.includes(" ")){const e=r.lastIndexOf(" "),a=r.substring(0,e),s=r.substring(e+1);if("ping"===a&&t.length>0)return t.filter(e=>e.toLowerCase().startsWith(s)).slice(0,10).map(e=>({cmd:`ping ${e}`,desc:`‚Üí ${e}`}));const n=Mt.find(e=>e.cmd.toLowerCase()===a);if(n&&Gt[n.cmd])return Gt[n.cmd].filter(e=>e.toLowerCase().startsWith(s)).map(e=>({cmd:`${n.cmd} ${e}`,desc:`‚Üí ${e}`}))}return[]}(e,v.current);_.current=t,S.current=0;const r=t.length>0&&e.trim().length>0;x({show:r,options:t,selectedIndex:0,input:e.trim()})},[]),T=a.useCallback(()=>{_.current=[],S.current=0,x({show:!1,options:[],selectedIndex:0,input:""})},[]),E=a.useCallback(e=>{var t;const r=_.current[e];r&&(m.current=r.required?r.cmd+" ":r.cmd,C(),r.required?O(m.current):T(),null==(t=d.current)||t.focus())},[C,O,T]),R=a.useCallback(async e=>{const r=d.current;if(!r)return;const a=e.trim();if(!a)return void k();f.current=!0,t(a),h.current=-1;let s=0;const n={write(e,t="default"){const a=("default"===t?e:de(e,t)).split("\n");for(const s of a)r.writeln(s);return s=a.length,String(s)},update(e,t,a){if(s>0)for(let o=0;o<s;o++)r.write(Pe()),r.write(Oe);const n=(a?de(t,a):t).split("\n");for(const s of n)r.writeln(s);s=n.length},clear(){r.clear(),s=0}},o=Rt.find(a);if(o){const e=a.split(/\s+/);try{await o.execute({output:n,args:e,rawInput:a,cols:r.cols})}catch(i){n.write(`Error: ${i instanceof Error?i.message:"Command failed"}`,"error")}}else n.write(`Unknown command: ${a}\nType 'help' for available commands.`,"error");f.current=!1,k()},[t,k]),A=a.useCallback(e=>{const t=d.current;if(!t||f.current)return;const r=Nt.getState().commandHistory,a=e=>requestAnimationFrame(()=>{var t;return null==(t=document.querySelector(`[data-ac-index="${e}"]`))?void 0:t.scrollIntoView({block:"nearest"})});for(let s=0;s<e.length;s++){const n=e.charCodeAt(s);if(13===n){if(_.current.length>0){const e=_.current[S.current];e&&(m.current=e.cmd,C())}T();const e=m.current;m.current="",t.writeln(""),R(e);continue}if(127!==n&&8!==n)if(3!==n)if(12!==n)if(9!==n)if(27!==n)n>=32&&(m.current+=e[s],t.write(e[s]),h.current=-1,O(m.current));else{if(91===e.charCodeAt(s+1)){const t=e.charCodeAt(s+2);if(s+=2,65===t){if(_.current.length>0){const e=Math.max(S.current-1,0);S.current=e,x(t=>({...t,selectedIndex:e})),a(e)}else r.length>0&&(-1===h.current&&(g.current=m.current),h.current<r.length-1&&(h.current++,m.current=r[r.length-1-h.current]||"",C()));continue}if(66===t){if(_.current.length>0){const e=Math.min(S.current+1,_.current.length-1);S.current=e,x(t=>({...t,selectedIndex:e})),a(e)}else h.current>0?(h.current--,m.current=r[r.length-1-h.current]||"",C()):0===h.current&&(h.current=-1,m.current=g.current,C());continue}if(67===t||68===t)continue;continue}_.current.length>0&&T()}else _.current.length>0&&E(S.current);else t.clear(),T(),C();else m.current="",T(),t.writeln("^C"),k();else m.current.length>0&&(m.current=m.current.slice(0,-1),t.write("\b \b"),O(m.current))}},[T,O,E,k,C,R]);a.useEffect(()=>{w.current=A},[A]);const I=a.useCallback(async()=>{const e=d.current;if(!e||y.current)return;y.current=!0;const t="‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  ‚ñà‚ñà    ‚ñà‚ñà ‚ñà‚ñà‚ñà    ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà\n‚ñà‚ñà   ‚ñà‚ñà  ‚ñà‚ñà  ‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà ‚ñà‚ñà     \n‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà    ‚ñà‚ñà‚ñà‚ñà   ‚ñà‚ñà ‚ñà‚ñà‚ñà‚ñà ‚ñà‚ñà ‚ñà‚ñà     \n‚ñà‚ñà         ‚ñà‚ñà    ‚ñà‚ñà  ‚ñà‚ñà  ‚ñà‚ñà ‚ñà‚ñà     \n‚ñà‚ñà         ‚ñà‚ñà    ‚ñà‚ñà      ‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà".split("\n");for(const r of t)e.writeln(he(r));e.writeln(""),e.write(ge("‚óè Initializing terminal...")),await new Promise(e=>setTimeout(e,300)),e.write(Oe),e.writeln(me("‚úì Initializing terminal...")),e.write(ge("‚óè Connecting to repeater...")),await new Promise(e=>setTimeout(e,500)),e.write(Oe),e.writeln(me("‚úì Connected to repeater")),e.writeln(ge("Ready. Type 'help' for commands.")),e.writeln(""),k()},[k]);a.useEffect(()=>{const e=l.current;if(!e)return;const t=new n({theme:Ne(),fontFamily:'"JetBrains Mono", "IBM Plex Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace',fontSize:13,lineHeight:1.4,cursorBlink:!1,cursorStyle:"underline",scrollback:1e4,convertEol:!0,allowTransparency:!0,rightClickSelectsWord:!1}),r=new o;t.loadAddon(r),t.loadAddon(new i),t.open(e),r.fit(),d.current=t,u.current=r;const a=t.onData(e=>w.current(e)),s=function(e){return c.subscribe(()=>{e.options.theme=Ne()})}(t),p=new ResizeObserver(()=>{requestAnimationFrame(()=>r.fit())});return p.observe(e),I(),Bt()||t.focus(),()=>{a.dispose(),s(),p.disconnect(),t.dispose(),d.current=null,u.current=null}},[]);const L=a.useCallback(e=>{const t=e.target.value;t.length>0&&(A(t),e.target.value="")},[A]),F=a.useCallback(e=>{"Enter"===e.key?(e.preventDefault(),A("\r")):"Backspace"===e.key?(e.preventDefault(),A("")):"ArrowUp"===e.key?(e.preventDefault(),A("[A")):"ArrowDown"===e.key&&(e.preventDefault(),A("[B"))},[A]),M=a.useCallback(()=>{var e,t;Bt()?null==(e=p.current)||e.focus():null==(t=d.current)||t.focus()},[]);return r.jsxs(q,{children:[r.jsx(X,{title:"Terminal",icon:r.jsx(N,{})}),r.jsx(W,{children:r.jsxs("div",{className:"terminal-card flex flex-col gap-1.5",children:[r.jsxs("div",{className:"card-terminal-header flex-wrap",children:[r.jsx("span",{className:"seven-seg-panel",children:r.jsx(U,{text:"5hell",minChars:7,size:24})}),r.jsx("div",{className:"keycap-well self-stretch flex flex-col",children:r.jsxs("div",{className:"indicator-key"+("connected"===b?" indicator-key--active":"degraded"===b?" indicator-key--sending":""),children:[r.jsx("span",{className:"indicator-key__label",children:"ONLINE"}),r.jsx("span",{className:"indicator-key__led"})]})}),r.jsx("div",{className:"card-terminal-ridge flex-1 min-w-8 hidden sm:block"}),r.jsx("div",{className:"keycap-well keycap-well--rounded flex items-center gap-1",children:r.jsx(Et,{})})]}),r.jsx(K,{noPadding:!0,className:"flex flex-col flex-1 min-h-0 overflow-hidden card-terminal",onClick:M,children:r.jsxs("div",{className:"card-terminal-well flex-1 min-h-0 flex flex-col overflow-hidden",children:[r.jsx("div",{className:"flex-1 min-h-0 terminal-gutter",children:r.jsx("div",{ref:l,className:"h-full w-full"})}),$.show&&$.options.length>0&&r.jsxs("div",{className:"flex-shrink-0 overflow-hidden terminal-completions",style:{borderTop:"1px solid rgba(255,255,255,0.06)",background:"rgba(255,255,255,0.02)"},children:[r.jsx("div",{className:"overflow-y-auto",style:{maxHeight:"176px"},children:$.options.map((e,t)=>{const a=t===$.selectedIndex,n=$.input.length;return r.jsxs("div",{"data-ac-index":t,onClick:()=>E(t),className:s("flex items-baseline gap-2 px-3 py-0.5 cursor-pointer transition-colors",a?"text-accent-primary":"text-text-primary"),style:{background:a?"var(--terminal-autocomplete-hover)":void 0},onMouseEnter:e=>{a||(e.currentTarget.style.background="var(--terminal-autocomplete-hover)")},onMouseLeave:e=>{a||(e.currentTarget.style.background="")},children:[r.jsx("span",{className:"w-3 shrink-0 text-center text-accent-primary opacity-80",children:a?"‚ñ∏":""}),r.jsxs("span",{className:"min-w-0 truncate flex-1",children:[r.jsx("span",{className:"font-semibold text-accent-primary",children:e.cmd.substring(0,n)}),e.cmd.substring(n)]}),r.jsx("span",{className:"shrink-0 text-[11px] text-text-muted pl-3",children:e.desc})]},e.cmd)})}),r.jsxs("div",{className:"flex justify-between items-center px-3 py-0.5 text-[10px] text-text-muted",style:{borderTop:"1px solid rgba(255,255,255,0.04)"},children:[r.jsx("span",{children:"Tab ¬∑ ‚Üë‚Üì ¬∑ Esc"}),r.jsxs("span",{children:[$.options.length," match",1!==$.options.length?"es":""]})]})]}),r.jsx("input",{ref:p,type:"text",className:"sr-only",onChange:L,onKeyDown:F,autoComplete:"off",autoCorrect:"off",autoCapitalize:"off",spellCheck:!1,"aria-label":"Terminal input"}),r.jsxs("div",{className:"px-3 sm:px-4 py-1 flex justify-between text-[10px] text-text-muted",style:{borderTop:"1px solid rgba(255,255,255,0.04)"},children:[r.jsx("span",{className:"hidden sm:inline",children:"‚Üë‚Üì History ¬∑ Tab ¬∑ Esc"}),r.jsx("span",{className:"sm:hidden",children:"Terminal"}),(null==e?void 0:e.version)&&r.jsxs("span",{children:["pyMC v",e.version]})]})]})})]})})]})}export{Dt as default};
