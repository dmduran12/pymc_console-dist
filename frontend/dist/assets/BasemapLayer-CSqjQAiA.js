import{a as t}from"./vendor-core-FtpmsTnh.js";import{r as e}from"./vendor-react-alRNW2nb.js";import{u as r}from"./maplibre-gl-BwLPRSIs.js";const a="pymc-basemap-mode",o="dark";function s(){if("undefined"==typeof window)return o;try{const t=localStorage.getItem(a);if("light"===t||"dark"===t)return t}catch{}return o}function n(t){if("undefined"!=typeof window)try{localStorage.setItem(a,t)}catch{}}const i=t(t=>({mode:s(),toggle:()=>t(t=>{const e="light"===t.mode?"dark":"light";return n(e),{mode:e}}),setMode:e=>{n(e),t({mode:e})}})),c=()=>i(t=>t.mode),l=()=>i(t=>t.toggle),d={light:"https://basemaps.cartocdn.com/gl/positron-gl-style/style.json",dark:"https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json"},u={light:"basemap-light-",dark:"basemap-dark-"},f={};function g({mode:t}){const{current:a}=r(),[o,s]=e.useState(null),n=e.useRef({light:!1,dark:!1}),i=e.useRef({light:[],dark:[]});e.useEffect(()=>{const t=()=>{var t;const e=null==(t=null==a?void 0:a.getMap)?void 0:t.call(a);e&&!o&&s(e)};t();const e=setInterval(t,50),r=setTimeout(()=>clearInterval(e),5e3);return()=>{clearInterval(e),clearTimeout(r)}},[a,o]);const c=e.useCallback(async(t,e,r)=>{var a,o;if(n.current[e])return;const s=u[e],c=await async function(t){if(f[t])return f[t];const e=await fetch(d[t]),r=await e.json();return f[t]=r,r}(e),l=[];for(const[n,i]of Object.entries(c.sources||{})){const e=s+n;t.getSource(e)||t.addSource(e,i)}const g=null==(o=((null==(a=t.getStyle())?void 0:a.layers)||[]).find(t=>!t.id.startsWith("basemap-light-")&&!t.id.startsWith("basemap-dark-")))?void 0:o.id;for(const n of c.layers||[]){const e=s+n.id;if(l.push(e),t.getLayer(e))continue;const a={...n,id:e};"source"in a&&"string"==typeof a.source&&(a.source=s+a.source),a.layout||(a.layout={}),a.layout.visibility=r?"visible":"none";try{t.addLayer(a,g)}catch(y){console.warn(`[BasemapLayer] Failed to add layer ${e}:`,y)}}i.current[e]=l,n.current[e]=!0},[]),l=e.useCallback((t,e,r)=>{const a=i.current[e],o=r?"visible":"none";for(const s of a)if(t.getLayer(s))try{t.setLayoutProperty(s,"visibility",o)}catch{}},[]),g=e.useCallback(t=>{var e;const r=((null==(e=t.getStyle())?void 0:e.layers)||[]).filter(t=>!t.id.startsWith("basemap-light-")&&!t.id.startsWith("basemap-dark-"));for(const a of r)try{t.moveLayer(a.id)}catch{}},[]);return e.useEffect(()=>{if(!o)return;const t=t=>{o.hasImage(t.id)||o.addImage(t.id,{width:1,height:1,data:new Uint8Array([0,0,0,0])})};return o.on("styleimagemissing",t),()=>{o.off("styleimagemissing",t)}},[o]),e.useEffect(()=>{if(!o)return;let e=!1;const r=async()=>{if(!e)try{await Promise.all([c(o,"light","light"===t),c(o,"dark","dark"===t)]),e||g(o)}catch(r){console.error("[BasemapLayer] Setup error:",r)}};o.isStyleLoaded()?r():(o.once("style.load",r),o.once("load",()=>{e||n.current.light||r()}));const a=()=>{e||setTimeout(()=>{!e&&n.current.light&&n.current.dark&&g(o)},100)};return o.on("styledata",a),()=>{e=!0,o.off("styledata",a)}},[o,c,g,t]),e.useEffect(()=>{o&&n.current.light&&n.current.dark&&(l(o,"light","light"===t),l(o,"dark","dark"===t))},[o,t,l]),null}export{g as B,l as a,c as u};
