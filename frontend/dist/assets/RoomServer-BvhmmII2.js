import{j as e,W as s,Z as t,M as a,r as n}from"./vendor-react-alRNW2nb.js";import{C as l,P as i,a as r,B as o}from"./PageLayout-BWMUVZgC.js";import{R as d,C as c}from"./Grid-m53vqd2Y.js";import{Y as m,bG as u,_ as x,h as p,I as h,bT as g,B as v,bb as f,q as j,bU as y,bV as b,bW as N,bX as k,bY as w,bZ as C,b_ as _,b$ as S,c0 as M,c1 as T,p as R,m as A,av as D}from"./index-CkRTgHHA.js";import{c as E,m as L}from"./node-types-DRVunROD.js";import{c as $}from"./vendor-core-FtpmsTnh.js";import{j as F,bc as I,R as P,b7 as O,bd as K,a1 as z,as as U,l as q,C as B,be as G,bf as V,bg as H,a as Y,bh as W,B as Z,b8 as X,o as J,U as Q,k as ee}from"./vendor-icons-TO0PZKGR.js";import{L as se,a as te,b as ae}from"./listbox-DrzA7Ewq.js";import{S as ne,K as le}from"./KeycapButton-DdWNfiky.js";import{C as ie}from"./ConfirmModal-B6Rz8ROW.js";import{S as re,C as oe}from"./ChatBubble-OmHlf-X1.js";import{e as de,g as ce,a as me}from"./chat-utils-mqGCinix.js";import"./vendor-virt-BytWoLhu.js";import"./cosmograph-DqYT4sUA.js";import"./vendor-charts-C916_-gs.js";import"./vendor-motion-DNp0Qg4F.js";import"./vendor-fonts-CRZaZSFf.js";import"./keycap-sfx-Bpx9zhkt.js";function ue({disabled:t,className:a,children:n}){return e.jsx(s,{disabled:t,className:$("flex flex-col gap-2",a),children:n})}function xe({required:s,className:a,children:n,...l}){return e.jsxs(t,{className:$("text-sm font-medium text-fg-primary select-none","data-[disabled]:opacity-50",l.title&&"cursor-help",a),...l,children:[n,s&&e.jsx("span",{className:"text-sys-red ml-0.5","aria-hidden":"true",children:"*"})]})}function pe({className:s,children:t,...n}){return e.jsx(a,{className:$("text-sm text-fg-muted","data-[disabled]:opacity-50",s),...n,children:t})}function he({icon:s,title:t,description:a,onClick:n,accent:l}){return e.jsxs("button",{onClick:n,className:$("flex flex-col items-center gap-3 p-6 rounded-2xl text-center","ring-1 ring-edge-subtle hover:ring-2 transition-all duration-150","w-full max-w-[260px]","primary"===l?"hover:ring-sys-blue hover:bg-sys-blue/5":"hover:ring-sys-indigo hover:bg-sys-indigo/5"),children:[e.jsx("div",{className:$("p-3 rounded-xl","primary"===l?"bg-sys-blue/10 text-sys-blue":"bg-sys-indigo/10 text-sys-indigo"),children:s}),e.jsx("p",{className:"type-body-sm font-medium text-fg-primary",children:t}),e.jsx("p",{className:"type-data-xs text-fg-muted leading-relaxed",children:a})]})}function ge({onCreateRoom:s}){return e.jsxs("div",{className:"flex flex-col items-center justify-center py-16 px-4",children:[e.jsx(F,{className:"w-12 h-12 text-fg-muted opacity-30 mb-4"}),e.jsx("p",{className:"type-subheading text-fg-secondary mb-1",children:"Add a Room Server"}),e.jsx("p",{className:"type-body-sm text-fg-muted mb-8",children:"Choose how this device should operate."}),e.jsxs("div",{className:"flex flex-col sm:flex-row items-center gap-4",children:[e.jsx(he,{icon:e.jsx(I,{className:"w-6 h-6"}),title:"Repeater + Room Server",description:"Keep forwarding packets and add group messaging.",onClick:()=>s("hybrid"),accent:"primary"}),e.jsx(he,{icon:e.jsx(P,{className:"w-6 h-6"}),title:"Dedicated Room Server",description:"Stop repeating. Focus entirely on room server duties.",onClick:()=>s("dedicated"),accent:"secondary"})]})]})}function ve({rooms:s,selected:t,onSelect:a,onAdd:n}){const l=n?e.jsx("button",{onClick:n,className:$("flex items-center justify-center px-2 py-1 rounded-md","text-fg-muted hover:text-fg-primary hover:bg-surface/60","transition-all duration-150"),title:"Add room server",children:e.jsx(O,{className:"w-4 h-4"})}):null;return s.length<=1?l:s.length<=3?e.jsxs("div",{className:"flex items-center gap-0.5 p-0.5 rounded-lg bg-subtle-fill",children:[s.map(s=>e.jsx("button",{onClick:()=>a(s.room_name),className:$("px-3 py-1 rounded-md text-sm font-medium transition-all duration-150",s.room_name===t?"bg-surface text-fg-primary shadow-sm":"text-fg-muted hover:text-fg-secondary"),children:s.room_name},s.room_name)),l]}):e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(se,{value:t??"",onChange:a,children:s.map(s=>e.jsx(te,{value:s.room_name,children:e.jsx(ae,{children:s.room_name})},s.room_name))}),l]})}function fe({open:s,onClose:t,mode:a,identity:l,repeaterConfig:i,onCreate:r,onUpdate:o,onDelete:d,onSendAdvert:c}){var f,j,y,b,N,k,w,C,_;const S="edit"===a&&l,M=`${s}-${(null==l?void 0:l.name)??""}-${a}`,[T,R]=n.useState(""),[A,D]=n.useState(""),[E,L]=n.useState(!1),[$,F]=n.useState(""),[I,P]=n.useState(""),[O,B]=n.useState(""),[G,V]=n.useState(""),[H,Y]=n.useState(!1),[W,Z]=n.useState(!1),[X,J]=n.useState(!1),[Q,ee]=n.useState(null),[se,te]=n.useState(M);if(M!==se)if(te(M),ee(null),Y(!1),Z(!1),J(!1),S)R((null==(f=l.settings)?void 0:f.node_name)??l.name),D(l.identity_key??""),L(!1),F((null==(j=l.settings)?void 0:j.admin_password)??""),P((null==(y=l.settings)?void 0:y.guest_password)??""),B((null==(N=null==(b=l.settings)?void 0:b.latitude)?void 0:N.toString())??""),V((null==(w=null==(k=l.settings)?void 0:k.longitude)?void 0:w.toString())??"");else{const e=i;R(""),D(""),L(!1),F(""),P(""),B(null!=(null==(C=null==e?void 0:e.repeater)?void 0:C.latitude)?e.repeater.latitude.toString():""),V(null!=(null==(_=null==e?void 0:e.repeater)?void 0:_.longitude)?e.repeater.longitude.toString():"")}const ae=n.useCallback(()=>{const e={};return T&&(e.node_name=T),$&&(e.admin_password=$),I&&(e.guest_password=I),""!==O&&(e.latitude=parseFloat(O)),""!==G&&(e.longitude=parseFloat(G)),e},[T,$,I,O,G]),ne=n.useCallback(async()=>{if(!T.trim())return void ee("Room name is required");Y(!0),ee(null);const e=S?l.name:function(e){if(!e)return"";const s=e.trim().toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-|-$/g,"");return s?`${s}-room`:""}(T);let s;if(S)s=await o({name:l.name,settings:ae()});else{const t={name:e,type:"room_server",settings:ae()};A.trim()&&(t.identity_key=A.trim()),s=await r(t)}Y(!1),s?t():ee("Failed to save. Check that the name is unique and passwords differ.")},[T,S,l,ae,r,o,t]),le=n.useCallback(async()=>{if(!S)return;Z(!0);const e=await d(l.name);Z(!1),e&&t()},[S,l,d,t]),ie=n.useCallback(async()=>{S&&(J(!0),await c(l.name),J(!1))},[S,l,c]);return e.jsxs(m,{open:s,onClose:t,size:"md",children:[e.jsx(u,{icon:S?void 0:e.jsx(K,{className:"w-5 h-5"}),title:S?"Edit Room Server":"Add Room Server",onClose:t}),e.jsx(x,{children:e.jsxs("div",{className:"space-y-5",children:[S&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(p,{color:l.registered?"green":"red",children:l.registered?"Active":"Inactive"}),l.identity_key&&e.jsxs("span",{className:"type-data-xs text-fg-muted truncate",title:l.identity_key,children:["Key: ",l.identity_key.slice(0,16),"…"]})]}),e.jsxs(ue,{children:[e.jsx(xe,{title:"What people see on the mesh",children:"Room Name"}),e.jsx(h,{value:T,onChange:e=>R(e.target.value),placeholder:"Room Name"})]}),!S&&e.jsxs(ue,{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(xe,{title:"The unique hex public ID",children:["Identity Key ",e.jsx("span",{className:"text-fg-muted font-normal",children:"(Optional)"})]}),e.jsx("button",{type:"button",onClick:()=>L(e=>!e),className:"type-data-xs text-fg-muted underline hover:text-fg-secondary",children:E?"Hide":"Show"})]}),E&&e.jsxs(e.Fragment,{children:[e.jsx(h,{value:A,onChange:e=>D(e.target.value),placeholder:"Leave empty to auto-generate"}),e.jsx(pe,{children:"Leave empty to automatically generate a secure key"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs(ue,{children:[e.jsxs(xe,{children:[e.jsx(z,{className:"inline w-3.5 h-3.5 -mt-0.5 mr-1 text-fg-muted"}),"Latitude"]}),e.jsx(h,{type:"number",step:"any",value:O,onChange:e=>B(e.target.value),placeholder:"0"})]}),e.jsxs(ue,{children:[e.jsxs(xe,{children:[e.jsx(z,{className:"inline w-3.5 h-3.5 -mt-0.5 mr-1 text-fg-muted"}),"Longitude"]}),e.jsx(h,{type:"number",step:"any",value:G,onChange:e=>V(e.target.value),placeholder:"0"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs(ue,{children:[e.jsxs(xe,{title:"Full access to room server",children:["Admin Password ",e.jsx("span",{className:"text-fg-muted font-normal",children:"(Optional)"})]}),e.jsx(h,{type:"password",value:$,onChange:e=>F(e.target.value),placeholder:"None Set"})]}),e.jsxs(ue,{children:[e.jsxs(xe,{title:"Can post and read, but not administer the room",children:["Guest Password ",e.jsx("span",{className:"text-fg-muted font-normal",children:"(Optional)"})]}),e.jsx(h,{type:"password",value:I,onChange:e=>P(e.target.value),placeholder:"None Set"})]})]}),Q&&e.jsx("p",{className:"type-data-xs text-sys-red",children:Q})]})}),e.jsxs(g,{children:[S&&e.jsxs("div",{className:"flex items-center gap-2 mr-auto",children:[e.jsxs(v,{color:"danger",plain:!0,onClick:le,disabled:W,children:[e.jsx(U,{"data-slot":"icon"}),W?"Deleting…":"Delete"]}),e.jsxs(v,{color:"primary",plain:!0,onClick:ie,disabled:X,children:[e.jsx(q,{"data-slot":"icon"}),X?"Sending…":"Send Advert"]})]}),e.jsx(v,{plain:!0,onClick:t,children:"Cancel"}),e.jsx(v,{color:"primary",onClick:ne,disabled:H,children:H?"Saving…":S?"Save Changes":"Create"})]})]})}const je=n.createContext(null),ye="room-tui";function be({children:s}){const[t,a]=n.useState(()=>"0"!==localStorage.getItem(ye)),l=n.useCallback(()=>{a(e=>{const s=!e;return localStorage.setItem(ye,s?"1":"0"),s})},[]);return e.jsx(je.Provider,{value:{terminalMode:t,toggleTerminalMode:l},children:s})}function Ne(){const e=n.useContext(je);if(!e)throw new Error("useTerminalMode must be used within RoomTerminalProvider");return e}const ke=e=>"server"===e.author_pubkey||"system"===e.author_pubkey;function we({messages:s,onDelete:t,terminalMode:a,serverName:l}){const i=n.useRef(null),[r,o]=n.useState(!1),d=n.useMemo(()=>[...s].sort((e,s)=>e.post_timestamp-s.post_timestamp),[s]);n.useEffect(()=>{!r&&i.current&&(i.current.scrollTop=0)},[d.length,r]);const c=n.useCallback(()=>{i.current&&o(i.current.scrollTop<-100)},[]),m=n.useCallback(()=>{i.current&&i.current.scrollTo({top:0,behavior:"smooth"}),o(!1)},[]);return 0===d.length?e.jsx("div",{className:"flex-1 flex flex-col items-center justify-center py-12 min-h-0"+(a?" font-mono":""),children:a?e.jsx("p",{className:"text-sm font-mono",style:{color:"var(--tui-accent)",opacity:.4},children:"> no messages in buffer_"}):e.jsxs(e.Fragment,{children:[e.jsx(F,{className:"w-10 h-10 text-fg-muted opacity-20 mb-2"}),e.jsx("p",{className:"type-data-sm text-fg-muted",children:"No messages yet"})]})}):a?e.jsxs("div",{className:"relative flex-1 min-h-0",children:[e.jsx("div",{ref:i,onScroll:c,className:"h-full overflow-y-auto scroll-smooth p-4 font-mono text-sm leading-relaxed flex flex-col-reverse",children:e.jsx("div",{children:d.map(s=>{const a=ke(s),n=new Date(1e3*s.post_timestamp).toLocaleTimeString(void 0,{hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}),i=a?"SYS":s.author_name||s.author_prefix,r=!a&&l&&i===l;return e.jsxs("div",{className:"group flex items-start gap-0 -mx-4 px-4 py-px",style:{"--tw-hover-bg":"var(--tui-hover-bg)"},onMouseEnter:e=>e.currentTarget.style.background="var(--tui-hover-bg)",onMouseLeave:e=>e.currentTarget.style.background="",children:[e.jsxs("span",{className:"select-none shrink-0",style:{color:"var(--tui-muted)"},children:["[",n,"]"]}),e.jsxs("span",{className:"mx-1.5 shrink-0",style:{color:r?"var(--tui-accent-local)":"var(--tui-accent)"},children:["<",i,">"]}),e.jsx("span",{style:{color:a?"var(--tui-system)":r?"var(--tui-body)":"var(--tui-accent)"},className:a?"italic":"",children:s.message_text}),e.jsx("button",{onClick:()=>t(s.id),className:"opacity-0 group-hover:opacity-100 ml-auto pl-2 shrink-0 transition-colors",style:{color:"var(--tui-muted)"},onMouseEnter:e=>e.currentTarget.style.color="var(--tui-danger)",onMouseLeave:e=>e.currentTarget.style.color="var(--tui-muted)",title:"Delete",children:"×"})]},s.id)})})}),r&&e.jsxs("button",{onClick:m,className:"absolute bottom-3 left-1/2 -translate-x-1/2 flex items-center gap-1.5 px-3 py-1 font-mono text-xs transition-colors duration-150",style:{background:"var(--tui-hover-bg)",border:"1px solid var(--tui-muted)",color:"var(--tui-accent)"},children:[e.jsx(B,{className:"w-3 h-3"}),"↓ scroll"]})]}):e.jsxs("div",{className:"relative flex-1 min-h-0",children:[e.jsx("div",{ref:i,onScroll:c,className:"h-full overflow-y-auto scroll-smooth flex flex-col-reverse",children:e.jsx("div",{className:"space-y-3 p-4",children:d.map(s=>ke(s)?e.jsx(re,{text:s.message_text},s.id):e.jsx(oe,{senderName:s.author_name||s.author_prefix,text:s.message_text,timestamp:s.post_timestamp,bubbleAccessory:e.jsx("button",{onClick:()=>t(s.id),className:"opacity-0 group-hover:opacity-100 transition-opacity duration-150 p-1 text-fg-muted hover:text-sys-red flex-shrink-0",title:"Delete message",children:e.jsx(U,{className:"w-3.5 h-3.5"})})},s.id))})}),r&&e.jsxs("button",{onClick:m,className:"absolute bottom-3 left-1/2 -translate-x-1/2 flex items-center gap-1.5 px-3 py-1.5 rounded-full bg-surface/90 backdrop-blur-sm ring-1 ring-edge-subtle shadow-md text-fg-secondary hover:text-fg-primary transition-colors duration-150",children:[e.jsx(B,{className:"w-3.5 h-3.5"}),e.jsx("span",{className:"type-data-xs",children:"New messages"})]})]})}function Ce({roomName:s,onSend:t,disabled:a,terminalMode:l}){const[i,r]=n.useState(""),[o,d]=n.useState(!1),c=n.useRef(null),m=n.useCallback(async()=>{var e;const s=i.trim();if(!s||o)return;d(!0);const a=await t(s);d(!1),a&&(r(""),null==(e=c.current)||e.focus())},[i,o,t]),u=n.useCallback(e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),m())},[m]);return l?e.jsxs("div",{className:"flex items-center gap-0 px-4 py-2 type-data-sm",children:[e.jsx("input",{ref:c,type:"text",value:i,onChange:e=>r(e.target.value),onKeyDown:u,placeholder:"type message...",disabled:a||o,className:"flex-1 bg-transparent outline-none ring-0 shadow-none border-none focus:outline-none focus:ring-0 font-mono tui-input",style:{color:"var(--tui-body)"}}),e.jsx("button",{onClick:m,disabled:!i.trim()||o||a,className:"transition-colors duration-100 px-1 font-mono text-xs disabled:opacity-30",style:{color:"var(--tui-accent)"},title:"Send",children:"[↵]"})]}):e.jsxs("div",{className:"flex items-center gap-2 p-3 border-t border-edge-subtle",children:[e.jsx("input",{ref:c,type:"text",value:i,onChange:e=>r(e.target.value),onKeyDown:u,placeholder:`Message ${s}…`,disabled:a||o,className:"flex-1 surface-input radius-inner px-3 py-2 type-body-sm text-fg-primary placeholder:text-fg-muted outline-none ring-focus"}),e.jsx("button",{onClick:m,disabled:!i.trim()||o||a,className:"p-2 rounded-lg text-sys-blue hover:bg-sys-blue/10 disabled:opacity-30 disabled:hover:bg-transparent transition-colors duration-150",title:"Send message",children:e.jsx(q,{className:"w-4.5 h-4.5"})})]})}function _e({selectedName:s,selectedIdentity:t,messages:a,onSend:i,onDelete:r,onClear:o}){var d;const{terminalMode:c,toggleTerminalMode:m}=Ne(),[u,x]=n.useState(!1),p=(null==(d=null==t?void 0:t.settings)?void 0:d.node_name)??s??void 0,h=n.useCallback(()=>{x(!1),o()},[o]);return c?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex flex-col h-full gap-1.5",children:[e.jsxs("div",{className:"card-terminal-header flex-shrink-0",children:[e.jsx("span",{className:"seven-seg-panel",children:e.jsx(ne,{text:"chat",minChars:7,size:24})}),e.jsx("div",{className:"card-terminal-ridge flex-1"}),e.jsxs("div",{className:"header-well",children:[e.jsx(le,{icon:e.jsx(G,{className:"!w-5.5 !h-5.5 translate-y-px"}),onClick:m,title:"Exit terminal mode"}),a.length>0&&e.jsx(le,{icon:e.jsx("span",{className:"text-[13px] font-bold font-mono leading-none translate-y-px",children:"DEL"}),onClick:()=>x(!0),title:"Clear all messages",variant:"red",iconActiveColor:f.red})]})]}),e.jsx(l,{noPadding:!0,className:"flex flex-col flex-1 min-h-0 overflow-hidden card-terminal",children:e.jsxs("div",{className:"card-terminal-well flex-1 min-h-0 flex flex-col overflow-hidden",children:[e.jsx(we,{messages:a,onDelete:r,terminalMode:!0,serverName:p}),e.jsx("div",{className:"card-terminal-divider"}),s&&e.jsx(Ce,{roomName:s,onSend:i,disabled:!(null==t?void 0:t.registered),terminalMode:!0})]})})]}),e.jsx(ie,{isOpen:u,title:"Clear All Messages",message:`This will permanently delete all ${a.length} message${1===a.length?"":"s"} from this room. This cannot be undone.`,confirmLabel:"Clear Messages",variant:"danger",onConfirm:h,onCancel:()=>x(!1)})]}):e.jsxs(e.Fragment,{children:[e.jsxs(l,{noPadding:!0,className:"flex flex-col h-full overflow-hidden",children:[e.jsx(j,{listHeader:!0,icon:e.jsx(V,{className:"icon-sm"}),title:"Messages",actions:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(v,{plain:!0,onClick:m,title:"Terminal mode",children:e.jsx(G,{"data-slot":"icon",className:"!w-5 !h-5 translate-y-px"})}),a.length>0&&e.jsx(v,{plain:!0,onClick:()=>x(!0),title:"Clear all messages",children:e.jsx("span",{"data-slot":"icon",className:"text-[12px] font-bold font-mono leading-none translate-y-px text-sys-red",children:"DEL"})})]})}),e.jsx(we,{messages:a,onDelete:r,terminalMode:!1,serverName:p}),s&&e.jsx(Ce,{roomName:s,onSend:i,disabled:!(null==t?void 0:t.registered),terminalMode:!1})]}),e.jsx(ie,{isOpen:u,title:"Clear All Messages",message:`This will permanently delete all ${a.length} message${1===a.length?"":"s"} from this room. This cannot be undone.`,confirmLabel:"Clear Messages",variant:"danger",onConfirm:h,onCancel:()=>x(!1)})]})}function Se({pubkey:s,className:t}){const[a,l]=n.useState(!1),i=n.useCallback(()=>{navigator.clipboard.writeText(s),l(!0),setTimeout(()=>l(!1),1500)},[s]);return e.jsxs("button",{onClick:i,title:a?"Copied!":"Copy public key",className:`inline-flex items-center gap-1 type-data-xs leading-tight text-fg-muted hover:text-fg-secondary transition-colors duration-150 cursor-copy ${t??""}`,children:[e.jsx("span",{className:"truncate min-w-0",children:s.slice(0,8)}),a&&e.jsx(Y,{className:"w-2.5 h-2.5 text-sys-green flex-shrink-0"})]})}const Me=n.memo(function({client:s,resolvedName:t,onRemove:a}){const n=s.name||t,l=0===s.unsynced_count,i=s.last_activity?new Date(1e3*s.last_activity).toLocaleString(void 0,{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}):"Never",{emoji:r,cleanName:o}=n?de(n):{emoji:null,cleanName:s.pubkey_prefix},d=n?ce(o):void 0,c=n?me(n):s.pubkey_prefix.slice(0,2).toUpperCase();return e.jsxs("div",{className:"group flex items-center gap-3 px-3 py-2.5 radius-inner row-hover transition-base",children:[e.jsxs("div",{className:"relative flex-shrink-0",children:[e.jsx("div",{className:$("w-8 h-8 rounded-full flex items-center justify-center",!d&&"bg-sys-blue/12"),style:d?{backgroundColor:d}:void 0,children:r?e.jsx("span",{className:"text-base leading-none",children:r}):e.jsx("span",{className:$("leading-none",d?"text-white text-[11px] font-bold tracking-tight":"text-sys-blue font-mono text-[11px]"),children:c})}),e.jsx("span",{className:"absolute -bottom-0.5 -right-0.5 w-2.5 h-2.5 rounded-sm ring-2 ring-surface "+(l?"bg-sys-green":"bg-sys-indigo")})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[n?e.jsx("p",{className:"text-[13px] font-medium leading-tight text-fg-primary truncate",children:n}):e.jsx("p",{className:"font-mono text-[13px] leading-tight text-fg-primary truncate",children:s.pubkey_prefix}),e.jsxs("div",{className:"flex items-center gap-1.5 mt-0.5",children:[n&&e.jsx(Se,{pubkey:s.pubkey}),n&&e.jsx("span",{className:"text-xs text-fg-muted/40",children:"·"}),e.jsxs("span",{className:"text-xs leading-tight text-fg-muted truncate",children:[!l&&e.jsxs("span",{className:"text-sys-indigo",children:[s.unsynced_count," unsynced · "]}),i]})]})]}),e.jsx("button",{onClick:()=>a(s.pubkey),className:"opacity-0 group-hover:opacity-100 transition-opacity duration-150 p-1.5 -mr-1 rounded-md text-fg-muted hover:text-sys-red hover:bg-sys-red/8",title:"Remove client",children:e.jsx(H,{className:"w-3.5 h-3.5"})})]})});function Te({clients:s,onRemove:t,messages:a,terminalMode:l}){const i=n.useMemo(()=>{const e=new Map;if(!a)return e;for(let s=a.length-1;s>=0;s--){const t=a[s];t.author_name&&t.author_pubkey&&"server"!==t.author_pubkey&&"system"!==t.author_pubkey&&e.set(t.author_pubkey,t.author_name)}return e},[a]);return 0===s.length?l?e.jsx("p",{className:"type-data-sm text-left px-4 py-4",style:{color:"var(--tui-accent)"},children:"< NO CLIENTS CONNECTED >"}):e.jsx("p",{className:"type-data-xs text-fg-muted text-center py-4",children:"No clients connected"}):l?e.jsx("div",{className:"type-data-sm pt-2",children:s.map(s=>{const a=s.name||i.get(s.pubkey),n=0===s.unsynced_count,l=s.pubkey_prefix;return e.jsxs("div",{className:"group flex items-center gap-0 -mx-0 px-4 py-0.5",onMouseEnter:e=>e.currentTarget.style.background="var(--tui-hover-bg)",onMouseLeave:e=>e.currentTarget.style.background="",children:[e.jsx("span",{style:{color:n?"var(--tui-accent)":"var(--tui-warn)"},children:"■"}),e.jsx("span",{className:"ml-2 shrink-0",style:{color:"var(--tui-accent)"},children:a||l}),a&&e.jsxs("span",{className:"ml-1.5 shrink-0",style:{color:"var(--tui-accent)"},children:["[",l,"]"]}),!n&&e.jsxs("span",{className:"ml-1.5",style:{color:"var(--tui-warn)"},children:[s.unsynced_count,"unsync"]}),e.jsx("button",{onClick:()=>t(s.pubkey),className:"opacity-0 group-hover:opacity-100 ml-auto pl-2 shrink-0 transition-colors",style:{color:"var(--tui-muted)"},onMouseEnter:e=>e.currentTarget.style.color="var(--tui-danger)",onMouseLeave:e=>e.currentTarget.style.color="var(--tui-muted)",title:"Remove",children:"×"})]},s.pubkey)})}):e.jsx("div",{className:"space-y-0.5 pt-1",children:s.map(s=>e.jsx(Me,{client:s,resolvedName:i.get(s.pubkey),onRemove:t},s.pubkey))})}function Re({name:s,onSend:t}){const{terminalMode:a}=Ne(),[l,i]=n.useState("idle"),r=n.useRef(),o=n.useCallback(async()=>{if("sending"===l)return;i("sending");const e=await t(s);i(e?"sent":"idle"),e&&(r.current=setTimeout(()=>i("idle"),2e3))},[s,t,l]);return n.useEffect(()=>()=>clearTimeout(r.current),[]),a?e.jsxs("button",{className:"btn-terminal",onClick:o,disabled:"sending"===l,children:["idle"===l&&"[ send_advert ]","sending"===l&&"[ broadcasting... ]","sent"===l&&"[ sent ✓ ]"]}):e.jsxs(v,{color:"sent"===l?"success":"primary",className:"w-full",onClick:o,disabled:"sending"===l,children:[e.jsx(W,{"data-slot":"icon"}),"idle"===l&&"Send Advert","sending"===l&&"Broadcasting…","sent"===l&&"Advert Sent"]})}function Ae({identity:s,onSendAdvert:t}){var a,l,i,r,o,d,c,m,u,x,h,g,v,f,y,b,N,k,w,C,_,S,M,T,R,A,D,E,L,$;const{terminalMode:F}=Ne(),[I,P]=n.useState(!1),O=n.useCallback(()=>{(null==s?void 0:s.identity_key)&&(navigator.clipboard.writeText(s.identity_key),P(!0),setTimeout(()=>P(!1),1500))},[null==s?void 0:s.identity_key]);return F?s?e.jsxs("div",{className:"space-y-1",children:[(null==(a=s.settings)?void 0:a.node_name)&&e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{style:{color:"var(--tui-muted)"},children:"node"}),e.jsx("span",{style:{color:"var(--tui-accent)"},children:s.settings.node_name})]}),(s.address||(null==(l=s.runtime)?void 0:l.address))&&e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{style:{color:"var(--tui-muted)"},children:"addr"}),e.jsx("span",{style:{color:"var(--tui-accent)"},children:s.address||(null==(i=s.runtime)?void 0:i.address)})]}),s.identity_key&&e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{style:{color:"var(--tui-muted)"},children:"key"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"truncate max-w-[140px]",style:{color:"var(--tui-accent)"},title:s.identity_key,children:[s.identity_key.slice(0,16),"…"]}),e.jsx("button",{type:"button",onClick:O,className:"text-xs",style:{color:"var(--tui-muted)"},children:I?"[copied ✓]":"[copy]"})]})]}),(null!=(null==(r=s.settings)?void 0:r.latitude)||null!=(null==(o=s.settings)?void 0:o.longitude))&&e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{style:{color:"var(--tui-muted)"},children:"loc"}),e.jsxs("span",{style:{color:"var(--tui-accent)"},title:`${(null==(d=s.settings)?void 0:d.latitude)??"—"}, ${(null==(c=s.settings)?void 0:c.longitude)??"—"}`,children:[(null==(u=null==(m=s.settings)?void 0:m.latitude)?void 0:u.toFixed(4))??"—",", ",(null==(h=null==(x=s.settings)?void 0:x.longitude)?void 0:h.toFixed(4))??"—"]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{style:{color:"var(--tui-muted)"},children:"pass"}),e.jsxs("span",{className:"flex items-center gap-1.5",children:[e.jsx("span",{style:{color:(null==(g=s.settings)?void 0:g.admin_password)?"var(--tui-accent)":"var(--tui-muted)"},children:(null==(v=s.settings)?void 0:v.admin_password)?"[✓ admin]":"[— admin]"}),e.jsx("span",{style:{color:(null==(f=s.settings)?void 0:f.guest_password)?"var(--tui-accent)":"var(--tui-muted)"},children:(null==(y=s.settings)?void 0:y.guest_password)?"[✓ guest]":"[— guest]"})]})]})]}):e.jsx("span",{style:{color:"var(--tui-muted)"},children:"no identity configured"}):e.jsxs("div",{className:"flex-shrink-0 border-t border-edge-subtle",children:[e.jsx(j,{listHeader:!0,icon:e.jsx(Z,{className:"icon-sm"}),title:"Room Info"}),s?e.jsxs("div",{className:"space-y-2 px-4 py-3",children:[(null==(b=s.settings)?void 0:b.node_name)&&e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"type-data-xs text-fg-muted",children:"Node"}),e.jsx("span",{className:"type-data-sm text-fg-primary",children:s.settings.node_name})]}),(s.address||(null==(N=s.runtime)?void 0:N.address))&&e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"type-data-xs text-fg-muted",children:"Address"}),e.jsx("span",{className:"type-data-sm font-mono text-fg-primary",children:s.address||(null==(k=s.runtime)?void 0:k.address)})]}),s.identity_key&&e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("span",{className:"type-data-xs text-fg-muted flex items-center gap-1",title:"The unique hex public ID",children:[e.jsx(X,{className:"w-3 h-3"}),"Key"]}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsxs("span",{className:"type-data-sm font-mono text-fg-primary truncate max-w-[140px]",title:s.identity_key,children:[s.identity_key.slice(0,16),"…"]}),e.jsx("button",{type:"button",onClick:O,className:"inline-flex items-center gap-0.5",children:e.jsx(p,{color:I?"green":"zinc",children:I?e.jsxs(e.Fragment,{children:[e.jsx(Y,{className:"w-3 h-3"}),"Copied"]}):e.jsxs(e.Fragment,{children:[e.jsx(J,{className:"w-3 h-3"}),"Copy"]})})})]})]}),(null!=(null==(w=s.settings)?void 0:w.latitude)||null!=(null==(C=s.settings)?void 0:C.longitude))&&e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("span",{className:"type-data-xs text-fg-muted flex items-center gap-1",children:[e.jsx(z,{className:"w-3 h-3"}),"Location"]}),e.jsxs("span",{className:"type-data-sm font-mono text-fg-primary",title:`${(null==(_=s.settings)?void 0:_.latitude)??"—"}, ${(null==(S=s.settings)?void 0:S.longitude)??"—"}`,children:[(null==(T=null==(M=s.settings)?void 0:M.latitude)?void 0:T.toFixed(4))??"—",", ",(null==(A=null==(R=s.settings)?void 0:R.longitude)?void 0:A.toFixed(4))??"—"]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"type-data-xs text-fg-muted",children:"Passwords"}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsxs(p,{color:(null==(D=s.settings)?void 0:D.admin_password)?"green":"zinc",children:[(null==(E=s.settings)?void 0:E.admin_password)&&e.jsx(Y,{className:"w-3 h-3"}),"Admin"]}),e.jsxs(p,{color:(null==(L=s.settings)?void 0:L.guest_password)?"green":"zinc",children:[(null==($=s.settings)?void 0:$.guest_password)&&e.jsx(Y,{className:"w-3 h-3"}),"Guest"]})]})]}),e.jsx("div",{className:"pt-3",children:e.jsx(Re,{name:s.name,onSend:t})})]}):e.jsx("p",{className:"type-data-xs text-fg-muted text-center py-3",children:"No identity configured"})]})}function De({selectedIdentity:s,clients:t,messages:a,onSendAdvert:i}){const{terminalMode:r}=Ne(),o=n.useCallback(async e=>{y.setState(s=>({clients:s.clients.filter(s=>s.pubkey!==e)})),await b({public_key:e})},[]);return r?e.jsxs("div",{className:"flex flex-col h-full gap-1.5",children:[s&&e.jsx("div",{className:"hidden lg:block",children:e.jsx("div",{className:"card-terminal-header flex-shrink-0",children:e.jsx("div",{className:"header-well flex-1",children:e.jsx(le,{icon:e.jsx(W,{}),onPress:()=>i(s.name),title:"Send room server advert",indicators:[{label:"ADVERTISE",trackPress:!0},{label:"ACTIVE",active:s.registered}]})})})}),e.jsxs("div",{className:"flex flex-col flex-1 min-h-0 gap-1.5",children:[e.jsx("div",{className:"card-terminal-header flex-shrink-0",children:e.jsx("span",{className:"seven-seg-panel",children:e.jsx(ne,{text:`OnLInE ${String(t.length).padStart(3,"0")}`,size:24})})}),e.jsx(l,{noPadding:!0,className:"!h-auto flex flex-col flex-1 min-h-0 overflow-hidden card-terminal",children:e.jsx("div",{className:"card-terminal-well flex-1 min-h-0 overflow-y-auto",children:e.jsx(Te,{clients:t,onRemove:o,messages:a,terminalMode:!0})})}),e.jsxs("div",{className:"card-terminal-header flex-shrink-0",children:[e.jsx("span",{className:"seven-seg-panel",children:e.jsx(ne,{text:"StAtUS "+((null==s?void 0:s.registered)?"On":"OFF"),size:24})}),s&&e.jsx("div",{className:"lg:hidden flex-1 flex min-w-0",children:e.jsx("div",{className:"header-well flex-1 !flex-shrink",children:e.jsx(le,{icon:e.jsx(W,{}),onPress:()=>i(s.name),title:"Send room server advert",className:"flex-row-reverse",indicators:[{label:"ACTIVE",active:s.registered},{label:"ADVERTISE",trackPress:!0}]})})})]}),e.jsx(l,{noPadding:!0,className:"!h-auto flex-shrink-0 overflow-hidden card-terminal",children:e.jsx("div",{className:"card-terminal-well px-4 py-3 type-data-sm",children:e.jsx(Ae,{identity:s,onSendAdvert:i})})})]})]}):e.jsxs(l,{compact:!0,className:"flex-1 min-h-0 flex flex-col overflow-hidden",children:[e.jsx(j,{listHeader:!0,icon:e.jsx(Q,{className:"icon-sm"}),title:"Clients",actions:t.length>0?e.jsx("span",{className:"type-data-xs text-fg-muted",children:t.length}):void 0}),e.jsx("div",{className:"flex-1 min-h-0 overflow-y-auto",children:e.jsx(Te,{clients:t,onRemove:o,messages:a,terminalMode:!1})}),e.jsx(Ae,{identity:s,onSendAdvert:i})]})}function Ee(){const s=N(),t=k(),a=w(),l=C(),m=_(),u=S(),x=M(),p=T(),h=R(),g=A(),f=(se=n.useMemo(()=>(null==h?void 0:h.neighbors)??{},[null==h?void 0:h.neighbors]),te=g,n.useMemo(()=>{const e=new Map;for(const[t,a]of Object.entries(se)){const s=a.name||a.node_name||null,{type:n}=E(a);e.set(t.toLowerCase(),{name:s,type:n})}const s=new Map;for(let t=te.length-1;t>=0;t--){const e=te[t];if(!e._advertSender)continue;const a=e._advertSender.toLowerCase();if(s.has(a))continue;const n=e._advertName??null,l=null!=e._advertNodeType?L(e._advertNodeType):"companion";s.set(a,{name:n,type:l})}return function(t){const a=t.toLowerCase(),n=e.get(a);if(null==n?void 0:n.name)return n;const l=s.get(a);return(null==l?void 0:l.name)?l:n||l||{name:null,type:"companion"}}},[se,te])),j=n.useMemo(()=>u.map(e=>{if(e.name)return e;const s=f(e.pubkey);return s.name?{...e,name:s.name}:e}),[u,f]),b=n.useMemo(()=>m.map(e=>{if(e.author_name||"server"===e.author_pubkey||"system"===e.author_pubkey)return e;const s=f(e.author_pubkey);return s.name?{...e,author_name:s.name}:e}),[m,f]),{selectRoom:$,postMessage:I,deleteMessage:P,clearMessages:O,createRoom:K,updateRoom:z,deleteRoom:U,sendAdvert:q,markAsRead:B,startActivePolling:G}=y.getState(),[H,Y]=n.useState(!1),[W,Z]=n.useState("create"),[X,J]=n.useState("hybrid");var se,te;n.useEffect(()=>{B()},[t,B]),n.useEffect(()=>G(),[G]);const ae=n.useCallback(async e=>!!t&&I({room_name:t,message:e,author_pubkey:"server"}),[t,I]),ne=n.useCallback((e="hybrid")=>{J(e),Z("create"),Y(!0)},[]),le=n.useCallback(()=>{Z("edit"),Y(!0)},[]),ie=e.jsxs("div",{className:"flex items-center gap-2 sm:gap-4 flex-shrink-0",children:[a&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"data-box flex items-center gap-1.5 cursor-default",title:`${a.total_messages} message${1!==a.total_messages?"s":""} in this room`,children:[e.jsx(V,{className:"w-3.5 h-3.5 text-fg-secondary"}),e.jsx("span",{children:a.total_messages})]}),e.jsxs("span",{className:"data-box flex items-center gap-1.5 cursor-default",title:`${a.total_clients} client${1!==a.total_clients?"s":""} connected`,children:[e.jsx(Q,{className:"w-3.5 h-3.5 text-fg-secondary"}),e.jsx("span",{children:a.total_clients})]})]}),e.jsx(ve,{rooms:s,selected:t,onSelect:$,onAdd:()=>ne("hybrid")}),s.length>0&&e.jsx(v,{plain:!0,onClick:le,title:"Manage room server",children:e.jsx(ee,{"data-slot":"icon"})})]});return 0!==s.length||0!==x.length||p?e.jsx(be,{children:e.jsxs(i,{children:[e.jsx(r,{title:"Room Server",icon:e.jsx(F,{}),controls:ie}),e.jsx(o,{children:e.jsxs(d,{template:"hero-tall",className:"!h-[calc(100vh-11rem)] !min-h-[400px]",children:[e.jsx(c,{span:12,lg:8,className:"h-full",children:e.jsx(_e,{selectedName:t,selectedIdentity:l,messages:b,onSend:ae,onDelete:P,onClear:O})}),e.jsx(c,{span:12,lg:4,className:"h-full",children:e.jsx(De,{selectedIdentity:l,clients:j,messages:b,onSendAdvert:q})})]})}),e.jsx(fe,{open:H,onClose:()=>Y(!1),mode:W,identity:l,repeaterConfig:null==h?void 0:h.config,onCreate:K,onUpdate:z,onDelete:U,onSendAdvert:q})]})}):e.jsx(be,{children:e.jsxs(i,{children:[e.jsx(r,{title:"Room Server",icon:e.jsx(F,{})}),e.jsx(ge,{onCreateRoom:e=>ne(e)}),e.jsx(fe,{open:H,onClose:()=>Y(!1),mode:"create",repeaterConfig:null==h?void 0:h.config,onCreate:async e=>{const s=await K(e);return s&&"dedicated"===X&&(await D.getState().setMode("monitor"),D.getState().clearModeMutation()),s},onUpdate:z,onDelete:U,onSendAdvert:q})]})})}export{Ee as default};
