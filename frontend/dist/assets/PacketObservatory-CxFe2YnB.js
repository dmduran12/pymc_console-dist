const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/usePipelineStore-5LDag23M.js","assets/cosmograph-DqYT4sUA.js","assets/vendor-react-SfmO5UG4.js","assets/vendor-core-D1p9zwXj.js","assets/node-types-CunV9yGl.js","assets/index-CF53FmhC.js","assets/vendor-charts-C916_-gs.js","assets/vendor-motion-BUrLkjC7.js","assets/vendor-icons-QG3AVsi5.js","assets/vendor-fonts-CRZaZSFf.js","assets/geo-utils-DJn8DnxF.js","assets/vendor-charts-D1GxaB_c.css","assets/vendor-fonts-hkYiuhFD.css","assets/index-BawBpZYt.css"])))=>i.map(i=>d[i]);
import{r as e,j as t}from"./vendor-react-SfmO5UG4.js";import{ar as s,c2 as r,c3 as n,c4 as a,c5 as l,a8 as o,c6 as c,c7 as i,c8 as d,c9 as p,a7 as u,ca as h,cb as x,cc as m,cd as g,bL as f,ce as b,h as v,af as y,ao as j,av as N,cf as k,cg as w,ch as C,ci as S,cj as _,ck as H,cl as T,cm as $,cn as P,co as L,M,H as D,cp as F,m as R,p as A,cq as z,a3 as E,bc as B}from"./index-CF53FmhC.js";import{b as O,r as V,c as I}from"./usePipelineStore-5LDag23M.js";import{_ as U}from"./cosmograph-DqYT4sUA.js";import{e as q,p as G,a as K,A as W,S as Z,c as Y,f as X,K as Q,H as J,B as ee,R as te,T as se,P as re,h as ne,i as ae,C as le,s as oe,j as ce}from"./primitives-Bm122DQ8.js";import{m as ie,i as de}from"./node-types-CunV9yGl.js";import{a as pe}from"./vendor-core-D1p9zwXj.js";import"./vendor-charts-C916_-gs.js";import"./vendor-motion-BUrLkjC7.js";import"./vendor-icons-QG3AVsi5.js";import"./vendor-fonts-CRZaZSFf.js";import"./geo-utils-DJn8DnxF.js";import"./payload-decoders-BPu6Liho.js";let ue=null,he=null;"undefined"!=typeof window&&setTimeout(()=>{U(()=>import("./usePipelineStore-5LDag23M.js").then(e=>e.d),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13])).then(e=>{ue=e}),U(()=>import("./index-CF53FmhC.js").then(e=>e.dv),__vite__mapDeps([2,3,11,12,13])).then(e=>{he=e})},0);const xe={advertSender:null,advertNodeType:null,advertFlags:null,advertHasLocation:null,advertHasName:null,advertName:null,advertLatitude:null,advertLongitude:null,channelHash:null,byteLength:void 0,hopCount:0,isZeroHop:!0,preComputed:!1};function me(e,t,s,r,n){if(0===t){const a=null==r?void 0:r.get(e);if(a)return{hash:a,confidence:.8};if(n){const r=V(n,e,{position:t,adjacentPrefixes:s});if(r.hash)return{hash:r.hash,confidence:r.confidence}}}else{if(n){const r=V(n,e,{position:t,adjacentPrefixes:s});if(r.hash)return{hash:r.hash,confidence:r.confidence}}const a=null==r?void 0:r.get(e);if(a)return{hash:a,confidence:.6}}return{hash:null,confidence:0}}function ge(t,x,m){const g=e.useRef({parse:0,decode:0,enrich:0,traceIndex:0,total:0}),f=e.useMemo(()=>t?function(e){var t;const s=e.raw_packet;if(!s||s.length<2)return null;const r=s.replace(/\s/g,""),n=Math.floor(r.length/2),a=(null==(t=r.match(/.{1,2}/g))?void 0:t.join(" "))??"";let l="";for(let o=0;o<n;o++){const e=parseInt(r.slice(2*o,2*o+2),16);l+=e>=32&&e<=126?String.fromCharCode(e):"Â·"}return{hexBytes:a,utf8:l,byteCount:n}}(t):null,[t]),b=e.useMemo(()=>{if(!x||x.length<4)return g.current.parse=0,g.current.decode=0,null;const e=performance.now(),t=G(x),s=performance.now()-e;return t?(g.current.parse=s,g.current.decode=0,{protocolPacket:t.packet,display:{headerFields:t.headerFields,transportCodesHex:t.transportCodesHex,pathLengthHex:t.pathLengthHex,pathDataHex:t.pathDataHex,payloadHex:t.payloadHex,payloadByteOffset:t.payloadStartByte,pathByteOffset:t.pathByteOffset,pathLenByteOffset:t.pathLenByteOffset},decoded:t.decoded,error:null}):(g.current.parse=s,g.current.decode=0,{protocolPacket:null,display:null,decoded:null,error:"Packet.fromHex() returned failure"})},[x]),v=e.useMemo(()=>{if(!t)return g.current.enrich=0,xe;const e=performance.now();if(void 0!==t._advertSender)return g.current.enrich=performance.now()-e,{advertSender:t._advertSender??null,advertNodeType:t._advertNodeType??null,advertFlags:t._advertFlags??null,advertHasLocation:t._advertHasLocation??null,advertHasName:t._advertHasName??null,advertName:t._advertName??null,advertLatitude:t._advertLatitude??null,advertLongitude:t._advertLongitude??null,channelHash:t._channelHash??null,byteLength:t._byteLength,hopCount:t._hopCount??0,isZeroHop:t._isZeroHop??!0,preComputed:!0};const s=t.type??t.payload_type,o=r(x,s),c=n(x,s),i=a(x,t),d=l(t);return g.current.enrich=performance.now()-e,{...o,channelHash:c,byteLength:i,...d,preComputed:!1}},[t,x]),y=e.useRef({fingerprint:"",index:new Map}),j=e.useMemo(()=>{const e=performance.now(),{index:t,fingerprint:r}=function(e){const t=new Map;let r=0,n="";for(const a of e){if((a.type??a.payload_type)!==s.TRACE)continue;r++,n=a.packet_hash;const e=a._traceTag??(a.payload?q(a.payload):null);if(!e)continue;let l=t.get(e);l||(l=[],t.set(e,l)),l.push(a)}return{index:t,fingerprint:`${r}:${n}`}}(m);return g.current.traceIndex=performance.now()-e,r===y.current.fingerprint?y.current.index:(y.current={fingerprint:r,index:t},t)},[m]),N=e.useMemo(()=>{const e=g.current;return{parse:e.parse,decode:e.decode,enrich:e.enrich,traceIndex:e.traceIndex,total:e.parse+e.decode+e.enrich+e.traceIndex}},[b,v,j]);if(!t)return null;const k=x?b?b.error:"rawHex too short":"No raw_packet (warm-tier)",w=(null==b?void 0:b.protocolPacket)??null,C=w?w.payloadVersion:null,S=0===C,_=1===C,H=function(e,t){const r=e.type??e.payload_type,n=u(r),a=o(e.route),l=r===s.ADVERT,h=r===s.TRACE,x=r===s.PATH,m=r===s.GRP_TXT||r===s.GRP_DATA,g=c(e.snr,e.rssi),f=(null==g?void 0:g.finalGrade)??"critical",b=i(e.route),v=d(e.route),y=p(e.route),j=null==e.route?"unknown":b?"flood":v?"direct":"unknown",N=y?`transport-${j}`:j,k=!!t.advertSender;let w="none";k?w="pubkey":m?w="encrypted":e.src_hash&&(w="prefix");const C=de(r),S=null!=t.advertNodeType?ie(t.advertNodeType):"unknown",_="unknown"!==C?C:S,H=e.packet_origin??"rx",T=Math.floor(Date.now()/1e3)-e.timestamp,$=T<10?"live":T<300?"recent":T<3600?"warm":T<86400?"stale":"historic",P=e.path_length??(Array.isArray(e.original_path)?e.original_path.length:void 0),L=Array.isArray(e.original_path)&&e.original_path.length>0,M=P??0,D=t.byteLength??(e.raw_packet?Math.floor(e.raw_packet.length/2):0),F=function(e){const t=e.type??e.payload_type,r=e.duplicates??[],n=e.is_duplicate,a=r.length;let l=null,o=null;if(a>0){const t=[e.rssi,...r.map(e=>e.rssi).filter(e=>null!=e)],s=[e.snr,...r.map(e=>e.snr).filter(e=>null!=e)];t.length>1&&(l=[Math.min(...t),Math.max(...t)]),s.length>1&&(o=[Math.min(...s),Math.max(...s)])}return{isDuplicate:n,dupeCount:a,rssiRange:l,snrRange:o,hashIncludesPathLen:t===s.TRACE}}(e);return{pType:r,payloadTypeName:n,routeTypeName:a,isAdvert:l,isTrace:h,isPath:x,isGrp:m,signalClass:f,routeClass:N,isFlood:b,isDirect:v,hasTransport:y,senderTier:w,hasPubkey:k,inferredType:C,advertType:S,effectiveType:_,origin:H,age:$,pathLen:P,pathAvail:L,pathHopCount:M,byteLen:D,dupeAnalysis:F}}(t,v);let T=null;return H.isTrace&&(T=function(e){var t,s,r,n,a,l;const o=K(e);if(!o||0===o.pathHashes.length)return null;const{pathHashes:c,snrValues:i}=o;if(c.length<2)return null;if(!ue||!he)return null;const d=ue.usePipelineStore.getState().srcHashResolverMap,p=ue.usePipelineStore.getState().neighborContext,u=(null==p?void 0:p.hashToName)??new Map,x=he.useStore.getState().stats,m=(null==x?void 0:x.neighbors)??{},g=null==x?void 0:x.local_hash,f=null==(s=null==(t=null==x?void 0:x.config)?void 0:t.repeater)?void 0:s.latitude,b=null==(n=null==(r=null==x?void 0:x.config)?void 0:r.repeater)?void 0:n.longitude,v=Object.keys(m).length>0?O([],m,g,f,b):null,y=[];for(let j=0;j<c.length-1;j++){const e=c[j].toUpperCase(),t=c[j+1].toUpperCase(),s=j+1<i.length?i[j+1]:0,r=me(e,j,[t,...j>0?[c[j-1].toUpperCase()]:[]],d,v),n=me(t,j+1,[e,...j+2<c.length?[c[j+2].toUpperCase()]:[]],d,v);y.push({fromPrefix:e,toPrefix:t,snrRaw:s,fromHash:r.hash,toHash:n.hash,fromName:r.hash?u.get(r.hash)??null:null,toName:n.hash?u.get(n.hash)??null:null,fromConfidence:r.confidence,toConfidence:n.confidence,quality:h(s,null==(l=null==(a=null==x?void 0:x.config)?void 0:a.radio)?void 0:l.spreading_factor),hopIndex:j})}return y.length>0?y:null}(t)),{wire:f,display:(null==b?void 0:b.display)??null,parseError:k,protocolPacket:w,decoded:(null==b?void 0:b.decoded)??null,payloadVersion:C,isV1:S,isV2:_,enrichment:v,traceTagIndex:j,analysis:H,traceHopDetail:T,timing:N}}function fe({options:e,nextFn:s}){var r;const n=e.find(e=>e.active),a=(null==n?void 0:n.color)??"green",l=(null==(r=W[a])?void 0:r.stem)??"bg-edge-subtle";return t.jsxs("div",{className:"flex flex-col items-start py-1 gap-0 px-2",children:[t.jsx("div",{className:`w-px h-2 ml-4 ${l}`}),t.jsxs("div",{className:"border border-dashed border-edge-subtle rounded-md overflow-hidden w-full",children:[e.map((e,s)=>{const r=W[e.color??"green"]??W.green;return t.jsxs("div",{className:`flex items-center gap-1.5 px-2 py-px font-mono text-[10px] leading-relaxed transition-opacity ${e.active?r.row:"opacity-25"}`,children:[t.jsx("span",{className:`w-1.5 h-1.5 rounded-full shrink-0 ${e.active?r.dot:"border border-zinc-500/40"}`}),t.jsx("span",{className:"w-16 shrink-0 font-medium "+(e.active?"text-fg-primary":"text-fg-muted"),children:e.label}),e.detail&&t.jsx("span",{className:e.active?"text-fg-primary/70":"text-fg-muted",children:e.detail})]},s)}),s&&t.jsx("div",{className:"flex items-center px-2 py-0.5 border-t border-edge-subtle",children:t.jsxs("span",{className:"text-[10px] text-fg-muted font-mono",children:["â†’ ",s]})})]}),t.jsx("div",{className:`w-px h-2 ml-4 ${l}`})]})}function be({tokens:e,nextFn:s}){var r;const n=e.find(e=>e.active),a=(null==n?void 0:n.color)??"green",l=(null==(r=W[a])?void 0:r.stem)??"bg-edge-subtle";return t.jsxs("div",{className:"flex flex-col items-start py-1 gap-0 px-2",children:[t.jsx("div",{className:`w-px h-2 ml-4 ${l}`}),t.jsxs("div",{className:"border border-dashed border-edge-subtle rounded-md overflow-hidden w-full",children:[e.map((e,s)=>{const r=W[e.color??"green"]??W.green;return t.jsxs("div",{className:`flex items-center gap-1 px-2 py-px font-mono text-[10px] leading-relaxed transition-opacity ${e.active?r.row:"opacity-25"}`,children:[t.jsx("span",{className:`w-1.5 h-1.5 rounded-full shrink-0 ${e.active?r.dot:"border border-zinc-500/40"}`}),t.jsx("span",{className:"text-fg-muted shrink-0",children:e.fn}),t.jsxs("span",{className:e.active?"text-fg-primary":"text-fg-muted",children:["(",e.value??"",")"]})]},s)}),s&&t.jsx("div",{className:"flex items-center px-2 py-0.5 border-t border-edge-subtle",children:t.jsxs("span",{className:"text-[10px] text-fg-muted font-mono",children:["â†’ ",s]})})]}),t.jsx("div",{className:`w-px h-2 ml-4 ${l}`})]})}const ve={0:"border-l-sys-green",1:"border-l-sys-blue",2:"border-l-sys-teal",3:"border-l-sys-purple"};function ye({stage:e,name:s,fn:r,verdict:n,timeMs:a,skipped:l,skipReason:o,children:c}){const i=ve[e]??"";return t.jsx(t.Fragment,{children:t.jsx(x,{defaultOpen:!l,children:t.jsxs("div",{className:`surface-base rounded-lg border border-edge-subtle overflow-hidden border-l-2 ${i}`,children:[t.jsxs(m,{className:"px-3 py-2 w-full",children:[t.jsxs("div",{className:"flex items-center gap-2 min-w-0",children:[t.jsx("span",{className:"font-mono text-xs font-bold text-sys-blue shrink-0",children:e}),t.jsx("span",{className:"font-mono text-xs font-medium text-fg-primary truncate",children:s}),r&&!n&&t.jsx("span",{className:"font-mono text-[11px] text-fg-muted truncate hidden sm:inline",children:r}),n&&t.jsx("span",{className:"font-mono text-[11px] text-fg-muted/70 truncate hidden sm:inline",children:n})]}),t.jsxs("div",{className:"flex items-center gap-2 shrink-0",children:[l&&t.jsx("span",{className:"font-mono text-[10px] px-1.5 py-0.5 rounded bg-zinc-500/20 text-fg-muted",children:"N/A"}),null!=a&&!l&&t.jsx("span",{className:"font-mono text-[10px] px-1.5 py-0.5 rounded bg-sys-green/15 text-sys-green",children:a<1?`${(1e3*a).toFixed(0)}Âµs`:`${a.toFixed(2)}ms`})]})]}),t.jsx(g,{children:t.jsx("div",{className:"px-3 pb-3 font-mono text-xs",children:l?t.jsx("p",{className:"text-fg-muted italic",children:o??"Not applicable for this packet type"}):c})})]})})})}const je={connected:"green",degraded:"amber",offline:"red"};function Ne({packet:e,isSynthetic:s}){const r=f(e=>e.wsState),n=f(e=>e.health),a=function(e,t){return t?"manual":e._stripped?"bulk-tier":b.isConnected()?"ws-push":"rest-poll"}(e,s),l=[{label:"ws-push",detail:"wsConnected && onPacket()",active:"ws-push"===a,color:"green"},{label:"rest-poll",detail:"!wsConnected, 3s interval",active:"rest-poll"===a,color:"amber"},{label:"catchup",detail:"wsReconnected, delta > 50",active:"catchup"===a,color:"amber"},{label:"bulk-tier",detail:"user extends time range â†’ gzip",active:"bulk-tier"===a,color:"blue"},{label:"manual",detail:"hex input â€” no transport",active:"manual"===a,color:"zinc"}],o=[{fn:"transport",value:a,group:"transport",color:"ws-push"===a?"green":"bulk-tier"===a?"blue":"amber"},{fn:"tier",value:e._stripped?"WARM":"HOT",group:"transport",color:"blue"},{fn:"wsState",value:r,group:"transport",color:"connected"===r?"green":"amber"},{fn:"health",value:n,group:"transport",color:je[n]}],c=s?"manual hex input":`${a} (${n})`;return t.jsx(ye,{stage:0,name:"TRANSPORT",fn:"websocketService / useStore.startPolling",verdict:c,children:s?t.jsx("p",{className:"text-fg-muted italic",children:"Manual hex input â€” no transport context"}):t.jsx(Z,{prefix:"transport",children:t.jsxs("div",{className:"space-y-0",children:[t.jsx(fe,{options:l,nextFn:"ingest()"}),t.jsx(Y,{tokens:o})]})})})}function ke({start:e,end:s}){const r=null!=s&&s!==e?`[${e}..${s}]`:`[${e}]`;return t.jsx("span",{className:"text-fg-muted text-[9px] font-mono mr-1 select-none",children:r})}const we={advert:"decodeAdvert()",ack:"decodeAck()",path:"decodePath()",trace:"decodeTraceWithSnr()",txt_msg:"decodeTextMessage()",grp_txt:"decodeGroupText()",grp_data:"decodeGroupData()",multipart:"decodeMultipart()",control:"decodeControl()",req:"decodeRequest()",response:"decodeResponse()",anon_req:"decodeAnonReq()",generic:"decodeGeneric()"};function Ce({rawHex:e,display:s,protocolPacket:r,parseError:n,parseTimeMs:a,payloadVersion:l,isV1:o,isV2:c}){return t.jsx("dl",{className:"space-y-0.5",children:s&&r&&e?t.jsxs(t.Fragment,{children:[t.jsx(X,{title:"A. Parse â€” Packet.fromHex()"}),a>0&&t.jsx("div",{className:"flex justify-end",children:t.jsx("span",{className:"font-mono text-[10px] px-1.5 py-0.5 rounded bg-sys-green/15 text-sys-green",children:a<1?`${(1e3*a).toFixed(0)}Âµs`:`${a.toFixed(2)}ms`})}),t.jsxs(Q,{label:"header byte",children:[t.jsx(ke,{start:0}),t.jsx(J,{value:e.slice(0,2)})," ",t.jsx(ee,{value:parseInt(e.slice(0,2),16)})]}),s.headerFields.map(e=>t.jsx(Q,{label:`  ${e.field}`,children:t.jsx(te,{raw:t.jsxs("span",{className:"text-[10px]",children:["bits[",e.bits,"] = ",e.binary]}),children:t.jsx("span",{className:"inline-block border border-edge-subtle rounded px-2 py-0.5 font-mono text-[11px] text-sys-amber",children:e.value})})},e.field)),t.jsx(Q,{label:"  version",children:null!=l?t.jsxs("span",{className:"inline-flex items-center gap-1.5",children:[t.jsx(se,{fn:"payloadVer",value:`${l}`,color:"amber"}),t.jsx(v,{color:o?"green":c?"blue":"zinc",children:o?"v1":c?"v2":`v${l}`}),o&&t.jsx("span",{className:"text-fg-muted text-[10px]",children:"1-byte hashes, 2-byte MAC"}),c&&t.jsx("span",{className:"text-sys-blue text-[10px]",children:"2-byte hashes, 4-byte MAC (speculative)"})]}):t.jsx("span",{className:"text-fg-muted",children:"unknown"})}),t.jsx(X,{title:"Wire Framing"}),t.jsx(Q,{label:"transportCodes",children:s.transportCodesHex?t.jsxs("span",{className:"inline-flex items-center gap-1",children:[t.jsx(ke,{start:1,end:4}),t.jsx(se,{fn:"transport",value:s.transportCodesHex,color:"amber"})]}):t.jsx("span",{className:"text-fg-muted",children:"N/A (non-transport route)"})}),t.jsx(Q,{label:"pathLen",children:t.jsx(te,{raw:t.jsxs(t.Fragment,{children:[t.jsx(ke,{start:s.pathLenByteOffset}),t.jsx(J,{value:s.pathLengthHex})]}),children:t.jsxs("span",{className:"inline-flex items-center gap-1",children:[t.jsx(ke,{start:s.pathLenByteOffset}),t.jsx(se,{fn:"pathLen",value:`${r.pathLen} hop${1!==r.pathLen?"s":""}`,color:"amber"})]})})}),t.jsx(Q,{label:"path",children:t.jsxs("span",{className:"inline-flex items-center gap-1",children:[r.pathLen>0&&t.jsx(ke,{start:s.pathByteOffset,end:s.pathByteOffset+r.pathLen-1}),t.jsx(re,{hops:r.pathHexArray,hexPrefix:s.pathDataHex||void 0})]})}),t.jsx(Q,{label:"payloadLen",children:t.jsxs("span",{className:"inline-flex items-center gap-1",children:[t.jsx(ke,{start:s.payloadByteOffset,end:s.payloadByteOffset+s.payloadHex.length/2-1}),t.jsx(se,{fn:"payloadLen",value:s.payloadHex.length/2+" bytes",color:"amber"})]})}),t.jsx(Q,{label:"payloadHex",children:t.jsx("span",{className:"inline-block border border-edge-subtle rounded px-2 py-0.5 font-mono text-[11px] text-sys-amber break-all",children:s.payloadHex})})]}):t.jsxs(t.Fragment,{children:[t.jsx(X,{title:"A. Parse"}),t.jsxs(Q,{label:"result",children:[t.jsx("span",{className:"inline-block border border-edge-subtle rounded px-2 py-0.5 font-mono text-[11px] text-sys-amber",children:"Skipped"}),t.jsx("span",{className:"ml-1 text-fg-muted",children:n??"No raw_packet (warm-tier)"})]})]})})}function Se({decoded:e,packet:s}){if(!e)return t.jsxs(t.Fragment,{children:[t.jsx(X,{title:"B. Decode"}),t.jsx("p",{className:"text-fg-muted italic text-[10px]",children:"No decoded payload"})]});const r=we[e.type]??`decode${e.type}()`;return t.jsxs(t.Fragment,{children:[t.jsx(X,{title:"B. Decode â€” decodePayload()"}),t.jsx(Z,{prefix:"decodePayload",children:t.jsxs("dl",{className:"space-y-0.5",children:[t.jsx(Q,{label:"dispatched",children:r}),t.jsx(X,{}),t.jsx(_e,{decoded:e,packet:s})]})})]})}function _e({decoded:e,packet:s}){switch(e.type){case"advert":return t.jsxs(t.Fragment,{children:[t.jsx(Q,{label:"publicKey",children:t.jsx(te,{raw:t.jsx("span",{className:"text-[10px] break-all",children:e.publicKey}),children:t.jsx(se,{fn:"publicKey",value:e.publicKey,color:"green"})})}),t.jsx(Q,{label:"timestamp",children:t.jsx(se,{fn:"timestamp",value:String(e.timestamp),color:"green"})}),t.jsx(Q,{label:"flags",children:t.jsx(te,{raw:t.jsx(J,{value:e.flags}),children:t.jsx(se,{fn:"flags",value:e.flagsDescription,color:"green"})})}),t.jsx(Q,{label:"nodeType",children:t.jsx(se,{fn:"nodeType",value:e.nodeType,color:"green"})}),null!=e.latitude&&t.jsx(Q,{label:"latitude",children:t.jsx(se,{fn:"lat",value:e.latitude.toFixed(6),color:"green"})}),null!=e.longitude&&t.jsx(Q,{label:"longitude",children:t.jsx(se,{fn:"lon",value:e.longitude.toFixed(6),color:"green"})}),e.name&&t.jsx(Q,{label:"name",children:t.jsx(se,{fn:"name",value:e.name,color:"green"})})]});case"ack":return t.jsx(Q,{label:"crc",children:t.jsx(te,{raw:t.jsx("span",{className:"text-[10px]",children:e.crc}),children:t.jsx(se,{fn:"crc",value:e.crc,color:"green"})})});case"trace":{const r=(null==s?void 0:s.src_hash)?s.src_hash.replace(/^0x/i,"").slice(0,2).toUpperCase():null;return t.jsxs(t.Fragment,{children:[t.jsx(Q,{label:"traceTag",children:t.jsx(se,{fn:"traceTag",value:e.traceTag,color:"green"})}),t.jsx(Q,{label:"authCode",children:t.jsx(se,{fn:"authCode",value:String(e.authCode),color:"green"})}),t.jsx(Q,{label:"flags",children:t.jsx(J,{value:e.flags})}),t.jsx(Q,{label:"target path",children:e.pathHashes.length>0?t.jsx(re,{hops:e.pathHashes.map(e=>e.toUpperCase()),color:"green"}):t.jsx("span",{className:"text-fg-muted italic",children:"âˆ… empty"})}),t.jsx(Q,{label:"complete",children:e.isComplete?t.jsxs("span",{className:"text-sys-green",children:["âœ“ all ",e.pathHashes.length," hops reported SNR"]}):t.jsxs("span",{className:"text-sys-amber",children:["âœ— ",e.snrValues.length,"/",e.pathHashes.length," hops reported"]})}),t.jsx(X,{}),t.jsxs("div",{children:[t.jsx("p",{className:"text-fg-muted mb-1 text-[10px]",children:"Directional Edge SNR â€” per-hop link quality"}),0===e.snrValues.length?t.jsx("p",{className:"text-fg-muted italic text-[11px] ml-2",children:"No SNR values in path field"}):t.jsx("div",{className:"space-y-0.5 ml-2",children:e.snrValues.map((s,n)=>{var a,l,o,c,i;const d=(null==(a=e.pathHashes[n])?void 0:a.toUpperCase())??"??",p=0===n?r??"SRC":(null==(l=e.pathHashes[n-1])?void 0:l.toUpperCase())??"??",u=null==(i=null==(c=null==(o=N.getState().stats)?void 0:o.config)?void 0:c.radio)?void 0:i.spreading_factor,x=h(s,u);return t.jsxs("div",{className:"flex items-center gap-1.5 text-[11px] font-mono",children:[t.jsx("span",{className:"text-fg-muted w-3 text-right",children:n}),t.jsx("span",{className:"text-fg-primary",children:p}),t.jsx("span",{className:"text-fg-muted",children:"â†’"}),t.jsx("span",{className:"text-fg-primary",children:d}),t.jsx("span",{className:"text-fg-muted",children:"@"}),t.jsxs("span",{className:"font-bold text-sys-green",children:[s>0?"+":"",s.toFixed(1)," dB"]}),t.jsx(v,{color:"green",children:x})]},n)})})]})]})}case"path":return t.jsxs(t.Fragment,{children:[t.jsx(Q,{label:"pathLength",children:t.jsx(se,{fn:"pathLength",value:String(e.pathLength),color:"green"})}),t.jsx(Q,{label:"path",children:e.path&&e.path.length>0?t.jsx(re,{hops:e.path.map(e=>e.toUpperCase()),color:"green"}):t.jsx("span",{className:"text-fg-muted italic",children:"âˆ… empty"})}),null!=e.extraType&&t.jsx(Q,{label:"extraType",children:t.jsx(se,{fn:"extraType",value:e.extraTypeName??String(e.extraType),color:"purple"})}),e.extraData&&t.jsxs(Q,{label:"extraData",children:[t.jsx("span",{className:"break-all text-[10px] font-mono",children:e.extraData}),t.jsxs("span",{className:"text-fg-muted ml-1",children:["(",e.extraData.length/2,"B)"]})]})]});case"txt_msg":return t.jsxs(t.Fragment,{children:[t.jsx(Q,{label:"destHash",children:t.jsx(te,{raw:t.jsx(J,{value:e.destHash}),children:t.jsx(se,{fn:"destHash",value:e.destHash,color:"green"})})}),t.jsx(Q,{label:"srcHash",children:t.jsx(te,{raw:t.jsx(J,{value:e.srcHash}),children:t.jsx(se,{fn:"srcHash",value:e.srcHash,color:"green"})})}),t.jsx(Q,{label:"cipherMac",children:t.jsx(se,{fn:"cipherMac",value:e.cipherMac,color:"purple"})}),t.jsx(Q,{label:"timestamp",children:t.jsx(se,{fn:"timestamp",value:String(e.timestamp),color:"green"})}),t.jsx(Q,{label:"text",children:t.jsx(se,{fn:"text",value:e.text,color:"green"})}),t.jsx(Q,{label:"encrypted",children:t.jsx(se,{fn:"encrypted",value:String(e.encrypted),color:"green"})})]});case"grp_txt":return t.jsxs(t.Fragment,{children:[t.jsx(Q,{label:"channelHash",children:t.jsx(J,{value:e.channelHash})}),e.channelName&&t.jsx(Q,{label:"channelName",children:t.jsx(se,{fn:"channel",value:e.channelName,color:"green"})}),t.jsx(Q,{label:"decrypted",children:t.jsx(se,{fn:"decrypted",value:String(e.decrypted),color:"green"})}),e.text&&t.jsx(Q,{label:"text",children:t.jsx(se,{fn:"text",value:e.text,color:"green"})}),e.senderName&&t.jsx(Q,{label:"senderName",children:t.jsx(se,{fn:"sender",value:e.senderName,color:"green"})}),e.macCorrupted&&t.jsx(Q,{label:"macCorrupted",children:t.jsx(se,{fn:"macCorrupted",value:"true",color:"green"})})]});case"grp_data":return t.jsxs(t.Fragment,{children:[t.jsx(Q,{label:"channelHash",children:t.jsx(J,{value:e.channelHash})}),t.jsx(Q,{label:"dataLength",children:e.dataLength}),t.jsx(Q,{label:"decrypted",children:String(e.decrypted)})]});case"multipart":return t.jsxs(t.Fragment,{children:[t.jsx(Q,{label:"messageId",children:e.messageId}),t.jsxs(Q,{label:"part",children:[e.partNumber+1," / ",e.totalParts]})]});case"control":return t.jsxs(t.Fragment,{children:[t.jsx(Q,{label:"controlType",children:t.jsx(te,{raw:t.jsx(J,{value:e.controlType}),children:t.jsx(se,{fn:"controlType",value:e.subtypeName,color:"green"})})}),t.jsx(Q,{label:"subtype",children:t.jsx(se,{fn:"subtype",value:`0x${e.subtype.toString(16).padStart(2,"0")}`,color:"green"})}),t.jsx(Q,{label:"subtypeFlags",children:t.jsx(se,{fn:"subtypeFlags",value:`0x${e.subtypeFlags.toString(16).padStart(2,"0")}`,color:"green"})}),e.dataLength>0&&t.jsxs(Q,{label:"data",children:[t.jsx("span",{className:"break-all text-[10px] font-mono",children:e.dataHex}),t.jsxs("span",{className:"text-fg-muted ml-1",children:["(",e.dataLength,"B)"]})]})]});case"req":case"response":return t.jsxs(t.Fragment,{children:[t.jsx(Q,{label:"destHash",children:t.jsx(te,{raw:t.jsx(J,{value:e.destHash}),children:t.jsx(se,{fn:"destHash",value:e.destHash,color:"green"})})}),t.jsx(Q,{label:"srcHash",children:t.jsx(te,{raw:t.jsx(J,{value:e.srcHash}),children:t.jsx(se,{fn:"srcHash",value:e.srcHash,color:"green"})})}),t.jsx(Q,{label:"cipherMac",children:t.jsx(se,{fn:"cipherMac",value:e.cipherMac,color:"purple"})}),t.jsxs(Q,{label:"ciphertext",children:[t.jsx("span",{className:"break-all text-[10px] font-mono",children:e.ciphertextHex}),t.jsxs("span",{className:"text-fg-muted ml-1",children:["(",e.ciphertextLength,"B)"]})]})]});case"anon_req":return t.jsxs(t.Fragment,{children:[t.jsx(Q,{label:"destHash",children:t.jsx(te,{raw:t.jsx(J,{value:e.destHash}),children:t.jsx(se,{fn:"destHash",value:e.destHash,color:"green"})})}),t.jsx(Q,{label:"senderPubKey",children:t.jsx("span",{className:"break-all text-[10px] font-mono text-sys-green",children:e.senderPublicKey})}),t.jsx(Q,{label:"cipherMac",children:t.jsx(se,{fn:"cipherMac",value:e.cipherMac,color:"purple"})}),t.jsxs(Q,{label:"ciphertext",children:[t.jsx("span",{className:"break-all text-[10px] font-mono",children:e.ciphertextHex}),t.jsxs("span",{className:"text-fg-muted ml-1",children:["(",e.ciphertextLength,"B)"]})]})]});case"generic":return t.jsxs(t.Fragment,{children:[t.jsxs(Q,{label:"payloadType",children:[t.jsx(ne,{value:e.payloadType})," (",e.payloadTypeName,")"]}),t.jsx(Q,{label:"length",children:e.length}),t.jsx(Q,{label:"rawHex",children:t.jsx("span",{className:"break-all",children:e.rawHex})})]});default:return t.jsx("p",{className:"text-fg-muted",children:"Unknown decoded type"})}}function He({protocolPacket:s,packetHash:r}){const n=null==s?void 0:s.payloadType,a=n===k||n===w,l=e.useMemo(()=>{if(!a||!s)return null;const e=s.payload;return e.length<4?null:{channelHash:e[0],mac:e.slice(1,3),ciphertext:e.slice(3)}},[s,a]),[o,c]=e.useState("pending"),[i,d]=e.useState([]),[p,u]=e.useState(0);e.useEffect(()=>{if(!l)return void c(null);let e=!1;return(async()=>{const t=performance.now(),s=await C(l.channelHash,l.mac,l.ciphertext);e||(c(s),u(performance.now()-t));const r=await S(l.channelHash);e||d(r)})(),()=>{e=!0}},[l]);const[h,x]=e.useState(""),[m,g]=e.useState(null),[f,b]=e.useState(!1),v=e.useCallback(async()=>{if(l&&h.trim()){b(!0);try{const e=await y(h.trim(),l.channelHash,l.mac,l.ciphertext);if(e.success){const t=new TextDecoder("utf-8",{fatal:!1}).decode(e.result.plaintext.slice(5));g({success:!0,text:t})}else g({success:!1,error:e.error})}catch(e){g({success:!1,error:String(e)})}finally{b(!1)}}},[l,h]),N=j(r);return a&&l?t.jsxs(t.Fragment,{children:[t.jsx(X,{title:"C. Decrypt â€” tryDecryptGroupMessage()"}),p>0&&t.jsx("div",{className:"flex justify-end",children:t.jsx("span",{className:"font-mono text-[10px] px-1.5 py-0.5 rounded bg-sys-green/15 text-sys-green",children:p<1?`${(1e3*p).toFixed(0)}Âµs`:`${p.toFixed(2)}ms`})}),t.jsx(Z,{prefix:"tryDecryptGroupMessage",children:t.jsxs("dl",{className:"space-y-0.5",children:[t.jsx(Q,{label:"channelHash",children:t.jsx(se,{fn:"channelHash",value:`0x${l.channelHash.toString(16).toUpperCase().padStart(2,"0")}`,color:"teal"})}),t.jsx(Q,{label:"mac",children:t.jsx(se,{fn:"mac",value:Array.from(l.mac).map(e=>e.toString(16).padStart(2,"0")).join(""),color:"teal"})}),t.jsx(Q,{label:"cipherLen",children:t.jsx(se,{fn:"cipherLen",value:`${l.ciphertext.length}B`,color:"teal"})}),t.jsx(Q,{label:"candidates",children:t.jsx(se,{fn:"candidates",value:i.length>0?`${i.length} names`:"0",color:i.length>0?"teal":"zinc"})}),i.length>0&&t.jsxs("details",{className:"mt-1",children:[t.jsx("summary",{className:"text-fg-muted cursor-pointer hover:text-fg-primary text-[10px]",children:"show candidate names"}),t.jsx("div",{className:"mt-1 text-[10px] text-fg-muted break-all max-h-24 overflow-y-auto",children:i.join(", ")})]}),t.jsx(X,{}),t.jsxs("div",{children:[t.jsx("p",{className:"text-fg-muted mb-1",children:"Result:"}),"pending"===o?t.jsx("p",{className:"text-fg-muted italic",children:"decryptingâ€¦"}):o?t.jsxs(t.Fragment,{children:[t.jsx(Q,{label:"channel",children:t.jsx(se,{fn:"channel",value:o.channelName,color:"teal"})}),t.jsx(Q,{label:"plaintext",children:t.jsx(se,{fn:"plaintext",value:new TextDecoder("utf-8",{fatal:!1}).decode(o.plaintext.slice(5)).trim()||"(empty)",color:"teal"})}),t.jsx(Q,{label:"macValid",children:t.jsx(se,{fn:"macValid",value:o.macCorrupted?"false":"true",color:"teal"})})]}):t.jsxs(Q,{label:"decrypt",children:[t.jsx(se,{fn:"decrypt",value:"failed",color:"red"}),t.jsx("span",{className:"text-fg-muted ml-1",children:"channel not in known list"})]})]}),t.jsx(X,{}),t.jsxs("div",{children:[t.jsx("p",{className:"text-fg-muted mb-1",children:"testChannelName() â€” manual test:"}),t.jsxs("div",{className:"flex gap-1.5 items-center",children:[t.jsx("input",{type:"text",value:h,onChange:e=>{x(e.target.value),g(null)},onKeyDown:e=>"Enter"===e.key&&v(),placeholder:"channel name",className:"surface-input px-2 py-1 rounded text-[11px] font-mono text-fg-primary w-40"}),t.jsx("button",{onClick:v,disabled:f||!h.trim(),className:"px-2 py-1 rounded text-[10px] font-mono bg-sys-blue/20 text-sys-blue hover:bg-sys-blue/30 disabled:opacity-40 transition-colors",children:f?"â€¦":"Try"})]}),m&&t.jsx("div",{className:"mt-1",children:m.success?t.jsx(Q,{label:"result",children:t.jsx(se,{fn:"plaintext",value:m.text??"(empty)",color:"teal"})}):t.jsx(Q,{label:"error",children:t.jsx(se,{fn:"error",value:m.error??"unknown",color:"red"})})})]}),t.jsx(X,{}),t.jsxs("div",{children:[t.jsx("p",{className:"text-fg-muted mb-1",children:"useDecodedMessage() store result:"}),N?N.decoded?t.jsxs(t.Fragment,{children:[t.jsx(Q,{label:"channel",children:t.jsx(se,{fn:"channel",value:N.decoded.channelName??"?",color:"teal"})}),t.jsx(Q,{label:"text",children:t.jsx(se,{fn:"text",value:N.decoded.text,color:"teal"})})]}):t.jsx(Q,{label:"decrypt",children:t.jsx(se,{fn:"decrypt",value:"failed",color:"red"})}):t.jsx(Q,{label:"decrypt",children:t.jsx(se,{fn:"decrypt",value:"pending",color:"zinc"})})]})]})})]}):null}function Te(e){const{rawHex:s,display:r,protocolPacket:n,decoded:a,parseError:l,parseTimeMs:o,payloadVersion:c,isV1:i,isV2:d,packetHash:p,packet:u}=e,h=!!s&&s.length>=4;return t.jsxs(x,{children:[t.jsx(m,{className:"w-full mt-2 mb-1",children:t.jsxs("div",{className:"flex items-center gap-2 min-w-0",children:[t.jsx("span",{className:"text-[10px] font-mono text-fg-muted",children:"ðŸ”¬"}),t.jsx("span",{className:"text-[10px] font-mono font-medium text-fg-muted",children:"Wire Inspection"}),t.jsx("span",{className:"text-[9px] text-fg-muted/50",children:"observatory diagnostic â€” not a runtime stage"})]})}),t.jsx(g,{children:t.jsxs("div",{className:"border border-dashed border-edge-subtle rounded-lg p-3 space-y-1 bg-surface/30",children:[t.jsx("p",{className:"text-[9px] text-fg-muted/50 mb-2",children:"The backend parsed these fields server-side. This panel verifies the wire-level encoding client-side."}),h?t.jsxs(t.Fragment,{children:[t.jsx(Ce,{rawHex:s,display:r,protocolPacket:n,parseError:l,parseTimeMs:o,payloadVersion:c,isV1:i,isV2:d}),t.jsx(Se,{decoded:a,packet:u}),t.jsx(He,{protocolPacket:n,packetHash:p})]}):t.jsx("p",{className:"text-fg-muted italic text-[10px]",children:l??"No raw_packet â€” wire inspection unavailable (warm-tier packet)"})]})})]})}function $e(e){if(!e)return[{fn:"decode",value:"no raw_packet",group:"decode",color:"zinc"}];switch(e.type){case"advert":{const t=e,s=[{fn:"decode.nodeType",value:t.nodeType,group:"decode",color:"blue"}];return t.name&&s.push({fn:"decode.name",value:t.name,group:"decode",color:"blue"}),null!=t.latitude&&null!=t.longitude&&s.push({fn:"decode.location",value:`${t.latitude.toFixed(4)}, ${t.longitude.toFixed(4)}`,group:"decode",color:"blue"}),s.push({fn:"decode.publicKey",value:t.publicKey,group:"decode",color:"blue"}),s}case"trace":{const t=e;return[{fn:"decode.traceTag",value:t.traceTag,group:"decode",color:"blue"},{fn:"decode.hops",value:t.pathHashes.length>0?t.pathString:"empty",group:"decode",color:"blue"},{fn:"decode.snr",value:t.snrValues.length>0?`${t.snrValues.length} values`:"none",group:"decode",color:t.snrValues.length>0?"blue":"zinc"},{fn:"decode.complete",value:t.isComplete?"yes":"partial",group:"decode",color:t.isComplete?"green":"amber"}]}case"path":{const t=e,s=[{fn:"decode.pathLength",value:String(t.pathLength),group:"decode",color:"blue"},{fn:"decode.path",value:t.path.length>0?t.pathString:"empty",group:"decode",color:"blue"}];return null!=t.extraType&&s.push({fn:"decode.extraType",value:t.extraTypeName??String(t.extraType),group:"decode",color:"purple"}),t.extraData&&s.push({fn:"decode.extraData",value:t.extraData.length/2+"B",group:"decode",color:"purple"}),s}case"ack":return[{fn:"decode.crc",value:e.crc,group:"decode",color:"blue"}];case"grp_txt":return[{fn:"decode.channelHash",value:e.channelHash,group:"decode",color:"blue"},{fn:"decode.encrypted",value:"true â€” decrypt at cascade",group:"decode",color:"zinc"}];case"grp_data":{const t=e;return[{fn:"decode.channelHash",value:t.channelHash,group:"decode",color:"blue"},{fn:"decode.dataLength",value:`${t.dataLength}B`,group:"decode",color:"blue"}]}case"txt_msg":{const t=e;return[{fn:"decode.srcHash",value:t.srcHash,group:"decode",color:"blue"},{fn:"decode.destHash",value:t.destHash,group:"decode",color:"blue"},{fn:"decode.encrypted",value:t.encrypted?"true":"false",group:"decode",color:t.encrypted?"zinc":"green"},...t.encrypted?[]:[{fn:"decode.text",value:t.text,group:"decode",color:"blue"}]]}case"multipart":{const t=e;return[{fn:"decode.part",value:`${t.partNumber+1}/${t.totalParts}`,group:"decode",color:"blue"},{fn:"decode.msgId",value:t.messageId,group:"decode",color:"blue"}]}case"control":{const t=e;return[{fn:"decode.subtype",value:t.subtypeName,group:"decode",color:"blue"},{fn:"decode.subtypeFlags",value:`0x${t.subtypeFlags.toString(16)}`,group:"decode",color:"blue"},{fn:"decode.dataLength",value:`${t.dataLength}B`,group:"decode",color:"blue"}]}case"req":{const t=e;return[{fn:"decode.destHash",value:t.destHash,group:"decode",color:"blue"},{fn:"decode.srcHash",value:t.srcHash,group:"decode",color:"blue"},{fn:"decode.cipherMac",value:t.cipherMac,group:"decode",color:"purple"},{fn:"decode.ciphertext",value:`${t.ciphertextLength}B`,group:"decode",color:"zinc"}]}case"response":{const t=e;return[{fn:"decode.destHash",value:t.destHash,group:"decode",color:"blue"},{fn:"decode.srcHash",value:t.srcHash,group:"decode",color:"blue"},{fn:"decode.cipherMac",value:t.cipherMac,group:"decode",color:"purple"},{fn:"decode.ciphertext",value:`${t.ciphertextLength}B`,group:"decode",color:"zinc"}]}case"anon_req":{const t=e;return[{fn:"decode.destHash",value:t.destHash,group:"decode",color:"blue"},{fn:"decode.senderPubKey",value:t.senderPublicKey,group:"decode",color:"green"},{fn:"decode.cipherMac",value:t.cipherMac,group:"decode",color:"purple"},{fn:"decode.ciphertext",value:`${t.ciphertextLength}B`,group:"decode",color:"zinc"}]}case"generic":return[{fn:"decode.raw",value:`${e.length}B`,group:"decode",color:"zinc"}];default:return[]}}function Pe({packet:s,pipeline:r,rawHex:n,traceTagIndex:a,neighbors:l}){const{enrichment:o,timing:c,display:i,protocolPacket:d,decoded:p,parseError:u,payloadVersion:h,isV1:x,isV2:m,analysis:g}=r,f=(s.type??s.payload_type)===_,b=g.dupeAnalysis,y=e.useRef(0),j=e.useMemo(()=>{if(!f)return null;const e=performance.now(),t=function(e,t,s){let r=e._traceTag;if(!r&&e.payload&&(r=q(e.payload)),!r)return{traceTag:null,siblingCount:0,isLocallyOriginated:!1,method:"none",confidence:"none",inferredSrc:null,inferredName:null,evidence:[],thisPathLen:0,minPathLen:0,firstHopPrefix:null,evidence:["no traceTag â€” cannot correlate"]};const n=t.get(r)??[],a=e=>null!=e.path_length?e.path_length:Array.isArray(e.original_path)?e.original_path.length:0,l=a(e),o=n.length>0?Math.min(...n.map(a)):l,c=e.payload?e.payload.slice(18):"",i=c.length>=2?c.slice(0,2).toUpperCase():null,d=[];if(d.push(`traceTag: ${r}`),d.push(`siblings: ${n.length} observation${1!==n.length?"s":""}`),"tx_local"===e.packet_origin)return d.push("packet_origin = tx_local â†’ we initiated this trace"),{traceTag:r,siblingCount:n.length,isLocallyOriginated:!0,method:"tx_local",confidence:"certain",inferredSrc:"LOCAL",inferredName:null,evidence:d,thisPathLen:l,minPathLen:o,firstHopPrefix:i};const p=n.find(e=>"tx_local"===e.packet_origin);if(p)return d.push(`sibling (hash ${p.packet_hash}) has packet_origin = tx_local`),{traceTag:r,siblingCount:n.length,isLocallyOriginated:!0,method:"tx_local",confidence:"certain",inferredSrc:"LOCAL",inferredName:null,evidence:d,thisPathLen:l,minPathLen:o,firstHopPrefix:i};if(d.push(`this observation: path_len=${l}, min across siblings: ${o}`),i){if(d.push(`first hop in target path: ${i}`),0===l)return d.push("path_len = 0 â†’ heard directly from initiator (no SNR appended yet)"),d.push("initiator is a direct RF neighbor"),{traceTag:r,siblingCount:n.length,isLocallyOriginated:!1,method:"min_path_len",confidence:"speculative",inferredSrc:null,inferredName:null,evidence:[...d,"initiator is within direct RF range (zero forwarding hops)"],thisPathLen:l,minPathLen:o,firstHopPrefix:i};const e=Object.entries(s).filter(([e])=>e.replace(/^0x/i,"").slice(0,2).toUpperCase()===i);if(1===e.length){const[t,s]=e[0],a=s.name||s.node_name||null;return d.push(`first hop ${i} â†’ unique neighbor: ${a??t}`),d.push("initiator is whoever sent TO this first hop"),{traceTag:r,siblingCount:n.length,isLocallyOriginated:!1,method:"first_hop_neighbor",confidence:"likely",inferredSrc:i,inferredName:a,evidence:d,thisPathLen:l,minPathLen:o,firstHopPrefix:i}}e.length>1?d.push(`first hop ${i} matches ${e.length} neighbors (ambiguous)`):d.push(`first hop ${i} is not a known neighbor`)}return d.push("insufficient data to identify initiator"),{traceTag:r,siblingCount:n.length,isLocallyOriginated:!1,method:"none",confidence:"none",inferredSrc:null,inferredName:null,evidence:d,thisPathLen:l,minPathLen:o,firstHopPrefix:i}}(s,a,l);return y.current=performance.now()-e,t},[s,a,l,f]),N=c.enrich+y.current,k=[];g.byteLen&&k.push(`${g.byteLen}B`),k.push(g.payloadTypeName),o.advertName&&k.push(`"${o.advertName}"`),o.isZeroHop?k.push("zero-hop"):g.pathHopCount>0&&k.push(`${g.pathHopCount}h`),k.push(`${s.rssi}dBm`),b.isDuplicate&&k.push("DUPE");const w=k.join(" â€” ");return t.jsxs(ye,{stage:1,name:"INGEST",fn:o.preComputed?"PacketCache.mergePackets()":"extractAdvertData() + extractHopData() + ...",verdict:w,timeMs:N,children:[t.jsx(Te,{rawHex:n,display:i,protocolPacket:d,decoded:p,parseError:u,parseTimeMs:c.parse,payloadVersion:h,isV1:x,isV2:m,packetHash:s.packet_hash,packet:s}),t.jsx(X,{title:"Cache Enrichment"}),t.jsx(Z,{prefix:"packetCache",children:t.jsxs("dl",{className:"space-y-0.5",children:[t.jsxs("div",{className:"mb-1.5",children:[o.preComputed?t.jsx(v,{color:"green",children:"PacketCache"}):t.jsx(v,{color:"amber",children:"computed"}),t.jsx("span",{className:"text-[10px] text-fg-muted ml-1.5",children:o.preComputed?"pre-enriched by real pipeline":"synthetic â€” computed on the fly"})]}),t.jsxs("div",{className:"flex flex-wrap gap-x-2 gap-y-1 mb-1",children:[t.jsx(se,{fn:"_byteLength",value:null!=o.byteLength?`${o.byteLength}B`:void 0,color:"blue"}),t.jsx(se,{fn:"_hopCount",value:String(o.hopCount),color:"blue"}),t.jsx(se,{fn:"_isZeroHop",value:String(o.isZeroHop),color:o.isZeroHop?"green":"blue"}),o.isZeroHop&&t.jsx(v,{color:"blue",children:"direct"}),null!=o.channelHash&&t.jsx(se,{fn:"_channelHash",value:o.channelHash,color:"blue"}),f&&s._traceTag&&t.jsx(se,{fn:"_traceTag",value:s._traceTag,color:"blue"})]}),o.advertSender||null!=o.advertNodeType||null!=o.advertName?t.jsxs("div",{className:"mt-1 mb-1",children:[t.jsx("p",{className:"text-[10px] text-sys-blue font-medium mb-0.5",children:"ADVERT Enrichment"}),t.jsxs("div",{className:"flex flex-wrap gap-x-2 gap-y-1",children:[o.advertSender&&t.jsx(se,{fn:"_advertSender",value:o.advertSender.slice(0,16)+"â€¦",color:"blue"}),null!=o.advertNodeType&&t.jsx(se,{fn:"_advertNodeType",value:ie(o.advertNodeType),color:"blue"}),null!=o.advertName&&t.jsx(se,{fn:"_advertName",value:o.advertName,color:"blue"}),null!=o.advertFlags&&t.jsx(se,{fn:"_advertFlags",value:`0x${o.advertFlags.toString(16).padStart(2,"0")}`,color:"blue"}),null!=o.advertHasLocation&&t.jsx(se,{fn:"_advertHasLocation",value:String(o.advertHasLocation),color:"blue"}),null!=o.advertHasName&&t.jsx(se,{fn:"_advertHasName",value:String(o.advertHasName),color:"blue"}),null!=o.advertLatitude&&null!=o.advertLongitude&&t.jsx(se,{fn:"location",value:`${o.advertLatitude.toFixed(4)}, ${o.advertLongitude.toFixed(4)}`,color:"blue"})]})]}):t.jsx("p",{className:"text-[10px] text-fg-muted/30 mb-1",children:"ADVERT fields: N/A (non-ADVERT packet)"}),t.jsx(X,{title:"Payload Decode"}),t.jsxs("div",{children:[t.jsxs("div",{className:"flex items-center gap-1.5 mb-1",children:[t.jsx("span",{className:"w-1.5 h-1.5 rounded-full shrink-0 "+(p?"bg-sys-blue":"bg-zinc-500/40")}),t.jsx("span",{className:"font-mono text-[10px] font-medium text-fg-primary",children:"decodePayload()"}),t.jsx("span",{className:"text-[9px] text-fg-muted",children:"sync â€” wire data only, no crypto"})]}),t.jsx("div",{className:"ml-3",children:p?t.jsx("div",{className:"flex flex-wrap gap-x-1.5 gap-y-1",children:$e(p).map((e,s)=>t.jsx("span",{className:"inline-block border border-edge-subtle rounded px-1.5 py-0.5",children:t.jsx(se,{fn:e.fn,value:e.value,color:e.color})},s))}):t.jsx(ae,{children:"no raw_packet â€” warm-tier packet, decode unavailable"})})]}),t.jsx(X,{}),t.jsxs("div",{className:"flex flex-wrap items-center gap-x-3 gap-y-1 text-[11px] font-mono",children:[t.jsx("span",{className:"text-fg-muted",children:"dupe:"}),b.isDuplicate?t.jsx(se,{fn:"is_duplicate",value:"true",color:"purple"}):t.jsx(ae,{children:"none"}),b.dupeCount>0&&t.jsx(se,{fn:"dupeCount",value:`Ã—${b.dupeCount}`,color:"purple"}),b.rssiRange&&t.jsxs(ae,{c:"text-fg-primary",children:["Î”",Math.abs(b.rssiRange[1]-b.rssiRange[0]),"dB RSSI"]})]}),j&&t.jsxs(t.Fragment,{children:[t.jsx(X,{}),t.jsxs("div",{className:"flex flex-wrap items-center gap-x-3 gap-y-1 text-[11px] font-mono",children:[t.jsx("span",{className:"text-fg-muted",children:"TRACE SRC:"}),j.inferredSrc?t.jsxs(t.Fragment,{children:[t.jsx(se,{fn:"inferredSrc",value:j.inferredSrc,color:"purple"}),j.inferredName&&t.jsx(se,{fn:"name",value:j.inferredName,color:"purple"})]}):t.jsx(ae,{children:"unresolvable"}),t.jsx(le,{color:"purple",children:j.method}),t.jsxs(ae,{children:["(",j.confidence,")"]}),t.jsxs(ae,{children:["siblings=",j.siblingCount]})]})]}),(()=>{const e=null!=g.pType?`0x${g.pType.toString(16).toUpperCase().padStart(2,"0")}`:void 0,r=null!=s.route?`0x${s.route.toString(16).toUpperCase().padStart(2,"0")}`:void 0,n=$e(p),a="excellent"===g.signalClass||"good"===g.signalClass?"green":"fair"===g.signalClass?"amber":"red",l="pubkey"===g.senderTier?"green":"prefix"===g.senderTier?"amber":"encrypted"===g.senderTier?"teal":"zinc",c=[{fn:"type",value:g.payloadTypeName,raw:e,group:"wire",color:"blue"},{fn:"route",value:g.routeTypeName,raw:r,group:"wire",color:"blue"},{fn:"src_hash",value:s.src_hash||void 0,group:"wire",color:"blue"},{fn:"rssi",value:`${s.rssi}dBm`,group:"wire",color:"blue"},{fn:"snr",value:`${s.snr}dB`,group:"wire",color:"blue"},{fn:"_byteLength",value:g.byteLen?`${g.byteLen}B`:void 0,group:"enrichment",color:"blue"},{fn:"_hopCount",value:String(o.hopCount),group:"enrichment",color:"blue"},{fn:"_isZeroHop",value:String(o.isZeroHop),group:"enrichment",color:"blue"},{fn:"_advertSender",value:o.advertSender||void 0,group:"enrichment",color:"blue"},{fn:"_advertNodeType",value:"unknown"!==g.advertType?g.advertType:void 0,group:"enrichment",color:"blue"},{fn:"_advertName",value:o.advertName||void 0,group:"enrichment",color:"blue"},{fn:"_channelHash",value:o.channelHash||void 0,group:"enrichment",color:"blue"},...n,{fn:"is_duplicate",value:String(b.isDuplicate),group:"analysis",color:"purple"},(null==j?void 0:j.inferredSrc)?{fn:"traceSrc",value:j.inferredSrc,group:"analysis",color:"purple"}:{fn:"traceSrc"},{fn:"_signalClass",value:g.signalClass,group:"analysis",color:a},{fn:"_routeClass",value:g.routeClass,group:"analysis",color:"purple"},{fn:"_senderTier",value:g.senderTier,group:"analysis",color:l},{fn:"_origin",value:g.origin,group:"analysis",color:"tx_local"===g.origin?"green":"tx_forward"===g.origin?"amber":"purple"},{fn:"_pathAvail",value:g.pathAvail?`${g.pathHopCount} hops`:"none",group:"analysis",color:g.pathAvail?"green":"zinc"},{fn:"_age",value:g.age,group:"analysis",color:"live"===g.age||"recent"===g.age?"green":"zinc"},...b.dupeCount>0?[{fn:"_dupeCount",value:`Ã—${b.dupeCount}`,group:"analysis",color:"purple"},...b.rssiRange?[{fn:"_multipath",value:`Î”${Math.abs(b.rssiRange[1]-b.rssiRange[0])}dB`,group:"analysis",color:Math.abs(b.rssiRange[1]-b.rssiRange[0])>6?"amber":"green"}]:[]]:[],...null!=s.lbt_attempts?[{fn:"_lbt",value:`${s.lbt_attempts} attempt${1!==s.lbt_attempts?"s":""}`,group:"analysis",color:(s.lbt_attempts??0)>1?"amber":"green"}]:[],...s.drop_reason?[{fn:"_dropReason",value:s.drop_reason,group:"analysis",color:"red"}]:[]];return t.jsx(Y,{tokens:c})})()]})})]})}function Le(e){switch(e){case"excellent":case"good":return"green";case"fair":return"amber";case"poor":case"critical":return"red";default:return"zinc"}}function Me(e){return`${Math.round(100*e)}%`}function De(e,t,s){return e||(t?t.slice(0,12):`~${s}`)}function Fe({hops:e}){return 0===e.length?null:t.jsxs("div",{className:"mt-2 pt-2 border-t border-edge-subtle/40",children:[t.jsx("p",{className:"text-[9px] text-fg-muted/40 uppercase tracking-widest font-mono mb-1.5",children:"per-hop trace inspection"}),t.jsx("div",{className:"space-y-1",children:e.map(e=>t.jsx(Z,{prefix:`trace.hop[${e.hopIndex}]`,children:t.jsxs("div",{className:"border border-edge-subtle/40 rounded px-2 py-1.5",children:[t.jsxs(Q,{label:"link",children:[t.jsx(re,{hops:[e.fromPrefix,e.toPrefix],color:"blue"}),t.jsx("span",{className:"ml-1.5",children:t.jsx(le,{color:Le(e.quality),children:e.quality})})]}),t.jsx(Q,{label:"snr",children:t.jsx(te,{raw:t.jsx("span",{className:"text-sys-blue",children:e.snrRaw}),children:t.jsx(se,{fn:"snr",value:`${e.snrRaw.toFixed(1)} dB`,color:Le(e.quality)})})}),t.jsxs(Q,{label:"from",children:[t.jsx(se,{fn:"resolve",value:De(e.fromName,e.fromHash,e.fromPrefix),color:e.fromHash?e.fromConfidence>=.8?"green":"amber":"purple"}),t.jsx("span",{className:"ml-1",children:t.jsx(se,{fn:"conf",value:Me(e.fromConfidence),color:"zinc"})})]}),t.jsxs(Q,{label:"to",children:[t.jsx(se,{fn:"resolve",value:De(e.toName,e.toHash,e.toPrefix),color:e.toHash?e.toConfidence>=.8?"green":"amber":"purple"}),t.jsx("span",{className:"ml-1",children:t.jsx(se,{fn:"conf",value:Me(e.toConfidence),color:"zinc"})})]})]})},e.hopIndex))}),t.jsx(Y,{label:"trace contributes",tokens:Re(e)})]})}function Re(e){const t=e.reduce((e,t)=>e+(t.fromHash?1:0)+(t.toHash?1:0),0),s=2*e.length,r=s-t,n=e.length>0?e.reduce((e,t)=>e+t.snrRaw,0)/e.length:0;return[{fn:"hops",value:String(e.length),group:"wire",color:"blue"},{fn:"resolved",value:`${t}/${s}`,group:"worker",color:"green"},...r>0?[{fn:"ghosts",value:String(r),group:"worker",color:"purple"}]:[],{fn:"avgSnr",value:`${n.toFixed(1)} dB`,group:"analysis",color:n>=5?"green":n>=0?"amber":"red"}]}function Ae(e){if(!e)return"never";const t=Math.floor((Date.now()-e)/1e3);return t<60?`${t}s ago`:t<3600?`${Math.floor(t/60)}m ago`:`${Math.floor(t/3600)}h ago`}function ze({packet:e,decrypted:r,pipeline:n}){var a;const l=H(e=>e.isComputing),o=H(e=>e.lastUpdated),c=H(e=>e.lastComputeTimeMs),i=H(e=>e.topology.edges.length),d=H(e=>e.topology.discoveredNodes.length),p=T(),u=$(),h=P(),f=L(e=>e.isComputing),b=L(e=>e.nodeCount),v=M(e=>e.progress),y=M(e=>e.initialDecodeComplete),j=e.type??e.payload_type,N=j===s.GRP_TXT||j===s.GRP_DATA,k=j===s.TRACE,w=j===s.PATH,C=N,S=[{label:"full",detail:"all GRP_TXT â†’ decryption worker",active:C&&y,color:"teal"},{label:"quick",detail:"100 most recent (initial load)",active:C&&!y,color:"amber"},{label:"skip",detail:"non-GRP or catchup path",active:!C,color:"zinc"}],_=function(e){if(!e)return[];const t=e.decoded;if(!t)return[{fn:"decrypt.result",value:"failed",group:"crypto",color:"red"}];if(!t.decrypted)return[{fn:"decrypt.result",value:"no key match",group:"crypto",color:"zinc"}];const s=[];return t.channelName&&s.push({fn:"decrypt.channelName",value:t.channelName,group:"crypto",color:"teal"}),t.senderName&&s.push({fn:"decrypt.senderName",value:t.senderName,group:"crypto",color:"teal"}),t.text&&s.push({fn:"decrypt.text",value:t.text,group:"crypto",color:"teal"}),t.timestamp&&s.push({fn:"decrypt.timestamp",value:new Date(1e3*t.timestamp).toISOString().slice(11,19),group:"crypto",color:"teal"}),t.macCorrupted&&s.push({fn:"decrypt.macCorrupted",value:"true",group:"crypto",color:"amber"}),s}(r),D=!0===(null==(a=null==r?void 0:r.decoded)?void 0:a.decrypted),F=`topo ${l?"â—‹":"âœ“"} ${l?"running":`${i}e ${d}g`} Â· spark ${f?"â—‹":"âœ“"} ${f?"running":`${b}n`} Â· decrypt ${C?D?"decrypted":v.isDecoding?`${v.percent}%`:"pending":"N/A"}`;return t.jsx(ye,{stage:2,name:"CASCADE",fn:"hydrateDownstream()",verdict:F,children:t.jsx(Z,{prefix:"cascade",children:t.jsxs("div",{className:"space-y-0",children:[t.jsxs("div",{className:"flex flex-wrap items-center gap-x-4 gap-y-1 py-1.5 text-[11px] font-mono",children:[t.jsxs("span",{className:"inline-flex items-center gap-1",children:[t.jsx("span",{className:"w-1.5 h-1.5 rounded-full "+(l?"bg-sys-amber animate-pulse":"bg-sys-green")}),t.jsx("span",{className:"text-fg-primary",children:"topology"}),t.jsxs("span",{className:"text-fg-muted",children:[i,"e ",d,"g"]}),(k||w)&&t.jsx("span",{className:"text-sys-green text-[9px]",children:"â†‘signal"})]}),t.jsxs("span",{className:"inline-flex items-center gap-1",children:[t.jsx("span",{className:"w-1.5 h-1.5 rounded-full "+(f?"bg-sys-amber animate-pulse":"bg-sys-green")}),t.jsx("span",{className:"text-fg-primary",children:"sparkline"}),t.jsxs("span",{className:"text-fg-muted",children:[b,"n"]})]}),t.jsxs("span",{className:"inline-flex items-center gap-1",children:[t.jsx("span",{className:"w-1.5 h-1.5 rounded-full "+(v.isDecoding?"bg-sys-amber animate-pulse":C?"bg-sys-teal":"bg-zinc-500/40")}),t.jsx("span",{className:"text-fg-primary",children:"decrypt"}),t.jsx("span",{className:C?"text-sys-teal":"text-fg-muted",children:C?D?"decrypted":v.isDecoding?`${v.percent}%`:"pending":"N/A"})]})]}),t.jsxs(x,{defaultOpen:k||w,children:[t.jsx(m,{className:"text-[10px] w-full border-t border-edge-subtle pt-1.5",children:t.jsx("span",{className:"font-mono text-fg-muted/50",children:"topology detailâ€¦"})}),t.jsx(g,{children:t.jsxs("div",{className:"ml-3 pb-2",children:[t.jsx(Q,{label:"status",children:t.jsx(se,{fn:"isComputing",value:l?"running":"idle",color:l?"amber":"green"})}),t.jsxs(Q,{label:"last",children:[t.jsx(se,{fn:"lastUpdated",value:Ae(o),color:"zinc"}),c>0&&t.jsxs("span",{className:"ml-2 text-fg-muted text-[10px]",children:["(",c<1e3?`${c.toFixed(0)}ms`:`${(c/1e3).toFixed(1)}s`,")"]})]}),t.jsxs(Q,{label:"output",children:[t.jsx(se,{fn:"edges",value:String(i),color:"green"}),t.jsx(se,{fn:"ghostNodes",value:String(d),color:"purple"})]}),u&&t.jsxs(t.Fragment,{children:[t.jsxs(Q,{label:"trace links",children:[t.jsx(se,{fn:"directed",value:String(p.totalDirectedLinks),color:"teal"}),t.jsx(se,{fn:"bidir",value:String(p.bidirectionalLinks),color:"teal"}),t.jsx(se,{fn:"traces",value:String(p.totalTraces),color:"zinc"})]}),t.jsxs(Q,{label:"trace SNR",children:[t.jsx(se,{fn:"mean",value:`${p.meanSnr.toFixed(1)} dB`,color:p.meanSnr>=5?"green":p.meanSnr>=0?"amber":"red"}),t.jsx(se,{fn:"median",value:`${p.medianSnr.toFixed(1)} dB`,color:"zinc"}),t.jsx(se,{fn:"confidence",value:`${Math.round(100*p.avgConfidence)}%`,color:"zinc"})]}),k&&t.jsxs(Q,{label:"quality",children:[t.jsx(se,{fn:"excellent",value:String(p.qualityCounts.excellent),color:"green"}),t.jsx(se,{fn:"good",value:String(p.qualityCounts.good),color:"green"}),t.jsx(se,{fn:"fair",value:String(p.qualityCounts.fair),color:"amber"}),t.jsx(se,{fn:"poor",value:String(p.qualityCounts.poor),color:"red"}),t.jsx(se,{fn:"critical",value:String(p.qualityCounts.critical),color:"red"})]}),h.confirmedResolutions.size>0&&t.jsxs(Q,{label:"feedback",children:[t.jsx(se,{fn:"feedback.confirmed",value:String(h.confirmedResolutions.size),color:"teal"}),t.jsx(se,{fn:"feedback.links",value:String(h.confirmedLinks.length),color:"teal"})]})]}),k&&(null==n?void 0:n.traceHopDetail)&&t.jsx(Fe,{hops:n.traceHopDetail})]})})]}),C&&t.jsx("div",{className:"border-t border-edge-subtle pt-2 pb-2",children:t.jsxs("div",{className:"ml-3",children:[t.jsx(Q,{label:"mode",children:t.jsx(fe,{options:S,nextFn:"queueDecryption()"})}),t.jsx(Q,{label:"result",children:t.jsx(se,{fn:"decrypt",value:D?"decrypted":r?"failed":"pending",color:D?"teal":r?"red":"zinc"})}),D&&t.jsx("div",{className:"mt-1 flex flex-wrap gap-x-1.5 gap-y-1",children:_.map((e,s)=>t.jsx("span",{className:"inline-block border border-edge-subtle rounded px-1.5 py-0.5",children:t.jsx(se,{fn:e.fn,value:e.value,color:e.color})},s))})]})}),(()=>{const e=[{fn:"topology.edges",value:String(i),group:"worker",color:"green"},{fn:"topology.ghostNodes",value:String(d),group:"worker",color:"purple"},{fn:"sparkline.nodes",value:`${b}`,group:"worker",color:"green"},...u?[{fn:"trace.directedLinks",value:String(p.totalDirectedLinks),group:"worker",color:"teal"},{fn:"trace.meanSnr",value:`${p.meanSnr.toFixed(1)} dB`,group:"worker",color:"teal"}]:[],..._];return t.jsx(Y,{tokens:e})})()]})})})}function Ee({packet:s,pipeline:r,resolved:n,resolveTimeMs:a,advertName:l,neighbors:o,decrypted:c}){var i,d;const p=I(e=>e.neighborContext),u=I(e=>e.topologyProfiles),h=I(e=>e.config),{analysis:f}=r,b=n??{hash:null,type:"unknown",name:null,confident:!1},y=s.src_hash?D(s.src_hash):"",j=y?p.prefixIndex.get(y)??[]:[],N=y?u.get(y)??[]:[],k=f.pType??-1,w=k>=0?k.toString(16).toUpperCase().padStart(2,"0"):"??",C=f.inferredType,S=f.advertType,_=f.effectiveType,H=null!=s._advertNodeType?s._advertNodeType.toString(16).padStart(2,"0").toUpperCase():"",T=(null==(i=null==c?void 0:c.decoded)?void 0:i.senderName)??null,$=function(e,t,s,r){var n;const a=e.src_hash?D(e.src_hash):"";if(e._advertSender&&t.hash&&t.confident)return{tier:1,label:"_advertSender â†’ pubkey",detail:"ADVERT carried full 32-byte public key â€” definitive match"};if(r&&t.confident&&(null==(n=t.name)?void 0:n.toLowerCase())===r.toLowerCase())return{tier:1.5,label:"decrypt.senderName â†’ nameToHash",detail:`Decrypted sender name â€œ${r}â€ matched neighbor â€” high-confidence`};if(a&&s.crossClassPrefixes.has(a))return{tier:2,label:"cross-class prefix",detail:"Prefix has mixed types (repeater + non-repeater); payload type narrows to one class"};if(t.confident){const e=s.prefixIndex.get(a);return 1===(null==e?void 0:e.length)?{tier:3,label:"single candidate",detail:"Only one node matches this prefix â€” unambiguous"}:{tier:3,label:"resolver",detail:"Multi-signal scoring selected best candidate from collision set"}}return{tier:4,label:"ambiguous",detail:"Cannot confidently resolve â€” multiple same-class candidates, insufficient scoring separation"}}(s,b,p,T),P=e.useMemo(()=>function(e,t){const s=e.original_path??e.forwarded_path,r=new Set;if(s&&Array.isArray(s))for(const n of s){const e=String(n).toUpperCase().slice(0,2);e.length>=2&&e!==t&&r.add(e)}return r}(s,y),[s,y]),L=f.pathLen,M=e.useMemo(()=>function(e,t,s,r,n,a,l){const o=Math.floor(Date.now()/1e3),c=new Map(s.map(e=>[e.hash,e]));return e.map(e=>{const s=t[e.hash],i=c.get(e.hash);let d=!0,p="";"unknown"!==r?"unknown"!==e.type&&e.type!==r?(d=!1,p=`${e.type} â‰  required ${r}`):p=e.type===r?"type matches":"type unknown â€” not ruled out":p="payload ambiguous â€” all types eligible";const u=!!(null==s?void 0:s.zero_hop),h=(null==s?void 0:s.last_seen)??0;let x=0;if(u&&h>0){const e=(o-h)/3600;x=50*Math.exp(-e/l)}let m=0;if(h>0){const e=(o-h)/3600;m=Math.exp(-e/a)}const g=20*m,f=!(!(null==s?void 0:s.latitude)||!(null==s?void 0:s.longitude)||0===s.latitude&&0===s.longitude),b=f?5:0,v=(null==i?void 0:i.advertCount)??0,y=Math.min(2*v,30),j=(null==i?void 0:i.forwarderPrefixes.size)??0,N=Math.min(3*j,15);let k=0;if(i&&i.totalForwarderObservations>0&&n.size>0){let e=0;for(const t of n)i.forwarderPrefixes.has(t)&&e++;k=e/n.size}const w=x+g+b+y+N;return{hash:e.hash,name:e.name,type:e.type,roleCompatible:d,roleReason:p,zeroHop:u,zeroHopScore:x,lastSeen:h,recencyScore:m,recencyPoints:g,hasGps:f,gpsScore:b,advertCount:v,advertScore:y,topoWidth:j,topoScore:N,affinity:k,total:w}}).sort((e,t)=>t.total-e.total)}(j,o,N,_,P,h.recencyDecayHours,h.zeroHopDecayHours),[j,o,N,_,P,h.recencyDecayHours,h.zeroHopDecayHours]),F=M.filter(e=>!e.roleCompatible),R=M.filter(e=>e.roleCompatible),A=s._advertSender?p.pubKeyMap.get(s._advertSender)??null:null,z=1===$.tier,E=[{fn:"src_hash",value:y||"",active:!!y,color:"blue"},{fn:"_advertSender",value:s._advertSender?s._advertSender.slice(0,12)+"â€¦":"",active:!!s._advertSender,color:"blue"},{fn:"_advertNodeType",value:H?`0x${H}`:"",active:null!=s._advertNodeType,color:"blue"},{fn:"path_length",value:null!=L?0===L?"zero-hop":String(L):"",active:null!=L,color:"blue"},{fn:"decrypt.senderName",value:T??"",active:!!T,color:"teal"}],B=[{label:"hit",detail:"pubKeyMap.get(_advertSender) â†’ definitive",active:!!A,color:"green"},{label:"miss",detail:s._advertSender?"pubkey not in neighbor table":"no _advertSender",active:!A,color:"zinc"}],O=[{label:"payload",detail:`inferDeviceType(0x${w}) â†’ ${C}`,active:"unknown"!==C,color:"amber"},{label:"flags",detail:H?`mapAdvertTypeCode(0x${H}) â†’ ${S}`:"no _advertNodeType",active:"unknown"===C&&"unknown"!==S,color:"green"},{label:"ambiguous",detail:"all types eligible",active:"unknown"===_,color:"zinc"}],V=`â†’ ${b.name??(null==(d=b.hash)?void 0:d.slice(0,12))??"?"} (${b.confident?"confident":"ambiguous"}, Tier ${$.tier})`;return t.jsx(ye,{stage:3,name:"RESOLVE",fn:"usePipelineStore.resolveSource()",verdict:V,timeMs:a,children:t.jsx(Z,{prefix:"resolvePacketSource",children:t.jsxs("div",{className:"space-y-0",children:[t.jsx("div",{className:"pt-1 pb-1",children:t.jsx(be,{tokens:E,nextFn:"resolvePacketSource()"})}),s.src_hash?t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"border-t border-edge-subtle pt-2 pb-2",children:[t.jsxs("p",{className:"text-fg-muted mb-1",children:[t.jsx(ae,{c:"text-sys-blue font-bold",children:"1"})," ","PUBKEY LOOKUP"]}),t.jsx(fe,{options:B,nextFn:"pubKeyMap.get()"}),t.jsx("div",{className:"ml-3 mt-1",children:A?t.jsxs(t.Fragment,{children:[t.jsx(Q,{label:"resolved",children:t.jsx(se,{fn:"hash",value:A,color:"green"})}),l&&t.jsxs(Q,{label:"name",children:[t.jsx(se,{fn:"name",value:l,color:"green"}),b.name&&l===b.name&&t.jsx(ae,{c:"text-sys-green ml-1",children:"âœ“ neighbor match"})]}),t.jsxs(Q,{label:"result",children:[t.jsx(v,{color:"green",children:"Tier 1"}),t.jsx(ae,{c:"text-fg-primary ml-1",children:"definitive â€” scoring bypassed"})]})]}):s._advertSender?t.jsx(Q,{label:"status",children:t.jsx(ae,{c:"text-sys-amber",children:"âœ— pubkey not in neighbor table"})}):t.jsx(Q,{label:"status",children:t.jsx(ae,{children:"no _advertSender â€” skip to prefix resolution"})})})]}),z?t.jsx("div",{className:"border-t border-edge-subtle py-2",children:t.jsx("p",{className:"text-[11px] text-fg-muted/40 font-mono ml-3",children:"Steps 2â€“5 bypassed â€” pubkey definitive"})}):t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"border-t border-edge-subtle pt-2 pb-2",children:[t.jsxs("p",{className:"text-fg-muted mb-1",children:[t.jsx(ae,{c:"text-sys-blue font-bold",children:"2"})," ","CANDIDATE POOL â€” ",j.length," node",1!==j.length?"s":"",' match "',y,'"']}),t.jsxs("div",{className:"space-y-0.5 ml-3",children:[M.map(e=>t.jsxs("div",{className:"flex gap-2 items-center text-[11px]",children:[t.jsx("span",{className:"break-all text-[10px]",children:e.hash}),t.jsx(v,{color:"zinc",children:e.type||"unknown"}),e.name&&t.jsx(ae,{children:e.name})]},e.hash)),0===j.length&&t.jsx(ae,{children:"no known nodes for this prefix"})]})]}),t.jsxs("div",{className:"border-t border-edge-subtle pt-2 pb-2",children:[t.jsxs("p",{className:"text-fg-muted mb-1",children:[t.jsx(ae,{c:"text-sys-blue font-bold",children:"3"})," ","TYPE INFERENCE"]}),t.jsx(fe,{options:O,nextFn:"effectiveType()"}),t.jsx("div",{className:"ml-3 mt-1",children:t.jsx(Q,{label:"effective",children:t.jsx(se,{fn:"effectiveType",value:_,color:"unknown"!==_?"unknown"!==C?"amber":"green":"zinc"})})})]}),t.jsxs("div",{className:"border-t border-edge-subtle pt-2 pb-2",children:[t.jsxs("p",{className:"text-fg-muted mb-1",children:[t.jsx(ae,{c:"text-sys-blue font-bold",children:"4"})," ","ROLE-TYPE SCRUB"]}),t.jsx("div",{className:"space-y-0.5 ml-3",children:M.map(e=>t.jsxs("div",{className:"flex gap-2 items-center text-[11px]",children:[t.jsx("span",{className:e.roleCompatible?"text-sys-green":"text-sys-red",children:e.roleCompatible?"âœ“":"âœ—"}),t.jsx("span",{className:"break-all text-[10px] "+(e.roleCompatible?"":"line-through text-fg-muted"),children:e.hash}),t.jsx(v,{color:e.roleCompatible?"zinc":"red",children:e.type||"unknown"}),t.jsx(ae,{c:e.roleCompatible?"text-fg-muted":"text-sys-red",children:e.roleReason})]},e.hash))}),F.length>0&&t.jsxs("p",{className:"text-[10px] text-fg-muted mt-1 ml-3",children:[F.length," eliminated, ",R.length," surviving"]})]}),t.jsxs("div",{className:"border-t border-edge-subtle pt-2 pb-2",children:[t.jsxs("p",{className:"text-fg-muted mb-1",children:[t.jsx(ae,{c:"text-sys-blue font-bold",children:"5"})," ","CANDIDATE SCORING"]}),0===R.length?t.jsx("p",{className:"text-fg-muted italic ml-3",children:"No surviving candidates"}):1===R.length?t.jsxs("div",{className:"ml-3 text-[11px]",children:[t.jsxs("div",{className:"flex gap-2 items-center",children:[t.jsx(ae,{c:"text-sys-green",children:"â†’"}),t.jsx("span",{className:"break-all text-[10px]",children:R[0].hash}),R[0].name&&t.jsx(ae,{c:"text-fg-muted ml-1",children:R[0].name})]}),t.jsx("p",{className:"text-fg-muted ml-4",children:"single survivor â€” scoring not needed"})]}):t.jsxs(x,{children:[t.jsx(m,{className:"text-[10px] ml-3",children:t.jsxs("span",{className:"font-mono text-fg-muted/50",children:[R.length," candidates scoredâ€¦"]})}),t.jsx(g,{children:t.jsx("div",{className:"space-y-2 ml-3 mt-1",children:R.map(e=>{const s=e.hash===b.hash;return t.jsxs("div",{className:"text-[11px] leading-relaxed rounded px-2 py-1 "+(s?"bg-sys-green/8 border border-sys-green/20":"bg-zinc-500/5"),children:[t.jsxs("div",{className:"flex gap-2 items-center mb-0.5",children:[t.jsx(ae,{c:s?"text-sys-green":"text-fg-muted",children:s?"â†’":" "}),t.jsx("span",{className:"break-all text-[10px] "+(s?"text-fg-primary":"text-fg-muted"),children:e.hash}),t.jsx(v,{color:s?"green":"zinc",children:e.type||"unknown"}),e.name&&t.jsx(ae,{children:e.name})]}),t.jsxs("div",{className:"ml-4 flex flex-wrap gap-x-3 gap-y-0.5",children:[t.jsxs("span",{children:[t.jsx(ae,{children:"zero_hop:"})," ",t.jsx(ae,{c:e.zeroHop?"text-sys-green":"text-fg-muted",children:e.zeroHop?"âœ“":"âœ—"})," ",t.jsxs(v,{color:oe(e.zeroHopScore),children:["+",e.zeroHopScore]})]}),t.jsxs("span",{children:[t.jsx(ae,{children:"recency:"})," ",t.jsx(ae,{c:"text-fg-primary",children:ce(e.lastSeen)})," ",t.jsxs(v,{color:oe(e.recencyPoints),children:["+",e.recencyPoints.toFixed(1)]})]}),t.jsxs("span",{children:[t.jsx(ae,{children:"gps:"})," ",t.jsx(ae,{c:e.hasGps?"text-sys-green":"text-fg-muted",children:e.hasGps?"âœ“":"âœ—"})," ",t.jsxs(v,{color:oe(e.gpsScore),children:["+",e.gpsScore]})]}),t.jsxs("span",{children:[t.jsx(ae,{children:"adverts:"})," ",t.jsx(ae,{c:"text-fg-primary",children:e.advertCount})," ",t.jsxs(v,{color:oe(e.advertScore),children:["+",e.advertScore]})]}),t.jsxs("span",{children:[t.jsx(ae,{children:"topo:"})," ",t.jsx(ae,{c:"text-fg-primary",children:e.topoWidth})," ",t.jsxs(v,{color:oe(e.topoScore),children:["+",e.topoScore]})]})]}),t.jsxs("div",{className:"ml-4 mt-0.5",children:[t.jsx(ae,{children:"score â‰ˆ"})," ",t.jsx(ae,{c:"text-fg-primary font-bold",children:e.total.toFixed(1)})]})]},e.hash)})})})]})]})]}),t.jsxs("div",{className:"border-t border-edge-subtle pt-2 pb-2",children:[t.jsxs("p",{className:"text-fg-muted mb-1",children:[t.jsx(ae,{c:"text-sys-green font-bold",children:"âœ“"})," ","RESOLUTION"]}),t.jsxs("div",{className:"ml-3",children:[t.jsx(Q,{label:"hash",children:b.hash?t.jsx(se,{fn:"resolved.hash",value:b.hash,color:"green"}):t.jsx(ae,{children:"null"})}),t.jsx(Q,{label:"type",children:t.jsx(se,{fn:"resolved.type",value:b.type,color:b.confident?"green":"zinc"})}),t.jsx(Q,{label:"name",children:b.name?t.jsx(se,{fn:"resolved.name",value:b.name,color:b.confident?"green":"amber"}):t.jsx(ae,{children:"null"})}),t.jsx(Q,{label:"confident",children:t.jsx(ae,{c:b.confident?"text-sys-green":"text-sys-red",children:String(b.confident)})}),t.jsxs(Q,{label:"tier",children:[t.jsx(v,{color:$.tier<=2?"green":3===$.tier?"amber":"red",children:$.tier}),t.jsx(ae,{c:"text-fg-primary ml-1",children:$.label})]})]})]})]}):t.jsx("div",{className:"border-t border-edge-subtle pt-2 pb-2",children:t.jsxs("div",{className:"flex flex-wrap items-center gap-x-3 gap-y-1 text-[11px] font-mono",children:[t.jsx(ae,{c:"text-sys-amber",children:"âš  no src_hash"}),T&&t.jsx(se,{fn:"decrypt.senderName",value:T,color:"teal"}),b.confident?t.jsxs(ae,{c:"text-sys-green",children:["â†’ resolved via ",$.label]}):t.jsx(ae,{c:"text-sys-red",children:"ambiguous"})]})}),(()=>{const e=[{fn:"resolved.hash",value:b.hash??"null",group:"resolution",color:b.confident?"green":"zinc"},{fn:"resolved.type",value:b.type,group:"resolution",color:"unknown"!==b.type?b.confident?"green":"amber":"zinc"},{fn:"resolved.name",value:b.name??"null",group:"resolution",color:b.confident?"green":b.name?"amber":"zinc"},{fn:"resolved.confident",value:String(b.confident),group:"resolution",color:b.confident?"green":"red"}];return t.jsx(Y,{tokens:e})})()]})})})}const Be=[{id:"packet-parse",label:"Packet Parse",inputs:["rawPacket"],outputs:["parsedPacket","decoded","headerFields"],emits:[{fn:"routeType",group:"wire",color:"blue"},{fn:"payloadType",group:"wire",color:"blue"},{fn:"pathLength",group:"wire",color:"blue"},{fn:"version",group:"wire",color:"blue"}],async:!1,observatoryStage:0},{id:"enrichment",label:"Ingestion Enrichment",inputs:["parsedPacket"],outputs:["advertSender","channelHash","hopData","byteLength"],emits:[{fn:"_advertSender",group:"enrichment",color:"blue"},{fn:"_advertNodeType",group:"enrichment",color:"blue"},{fn:"_channelHash",group:"enrichment",color:"blue"},{fn:"_hopCount",group:"enrichment",color:"blue"},{fn:"_isZeroHop",group:"enrichment",color:"blue"},{fn:"_byteLength",group:"enrichment",color:"blue"}],async:!1,observatoryStage:1},{id:"topology",label:"Topology Analysis",inputs:["packets","neighbors","srcHashResolver"],outputs:["edges","nodeMetrics","pathHealth","ghostNodes","centrality","loops"],emits:[{fn:"edges",group:"worker",color:"green"},{fn:"ghostNodes",group:"worker",color:"purple"},{fn:"loops",group:"analysis",color:"amber"},{fn:"nodeMetrics",group:"worker",color:"green"},{fn:"pathHealth",group:"worker",color:"green"},{fn:"centrality",group:"worker",color:"green"}],async:!0,worker:"topology.worker.ts",observatoryStage:2},{id:"trace-enrichment",label:"Trace Link Quality",inputs:["packets","prefixLookup","srcHashResolver","edges","pathHealth","nodeMetrics"],outputs:["traceLinks","traceLinkSummary","traceDisambiguationFeedback"],emits:[{fn:"traceLinks.directed",group:"worker",color:"teal"},{fn:"traceLinks.bidir",group:"worker",color:"teal"},{fn:"traceSummary.meanSnr",group:"analysis",color:"green"},{fn:"traceSummary.medianSnr",group:"analysis",color:"zinc"},{fn:"traceSummary.confidence",group:"analysis",color:"zinc"},{fn:"feedback.confirmed",group:"worker",color:"teal"},{fn:"feedback.links",group:"worker",color:"teal"}],async:!1,observatoryStage:2},{id:"disambiguation",label:"Source Disambiguation",inputs:["packets","neighbors","decodedMessages"],outputs:["srcHashResolverMap","neighborContext"],emits:[{fn:"resolvedHash",group:"resolution",color:"purple"},{fn:"resolvedName",group:"resolution",color:"purple"},{fn:"resolvedType",group:"resolution",color:"purple"},{fn:"confidence",group:"resolution",color:"green"}],async:!1,observatoryStage:3},{id:"sparkline",label:"Sparkline Computation",inputs:["packets","neighbors"],outputs:["sparklineData"],emits:[{fn:"sparklines",group:"worker",color:"blue"}],async:!0,worker:"sparkline.worker.ts"},{id:"decryption",label:"Channel Decryption",inputs:["packets","channelKeys"],outputs:["decodedMessages"],emits:[{fn:"decrypt.text",group:"crypto",color:"teal"},{fn:"decrypt.senderName",group:"crypto",color:"teal"},{fn:"decrypt.channelName",group:"crypto",color:"teal"},{fn:"decrypt.macCorrupted",group:"crypto",color:"amber"}],async:!0,worker:"decryption.worker.ts",observatoryStage:2},{id:"decoded-content",label:"Decoded Content Policy",inputs:["decodedMessages","packets"],outputs:["decodedContent","contentInheritance"],emits:[{fn:"content.senderName",group:"crypto",color:"teal"},{fn:"content.text",group:"crypto",color:"teal"},{fn:"content.channelName",group:"crypto",color:"teal"},{fn:"content.corrupted",group:"crypto",color:"amber"},{fn:"content.inherited",group:"analysis",color:"purple"}],async:!1}],Oe=new Map(Be.map(e=>[e.id,e])),Ve=new Map;for(const pt of Be)for(const e of pt.emits)Ve.set(e.fn,pt);const Ie=new Map;for(const pt of Be)for(const e of pt.outputs)Ie.set(e,pt);const Ue={0:"text-sys-green",1:"text-sys-blue",2:"text-sys-teal",3:"text-sys-purple"};function qe({stage:e,isActive:s,onClick:r}){const n=null!=e.observatoryStage?Ue[e.observatoryStage]??"text-fg-muted":"text-fg-muted/40";return t.jsxs("button",{type:"button",onClick:r,className:`\n        flex items-center gap-1.5 w-full px-1.5 py-1 rounded transition-base text-left\n        ${s?"bg-sys-blue/10 ring-1 ring-sys-blue/30":"hover:bg-zinc-500/5"}\n      `,children:[t.jsx("span",{className:`font-mono text-[9px] font-bold w-3 shrink-0 text-center ${n}`,children:e.observatoryStage??"Â·"}),t.jsx("span",{className:"font-mono text-[9px] text-fg-primary truncate flex-1",children:e.label}),e.async&&t.jsx("span",{className:"font-mono text-[7px] px-1 py-px rounded bg-sys-amber/15 text-sys-amber shrink-0 leading-tight",children:"âš¡"}),e.emits.length>0&&t.jsxs("span",{className:"flex items-center gap-px shrink-0",children:[e.emits.slice(0,6).map(e=>{var s;return t.jsx("span",{className:`inline-block w-1 h-1 rounded-full ${(null==(s=W[e.color])?void 0:s.dot)??"bg-zinc-500"}`,title:`${e.fn} [${e.group}]`},e.fn)}),e.emits.length>6&&t.jsxs("span",{className:"font-mono text-[7px] text-fg-muted/40 ml-0.5",children:["+",e.emits.length-6]})]})]})}function Ge({activeStageId:s,onStageClick:r}){const n=e.useMemo(()=>function(){const e=new Map,t=new Map;for(const n of Be)e.has(n.id)||e.set(n.id,0),t.has(n.id)||t.set(n.id,new Set);for(const n of Be)for(const s of n.inputs){const r=Ie.get(s);if(r&&r.id!==n.id){const s=t.get(r.id);s.has(n.id)||(s.add(n.id),e.set(n.id,(e.get(n.id)??0)+1))}}const s=[];for(const[n,a]of e)0===a&&s.push(n);const r=[];for(;s.length>0;){const n=s.shift(),a=Oe.get(n);a&&r.push(a);for(const r of t.get(n)??[]){const t=(e.get(r)??1)-1;e.set(r,t),0===t&&s.push(r)}}for(const n of Be)r.includes(n)||r.push(n);return r}(),[]),a=e.useMemo(()=>{const e=new Map;for(const s of n){const t=s.observatoryStage??"other";let r=e.get(t);r||(r=[],e.set(t,r)),r.push(s)}const t=[];for(const s of[0,1,2,3,"other"]){const r=e.get(s);(null==r?void 0:r.length)&&t.push({key:s,stages:r})}return t},[n]);return t.jsxs("div",{className:"surface-base rounded-lg border border-edge-subtle p-2",children:[t.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[t.jsx("span",{className:"font-mono text-[8px] text-fg-muted/40 uppercase tracking-widest",children:"Pipeline DAG"}),t.jsxs("span",{className:"font-mono text-[8px] text-fg-muted/30",children:[n.length," stages"]})]}),t.jsx("div",{className:"space-y-px",children:a.map((e,n)=>t.jsxs("div",{children:[n>0&&t.jsx("div",{className:"flex items-center pl-2.5 py-px",children:t.jsx("svg",{width:"6",height:"8",viewBox:"0 0 6 8",className:"text-fg-muted/20",children:t.jsx("path",{d:"M3 0 L3 6 M1 4 L3 6 L5 4",fill:"none",stroke:"currentColor",strokeWidth:"1"})})}),e.stages.map(e=>t.jsx(qe,{stage:e,isActive:s===e.id,onClick:r?()=>r(e.id):void 0},e.id))]},String(e.key)))})]})}const Ke={status:"idle",lastDurationMs:null,lastTs:null,runCount:0};function We(e,t,s){var r,n,a;switch(e.type){case"transport:ws:state":t.wsState=(null==(r=e.data)?void 0:r.state)??s.wsState;break;case"transport:ws:packet":t.wsPacketCount=(t.wsPacketCount??s.wsPacketCount)+1;break;case"transport:ws:stats":t.wsStatsCount=(t.wsStatsCount??s.wsStatsCount)+1;break;case"transport:rest:stats":t.restStatsCount=(t.restStatsCount??s.restStatsCount)+1;break;case"transport:rest:packets":t.restPacketsCount=(t.restPacketsCount??s.restPacketsCount)+1;break;case"store:packets:ws-merge":t.wsMergeCount=(t.wsMergeCount??s.wsMergeCount)+1;break;case"cascade:hydrate":t.lastHydrateTs=e.ts,t.hydrateCount=(t.hydrateCount??s.hydrateCount)+1;break;case"worker:topology:start":case"worker:sparkline:start":{const r=e.type.split(":")[1],n=t.workers??s.workers,a=n[r]??{...Ke};t.workers={...n,[r]:{...a,status:"running",lastTs:e.ts}}}break;case"worker:topology:done":case"worker:sparkline:done":{const r=e.type.split(":")[1],a=t.workers??s.workers,l=a[r]??{...Ke},o=(null==(n=e.data)?void 0:n.ms)??null;t.workers={...a,[r]:{...l,status:"done",lastDurationMs:o,lastTs:e.ts,runCount:l.runCount+1}}}break;case"worker:decryption:batch":{const r=t.workers??s.workers,n=r.decryption??{...Ke},l=(null==(a=e.data)?void 0:a.ms)??null;t.workers={...r,decryption:{...n,status:"done",lastDurationMs:l,lastTs:e.ts,runCount:n.runCount+1}}}break;case"pipeline:disambig:recompute":t.disambigCount=(t.disambigCount??s.disambigCount)+1}}const Ze=pe(e=>({events:[],eventCount:0,wsState:"disconnected",wsPacketCount:0,wsStatsCount:0,restStatsCount:0,restPacketsCount:0,workers:{topology:{...Ke},sparkline:{...Ke},decryption:{...Ke}},wsMergeCount:0,lastHydrateTs:null,hydrateCount:0,disambigCount:0,lastDisambigMs:null,_pushBatch:t=>e(e=>{if(0===t.length)return e;let s=[...e.events,...t];s.length>200&&(s=s.slice(s.length-200));const r={events:s,eventCount:e.eventCount+t.length};for(const n of t)We(n,r,e);return r}),clear:()=>e({events:[],eventCount:0,wsState:"disconnected",wsPacketCount:0,wsStatsCount:0,restStatsCount:0,restPacketsCount:0,workers:{topology:{...Ke},sparkline:{...Ke},decryption:{...Ke}},wsMergeCount:0,lastHydrateTs:null,hydrateCount:0,disambigCount:0,lastDisambigMs:null})}));let Ye=null,Xe=[],Qe=null;function Je(){if(Qe=null,0===Xe.length)return;const e=Xe;Xe=[],Ze.getState()._pushBatch(e)}function et(e){switch(e){case"active":return"â—";case"skipped":return"â—‹";case"inferred":return"â—Œ"}}function tt(e){switch(e){case"active":return"text-sys-green";case"skipped":return"text-fg-muted/30";case"inferred":return"text-sys-amber"}}function st(e){switch(e){case"transport":return"text-sys-blue";case"store":return"text-sys-amber";case"worker":return"text-sys-violet";case"pipeline":return"text-sys-green";case"consumer":return"text-sys-teal"}}const rt=[],nt=["transport","store","worker","pipeline","consumer"],at={transport:"Transport",store:"Store",worker:"Workers",pipeline:"Pipeline",consumer:"Consumers"};function lt(e){return e.replace("transport:","").replace("store:packets:","").replace("cascade:","").replace("worker:","w:").replace("pipeline:","p:").replace("packet","pkt").replace("sparkline","spark").replace("topology","topo").replace("decryption","dec").replace("disambig","dis").replace("recompute","recomp")}const ot=e.memo(function({event:e}){const s=`${(e.ts/1e3).toFixed(1)}s`,r=e.data?Object.entries(e.data).map(([e,t])=>{var s;return`${e}=${"number"==typeof t?(null==(s=t.toFixed)?void 0:s.call(t,1))??t:t}`}).join(" "):"";return t.jsxs("div",{className:"flex gap-2 text-[9px] font-mono leading-tight",children:[t.jsx("span",{className:"text-fg-muted/40 w-12 shrink-0 text-right",children:s}),t.jsx("span",{className:"w-20 shrink-0 "+(n=e.type,n.startsWith("transport:")?"text-sys-blue":n.startsWith("store:")||n.startsWith("cascade:")?"text-sys-amber":n.startsWith("worker:")?"text-sys-violet":n.startsWith("pipeline:")?"text-sys-green":"text-fg-muted"),children:lt(e.type)}),t.jsx("span",{className:"text-fg-muted/60 truncate",children:r})]});var n});function ct({packet:s,pipeline:r,resolved:n,decrypted:a,isSynthetic:l,liveMode:o}){const[c,i]=e.useState(!1);e.useEffect(()=>{if(c)return Ye||(Xe=[],Ye=F.subscribe(e=>{Xe.push(e),null===Qe&&(Qe=requestAnimationFrame(Je))})),()=>{!function(){if(null==Ye||Ye(),Ye=null,null!==Qe&&(cancelAnimationFrame(Qe),Qe=null),Xe.length>0){const e=Xe;Xe=[],Ze.getState()._pushBatch(e)}}()}},[c]);const d=null==r?void 0:r.analysis,p=e.useMemo(()=>s&&d?function(e,t,s,r,n){var a,l;const o=[];if(n?o.push({label:"Hex Input",detail:"Manual hex â€” no transport",status:"skipped",lane:"transport"}):"live"===t.age||"recent"===t.age?o.push({label:"WebSocket",detail:"ws:packet â†’ real-time push",status:"active",lane:"transport"}):o.push({label:"REST Poll",detail:"fetchPackets â†’ packetCache.poll()",status:"inferred",lane:"transport"}),!n){o.push({label:"Cache Merge",detail:"packetCache.mergePacketsDirectly()",status:"active",lane:"store"});const e="live"===t.age||"recent"===t.age;o.push({label:"Flash",detail:e?"flashReceived++ â†’ sidebar blink":"Not newest â€” no flash",status:e?"active":"skipped",lane:"store"}),o.push({label:"Hydrate Cascade",detail:"hydrateDownstream() â†’ schedule workers",status:"active",lane:"store"})}const c=t.pathAvail||t.pathHopCount>0;o.push({label:"Topology Worker",detail:c?`Path data (${t.pathHopCount} hops) â†’ edge extraction`:"No path data â€” still included in batch recompute",status:"active",lane:"worker"}),o.push({label:"Sparkline Worker",detail:`Contributes to sparkline for src ${(null==(a=e.src_hash)?void 0:a.slice(0,4))??"??"}`,status:"active",lane:"worker"});const i=t.isGrp;o.push({label:"Decryption Worker",detail:i?"GRP_TXT â†’ queued for channel key search"+(r?" â†’ decrypted âœ“":""):`${t.payloadTypeName} â€” not encrypted, skipped`,status:i?"active":"skipped",lane:"worker"}),o.push({label:"Source Disambiguation",detail:s?`â†’ ${s.name??(null==(l=s.hash)?void 0:l.slice(0,8))??"?"} (${s.type}${s.confident?", confident":", ambiguous"})`:"Pending recompute",status:s?"active":"inferred",lane:"pipeline"}),t.isAdvert&&o.push({label:"ADVERT Discovery",detail:"pubkey â†’ extended hash-to-type + name extraction",status:"active",lane:"pipeline"}),i&&(null==r?void 0:r.decoded)&&o.push({label:"Decoded Content Policy",detail:`macCorrupted=${r.decoded.macCorrupted?"true":"false"} â†’ cross-hash inheritance`,status:"active",lane:"pipeline"});const d=["Packets","Dashboard","Statistics"];return c&&d.push("Map","Graph"),t.isTrace&&d.push("Trace Detail"),o.push({label:"Page Hydration",detail:d.join(", "),status:"active",lane:"consumer"}),o}(s,d,n,a,l):null,[s,d,n,a,l]),u=e.useMemo(()=>{if(!p)return null;const e=new Map;for(const t of p){let s=e.get(t.lane);s||(s=[],e.set(t.lane,s)),s.push(t)}return e},[p]),h=Ze(e=>c?e.events:rt),f=Ze(e=>c?e.eventCount:0),b=Ze(e=>e.clear),v=e.useRef(null);e.useEffect(()=>{c&&v.current&&(v.current.scrollTop=v.current.scrollHeight)},[f,c]);const y=(null==p?void 0:p.filter(e=>"active"===e.status).length)??0,j=(null==p?void 0:p.length)??0;return t.jsxs(x,{defaultOpen:!0,children:[t.jsx(m,{className:"text-[10px]",children:t.jsxs("span",{className:"flex items-center gap-2 font-mono",children:[t.jsx("span",{className:"text-sys-green",children:"CFT"}),t.jsx("span",{className:"text-fg-muted/40",children:"Control Flow Trace"}),s&&t.jsxs("span",{className:"text-fg-muted/30",children:["â€” ",y,"/",j," stages active"]})]})}),t.jsx(g,{children:t.jsxs("div",{className:"surface-base rounded-lg border border-edge-subtle p-3 space-y-3",children:[s?u?t.jsx("div",{className:"space-y-2",children:nt.map(e=>{const s=u.get(e);return s?t.jsxs("div",{children:[t.jsx("div",{className:`text-[8px] uppercase tracking-widest font-mono mb-0.5 ${st(e)}`,children:at[e]}),s.map((e,s)=>t.jsxs("div",{className:"flex items-start gap-1.5 text-[10px] font-mono leading-snug ml-1",children:[t.jsx("span",{className:`shrink-0 ${tt(e.status)}`,children:et(e.status)}),t.jsx("span",{className:"text-fg-primary",children:e.label}),t.jsx("span",{className:"text-fg-muted/50 truncate",children:e.detail})]},s))]},e):null})}):null:t.jsx("div",{className:"text-[9px] text-fg-muted/30 font-mono py-2 text-center",children:"Select a packet to trace its flow"}),t.jsxs("div",{className:"border-t border-edge-subtle pt-2 flex items-center gap-2",children:[t.jsx("button",{onClick:()=>i(e=>!e),className:"px-2 py-0.5 rounded text-[9px] font-mono transition-colors "+(c?"bg-sys-green/20 text-sys-green":"bg-zinc-500/20 text-fg-muted hover:text-fg-primary"),children:c?"â— LIVE":"â—‹ LIVE"}),t.jsx("span",{className:"text-[9px] text-fg-muted/40 font-mono",children:c?`${f} events`:"Subscribe to all pipeline events"}),c&&t.jsx("button",{onClick:b,className:"text-[9px] text-fg-muted/40 hover:text-fg-muted font-mono transition-colors ml-auto",children:"clear"})]}),c&&t.jsx("div",{ref:v,className:"max-h-32 overflow-y-auto space-y-px",children:0===h.length?t.jsx("div",{className:"text-[9px] text-fg-muted/30 font-mono py-1 text-center",children:"Waiting for eventsâ€¦"}):h.map((e,s)=>t.jsx(ot,{event:e},`${e.ts}-${s}`))})]})})]})}function it(e){const t=u(e.type??e.payload_type??-1).padEnd(7),s=e.packet_hash.slice(0,8),r=(e.src_hash??"â€”").replace(/^0x/i,"").slice(0,4).toUpperCase(),n=null!=e._hopCount?`${e._hopCount}h`:"",a=B(e.timestamp);return`${s} ${t} â†${r} ${e.rssi}dBm ${n} ${a}`}function dt(){const s=R(),r=A(),n=z(),a=(null==r?void 0:r.neighbors)??{},l=I(e=>e.resolveSource),o=I(e=>e.config),c=I(e=>e.setConfig),[i,d]=e.useState(-1),p=e.useMemo(()=>{let e=s;return-1!==i&&(e=s.filter(e=>(e.type??e.payload_type)===i)),e.slice(-50).reverse()},[s,i]),[u,h]=e.useState(""),[f,b]=e.useState(""),[v,y]=e.useState(!1),N=e.useRef(n);e.useEffect(()=>{v&&n!==N.current&&p.length>0&&(h(p[0].packet_hash),b("")),N.current=n},[n,v,p]),e.useEffect(()=>{!u&&p.length>0&&!f&&h(p[0].packet_hash)},[u,p,f]);const k=e.useMemo(()=>f.trim()?null:p.find(e=>e.packet_hash===u)??null,[u,p,f]),w=e.useMemo(()=>{const e=f.replace(/\s+/g,"").trim();return e?{packet_hash:"manual-hex-input",timestamp:0,rssi:0,snr:0,transmitted:!1,drop_reason:null,is_duplicate:!1,raw_packet:e}:null},[f]),C=k??w,S=!!f.trim(),_=f.trim().replace(/\s+/g,"")||(null==C?void 0:C.raw_packet),H=ge(C,_,s),T=(null==H?void 0:H.enrichment)??xe,$=j((null==C?void 0:C.packet_hash)??""),P=e.useRef(0),L=e.useMemo(()=>{if(!C)return null;const e=performance.now(),t=l(C);return P.current=performance.now()-e,t},[C,l]);return t.jsxs("div",{className:"max-w-[960px] mx-auto",children:[t.jsxs("div",{className:"mb-3",children:[t.jsx("h1",{className:"text-sm font-bold text-fg-primary tracking-wide font-mono",children:"PACKET OBSERVATORY"}),t.jsx("p",{className:"text-[11px] text-fg-muted font-mono",children:"Pipeline introspection â€” select a packet to trace its journey"})]}),t.jsxs("div",{className:"surface-base rounded-lg border border-edge-subtle p-3 mb-3",children:[t.jsxs("div",{className:"flex gap-2 items-center flex-wrap",children:[t.jsxs("select",{value:i,onChange:e=>{d(Number(e.target.value)),h("")},className:"surface-input px-2 py-1 rounded text-[11px] font-mono text-fg-primary w-36",children:[t.jsx("option",{value:-1,children:"ALL TYPES"}),Object.entries(E).map(([e,s])=>t.jsxs("option",{value:Number(e),children:["0x",Number(e).toString(16).toUpperCase().padStart(2,"0")," ",s]},e))]}),t.jsxs("select",{value:u,onChange:e=>{h(e.target.value),b("")},className:"surface-input flex-1 min-w-0 px-2 py-1 rounded text-[11px] font-mono text-fg-primary truncate",children:[p.map((e,s)=>t.jsx("option",{value:e.packet_hash,children:it(e)},`${e.packet_hash}-${s}`)),0===p.length&&t.jsxs("option",{value:"",children:["No packets",-1!==i?" matching filter":" loaded"]})]}),t.jsx("button",{onClick:()=>y(e=>!e),className:"px-2 py-1 rounded text-[11px] font-mono transition-colors shrink-0 "+(v?"bg-sys-green/20 text-sys-green":"bg-zinc-500/20 text-fg-muted hover:text-fg-primary"),children:v?"â— LIVE":"â—‹ LIVE"})]}),t.jsxs(x,{children:[t.jsx(m,{className:"text-[10px] text-fg-muted/50 hover:text-fg-muted mt-1.5",children:t.jsx("span",{className:"font-mono",children:"Paste hexâ€¦"})}),t.jsx(g,{children:t.jsx("textarea",{value:f,onChange:e=>b(e.target.value),placeholder:"Paste raw packet hex (overrides dropdown)",rows:2,className:"surface-input w-full mt-1 px-2 py-1 rounded text-[11px] font-mono text-fg-primary resize-y"})})]})]}),t.jsxs(x,{children:[t.jsx(m,{className:"text-[11px] mb-3 w-full",children:t.jsxs("span",{className:"flex items-center gap-2 font-mono",children:[t.jsx("span",{className:"text-fg-muted/50",children:"âš™"}),t.jsx("span",{className:"text-fg-muted/50",children:"Pipeline Config & Dev Tools"}),t.jsxs("span",{className:"text-fg-muted/30 text-[10px]",children:["disambig=",o.disambiguationEnabled?"on":"off"," mac=",o.macCorruptedPolicy," decay=",o.recencyDecayHours,"h"]})]})}),t.jsx(g,{children:t.jsxs("div",{className:"space-y-3 mb-4",children:[t.jsxs("div",{className:"surface-base rounded-lg border border-edge-subtle p-3",children:[t.jsx("h2",{className:"text-[10px] text-fg-muted/50 uppercase tracking-widest font-mono mb-2",children:"Pipeline Config"}),t.jsxs("div",{className:"grid grid-cols-2 gap-x-4 gap-y-1.5",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("label",{className:"text-[11px] text-fg-muted w-24 shrink-0",children:"Disambiguation"}),t.jsx("button",{onClick:()=>c({disambiguationEnabled:!o.disambiguationEnabled}),className:"px-2 py-0.5 rounded text-[11px] font-mono transition-colors "+(o.disambiguationEnabled?"bg-sys-green/20 text-sys-green":"bg-sys-red/20 text-sys-red"),children:o.disambiguationEnabled?"â— ON":"â—‹ OFF"})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("label",{className:"text-[11px] text-fg-muted w-24 shrink-0",children:"MAC policy"}),t.jsxs("select",{value:o.macCorruptedPolicy,onChange:e=>c({macCorruptedPolicy:e.target.value}),className:"surface-input px-1.5 py-0.5 rounded text-[11px] font-mono text-fg-primary",children:[t.jsx("option",{value:"strict",children:"strict (drop)"}),t.jsx("option",{value:"name-only",children:"name-only"}),t.jsx("option",{value:"permissive",children:"permissive"})]})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("label",{className:"text-[11px] text-fg-muted w-24 shrink-0",children:"Recency decay"}),t.jsx("input",{type:"range",min:1,max:48,step:1,value:o.recencyDecayHours,onChange:e=>c({recencyDecayHours:Number(e.target.value)}),className:"flex-1 h-1 accent-sys-blue"}),t.jsxs("span",{className:"text-[11px] font-mono text-fg-primary w-8 text-right",children:[o.recencyDecayHours,"h"]})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("label",{className:"text-[11px] text-fg-muted w-24 shrink-0",children:"Zero-hop decay"}),t.jsx("input",{type:"range",min:12,max:168,step:6,value:o.zeroHopDecayHours,onChange:e=>c({zeroHopDecayHours:Number(e.target.value)}),className:"flex-1 h-1 accent-sys-blue"}),t.jsxs("span",{className:"text-[11px] font-mono text-fg-primary w-10 text-right",children:[o.zeroHopDecayHours,"h"]})]})]})]}),t.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-3",children:[t.jsx(ct,{packet:C,pipeline:H,resolved:L,decrypted:$??null,isSynthetic:S,liveMode:v}),t.jsx(Ge,{})]})]})})]}),C?t.jsxs("div",{className:"space-y-1",children:[t.jsx(Ne,{packet:C,isSynthetic:S}),t.jsx(Pe,{packet:C,pipeline:H,rawHex:_,traceTagIndex:(null==H?void 0:H.traceTagIndex)??new Map,neighbors:a}),t.jsx(ze,{packet:C,decrypted:$??void 0,pipeline:H}),t.jsx(Ee,{packet:C,pipeline:H,resolved:L,decrypted:$??void 0,resolveTimeMs:P.current,neighbors:a,advertName:T.advertName})]}):t.jsx("div",{className:"surface-base rounded-lg border border-edge-subtle p-8 text-center",children:t.jsx("p",{className:"text-fg-muted text-xs",children:"Select a packet from the dropdown or paste hex above"})})]})}export{dt as default};
