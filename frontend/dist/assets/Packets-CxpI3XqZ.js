import{c as e,j as t,d as s,m as a,R as l,X as r,P as c}from"./index-DJZzIT5o.js";import{b as i,c as n}from"./recharts-bmHCCfxU.js";import{c as o,d,A as m,C as x,e as p,R as u,g as h,P as b,a as j,b as g}from"./PacketDetailModal-DVdhBb13.js";import{u as y}from"./usePolling-DMtQdE_y.js";import{C as f}from"./HashBadge-Bw92Kxy4.js";import{U as v}from"./users--u_9e887.js";import{P as N,a as w,C as k,b as S}from"./PageLayout-v625f7fI.js";import{C as _}from"./circle-kquAvdKJ.js";import{R as C}from"./refresh-cw-J4C9PxWk.js";import"./maplibre-gl-CFO9X1Ek.js";import"./SignalIndicator-TYN_Wy0w.js";import"./triangle-alert-CG0Hcq6I.js";const R=e("funnel",[["path",{d:"M10 20a1 1 0 0 0 .553.895l2 1A1 1 0 0 0 14 21v-7a2 2 0 0 1 .517-1.341L21.74 4.67A1 1 0 0 0 21 3H3a1 1 0 0 0-.742 1.67l7.225 7.989A2 2 0 0 1 10 14z",key:"sc7q7i"}]]);function P({icon:e,label:s,value:a,color:l,percentage:r}){return t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("div",{className:n("p-1.5 rounded-md",l),children:e}),t.jsxs("div",{className:"flex flex-col",children:[t.jsx("span",{className:"text-sm font-semibold text-text-primary",children:a.toLocaleString()}),t.jsxs("span",{className:"text-[10px] text-text-muted leading-tight",children:[s,void 0!==r&&t.jsxs("span",{className:"ml-1 opacity-70",children:["(",r,"%)"]})]})]})]})}const L=i.memo(function({packets:e}){const s=i.useMemo(()=>{let t=0,s=0,a=0;const l=new Set;let r=0,c=0;for(const d of e){switch(o(d)){case"forward":t++;break;case"dropped":s++;break;case"duplicate":a++}d.src_hash&&l.add(d.src_hash),d.rssi&&(r+=d.rssi,c++)}const i=e.length,n=c>0?Math.round(r/c):0;return{total:i,rx:i,fwd:t,dropped:s,duplicate:a,uniqueSources:l.size,avgRssi:n,rxPercent:100,fwdPercent:i>0?Math.round(t/i*100):0,droppedPercent:i>0?Math.round(s/i*100):0}},[e]);return 0===e.length?null:t.jsx("div",{className:"glass-card p-3 pr-4",children:t.jsxs("div",{className:"grid grid-cols-2 gap-3 sm:flex sm:items-center sm:justify-between sm:gap-6",children:[t.jsx(P,{icon:t.jsx(d,{className:"w-3.5 h-3.5 text-accent-primary"}),label:"Received",value:s.rx,color:"bg-accent-primary/10",percentage:s.rxPercent}),t.jsx(P,{icon:t.jsx(m,{className:"w-3.5 h-3.5 text-accent-success"}),label:"Forwarded",value:s.fwd,color:"bg-accent-success/10",percentage:s.fwdPercent}),t.jsx(P,{icon:t.jsx(x,{className:"w-3.5 h-3.5 text-accent-danger"}),label:"Dropped",value:s.dropped,color:"bg-accent-danger/10",percentage:s.droppedPercent}),t.jsx(P,{icon:t.jsx(f,{className:"w-3.5 h-3.5 text-text-muted"}),label:"Duplicates",value:s.duplicate,color:"bg-white/5"}),t.jsxs("div",{className:"hidden sm:flex items-center gap-6 ml-auto",children:[t.jsx(P,{icon:t.jsx(v,{className:"w-3.5 h-3.5 text-accent-secondary"}),label:"Sources",value:s.uniqueSources,color:"bg-accent-secondary/10"}),t.jsxs("div",{className:"flex flex-col items-end pr-1",children:[t.jsxs("span",{className:"text-sm font-mono text-text-secondary",children:[s.avgRssi," dBm"]}),t.jsx("span",{className:"text-[10px] text-text-muted",children:"Avg Signal"})]})]})]})})});function M(){const[e,d]=i.useState([]),[m,x]=i.useState(!0),[f,v]=i.useState(!0),[P,M]=i.useState(null),[A,T]=i.useState(!1),[F,D]=i.useState({limit:100,status:"all"}),q=s(),[H,z]=i.useState(null),B=i.useRef(0),E=i.useCallback(async()=>{try{const e=await a(F.limit||100);e.success&&e.data&&d(e.data)}catch{}finally{x(!1)}},[F.limit]),O=i.useMemo(()=>{let t=e;if(void 0!==F.type){const e=p[F.type];t=t.filter(t=>{const s=t.type??t.payload_type,a=t.payload_type_name;return s===F.type||a===e})}if(void 0!==F.route){const e=u[F.route];t=t.filter(t=>{const s=t.route??t.route_type,a=t.route_type_name;return s===F.route||a===e})}if(F.status&&"all"!==F.status&&(t=t.filter(e=>o(e)===F.status)),void 0!==F.signalMin&&(t=t.filter(e=>e.rssi>=F.signalMin)),F.timeRange&&F.timeRange>0){const e=Date.now()/1e3-3600*F.timeRange;t=t.filter(t=>t.timestamp>=e)}return t},[e,F.type,F.route,F.status,F.signalMin,F.timeRange]);i.useEffect(()=>{E()},[E]),y(E,c.packets,f,!0),i.useEffect(()=>{if(q>0&&q!==B.current&&e.length>0){B.current=q;const t=e.find(e=>(e.payload_type_name||h(e.payload_type??e.type)).toLowerCase().includes("advert"));if(t){const e=requestAnimationFrame(()=>z(t.packet_hash)),s=setTimeout(()=>z(null),600);return()=>{cancelAnimationFrame(e),clearTimeout(s)}}}},[q,e]);const G=(e,t)=>{D(s=>({...s,[e]:t}))},I=void 0!==F.type||void 0!==F.route||F.status&&"all"!==F.status||void 0!==F.signalMin||F.timeRange&&F.timeRange>0;return t.jsxs(N,{children:[t.jsx(w,{title:"Packet History",icon:t.jsx(l,{}),controls:t.jsxs(t.Fragment,{children:[f&&t.jsxs("div",{className:"flex items-center gap-1.5 text-xs",children:[t.jsx(_,{className:"w-1.5 h-1.5 fill-accent-success text-accent-success animate-pulse"}),t.jsx("span",{className:"text-text-muted hidden xs:inline",children:"Live"})]}),t.jsxs("button",{onClick:()=>T(!A),className:n("sm:hidden px-3 py-1.5 rounded-lg text-sm font-medium transition-all","flex items-center gap-1.5 border",I?"bg-accent-primary/20 text-accent-primary border-accent-primary/30":"bg-bg-subtle text-text-muted border-border-subtle"),children:[t.jsx(R,{className:"w-4 h-4"}),I&&t.jsx("span",{className:"w-1.5 h-1.5 rounded-full bg-accent-primary"})]}),t.jsxs("button",{onClick:()=>v(!f),className:n("px-3 py-1.5 rounded-lg text-sm font-medium transition-all duration-200","flex items-center gap-1.5 border",f?"bg-accent-success/20 text-accent-success border-accent-success/30":"bg-bg-subtle text-text-muted border-border-subtle hover:bg-bg-elevated"),children:[t.jsx(C,{className:n("w-4 h-4",f&&"animate-spin")}),t.jsx("span",{className:"hidden xs:inline",children:f?"Live":"Paused"})]})]})}),t.jsxs(k,{noPadding:!0,className:n("overflow-hidden transition-all duration-200",A?"max-h-96 opacity-100":"max-h-0 opacity-0 sm:max-h-96 sm:opacity-100"),children:[t.jsx(S,{listHeader:!0,icon:t.jsx(R,{className:"icon-sm"}),title:"Filters",actions:I?t.jsxs("button",{onClick:()=>{D({limit:F.limit,status:"all"})},className:"type-data-xs text-text-muted hover:text-text-primary flex items-center gap-1",children:[t.jsx(r,{className:"w-3 h-3"})," Clear"]}):void 0}),t.jsx("div",{className:"p-3 sm:p-4",children:t.jsxs("div",{className:"grid grid-cols-2 sm:flex sm:flex-wrap gap-3",children:[t.jsxs("div",{className:"flex-1 min-w-[120px]",children:[t.jsx("label",{className:"type-micro block mb-1",children:"Type"}),t.jsxs("select",{value:F.type??"",onChange:e=>G("type",e.target.value?Number(e.target.value):void 0),className:"w-full bg-bg-subtle border border-border-subtle rounded-lg px-2.5 py-1.5 text-sm text-text-primary focus:outline-none focus:border-accent-primary/50",children:[t.jsx("option",{value:"",children:"All Types"}),Object.entries(p).map(([e,s])=>t.jsx("option",{value:e,children:s},e))]})]}),t.jsxs("div",{className:"flex-1 min-w-[120px]",children:[t.jsx("label",{className:"type-micro block mb-1",children:"Route"}),t.jsxs("select",{value:F.route??"",onChange:e=>G("route",e.target.value?Number(e.target.value):void 0),className:"w-full bg-bg-subtle border border-border-subtle rounded-lg px-2.5 py-1.5 text-sm text-text-primary focus:outline-none focus:border-accent-primary/50",children:[t.jsx("option",{value:"",children:"All Routes"}),Object.entries(u).map(([e,s])=>t.jsx("option",{value:e,children:s},e))]})]}),t.jsxs("div",{className:"flex-1 min-w-[120px]",children:[t.jsx("label",{className:"type-micro block mb-1",children:"Status"}),t.jsxs("select",{value:F.status??"all",onChange:e=>G("status",e.target.value),className:"w-full bg-bg-subtle border border-border-subtle rounded-lg px-2.5 py-1.5 text-sm text-text-primary focus:outline-none focus:border-accent-primary/50",children:[t.jsx("option",{value:"all",children:"All Status"}),t.jsx("option",{value:"rx",children:"Received"}),t.jsx("option",{value:"forward",children:"Forwarded"}),t.jsx("option",{value:"dropped",children:"Dropped"}),t.jsx("option",{value:"duplicate",children:"Duplicate"})]})]}),t.jsxs("div",{className:"flex-1 min-w-[100px]",children:[t.jsx("label",{className:"type-micro block mb-1",children:"Time"}),t.jsxs("select",{value:F.timeRange??0,onChange:e=>G("timeRange",Number(e.target.value)||void 0),className:"w-full bg-bg-subtle border border-border-subtle rounded-lg px-2.5 py-1.5 text-sm text-text-primary focus:outline-none focus:border-accent-primary/50",children:[t.jsx("option",{value:0,children:"All Time"}),t.jsx("option",{value:1,children:"Last 1h"}),t.jsx("option",{value:6,children:"Last 6h"}),t.jsx("option",{value:24,children:"Last 24h"}),t.jsx("option",{value:168,children:"Last 7d"})]})]}),t.jsxs("div",{className:"flex-1 min-w-[100px]",children:[t.jsx("label",{className:"type-micro block mb-1",children:"Signal"}),t.jsxs("select",{value:F.signalMin??"",onChange:e=>G("signalMin",e.target.value?Number(e.target.value):void 0),className:"w-full bg-bg-subtle border border-border-subtle rounded-lg px-2.5 py-1.5 text-sm text-text-primary focus:outline-none focus:border-accent-primary/50",children:[t.jsx("option",{value:"",children:"Any Signal"}),t.jsx("option",{value:-90,children:"Strong (≥-90)"}),t.jsx("option",{value:-100,children:"Good (≥-100)"}),t.jsx("option",{value:-110,children:"Fair (≥-110)"}),t.jsx("option",{value:-120,children:"Weak (≥-120)"})]})]}),t.jsxs("div",{className:"flex-1 min-w-[80px]",children:[t.jsx("label",{className:"type-micro block mb-1",children:"Limit"}),t.jsxs("select",{value:F.limit??100,onChange:e=>G("limit",Number(e.target.value)),className:"w-full bg-bg-subtle border border-border-subtle rounded-lg px-2.5 py-1.5 text-sm text-text-primary focus:outline-none focus:border-accent-primary/50",children:[t.jsx("option",{value:50,children:"50"}),t.jsx("option",{value:100,children:"100"}),t.jsx("option",{value:200,children:"200"}),t.jsx("option",{value:500,children:"500"})]})]})]})})]}),t.jsx(L,{packets:O}),t.jsxs(k,{noPadding:!0,children:[t.jsxs("div",{className:"sm:hidden flex items-center gap-1.5 px-3 py-2 border-b border-border-subtle bg-bg-elevated/30",children:[t.jsx("span",{className:"type-micro w-14 flex-shrink-0",children:"Dir"}),t.jsx("span",{className:"type-micro w-7 flex-shrink-0",children:"Time"}),t.jsx("span",{className:"type-micro w-9 flex-shrink-0",children:"Src"}),t.jsx("span",{className:"type-micro flex-1 min-w-0",children:"Type"}),t.jsx("span",{className:"type-micro w-14 flex-shrink-0",children:"Route"}),t.jsx("span",{className:"type-micro w-10 text-right flex-shrink-0",children:"Signal"})]}),t.jsx("div",{className:"hidden sm:block overflow-x-auto",children:t.jsxs("table",{className:"w-full",children:[t.jsx("thead",{children:t.jsxs("tr",{className:"border-b border-border-subtle bg-bg-elevated/30",children:[t.jsx("th",{className:"text-left py-2.5 px-3 type-micro w-16",children:"Dir"}),t.jsx("th",{className:"text-left py-2.5 px-3 type-micro",children:"Time"}),t.jsx("th",{className:"text-left py-2.5 px-3 type-micro",children:"Source"}),t.jsx("th",{className:"text-left py-2.5 px-3 type-micro",children:"Type"}),t.jsx("th",{className:"text-left py-2.5 px-3 type-micro",children:"Route"}),t.jsx("th",{className:"text-right py-2.5 px-3 pr-4 type-micro",children:"Signal"})]})}),t.jsx("tbody",{className:"divide-y divide-border-subtle/30",children:m&&0===e.length?t.jsx("tr",{children:t.jsx("td",{colSpan:6,className:"text-center py-12 text-text-muted",children:"Loading packets..."})}):0===O.length?t.jsx("tr",{children:t.jsx("td",{colSpan:6,className:"text-center py-12 text-text-muted",children:"No packets found"})}):O.map(e=>{const s=(e.payload_type_name||h(e.payload_type??e.type)).toLowerCase().includes("advert");return t.jsx(b,{packet:e,onClick:M,isFlashing:s&&H===e.packet_hash},e.packet_hash)})})]})}),t.jsx("div",{className:"sm:hidden divide-y divide-border-subtle/30",children:m&&0===e.length?t.jsx("div",{className:"p-8 text-center text-text-muted",children:"Loading packets..."}):0===O.length?t.jsx("div",{className:"p-8 text-center text-text-muted",children:"No packets found"}):O.map(e=>{const s=(e.payload_type_name||h(e.payload_type??e.type)).toLowerCase().includes("advert");return t.jsx(j,{packet:e,onClick:M,isFlashing:s&&H===e.packet_hash},e.packet_hash)})}),t.jsxs("div",{className:"px-3 py-2 border-t border-border-subtle type-data-xs text-text-muted bg-bg-elevated/20 sm:text-left text-center",children:["Showing ",O.length," of ",e.length," packets"]})]}),P&&t.jsx(g,{packet:P,onClose:()=>M(null)})]})}export{M as default};
