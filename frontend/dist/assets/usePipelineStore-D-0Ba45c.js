const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-2YU-f7O7.js","assets/index-CgjVNfe7.css"])))=>i.map(i=>d[i]);
import{bK as Q,bh as oe,a3 as Z,r as se,ev as ae,$ as G,es as k,ew as re,bo as W}from"./index-2YU-f7O7.js";import{c as ce,m as B,i as z}from"./node-types--B4HRIdZ.js";function ee(e){if(!e||e.length<6)return null;const r=e,n=parseInt(r.slice(0,2),16);if(isNaN(n))return null;const o=n&3;let d=2;if((o===0||o===3)&&(d=10),d+2>r.length)return null;const s=parseInt(r.slice(d,d+2),16);if(isNaN(s)||(d+=2+s*2,d>=r.length))return null;const f=r.slice(d);return f.length>=38?f.slice(0,38):f}function q(e,r="name-only"){const n=e.decoded;if(!n||!n.decrypted)return null;if(n.macCorrupted)switch(r){case"strict":return null;case"name-only":return{senderName:n.senderName||null,channelName:n.channelName||null,channelHash:n.channelHash||null,text:null,corrupted:!0,decrypted:!0}}return{senderName:n.senderName||null,channelName:n.channelName||null,channelHash:n.channelHash||null,text:n.text||null,corrupted:!!n.macCorrupted,decrypted:!0}}function ie(e,r){var d;const n=new Map,o=new Map;for(const s of e){const f=s.payload_type??s.type;if(f!==Q.GRP_TXT)continue;const _=r.get(s.packet_hash);if(!((d=_==null?void 0:_.decoded)!=null&&d.decrypted)||_.decoded.macCorrupted)continue;const h=s._payloadHexPrefix??ee(s.raw_packet);h&&!n.has(h)&&n.set(h,_);const y=s.payload_length??s.length??0,t=Math.floor((s.timestamp??0)/60),m=`${f}:${y}:${t}`;o.has(m)||o.set(m,_)}return{byPayload:n,byApprox:o}}function de(e,r,n,o="name-only"){const d=e.payload_type??e.type;if(d!==Q.GRP_TXT)return null;const s=r.get(e.packet_hash);if(s)return q(s,o);const f=e._payloadHexPrefix??ee(e.raw_packet),_=(f?n.byPayload.get(f):null)??n.byApprox.get(`${d}:${e.payload_length??e.length??0}:${Math.floor((e.timestamp??0)/60)}`);return _?q(_,o):null}function le(e){return e.name||e.node_name||null}function S(e,r,n,o,d,s,f){return{hash:e,type:r,name:n,isRepeater:r==="repeater",isCompanion:r==="companion",confident:o,advertObservations:d,topologyNeighborCount:s,topologyAffinity:f}}const ne=Object.freeze(S(null,"unknown",null,!1,0,0,0)),he=5,ue={disambiguationEnabled:!0,recencyDecayHours:12,zeroHopDecayHours:72,confidenceThreshold:.6,macCorruptedPolicy:"name-only"};function pe(e){const r=new Map,n=new Map,o=new Map,d=new Map,s=new Map,f=new Map,_=new Map;for(const[t,m]of Object.entries(e)){const i=ce(m).type;r.set(t,i);const l=(t.startsWith("0x")?t.slice(2):t).toLowerCase();n.set(l,t);const N=G(t),w=le(m);let H=o.get(N);H||(H=[],o.set(N,H)),H.push({hash:t,name:w,type:i});const T=d.get(N)||{repeaters:0,others:0};if(i==="repeater"?T.repeaters++:T.others++,d.set(N,T),w){f.set(t,w);const E=w.toLowerCase(),C=_.get(E)??0,A=m.last_seen??0;(!s.has(E)||A>C)&&(s.set(E,t),_.set(E,A))}}const h=new Set,y=new Set;for(const[t,m]of d)m.repeaters>0&&m.others>0&&h.add(t),(m.repeaters>=2||m.others>=2)&&y.add(t);return{hashToType:r,pubKeyMap:n,prefixIndex:o,crossClassPrefixes:h,sameClassAmbiguous:y,nameToHash:s,hashToName:f}}function fe(e,r,n,o){const d=new Map(r),s=new Map,f=new Map,_=new Map,h=new Map,y=new Map;for(const t of e){const m=t.timestamp??0;if(t._advertSender){const i=n.get(t._advertSender)??t._advertSender,l=y.get(i);(!l||m>l.lastSeen)&&y.set(i,{lastSeen:m,name:t._advertName??(l==null?void 0:l.name)??null,nodeType:t._advertNodeType!=null?B(t._advertNodeType):(l==null?void 0:l.nodeType)??z(t.type??t.payload_type),latitude:t._advertLatitude??(l==null?void 0:l.latitude),longitude:t._advertLongitude??(l==null?void 0:l.longitude)})}else if(t.src_hash&&t.src_hash.length>8){const i=t.src_hash,l=y.get(i);l?m>l.lastSeen&&(l.lastSeen=m):y.set(i,{lastSeen:m,name:null,nodeType:z(t.type??t.payload_type)})}if(t._advertNodeType==null&&!t._advertName)continue;const v=t._advertSender;if(t._advertNodeType!=null){let i;if(v&&(i=n.get(v)),!i&&t.src_hash&&d.has(t.src_hash)&&(i=t.src_hash),i){const l=d.get(i);if(!l||l==="unknown"){const N=B(t._advertNodeType);N!=="unknown"&&d.set(i,N)}}}if(t._advertName&&v){const i=n.get(v)??v,l=t.timestamp??0,N=t._advertName.toLowerCase();if(!o.has(N)){const H=_.get(N)??0;(!s.has(N)||l>H)&&(s.set(N,i),_.set(N,l))}const w=h.get(i)??0;(!f.has(i)||l>w)&&(f.set(i,t._advertName),h.set(i,l))}}for(const[t,m]of y){const v=d.get(t);v&&v!=="unknown"&&m.nodeType==="unknown"&&(m.nodeType=v)}return{extendedHashToType:d,advertNameToHash:s,advertHashToName:f,discoveredNodes:y}}function ge(e,r,n,o,d){var y;const s=new Map,f=new Map;if(r.size===0)return{decryptedNameToHash:s,decryptedHashToName:f};const{prefixIndex:_,nameToHash:h}=n;for(const t of e){if((t.type??t.payload_type)!==he)continue;const v=r.get(t.packet_hash);if(!((y=v==null?void 0:v.decoded)!=null&&y.decrypted)||v.decoded.macCorrupted)continue;const i=v.decoded.senderName;if(!i)continue;const l=t.src_hash;if(!l)continue;const N=G(l);let w=d.get(N);if(!w){const T=_.get(N);(T==null?void 0:T.length)===1&&(w=T[0].hash)}if(!w&&l.length>4&&(w=l),!w)continue;const H=i.toLowerCase();!h.has(H)&&!o.has(H)&&s.set(H,w),f.has(w)||f.set(w,i)}return{decryptedNameToHash:s,decryptedHashToName:f}}function ye(e,r,n,o,d,s,f,_,h,y,t){var M,P,D,x,F,K,R;const m=e.src_hash,v=_==null?void 0:_.get(e.packet_hash),i=((M=v==null?void 0:v.decoded)==null?void 0:M.senderName)??null,{nameToHash:l}=r;if(!m){const u=e.type??e.payload_type,c=z(u),g=e._advertName??null;if(i){const p=i.toLowerCase(),I=l.get(p)??o.get(p)??h.get(p);if(I){const b=n.get(I)??c;return S(I,b,i,!0)}return S(null,c!=="unknown"?c:"companion",i,!1)}if(e._advertSender){const{pubKeyMap:p,hashToName:I}=r,b=p.get(e._advertSender);if(b){const U=n.get(b)??c,te=I.get(b)??d.get(b)??y.get(b)??null;return S(b,U,te,!0)}const L=d.get(e._advertSender);if(L){const U=n.get(e._advertSender)??c;return S(e._advertSender,U,L,!0)}const Y=y.get(e._advertSender);if(Y){const U=n.get(e._advertSender)??c;return S(e._advertSender,U,Y,!0)}}if(c!=="unknown")return S(null,c,g,!1);if(e._advertNodeType!=null){const p=B(e._advertNodeType);if(p!=="unknown")return S(null,p,g,!1)}return g?S(null,"unknown",g,!1):ne}const N=e.type??e.payload_type??-1,w=e._advertSender?`${m}\0${e._advertSender}`:`${m}\0${N}\0${i??""}`,H=t.get(w);if(H)return H;const T=G(m),{pubKeyMap:E,prefixIndex:C,crossClassPrefixes:A,sameClassAmbiguous:O}=r;let a;if(e._advertSender){const u=E.get(e._advertSender);if(u){const c=n.get(u)??"unknown",g=(P=C.get(T))==null?void 0:P.find(p=>p.hash===u);a=S(u,c,(g==null?void 0:g.name)??null,!0)}else if(e._advertNodeType!=null){const c=B(e._advertNodeType);c!=="unknown"&&(a=S(e._advertSender,c,e._advertName??null,!0))}else{const c=d.get(e._advertSender);if(c){const g=n.get(e._advertSender)??z(e.type??e.payload_type);a=S(e._advertSender,g,c,!0)}}}if(!a&&i){const u=C.get(T),c=u==null?void 0:u.find(g=>{var p;return((p=g.name)==null?void 0:p.toLowerCase())===i.toLowerCase()});if(c){const g=n.get(c.hash)??c.type;a=S(c.hash,g,c.name,!0)}else{const g=i.toLowerCase(),p=l.get(g)??o.get(g)??h.get(g);if(p){const I=n.get(p)??"unknown",b=(D=C.get(G(p)))==null?void 0:D.find(L=>L.hash===p);a=S(p,I,(b==null?void 0:b.name)??i,!0)}}}if(!a&&A.has(T)){const u=z(e.type??e.payload_type);if(u!=="unknown"){const c=(x=C.get(T))==null?void 0:x.find(g=>g.type===u);c&&(a=S(c.hash,u,c.name,!0))}if(!a&&e._advertNodeType!=null){const c=B(e._advertNodeType);if(c!=="unknown"){const g=(F=C.get(T))==null?void 0:F.find(p=>p.type===c);g&&(a=S(g.hash,c,g.name,!0))}}if(!a){const c=C.get(T),g=s.get(T),p=g?c==null?void 0:c.find(L=>L.hash===g):c==null?void 0:c[0],I=p?n.get(p.hash)??p.type:"unknown",b=!!g&&!!p&&p.hash===g;a=S((p==null?void 0:p.hash)??null,I,(p==null?void 0:p.name)??null,b)}}if(!a){const u=s.get(T);if(u){const c=n.get(u)??"unknown",g=(K=C.get(T))==null?void 0:K.find(p=>p.hash===u);a=S(u,c,(g==null?void 0:g.name)??null,!0)}}if(!a&&O.has(T)){const u=(R=C.get(T))==null?void 0:R[0];a=S((u==null?void 0:u.hash)??null,(u==null?void 0:u.type)??"unknown",(u==null?void 0:u.name)??null,!1)}if(!a){const u=C.get(T);if((u==null?void 0:u.length)===1){const c=u[0];a=S(c.hash,c.type,c.name,!0)}else a=S(null,z(N),null,!1)}const j=z(N);if(j!=="unknown"&&j!==a.type&&(a=S(a.hash,j,a.name,a.confident)),a.type==="unknown"&&e._advertNodeType!=null){const u=B(e._advertNodeType);u!=="unknown"&&(a=S(a.hash,u,a.name,a.confident))}if(a.hash){const u=f.get(T);if(u){const c=u.find(g=>g.hash===a.hash);if(c){let g=0;const p=e.original_path??e.forwarded_path;if(p&&Array.isArray(p)&&p.length>0&&c.totalForwarderObservations>0){const I=new Set;for(const b of p){const L=String(b).toUpperCase().slice(0,2);L.length>=2&&L!==T&&I.add(L)}if(I.size>0){let b=0;for(const L of I)c.forwarderPrefixes.has(L)&&b++;g=b/I.size}}a=S(a.hash,a.type,a.name,a.confident,c.advertCount,c.forwarderPrefixes.size,g)}}}if(a.name===null&&a.hash){const u=r.hashToName.get(a.hash)??d.get(a.hash)??y.get(a.hash)??null;u&&(a=S(a.hash,a.type,u,a.confident,a.advertObservations,a.topologyNeighborCount,a.topologyAffinity))}return t.set(w,a),a}const me={hashToType:new Map,pubKeyMap:new Map,prefixIndex:new Map,crossClassPrefixes:new Set,sameClassAmbiguous:new Set,nameToHash:new Map,hashToName:new Map},_e={byPayload:new Map,byApprox:new Map},$=oe((e,r)=>({config:ue,neighborContext:me,extendedHashToType:new Map,advertNameToHash:new Map,advertHashToName:new Map,resolverMap:new Map,topologyProfiles:new Map,decryptedNameToHash:new Map,decryptedHashToName:new Map,srcHashResolverMap:new Map,discoveredNodes:new Map,contentInheritanceIndex:_e,_cache:new Map,_neighborFingerprint:"",_resolverFingerprint:"",_advertScanFingerprint:"",_decodedNameFingerprint:"",_inheritanceFingerprint:"",_decodedContentVersion:0,resolveSource:n=>{const o=r();return o.config.disambiguationEnabled?ye(n,o.neighborContext,o.extendedHashToType,o.advertNameToHash,o.advertHashToName,o.resolverMap,o.topologyProfiles,V,o.decryptedNameToHash,o.decryptedHashToName,o._cache):ne},getDecodedContent:n=>{const o=r(),d=Z.getState().messages;return de(n,d,o.contentInheritanceIndex,o.config.macCorruptedPolicy)},setConfig:n=>{const o={...r().config,...n};e({config:o,_cache:new Map}),X==null||X()},recompute:(n,o,d)=>{const s=r(),{config:f}=s,_=`${Object.keys(o).length}`;let h=s.neighborContext;_!==s._neighborFingerprint&&(h=pe(o));const y=Math.floor(n.length/50)*50,t=`${_}:${y}`;let m=s.extendedHashToType,v=s.advertNameToHash,i=s.advertHashToName,l=s.discoveredNodes;if(t!==s._advertScanFingerprint||_!==s._neighborFingerprint){const M=fe(n,h.hashToType,h.pubKeyMap,h.nameToHash);m=M.extendedHashToType,v=M.advertNameToHash,i=M.advertHashToName,l=M.discoveredNodes}const N=`${Object.keys(o).length}:${y}:${h.crossClassPrefixes.size}:${f.recencyDecayHours}:${f.zeroHopDecayHours}`;let w=s.resolverMap,H=s.topologyProfiles;if(N!==s._resolverFingerprint){const M=ae(n,o,{recencyDecayHours:f.recencyDecayHours,zeroHopDecayHours:f.zeroHopDecayHours});w=M.resolver,H=M.topologyProfiles}const T=Math.floor(d.size/20)*20,E=`${y}:${T}:${N}`;let C=s.decryptedNameToHash,A=s.decryptedHashToName;if(E!==s._decodedNameFingerprint){const M=ge(n,d,h,v,w);C=M.decryptedNameToHash,A=M.decryptedHashToName}{const M=[];for(const[P,D]of l)if(D.name===null){const x=h.hashToName.get(P)??i.get(P)??A.get(P)??null;x&&M.push([P,x])}if(M.length>0){l=new Map(l);for(const[P,D]of M){const x=l.get(P);l.set(P,{...x,name:D})}}}const O=new Map(w);for(const[M,P]of C){const D=G(P),x=h.prefixIndex.get(D);if(!x||x.length<=1)continue;const F=x.find(K=>{var R;return((R=K.name)==null?void 0:R.toLowerCase())===M});F&&O.get(D)!==F.hash&&O.set(D,F.hash)}for(const[M,P]of v){const D=G(P),x=h.prefixIndex.get(D);if(!x||x.length<=1)continue;const F=x.find(K=>{var R;return((R=K.name)==null?void 0:R.toLowerCase())===M});F&&O.get(D)!==F.hash&&O.set(D,F.hash)}const a=`${y}:${T}`;let j=s.contentInheritanceIndex;a!==s._inheritanceFingerprint&&(j=ie(n,d)),re(O),k.active&&k.emit("pipeline:disambig:recompute",{packets:n.length,neighbors:Object.keys(o).length,decoded:d.size}),e({neighborContext:h,extendedHashToType:m,advertNameToHash:v,advertHashToName:i,resolverMap:w,topologyProfiles:H,decryptedNameToHash:C,decryptedHashToName:A,srcHashResolverMap:O,discoveredNodes:l,contentInheritanceIndex:j,_cache:new Map,_neighborFingerprint:_,_resolverFingerprint:N,_advertScanFingerprint:t,_decodedNameFingerprint:E,_inheritanceFingerprint:a,_decodedContentVersion:s._decodedContentVersion+1})}}));let V=new Map,X=null;function J(e,r){var d,s,f,_;if(!(r!=null&&r.public_key))return e;const n=r.public_key.toLowerCase(),o=n.startsWith("0x")?n.slice(2):n;for(const h of Object.keys(e))if((h.startsWith("0x")?h.slice(2):h).toLowerCase()===o)return e;return{...e,[r.public_key]:{name:r.node_name,node_name:r.node_name,contact_type:"Repeater",is_repeater:!0,last_seen:Date.now()/1e3,latitude:(s=(d=r.config)==null?void 0:d.repeater)==null?void 0:s.latitude,longitude:(_=(f=r.config)==null?void 0:f.repeater)==null?void 0:_.longitude,zero_hop:!0}}}if(typeof window<"u"){let e=function(){f&&clearTimeout(f),f=setTimeout(()=>{var i;if(f=null,!r||!n)return;const h=r.useStore.getState(),y=n.useDecodedMessagesStore.getState(),t=h.packets,m=J(((i=h.stats)==null?void 0:i.neighbors)??{},h.stats),v=y.stableMessages;$.getState().recompute(t,m,v)},_)},r=null,n=null,o=[],d,s=new Map,f=null;const _=150;X=e,setTimeout(()=>{W(()=>import("./index-2YU-f7O7.js").then(h=>h.g1),__vite__mapDeps([0,1])).then(h=>{var m,v;r=h,h.useStore.subscribe(i=>{var w,H;const l=i.packets!==o,N=((w=i.stats)==null?void 0:w.neighbors)!==d;(l||N)&&(o=i.packets,d=(H=i.stats)==null?void 0:H.neighbors,e())});const y=h.useStore.getState();o=y.packets,d=(m=y.stats)==null?void 0:m.neighbors;const t=J(((v=y.stats)==null?void 0:v.neighbors)??{},y.stats);(o.length>0||Object.keys(t).length>0)&&$.getState().recompute(o,t,new Map)}),W(()=>import("./index-2YU-f7O7.js").then(h=>h.g0),__vite__mapDeps([0,1])).then(h=>{n=h,V=h.useDecodedMessagesStore.getState().messages,h.useDecodedMessagesStore.subscribe(y=>{y.messages!==V&&(V=y.messages),y.stableMessages!==s&&(s=y.stableMessages,e())})})},0)}const we=$;function Te(){return $(e=>e.resolveSource)}function Se(){return $(e=>e.neighborContext)}function Me(){return $(e=>e.topologyProfiles)}function He(){return $(e=>e.advertNameToHash)}function be(){const e=$(o=>o.getDecodedContent),r=$(o=>o._decodedContentVersion),n=Z(o=>o._successCount);return se.useCallback(o=>e(o),[e,r,n])}function Ce(){return $(e=>e.config)}function xe(){return $(e=>e.srcHashResolverMap)}function Pe(){return $(e=>e.discoveredNodes)}export{ue as DEFAULT_PIPELINE_CONFIG,He as useAdvertNameToHash,Pe as useDiscoveredNodes,be as useGetDecodedContent,Se as useNeighborContext,Ce as usePipelineConfig,we as usePipelineStore,Te as useResolveSource,xe as useSrcHashResolverMap,Me as useTopologyProfiles};
