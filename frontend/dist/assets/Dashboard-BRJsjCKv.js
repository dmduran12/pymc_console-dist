import{c as e,j as t,a as s,b as a,d as n,e as l,R as i,L as r,f as o,g as c,h as d,k as u,u as m,m as x,n as h,D as p,o as v,p as g,q as f,C as j}from"./index-CLi6xczL.js";import{b,d as y,L as k,e as N,A as w,C as M,X as _,Y as L,T as S,f as C}from"./recharts-bmHCCfxU.js";import{u as B,a as F}from"./useThemeColors-aZ327gx7.js";import{g as R,A as T,P as H,a as P,b as D,C as A}from"./PacketDetailModal-2qvWC4VM.js";import{C as $}from"./circle-Ca8pl55s.js";import{R as W,T as z}from"./TimeRangeSelector-Hu7vgLzP.js";import{H as E}from"./HashBadge-Ds68z9zP.js";import{T as I}from"./trending-up-C2PPgLZS.js";import{T as q,M as K,Z as V}from"./zap-BMeccDbl.js";import{C as O,P as U,a as X,b as Q}from"./PageLayout-BXoaut2N.js";import{H as G}from"./house-Br0ddgCN.js";import{R as J}from"./Grid-BpRuWPLK.js";import"./maplibre-gl-CFO9X1Ek.js";import"./SignalIndicator-C9Bb21cj.js";import"./map-pin-BHxLBGAv.js";import"./triangle-alert-CtfeX3hX.js";import"./map-Dkyc42DP.js";import"./chevron-right-uVAMQ-qt.js";const Y=e("arrow-up-right",[["path",{d:"M7 7h10v10",key:"1tivn9"}],["path",{d:"M7 17 17 7",key:"1vkiza"}]]),Z=e("audio-waveform",[["path",{d:"M2 13a2 2 0 0 0 2-2V7a2 2 0 0 1 4 0v13a2 2 0 0 0 4 0V4a2 2 0 0 1 4 0v13a2 2 0 0 0 4 0v-4a2 2 0 0 1 2-2",key:"57tc96"}]]),ee=e("ear-off",[["path",{d:"M6 18.5a3.5 3.5 0 1 0 7 0c0-1.57.92-2.52 2.04-3.46",key:"1qngmn"}],["path",{d:"M6 8.5c0-.75.13-1.47.36-2.14",key:"b06bma"}],["path",{d:"M8.8 3.15A6.5 6.5 0 0 1 19 8.5c0 1.63-.44 2.81-1.09 3.76",key:"g10hsz"}],["path",{d:"M12.5 6A2.5 2.5 0 0 1 15 8.5M10 13a2 2 0 0 0 1.82-1.18",key:"ygzou7"}],["line",{x1:"2",x2:"22",y1:"2",y2:"22",key:"a6p6uj"}]]),te=e("square-activity",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}],["path",{d:"M17 12h-2l-2 5-2-10-2 5H7",key:"15hlnc"}]]),se=e("timer",[["line",{x1:"10",x2:"14",y1:"2",y2:"2",key:"14vaq8"}],["line",{x1:"12",x2:"15",y1:"14",y2:"11",key:"17fdiu"}],["circle",{cx:"12",cy:"14",r:"8",key:"1e1u0o"}]]),ae={received:{value:"text-[var(--metric-received)]",barBase:"var(--metric-received)"},forwarded:{value:"text-[var(--metric-forwarded)]",barBase:"var(--metric-forwarded)"},transmitted:{value:"text-[var(--metric-transmitted)]",barBase:"var(--metric-transmitted)"},dropped:{value:"text-[var(--metric-dropped)]",barBase:"var(--metric-dropped)"},neutral:{value:"text-text-secondary",barBase:"var(--metric-neutral)"}};function ne({buckets:e,colorType:s,height:a=64}){const n=ae[s],{bars:l}=b.useMemo(()=>{var t,s;if(!e||0===e.length)return{bars:[]};const a=[],l=e.length/60;if(l<=1)a.push(...e);else for(let n=0;n<60;n++){const i=Math.floor(n*l),r=Math.floor((n+1)*l),o=e.slice(i,r),c=o.reduce((e,t)=>e+t.count,0),d=o.length>0?o.reduce((e,t)=>e+t.avg_snr,0)/o.length:0;a.push({bucket:n,start:(null==(t=o[0])?void 0:t.start)??0,end:(null==(s=o[o.length-1])?void 0:s.end)??0,count:c,airtime_ms:o.reduce((e,t)=>e+t.airtime_ms,0),avg_snr:d,avg_rssi:0})}const i=Math.max(...a.map(e=>e.count),1);return{bars:a.map(e=>({height:e.count>0?Math.max(e.count/i*100,8):0,color:e.count>0?n.barBase:"transparent",count:e.count,snr:e.avg_snr}))}},[e,n]);return e&&0!==e.length?t.jsx("div",{className:"w-full flex items-end gap-[1px]",style:{height:a},children:l.map((e,s)=>{var a;return t.jsx("div",{className:"flex-1 rounded-t-sm",style:{height:`${e.height}%`,backgroundColor:e.color,opacity:e.count>0?.8:.1,minHeight:e.count>0?"4px":"2px",maxWidth:"4px"},title:e.count>0?`${e.count} packets, SNR: ${null==(a=e.snr)?void 0:a.toFixed(1)}dB`:"No packets"},s)})}):t.jsx("div",{className:"w-full flex items-end justify-center gap-[2px] opacity-20",style:{height:a},children:t.jsx("span",{className:"type-data-xs text-text-muted",children:"No data"})})}const le={received:"text-text-secondary",forwarded:"text-text-secondary",transmitted:"text-text-secondary",dropped:"text-text-secondary",neutral:"text-text-secondary"},ie={sm:"card-sm",md:"card-md",lg:"card-lg",hero:"card-hero",auto:""};function re({title:e,value:s,color:a="neutral",subtitle:n,buckets:l,timeRangeLabel:i,icon:r,size:o="md"}){const c=ae[a],d="string"==typeof s?s:s.toLocaleString();return t.jsxs("div",{className:`data-card flex flex-col ${ie[o]}`,children:[t.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[r&&t.jsx("span",{className:`icon-sm ${le[a]}`,children:r}),t.jsx("span",{className:"type-micro",children:e}),i&&t.jsx("span",{className:"pill-tag",children:i})]}),t.jsx("div",{className:"data-card-value",children:d}),t.jsx("div",{className:"flex-1 py-2 mt-2",children:l?t.jsx(ne,{buckets:l,colorType:a,height:64}):t.jsx("div",{className:"w-full h-16 flex items-center justify-center",children:t.jsx("div",{className:"w-full h-0.5 rounded-full",style:{backgroundColor:c.barBase,opacity:.15}})})}),t.jsx("div",{className:"type-label text-text-muted border-t border-border-subtle pt-3 mt-2",children:n||`Total ${e.toLowerCase()}`})]})}function oe(){const e=s(),o=a(),c=n(),d=l(),[u,m]=b.useState(null),[x,h]=b.useState(null),p=b.useRef(0);b.useEffect(()=>{if(d>0&&d!==p.current&&e.length>0){p.current=d;const t=e.find(e=>(e.payload_type_name||R(e.payload_type??e.type)).toLowerCase().includes("advert"));if(t){const e=requestAnimationFrame(()=>m(t.packet_hash)),s=setTimeout(()=>m(null),600);return()=>{cancelAnimationFrame(e),clearTimeout(s)}}}},[d,e]);const v=e.slice(-15).reverse();return t.jsxs("div",{className:"chart-container h-full flex flex-col",children:[t.jsxs("div",{className:"chart-header",children:[t.jsxs("div",{className:"chart-title",children:[t.jsx(i,{className:"chart-title-icon"}),"Recent Packets"]}),t.jsxs("div",{className:"flex items-center gap-3",children:[c&&t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx($,{className:"w-2 h-2 fill-accent-success text-accent-success animate-pulse"}),t.jsx("span",{className:"type-data-xs text-text-muted",children:"LIVE"})]}),t.jsxs(r,{to:"/packets",className:"pill-subtle",children:["View all ",t.jsx(T,{className:"w-3 h-3"})]})]})]}),t.jsxs("div",{className:"sm:hidden flex items-center gap-1.5 px-3 py-1.5 border-b border-border-subtle/50 bg-bg-elevated/20",children:[t.jsx("span",{className:"text-[9px] font-semibold text-text-muted uppercase tracking-wider w-14 flex-shrink-0",children:"Dir"}),t.jsx("span",{className:"text-[9px] font-semibold text-text-muted uppercase tracking-wider w-7 flex-shrink-0",children:"Time"}),t.jsx("span",{className:"text-[9px] font-semibold text-text-muted uppercase tracking-wider w-9 flex-shrink-0",children:"Src"}),t.jsx("span",{className:"text-[9px] font-semibold text-text-muted uppercase tracking-wider flex-1 min-w-0",children:"Type"}),t.jsx("span",{className:"text-[9px] font-semibold text-text-muted uppercase tracking-wider w-14 flex-shrink-0",children:"Route"}),t.jsx("span",{className:"text-[9px] font-semibold text-text-muted uppercase tracking-wider w-10 text-right flex-shrink-0",children:"Signal"})]}),t.jsx("div",{className:"hidden sm:block flex-1 overflow-hidden",children:t.jsx("div",{className:"h-full overflow-y-auto",children:t.jsxs("table",{className:"w-full",children:[t.jsx("thead",{className:"sticky top-0 bg-bg-elevated/95 backdrop-blur-sm",children:t.jsxs("tr",{className:"border-b border-border-subtle/50",children:[t.jsx("th",{className:"text-left py-1.5 px-3 text-[9px] font-semibold text-text-muted uppercase tracking-wider w-16",children:"Dir"}),t.jsx("th",{className:"text-left py-1.5 px-3 text-[9px] font-semibold text-text-muted uppercase tracking-wider",children:"Time"}),t.jsx("th",{className:"text-left py-1.5 px-3 text-[9px] font-semibold text-text-muted uppercase tracking-wider",children:"Source"}),t.jsx("th",{className:"text-left py-1.5 px-3 text-[9px] font-semibold text-text-muted uppercase tracking-wider",children:"Type"}),t.jsx("th",{className:"text-left py-1.5 px-3 text-[9px] font-semibold text-text-muted uppercase tracking-wider",children:"Route"}),t.jsx("th",{className:"text-right py-1.5 px-3 pr-4 text-[9px] font-semibold text-text-muted uppercase tracking-wider",children:"Signal"})]})}),t.jsx("tbody",{className:"divide-y divide-border-subtle/30",children:o&&0===e.length?t.jsx("tr",{children:t.jsx("td",{colSpan:6,className:"text-center py-8 text-text-muted",children:"Loading packets..."})}):0===v.length?t.jsx("tr",{children:t.jsxs("td",{colSpan:6,className:"text-center py-8",children:[t.jsx(i,{className:"w-6 h-6 text-text-muted mx-auto mb-2"}),t.jsx("div",{className:"text-sm text-text-primary",children:"No packets received"}),t.jsx("div",{className:"text-xs text-text-muted",children:"Packets will appear here"})]})}):v.map((e,s)=>{const a=(e.payload_type_name||R(e.payload_type??e.type)).toLowerCase().includes("advert");return t.jsx(H,{packet:e,onClick:h,isFlashing:a&&u===e.packet_hash},`${e.packet_hash}_${e.timestamp}_${s}`)})})]})})}),t.jsx("div",{className:"sm:hidden flex-1 overflow-y-auto divide-y divide-border-subtle/30",children:o&&0===e.length?t.jsx("div",{className:"p-8 text-center text-text-muted",children:"Loading packets..."}):0===v.length?t.jsxs("div",{className:"p-8 text-center",children:[t.jsx(i,{className:"w-6 h-6 text-text-muted mx-auto mb-2"}),t.jsx("div",{className:"text-sm text-text-primary",children:"No packets received"}),t.jsx("div",{className:"text-xs text-text-muted",children:"Packets will appear here"})]}):v.map((e,s)=>{const a=(e.payload_type_name||R(e.payload_type??e.type)).toLowerCase().includes("advert");return t.jsx(P,{packet:e,onClick:h,isFlashing:a&&u===e.packet_hash},`${e.packet_hash}_${e.timestamp}_${s}`)})}),t.jsxs("div",{className:"px-3 py-1.5 border-t border-border-subtle/50 text-[10px] text-text-muted bg-bg-elevated/20 text-center",children:["Showing ",v.length," of ",e.length," packets"]}),x&&t.jsx(D,{packet:x,onClose:()=>h(null)})]})}b.memo(function({active:e,payload:s,label:a,formatValue:n,labelKey:l}){var i;if(!e||!s||0===s.length)return null;const r=l&&(null==(i=s[0])?void 0:i.payload)?s[0].payload[l]:a;return t.jsxs("div",{className:"bg-tooltip-bg border border-border-subtle rounded-lg px-4 py-3 shadow-xl",children:[r&&t.jsx("p",{className:"type-data-xs text-white/50 mb-2",children:r}),t.jsx("div",{className:"space-y-1.5",children:s.map((e,s)=>t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("span",{className:"w-2 h-2 rounded-full flex-shrink-0",style:{backgroundColor:e.color}}),t.jsx("span",{className:"type-body-sm text-white/70 capitalize min-w-[60px]",children:e.name}),t.jsx("span",{className:"type-data-sm text-white tabular-nums",children:n?n(e.value,e.name):e.value.toLocaleString()})]},s))})]})});const ce=b.memo(function({active:e,payload:s,color:a,labelKey:n,unit:l=""}){var i,r;if(!e||!s||0===s.length)return null;const o=s[0],c=null==(i=null==o?void 0:o.payload)?void 0:i[n];return t.jsxs("div",{className:"bg-tooltip-bg border border-border-subtle rounded-lg px-3 py-2 shadow-xl",children:[t.jsx("p",{className:"type-data-xs text-white/50 mb-1",children:c}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("span",{className:"w-2 h-2 rounded-full",style:{backgroundColor:a}}),t.jsxs("span",{className:"type-data-sm text-white tabular-nums",children:[null==(r=null==o?void 0:o.value)?void 0:r.toLocaleString(),l]})]})]})});b.memo(function({payload:e}){return e&&0!==e.length?t.jsx("div",{className:"flex items-center justify-center gap-6 mt-4 pt-4 border-t border-white/5",children:e.map((e,s)=>t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("span",{className:"w-2 h-2 rounded-full",style:{backgroundColor:e.color}}),t.jsx("span",{className:"type-body-sm text-white/60 capitalize",children:e.value})]},s))}):null});const de=.2;function ue(e,t=1){return Math.floor(5*t*e)}function me(e){const t=Math.round(e/de)*de;return Math.max(0,Math.min(5,t))}function xe({stats:e,receivedBuckets:s,droppedBuckets:a,forwardedBuckets:n,bucketDurationSeconds:l,timeRangeLabel:i}){var r,o,c,d;const u=b.useMemo(()=>function(e,t,s,a,n){var l,i;const r=(null==t?void 0:t.reduce((e,t)=>e+t.count,0))??0,o=(null==s?void 0:s.reduce((e,t)=>e+t.count,0))??0,c=(null==a?void 0:a.reduce((e,t)=>e+t.count,0))??0,d=r>0?r:(null==e?void 0:e.rx_count)||1,u=o>0?o:(null==e?void 0:e.dropped_count)||0,m=d>0?u/(d+u)*100:0;let x=0;if(a&&a.length>0&&n)x=100*c/(a.length*n*1e3)*100;else if(e){const t=1e3*(e.uptime_seconds||1);x=(e.total_airtime_ms||e.airtime_used_ms||0)/t*100}const h=(null==e?void 0:e.neighbors)||{},p=Object.values(h).filter(e=>!0===e.zero_hop).length;let v=1;m<3?v-=de:m>15?v+=.4:m>10&&(v+=de),x>5&&(v+=de),p>10&&(v+=de);const g=me(v),f=me(.28*g),j=ue(g),b=ue(f),y=ue((null==(i=null==(l=null==e?void 0:e.config)?void 0:l.delays)?void 0:i.tx_delay_factor)??1);let k;return k=j>y?"increase":j<y?"decrease":"stable",{floodFactor:g,directFactor:f,floodSlots:j,directSlots:b,adjustment:k,duplicateRate:Math.round(100*m)/100,txUtilization:Math.round(1e3*x)/1e3,zeroHopCount:p,totalReceived:r,totalDropped:o}}(e,s,a,n,l),[e,s,a,n,l]),m=(null==(o=null==(r=null==e?void 0:e.config)?void 0:r.delays)?void 0:o.tx_delay_factor)??null,x=(null==(d=null==(c=null==e?void 0:e.config)?void 0:c.delays)?void 0:d.direct_tx_delay_factor)??null,h=null!==m?ue(m):null,p=null!==h&&u.floodSlots!==h,v="increase"===u.adjustment?I:"decrease"===u.adjustment?q:K;return t.jsxs("div",{className:"data-card flex flex-col",children:[t.jsxs("div",{className:"flex items-center gap-2 mb-3 flex-wrap",children:[t.jsx(se,{className:"w-4 h-4 text-[var(--metric-transmitted)] flex-shrink-0"}),t.jsx("span",{className:"type-micro",children:"TX DELAY"}),i&&t.jsx("span",{className:"pill-tag",children:i}),p&&t.jsxs("span",{className:"pill-tag flex items-center gap-1 "+("increase"===u.adjustment?"bg-accent-warning/20 text-accent-warning border-accent-warning/30":"bg-accent-success/20 text-accent-success border-accent-success/30"),children:[t.jsx(v,{className:"w-3 h-3"}),"increase"===u.adjustment?"+":"-",Math.abs(u.floodSlots-(h??0))]})]}),t.jsxs("div",{className:"data-card-value",children:["×",u.floodFactor.toFixed(1)]}),t.jsxs("div",{className:"flex-1 grid grid-cols-2 gap-x-3 gap-y-1 py-2 mt-2 text-xs",children:[t.jsxs("div",{className:"flex justify-between",children:[t.jsx("span",{className:"text-text-muted",children:"Flood"}),t.jsxs("span",{className:"tabular-nums text-accent-secondary font-medium",children:[u.floodSlots," slots"]})]}),t.jsxs("div",{className:"flex justify-between",children:[t.jsx("span",{className:"text-text-muted",children:"Direct"}),t.jsxs("span",{className:"tabular-nums text-accent-secondary font-medium",children:[u.directSlots," slots"]})]}),t.jsxs("div",{className:"flex justify-between",children:[t.jsx("span",{className:"text-text-muted",children:"Dup Rate"}),t.jsxs("span",{className:"tabular-nums "+(u.duplicateRate>10?"text-accent-warning":"text-text-secondary"),children:[u.duplicateRate.toFixed(1),"%"]})]}),t.jsxs("div",{className:"flex justify-between",children:[t.jsx("span",{className:"text-text-muted",children:"TX Util"}),t.jsxs("span",{className:"tabular-nums text-text-secondary",children:[u.txUtilization.toFixed(2),"%"]})]})]}),t.jsx("div",{className:"type-label text-text-muted border-t border-border-subtle pt-3 mt-2 truncate",children:null!==m?t.jsxs("span",{children:["Current: ×",m.toFixed(1)," / ×",(null==x?void 0:x.toFixed(1))??"—"]}):t.jsx("span",{children:"Slot-aligned factors"})})]})}function he({trend:e}){return"stable"===e?t.jsx("span",{className:"mini-widget-trend stable",children:t.jsx("svg",{className:"w-3 h-3",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 12h14"})})}):"up"===e?t.jsx("span",{className:"mini-widget-trend up",children:t.jsx("svg",{className:"w-3 h-3",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 15l7-7 7 7"})})}):t.jsx("span",{className:"mini-widget-trend down",children:t.jsx("svg",{className:"w-3 h-3",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})})}function pe(){return t.jsx("div",{className:"mini-widget-loading",children:t.jsx("div",{className:"mini-widget-loading-spinner"})})}function ve({message:e}){return t.jsx("div",{className:"mini-widget-error",children:t.jsx("span",{title:e,children:"No data"})})}function ge({title:e,icon:s,value:a,unit:n,valueSize:l="md",status:i,subtitle:r,trend:o,children:c,isLoading:d=!1,error:u,className:m="",onClick:x}){const h=["mini-widget-value","lg"===l&&"mini-widget-value-lg","sm"===l&&"mini-widget-value-sm",""].filter(Boolean).join(" "),p=["mini-widget",x&&"cursor-pointer",m].filter(Boolean).join(" ");return t.jsxs("div",{className:p,onClick:x,role:x?"button":void 0,children:[t.jsxs("div",{className:"mini-widget-header",children:[s,t.jsx("span",{className:"mini-widget-title",children:e}),i&&"unknown"!==i&&t.jsx("div",{className:`mini-widget-status-dot ${i}`}),o&&t.jsx(he,{trend:o})]}),d?t.jsx(pe,{}):u?t.jsx(ve,{message:u}):t.jsxs(t.Fragment,{children:[void 0!==a&&t.jsxs("div",{className:h,children:[a,n&&t.jsx("span",{className:"mini-widget-unit",children:n})]}),r&&t.jsx("div",{className:"mini-widget-subtitle",children:r}),c]})]})}const fe=b.createContext({lbtStats:null,noiseFloor:null,hourlyNoiseFloor:[],linkQuality:null,channelHealth:null,trends:null,stats:null,recentPackets:[],quickNeighbors:[],isLoading:!0,error:null,refresh:async()=>{}});function je(e){if(!e)return[];try{const t=JSON.parse(e);if(Array.isArray(t))return t.map(Number).filter(e=>!isNaN(e))}catch{}return[]}function be(e,t,s=2,a=!1){if(null===t)return"stable";const n=e-t;return(0!==t?100*Math.abs(n/t):Math.abs(n))<s?"stable":a?n>0?"up":"down":n>0?"down":"up"}function ye({children:e}){const a=o(),n=s(),l=c(),i=d(),r=null===a,m=b.useMemo(()=>function(e){const t=Math.floor(Date.now()/1e3),s=t-86400,a=e.filter(e=>e.timestamp>=s&&void 0!==e.lbt_attempts&&e.lbt_attempts>0),n=a.length,l=a.filter(e=>(e.lbt_attempts??0)>1).length,i=n>0?l/n*100:0,r=a.filter(e=>(e.lbt_attempts??0)>1),o=r.length>0?r.reduce((e,t)=>e+(t.lbt_attempts??0),0)/r.length:0,c=a.filter(e=>!0===e.lbt_channel_busy||1===e.lbt_channel_busy).length,d=n>0?c/n*100:0,u=[];for(const f of a){const e=je(f.lbt_backoff_delays_ms);u.push(...e)}const m=u.reduce((e,t)=>e+t,0),x=u.length>0?m/u.length:0,h=u.length>0?Math.max(...u):0,p=[],v=[],g=[];for(let f=0;f<24;f++){const e=t-3600*(24-f),s=e+3600,n=a.filter(t=>t.timestamp>=e&&t.timestamp<s),l=n.filter(e=>(e.lbt_attempts??0)>1).length,i=n.length>0?l/n.length*100:0;p.push(i);const r=[];for(const t of n){const e=je(t.lbt_backoff_delays_ms);r.push(...e)}const o=r.length>0?r.reduce((e,t)=>e+t,0)/r.length:0;if(g.push(o),0===n.length)v.push(0);else{const e=n.filter(e=>!0===e.lbt_channel_busy||1===e.lbt_channel_busy).length,t=r.length>0?Math.max(...r):0,s=Math.min(n.length/5,1),a=.15,l=Math.log(1+i*a)/Math.log(1+100*a)*40,c=e/n.length*100,d=Math.min(.5*c,25);let u=0;o>100&&(u=Math.min(8*Math.log10(o/100),15));let m=0;t>500&&o>0&&t>2*o&&(m=Math.min((t-500)/200,5));const x=l+d+u+m;v.push(Math.min(x*s,85))}}return{totalPacketsWithLBT:n,packetsWithRetries:l,retryRate:i,avgRetries:o,channelBusyCount:c,channelBusyRate:d,avgBackoffMs:x,maxBackoffMs:h,totalBackoffMs:m,hourlyRetryRates:p,hourlyCollisionRisk:v,hourlyAvgBackoffMs:g,windowHours:24,packetCount:e.length}}(n),[n]),x=(null==a?void 0:a.noise_floor_dbm)??null,[h,p]=b.useState([]),v=b.useRef(0);b.useEffect(()=>{const e=async()=>{var e;const t=Date.now();if(!(t-v.current<6e4)){v.current=t;try{const t=await u(24);if(t.success&&(null==(e=t.data)?void 0:e.history)){const e=Math.floor(Date.now()/1e3),s=[];for(let a=0;a<24;a++){const n=e-3600*(24-a),l=n+3600,i=t.data.history.filter(e=>e.timestamp>=n&&e.timestamp<l);if(i.length>0){const e=i.reduce((e,t)=>e+t.noise_floor_dbm,0)/i.length;s.push(e)}else s.push(s.length>0?s[s.length-1]:-100)}p(s)}}catch{}}};e();const t=setInterval(e,6e4);return()=>clearInterval(t)},[]);const g=null==a?void 0:a.neighbors,f=b.useMemo(()=>{const e=g??{};return Object.fromEntries(Object.entries(e).filter(([e])=>!i.has(e)))},[g,i]),j=b.useMemo(()=>l.filter(e=>!i.has(e.hash)),[l,i]),y=b.useMemo(()=>function(e,t){if(0===e.length)return{neighbors:[],networkScore:0,neighborCount:0,bestLink:null,worstLink:null};const s=e.map(e=>{const s=function(e,t){let s=50;void 0!==e&&(s=e>=10?100:e>=5?80:e>=0?60:e>=-5?40:20);let a=50;return void 0!==t&&(a=t>=-70?100:t>=-80?80:t>=-90?60:t>=-100?40:20),Math.round(.6*s+.4*a)}(e.avgSnr??void 0,e.avgRssi??void 0),a=t[e.hash];return{name:(null==a?void 0:a.name)||(null==a?void 0:a.node_name)||e.prefix,hash:e.hash,rssi:e.avgRssi??-100,snr:e.avgSnr??-10,score:s,advertCount:e.count}});s.sort((e,t)=>t.score-e.score);const a=s.length>0?s.reduce((e,t)=>e+t.score,0)/s.length:0;return{neighbors:s,networkScore:Math.round(a),neighborCount:s.length,bestLink:s.length>0?{name:s[0].name,score:s[0].score}:null,worstLink:s.length>0?{name:s[s.length-1].name,score:s[s.length-1].score}:null}}(j,f),[j,f]),k=b.useMemo(()=>function(e,t,s){const a=e?Math.max(0,Math.min(100,100-5*e.retryRate)):50;let n=50;null!==t&&(n=Math.max(0,Math.min(100,(t+120)/30*100)));const l=(null==s?void 0:s.networkScore)??50,i=Math.round(.35*a+.25*n+.4*l);let r;return r=i>=85?"excellent":i>=70?"good":i>=50?"fair":i>=30?"congested":"critical",{score:i,status:r,components:{lbtHealth:Math.round(a),noiseHealth:Math.round(n),linkHealth:Math.round(l)}}}(m,x,y),[m,x,y]),[N,w]=b.useState({noiseFloor:null,networkScore:null,channelHealth:null}),M=b.useRef(0);b.useEffect(()=>{const e=()=>{const e=Date.now();e-M.current>3e4&&(M.current=e,w({noiseFloor:x,networkScore:(null==y?void 0:y.networkScore)??null,channelHealth:(null==k?void 0:k.score)??null}))};e();const t=setInterval(e,5e3);return()=>clearInterval(t)},[x,null==y?void 0:y.networkScore,null==k?void 0:k.score]);const _=b.useMemo(()=>({noiseFloor:{current:x,previous:N.noiseFloor,trend:null!==x?be(x,N.noiseFloor,2,!0):"stable"},networkScore:{current:(null==y?void 0:y.networkScore)??0,previous:N.networkScore,trend:be((null==y?void 0:y.networkScore)??0,N.networkScore,3,!1)},channelHealth:{current:(null==k?void 0:k.score)??0,previous:N.channelHealth,trend:be((null==k?void 0:k.score)??0,N.channelHealth,3,!1)}}),[x,null==y?void 0:y.networkScore,null==k?void 0:k.score,N]),L={lbtStats:m,noiseFloor:x,hourlyNoiseFloor:h,linkQuality:y,channelHealth:k,trends:_,stats:a,recentPackets:n,quickNeighbors:l,isLoading:r,error:null,refresh:async()=>{}};return t.jsx(fe.Provider,{value:L,children:e})}function ke(){const e=b.useContext(fe);if(void 0===e)throw new Error("useLBTData must be used within an LBTDataProvider");return e}const Ne={excellent:"var(--signal-excellent)",good:"var(--signal-good)",fair:"var(--signal-fair)",congested:"var(--signal-poor)",critical:"var(--signal-critical)",unknown:"var(--text-muted)"};function we(e,t){return 0===e?"No backoffs":`${t.toFixed(0)}% retry rate`}function Me(){const{lbtStats:e,isLoading:s,error:a}=ke(),n=m(),l=(null==e?void 0:e.avgBackoffMs)??0,i=(null==e?void 0:e.retryRate)??0,r=e?(o=l)<100?"excellent":o<250?"good":o<500?"fair":o<1e3?"congested":"critical":"unknown";var o;const c=null==e?void 0:e.hourlyAvgBackoffMs,d=b.useMemo(()=>!c||c.length<2?[]:c.map(e=>({value:e})),[c]),u=Ne[r];return t.jsx(ge,{title:"LBT Backoff",icon:t.jsx(se,{className:"mini-widget-icon"}),value:Math.round(l),unit:"ms",status:r,subtitle:e?we(l,i):void 0,isLoading:s,error:a,onClick:()=>n("/packets"),children:t.jsx("div",{className:"mini-widget-sparkline",children:d.length>0?t.jsx(y,{width:"100%",height:"100%",minWidth:1,minHeight:1,children:t.jsx(k,{data:d,margin:{top:2,right:2,bottom:2,left:2},children:t.jsx(N,{type:"monotone",dataKey:"value",stroke:u,strokeWidth:1,dot:!1,isAnimationActive:!1})})}):t.jsx("div",{className:"h-full"})})})}function _e(){const{lbtStats:e,isLoading:s,error:a}=ke(),n=m(),l=(null==e?void 0:e.channelBusyCount)??0,i=(null==e?void 0:e.totalPacketsWithLBT)??0,r=(null==e?void 0:e.channelBusyRate)??0,o=e?(c=r)<.5?"excellent":c<1?"good":c<2?"fair":c<5?"congested":"critical":"unknown";var c;return t.jsx(ge,{title:"Ch. Busy",icon:t.jsx(ee,{className:"mini-widget-icon"}),value:l,status:o,subtitle:e?`${r.toFixed(2)}% of ${i} TX`:void 0,isLoading:s,error:a,onClick:()=>n("/packets")})}function Le(e){return null===e?"No reading":e<-115?"Very quiet":e<-105?"Quiet":e<-95?"Moderate":e<-85?"Elevated":"High interference"}const Se={excellent:"var(--signal-excellent)",good:"var(--signal-good)",fair:"var(--signal-fair)",congested:"var(--signal-poor)",critical:"var(--signal-critical)",unknown:"var(--text-muted)"};function Ce(){const{noiseFloor:e,hourlyNoiseFloor:s,trends:a,isLoading:n,error:l}=ke(),i=null===(r=e)||r<-110?"excellent":r<-100?"good":r<-90?"fair":r<-80?"congested":"critical";var r;const o=null==a?void 0:a.noiseFloor.trend,c=b.useMemo(()=>!s||s.length<2?[]:s.map(e=>({value:e})),[s]),d=Se[i];return t.jsx(ge,{title:"Noise Floor",icon:t.jsx(Z,{className:"mini-widget-icon"}),value:null!==e?Math.round(e):"—",unit:null!==e?"dBm":void 0,status:i,trend:o,subtitle:Le(e),isLoading:n,error:l,children:t.jsx("div",{className:"mini-widget-sparkline",children:c.length>0?t.jsx(y,{width:"100%",height:"100%",minWidth:1,minHeight:1,children:t.jsx(k,{data:c,margin:{top:2,right:2,bottom:2,left:2},children:t.jsx(N,{type:"monotone",dataKey:"value",stroke:d,strokeWidth:1,dot:!1,isAnimationActive:!1})})}):t.jsx("div",{className:"h-full"})})})}function Be(e,t=8){return e.length<=t?e:e.substring(0,t-1)+"…"}function Fe(){const{linkQuality:e,isLoading:s,error:a}=ke(),n=m(),l=null==e?void 0:e.bestLink,i=null==e?void 0:e.worstLink,r=i?(o=i.score)>=60?"excellent":o>=40?"good":o>=25?"fair":o>=10?"congested":"critical":"unknown";var o;const c=e&&l&&i?t.jsxs("div",{className:"flex flex-col gap-0.5 mt-auto",children:[t.jsxs("div",{className:"flex items-center justify-between text-xs",children:[t.jsx("span",{className:"text-text-muted",children:"Best:"}),t.jsxs("span",{className:"font-mono text-signal-excellent",children:[Be(l.name)," (",Math.round(l.score),")"]})]}),t.jsxs("div",{className:"flex items-center justify-between text-xs",children:[t.jsx("span",{className:"text-text-muted",children:"Worst:"}),t.jsxs("span",{className:"font-mono "+(i.score>=40?"text-signal-fair":"text-signal-critical"),children:[Be(i.name)," (",Math.round(i.score),")"]})]})]}):e&&0===e.neighborCount?t.jsx("div",{className:"flex items-center justify-center text-xs text-text-muted mt-auto",children:"No direct neighbors"}):null;return t.jsx(ge,{title:"Link Range",icon:t.jsx(W,{className:"mini-widget-icon"}),status:r,isLoading:s,error:a,onClick:()=>n("/contacts"),children:c})}const Re={excellent:"var(--signal-excellent)",good:"var(--signal-good)",fair:"var(--signal-fair)",congested:"var(--signal-poor)",critical:"var(--signal-critical)",unknown:"var(--text-muted)"};function Te(){const{lbtStats:e,isLoading:s,error:a}=ke(),n=e?function(e){const{retryRate:t,channelBusyCount:s,totalPacketsWithLBT:a,avgBackoffMs:n,maxBackoffMs:l}=e;if(0===a)return 0;const i=Math.min(a/10,1),r=Math.log(1+.15*t)/Math.log(16)*40,o=s/a*100,c=Math.min(.5*o,25);let d=0;n>100&&(d=Math.min(8*Math.log10(n/100),15));let u=0;l>500&&n>0&&l>2*n&&(u=Math.min((l-500)/200,5));const m=(r+c+d+u)*i;return Math.min(m,85)}(e):0,l=e?(i=n)<15?"excellent":i<30?"good":i<45?"fair":i<60?"congested":"critical":"unknown";var i;const r=(null==e?void 0:e.maxBackoffMs)??0,o=e?r>200?`Max backoff: ${Math.round(r)}ms`:function(e){return e<15?"Clear channel":e<30?"Light traffic":e<45?"Moderate traffic":e<60?"Heavy traffic":e<75?"Congested":"Severe congestion"}(n):void 0,c=null==e?void 0:e.hourlyCollisionRisk,d=b.useMemo(()=>!c||c.length<2?[]:c.map(e=>({value:e})),[c]),u=Re[l];return t.jsx(ge,{title:"Collision Risk",icon:t.jsx(V,{className:"mini-widget-icon"}),value:n.toFixed(1),unit:"%",status:l,subtitle:o,isLoading:s,error:a,children:t.jsx("div",{className:"mini-widget-sparkline",children:d.length>0?t.jsx(y,{width:"100%",height:"100%",minWidth:1,minHeight:1,children:t.jsx(k,{data:d,margin:{top:2,right:2,bottom:2,left:2},children:t.jsx(N,{type:"monotone",dataKey:"value",stroke:u,strokeWidth:1,dot:!1,isAnimationActive:!1})})}):t.jsx("div",{className:"h-full"})})})}function He(){const[e,s]=b.useState(!1),[a]=b.useState(0),{stats:n,lbtStats:l,isLoading:r}=ke(),o=b.useMemo(()=>{if(!n)return null;const e=n.airtime_used_ms??0,t=n.max_airtime_ms??1;return{usedMs:e,maxMs:t,remainingMs:n.airtime_remaining_ms??0,utilizationPercent:n.utilization_percent??(t>0?e/t*100:0)}},[n]),c=b.useMemo(()=>{if(!l||0===l.totalPacketsWithLBT)return 100;const e=l.channelBusyCount,t=l.totalPacketsWithLBT;return(t-e)/t*100},[l]),d=(null==o?void 0:o.utilizationPercent)??0,u=(m=d)<30?"excellent":m<50?"good":m<70?"fair":m<90?"congested":"critical";var m;const x=(null==o?void 0:o.remainingMs)??0,h=c<99?`${c.toFixed(0)}% TX success`:((p=x)<1e3?`${Math.round(p)}ms`:p<6e4?`${(p/1e3).toFixed(1)}s`:`${(p/6e4).toFixed(1)}m`)+" remaining";var p;const v=o?t.jsx("div",{className:"mini-widget-progress mt-auto",children:t.jsx("div",{className:`mini-widget-progress-bar ${u}`,style:{width:`${Math.min(d,100)}%`}})}):null;return t.jsx(ge,{title:"Duty Cycle",icon:t.jsx(i,{className:"mini-widget-icon"}),value:d.toFixed(1),unit:"%",status:u,subtitle:h,isLoading:r,children:v})}function Pe({className:e=""}){return t.jsx(ye,{children:t.jsxs("div",{className:`mesh-health-container ${e}`,children:[t.jsxs("div",{className:"mesh-health-header",children:[t.jsx(te,{className:"w-4 h-4 text-accent-primary"}),t.jsx("span",{className:"type-label text-text-muted",children:"MESH HEALTH"})]}),t.jsxs("div",{className:"widget-row",children:[t.jsx(Me,{}),t.jsx(Te,{}),t.jsx(Ce,{}),t.jsx(He,{}),t.jsx(_e,{}),t.jsx(Fe,{})]})]})})}function De(){var e;const s=o(),a=x(),n=h(),l=B(),r=F(),[c,d]=b.useState(4),[u,m]=b.useState(null),[k,N]=b.useState(!1),[R,T]=b.useTransition(),H=p[c],P=b.useMemo(()=>function(e,t){if(!e||0===e.length)return[];const s=t>1440;return e.map(e=>{const t=new Date(1e3*e.start);return{time:s?t.toLocaleDateString([],{weekday:"short",hour:"2-digit",minute:"2-digit",hour12:!1}):t.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hour12:!1}),received:e.count}})}(null==u?void 0:u.received,H.minutes),[null==u?void 0:u.received,H.minutes]),D=b.useMemo(()=>{const e=P.length;return e<=12?0:e<=24?2:e<=48?5:e<=72?8:Math.floor(e/7)},[P.length]),$=b.useCallback(async e=>{try{const t=p[e],s=await v(t.minutes,t.buckets);if(s.success&&s.data){const e=s.data;T(()=>{m(e)})}}catch{}},[]),W=b.useCallback(e=>{d(e),$(e)},[$]);b.useEffect(()=>{$(c);const e=setInterval(()=>{$(c)},g.charts);return()=>clearInterval(e)},[c,$]),b.useEffect(()=>{if(n>0){const e=requestAnimationFrame(()=>N(!0)),t=setTimeout(()=>N(!1),600);return()=>{cancelAnimationFrame(e),clearTimeout(t)}}},[n]);const q=(null==s?void 0:s.uptime_seconds)?f(s.uptime_seconds):"0m",K=(null==s?void 0:s.node_name)||(null==(e=null==s?void 0:s.config)?void 0:e.node_name)||"Unknown Node",V=b.useMemo(()=>{var e,t,s,a;const n=(null==(e=null==u?void 0:u.received)?void 0:e.reduce((e,t)=>e+t.count,0))??0,l=(null==(t=null==u?void 0:u.forwarded)?void 0:t.reduce((e,t)=>e+t.count,0))??0,i=(null==(s=null==u?void 0:u.dropped)?void 0:s.reduce((e,t)=>e+t.count,0))??0,r=(null==(a=null==u?void 0:u.transmitted)?void 0:a.reduce((e,t)=>e+t.count,0))??0,o=((null==u?void 0:u.time_range_minutes)??H.minutes)/60;return{received:n,forwarded:l,dropped:i,transmitted:r,rxPerHour:o>0?Math.round(n/o):0,fwdPerHour:o>0?Math.round(l/o):0}},[u,H.minutes]);return a?t.jsxs(O,{className:"p-8 text-center",children:[t.jsx("p",{className:"type-subheading text-accent-red mb-2",children:"Failed to connect to backend"}),t.jsx("p",{className:"type-body text-white/50",children:a}),t.jsx("p",{className:"type-data-sm text-white/40 mt-4",children:"Make sure the Python backend is running on port 8000"})]}):t.jsxs(U,{children:[t.jsx(X,{title:K,icon:t.jsx(G,{}),controls:t.jsx(z,{ranges:p,selectedIndex:c,onSelect:W,isPending:R})}),t.jsx(J,{template:"hero",children:t.jsxs(O,{className:"relative",children:[k&&t.jsx("div",{className:"flash-overlay"}),t.jsx(Q,{icon:t.jsx(I,{}),title:"RECEIVED",badge:H.label,iconColor:"text-accent-success"}),t.jsx("div",{className:"type-hero font-semibold",style:{color:l.received},children:V.received.toLocaleString()}),t.jsxs("div",{className:"type-body-sm text-text-muted mt-1",children:[V.rxPerHour,"/hr rate"]}),P.length>0?t.jsx("div",{className:"mt-4",style:{height:180},children:t.jsx(y,{width:"100%",height:"100%",minWidth:1,minHeight:1,children:t.jsxs(w,{data:P,children:[t.jsx("defs",{children:t.jsxs("linearGradient",{id:"gradient-received",x1:"0",y1:"0",x2:"0",y2:"1",children:[t.jsx("stop",{offset:"5%",stopColor:l.received,stopOpacity:.3}),t.jsx("stop",{offset:"95%",stopColor:l.received,stopOpacity:0})]})}),t.jsx(M,{strokeDasharray:"3 3",stroke:r.grid,vertical:!1}),t.jsx(_,{dataKey:"time",axisLine:!1,tickLine:!1,tick:{fill:r.axisTick,fontSize:10,fontFamily:"'JetBrains Mono', monospace"},dy:8,interval:D,minTickGap:20}),t.jsx(L,{axisLine:!1,tickLine:!1,tick:{fill:r.axisTick,fontSize:10,fontFamily:"'JetBrains Mono', monospace"},dx:-8,width:40}),t.jsx(S,{content:t.jsx(ce,{color:l.received,labelKey:"time",unit:" packets"}),cursor:{stroke:r.cursor,strokeWidth:1}}),t.jsx(C,{type:"stepAfter",dataKey:"received",stroke:l.received,fill:"url(#gradient-received)",strokeWidth:1,dot:!1,activeDot:{r:4,strokeWidth:0,fill:l.received},isAnimationActive:!1})]})})}):t.jsx("div",{className:"flex-1 flex items-center justify-center text-text-muted",children:"No data available for this time range"})]})}),t.jsxs(J,{template:"compact",children:[t.jsx(re,{title:"FORWARDED",value:V.forwarded,subtitle:`${V.fwdPerHour}/hr rate`,color:"forwarded",buckets:null==u?void 0:u.forwarded,timeRangeLabel:H.label,icon:t.jsx(Y,{className:"w-4 h-4"})}),t.jsx(re,{title:"DROPPED",value:V.dropped,subtitle:"Filtered or duplicate",color:"dropped",buckets:null==u?void 0:u.dropped,timeRangeLabel:H.label,icon:t.jsx(A,{className:"w-4 h-4"})}),t.jsx(xe,{stats:s,receivedBuckets:null==u?void 0:u.received,droppedBuckets:null==u?void 0:u.dropped,forwardedBuckets:null==u?void 0:u.forwarded,bucketDurationSeconds:null==u?void 0:u.bucket_duration_seconds,timeRangeLabel:H.label}),t.jsx(re,{title:"UPTIME",value:q,subtitle:"Since last restart",color:"neutral",icon:t.jsx(j,{className:"w-4 h-4"})})]}),t.jsx(Pe,{}),t.jsx(oe,{}),s&&t.jsx(J,{template:"auto",children:t.jsxs(O,{children:[t.jsx(Q,{icon:t.jsx(i,{}),title:"Node Information",largeTitle:!0}),t.jsxs("div",{className:"grid grid-cols-2 lg:grid-cols-4 gap-4",children:[t.jsxs("div",{children:[t.jsx("span",{className:"type-label text-text-muted",children:"Node Name"}),t.jsx("p",{className:"type-body text-text-primary mt-1",children:K})]}),t.jsxs("div",{children:[t.jsx("span",{className:"type-label text-text-muted",children:"Version"}),t.jsxs("p",{className:"type-data text-text-primary mt-1",children:["v",s.version]})]}),t.jsxs("div",{children:[t.jsx("span",{className:"type-label text-text-muted",children:"Core Version"}),t.jsxs("p",{className:"type-data text-text-primary mt-1",children:["v",s.core_version]})]}),t.jsxs("div",{children:[t.jsx("span",{className:"type-label text-text-muted",children:"Local Hash"}),t.jsx("div",{className:"mt-1",children:s.local_hash?t.jsx(E,{hash:s.local_hash,size:"sm"}):t.jsx("span",{className:"type-data-sm text-text-muted",children:"N/A"})})]})]}),s.public_key&&t.jsxs("div",{className:"mt-4 pt-4 border-t border-border-subtle",children:[t.jsx("span",{className:"type-label text-text-muted",children:"Public Key"}),t.jsx("div",{className:"mt-1",children:t.jsx(E,{hash:s.public_key,prefixLength:12,suffixLength:8})})]})]})})]})}export{De as default};
