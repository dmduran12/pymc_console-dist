var w=Object.defineProperty;var Y=(s,e,t)=>e in s?w(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var f=(s,e,t)=>Y(s,typeof e!="symbol"?e+"":e,t);import{bt as M,es as V,et as F,eu as U,ev as I,br as O,ew as b,ex as G,e6 as B,e4 as $,e5 as v,ey as K,ez as g,dl as a,eA as S,eB as z,eC as R,eD as C,eE as k,eF as D,eG as W,eH as Z,eI as X,eJ as E,eK as H,eL as x,eM as j,eN as q,eO as Q,eP as J,eQ as ee,eR as te,ed as se,ec as re,eS as ne,eg as ae,eT as ce,eU as ie,eV as he,eW as T,eX as m,eY as oe,eZ as le,e_ as ue,e$ as pe,f0 as ge,ee as N,ef as de,f1 as fe,f2 as Te,f3 as Ae,f4 as _e,f5 as ye}from"./index-C8IY8K2r.js";class L{constructor(){f(this,"header",0);f(this,"transportCodes",[0,0]);f(this,"pathLen",0);f(this,"path",new Uint8Array(0));f(this,"payload",new Uint8Array(0));f(this,"decrypted",{});f(this,"_rssi",0);f(this,"_snr",0)}static fromBytes(e){const t=new L;try{return t.readFrom(e),{success:!0,packet:t}}catch(r){return{success:!1,error:r instanceof Error?r.message:String(r)}}}static fromHex(e){try{const t=M(e);return L.fromBytes(t)}catch(t){return{success:!1,error:t instanceof Error?t.message:String(t)}}}get routeType(){return this.header&V}get routeTypeName(){return F[this.routeType]??`UNKNOWN(${this.routeType})`}get payloadType(){return this.header>>U&I}get payloadTypeName(){return O[this.payloadType]??`UNKNOWN(${this.payloadType})`}get payloadVersion(){return this.header>>b&G}hasTransportCodes(){return B(this.routeType)}isFlood(){return $(this.routeType)}isDirect(){return v(this.routeType)}get pathBytes(){return Array.from(this.path)}get pathString(){return K(this.path)}get pathHexArray(){return Array.from(this.path).map(e=>g(e,!0))}get payloadLen(){return this.payload.length}get payloadHex(){return a(this.payload,!0)}getPayloadAppData(){const e=E+H+x;return this.payload.length>=e?this.payload.slice(e):new Uint8Array(0)}get rssi(){return this._rssi}set rssi(e){this._rssi=e}get snr(){return this._snr}set snr(e){this._snr=e}readFrom(e){let t=0;const r=e.length;S(t,1,r,"Missing header byte"),this.header=e[t++];const n=this.payloadVersion;if(n>z)throw new Error(`Unsupported packet version: ${n}`);if(this.hasTransportCodes()?(S(t,4,r,"Missing transport codes"),this.transportCodes=[R(e,t),R(e,t+2)],t+=4):this.transportCodes=[0,0],S(t,1,r,"Missing path_len"),this.pathLen=e[t++],this.pathLen>C)throw new Error(`path_len too large: ${this.pathLen} > ${C}`);return S(t,this.pathLen,r,"Truncated path"),this.path=e.slice(t,t+this.pathLen),t+=this.pathLen,this.payload=e.slice(t),k(this.payload.length),!0}writeTo(){let e=1;this.hasTransportCodes()&&(e+=4),e+=1,e+=this.path.length,e+=this.payload.length;const t=new Uint8Array(e);let r=0;return t[r++]=this.header,this.hasTransportCodes()&&(D(this.transportCodes[0],t,r),D(this.transportCodes[1],t,r+2),r+=4),t[r++]=this.path.length,t.set(this.path,r),r+=this.path.length,t.set(this.payload,r),t}toHex(){return a(this.writeTo(),!0)}async calculateHash(){return W(this.payloadType,this.pathLen,this.payload)}async calculateHashString(e){return Z(this.payloadType,this.pathLen,this.payload,e)}async calculateCRC(){return X(this.payloadType,this.pathLen,this.payload)}getRawLength(){let e=2+this.pathLen+this.payload.length;return this.hasTransportCodes()&&(e+=4),e}getSummary(){return{header:g(this.header,!0),routeType:this.routeTypeName,payloadType:this.payloadTypeName,version:this.payloadVersion,pathLen:this.pathLen,pathStr:this.pathString,transportCodes:this.hasTransportCodes()?[this.transportCodes[0].toString(16).toUpperCase().padStart(4,"0"),this.transportCodes[1].toString(16).toUpperCase().padStart(4,"0")]:null,payloadLen:this.payload.length,payloadHex:this.payloadHex,rawLength:this.getRawLength()}}toString(){const e=[`[${this.routeTypeName}/${this.payloadTypeName} v${this.payloadVersion}]`,`path=${this.pathString||"(empty)"}`,`payload=${this.payload.length}B`];return this.hasTransportCodes()&&e.push(`transport=[${this.transportCodes[0]},${this.transportCodes[1]}]`),e.join(" ")}}function Ee(s){const e=E+H+x+1;if(s.length<e)return null;let t=0;const r=a(s.slice(t,t+E));t+=E;const n=m(s,t);t+=H;const o=a(s.slice(t,t+x));t+=x;const c=s[t++],i=oe(c),h=c&ye;let l="unknown";switch(h){case _e:l="chat";break;case Ae:l="repeater";break;case Te:l="room_server";break;case fe:l="sensor";break}const u={type:"advert",publicKey:r,timestamp:n,signature:o,flags:c,flagsDescription:i,nodeType:l,rawAppData:a(s.slice(E+H+x))};if(c&le&&t+8<=s.length){const p=s.slice(t,t+8),A=new ArrayBuffer(8);new Uint8Array(A).set(p);const P=new DataView(A),_=P.getInt32(0,!0),y=P.getInt32(4,!0);u.latitude=_/1e6,u.longitude=y/1e6,t+=8}if(c&ue&&(t+=2),c&pe&&(t+=2),c&ge&&t<s.length){let p=t;for(;p<s.length&&s[p]!==0;)p++;p>t&&(u.name=new TextDecoder().decode(s.slice(t,p)))}return u}function xe(s){if(s.length<4)return null;const e=m(s,0);return{type:"ack",crc:e.toString(16).toUpperCase().padStart(8,"0"),crcValue:e}}function me(s){if(s.length===0)return{type:"path",pathLength:0,path:[],pathString:""};const e=s[0];if(s.length<1+e+1){const i=Math.min(e,s.length-1),h=Array.from(s.slice(1,1+i)).map(l=>g(l,!0));return{type:"path",pathLength:e,path:h,pathString:h.join("->")}}const t=Array.from(s.slice(1,1+e)).map(i=>g(i,!0)),r=t.join("->"),n=s[1+e],o=O[n]??`UNKNOWN(${n})`;let c;return s.length>1+e+1&&(c=a(s.slice(1+e+1))),{type:"path",pathLength:e,path:t,pathString:r,extraType:n,extraTypeName:o,extraData:c}}function Se(s){if(s.length<9)return{type:"trace",traceTag:"00000000",traceTagValue:0,authCode:0,flags:0,pathHashes:[],pathString:"",snrValues:[],isComplete:!1,path:[],targetHash:""};const e=m(s,0),t=e.toString(16).toUpperCase().padStart(8,"0"),r=m(s,4),n=s[8],o=s.slice(9),c=Array.from(o).map(h=>g(h,!0)),i=c.join("->");return{type:"trace",traceTag:t,traceTagValue:e,authCode:r,flags:n,pathHashes:c,pathString:i,snrValues:[],isComplete:!1,path:c,targetHash:c.length>0?c[0]:""}}function He(s,e){const t=Se(s);if(!t)return null;const r=[],n=e instanceof Uint8Array?Array.from(e):e;for(let c=0;c<n.length;c++){let i=n[c];i>127&&(i-=256);const h=i/4;r.push(Math.max(-20,Math.min(15,h)))}const o=r.length>=t.pathHashes.length;return{...t,snrValues:r,isComplete:o}}function Pe(s,e=0){const t=e>=1?2:1,r=T,n=t*2+r;if(s.length<n)return null;const o=a(s.slice(0,t),!0),c=a(s.slice(t,t*2),!0),i=t*2,h=a(s.slice(i,i+r)),l=s.slice(i+r);let u="",p=!0;try{const A=new TextDecoder("utf-8",{fatal:!0}).decode(l);/^[\x20-\x7E\u00A0-\uFFFF\n\r\t]*$/.test(A)&&(u=A,p=!1)}catch{}return p&&(u=a(l)),{type:"txt_msg",destHash:o,srcHash:c,cipherMac:h,timestamp:0,text:u,ciphertextHex:p?a(l):void 0,encrypted:p}}function Le(s,e=0){const t=e>=1?4:T,r=1+t+1;if(s.length<r)return null;const n=s[0],o=g(n,!0),c=s.slice(1,1+t),i=s.slice(1+t);return{type:"grp_txt",channelHash:o,text:a(i),decrypted:!1,ciphertextHex:a(i),macHex:a(c)}}async function Ve(s,e=0){const t=e>=1?4:T,r=1+t+1;if(s.length<r)return null;const n=s[0],o=g(n,!0),c=s.slice(1,1+t),i=s.slice(1+t),h={type:"grp_txt",channelHash:o,text:a(i),decrypted:!1,ciphertextHex:a(i),macHex:a(c)};try{const l=await N(n,c,i);if(l&&l.plaintext.length>=5){h.channelName=l.channelName;const u=l.plaintext,p=m(u,0),A=u[4],_=new TextDecoder("utf-8",{fatal:!1}).decode(u.slice(5)).replace(/\uFFFD/g,"").replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F-\x9F]/g,"").replace(/\x00+$/,"").trim();h.decrypted=!0,h.isPublicHashChannel=!0,h.timestamp=p,h.flags=A,l.macCorrupted&&(h.macCorrupted=!0);const y=_.indexOf(": ");y>0?(h.senderName=_.slice(0,y),h.text=_.slice(y+2)):h.text=_}else{const u=await de(n);h.isPublicHashChannel=u.length>0}}catch{}return h}function Re(s){if(s.length<1+T+1)return null;const e=s[0],t=g(e,!0),r=s.slice(1,1+T),n=s.slice(1+T);return{type:"grp_data",channelHash:t,dataHex:a(n),dataLength:n.length,decrypted:!1,macHex:a(r)}}async function Fe(s){if(s.length<1+T+1)return null;const e=s[0],t=g(e,!0),r=s.slice(1,1+T),n=s.slice(1+T),o={type:"grp_data",channelHash:t,dataHex:a(n),dataLength:n.length,decrypted:!1,macHex:a(r)};try{const c=await N(e,r,n);c&&(o.channelName=c.channelName,o.decrypted=!0,o.decryptedHex=a(c.plaintext))}catch{}return o}function Ce(s){if(s.length<4)return null;const e=a(s.slice(0,2)),t=s[2],r=s[3],n=a(s.slice(4));return{type:"multipart",messageId:e,partNumber:t,totalParts:r,partData:n}}function De(s){if(s.length<1)return null;const e=s[0],t=e>>4&15,r=e&15,o={8:"DISCOVER_REQ",9:"DISCOVER_RESP"}[t]??`0x${t.toString(16)}`;return{type:"control",controlType:e,subtype:t,subtypeFlags:r,subtypeName:o,dataHex:a(s.slice(1)),dataLength:s.length-1,isInternal:t>=8}}function Oe(s){if(s.length<4)return null;const e=g(s[0],!0),t=g(s[1],!0),r=a(s.slice(2,4)),n=s.slice(4);return{type:"req",destHash:e,srcHash:t,cipherMac:r,ciphertextHex:a(n),ciphertextLength:n.length}}function Ne(s){if(s.length<4)return null;const e=g(s[0],!0),t=g(s[1],!0),r=a(s.slice(2,4)),n=s.slice(4);return{type:"response",destHash:e,srcHash:t,cipherMac:r,ciphertextHex:a(n),ciphertextLength:n.length}}function we(s){if(s.length<35)return null;const e=g(s[0],!0),t=a(s.slice(1,33)),r=a(s.slice(33,35)),n=s.slice(35);return{type:"anon_req",destHash:e,senderPublicKey:t,cipherMac:r,ciphertextHex:a(n),ciphertextLength:n.length}}function d(s,e,t){return{type:"generic",payloadType:e,payloadTypeName:t,rawHex:a(s),length:s.length}}function Ue(s){const{payload:e,payloadType:t,payloadTypeName:r}=s;switch(t){case he:return Ee(e)??d(e,t,r);case ie:return xe(e)??d(e,t,r);case ce:return me(e)??d(e,t,r);case ae:return He(e,s.path)??d(e,t,r);case ne:return Pe(e,s.payloadVersion)??d(e,t,r);case re:return Le(e,s.payloadVersion)??d(e,t,r);case se:return Re(e)??d(e,t,r);case te:return Ce(e)??d(e,t,r);case ee:return De(e)??d(e,t,r);case J:return Oe(e)??d(e,t,r);case Q:return Ne(e)??d(e,t,r);case q:return we(e)??d(e,t,r);case j:default:return d(e,t,r)}}export{L as P,Ve as a,Fe as b,Ue as c,Pe as d,He as e,Ee as f};
