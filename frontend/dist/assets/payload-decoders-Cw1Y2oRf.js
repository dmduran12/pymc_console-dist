var t=Object.defineProperty,e=(e,a,s)=>((e,a,s)=>a in e?t(e,a,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[a]=s)(e,"symbol"!=typeof a?a+"":a,s);import{ar as a,cL as s,cM as r,cN as n,cO as h,ap as i,cP as c,cQ as p,ct as o,cr as l,cs as d,cR as u,cS as y,bV as g,cT as f,cU as m,cV as x,cW as T,cX as H,cY as C,cZ as w,c_ as L,c$ as S,d0 as N,d1 as b,d2 as A,d3 as _,d4 as V,d5 as $,d6 as U,d7 as D,d8 as F,cA as E,cz as M,d9 as P,cD as k,da as v,db as O,dc as R,dd as j,de as B,df as I,dg as K,dh as W,di as q,cB as Q,cC as z,dj as X,dk as Y,dl as Z,dm as G,dn as J}from"./index-Dao0ei72.js";class tt{constructor(){e(this,"header",0),e(this,"transportCodes",[0,0]),e(this,"pathLen",0),e(this,"path",new Uint8Array(0)),e(this,"payload",new Uint8Array(0)),e(this,"decrypted",{}),e(this,"_rssi",0),e(this,"_snr",0)}static fromBytes(t){const e=new tt;try{return e.readFrom(t),{success:!0,packet:e}}catch(a){return{success:!1,error:a instanceof Error?a.message:String(a)}}}static fromHex(t){try{const e=a(t);return tt.fromBytes(e)}catch(e){return{success:!1,error:e instanceof Error?e.message:String(e)}}}get routeType(){return this.header&s}get routeTypeName(){return r[this.routeType]??`UNKNOWN(${this.routeType})`}get payloadType(){return this.header>>n&h}get payloadTypeName(){return i[this.payloadType]??`UNKNOWN(${this.payloadType})`}get payloadVersion(){return this.header>>c&p}hasTransportCodes(){return o(this.routeType)}isFlood(){return l(this.routeType)}isDirect(){return d(this.routeType)}get pathBytes(){return Array.from(this.path)}get pathString(){return u(this.path)}get pathHexArray(){return Array.from(this.path).map(t=>y(t,!0))}get payloadLen(){return this.payload.length}get payloadHex(){return g(this.payload,!0)}getPayloadAppData(){const t=N+b+A;return this.payload.length>=t?this.payload.slice(t):new Uint8Array(0)}get rssi(){return this._rssi}set rssi(t){this._rssi=t}get snr(){return this._snr}set snr(t){this._snr=t}readFrom(t){let e=0;const a=t.length;f(e,1,a,"Missing header byte"),this.header=t[e++];const s=this.payloadVersion;if(s>m)throw new Error(`Unsupported packet version: ${s}`);if(this.hasTransportCodes()?(f(e,4,a,"Missing transport codes"),this.transportCodes=[x(t,e),x(t,e+2)],e+=4):this.transportCodes=[0,0],f(e,1,a,"Missing path_len"),this.pathLen=t[e++],this.pathLen>T)throw new Error(`path_len too large: ${this.pathLen} > ${T}`);return f(e,this.pathLen,a,"Truncated path"),this.path=t.slice(e,e+this.pathLen),e+=this.pathLen,this.payload=t.slice(e),H(this.payload.length),!0}writeTo(){let t=1;this.hasTransportCodes()&&(t+=4),t+=1,t+=this.path.length,t+=this.payload.length;const e=new Uint8Array(t);let a=0;return e[a++]=this.header,this.hasTransportCodes()&&(C(this.transportCodes[0],e,a),C(this.transportCodes[1],e,a+2),a+=4),e[a++]=this.path.length,e.set(this.path,a),a+=this.path.length,e.set(this.payload,a),e}toHex(){return g(this.writeTo(),!0)}async calculateHash(){return w(this.payloadType,this.pathLen,this.payload)}async calculateHashString(t){return L(this.payloadType,this.pathLen,this.payload,t)}async calculateCRC(){return S(this.payloadType,this.pathLen,this.payload)}getRawLength(){let t=2+this.pathLen+this.payload.length;return this.hasTransportCodes()&&(t+=4),t}getSummary(){return{header:y(this.header,!0),routeType:this.routeTypeName,payloadType:this.payloadTypeName,version:this.payloadVersion,pathLen:this.pathLen,pathStr:this.pathString,transportCodes:this.hasTransportCodes()?[this.transportCodes[0].toString(16).toUpperCase().padStart(4,"0"),this.transportCodes[1].toString(16).toUpperCase().padStart(4,"0")]:null,payloadLen:this.payload.length,payloadHex:this.payloadHex,rawLength:this.getRawLength()}}toString(){const t=[`[${this.routeTypeName}/${this.payloadTypeName} v${this.payloadVersion}]`,`path=${this.pathString||"(empty)"}`,`payload=${this.payload.length}B`];return this.hasTransportCodes()&&t.push(`transport=[${this.transportCodes[0]},${this.transportCodes[1]}]`),t.join(" ")}}function et(t){const e=N+b+A+1;if(t.length<e)return null;let a=0;const s=g(t.slice(a,a+N));a+=N;const r=j(t,a);a+=b;const n=g(t.slice(a,a+A));a+=A;const h=t[a++],i=B(h);let c="unknown";switch(h&J){case G:c="chat";break;case Z:c="repeater";break;case Y:c="room_server";break;case X:c="sensor"}const p={type:"advert",publicKey:s,timestamp:r,signature:n,flags:h,flagsDescription:i,nodeType:c,rawAppData:g(t.slice(N+b+A))};if(h&I&&a+8<=t.length){const e=t.slice(a,a+8),s=new ArrayBuffer(8);new Uint8Array(s).set(e);const r=new DataView(s),n=r.getInt32(0,!0),h=r.getInt32(4,!0);p.latitude=n/1e6,p.longitude=h/1e6,a+=8}if(h&K&&(a+=2),h&W&&(a+=2),h&q&&a<t.length){let e=a;for(;e<t.length&&0!==t[e];)e++;e>a&&(p.name=(new TextDecoder).decode(t.slice(a,e)))}return p}function at(t,e){const a=function(t){if(t.length<9)return{type:"trace",traceTag:"00000000",traceTagValue:0,authCode:0,flags:0,pathHashes:[],pathString:"",snrValues:[],isComplete:!1,path:[],targetHash:""};const e=j(t,0),a=e.toString(16).toUpperCase().padStart(8,"0"),s=j(t,4),r=t[8],n=t.slice(9),h=Array.from(n).map(t=>y(t,!0)),i=h.join("->");return{type:"trace",traceTag:a,traceTagValue:e,authCode:s,flags:r,pathHashes:h,pathString:i,snrValues:[],isComplete:!1,path:h,targetHash:h.length>0?h[0]:""}}(t);if(!a)return null;const s=[],r=e instanceof Uint8Array?Array.from(e):e;for(let h=0;h<r.length;h++){let t=r[h];t>127&&(t-=256),s.push(t/4)}const n=s.length>=a.pathHashes.length;return{...a,snrValues:s,isComplete:n}}function st(t,e=0){const a=e>=1?2:1,s=2*a+2;if(t.length<s)return null;const r=g(t.slice(0,a),!0),n=g(t.slice(a,2*a),!0),h=2*a,i=g(t.slice(h,h+2)),c=t.slice(h+2);let p="",o=!0;try{const t=new TextDecoder("utf-8",{fatal:!0}).decode(c);/^[\x20-\x7E\u00A0-\uFFFF\n\r\t]*$/.test(t)&&(p=t,o=!1)}catch{}return o&&(p=g(c)),{type:"txt_msg",destHash:r,srcHash:n,cipherMac:i,timestamp:0,text:p,ciphertextHex:o?g(c):void 0,encrypted:o}}async function rt(t,e=0){const a=e>=1?4:2,s=1+a+1;if(t.length<s)return null;const r=t[0],n=y(r,!0),h=t.slice(1,1+a),i=t.slice(1+a),c={type:"grp_txt",channelHash:n,text:g(i),decrypted:!1,ciphertextHex:g(i),macHex:g(h)};try{const t=await Q(r,h,i);if(t&&t.plaintext.length>=5){c.channelName=t.channelName;const e=t.plaintext,a=j(e,0),s=e[4],r=new TextDecoder("utf-8",{fatal:!1}).decode(e.slice(5)).replace(/\uFFFD/g,"").replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F-\x9F]/g,"").replace(/\x00+$/,"").trim();c.decrypted=!0,c.isPublicHashChannel=!0,c.timestamp=a,c.flags=s,t.macCorrupted&&(c.macCorrupted=!0);const n=r.indexOf(": ");n>0?(c.senderName=r.slice(0,n),c.text=r.slice(n+2)):c.text=r}else{const t=await z(r);c.isPublicHashChannel=t.length>0}}catch{}return c}async function nt(t){if(t.length<4)return null;const e=t[0],a=y(e,!0),s=t.slice(1,3),r=t.slice(3),n={type:"grp_data",channelHash:a,dataHex:g(r),dataLength:r.length,decrypted:!1,macHex:g(s)};try{const t=await Q(e,s,r);t&&(n.channelName=t.channelName,n.decrypted=!0,n.decryptedHex=g(t.plaintext))}catch{}return n}function ht(t,e,a){return{type:"generic",payloadType:e,payloadTypeName:a,rawHex:g(t),length:t.length}}function it(t){const{payload:e,payloadType:a,payloadTypeName:s}=t;switch(a){case R:return et(e)??ht(e,a,s);case O:return function(t){if(t.length<4)return null;const e=j(t,0);return{type:"ack",crc:e.toString(16).toUpperCase().padStart(8,"0"),crcValue:e}}(e)??ht(e,a,s);case v:return function(t){if(0===t.length)return{type:"path",pathLength:0,path:[],pathString:""};const e=t[0];if(t.length<1+e+1){const a=Math.min(e,t.length-1),s=Array.from(t.slice(1,1+a)).map(t=>y(t,!0));return{type:"path",pathLength:e,path:s,pathString:s.join("->")}}const a=Array.from(t.slice(1,1+e)).map(t=>y(t,!0)),s=a.join("->"),r=t[1+e],n=i[r]??`UNKNOWN(${r})`;let h;return t.length>1+e+1&&(h=g(t.slice(1+e+1))),{type:"path",pathLength:e,path:a,pathString:s,extraType:r,extraTypeName:n,extraData:h}}(e)??ht(e,a,s);case k:return at(e,t.path)??ht(e,a,s);case P:return st(e,t.payloadVersion)??ht(e,a,s);case M:return function(t,e=0){const a=e>=1?4:2,s=1+a+1;if(t.length<s)return null;const r=t[0],n=y(r,!0),h=t.slice(1,1+a),i=t.slice(1+a);return{type:"grp_txt",channelHash:n,text:g(i),decrypted:!1,ciphertextHex:g(i),macHex:g(h)}}(e,t.payloadVersion)??ht(e,a,s);case E:return function(t){if(t.length<4)return null;const e=t[0],a=y(e,!0),s=t.slice(1,3),r=t.slice(3);return{type:"grp_data",channelHash:a,dataHex:g(r),dataLength:r.length,decrypted:!1,macHex:g(s)}}(e)??ht(e,a,s);case F:return function(t){return t.length<4?null:{type:"multipart",messageId:g(t.slice(0,2)),partNumber:t[2],totalParts:t[3],partData:g(t.slice(4))}}(e)??ht(e,a,s);case D:return function(t){if(t.length<1)return null;const e=t[0],a=e>>4&15,s=15&e,r={8:"DISCOVER_REQ",9:"DISCOVER_RESP"}[a]??`0x${a.toString(16)}`;return{type:"control",controlType:e,subtype:a,subtypeFlags:s,subtypeName:r,dataHex:g(t.slice(1)),dataLength:t.length-1,isInternal:a>=8}}(e)??ht(e,a,s);case U:return function(t){if(t.length<4)return null;const e=y(t[0],!0),a=y(t[1],!0),s=g(t.slice(2,4)),r=t.slice(4);return{type:"req",destHash:e,srcHash:a,cipherMac:s,ciphertextHex:g(r),ciphertextLength:r.length}}(e)??ht(e,a,s);case $:return function(t){if(t.length<4)return null;const e=y(t[0],!0),a=y(t[1],!0),s=g(t.slice(2,4)),r=t.slice(4);return{type:"response",destHash:e,srcHash:a,cipherMac:s,ciphertextHex:g(r),ciphertextLength:r.length}}(e)??ht(e,a,s);case V:return function(t){if(t.length<35)return null;const e=y(t[0],!0),a=g(t.slice(1,33)),s=g(t.slice(33,35)),r=t.slice(35);return{type:"anon_req",destHash:e,senderPublicKey:a,cipherMac:s,ciphertextHex:g(r),ciphertextLength:r.length}}(e)??ht(e,a,s);default:return ht(e,a,s)}}export{tt as P,rt as a,nt as b,it as c,st as d,at as e,et as f};
