!function(){"use strict";let e=null,t=null,s=!0,a=!1,r=24;const n=new Map;let o=0,c=null,l=null;async function i(e){const s={};t&&(s.Authorization=`Bearer ${t}`);const a=new AbortController,r=setTimeout(()=>a.abort(),15e3);try{return await fetch(e,{headers:s,signal:a.signal})}finally{clearTimeout(r)}}async function p(){if(e&&!a)try{const t=`${e.apiBaseUrl}/api/stats`,s=await i(t);if(!s.ok)throw new Error(`API error: ${s.status}`);const a=await s.json();self.postMessage({type:"stats",data:a,timestamp:Date.now()})}catch(t){self.postMessage({type:"error",source:"stats",error:t instanceof Error?t.message:"Unknown error"})}}async function f(){if(e&&s&&!a)try{const t=`${e.apiBaseUrl}/api/recent_packets?limit=100`,s=await i(t);if(!s.ok)throw new Error(`API error: ${s.status}`);const a=await s.json(),r=a.data??a.packets??[],c=[];for(const e of r){const t=e.packet_hash;if(t&&!n.has(t)){n.set(t,e),c.push(e);const s=e.timestamp??0;s>o&&(o=s)}}n.size>75e3&&function(){const e=Array.from(n.values()).sort((e,t)=>(e.timestamp??0)-(t.timestamp??0)),t=e.length-75e3;for(let s=0;s<t;s++){const t=e[s];t.packet_hash&&n.delete(t.packet_hash)}}(),c.length>0&&self.postMessage({type:"packets",newPackets:c,totalCount:n.size,newestTimestamp:o})}catch(t){self.postMessage({type:"error",source:"packets",error:t instanceof Error?t.message:"Unknown error"})}}function u(){c&&(clearInterval(c),c=null),l&&(clearInterval(l),l=null)}self.onmessage=i=>{const k=i.data;switch(k.type){case"init":e=k.config,t=k.config.authToken??null,e&&(u(),c=setInterval(p,e.statsIntervalMs),l=setInterval(f,e.packetsIntervalMs),p(),f()),self.postMessage({type:"ready"});break;case"setAuth":t=k.token;break;case"setLiveMode":s=k.enabled;break;case"setTimeWindow":r=k.hours;break;case"forceRefresh":p(),f();break;case"clearCache":n.clear(),o=0,self.postMessage({type:"packetsReset",packets:[],newestTimestamp:0});break;case"pause":a=!0;break;case"resume":a=!1;break;case"stop":u()}}}();
