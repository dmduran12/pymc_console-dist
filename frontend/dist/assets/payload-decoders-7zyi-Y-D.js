var Y=Object.defineProperty;var M=(t,e,s)=>e in t?Y(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s;var T=(t,e,s)=>M(t,typeof e!="symbol"?e+"":e,s);import{bv as F,ex as I,ey as b,ez as U,eA as B,bt as w,eB as G,eC as $,eb as v,e9 as K,ea as z,eD as k,eE as g,dr as a,eF as R,eG as Q,eH as O,eI as D,eJ as j,eK as N,eL as W,eM as Z,eN as X,eO as y,eP as P,eQ as m,eR as q,eS as J,eT as ee,eU as te,eV as se,eW as ne,ej as re,ei as ae,eX as ce,em as ie,eY as he,eZ as oe,e_ as ue,e$ as le,f0 as A,f1 as _,f2 as pe,f3 as ge,f4 as fe,f5 as Te,f6 as _e,ek as V,el as de,f7 as Ee,f8 as Ae,f9 as Se,fa as ye,fb as me}from"./index-BwGHI0A_.js";class L{constructor(){T(this,"header",0);T(this,"transportCodes",[0,0]);T(this,"pathLen",0);T(this,"path",new Uint8Array(0));T(this,"payload",new Uint8Array(0));T(this,"decrypted",{});T(this,"_rssi",0);T(this,"_snr",0)}static fromBytes(e){const s=new L;try{return s.readFrom(e),{success:!0,packet:s}}catch(n){return{success:!1,error:n instanceof Error?n.message:String(n)}}}static fromHex(e){try{const s=F(e);return L.fromBytes(s)}catch(s){return{success:!1,error:s instanceof Error?s.message:String(s)}}}get routeType(){return this.header&I}get routeTypeName(){return b[this.routeType]??`UNKNOWN(${this.routeType})`}get payloadType(){return this.header>>U&B}get payloadTypeName(){return w[this.payloadType]??`UNKNOWN(${this.payloadType})`}get payloadVersion(){return this.header>>G&$}hasTransportCodes(){return v(this.routeType)}isFlood(){return K(this.routeType)}isDirect(){return z(this.routeType)}get pathBytes(){return Array.from(this.path)}get pathString(){return k(this.path)}get pathHexArray(){return Array.from(this.path).map(e=>g(e,!0))}get payloadLen(){return this.payload.length}get payloadHex(){return a(this.payload,!0)}getPayloadAppData(){const e=y+P+m;return this.payload.length>=e?this.payload.slice(e):new Uint8Array(0)}get rssi(){return this._rssi}set rssi(e){this._rssi=e}get snr(){return this._snr}set snr(e){this._snr=e}readFrom(e){let s=0;const n=e.length;R(s,1,n,"Missing header byte"),this.header=e[s++];const r=this.payloadVersion;if(r>Q)throw new Error(`Unsupported packet version: ${r}`);if(this.hasTransportCodes()?(R(s,4,n,"Missing transport codes"),this.transportCodes=[O(e,s),O(e,s+2)],s+=4):this.transportCodes=[0,0],R(s,1,n,"Missing path_len"),this.pathLen=e[s++],this.pathLen>D)throw new Error(`path_len too large: ${this.pathLen} > ${D}`);return R(s,this.pathLen,n,"Truncated path"),this.path=e.slice(s,s+this.pathLen),s+=this.pathLen,this.payload=e.slice(s),j(this.payload.length),!0}writeTo(){let e=1;this.hasTransportCodes()&&(e+=4),e+=1,e+=this.path.length,e+=this.payload.length;const s=new Uint8Array(e);let n=0;return s[n++]=this.header,this.hasTransportCodes()&&(N(this.transportCodes[0],s,n),N(this.transportCodes[1],s,n+2),n+=4),s[n++]=this.path.length,s.set(this.path,n),n+=this.path.length,s.set(this.payload,n),s}toHex(){return a(this.writeTo(),!0)}async calculateHash(){return W(this.payloadType,this.pathLen,this.payload)}async calculateHashString(e){return Z(this.payloadType,this.pathLen,this.payload,e)}async calculateCRC(){return X(this.payloadType,this.pathLen,this.payload)}getRawLength(){let e=2+this.pathLen+this.payload.length;return this.hasTransportCodes()&&(e+=4),e}getSummary(){return{header:g(this.header,!0),routeType:this.routeTypeName,payloadType:this.payloadTypeName,version:this.payloadVersion,pathLen:this.pathLen,pathStr:this.pathString,transportCodes:this.hasTransportCodes()?[this.transportCodes[0].toString(16).toUpperCase().padStart(4,"0"),this.transportCodes[1].toString(16).toUpperCase().padStart(4,"0")]:null,payloadLen:this.payload.length,payloadHex:this.payloadHex,rawLength:this.getRawLength()}}toString(){const e=[`[${this.routeTypeName}/${this.payloadTypeName} v${this.payloadVersion}]`,`path=${this.pathString||"(empty)"}`,`payload=${this.payload.length}B`];return this.hasTransportCodes()&&e.push(`transport=[${this.transportCodes[0]},${this.transportCodes[1]}]`),e.join(" ")}}const H={DISCOVER_REQ:8,DISCOVER_RESP:9},Re={[H.DISCOVER_REQ]:"DISCOVER_REQ",[H.DISCOVER_RESP]:"DISCOVER_RESP"},x={CHAT_NODE:1,REPEATER:2,ROOM_SERVER:4,SENSOR:8},xe={1:"companion",2:"repeater",3:"room_server",4:"sensor"};function Pe(t){const e=y+P+m+1;if(t.length<e)return null;let s=0;const n=a(t.slice(s,s+y));s+=y;const r=A(t,s);s+=P;const i=a(t.slice(s,s+m));s+=m;const c=t[s++],o=pe(c),h=c&me;let u="unknown";switch(h){case ye:u="chat";break;case Se:u="repeater";break;case Ae:u="room_server";break;case Ee:u="sensor";break}const l={type:"advert",publicKey:n,timestamp:r,signature:i,flags:c,flagsDescription:o,nodeType:u,rawAppData:a(t.slice(y+P+m))};if(c&ge&&s+8<=t.length){const p=t.slice(s,s+8),d=new ArrayBuffer(8);new Uint8Array(d).set(p);const C=new DataView(d),E=C.getInt32(0,!0),S=C.getInt32(4,!0);l.latitude=E/1e6,l.longitude=S/1e6,s+=8}if(c&fe&&(s+=2),c&Te&&(s+=2),c&_e&&s<t.length){let p=s;for(;p<t.length&&t[p]!==0;)p++;p>s&&(l.name=new TextDecoder().decode(t.slice(s,p)))}return l}function He(t){if(t.length<4)return null;const e=A(t,0);return{type:"ack",crc:e.toString(16).toUpperCase().padStart(8,"0"),crcValue:e}}function Ce(t){if(t.length===0)return{type:"path",pathLength:0,path:[],pathString:""};const e=t[0];if(t.length<1+e+1){const o=Math.min(e,t.length-1),h=Array.from(t.slice(1,1+o)).map(u=>g(u,!0));return{type:"path",pathLength:e,path:h,pathString:h.join("->")}}const s=Array.from(t.slice(1,1+e)).map(o=>g(o,!0)),n=s.join("->"),r=t[1+e],i=w[r]??`UNKNOWN(${r})`;let c;return t.length>1+e+1&&(c=a(t.slice(1+e+1))),{type:"path",pathLength:e,path:s,pathString:n,extraType:r,extraTypeName:i,extraData:c}}function Le(t){if(t.length<9)return{type:"trace",traceTag:"00000000",traceTagValue:0,authCode:0,flags:0,pathHashes:[],pathString:"",snrValues:[],isComplete:!1,path:[],targetHash:""};const e=A(t,0),s=e.toString(16).toUpperCase().padStart(8,"0"),n=A(t,4),r=t[8],i=t.slice(9),c=Array.from(i).map(h=>g(h,!0)),o=c.join("->");return{type:"trace",traceTag:s,traceTagValue:e,authCode:n,flags:r,pathHashes:c,pathString:o,snrValues:[],isComplete:!1,path:c,targetHash:c.length>0?c[0]:""}}function Oe(t,e){const s=Le(t);if(!s)return null;const n=[],r=e instanceof Uint8Array?Array.from(e):e;for(let c=0;c<r.length;c++){let o=r[c];o>127&&(o-=256);const h=o/4;n.push(Math.max(-20,Math.min(15,h)))}const i=n.length>=s.pathHashes.length;return{...s,snrValues:n,isComplete:i}}function De(t,e=0){const s=e>=1?2:1,n=_,r=s*2+n;if(t.length<r)return null;const i=a(t.slice(0,s),!0),c=a(t.slice(s,s*2),!0),o=s*2,h=a(t.slice(o,o+n)),u=t.slice(o+n);let l="",p=!0;try{const d=new TextDecoder("utf-8",{fatal:!0}).decode(u);/^[\x20-\x7E\u00A0-\uFFFF\n\r\t]*$/.test(d)&&(l=d,p=!1)}catch{}return p&&(l=a(u)),{type:"txt_msg",destHash:i,srcHash:c,cipherMac:h,timestamp:0,text:l,ciphertextHex:p?a(u):void 0,encrypted:p}}function Ne(t,e=0){const s=e>=1?4:_,n=1+s+1;if(t.length<n)return null;const r=t[0],i=g(r,!0),c=t.slice(1,1+s),o=t.slice(1+s);return{type:"grp_txt",channelHash:i,text:a(o),decrypted:!1,ciphertextHex:a(o),macHex:a(c)}}async function Ge(t,e=0){const s=e>=1?4:_,n=1+s+1;if(t.length<n)return null;const r=t[0],i=g(r,!0),c=t.slice(1,1+s),o=t.slice(1+s),h={type:"grp_txt",channelHash:i,text:a(o),decrypted:!1,ciphertextHex:a(o),macHex:a(c)};try{const u=await V(r,c,o);if(u&&u.plaintext.length>=5){h.channelName=u.channelName;const l=u.plaintext,p=A(l,0),d=l[4],E=new TextDecoder("utf-8",{fatal:!1}).decode(l.slice(5)).replace(/\uFFFD/g,"").replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F-\x9F]/g,"").replace(/\x00+$/,"").trim();h.decrypted=!0,h.isPublicHashChannel=!0,h.timestamp=p,h.flags=d,u.macCorrupted&&(h.macCorrupted=!0);const S=E.indexOf(": ");S>0?(h.senderName=E.slice(0,S),h.text=E.slice(S+2)):h.text=E}else{const l=await de(r);h.isPublicHashChannel=l.length>0}}catch{}return h}function we(t){if(t.length<1+_+1)return null;const e=t[0],s=g(e,!0),n=t.slice(1,1+_),r=t.slice(1+_);return{type:"grp_data",channelHash:s,dataHex:a(r),dataLength:r.length,decrypted:!1,macHex:a(n)}}async function $e(t){if(t.length<1+_+1)return null;const e=t[0],s=g(e,!0),n=t.slice(1,1+_),r=t.slice(1+_),i={type:"grp_data",channelHash:s,dataHex:a(r),dataLength:r.length,decrypted:!1,macHex:a(n)};try{const c=await V(e,n,r);c&&(i.channelName=c.channelName,i.decrypted=!0,i.decryptedHex=a(c.plaintext))}catch{}return i}function Ve(t){if(t.length<4)return null;const e=a(t.slice(0,2)),s=t[2],n=t[3],r=a(t.slice(4));return{type:"multipart",messageId:e,partNumber:s,totalParts:n,partData:r}}function Ye(t){const e=[];return t&x.CHAT_NODE&&e.push("companion"),t&x.REPEATER&&e.push("repeater"),t&x.ROOM_SERVER&&e.push("room_server"),t&x.SENSOR&&e.push("sensor"),e.length>0?e.join("+"):"none"}function Me(t){if(t.length<1)return null;const e=t[0],s=e>>4&15,n=e&15,r=Re[s]??`0x${s.toString(16)}`,i={type:"control",controlType:e,subtype:s,subtypeFlags:n,subtypeName:r,dataHex:a(t.slice(1)),dataLength:t.length-1,isInternal:s>=8};if(s===H.DISCOVER_RESP&&t.length>=6){i.nodeType=n,i.nodeTypeName=xe[n]??"unknown";const o=le(t,1)/4;if(i.snrDb=Math.max(-20,Math.min(15,o)),i.tag=a(t.slice(2,6)),t.length>6){const h=t.slice(6);i.publicKey=a(h).toLowerCase(),i.publicKeyFull=h.length>=32}}return s===H.DISCOVER_REQ&&t.length>=6&&(i.prefixOnly=!!(n&1),i.typeFilter=t[1],i.typeFilterDescription=Ye(t[1]),i.tag=a(t.slice(2,6)),t.length>=10&&(i.since=A(t,6))),i}function Fe(t){if(t.length<4)return null;const e=g(t[0],!0),s=g(t[1],!0),n=a(t.slice(2,4)),r=t.slice(4);return{type:"req",destHash:e,srcHash:s,cipherMac:n,ciphertextHex:a(r),ciphertextLength:r.length}}function Ie(t){if(t.length<4)return null;const e=g(t[0],!0),s=g(t[1],!0),n=a(t.slice(2,4)),r=t.slice(4);return{type:"response",destHash:e,srcHash:s,cipherMac:n,ciphertextHex:a(r),ciphertextLength:r.length}}function be(t){if(t.length<35)return null;const e=g(t[0],!0),s=a(t.slice(1,33)),n=a(t.slice(33,35)),r=t.slice(35);return{type:"anon_req",destHash:e,senderPublicKey:s,cipherMac:n,ciphertextHex:a(r),ciphertextLength:r.length}}function f(t,e,s){return{type:"generic",payloadType:e,payloadTypeName:s,rawHex:a(t),length:t.length}}function ve(t){const{payload:e,payloadType:s,payloadTypeName:n}=t;switch(s){case ue:return Pe(e)??f(e,s,n);case oe:return He(e)??f(e,s,n);case he:return Ce(e)??f(e,s,n);case ie:return Oe(e,t.path)??f(e,s,n);case ce:return De(e,t.payloadVersion)??f(e,s,n);case ae:return Ne(e,t.payloadVersion)??f(e,s,n);case re:return we(e)??f(e,s,n);case ne:return Ve(e)??f(e,s,n);case se:return Me(e)??f(e,s,n);case te:return Fe(e)??f(e,s,n);case ee:return Ie(e)??f(e,s,n);case J:return be(e)??f(e,s,n);case q:default:return f(e,s,n)}}export{L as P,Ge as a,$e as b,ve as c,De as d,Oe as e,Pe as f,Me as g,be as h};
