var e=Object.defineProperty,t=(t,s,n)=>((t,s,n)=>s in t?e(t,s,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[s]=n)(t,"symbol"!=typeof s?s+"":s,n);import{r as s,j as n,m as a,i,W as l,Z as o}from"./vendor-react-j_fHog8x.js";import{c as r,ba as c,bb as d,bc as u,A as m,m as h,M as x,a4 as p,aL as g,bd as f,be as v,b1 as b,bf as y,bg as j,aA as N,q as w,aY as C,bh as k,Z as S,x as L,b2 as D,j as F,E as R,bi as M,bj as H,R as B,bk as P,W as E,X as z,bl as A,bm as T,B as $,bn as I,aF as G}from"./index-xL2kp1Fg.js";import{u as O,G as Z,M as W,c as V,E as K,a as _,D as q,s as U}from"./DeepAnalysisModal-_2FYC_OB.js";import{D as X}from"./DataBox-BdDC7Mkm.js";import{h as Y,c as J,D as Q}from"./geo-utils-BjWMEe7m.js";import{E as ee,S as te,T as se}from"./target-Cb3VAWON.js";import{L as ne}from"./layers-DGcyShcJ.js";import{S as ae}from"./search-CTDdAodr.js";import{S as ie}from"./settings-2-HcZotqQV.js";import{C as le}from"./chevron-right-FwTl6sKg.js";import{N as oe}from"./network-DHZLewnA.js";import"./maplibre-gl-b91ci4Kr.js";import"./vendor-core-CmkNwW1A.js";import"./git-branch-DV5TchGC.js";import"./database-BTXMo_EQ.js";import"./copy-CsTCkow_.js";const re=r("arrow-right-left",[["path",{d:"m16 3 4 4-4 4",key:"1x1c3m"}],["path",{d:"M20 7H4",key:"zbl0bi"}],["path",{d:"m8 21-4-4 4-4",key:"h9nckh"}],["path",{d:"M4 17h16",key:"g4d7ey"}]]),ce=r("focus",[["circle",{cx:"12",cy:"12",r:"3",key:"1v7zrd"}],["path",{d:"M3 7V5a2 2 0 0 1 2-2h2",key:"aa7l1z"}],["path",{d:"M17 3h2a2 2 0 0 1 2 2v2",key:"4qcy5o"}],["path",{d:"M21 17v2a2 2 0 0 1-2 2h-2",key:"6vwrx8"}],["path",{d:"M7 21H5a2 2 0 0 1-2-2v-2",key:"ioqczr"}]]),de=r("group",[["path",{d:"M3 7V5c0-1.1.9-2 2-2h2",key:"adw53z"}],["path",{d:"M17 3h2c1.1 0 2 .9 2 2v2",key:"an4l38"}],["path",{d:"M21 17v2c0 1.1-.9 2-2 2h-2",key:"144t0e"}],["path",{d:"M7 21H5c-1.1 0-2-.9-2-2v-2",key:"rtnfgi"}],["rect",{width:"7",height:"5",x:"7",y:"7",rx:"1",key:"1eyiv7"}],["rect",{width:"7",height:"5",x:"10",y:"12",rx:"1",key:"1qlmkx"}]]),ue=r("lasso",[["path",{d:"M3.704 14.467A10 8 0 0 1 2 10a10 8 0 0 1 20 0 10 8 0 0 1-10 8 10 8 0 0 1-5.181-1.158",key:"1yant3"}],["path",{d:"M7 22a5 5 0 0 1-2-3.994",key:"1xp6a4"}],["circle",{cx:"5",cy:"16",r:"2",key:"18csp3"}]]),me=r("rotate-ccw",[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}]]);function he(e){if(null==e)return"";const t=String(e);return t.includes(",")||t.includes('"')||t.includes("\n")?`"${t.replace(/"/g,'""')}"`:t}function xe(e,t){const s=[e.join(",")];for(const n of t)s.push(n.map(he).join(","));return s.join("\n")}function pe(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;")}function ge(e){return!e||e<=0?"":new Date(1e3*e).toISOString()}function fe(e,t){return`${e}-${(new Date).toISOString().replace(/[:.]/g,"-").slice(0,19)}.${t}`}const ve=["hash","prefix","name","nodeClass","communityId","degree","inDegree","outDegree","betweenness","pathDiversity","packetCount","lastSeen","activityLevel","recencyScore","avgRssi","avgSnr","isZeroHop","prefixConfidence","hasCollision","collisionCandidates","isLocal","isHub","isGateway","isBackbone","isMobile","isGhost","isInLoop","latitude","longitude","contactType"];function be(e){var t,s;return[e.hash,e.prefix,e.name??"",e.nodeClass,e.communityId,e.degree,e.inDegree,e.outDegree,e.betweenness.toFixed(6),e.pathDiversity,e.packetCount,ge(e.lastSeen),e.activityLevel,e.recencyScore.toFixed(4),(null==(t=e.avgRssi)?void 0:t.toFixed(1))??"",(null==(s=e.avgSnr)?void 0:s.toFixed(1))??"",e.isZeroHop,e.prefixConfidence.toFixed(4),e.hasCollision,e.collisionCandidates,e.isLocal,e.isHub,e.isGateway,e.isBackbone,e.isMobile,e.isGhost,e.isInLoop,e.latitude??"",e.longitude??"",e.contactType??""]}function ye(e,t){const s=[];for(const n of e.nodeMetrics.values())!t&&n.isGhost||s.push({hash:n.hash,prefix:n.prefix,name:n.name,nodeClass:n.nodeClass,communityId:n.communityId,degree:n.degree,inDegree:n.inDegree,outDegree:n.outDegree,betweenness:n.betweenness,pathDiversity:n.pathDiversity,packetCount:n.packetCount,lastSeen:n.lastSeen,activityLevel:n.activityLevel,recencyScore:n.recencyScore,avgRssi:n.avgRssi,avgSnr:n.avgSnr,isZeroHop:n.isZeroHop,prefixConfidence:n.prefixConfidence,hasCollision:n.hasCollision,isLocal:n.isLocal,isHub:n.isHub,isGateway:n.isGateway,isBackbone:n.isBackbone,isMobile:n.isMobile,isGhost:n.isGhost,isInLoop:n.isInLoop,latitude:n.latitude,longitude:n.longitude,contactType:n.contactType});return s}const je=["fromHash","toHash","key","packetCount","certainCount","avgConfidence","strength","forwardCount","reverseCount","symmetryRatio","dominantDirection","floodCount","directCount","isDirectPathEdge","isZeroHop","isLoopEdge","isCertain","avgRssi","avgSnr","avgRecency","hopDistanceFromLocal","edgeBetweenness","isBackbone"];function Ne(e,t){const s=t?e.edges:e.validatedEdges,n=new Set(e.backboneEdges);return s.map(t=>({fromHash:t.fromHash,toHash:t.toHash,key:t.key,packetCount:t.packetCount,certainCount:t.certainCount,avgConfidence:t.avgConfidence,strength:t.strength,forwardCount:t.forwardCount,reverseCount:t.reverseCount,symmetryRatio:t.symmetryRatio,dominantDirection:t.dominantDirection,floodCount:t.floodCount,directCount:t.directCount,isDirectPathEdge:t.isDirectPathEdge,isZeroHop:t.isZeroHop??!1,isLoopEdge:t.isLoopEdge??!1,isCertain:t.isCertain,avgRssi:t.avgRssi??null,avgSnr:t.avgSnr??null,avgRecency:t.avgRecency,hopDistanceFromLocal:t.hopDistanceFromLocal,edgeBetweenness:e.edgeBetweenness.get(t.key)??0,isBackbone:n.has(t.key)}))}const we=["pathKey","hops","hopCount","healthScore","weakestLinkKey","weakestLinkConfidence","avgEdgeCertainty","observationTrend","alternatePathsCount","estimatedLatencyMs","observationCount","routeType","lastSeen","involvesHub"];function Ce(e){return[e.pathKey,e.hops.join(">"),e.hops.length,e.healthScore.toFixed(4),e.weakestLinkKey??"",e.weakestLinkConfidence.toFixed(4),e.avgEdgeCertainty.toFixed(4),e.observationTrend.toFixed(4),e.alternatePathsCount,e.estimatedLatencyMs.toFixed(0),e.observationCount,e.routeType,ge(e.lastSeen),e.involvesHub]}const ke=["nodeHash","nodePrefix","nodeName","networkRole","floodFactor","directFactor","floodSlots","directSlots","trafficIntensity","directNeighborCount","collisionRisk","confidence","adjustment","dataConfidence","observationSymmetry","rationale"];function Se(e,t,s){const n=s.get(e);return[e,(null==n?void 0:n.prefix)??"",(null==n?void 0:n.name)??"",t.networkRole,t.floodFactor.toFixed(2),t.directFactor.toFixed(2),t.floodSlots,t.directSlots,t.trafficIntensity.toFixed(4),t.directNeighborCount,t.collisionRisk.toFixed(4),t.confidence.toFixed(4),t.adjustment,t.dataConfidence,t.observationSymmetry.toFixed(4),t.rationale]}function Le(e,t){var s,n;const a=new Set(e.backboneEdges),i=['<?xml version="1.0" encoding="UTF-8"?>','<gexf xmlns="http://gexf.net/1.3" version="1.3">',`  <meta lastmodifieddate="${(new Date).toISOString()}">`,`    <creator>pymc_console v${c}</creator>`,"    <description>MeshCore LoRa Mesh Network Topology</description>","  </meta>",'  <graph defaultedgetype="directed" mode="static">',"","    \x3c!-- Node Attributes --\x3e",'    <attributes class="node">','      <attribute id="n0" title="prefix" type="string"/>','      <attribute id="n1" title="name" type="string"/>','      <attribute id="n2" title="nodeClass" type="string"/>','      <attribute id="n3" title="communityId" type="integer"/>','      <attribute id="n4" title="degree" type="integer"/>','      <attribute id="n5" title="betweenness" type="float"/>','      <attribute id="n6" title="packetCount" type="integer"/>','      <attribute id="n7" title="activityLevel" type="string"/>','      <attribute id="n8" title="isHub" type="boolean"/>','      <attribute id="n9" title="isGateway" type="boolean"/>','      <attribute id="n10" title="isBackbone" type="boolean"/>','      <attribute id="n11" title="isMobile" type="boolean"/>','      <attribute id="n12" title="isGhost" type="boolean"/>','      <attribute id="n13" title="isZeroHop" type="boolean"/>','      <attribute id="n14" title="prefixConfidence" type="float"/>','      <attribute id="n15" title="avgRssi" type="float"/>','      <attribute id="n16" title="avgSnr" type="float"/>',"    </attributes>","","    \x3c!-- Edge Attributes --\x3e",'    <attributes class="edge">','      <attribute id="e0" title="packetCount" type="integer"/>','      <attribute id="e1" title="certainCount" type="integer"/>','      <attribute id="e2" title="confidence" type="float"/>','      <attribute id="e3" title="symmetryRatio" type="float"/>','      <attribute id="e4" title="dominantDirection" type="string"/>','      <attribute id="e5" title="isBackbone" type="boolean"/>','      <attribute id="e6" title="isLoopEdge" type="boolean"/>','      <attribute id="e7" title="isDirectPath" type="boolean"/>','      <attribute id="e8" title="isZeroHop" type="boolean"/>','      <attribute id="e9" title="edgeBetweenness" type="float"/>','      <attribute id="e10" title="floodCount" type="integer"/>','      <attribute id="e11" title="directCount" type="integer"/>',"    </attributes>","","    <nodes>"];for(const l of e.nodeMetrics.values()){if(!t&&l.isGhost)continue;const e=pe(l.name??l.prefix);i.push(`      <node id="${pe(l.hash)}" label="${e}">`),i.push("        <attvalues>"),i.push(`          <attvalue for="n0" value="${pe(l.prefix)}"/>`),i.push(`          <attvalue for="n1" value="${pe(l.name??"")}"/>`),i.push(`          <attvalue for="n2" value="${l.nodeClass}"/>`),i.push(`          <attvalue for="n3" value="${l.communityId}"/>`),i.push(`          <attvalue for="n4" value="${l.degree}"/>`),i.push(`          <attvalue for="n5" value="${l.betweenness}"/>`),i.push(`          <attvalue for="n6" value="${l.packetCount}"/>`),i.push(`          <attvalue for="n7" value="${l.activityLevel}"/>`),i.push(`          <attvalue for="n8" value="${l.isHub}"/>`),i.push(`          <attvalue for="n9" value="${l.isGateway}"/>`),i.push(`          <attvalue for="n10" value="${l.isBackbone}"/>`),i.push(`          <attvalue for="n11" value="${l.isMobile}"/>`),i.push(`          <attvalue for="n12" value="${l.isGhost}"/>`),i.push(`          <attvalue for="n13" value="${l.isZeroHop}"/>`),i.push(`          <attvalue for="n14" value="${l.prefixConfidence}"/>`),null!=l.avgRssi&&i.push(`          <attvalue for="n15" value="${l.avgRssi}"/>`),null!=l.avgSnr&&i.push(`          <attvalue for="n16" value="${l.avgSnr}"/>`),i.push("        </attvalues>"),null==l.latitude||null==l.longitude||0===l.latitude&&0===l.longitude||i.push(`        <viz:position x="${l.longitude}" y="${l.latitude}" z="0.0"/>`),i.push("      </node>")}i.push("    </nodes>"),i.push(""),i.push("    <edges>");for(const l of e.validatedEdges){const o=e.nodeMetrics;if(!t&&((null==(s=o.get(l.fromHash))?void 0:s.isGhost)||(null==(n=o.get(l.toHash))?void 0:n.isGhost)))continue;const r=e.edgeBetweenness.get(l.key)??0;i.push(`      <edge id="${pe(l.key)}" source="${pe(l.fromHash)}" target="${pe(l.toHash)}" weight="${l.strength}">`),i.push("        <attvalues>"),i.push(`          <attvalue for="e0" value="${l.packetCount}"/>`),i.push(`          <attvalue for="e1" value="${l.certainCount}"/>`),i.push(`          <attvalue for="e2" value="${l.avgConfidence}"/>`),i.push(`          <attvalue for="e3" value="${l.symmetryRatio}"/>`),i.push(`          <attvalue for="e4" value="${l.dominantDirection}"/>`),i.push(`          <attvalue for="e5" value="${a.has(l.key)}"/>`),i.push(`          <attvalue for="e6" value="${l.isLoopEdge??!1}"/>`),i.push(`          <attvalue for="e7" value="${l.isDirectPathEdge}"/>`),i.push(`          <attvalue for="e8" value="${l.isZeroHop??!1}"/>`),i.push(`          <attvalue for="e9" value="${r}"/>`),i.push(`          <attvalue for="e10" value="${l.floodCount}"/>`),i.push(`          <attvalue for="e11" value="${l.directCount}"/>`),i.push("        </attvalues>"),i.push("      </edge>")}return i.push("    </edges>"),i.push("  </graph>"),i.push("</gexf>"),i.join("\n")}function De(e,t,s){const n={meta:{exportedAt:(new Date).toISOString(),pymcConsoleVersion:c,nodeCount:e.nodeMetrics.size,edgeCount:e.validatedEdges.length,communityCount:e.communityCount,loopCount:e.loops.length,backboneEdgeCount:e.backboneEdges.length,hubNodes:e.hubNodes.length,gatewayNodes:e.gatewayNodes.length,mobileNodes:e.mobileNodes.length,ghostNodes:e.discoveredNodes.filter(e=>e.isLikelyReal).length},nodes:ye(e,t),edges:Ne(e,s),pathHealth:e.pathHealth.map(e=>({pathKey:e.pathKey,hops:e.hops,healthScore:e.healthScore,weakestLinkKey:e.weakestLinkKey,weakestLinkConfidence:e.weakestLinkConfidence,avgEdgeCertainty:e.avgEdgeCertainty,observationTrend:e.observationTrend,alternatePathsCount:e.alternatePathsCount,estimatedLatencyMs:e.estimatedLatencyMs,observationCount:e.observationCount,routeType:e.routeType,lastSeen:e.lastSeen,involvesHub:e.involvesHub})),txDelayRecommendations:Array.from(e.txDelayRecommendations.entries()).map(([t,s])=>{var n,a;return{nodeHash:t,nodePrefix:(null==(n=e.nodeMetrics.get(t))?void 0:n.prefix)??"",nodeName:(null==(a=e.nodeMetrics.get(t))?void 0:a.name)??null,networkRole:s.networkRole,floodFactor:s.floodFactor,directFactor:s.directFactor,floodSlots:s.floodSlots,directSlots:s.directSlots,trafficIntensity:s.trafficIntensity,collisionRisk:s.collisionRisk,confidence:s.confidence,adjustment:s.adjustment,dataConfidence:s.dataConfidence,rationale:s.rationale}}),loops:e.loops.map(e=>({id:e.id,nodes:e.nodes,edgeKeys:e.edgeKeys,size:e.size,avgCertainCount:e.avgCertainCount,minCertainCount:e.minCertainCount,includesLocal:e.includesLocal,strength:e.strength})),disambiguationStats:{totalPrefixes:e.disambiguationStats.totalPrefixes,unambiguousPrefixes:e.disambiguationStats.unambiguousPrefixes,collisionPrefixes:e.disambiguationStats.collisionPrefixes,collisionRate:e.disambiguationStats.collisionRate,avgConfidence:e.disambiguationStats.avgConfidence},viterbiStats:{totalPaths:e.viterbiStats.totalPaths,pathsWithGhosts:e.viterbiStats.pathsWithGhosts,avgPathConfidence:e.viterbiStats.avgPathConfidence,tracePacketsProcessed:e.viterbiStats.tracePacketsProcessed,pathPacketsProcessed:e.viterbiStats.pathPacketsProcessed,distantEdgesDiscovered:e.viterbiStats.distantEdgesDiscovered,duplicateGroupsFound:e.viterbiStats.duplicateGroupsFound,echolocationEdgesInferred:e.viterbiStats.echolocationEdgesInferred}};return JSON.stringify(n,null,2)}function Fe(e,t){const s=t.includeGhosts??!0,n=t.includeWeakEdges??!1;switch(t.format){case"csv":{let a,i;switch(t.dataset){case"nodes":case"full":default:a=function(e,t){const s=[];for(const n of e.nodeMetrics.values())!t&&n.isGhost||s.push(be(n));return xe(ve,s)}(e,s),i="mesh-nodes";break;case"edges":a=function(e,t){const s=t?e.edges:e.validatedEdges,n=new Set(e.backboneEdges),a=s.map(t=>function(e,t,s){var n,a;return[e.fromHash,e.toHash,e.key,e.packetCount,e.certainCount,e.avgConfidence.toFixed(4),e.strength.toFixed(4),e.forwardCount,e.reverseCount,e.symmetryRatio.toFixed(4),e.dominantDirection,e.floodCount,e.directCount,e.isDirectPathEdge,e.isZeroHop??!1,e.isLoopEdge??!1,e.isCertain,(null==(n=e.avgRssi)?void 0:n.toFixed(1))??"",(null==(a=e.avgSnr)?void 0:a.toFixed(1))??"",e.avgRecency.toFixed(4),e.hopDistanceFromLocal,(t.get(e.key)??0).toFixed(6),s.has(e.key)]}(t,e.edgeBetweenness,n));return xe(je,a)}(e,n),i="mesh-edges";break;case"pathHealth":a=function(e){const t=e.pathHealth.map(Ce);return xe(we,t)}(e),i="mesh-path-health";break;case"txDelay":a=function(e){const t=[];for(const[s,n]of e.txDelayRecommendations)t.push(Se(s,n,e.nodeMetrics));return xe(ke,t)}(e),i="mesh-tx-delay"}return{content:a,filename:fe(i,"csv"),mimeType:"text/csv"}}case"gexf":return{content:Le(e,s),filename:fe("mesh-topology","gexf"),mimeType:"application/xml"};default:return{content:De(e,s,n),filename:fe("mesh-topology","json"),mimeType:"application/json"}}}function Re(e,t,s=1){const{n:n,adjList:a,totalWeight:i,degree:l}=e;if(0===i)return!1;const o=2*i,r=new Float64Array(n);for(let u=0;u<n;u++)r[t[u]]+=l[u];let c=!1,d=!0;for(;d;){d=!1;for(let e=0;e<n;e++){const n=t[e],u=l[e];if(0===u)continue;const m=new Map;for(const{j:s,w:i}of a[e]){const e=t[s];m.set(e,(m.get(e)??0)+i)}const h=-(m.get(n)??0)/i+s*(u*(r[n]-u))/(o*i);let x=n,p=0;for(const[e,t]of m){if(e===n)continue;const a=h+(t/i-s*(u*r[e])/(o*i));a>p+1e-7&&(p=a,x=e)}x!==n&&(r[n]-=u,r[x]+=u,t[e]=x,d=!0,c=!0)}}return c}function Me(e,t){const{n:s,adjList:n}=e,a=new Set;for(let h=0;h<s;h++)a.add(t[h]);const i=Array.from(a).sort((e,t)=>e-t),l=new Map;for(let h=0;h<i.length;h++)l.set(i[h],h);const o=i.length,r=new Int32Array(s);for(let h=0;h<s;h++)r[h]=l.get(t[h]);const c=new Map,d=new Float64Array(o);let u=0;for(let h=0;h<s;h++){const e=r[h];for(const{j:t,w:s}of n[h]){const n=r[t];if(e===n)continue;const a=e<=n?`${e}-${n}`:`${n}-${e}`;c.set(a,(c.get(a)??0)+s)}}const m=Array.from({length:o},()=>[]);for(const[h,x]of c){const[e,t]=h.split("-").map(Number),s=x/2;m[e].push({j:t,w:s}),m[t].push({j:e,w:s}),d[e]+=s,d[t]+=s,u+=s}return{newGraph:{n:o,adjList:m,totalWeight:u,degree:Array.from(d)},mapping:r}}function He(e,t,s){const n=(null==s?void 0:s.resolution)??1,a=(null==s?void 0:s.kWeight)??1,i=t.length;if(0===i)return{communities:new Map,numCommunities:0,modularity:0,passes:0};if(1===i)return{communities:new Map([[t[0],0]]),numCommunities:1,modularity:0,passes:0};const{graph:l}=function(e,t,s=1){const n=t.length,a=new Map;for(let r=0;r<n;r++)a.set(t[r],r);const i=Array.from({length:n},()=>[]),l=new Array(n).fill(0);let o=0;for(const r of e){const e=a.get(r.fromHash),t=a.get(r.toHash);if(void 0===e||void 0===t)continue;if(e===t)continue;const n=Math.max(.01,(r.certainCount+1)*r.avgConfidence*r.strength),c=1===s?n:Math.pow(n,s);i[e].push({j:t,w:c}),i[t].push({j:e,w:c}),l[e]+=c,l[t]+=c,o+=c}return{graph:{n:n,adjList:i,totalWeight:o,degree:l},hashToIdx:a}}(e,t,a);let o=l,r=new Int32Array(i);for(let v=0;v<i;v++)r[v]=v;const c=[];let d=0;for(;d<10&&Re(o,r,n);){d++;const{newGraph:e,mapping:t}=Me(o,r);if(c.push(t),e.n>=o.n)break;o=e,r=new Int32Array(e.n);for(let s=0;s<e.n;s++)r[s]=s}const u=new Int32Array(i);for(let v=0;v<i;v++)u[v]=v;for(const v of c)for(let e=0;e<i;e++)u[e]=v[u[e]];for(let v=0;v<i;v++)u[v]=r[u[v]];const m=new Set;for(let v=0;v<i;v++)m.add(u[v]);const h=Array.from(m).sort((e,t)=>e-t),x=new Map;for(let v=0;v<h.length;v++)x.set(h[v],v);const p=new Map;for(let v=0;v<i;v++)p.set(t[v],x.get(u[v]));const g=new Int32Array(i);for(let v=0;v<i;v++)g[v]=x.get(u[v]);const f=function(e,t,s=1){const{n:n,adjList:a,totalWeight:i,degree:l}=e;if(0===i)return 0;const o=2*i;let r=0;for(let c=0;c<n;c++)for(const{j:e,w:n}of a[c])t[c]===t[e]&&(r+=n-s*(l[c]*l[e])/o);return r/o}(l,g,n);return{communities:p,numCommunities:h.length,modularity:f,passes:d}}const Be={7:-124,8:-127,9:-130,10:-133,11:-135.5,12:-137},Pe={62.5:3,125:0,250:-3,500:-6},Ee={5:0,6:-.6,7:-1.1,8:-1.5};function ze(e,t){if(e<=0)return 0;const s=1e6*t;return 20*Math.log10(e)+20*Math.log10(s)+20*Math.log10(4*Math.PI/299792458)}function Ae(e,t,s=5){return(Be[e]??Be[12])+(Pe[t]??0)+(Ee[s]??0)}function Te(e,t=6){return 10*Math.log10(e)-174+t}function $e(e){return e>=20?"excellent":e>=10?"good":e>=3?"fair":e>=0?"marginal":"critical"}function Ie(e){return e>=15?"anomalous-good":e>=5?"better":e>=-5?"expected":e>=-20?"worse":"anomalous-bad"}function Ge(e,t,s,n,a){const i=n.tx_power??22,l=n.spreading_factor??12,o=n.coding_rate??5,r=n.frequency??0,c=r>1e5?r/1e6:r||915,d=n.bandwidth??0,u=d>1e3?d/1e3:d||125,m=(null==a?void 0:a.sensitivityOverrideDbm)??Ae(l,u,o);let h=null,x=null;t&&s&&Y(t.latitude??void 0,t.longitude??void 0)&&Y(s.latitude??void 0,s.longitude??void 0)&&(h=J(t.latitude,t.longitude,s.latitude,s.longitude),x=h/1e3);let p=null,g=null;null!=h&&h>0&&(p=ze(h,c),g=i+2.15+2.15-p);const f=e.avgRssi??null,v=e.avgSnr??null;let b=null,y=null;null!=f&&null!=g&&(b=f-g,y=Ie(b));let j=null,N=null;null!=f&&(j=f-m,N=$e(j));const w=null!=f,C="anomalous-good"===y||"anomalous-bad"===y;return{edgeKey:e.key,fromHash:e.fromHash,toHash:e.toHash,distanceM:h,distanceKm:x,fsplDb:p,theoreticalRxPowerDbm:g,observedRssiDbm:f,observedSnrDb:v,deviationDb:b,deviationClass:y,marginDb:j,marginClass:N,sensitivityDbm:m,txPowerDbm:i,frequencyMhz:c,spreadingFactor:l,bandwidthKhz:u,noiseFloorDbm:null,isZeroHop:e.isZeroHop??!1,isTraceEstimated:!1,hasData:w,isAnomalous:C}}function Oe(e,t,s,n,a=22,i){const l=e.traceQuality;if(!l)return null;let o=null;if(o=null!=l.forwardSnr&&null!=l.reverseSnr?Math.min(l.forwardSnr,l.reverseSnr):l.forwardSnr??l.reverseSnr,null==o)return null;const r=n.spreading_factor??12,c=n.coding_rate??5,d=n.bandwidth??0,u=d>1e3?d/1e3:d||125,m=1e3*u,h=n.frequency??0,x=h>1e5?h/1e6:h||915,p=(null==i?void 0:i.sensitivityOverrideDbm)??Ae(r,u,c),g=(null==i?void 0:i.observedNoiseFloorDbm)??Te(m),f=g+o;let v=null,b=null;t&&s&&Y(t.latitude??void 0,t.longitude??void 0)&&Y(s.latitude??void 0,s.longitude??void 0)&&(v=J(t.latitude,t.longitude,s.latitude,s.longitude),b=v/1e3);let y=null,j=null;null!=v&&v>0&&(y=ze(v,x),j=a+2.15+2.15-y);let N=null,w=null;null!=j&&(N=f-j,w=Ie(N));const C=f-p,k=$e(C);return{edgeKey:e.key,fromHash:e.fromHash,toHash:e.toHash,distanceM:v,distanceKm:b,fsplDb:y,theoreticalRxPowerDbm:j,observedRssiDbm:f,observedSnrDb:o,deviationDb:N,deviationClass:w,marginDb:C,marginClass:k,sensitivityDbm:p,noiseFloorDbm:g,txPowerDbm:a,frequencyMhz:x,spreadingFactor:r,bandwidthKhz:u,isZeroHop:!1,isTraceEstimated:!0,hasData:!0,isAnomalous:"anomalous-good"===w||"anomalous-bad"===w}}const Ze={"anomalous-good":"#2DD4BF",better:"#34D399",expected:"#9CA3AF",worse:"#FB923C","anomalous-bad":"#EF4444"},We={excellent:"#34D399",good:"#A3E635",fair:"#FBBF24",marginal:"#FB923C",critical:"#EF4444"};function Ve(e,t="margin"){return e.hasData?"deviation"===t?e.deviationClass?Ze[e.deviationClass]:"#505058":e.marginClass?We[e.marginClass]:"#505058":"#505058"}function Ke(e,t=.5,s=4){return null==e.marginDb?t:t+Math.max(0,Math.min(1,e.marginDb/40))*(s-t)}let _e=0;function qe(){return`ta-${++_e}-${Date.now()}`}function Ue(e){return{standard:0,ghost:1,mobile:2,neighbor:3,backbone:4,gateway:5,hub:6,local:7}[e]??0}class Xe{constructor(e=200){t(this,"prevSnapshot",null),t(this,"log",[]),t(this,"maxLog"),this.maxLog=e}update(e,t){const s=function(e){const t=new Set;for(const o of e.edges)t.add(o.key);const s=new Map,n=new Map,a=new Map,i=new Set;for(const[o,r]of e.nodeMetrics)s.set(o,r.betweenness),n.set(o,r.communityId),a.set(o,r.nodeClass),i.add(o);const l=new Set;for(const o of e.discoveredNodes)o.isLikelyReal&&l.add(o.prefix);return{timestamp:Date.now(),edgeKeys:t,betweenness:s,communities:n,nodeClasses:a,ghostPrefixes:l,nodeHashes:i}}(e);if(!this.prevSnapshot)return this.prevSnapshot=s,{anomalies:[],categoryCounts:{"edge-appeared":0,"edge-disappeared":0,"ghost-appeared":0,"ghost-disappeared":0,"betweenness-shift":0,"community-change":0,"class-change":0,"node-appeared":0,"node-disappeared":0},severityCounts:{info:0,warning:0,critical:0},totalCount:0,timestamp:Date.now()};const n=function(e,t,s){const n=Date.now(),a=[],i=e=>(null==s?void 0:s.get(e))??null;for(const d of t.edgeKeys)if(!e.edgeKeys.has(d)){const[e,t]=d.split("-"),s=i(e)??(null==e?void 0:e.slice(0,6)),l=i(t)??(null==t?void 0:t.slice(0,6));a.push({id:qe(),detectedAt:n,category:"edge-appeared",severity:"info",description:`New edge: ${s} ↔ ${l}`,edgeKey:d})}for(const d of e.edgeKeys)if(!t.edgeKeys.has(d)){const[e,t]=d.split("-"),s=i(e)??(null==e?void 0:e.slice(0,6)),l=i(t)??(null==t?void 0:t.slice(0,6));a.push({id:qe(),detectedAt:n,category:"edge-disappeared",severity:"warning",description:`Edge lost: ${s} ↔ ${l}`,edgeKey:d})}for(const d of t.nodeHashes)if(!e.nodeHashes.has(d)){const e=i(d);a.push({id:qe(),detectedAt:n,category:"node-appeared",severity:"info",description:`Node appeared: ${e??d.slice(0,8)}`,nodeHash:d,nodeName:e??void 0})}for(const d of e.nodeHashes)if(!t.nodeHashes.has(d)){const e=i(d);a.push({id:qe(),detectedAt:n,category:"node-disappeared",severity:"warning",description:`Node dropped: ${e??d.slice(0,8)}`,nodeHash:d,nodeName:e??void 0})}for(const d of t.ghostPrefixes)e.ghostPrefixes.has(d)||a.push({id:qe(),detectedAt:n,category:"ghost-appeared",severity:"info",description:`Ghost node discovered: ${d.toUpperCase()}`});for(const d of e.ghostPrefixes)t.ghostPrefixes.has(d)||a.push({id:qe(),detectedAt:n,category:"ghost-disappeared",severity:"info",description:`Ghost node resolved: ${d.toUpperCase()}`});for(const[d,u]of t.betweenness){const t=e.betweenness.get(d);if(void 0===t)continue;const s=Math.abs(u-t);if(s>=.15){const e=i(d),l=u>t?"increased":"decreased";a.push({id:qe(),detectedAt:n,category:"betweenness-shift",severity:s>=.3?"critical":"warning",description:`${e??d.slice(0,8)} betweenness ${l}: ${t.toFixed(3)} → ${u.toFixed(3)}`,nodeHash:d,nodeName:e??void 0,previousValue:t,currentValue:u})}}for(const[d,u]of t.communities){const t=e.communities.get(d);if(void 0!==t&&u!==t){const e=i(d);a.push({id:qe(),detectedAt:n,category:"community-change",severity:"info",description:`${e??d.slice(0,8)} moved: community #${t} → #${u}`,nodeHash:d,nodeName:e??void 0,previousValue:t,currentValue:u})}}for(const[d,u]of t.nodeClasses){const t=e.nodeClasses.get(d);if(void 0!==t&&u!==t){const e=i(d),s=Ue(u)>Ue(t);a.push({id:qe(),detectedAt:n,category:"class-change",severity:s?"warning":"info",description:`${e??d.slice(0,8)} ${s?"promoted":"changed"}: ${t} → ${u}`,nodeHash:d,nodeName:e??void 0,previousValue:t,currentValue:u})}}const l={},o={},r=["edge-appeared","edge-disappeared","ghost-appeared","ghost-disappeared","betweenness-shift","community-change","class-change","node-appeared","node-disappeared"],c=["info","warning","critical"];for(const d of r)l[d]=0;for(const d of c)o[d]=0;for(const d of a)l[d.category]++,o[d.severity]++;return a.sort((e,t)=>t.detectedAt-e.detectedAt),{anomalies:a,categoryCounts:l,severityCounts:o,totalCount:a.length,timestamp:n}}(this.prevSnapshot,s,t);this.prevSnapshot=s;try{!function(e,t){const s=t.edgeMap,n=t.nodeMetrics,a=new Set(t.backboneEdges??[]);for(const i of e){if(i.edgeKey&&("edge-appeared"===i.category||"edge-disappeared"===i.category)){const e=null==s?void 0:s.get(i.edgeKey),t=i.edgeKey.split("-"),l=t[0],o=t[1],r=l?null==n?void 0:n.get(l):void 0,c=o?null==n?void 0:n.get(o):void 0;i.edgeDetail=e?{fromName:(null==r?void 0:r.name)??null,toName:(null==c?void 0:c.name)??null,fromClass:(null==r?void 0:r.nodeClass)??null,toClass:(null==c?void 0:c.nodeClass)??null,packetCount:e.packetCount,confidence:e.avgConfidence,symmetryRatio:e.symmetryRatio,isBackbone:a.has(i.edgeKey),isLoop:e.isLoopEdge??!1,isZeroHop:e.isZeroHop??!1,isDirectPath:e.isDirectPathEdge,avgRssi:e.avgRssi??null,avgSnr:e.avgSnr??null,fromBetweenness:(null==r?void 0:r.betweenness)??null,toBetweenness:(null==c?void 0:c.betweenness)??null}:{fromName:(null==r?void 0:r.name)??null,toName:(null==c?void 0:c.name)??null,fromClass:(null==r?void 0:r.nodeClass)??null,toClass:(null==c?void 0:c.nodeClass)??null,packetCount:0,confidence:0,symmetryRatio:0,isBackbone:!1,isLoop:!1,isZeroHop:!1,isDirectPath:!1,avgRssi:null,avgSnr:null,fromBetweenness:(null==r?void 0:r.betweenness)??null,toBetweenness:(null==c?void 0:c.betweenness)??null}}if(i.nodeHash){const e=null==n?void 0:n.get(i.nodeHash);e&&(i.nodeDetail=Ye(e))}}}(n.anomalies,e)}catch(a){}return this.log.unshift(...n.anomalies),this.log.length>this.maxLog&&(this.log.length=this.maxLog),n}getLog(){return this.log}getFiltered(e){const t=Date.now();return this.log.filter(s=>!(e.category&&s.category!==e.category||e.severity&&s.severity!==e.severity||e.nodeHash&&s.nodeHash!==e.nodeHash||e.maxAge&&t-s.detectedAt>e.maxAge))}clear(){this.log=[],this.prevSnapshot=null}}function Ye(e){return{nodeClass:e.nodeClass,degree:e.degree,betweenness:e.betweenness,activityLevel:e.activityLevel,isZeroHop:e.isZeroHop,avgRssi:e.avgRssi,avgSnr:e.avgSnr,communityId:e.communityId,packetCount:e.packetCount,connectionCount:e.degree}}function Je(e){if(e.length<2)return 0;const t=e.length;let s=0,n=0,a=0,i=0;for(let o=0;o<t;o++)s+=o,n+=e[o],a+=o*e[o],i+=o*o;const l=t*i-s*s;return 0===l?0:(t*a-s*n)/l}const Qe=.15;function et(e,t,s){if(e.observationCount<5)return null;const n=[];let a=0;e.observationTrend<0&&(a=Math.abs(e.observationTrend),n.push({name:"Declining usage",description:e.observationTrend<-.3?"Traffic rapidly declining":"Traffic gradually declining",score:a,weight:.35}));const i=1-Math.min(1,e.avgEdgeCertainty);i>.3&&n.push({name:"Weak link certainty",description:e.weakestLinkKey?`Weakest: ${e.weakestLinkConfidence<.3?"very low":"low"} confidence`:`Average certainty: ${(100*e.avgEdgeCertainty).toFixed(0)}%`,score:i,weight:.3});let l=0;0===e.alternatePathsCount?(l=1,n.push({name:"No alternate paths",description:"Single route to destination — no failover available",score:l,weight:.2})):1===e.alternatePathsCount&&(l=.5,n.push({name:"Limited redundancy",description:"Only 1 alternate path available",score:l,weight:.2}));let o=0;if(e.weakestLinkKey){const a=t.get(e.weakestLinkKey);if(null!=(null==a?void 0:a.avgRssi)){const e=a.avgRssi-s;e<3?(o=1,n.push({name:"Signal near sensitivity",description:`Weakest link: ${e.toFixed(1)} dB margin (< 3 dB)`,score:o,weight:Qe})):e<10&&(o=1-(e-3)/7,n.push({name:"Low signal margin",description:`Weakest link: ${e.toFixed(1)} dB margin`,score:o,weight:Qe}))}}const r=.35*a+.3*i+.2*l+o*Qe;if(r<.35)return null;let c,d;return r>=.75?(c="critical",d="imminent"):r>=.55?(c="high",d="near-term"):(c="moderate",d="watch"),{pathKey:e.pathKey,hops:e.hops,riskScore:Math.round(100*r)/100,riskLevel:c,factors:n,weakestEdgeKey:e.weakestLinkKey,healthScore:e.healthScore,observationTrend:e.observationTrend,alternatePathsCount:e.alternatePathsCount,urgency:d}}let tt=100;function st(){return++tt}const nt="meshgraph-panel-";function at(e){try{const t=localStorage.getItem(nt+e);return t?JSON.parse(t):null}catch{return null}}function it({id:e,title:t,icon:a,open:i,onClose:l,defaultPosition:o,defaultSize:r,minSize:c={width:180,height:120},maxSize:d,autoHeight:u=!1,headerActions:g,children:f}){const v=O(),b=s.useRef(null),y=s.useRef(null),j=s.useMemo(()=>{const t=at(e);return t?{x:t.x,y:t.y,w:t.w,h:u?r.height:t.h,minimized:t.minimized}:{x:o.x,y:o.y,w:r.width,h:r.height,minimized:!1}},[e]),[N,w]=s.useState({w:j.w,h:j.h}),[C,k]=s.useState(j.minimized),[S,L]=s.useState(()=>st()),[D,F]=s.useState({x:j.x,y:j.y});s.useLayoutEffect(()=>{const t=b.current;if(!i||!t)return;const s=t.getBoundingClientRect();if(s.width<1||s.height<1)return;const n=at(e),a=(l=(null==n?void 0:n.x)??j.x,o=(null==n?void 0:n.y)??j.y,r=(null==n?void 0:n.w)??N.w,c=s.width,d=s.height,{x:Math.max(8,Math.min(l,Math.max(8,c-r-8))),y:Math.max(8,Math.min(o,Math.max(8,d-36)))});var l,o,r,c,d;F(a)},[i,e]);const[R,M]=s.useState(!1),H=s.useRef({startX:0,startY:0,startW:0,startH:0,edge:""}),B=s.useRef(),P=s.useCallback(()=>{B.current&&clearTimeout(B.current),B.current=setTimeout(()=>{const t=y.current;if(!t)return;const s=window.getComputedStyle(t),n=new DOMMatrix(s.transform);!function(e,t){try{localStorage.setItem(nt+e,JSON.stringify(t))}catch{}}(e,{x:n.m41,y:n.m42,w:N.w,h:N.h,minimized:C})},300)},[e,N.w,N.h,C]);s.useEffect(()=>{P()},[N,C,P]);const E=s.useCallback(()=>{L(st())},[]),z=s.useCallback(()=>{k(e=>!e)},[]),A=s.useCallback((e,t)=>{e.preventDefault(),e.stopPropagation(),M(!0),H.current={startX:e.clientX,startY:e.clientY,startW:N.w,startH:N.h,edge:t},E();const s=e=>{const{startX:t,startY:s,startW:n,startH:a,edge:i}=H.current,l=e.clientX-t,o=e.clientY-s;let r=n,u=a;"e"!==i&&"se"!==i||(r=Math.max(c.width,n+l),d&&(r=Math.min(d.width,r))),"s"!==i&&"se"!==i||(u=Math.max(c.height,a+o),d&&(u=Math.min(d.height,u))),w({w:r,h:u})},n=()=>{M(!1),window.removeEventListener("pointermove",s),window.removeEventListener("pointerup",n)};window.addEventListener("pointermove",s),window.addEventListener("pointerup",n)},[N,c,d,E]);return n.jsx("div",{ref:b,className:"absolute inset-0 pointer-events-none",style:{zIndex:S},children:n.jsx(m,{children:i&&n.jsxs(h.div,{ref:y,drag:!R,dragControls:v,dragConstraints:b,dragElastic:.05,dragMomentum:!1,dragListener:!1,initial:{opacity:0,scale:.96,x:D.x,y:D.y},animate:{opacity:1,scale:1,x:D.x,y:D.y},exit:{opacity:0,scale:.96},transition:{duration:.15},onPointerDown:E,className:"absolute top-0 left-0 pointer-events-auto",style:{width:N.w,touchAction:"none"},children:[n.jsxs("div",{className:"surface-elevated radius-inset shadow-xl overflow-hidden flex flex-col",style:{maxHeight:C?void 0:u?"80vh":N.h},children:[n.jsxs("div",{className:"flex items-center gap-1.5 px-2 py-1.5 border-b border-edge-subtle cursor-grab active:cursor-grabbing select-none shrink-0",onPointerDown:e=>{E(),v.start(e)},children:[n.jsx(Z,{className:"w-3 h-3 text-fg-muted/50 shrink-0"}),a&&n.jsx("span",{className:"text-fg-muted shrink-0 [&>svg]:w-3 [&>svg]:h-3",children:a}),n.jsx("span",{className:"text-[11px] font-medium text-fg-primary flex-1 truncate",children:t}),g,n.jsx("button",{onClick:z,className:"p-0.5 radius-badge hover-bg transition-base",title:C?"Expand":"Minimize",children:C?n.jsx(W,{className:"w-2.5 h-2.5 text-fg-muted"}):n.jsx(x,{className:"w-2.5 h-2.5 text-fg-muted"})}),n.jsx("button",{onClick:l,className:"p-0.5 radius-badge hover-bg transition-base",title:"Close",children:n.jsx(p,{className:"w-2.5 h-2.5 text-fg-muted"})})]}),n.jsx(m,{initial:!1,children:!C&&n.jsx(h.div,{initial:{height:0,opacity:0},animate:{height:"auto",opacity:1},exit:{height:0,opacity:0},transition:{duration:.15},className:"overflow-hidden",children:n.jsx("div",{className:"overflow-y-auto",style:{maxHeight:u?"70vh":void 0},children:f})})})]}),!C&&!u&&n.jsxs(n.Fragment,{children:[n.jsx("div",{className:"absolute top-0 -right-1 w-2 h-full cursor-ew-resize",onPointerDown:e=>A(e,"e")}),n.jsx("div",{className:"absolute -bottom-1 left-0 w-full h-2 cursor-ns-resize",onPointerDown:e=>A(e,"s")}),n.jsx("div",{className:"absolute -bottom-1 -right-1 w-3 h-3 cursor-nwse-resize",onPointerDown:e=>A(e,"se"),children:n.jsxs("svg",{className:"w-full h-full text-fg-muted/30",viewBox:"0 0 12 12",children:[n.jsx("path",{d:"M10 2 L10 10 L2 10",fill:"none",stroke:"currentColor",strokeWidth:"1.5"}),n.jsx("path",{d:"M7 5 L7 7 L5 7",fill:"none",stroke:"currentColor",strokeWidth:"1"})]})})]})]})})})}const lt=800,ot={critical:[k.red,k.red],poor:[k.orange,k.orange],fair:[k.amber,k.amber],good:[k.green,k.green],excellent:[k.blue,k.blue]},rt={active:1,recent:.85,stale:.45,inactive:.25},ct=[k.purple,k.green,k.amber,k.red,k.blue,k.pink,k.teal,k.orange],dt=[k.purple,k.green,k.amber,k.red,k.blue,k.pink,k.teal,k.orange];function ut(e,t,s){const n=(e,t)=>parseInt(e.slice(1+2*t,3+2*t),16);return`#${[0,1,2].map(a=>{return(i=a,Math.round(n(e,i)*s+n(t,i)*(1-s))).toString(16).padStart(2,"0");var i}).join("")}`}const mt={zeroHop:ut(k.amber,S[500],.55),directPath:ut(k.teal,S[500],.55),loop:ut(k.purple,S[500],.55),backbone:S[300],standard:S[500],standardDim:S[600],ghost:S[600]},ht={zeroHop:ut(k.amber,S[700],.5),directPath:ut(k.teal,S[700],.5),loop:ut(k.purple,S[700],.5),backbone:S[700],standard:S[400],standardDim:S[300],ghost:S[400]},xt=!1,pt=!0,gt=!0,ft=!0,vt=!0,bt=!0,yt={local:k.amber,hub:k.purple,gateway:k.blue,backbone:k.green,neighbor:k.pink,mobile:k.orange,ghost:S[400],standard:S[300]},jt={local:k.amber,hub:k.purple,gateway:k.blue,backbone:k.green,neighbor:k.pink,mobile:k.orange,ghost:S[500],standard:S[600]},Nt={local:"Your repeater — the home node running this dashboard",hub:"≥10% of last-hop traffic — dominant forwarder for your local node",gateway:"7-10% of last-hop traffic — significant relay node",backbone:"High betweenness centrality — critical path node connecting clusters",neighbor:"Zero-hop direct RF contact — no intermediate forwarders",mobile:"High path volatility — node appears and disappears frequently",ghost:"Unresolved prefix inferred by Viterbi HMM from path patterns",standard:"<7% of traffic — normal mesh participant"};function wt(e){const t=e.replace("#","");return[parseInt(t.slice(0,2),16),parseInt(t.slice(2,4),16),parseInt(t.slice(4,6),16)]}function Ct(e,t,s){const[n,a,i]=wt(e),[l,o,r]=wt(t),c=Math.max(0,Math.min(1,s)),d=Math.round(n*c+l*(1-c)),u=Math.round(a*c+o*(1-c)),m=Math.round(i*c+r*(1-c));return`#${d.toString(16).padStart(2,"0")}${u.toString(16).padStart(2,"0")}${m.toString(16).padStart(2,"0")}`}function kt(e,t){return e.isZeroHop?"zero-hop":e.isDirectPathEdge?"direct-path":e.isLoopEdge?"loop":t.has(e.key)?"backbone":"standard"}function St(e,t,s){const n=s?mt:ht;switch(e){case"zero-hop":return n.zeroHop;case"direct-path":return n.directPath;case"loop":return n.loop;case"backbone":return n.backbone;case"ghost":return n.ghost;default:return t>=.7?n.standard:n.standardDim}}const Lt={"zero-hop":"Zero-Hop (Direct RF)","direct-path":"Direct Path (Unicast)",loop:"Redundant Loop",backbone:"Backbone",standard:"Standard",ghost:"Ghost (Inferred)"},Dt={"zero-hop":"Direct radio contact — no intermediate forwarders in path","direct-path":"Unicast-routed edge — verified via DIRECT route type packets",loop:"Redundant path — alternate route between the same endpoints exists",backbone:"High betweenness centrality — critical traffic flow edge",standard:"Normal mesh edge with moderate-to-high confidence",ghost:"Inferred connection from Viterbi HMM ghost node analysis"},Ft=s.memo(function({timeline:e}){const t=e.buckets;if(t.length<2)return null;const[s,a]=e.rssiRange,i=Math.max(1,a-s),[l,o]=e.snrRange,r=Math.max(1,o-l),c=198/(t.length-1),d=t.map((e,t)=>{const n=1+t*c,a=1+34*(1-(e.avgRssi-s)/i);return`${n.toFixed(1)},${a.toFixed(1)}`}).join(" "),u=t.map((e,t)=>{const s=1+t*c,n=1+34*(1-(e.avgSnr-l)/r);return`${s.toFixed(1)},${n.toFixed(1)}`}).join(" "),m=e.rssiTrend>.1?"↑":e.rssiTrend<-.1?"↓":"→",h=e.snrTrend>.1?"↑":e.snrTrend<-.1?"↓":"→",x=e.rssiTrend>.1?"#34D399":e.rssiTrend<-.1?"#EF4444":"#9CA3AF",p=e.snrTrend>.1?"#34D399":e.snrTrend<-.1?"#EF4444":"#9CA3AF",g=(e.timeSpanMs/36e5).toFixed(1),f=function(e){const t=e.rssiTrend<-.1,s=e.snrTrend<-.1,n=e.rssiTrend>.1,a=e.snrTrend>.1,i=e.rssiRange[1]-e.rssiRange[0],l=e.snrRange[1]-e.snrRange[0];return t&&s?{text:"Both RSSI and SNR declining — possible antenna degradation or increasing distance",color:"#EF4444"}:s&&!t?{text:"SNR declining while RSSI stable — likely RF interference or noise floor increase",color:"#F97316"}:t&&!s?{text:"RSSI declining while SNR stable — possible path obstruction or power change",color:"#F97316"}:n&&a?{text:"Signal improving — conditions favorable or antenna adjustment working",color:"#34D399"}:i>15||l>10?{text:"High signal variance — intermittent obstruction or multipath fading",color:"#FBBF24"}:{text:"Signal stable — no significant degradation detected",color:"#9CA3AF"}}(e);return n.jsxs("div",{className:"mt-2 pt-2 border-t border-edge-subtle/50",children:[n.jsxs("div",{className:"flex items-center justify-between mb-1",children:[n.jsx(R,{content:n.jsxs("div",{className:"max-w-xs space-y-1.5",children:[n.jsx("div",{className:"font-semibold text-fg-primary",children:"Signal Quality Over Time"}),n.jsx("div",{className:"text-fg-secondary text-[11px]",children:"Tracks RSSI (signal power) and SNR (signal-to-noise ratio) for zero-hop packets received directly from this neighbor. Reveals weather effects, interference, and antenna degradation."}),n.jsxs("div",{className:"pt-1 border-t border-edge-subtle/30 space-y-0.5 font-mono text-[10px]",children:[n.jsxs("div",{className:"flex justify-between",children:[n.jsx("span",{className:"text-fg-muted",children:"Samples"}),n.jsx("span",{className:"text-fg-primary tabular-nums",children:e.totalSamples})]}),n.jsxs("div",{className:"flex justify-between",children:[n.jsx("span",{className:"text-fg-muted",children:"Time span"}),n.jsxs("span",{className:"text-fg-primary tabular-nums",children:[g,"h"]})]}),n.jsxs("div",{className:"flex justify-between",children:[n.jsx("span",{className:"text-fg-muted",children:"Avg RSSI"}),n.jsxs("span",{className:"text-fg-primary tabular-nums",children:[e.avgRssi.toFixed(1)," dBm"]})]}),n.jsxs("div",{className:"flex justify-between",children:[n.jsx("span",{className:"text-fg-muted",children:"Avg SNR"}),n.jsxs("span",{className:"text-fg-primary tabular-nums",children:[e.avgSnr.toFixed(1)," dB"]})]}),n.jsxs("div",{className:"flex justify-between",children:[n.jsx("span",{className:"text-fg-muted",children:"RSSI trend"}),n.jsxs("span",{className:"tabular-nums",style:{color:x},children:[e.rssiTrend>0?"+":"",e.rssiTrend.toFixed(3)," dBm/bucket"]})]}),n.jsxs("div",{className:"flex justify-between",children:[n.jsx("span",{className:"text-fg-muted",children:"SNR trend"}),n.jsxs("span",{className:"tabular-nums",style:{color:p},children:[e.snrTrend>0?"+":"",e.snrTrend.toFixed(3)," dB/bucket"]})]})]}),n.jsxs("div",{className:"text-[10px] text-fg-muted italic",children:["Trend is linear regression slope across ",t.length," time buckets. ↑ = improving, ↓ = degrading, → = stable."]})]}),children:n.jsx("span",{className:"text-[9px] text-fg-muted uppercase cursor-help",children:"Signal Timeline"})}),n.jsxs("span",{className:"text-[9px] text-fg-muted tabular-nums",children:[e.totalSamples," samples · ",g,"h"]})]}),n.jsxs("svg",{viewBox:"0 0 200 36",className:"w-full h-9",preserveAspectRatio:"none",children:[n.jsx("polyline",{points:d,fill:"none",stroke:"#60A5FA",strokeWidth:"1.5",strokeLinejoin:"round",strokeLinecap:"round",opacity:"0.8"}),n.jsx("polyline",{points:u,fill:"none",stroke:"#34D399",strokeWidth:"1",strokeLinejoin:"round",strokeLinecap:"round",opacity:"0.5",strokeDasharray:"3 2"})]}),n.jsxs("div",{className:"flex items-center justify-between text-[9px] mt-0.5",children:[n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsxs("span",{className:"flex items-center gap-0.5",children:[n.jsx("span",{className:"w-2.5 h-[1.5px] bg-[#60A5FA] rounded-full inline-block"}),n.jsx("span",{className:"text-fg-muted",children:"RSSI"}),n.jsx("span",{className:"tabular-nums",style:{color:x},children:m})]}),n.jsxs("span",{className:"flex items-center gap-0.5",children:[n.jsx("span",{className:"w-2.5 h-[1px] bg-[#34D399] rounded-full inline-block opacity-50",style:{borderTop:"1px dashed #34D399"}}),n.jsx("span",{className:"text-fg-muted",children:"SNR"}),n.jsx("span",{className:"tabular-nums",style:{color:p},children:h})]})]}),n.jsxs("div",{className:"flex items-center gap-2 text-fg-muted tabular-nums",children:[n.jsxs("span",{children:[s.toFixed(0),"…",a.toFixed(0)," dBm"]}),n.jsxs("span",{children:[l.toFixed(0),"…",o.toFixed(0)," dB"]})]})]}),n.jsx("div",{className:"mt-1 text-[9px] leading-tight",style:{color:f.color},children:f.text})]})}),Rt=s.memo(function({edge:e,onClose:t}){const[a,i]=s.useState(null);return s.useEffect(()=>{if(!e.isZeroHop&&"zero-hop"!==e.edgeType)return void i(null);const t=G.getState().packets,s=G.getState().cachedLocalHash??void 0,n=function(e,t,s,n,a=24){const i=function(e,t,s,n){var a;const i=[],l=t.replace(/^0x/i,"").slice(0,2).toLowerCase();for(const o of e){if(o.transmitted)continue;if(null==o.rssi||null==o.snr)continue;if(0===o.rssi&&0===o.snr)continue;const e=(null==(a=o.src_hash)?void 0:a.replace(/^0x/i,""))??"";if(e.slice(0,2).toLowerCase()!==l&&e!==t.replace(/^0x/i,""))continue;const s=o.original_path??o.forwarded_path??[],r=d(s,n),c=(null==r?void 0:r.effectiveLength)??0,m=o.route??o.route_type;let h=!1;h=null!=m&&u(m)?c<=1:0===c,h&&i.push({timestamp:1e3*o.timestamp,rssi:o.rssi,snr:o.snr})}if(i.sort((e,t)=>e.timestamp-t.timestamp),i.length>0&&i[0].timestamp<4102444800)for(const o of i)o.timestamp*=1e3;return i}(e,t,0,n);if(i.length<3)return null;const l=function(e,t=24){if(0===e.length)return[];const s=e[0].timestamp,n=e[e.length-1].timestamp-s;if(n<=0)return[{timestamp:s,avgRssi:e.reduce((e,t)=>e+t.rssi,0)/e.length,avgSnr:e.reduce((e,t)=>e+t.snr,0)/e.length,minRssi:Math.min(...e.map(e=>e.rssi)),maxRssi:Math.max(...e.map(e=>e.rssi)),minSnr:Math.min(...e.map(e=>e.snr)),maxSnr:Math.max(...e.map(e=>e.snr)),count:e.length}];const a=n/t,i=[];for(let o=0;o<t;o++)i.push({timestamp:s+(o+.5)*a,avgRssi:0,avgSnr:0,minRssi:1/0,maxRssi:-1/0,minSnr:1/0,maxSnr:-1/0,count:0});for(const o of e){const e=i[Math.min(t-1,Math.floor((o.timestamp-s)/a))];e.avgRssi+=o.rssi,e.avgSnr+=o.snr,e.minRssi=Math.min(e.minRssi,o.rssi),e.maxRssi=Math.max(e.maxRssi,o.rssi),e.minSnr=Math.min(e.minSnr,o.snr),e.maxSnr=Math.max(e.maxSnr,o.snr),e.count++}const l=[];for(const o of i)o.count>0&&(o.avgRssi/=o.count,o.avgSnr/=o.count,l.push(o));return l}(i,a);if(l.length<2)return null;let o=0,r=0,c=1/0,m=-1/0,h=1/0,x=-1/0;for(const d of i)o+=d.rssi,r+=d.snr,c=Math.min(c,d.rssi),m=Math.max(m,d.rssi),h=Math.min(h,d.snr),x=Math.max(x,d.snr);const p=Je(l.map(e=>e.avgRssi)),g=Je(l.map(e=>e.avgSnr)),f=i[0].timestamp,v=i[i.length-1].timestamp;return{buckets:l,totalSamples:i.length,rssiRange:[c,m],snrRange:[h,x],avgRssi:o/i.length,avgSnr:r/i.length,rssiTrend:p,snrTrend:g,timeSpanMs:v-f}}(t,e.source,e.target,s);i(n)},[e.source,e.target,e.isZeroHop,e.edgeType]),n.jsxs(h.div,{variants:U,initial:"hidden",animate:"visible",exit:"exit",className:"absolute inset-x-3 bottom-3 z-20 surface-elevated radius-inset shadow-xl",children:[n.jsxs("div",{className:"flex items-center justify-between px-4 py-2.5 border-b border-edge-subtle/50",children:[n.jsxs("div",{className:"flex items-center gap-2 min-w-0",children:[n.jsx(re,{className:"size-3.5 text-fg-muted shrink-0"}),n.jsxs("span",{className:"text-sm font-semibold text-fg-primary truncate",children:[e.fromName??e.source.slice(0,6)," → ",e.toName??e.target.slice(0,6)]}),n.jsxs("div",{className:"flex gap-1 shrink-0",children:[n.jsx(F,{color:"zinc",compact:!0,children:Lt[e.edgeType]}),e.isBackbone&&n.jsx(F,{color:"emerald",compact:!0,children:"BONE"}),e.isLoopEdge&&n.jsx(F,{color:"indigo",compact:!0,children:"LOOP"}),e.isGhost&&n.jsx(F,{color:"zinc",compact:!0,children:"GHOST"})]})]}),n.jsx($,{plain:!0,onClick:t,title:"Close",className:"shrink-0",children:n.jsx(p,{className:"size-4"})})]}),n.jsxs("div",{className:"p-3 font-mono text-[11px]",children:[n.jsxs("div",{className:"grid grid-cols-4 gap-3",children:[n.jsxs("div",{children:[n.jsx(R,{content:"Average disambiguation confidence across all observations of this edge",children:n.jsx("div",{className:"text-[9px] text-fg-muted uppercase cursor-help",children:"Confidence"})}),n.jsxs("div",{className:"text-fg-primary tabular-nums",children:[(100*e.confidence).toFixed(0),"%"]})]}),n.jsxs("div",{children:[n.jsx(R,{content:"Observations where both endpoints had high-confidence disambiguation",children:n.jsx("div",{className:"text-[9px] text-fg-muted uppercase cursor-help",children:"Certain"})}),n.jsx("div",{className:"text-fg-primary tabular-nums",children:e.certainCount.toLocaleString()})]}),n.jsxs("div",{children:[n.jsx(R,{content:"Total packets observed traversing this edge",children:n.jsx("div",{className:"text-[9px] text-fg-muted uppercase cursor-help",children:"Packets"})}),n.jsx("div",{className:"text-fg-primary tabular-nums",children:e.packetCount.toLocaleString()})]}),n.jsxs("div",{children:[n.jsx(R,{content:"Combined certainCount × confidence metric for edge ranking",children:n.jsx("div",{className:"text-[9px] text-fg-muted uppercase cursor-help",children:"Strength"})}),n.jsx("div",{className:"text-fg-primary tabular-nums",children:e.strength.toFixed(2)})]})]}),n.jsxs("div",{className:"grid grid-cols-4 gap-3 mt-2",children:[n.jsxs("div",{children:[n.jsx(R,{content:"Bidirectional balance (min/max) — 0 = one-way traffic, 1 = perfectly balanced",children:n.jsx("div",{className:"text-[9px] text-fg-muted uppercase cursor-help",children:"Symmetry"})}),n.jsx("div",{className:"text-fg-primary tabular-nums",children:e.symmetryRatio.toFixed(2)})]}),n.jsxs("div",{children:[n.jsx(R,{content:"Dominant traffic flow direction between these nodes",children:n.jsx("div",{className:"text-[9px] text-fg-muted uppercase cursor-help",children:"Direction"})}),n.jsx("div",{className:"text-fg-primary capitalize",children:e.dominantDirection})]}),n.jsxs("div",{children:[n.jsx(R,{content:"Forward (A→B) vs reverse (B→A) observation counts",children:n.jsx("div",{className:"text-[9px] text-fg-muted uppercase cursor-help",children:"Fwd / Rev"})}),n.jsxs("div",{className:"text-fg-primary tabular-nums",children:[e.forwardCount," / ",e.reverseCount]})]}),n.jsxs("div",{children:[n.jsx(R,{content:"Routing method — broadcast flood vs unicast direct routing",children:n.jsx("div",{className:"text-[9px] text-fg-muted uppercase cursor-help",children:"Flood / Direct"})}),n.jsxs("div",{className:"text-fg-primary tabular-nums",children:[e.floodCount," / ",e.directCount]})]})]}),(null!=e.avgRssi||null!=e.avgSnr)&&n.jsxs("div",{className:"grid grid-cols-2 gap-3 mt-2 pt-2 border-t border-edge-subtle/50",children:[null!=e.avgRssi&&n.jsxs("div",{children:[n.jsx("div",{className:"text-[9px] text-fg-muted uppercase",children:"RSSI"}),n.jsxs("div",{className:"text-fg-primary tabular-nums",children:[e.avgRssi.toFixed(1)," dBm"]})]}),null!=e.avgSnr&&n.jsxs("div",{children:[n.jsx("div",{className:"text-[9px] text-fg-muted uppercase",children:"SNR"}),n.jsxs("div",{className:"text-fg-primary tabular-nums",children:[e.avgSnr.toFixed(1)," dB"]})]})]}),e.linkBudget&&n.jsxs("div",{className:"grid grid-cols-4 gap-3 mt-2 pt-2 border-t border-edge-subtle/50",children:[null!=e.linkBudget.distanceKm&&n.jsxs("div",{children:[n.jsx(R,{content:"Haversine distance between endpoint locations",children:n.jsx("div",{className:"text-[9px] text-fg-muted uppercase cursor-help",children:"Distance"})}),n.jsxs("div",{className:"text-fg-primary tabular-nums",children:[e.linkBudget.distanceKm.toFixed(2)," km"]})]}),null!=e.linkBudget.fsplDb&&n.jsxs("div",{children:[n.jsx(R,{content:"Free Space Path Loss — theoretical signal attenuation over this distance at configured frequency",children:n.jsx("div",{className:"text-[9px] text-fg-muted uppercase cursor-help",children:"FSPL"})}),n.jsxs("div",{className:"text-fg-primary tabular-nums",children:[e.linkBudget.fsplDb.toFixed(1)," dB"]})]}),null!=e.linkBudget.marginDb&&n.jsxs("div",{children:[n.jsx(R,{content:"Link margin — observed RSSI minus receiver sensitivity. Positive = signal headroom above minimum.",children:n.jsx("div",{className:"text-[9px] text-fg-muted uppercase cursor-help",children:"Margin"})}),n.jsxs("div",{className:"text-fg-primary tabular-nums",style:{color:e.linkBudget.marginClass?We[e.linkBudget.marginClass]:void 0},children:[e.linkBudget.marginDb>0?"+":"",e.linkBudget.marginDb.toFixed(1)," dB"]})]}),null!=e.linkBudget.deviationDb&&n.jsxs("div",{children:[n.jsx(R,{content:"Deviation from theoretical FSPL — positive means better signal than free-space prediction",children:n.jsx("div",{className:"text-[9px] text-fg-muted uppercase cursor-help",children:"vs Theory"})}),n.jsxs("div",{className:"text-fg-primary tabular-nums",children:[e.linkBudget.deviationDb>0?"+":"",e.linkBudget.deviationDb.toFixed(1)," dB"]})]})]}),a&&n.jsx(Ft,{timeline:a})]})]})}),Mt=s.memo(function({node:e,onClose:t,egoMetrics:a,onExpandEgo:i,neighbors:l,onSelectNeighbor:o}){const[r,c]=s.useState(!1);return n.jsxs(h.div,{variants:U,initial:"hidden",animate:"visible",exit:"exit",className:"absolute inset-x-3 bottom-3 z-20 surface-elevated radius-inset shadow-xl max-h-[60vh] flex flex-col",children:[n.jsxs("div",{className:"flex items-center justify-between px-4 py-2.5 border-b border-edge-subtle/50",children:[n.jsxs("div",{className:"flex items-center gap-2 min-w-0",children:[n.jsx("span",{className:"size-2 shrink-0 rounded-full",style:{backgroundColor:(T()?yt:jt)[e.nodeClass]}}),n.jsx("code",{className:"text-sm font-semibold text-fg-primary shrink-0",children:e.prefix}),e.name&&n.jsx("span",{className:"text-sm text-fg-secondary truncate",children:e.name}),n.jsxs("div",{className:"flex gap-1 shrink-0",children:[e.isLocal&&n.jsx(F,{color:"yellow",compact:!0,children:"LOCAL"}),e.isHub&&n.jsx(F,{color:"violet",compact:!0,children:"HUB"}),e.isGateway&&n.jsx(F,{color:"sky",compact:!0,children:"GW"}),e.isBackbone&&n.jsx(F,{color:"emerald",compact:!0,children:"BONE"}),e.isMobile&&n.jsx(F,{color:"orange",compact:!0,children:"MOB"}),e.isZeroHop&&n.jsx(F,{color:"amber",compact:!0,children:"RF"}),e.isGhost&&n.jsx(F,{color:"zinc",compact:!0,children:"GHOST"}),e.isInLoop&&n.jsx(F,{color:"indigo",compact:!0,children:"LOOP"})]})]}),n.jsx($,{plain:!0,onClick:t,title:"Close",className:"shrink-0",children:n.jsx(p,{className:"size-4"})})]}),n.jsxs("div",{className:"p-3 font-mono text-[11px]",children:[n.jsx(X,{copy:!0,size:"compact",truncate:[10,6],className:"w-full mb-3",children:e.hash}),n.jsxs("div",{className:"grid grid-cols-4 gap-3",children:[n.jsxs("div",{children:[n.jsx(R,{content:"Total connections (edges) to this node",children:n.jsx("div",{className:"text-[9px] text-fg-muted uppercase cursor-help",children:"Degree"})}),n.jsx("div",{className:"text-fg-primary tabular-nums",children:e.degree})]}),n.jsxs("div",{children:[n.jsx(R,{content:"Inbound vs outbound edge count — indicates traffic directionality",children:n.jsx("div",{className:"text-[9px] text-fg-muted uppercase cursor-help",children:"In / Out"})}),n.jsxs("div",{className:"text-fg-primary tabular-nums",children:[e.inDegree," / ",e.outDegree]})]}),n.jsxs("div",{children:[n.jsx(R,{content:"Betweenness centrality (0–1) — how often this node lies on shortest paths. High value = critical relay.",children:n.jsx("div",{className:"text-[9px] text-fg-muted uppercase cursor-help",children:"Between."})}),n.jsx("div",{className:"text-fg-primary tabular-nums",children:e.betweenness.toFixed(3)})]}),n.jsxs("div",{children:[n.jsx(R,{content:"Total packets observed involving this node",children:n.jsx("div",{className:"text-[9px] text-fg-muted uppercase cursor-help",children:"Packets"})}),n.jsx("div",{className:"text-fg-primary tabular-nums",children:e.packetCount.toLocaleString()})]})]}),n.jsxs("div",{className:"grid grid-cols-4 gap-3 mt-2",children:[n.jsxs("div",{children:[n.jsx(R,{content:"Number of topology edges connected to this node",children:n.jsx("div",{className:"text-[9px] text-fg-muted uppercase cursor-help",children:"Edges"})}),n.jsx("div",{className:"text-fg-primary tabular-nums",children:e.edgeCount})]}),n.jsxs("div",{children:[n.jsx(R,{content:"Community cluster assignment from graph partitioning algorithm",children:n.jsx("div",{className:"text-[9px] text-fg-muted uppercase cursor-help",children:"Community"})}),n.jsxs("div",{className:"text-fg-primary tabular-nums",children:["#",e.communityId]})]}),n.jsxs("div",{children:[n.jsx(R,{content:"Prefix disambiguation confidence — how certain the 2-char prefix→node mapping is (multi-factor scoring)",children:n.jsx("div",{className:"text-[9px] text-fg-muted uppercase cursor-help",children:"Confidence"})}),n.jsxs("div",{className:"text-fg-primary tabular-nums",children:[(100*e.prefixConfidence).toFixed(0),"%"]})]}),n.jsxs("div",{children:[n.jsx(R,{content:"Recency level — active (<1h), recent (<6h), stale (<24h), inactive (>24h)",children:n.jsx("div",{className:"text-[9px] text-fg-muted uppercase cursor-help",children:"Activity"})}),n.jsx("div",{className:"text-fg-primary capitalize",children:e.activityLevel})]})]}),(null!=e.avgRssi||null!=e.avgSnr)&&n.jsxs("div",{className:"grid grid-cols-2 gap-3 mt-2 pt-2 border-t border-edge-subtle/50",children:[null!=e.avgRssi&&n.jsxs("div",{children:[n.jsx("div",{className:"text-[9px] text-fg-muted uppercase",children:"RSSI"}),n.jsxs("div",{className:"text-fg-primary tabular-nums",children:[e.avgRssi.toFixed(1)," dBm"]})]}),null!=e.avgSnr&&n.jsxs("div",{children:[n.jsx("div",{className:"text-[9px] text-fg-muted uppercase",children:"SNR"}),n.jsxs("div",{className:"text-fg-primary tabular-nums",children:[e.avgSnr.toFixed(1)," dB"]})]})]}),a&&n.jsxs(n.Fragment,{children:[n.jsxs("div",{className:"grid grid-cols-3 gap-3 mt-2 pt-2 border-t border-edge-subtle/50",children:[n.jsxs("div",{children:[n.jsx(R,{content:"Number of direct 1-hop neighbors in the topology",children:n.jsx("div",{className:"text-[9px] text-fg-muted uppercase cursor-help",children:"Ego Size"})}),n.jsx("div",{className:"text-fg-primary tabular-nums",children:a.neighborCount})]}),n.jsxs("div",{children:[n.jsx(R,{content:"Local clustering coefficient — how interconnected this node's neighbors are (0 = none, 1 = fully connected)",children:n.jsx("div",{className:"text-[9px] text-fg-muted uppercase cursor-help",children:"Clustering"})}),n.jsx("div",{className:"text-fg-primary tabular-nums",children:a.clusteringCoeff.toFixed(3)})]}),n.jsxs("div",{children:[n.jsx(R,{content:"Average betweenness centrality of this node's direct neighbors",children:n.jsx("div",{className:"text-[9px] text-fg-muted uppercase cursor-help",children:"Avg Nbr Btw."})}),n.jsx("div",{className:"text-fg-primary tabular-nums",children:a.avgNeighborBetweenness.toFixed(3)})]})]}),n.jsxs("div",{className:"grid grid-cols-3 gap-3 mt-2",children:[n.jsxs("div",{children:[n.jsx(R,{content:"Average disambiguation confidence across all connected edges",children:n.jsx("div",{className:"text-[9px] text-fg-muted uppercase cursor-help",children:"Edge Conf."})}),n.jsxs("div",{className:"text-fg-primary tabular-nums",children:[(100*a.avgEdgeConfidence).toFixed(0),"%"]})]}),null!=a.avgRssi&&n.jsxs("div",{children:[n.jsx("div",{className:"text-[9px] text-fg-muted uppercase",children:"Avg RSSI"}),n.jsxs("div",{className:"text-fg-primary tabular-nums",children:[a.avgRssi.toFixed(1)," dBm"]})]}),null!=a.avgSnr&&n.jsxs("div",{children:[n.jsx("div",{className:"text-[9px] text-fg-muted uppercase",children:"Avg SNR"}),n.jsxs("div",{className:"text-fg-primary tabular-nums",children:[a.avgSnr.toFixed(1)," dB"]})]})]})]}),i&&n.jsx("div",{className:"mt-2 pt-2 border-t border-edge-subtle/50",children:n.jsxs("button",{onClick:i,className:"flex items-center gap-1.5 text-[10px] text-sys-blue hover:text-sys-blue/80 transition-base",children:[n.jsx(I,{className:"w-3 h-3"}),"Expand 2-hop neighborhood"]})}),l&&l.length>0&&n.jsxs("div",{className:"mt-2 pt-2 border-t border-edge-subtle/50",children:[n.jsxs("button",{onClick:()=>c(e=>!e),className:"flex items-center justify-between w-full text-[9px] text-fg-muted uppercase tracking-wide cursor-pointer hover:text-fg-secondary transition-base",children:[n.jsxs("span",{children:["Neighbors (",l.length,")"]}),n.jsx(E,{className:"w-3 h-3 transition-transform "+(r?"rotate-180":"")})]}),r&&n.jsx("div",{className:"mt-1.5 max-h-32 overflow-y-auto space-y-0.5",children:l.map(e=>n.jsxs("button",{onClick:()=>null==o?void 0:o(e.hash),className:"w-full flex items-center gap-2 px-1.5 py-1 radius-badge hover-bg transition-base text-left group",children:[n.jsx("code",{className:"text-[10px] text-sys-blue shrink-0 tabular-nums",children:e.prefix}),n.jsx("span",{className:"text-[10px] text-fg-secondary truncate flex-1",children:e.name||"—"}),null!=e.avgSnr&&n.jsxs("span",{className:"text-[9px] text-fg-muted tabular-nums shrink-0",children:[e.avgSnr.toFixed(0)," dB"]}),null!=e.avgRssi&&n.jsx("span",{className:"text-[9px] text-fg-muted tabular-nums shrink-0",children:e.avgRssi.toFixed(0)}),n.jsxs("span",{className:"text-[9px] text-fg-muted/60 tabular-nums shrink-0",children:[(100*e.edgeConfidence).toFixed(0),"%"]})]},e.hash))})]})]})]})}),Ht=s.memo(function({metrics:e,onClose:t}){const s=Object.entries(e.communities).sort(([,e],[,t])=>t-e),a=Object.entries(e.nodeClasses).sort(([,e],[,t])=>t-e);return n.jsxs(h.div,{variants:U,initial:"hidden",animate:"visible",exit:"exit",className:"absolute inset-x-3 bottom-3 z-20 surface-elevated radius-inset shadow-xl",children:[n.jsxs("div",{className:"flex items-center justify-between px-4 py-2.5 border-b border-edge-subtle/50",children:[n.jsxs("div",{className:"flex items-center gap-2 min-w-0",children:[n.jsx(ue,{className:"size-3.5 text-fg-muted shrink-0"}),n.jsx("span",{className:"text-sm font-semibold text-fg-primary",children:"Subgraph Analysis"}),n.jsxs(F,{color:"violet",compact:!0,children:[e.nodeCount," nodes"]})]}),n.jsx($,{plain:!0,onClick:t,title:"Close",className:"shrink-0",children:n.jsx(p,{className:"size-4"})})]}),n.jsxs("div",{className:"p-3 font-mono text-[11px]",children:[n.jsxs("div",{className:"grid grid-cols-4 gap-3",children:[n.jsxs("div",{children:[n.jsx("div",{className:"text-[9px] text-fg-muted uppercase",children:"Nodes"}),n.jsx("div",{className:"text-fg-primary tabular-nums",children:e.nodeCount})]}),n.jsxs("div",{children:[n.jsx(R,{content:"Edges where both endpoints are within the lasso selection",children:n.jsx("div",{className:"text-[9px] text-fg-muted uppercase cursor-help",children:"Internal Edges"})}),n.jsx("div",{className:"text-fg-primary tabular-nums",children:e.edgeCount})]}),n.jsxs("div",{children:[n.jsx(R,{content:"Mean betweenness centrality of selected nodes",children:n.jsx("div",{className:"text-[9px] text-fg-muted uppercase cursor-help",children:"Avg Between."})}),n.jsx("div",{className:"text-fg-primary tabular-nums",children:e.avgBetweenness.toFixed(3)})]}),n.jsxs("div",{children:[n.jsx(R,{content:"Mean edge disambiguation confidence for internal edges",children:n.jsx("div",{className:"text-[9px] text-fg-muted uppercase cursor-help",children:"Avg Confidence"})}),n.jsxs("div",{className:"text-fg-primary tabular-nums",children:[(100*e.avgConfidence).toFixed(0),"%"]})]})]}),n.jsxs("div",{className:"grid grid-cols-2 gap-3 mt-2 pt-2 border-t border-edge-subtle/50",children:[n.jsxs("div",{children:[n.jsx("div",{className:"text-[9px] text-fg-muted uppercase mb-1",children:"Communities"}),n.jsx("div",{className:"flex flex-wrap gap-1",children:s.map(([e,t])=>n.jsxs("span",{className:"text-fg-secondary",children:["#",e,"×",t]},e))})]}),n.jsxs("div",{children:[n.jsx("div",{className:"text-[9px] text-fg-muted uppercase mb-1",children:"Node Types"}),n.jsx("div",{className:"flex flex-wrap gap-1",children:a.map(([e,t])=>n.jsxs("span",{className:"text-fg-secondary capitalize",children:[e,"×",t]},e))})]})]}),e.nodeCount>1&&n.jsx("div",{className:"mt-2 pt-2 border-t border-edge-subtle/50",children:n.jsxs("div",{className:"text-[9px] text-fg-muted flex items-center gap-1 flex-wrap",children:[n.jsx(R,{content:"Fraction of possible edges that exist — 2E / N(N-1)",children:n.jsxs("span",{className:"cursor-help",children:["Density: ",(2*e.edgeCount/(e.nodeCount*(e.nodeCount-1))*100).toFixed(1),"%"]})}),n.jsx("span",{children:"·"}),n.jsx(R,{content:"Mean connections per node — 2E / N",children:n.jsxs("span",{className:"cursor-help",children:["Avg Degree: ",(2*e.edgeCount/e.nodeCount).toFixed(1)]})}),null!=e.avgPathHealth&&n.jsxs(n.Fragment,{children:[n.jsx("span",{children:"·"}),n.jsx(R,{content:"Average health score of paths within the selection",children:n.jsxs("span",{className:"cursor-help",children:["Path Health: ",(100*e.avgPathHealth).toFixed(0),"%"]})})]})]})})]})]})});function Bt(){return n.jsxs("div",{className:"flex flex-col items-center justify-center gap-6 text-center px-8",children:[n.jsx("div",{className:"p-4 radius-pill bg-subtle-fill",children:n.jsx(oe,{className:"w-8 h-8 text-fg-muted"})}),n.jsxs("div",{className:"space-y-2",children:[n.jsx("h2",{className:"type-subheading text-fg-primary",children:"No Topology Data"}),n.jsx("p",{className:"type-body text-fg-muted max-w-sm",children:"The mesh topology will appear here once packets are received and processed."})]}),n.jsxs("div",{className:"flex items-center gap-2 type-data-xs text-fg-muted",children:[n.jsx(B,{className:"w-4 h-4 animate-pulse"}),n.jsx("span",{children:"Waiting for mesh traffic..."})]})]})}const Pt=s.memo(function({label:e,value:t,onChange:a,min:i,max:l,step:o}){const[r,c]=s.useState(!1),[d,u]=s.useState(""),m=s.useRef(null),h=s.useCallback(()=>{const e=parseFloat(d);isNaN(e)||a(Math.min(l,Math.max(i,Math.round(e/o)*o))),c(!1)},[d,a,i,l,o]),x=s.useCallback(()=>{u(t.toFixed(2)),c(!0),setTimeout(()=>{var e;return null==(e=m.current)?void 0:e.select()},0)},[t]);return n.jsxs("div",{className:"space-y-1",children:[n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"text-[10px] text-fg-muted",children:e}),r?n.jsx("input",{ref:m,type:"number",value:d,onChange:e=>u(e.target.value),onBlur:h,onKeyDown:e=>{"Enter"===e.key&&h(),"Escape"===e.key&&c(!1)},min:i,max:l,step:o,className:"w-14 text-right text-[10px] text-fg-secondary tabular-nums bg-subtle-fill radius-badge px-1 py-0.5 border border-edge-subtle focus:outline-none focus:border-sys-blue"}):n.jsx("button",{onClick:x,className:"text-[10px] text-fg-secondary tabular-nums hover:text-sys-blue cursor-text transition-colors",title:"Click to type a value",children:t.toFixed(2)})]}),n.jsx("input",{type:"range",min:i,max:l,step:o,value:t,onChange:e=>a(parseFloat(e.target.value)),className:"w-full h-1 bg-subtle-fill rounded appearance-none cursor-pointer [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:w-3 [&::-webkit-slider-thumb]:h-3 [&::-webkit-slider-thumb]:bg-sys-blue [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:cursor-pointer"})]})}),Et=s.memo(function({label:e,checked:t,onChange:s}){return n.jsxs(l,{className:"flex items-center justify-between",children:[n.jsx(o,{className:"text-[10px] text-fg-muted cursor-pointer select-none",children:e}),n.jsx(A,{enabled:t,onChange:s,size:"sm"})]})});function zt(){var e,t,l,o,r,c,d,u,x,k,A,T,$,I,G;const O=g(),[Z,U]=s.useState(!1),[X,Y]=s.useState(!1),J=s.useRef(!1);s.useEffect(()=>{O&&!J.current&&(J.current=!0,Y(!0))},[O]);const oe=s.useCallback(()=>{Y(!1),U(!0)},[]),re=f(),he=function(e,t=1e3){const[n,a]=s.useState(e),i=s.useRef(Date.now()),l=s.useRef(null);return s.useEffect(()=>{const s=Date.now(),n=t-(s-i.current);return n<=0?(a(e),i.current=s):(l.current&&clearTimeout(l.current),l.current=setTimeout(()=>{a(e),i.current=Date.now()},n)),()=>{l.current&&clearTimeout(l.current)}},[e,t]),n}(v(),2e3),xe=b(),pe=y(),ge=j(),fe=N(),ve=w(),be=C(),ye=be?yt:jt,je=be?ct:dt,Ne=s.useMemo(()=>function(e){if("undefined"==typeof document)return e?S[950]:"#EFF0F1";const t=getComputedStyle(document.documentElement).getPropertyValue("--bg-body").trim();return t.startsWith("#")?t:e?S[950]:"#EFF0F1"}(be),[be]),we=s.useMemo(()=>function(e){if("undefined"==typeof document)return e?S[400]:S[500];const t=getComputedStyle(document.documentElement).getPropertyValue("--text-secondary").trim();return t.startsWith("#")?t:e?S[400]:S[500]}(be),[be]),[Ce,ke]=s.useState(!0),[Se,Le]=s.useState(null),[De,Re]=s.useState(null),[Me,Be]=s.useState(!1),[Pe,Ee]=s.useState(""),[ze,$e]=s.useState(!1),[Ie,Ze]=s.useState(!1),[_e,qe]=s.useState("simulation"),[Ue,Ye]=s.useState(!0),[Je,Qe]=s.useState(!1),[tt,st]=s.useState(!0),[nt,at]=s.useState(!1),[ut,wt]=s.useState(!1),[Lt,Ft]=s.useState(new Set),[zt,At]=s.useState(!1),[Tt,$t]=s.useState("spectral"),[It,Gt]=s.useState(1),[Ot,Zt]=s.useState(1),[Wt,Vt]=s.useState(!1),[Kt,_t]=s.useState(null),[qt,Ut]=s.useState(!1),[Xt,Yt]=s.useState(!1),[Jt,Qt]=s.useState(null),[es,ts]=s.useState(null),[ss,ns]=s.useState(null),[as,is]=s.useState(null),[ls,os]=s.useState(null),[rs,cs]=s.useState(null),ds=s.useRef(!1),[us,ms]=s.useState(!1),[hs,xs]=s.useState([]),[ps,gs]=s.useState(0),[fs,vs]=s.useState(null),bs=s.useRef(new Xe),ys=s.useRef(null),js=s.useRef(null),[Ns,ws]=s.useState(null),[Cs,ks]=s.useState(null),[Ss,Ls]=s.useState({}),[Ds,Fs]=s.useState({simulationDecay:2e4,simulationGravity:.05,simulationCenter:.05,simulationRepulsion:5,simulationRepulsionTheta:.4,simulationLinkSpring:.05,simulationLinkDistance:78,simulationFriction:.72,simulationRepulsionFromMouse:0,pointSizeScale:.4,pointOpacity:1,pointGreyoutOpacity:.1,linkWidthScale:.06,linkOpacity:.95,linkGreyoutOpacity:.1,curvedLinks:xt,curvedLinkWeight:.8,linkDefaultArrows:pt,linkArrowsSizeScale:1.7,scalePointsOnZoom:gt,scaleLinksOnZoom:ft,renderLinks:vt,renderHoveredPointRing:bt,spaceSize:4096}),Rs=s.useCallback((e,t)=>{Fs(s=>({...s,[e]:t}))},[]),Ms=s.useCallback(()=>{Fs({simulationDecay:2e4,simulationGravity:.05,simulationCenter:.05,simulationRepulsion:5,simulationRepulsionTheta:.4,simulationLinkSpring:.05,simulationLinkDistance:78,simulationFriction:.72,simulationRepulsionFromMouse:0,pointSizeScale:.4,pointOpacity:1,pointGreyoutOpacity:.1,linkWidthScale:.06,linkOpacity:.95,linkGreyoutOpacity:.1,curvedLinks:xt,curvedLinkWeight:.8,linkDefaultArrows:pt,linkArrowsSizeScale:1.7,scalePointsOnZoom:gt,scaleLinksOnZoom:ft,renderLinks:vt,renderHoveredPointRing:bt,spaceSize:4096})},[]);s.useEffect(()=>()=>{var e;try{null==(e=js.current)||e.destroy()}catch{}js.current=null},[]),s.useEffect(()=>{const e=e=>{var t,s;if(!(e.target instanceof HTMLInputElement||e.target instanceof HTMLSelectElement))switch(e.key.toLowerCase()){case"f":e.metaKey||e.ctrlKey||(e.preventDefault(),null==(t=js.current)||t.fitView(lt));break;case"escape":ze?($e(!1),Ee("")):Se&&(Le(null),null==(s=js.current)||s.unselectAllPoints());break;case"/":ze||(e.preventDefault(),$e(!0),setTimeout(()=>{var e;return null==(e=ys.current)?void 0:e.focus()},50));break;case" ":e.preventDefault(),js.current&&(Ce?js.current.pause():js.current.start(),ke(e=>!e));break;case"l":Ye(e=>!e)}};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[ze,Se,Ce]);const Hs=s.useMemo(()=>new Set((null==re?void 0:re.backboneEdges)??[]),[null==re?void 0:re.backboneEdges]),Bs=s.useMemo(()=>({resolution:It,kWeight:Ot}),[It,Ot]),Ps=s.useMemo(()=>{if("louvain"!==Tt)return null;const e=null==re?void 0:re.edges;return!e||0===e.length||!he||he.size<3?null:He(e,Array.from(he.keys()),Bs).communities},[Tt,null==re?void 0:re.edges,he,Bs]),Es=s.useMemo(()=>{var e;if(!he||0===he.size||!Z)return[];const t=[],s=(null==ve?void 0:ve.node_name)??(null==(e=null==ve?void 0:ve.config)?void 0:e.node_name)??null,n=be?"#171717":"#EFF0F1";let a=1;for(const i of he.values())i.degree>a&&(a=i.degree);for(const i of he.values()){const e=i,l=e.degree>0?Math.log10(e.degree+1)/Math.log10(a+1):0,o=5+23*Math.min(1,l),r=6*e.betweenness,c=e.isLocal?28:Math.min(34,o+r),d=(null==Ps?void 0:Ps.get(e.hash))??e.communityId,u=zt&&d>=0?je[d%je.length]:ye[e.nodeClass],m=rt[e.activityLevel]??1,h=e.isLocal?ye.local:m<1?Ct(u,n,m):u,x=e.isLocal?s??e.name:e.name;t.push({id:e.hash,label:x?`${e.prefix} ${x}`:e.prefix,color:h,size:c,nodeClass:e.nodeClass,name:x,prefix:e.prefix,packetCount:e.packetCount,isLocal:e.isLocal,isHub:e.isHub,isGateway:e.isGateway,isBackbone:e.isBackbone,isMobile:e.isMobile,isZeroHop:e.isZeroHop,isGhost:e.isGhost,degree:e.degree,betweenness:e.betweenness,communityId:(null==Ps?void 0:Ps.get(e.hash))??e.communityId,activityLevel:e.activityLevel,prefixConfidence:e.prefixConfidence,hasCollision:e.hasCollision,inDegree:e.inDegree,outDegree:e.outDegree,isInLoop:e.isInLoop,avgRssi:e.avgRssi,avgSnr:e.avgSnr})}for(const i of xe){const e=`ghost-${i.prefix}`;if(t.some(t=>t.id===e))continue;const s=Ct(ye.ghost,n,.6);t.push({id:e,label:`? ${i.prefix.toUpperCase()}`,color:s,size:6,nodeClass:"ghost",name:null,prefix:i.prefix,packetCount:i.observationCount,isLocal:!1,isHub:!1,isGateway:!1,isBackbone:!1,isMobile:!1,isZeroHop:!1,isGhost:!0,degree:i.commonNeighbors.size,betweenness:0,communityId:-1,activityLevel:"active",prefixConfidence:i.confidence,hasCollision:!1,inDegree:0,outDegree:0,isInLoop:!1,avgRssi:null,avgSnr:null})}return t},[he,Z,null==ve?void 0:ve.node_name,null==(e=null==ve?void 0:ve.config)?void 0:e.node_name,ye,be,xe,je,zt,Tt,Ps]),zs=s.useMemo(()=>new Set(Es.map(e=>e.id)),[Es]),As=s.useMemo(()=>{const e=new Map;if(!he)return e;for(const t of he.values())e.set(t.hash,t.name);return e},[he]),Ts=s.useMemo(()=>{const e=(null==re?void 0:re.edges)??[];if(!e.length||!Z)return[];const t=[],s=(null==re?void 0:re.edgeBetweenness)??new Map;for(const a of e){if(!zs.has(a.fromHash)||!zs.has(a.toHash))continue;const e=kt(a,Hs),n=St(e,a.avgConfidence,be),i=s.get(a.key)??0,l=i>0?.5+4*i:.5+2*Math.min(1,a.certainCount/50);t.push({source:a.fromHash,target:a.toHash,color:n,width:l,key:a.key,packetCount:a.packetCount,certainCount:a.certainCount,confidence:a.avgConfidence,symmetryRatio:a.symmetryRatio,dominantDirection:a.dominantDirection,isBackbone:Hs.has(a.key),isLoopEdge:a.isLoopEdge??!1,isDirectPath:a.isDirectPathEdge,isZeroHop:a.isZeroHop??!1,isGhost:!1,forwardCount:a.forwardCount,reverseCount:a.reverseCount,floodCount:a.floodCount,directCount:a.directCount,avgRssi:a.avgRssi??null,avgSnr:a.avgSnr??null,strength:a.strength,fromName:As.get(a.fromHash)??null,toName:As.get(a.toHash)??null,edgeType:e})}const n=be?mt:ht;for(const a of xe){const e=`ghost-${a.prefix}`;if(zs.has(e))for(const s of a.commonNeighbors)zs.has(s)&&t.push({source:e,target:s,color:n.ghost,width:.4,key:`ghost-${a.prefix}-${s}`,packetCount:a.observationCount,certainCount:0,confidence:a.confidence,symmetryRatio:0,dominantDirection:"balanced",isBackbone:!1,isLoopEdge:!1,isDirectPath:!1,isZeroHop:!1,isGhost:!0,forwardCount:0,reverseCount:0,floodCount:0,directCount:0,avgRssi:null,avgSnr:null,strength:a.confidence,fromName:null,toName:As.get(s)??null,edgeType:"ghost"})}return t},[null==re?void 0:re.edges,null==re?void 0:re.edgeBetweenness,Z,zs,be,Hs,As,xe]),$s=null==(l=null==(t=null==ve?void 0:ve.config)?void 0:t.radio)?void 0:l.frequency,Is=null==(r=null==(o=null==ve?void 0:ve.config)?void 0:o.radio)?void 0:r.bandwidth,Gs=null==(d=null==(c=null==ve?void 0:ve.config)?void 0:c.radio)?void 0:d.spreading_factor,Os=null==(x=null==(u=null==ve?void 0:ve.config)?void 0:u.radio)?void 0:x.tx_power,Zs=null==(A=null==(k=null==ve?void 0:ve.config)?void 0:k.radio)?void 0:A.coding_rate;s.useEffect(()=>{Xt&&!ds.current&&(ds.current=!0,(async()=>{var e,t;try{const s=await L(24);if(s.success&&(null==(t=null==(e=s.data)?void 0:e.history)?void 0:t.length)){const e=s.data.history.map(e=>e.noise_floor_dbm).filter(e=>null!=e&&e>-200&&e<0);if(e.length>0){const t=[...e].sort((e,t)=>e-t),s=t[Math.floor(t.length/2)];cs(s)}}}catch{}})())},[Xt]);const Ws=s.useMemo(()=>{if(!re||!Xt)return null;const e={frequency:$s,bandwidth:null!=ss?1e3*ss:Is,spreading_factor:es??Gs,tx_power:Jt??Os,coding_rate:as??Zs},t={};return null!=ls&&(t.sensitivityOverrideDbm=ls),null!=rs&&(t.observedNoiseFloorDbm=rs),function(e,t,s){const n=[],a=e.nodeMetrics,i=new Set,l=t.tx_power??22;for(const o of e.edges){if(!o.isZeroHop)continue;const e=a.get(o.fromHash),l=a.get(o.toHash);n.push(Ge(o,e,l,t,s)),i.add(o.key)}for(const o of e.edges){if(i.has(o.key))continue;if(!o.traceQuality)continue;const e=Oe(o,a.get(o.fromHash),a.get(o.toHash),t,l,s);e&&(n.push(e),i.add(o.key))}return n}(re,e,t)},[re,Xt,$s,Is,Gs,Os,Zs,Jt,es,ss,as,ls,rs]),Vs=s.useMemo(()=>{if(!Ws)return null;const e=new Map;for(const t of Ws)e.set(t.edgeKey,t);return e},[Ws]),Ks=s.useMemo(()=>Ws&&0!==Ws.length?function(e){const t={"anomalous-good":0,better:0,expected:0,worse:0,"anomalous-bad":0},s={excellent:0,good:0,fair:0,marginal:0,critical:0};let n=0,a=0,i=null,l=null,o=0,r=0;for(const c of e)c.hasData&&(null!=c.marginDb&&(n+=c.marginDb,a++,(!i||c.marginDb<(i.marginDb??1/0))&&(i=c),(!l||c.marginDb>(l.marginDb??-1/0))&&(l=c)),c.marginClass&&s[c.marginClass]++,null!=c.deviationDb&&c.deviationClass?(t[c.deviationClass]++,r++):o++);return{totalEdges:e.length,analyzedEdges:r,rssiOnlyEdges:o,avgMarginDb:a>0?n/a:null,worstMargin:i,bestMargin:l,deviationCounts:t,marginCounts:s,anomalousCount:t["anomalous-good"]+t["anomalous-bad"]}}(Ws):null,[Ws]),_s=s.useMemo(()=>{if(!Xt||!Vs)return Ts;const e=be?"#303038":"#D0D0D8";return Ts.map(t=>{const s=Vs.get(t.key);return s&&s.hasData?{...t,color:Ve(s,"margin"),width:Ke(s),linkBudget:s}:{...t,color:e,width:.3}})},[Ts,Xt,Vs,be]),qs=s.useMemo(()=>0===Lt.size?Es:Es.filter(e=>!Lt.has(e.nodeClass)),[Es,Lt]),Us=s.useMemo(()=>{if(0===Lt.size)return _s;const e=new Set(qs.map(e=>e.id));return _s.filter(t=>e.has(t.source)&&e.has(t.target))},[_s,qs,Lt]),Xs=s.useRef([]);s.useEffect(()=>{Xs.current=Us},[Us]);const Ys=s.useMemo(()=>{const e=new Map;for(const t of Ts)e.set(t.source,(e.get(t.source)??0)+1),e.set(t.target,(e.get(t.target)??0)+1);return e},[Ts]),Js=s.useMemo(()=>{const e=new Map;for(const t of Es)e.set(t.id,t);return e},[Es]);s.useEffect(()=>{if(0===qs.length)return ws(null),ks(null),void Ls({});let e=!1;const t=setTimeout(async()=>{try{const t=qs.map(e=>({id:e.id,label:e.label,color:e.color,size:e.size,communityId:String(e.communityId)})),s=Us.map(e=>({source:e.source,target:e.target,color:e.color,width:e.width})),n={points:{pointIdBy:"id",pointColorBy:"color",pointColorStrategy:"direct",pointDefaultColor:be?"#9CA3AF":"#374151",pointLabelBy:"label",pointSizeBy:"size",pointSizeStrategy:"direct",pointDefaultSize:8,pointSizeScale:1,pointGreyoutOpacity:.3,pointIncludeColumns:["communityId"]},links:{linkSourceBy:"source",linkTargetsBy:["target"],linkColorBy:"color",linkColorStrategy:"direct",linkDefaultColor:be?"#6B7280":"#9CA3AF",linkWidthBy:"width",linkWidthStrategy:"direct",linkDefaultWidth:1,linkWidthScale:1,linkGreyoutOpacity:.1}},a=await i(n,t,s);if(e||!a)return;ws(a.points??null),ks(a.links??null),Ls(a.cosmographConfig??{})}catch(t){}},100);return()=>{e=!0,clearTimeout(t)}},[qs,Us,be]);const Qs=s.useCallback(e=>{e&&(js.current=e,e.start(),setTimeout(()=>{e.fitView(lt)},1500))},[]),en=s.useCallback(()=>{var e;null==(e=js.current)||e.fitView(lt)},[]),tn=s.useCallback(()=>{const e=js.current;e&&(Ce?e.pause():e.start(),ke(!Ce))},[Ce]),sn=s.useCallback(async e=>{const t=js.current,s=Js.get(e);if(s){if(t)try{const s=await t.getPointIndicesByIds([e]);s&&s.length>0&&void 0!==s[0]&&(t.zoomToPoint(s[0],400,2.5),t.selectPoint(s[0],!1,!0))}catch{}Re(null),Le({hash:e,name:s.name,prefix:s.prefix,nodeClass:s.nodeClass,packetCount:s.packetCount,edgeCount:Ys.get(e)??0,degree:s.degree,betweenness:s.betweenness,communityId:s.communityId,isLocal:s.isLocal,isHub:s.isHub,isGateway:s.isGateway,isBackbone:s.isBackbone,isMobile:s.isMobile,isZeroHop:s.isZeroHop,isGhost:s.isGhost,isInLoop:s.isInLoop,activityLevel:s.activityLevel,prefixConfidence:s.prefixConfidence,hasCollision:s.hasCollision,inDegree:s.inDegree,outDegree:s.outDegree,avgRssi:s.avgRssi,avgSnr:s.avgSnr})}},[Js,Ys]),nn=s.useRef(null);s.useEffect(()=>{nn.current=Vs},[Vs]);const an=s.useCallback(e=>{var t;if(void 0===e)return void Re(null);const s=Xs.current[e];if(!s)return;const n=null==(t=nn.current)?void 0:t.get(s.key);Re(n&&!s.linkBudget?{...s,linkBudget:n}:s),Le(null)},[]),ln=s.useCallback(async(e,t,s)=>{var n;if(void 0===e)return Le(null),_t(null),void(null==(n=js.current)||n.unselectAllPoints());Re(null);const a=js.current;if(a)try{const t=await a.getPointIdsByIndices([e]);if(!t||0===t.length)return;const s=t[0],n=Js.get(s);if(!n)return;a.selectPoint(e,!1,!0),Le({hash:s,name:n.name,prefix:n.prefix,nodeClass:n.nodeClass,packetCount:n.packetCount,edgeCount:Ys.get(s)??0,degree:n.degree,betweenness:n.betweenness,communityId:n.communityId,isLocal:n.isLocal,isHub:n.isHub,isGateway:n.isGateway,isBackbone:n.isBackbone,isMobile:n.isMobile,isZeroHop:n.isZeroHop,isGhost:n.isGhost,isInLoop:n.isInLoop,activityLevel:n.activityLevel,prefixConfidence:n.prefixConfidence,hasCollision:n.hasCollision,inDegree:n.inDegree,outDegree:n.outDegree,avgRssi:n.avgRssi,avgSnr:n.avgSnr})}catch{}},[Js,Ys]),on=s.useMemo(()=>{if(!ze||!Pe.trim())return[];const e=Pe.toLowerCase();return Es.filter(t=>{var s;return t.prefix.toLowerCase().includes(e)||(null==(s=t.name)?void 0:s.toLowerCase().includes(e))||t.id.toLowerCase().includes(e)}).slice(0,8)},[Es,Pe,ze]),rn=s.useCallback(e=>{$e(!1),Ee(""),sn(e.id)},[sn]),cn=s.useCallback(()=>{Be(e=>!e)},[]),dn=s.useCallback(e=>{Ft(t=>{const s=new Set(t);return s.has(e)?s.delete(e):s.add(e),s})},[]),un=s.useCallback(()=>{At(e=>{const t=!e,s=js.current;return s&&s.start(.5),t})},[]),mn=s.useCallback(()=>{Vt(e=>{const t=!e,s=js.current;return s?(t?s.activatePolygonalSelection():(s.deactivatePolygonalSelection(),_t(null),s.unselectAllPoints()),t):t})},[]),hn=s.useCallback(async()=>{const e=js.current;if(!e)return;await new Promise(e=>setTimeout(e,80));const t=e.getSelectedPointIndices();if(!t||0===t.length)return void _t(null);const s=await e.getPointIdsByIndices(t);if(!s||0===s.length)return void _t(null);const n=new Set(s);let a=0,i=0;for(const m of Xs.current)n.has(m.source)&&n.has(m.target)&&(a++,i+=m.confidence);let l=0;const o={},r={};for(const m of s){const e=Js.get(m);e&&(l+=e.betweenness,o[e.communityId]=(o[e.communityId]??0)+1,r[e.nodeClass]=(r[e.nodeClass]??0)+1)}const c=new Set;for(const m of s){const e=Js.get(m);e&&c.add(e.prefix.toLowerCase())}let d=0,u=0;for(const m of fe)if(m.hops.length>=2){const e=m.hops[0].toLowerCase(),t=m.hops[m.hops.length-1].toLowerCase();c.has(e)&&c.has(t)&&(d+=m.healthScore,u++)}_t({nodeCount:s.length,edgeCount:a,avgBetweenness:s.length>0?l/s.length:0,avgConfidence:a>0?i/a:0,avgPathHealth:u>0?d/u:null,communities:o,nodeClasses:r}),Le(null),Re(null)},[Js,fe]),xn=s.useCallback(()=>{var e;_t(null),null==(e=js.current)||e.unselectAllPoints()},[]),pn=s.useMemo(()=>{var e;if(!Se)return null;const t=Se.hash,s=new Set;for(const h of Us)h.source===t?s.add(h.target):h.target===t&&s.add(h.source);if(0===s.size)return{clusteringCoeff:0,avgNeighborBetweenness:0,neighborCount:0,avgEdgeConfidence:0,avgRssi:null,avgSnr:null};let n=0;for(const h of Us)s.has(h.source)&&s.has(h.target)&&n++;const a=s.size,i=a>1?2*n/(a*(a-1)):0;let l=0;for(const h of s)l+=(null==(e=Js.get(h))?void 0:e.betweenness)??0;let o=0,r=0,c=0,d=0,u=0,m=0;for(const h of Us)h.source!==t&&h.target!==t||(o+=h.confidence,r++,null!=h.avgRssi&&(c+=h.avgRssi,d++),null!=h.avgSnr&&(u+=h.avgSnr,m++));return{clusteringCoeff:Math.min(1,i),avgNeighborBetweenness:l/a,neighborCount:a,avgEdgeConfidence:r>0?o/r:0,avgRssi:d>0?c/d:null,avgSnr:m>0?u/m:null}},[Se,Us,Js]),gn=s.useMemo(()=>{if(!Se)return[];const e=Se.hash,t=[],s=new Set;for(const n of Us){let a=null;if(n.source===e?a=n.target:n.target===e&&(a=n.source),!a||s.has(a))continue;s.add(a);const i=Js.get(a);t.push({hash:a,prefix:(null==i?void 0:i.prefix)??a.slice(2,4).toUpperCase(),name:(null==i?void 0:i.name)??null,edgeConfidence:n.confidence,edgeType:n.edgeType,avgRssi:n.avgRssi,avgSnr:n.avgSnr})}return t.sort((e,t)=>t.edgeConfidence-e.edgeConfidence),t},[Se,Us,Js]),fn=s.useCallback(async()=>{const e=js.current;if(!e||!Se)return;const t=await e.getPointIndicesByIds([Se.hash]);if(!t||void 0===t[0])return;const s=t[0],n=e.getConnectedPointIndices(s)??[],a=new Set([s,...n]);for(const l of n){const t=e.getConnectedPointIndices(l)??[];for(const e of t)a.add(e)}const i=Array.from(a);e.selectPoints(i),e.fitViewByIndices(i,lt,.15)},[Se]);s.useEffect(()=>{if(!Wt)return;const e=e=>{var t,s;"Escape"===e.key&&(Vt(!1),null==(t=js.current)||t.deactivatePolygonalSelection(),_t(null),null==(s=js.current)||s.unselectAllPoints())};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[Wt]);const vn=s.useCallback((e,t)=>{re&&(function(e,t){!function(e){const t=new Blob([e.content],{type:e.mimeType}),s=URL.createObjectURL(t),n=document.createElement("a");n.href=s,n.download=e.filename,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(s)}(Fe(e,t))}(re,{format:e,dataset:t}),Ut(!1))},[re]),bn=s.useMemo(()=>{if(!re||!fe.length)return null;const e=re.edges??[];return 0===e.length?null:function(e,t,s=-137){const n=new Map;for(const l of t)n.set(l.key,l);const a=t.filter(e=>null!=e.avgRssi).length,i=[];for(const l of e){const e=et(l,n,s);e&&i.push(e)}return i.sort((e,t)=>t.riskScore-e.riskScore),{atRiskPaths:i,criticalCount:i.filter(e=>"critical"===e.riskLevel).length,highCount:i.filter(e=>"high"===e.riskLevel).length,moderateCount:i.filter(e=>"moderate"===e.riskLevel).length,edgesAnalyzed:t.length,edgesWithSignal:a}}(fe,e)},[re,fe]),yn=s.useMemo(()=>{const e=null==re?void 0:re.edges;if(!e||0===e.length||!he||he.size<3)return null;const t=Array.from(he.keys());return V(e,t)},[null==re?void 0:re.edges,he]),jn=s.useMemo(()=>{if("louvain"!==Tt)return null;const e=null==re?void 0:re.edges;return!e||0===e.length||!he||he.size<3?null:He(e,Array.from(he.keys()),Bs)},[Tt,null==re?void 0:re.edges,he,Bs]);s.useEffect(()=>{if(!re)return;const e=new Map;for(const[s,n]of re.nodeMetrics)e.set(s,n.name);const t=bs.current.update(re,e);t.totalCount>0&&(xs(bs.current.getLog()),gs(e=>e+t.totalCount))},[re]);const Nn=s.useCallback(()=>{gs(0),ms(e=>!e)},[]),wn=s.useMemo(()=>function(e,t){if(null==e)return null;const s=Math.max(0,e),n=s>0?(Math.log10(s)+4)/4.5:0,a=Math.round(Math.max(0,Math.min(100,100*n)));let i,l;a<10?(i="critical",l="Partition risk"):a<30?(i="poor",l="Weak connectivity"):a<55?(i="fair",l="Moderate resilience"):a<80?(i="good",l="Well connected"):(i="excellent",l="Highly resilient");const[o,r]=ot[i];return{score:a,grade:i,label:l,color:t?o:r}}(yn,be),[yn,be]),Cn=n.jsxs("div",{className:"absolute top-0 left-0 right-0 z-20 px-4 py-3 pointer-events-none flex items-start justify-between",children:[n.jsxs("h1",{className:"type-title text-fg-primary flex items-center gap-2 sm:gap-3 pointer-events-auto",children:[n.jsx(D,{className:"w-5 h-5 sm:w-6 sm:h-6 text-icon-page-title"}),n.jsx("span",{children:"MeshGraph"}),n.jsx(F,{color:"violet",compact:!0,children:"Analytics"})]}),wn&&n.jsx(R,{content:n.jsxs("div",{className:"max-w-xs space-y-2",children:[n.jsx("div",{className:"font-semibold text-fg-primary",children:"Mesh Resilience Score"}),n.jsx("div",{className:"text-fg-secondary",children:"Derived from the Fiedler eigenvalue (λ₂) — the second-smallest eigenvalue of the graph Laplacian. Measures how well-connected the mesh is and how resistant it is to partitioning."}),n.jsxs("div",{className:"space-y-0.5 font-mono text-[10px]",children:[n.jsxs("div",{className:"flex justify-between",children:[n.jsx("span",{className:"text-fg-muted",children:"Raw λ₂"}),n.jsx("span",{className:"text-fg-primary tabular-nums",children:(null==yn?void 0:yn.toFixed(6))??"—"})]}),n.jsxs("div",{className:"flex justify-between",children:[n.jsx("span",{className:"text-fg-muted",children:"Score"}),n.jsxs("span",{className:"tabular-nums",style:{color:wn.color},children:[wn.score,"/100"]})]}),n.jsxs("div",{className:"flex justify-between",children:[n.jsx("span",{className:"text-fg-muted",children:"Grade"}),n.jsx("span",{className:"capitalize",style:{color:wn.color},children:wn.grade})]})]}),n.jsxs("div",{className:"pt-1 border-t border-edge-subtle/30 space-y-0.5 text-[10px]",children:[n.jsx("div",{className:"text-fg-muted font-medium",children:"Grade thresholds"}),n.jsxs("div",{className:"flex justify-between",children:[n.jsx("span",{style:{color:ot.excellent[0]},children:"Excellent"}),n.jsx("span",{className:"text-fg-muted tabular-nums",children:"80-100 (λ₂ > 0.3)"})]}),n.jsxs("div",{className:"flex justify-between",children:[n.jsx("span",{style:{color:ot.good[0]},children:"Good"}),n.jsx("span",{className:"text-fg-muted tabular-nums",children:"55-79 (λ₂ 0.03-0.3)"})]}),n.jsxs("div",{className:"flex justify-between",children:[n.jsx("span",{style:{color:ot.fair[0]},children:"Fair"}),n.jsx("span",{className:"text-fg-muted tabular-nums",children:"30-54 (λ₂ 0.003-0.03)"})]}),n.jsxs("div",{className:"flex justify-between",children:[n.jsx("span",{style:{color:ot.poor[0]},children:"Poor"}),n.jsx("span",{className:"text-fg-muted tabular-nums",children:"10-29 (λ₂ 0.0001-0.003)"})]}),n.jsxs("div",{className:"flex justify-between",children:[n.jsx("span",{style:{color:ot.critical[0]},children:"Critical"}),n.jsx("span",{className:"text-fg-muted tabular-nums",children:"<10 (λ₂ ≈ 0)"})]})]}),n.jsx("div",{className:"text-[10px] text-fg-muted italic",children:"Near-zero λ₂ = one bridge away from network partition. Log-scale mapping: small λ₂ changes at low values have outsized impact."})]}),children:n.jsxs("div",{className:"pointer-events-auto surface-control radius-inner px-3 py-1.5 flex items-center gap-2 cursor-help",children:[n.jsxs("div",{className:"flex items-baseline gap-1.5",children:[n.jsx("span",{className:"text-[10px] text-fg-muted uppercase tracking-wider",children:"Resilience"}),n.jsx("span",{className:"text-lg font-semibold tabular-nums leading-none",style:{color:wn.color},children:wn.score})]}),n.jsx("div",{className:"w-12 h-1.5 rounded-full bg-subtle-fill overflow-hidden",children:n.jsx("div",{className:"h-full rounded-full transition-all duration-500",style:{width:`${wn.score}%`,backgroundColor:wn.color}})})]})})]}),kn=(e,t=!1)=>{const s="flex flex-col items-center gap-0.5 px-1.5 py-1 radius-inner transition-all duration-100 active:scale-95";return e&&t?`${s} bg-status-warning/15 text-status-warning shadow-inner`:e?`${s} bg-sys-blue/20 text-sys-blue shadow-inner`:`${s} hover:bg-white/5 hover:scale-105 text-fg-secondary`},Sn=n.jsx("div",{className:"w-px h-6 bg-border-subtle/40 mx-0.5 shrink-0"}),Ln=n.jsxs("div",{className:"absolute top-12 right-3 z-10 flex items-center gap-0.5 surface-control radius-inner px-1.5 py-1",children:[n.jsx(R,{content:"Visible nodes / edges in the graph",children:n.jsxs("span",{className:"text-[9px] text-fg-muted tabular-nums mr-1.5 leading-none cursor-help",children:[qs.length,n.jsx("br",{}),Us.length]})}),Sn,n.jsx(R,{content:Ue?"Hide labels (L)":"Show labels (L)",children:n.jsxs("button",{onClick:()=>Ye(e=>!e),className:kn(!Ue,!0),children:[Ue?n.jsx(ee,{className:"w-3.5 h-3.5"}):n.jsx(K,{className:"w-3.5 h-3.5"}),n.jsx("span",{className:"text-[7px] uppercase tracking-wider leading-none",children:"Lbl"})]})}),n.jsx(R,{content:zt?"Disable clustering":"Community clustering",children:n.jsxs("button",{onClick:un,className:kn(zt),children:[n.jsx(de,{className:"w-3.5 h-3.5"}),n.jsx("span",{className:"text-[7px] uppercase tracking-wider leading-none",children:"Grp"})]})}),n.jsx(R,{content:Wt?"Exit lasso (Esc)":"Lasso selection",children:n.jsxs("button",{onClick:mn,className:kn(Wt,!0),children:[n.jsx(ue,{className:"w-3.5 h-3.5"}),n.jsx("span",{className:"text-[7px] uppercase tracking-wider leading-none",children:"Sel"})]})}),Sn,n.jsx(R,{content:"Legend",children:n.jsxs("button",{onClick:()=>Qe(e=>!e),className:kn(Je),children:[n.jsx(ne,{className:"w-3.5 h-3.5"}),n.jsx("span",{className:"text-[7px] uppercase tracking-wider leading-none",children:"Map"})]})}),n.jsx(R,{content:"Search (/)",children:n.jsxs("button",{onClick:()=>{$e(!0),setTimeout(()=>{var e;return null==(e=ys.current)?void 0:e.focus()},50)},className:kn(ze),children:[n.jsx(ae,{className:"w-3.5 h-3.5"}),n.jsx("span",{className:"text-[7px] uppercase tracking-wider leading-none",children:"Fnd"})]})}),Sn,n.jsx(R,{content:Ce?"Pause (Space)":"Play (Space)",children:n.jsxs("button",{onClick:tn,className:kn(!Ce),children:[Ce?n.jsx(M,{className:"w-3.5 h-3.5 text-sys-green"}):n.jsx(H,{className:"w-3.5 h-3.5"}),n.jsx("span",{className:"text-[7px] uppercase tracking-wider leading-none",children:Ce?"Run":"Stop"})]})}),n.jsx(R,{content:"Fit view (F)",children:n.jsxs("button",{onClick:en,className:kn(!1),children:[n.jsx(ce,{className:"w-3.5 h-3.5"}),n.jsx("span",{className:"text-[7px] uppercase tracking-wider leading-none",children:"Fit"})]})}),Sn,n.jsx(R,{content:Xt?"Disable link budget":"Link budget overlay",children:n.jsxs("button",{onClick:()=>Yt(e=>!e),className:kn(Xt),children:[n.jsx(B,{className:"w-3.5 h-3.5"}),n.jsx("span",{className:"text-[7px] uppercase tracking-wider leading-none",children:"RF"})]})}),n.jsx(R,{content:"Anomaly log",children:n.jsxs("button",{onClick:Nn,className:`relative ${kn(us,!0)}`,children:[n.jsx(te,{className:"w-3.5 h-3.5"}),n.jsx("span",{className:"text-[7px] uppercase tracking-wider leading-none",children:"Alert"}),ps>0&&n.jsx("span",{className:"absolute -top-1 -right-0.5 w-3 h-3 rounded-full bg-status-danger text-[7px] font-bold text-white flex items-center justify-center",children:ps>9?"9+":ps})]})}),n.jsx(R,{content:"Export topology",children:n.jsxs("button",{onClick:()=>Ut(e=>!e),className:kn(qt),children:[n.jsx(Q,{className:"w-3.5 h-3.5"}),n.jsx("span",{className:"text-[7px] uppercase tracking-wider leading-none",children:"Exp"})]})}),n.jsx(R,{content:"Settings",children:n.jsxs("button",{onClick:()=>Ze(e=>!e),className:kn(Ie),children:[n.jsx(ie,{className:"w-3.5 h-3.5"}),n.jsx("span",{className:"text-[7px] uppercase tracking-wider leading-none",children:"Cfg"})]})}),Sn,n.jsx(R,{content:Me?"Exit fullscreen":"Fullscreen",children:n.jsxs("button",{onClick:cn,className:kn(Me),children:[Me?n.jsx(_,{className:"w-3.5 h-3.5"}):n.jsx(W,{className:"w-3.5 h-3.5"}),n.jsx("span",{className:"text-[7px] uppercase tracking-wider leading-none",children:"Max"})]})})]}),Dn=n.jsxs(it,{id:"settings",title:"Graph Settings",icon:n.jsx(ie,{}),open:Ie,onClose:()=>Ze(!1),defaultPosition:{x:"undefined"!=typeof window?window.innerWidth-308:600,y:60},defaultSize:{width:288,height:420},minSize:{width:260,height:200},maxSize:{width:400,height:600},headerActions:n.jsx(R,{content:"Reset to defaults",children:n.jsx("button",{onClick:Ms,className:"p-0.5 radius-badge hover-bg transition-base",children:n.jsx(me,{className:"w-2.5 h-2.5 text-fg-muted"})})}),children:[n.jsx("div",{className:"flex border-b border-edge-subtle",children:["simulation","points","links","rendering"].map(e=>n.jsx("button",{onClick:()=>qe(e),className:"flex-1 px-2 py-1.5 text-[10px] font-medium capitalize transition-colors "+(_e===e?"text-sys-blue border-b-2 border-sys-blue":"text-fg-muted hover:text-fg-secondary"),children:e},e))}),n.jsxs("div",{className:"p-3 space-y-3",children:["simulation"===_e&&n.jsxs(n.Fragment,{children:[n.jsx(Pt,{label:"Gravity",value:Ds.simulationGravity,onChange:e=>Rs("simulationGravity",e),min:0,max:1,step:.01}),n.jsx(Pt,{label:"Repulsion",value:Ds.simulationRepulsion,onChange:e=>Rs("simulationRepulsion",e),min:0,max:5,step:.1}),n.jsx(Pt,{label:"Link Spring",value:Ds.simulationLinkSpring,onChange:e=>Rs("simulationLinkSpring",e),min:0,max:2,step:.05}),n.jsx(Pt,{label:"Link Distance",value:Ds.simulationLinkDistance,onChange:e=>Rs("simulationLinkDistance",e),min:1,max:100,step:1}),n.jsx(Pt,{label:"Friction",value:Ds.simulationFriction,onChange:e=>Rs("simulationFriction",e),min:0,max:1,step:.01}),n.jsx(Pt,{label:"Center Force",value:Ds.simulationCenter,onChange:e=>Rs("simulationCenter",e),min:0,max:1,step:.01}),n.jsx(Pt,{label:"Decay",value:Ds.simulationDecay,onChange:e=>Rs("simulationDecay",e),min:100,max:2e4,step:100}),n.jsx(Pt,{label:"Repulsion Theta",value:Ds.simulationRepulsionTheta,onChange:e=>Rs("simulationRepulsionTheta",e),min:.1,max:3,step:.05}),n.jsx(Pt,{label:"Mouse Repulsion",value:Ds.simulationRepulsionFromMouse,onChange:e=>Rs("simulationRepulsionFromMouse",e),min:0,max:10,step:.5})]}),"points"===_e&&n.jsxs(n.Fragment,{children:[n.jsx(Pt,{label:"Size Scale",value:Ds.pointSizeScale,onChange:e=>Rs("pointSizeScale",e),min:.1,max:5,step:.1}),n.jsx(Pt,{label:"Opacity",value:Ds.pointOpacity,onChange:e=>Rs("pointOpacity",e),min:0,max:1,step:.05}),n.jsx(Pt,{label:"Greyout Opacity",value:Ds.pointGreyoutOpacity,onChange:e=>Rs("pointGreyoutOpacity",e),min:0,max:1,step:.05}),n.jsx(Et,{label:"Scale on Zoom",checked:Ds.scalePointsOnZoom,onChange:e=>Rs("scalePointsOnZoom",e)}),n.jsx(Et,{label:"Hover Ring",checked:Ds.renderHoveredPointRing,onChange:e=>Rs("renderHoveredPointRing",e)})]}),"links"===_e&&n.jsxs(n.Fragment,{children:[n.jsx(Et,{label:"Show Links",checked:Ds.renderLinks,onChange:e=>Rs("renderLinks",e)}),n.jsx(Et,{label:"Curved Links",checked:Ds.curvedLinks,onChange:e=>Rs("curvedLinks",e)}),n.jsx(Et,{label:"Show Arrows",checked:Ds.linkDefaultArrows,onChange:e=>Rs("linkDefaultArrows",e)}),n.jsx(Pt,{label:"Width Scale",value:Ds.linkWidthScale,onChange:e=>Rs("linkWidthScale",e),min:.1,max:5,step:.1}),n.jsx(Pt,{label:"Opacity",value:Ds.linkOpacity,onChange:e=>Rs("linkOpacity",e),min:0,max:1,step:.05}),n.jsx(Pt,{label:"Greyout Opacity",value:Ds.linkGreyoutOpacity,onChange:e=>Rs("linkGreyoutOpacity",e),min:0,max:1,step:.05}),Ds.curvedLinks&&n.jsx(Pt,{label:"Curve Weight",value:Ds.curvedLinkWeight,onChange:e=>Rs("curvedLinkWeight",e),min:0,max:1,step:.05}),Ds.linkDefaultArrows&&n.jsx(Pt,{label:"Arrow Size",value:Ds.linkArrowsSizeScale,onChange:e=>Rs("linkArrowsSizeScale",e),min:.1,max:3,step:.1}),n.jsx(Et,{label:"Scale on Zoom",checked:Ds.scaleLinksOnZoom,onChange:e=>Rs("scaleLinksOnZoom",e)})]}),"rendering"===_e&&n.jsxs(n.Fragment,{children:[n.jsx(Pt,{label:"Space Size",value:Ds.spaceSize,onChange:e=>Rs("spaceSize",e),min:1024,max:16384,step:512}),n.jsx("div",{className:"pt-2 border-t border-edge-subtle/50",children:n.jsx("p",{className:"text-[9px] text-fg-muted",children:"Space size defines the simulation boundary. Larger values allow more spread."})})]})]})]}),Fn=n.jsxs(it,{id:"export",title:"Export Topology",icon:n.jsx(Q,{}),open:qt,onClose:()=>Ut(!1),defaultPosition:{x:"undefined"!=typeof window?window.innerWidth-280:600,y:100},defaultSize:{width:256,height:320},minSize:{width:220,height:150},autoHeight:!0,children:[n.jsx("div",{className:"py-1",children:[{label:"Full Topology (JSON)",format:"json",dataset:"full",desc:"All data: nodes, edges, paths, TX delay"},{label:"Gephi Graph (GEXF)",format:"gexf",dataset:"full",desc:"Import into Gephi for advanced analysis"},{label:"Nodes (CSV)",format:"csv",dataset:"nodes",desc:"Node metrics: centrality, class, signal"},{label:"Edges (CSV)",format:"csv",dataset:"edges",desc:"Edge metrics: confidence, symmetry, type"},{label:"Path Health (CSV)",format:"csv",dataset:"pathHealth",desc:"Route health scores and trends"},{label:"TX Delay (CSV)",format:"csv",dataset:"txDelay",desc:"TX delay recommendations per node"}].map(({label:e,format:t,dataset:s,desc:a})=>n.jsxs("button",{onClick:()=>vn(t,s),className:"w-full flex flex-col px-3 py-2 text-left hover-bg transition-base",children:[n.jsx("span",{className:"text-[11px] font-medium text-fg-primary",children:e}),n.jsx("span",{className:"text-[9px] text-fg-muted",children:a})]},`${t}-${s}`))}),n.jsx("div",{className:"px-3 py-1.5 border-t border-edge-subtle",children:n.jsxs("span",{className:"text-[9px] text-fg-muted",children:[(null==(T=null==re?void 0:re.nodeMetrics)?void 0:T.size)??0," nodes · ",(null==($=null==re?void 0:re.validatedEdges)?void 0:$.length)??0," edges"]})})]}),Rn={info:{dot:"bg-sys-blue",text:"text-fg-secondary"},warning:{dot:"bg-status-warning",text:"text-status-warning"},critical:{dot:"bg-status-danger",text:"text-status-danger"}},Mn={"edge-appeared":"Link Discovered","edge-disappeared":"Link Lost","ghost-appeared":"Ghost Discovered","ghost-disappeared":"Ghost Resolved","betweenness-shift":"Traffic Rerouting","community-change":"Community Change","class-change":"Role Change","node-appeared":"Node Appeared","node-disappeared":"Node Dropped"},Hn=(e,t,s)=>null==t||""===t?null:n.jsxs("div",{className:"flex justify-between gap-2",children:[n.jsx("span",{className:"text-fg-muted",children:e}),n.jsx("span",{className:`tabular-nums text-right ${s??"text-fg-secondary"}`,children:t})]}),Bn=e=>{const t=[];return e.isZeroHop&&t.push({label:"Zero-Hop",color:"text-status-warning"}),e.isDirectPath&&t.push({label:"Direct",color:"text-sys-blue"}),e.isBackbone&&t.push({label:"Backbone",color:"text-fg-primary"}),e.isLoop&&t.push({label:"Loop",color:"text-sys-indigo"}),0===t.length?null:n.jsx("div",{className:"flex flex-wrap gap-1 mt-1",children:t.map(e=>n.jsx("span",{className:`text-[8px] font-medium uppercase tracking-wider px-1 py-px radius-badge bg-subtle-fill ${e.color}`,children:e.label},e.label))})},Pn=e=>n.jsxs("div",{className:"text-[9px] space-y-0.5",children:[n.jsxs("div",{className:"flex items-center gap-1",children:[n.jsx("span",{className:"capitalize font-medium text-fg-secondary",children:e.nodeClass}),e.isZeroHop&&n.jsx("span",{className:"text-[8px] font-medium uppercase tracking-wider px-1 py-px radius-badge bg-subtle-fill text-status-warning",children:"Neighbor"})]}),Hn("Degree",e.degree),e.betweenness>.01&&Hn("Betweenness",e.betweenness.toFixed(3)),Hn("Packets",e.packetCount),Hn("Community",`#${e.communityId}`),Hn("Activity",e.activityLevel),null!=e.avgRssi&&Hn("RSSI",`${e.avgRssi.toFixed(0)} dBm`),null!=e.avgSnr&&Hn("SNR",`${e.avgSnr.toFixed(1)} dB`)]}),En=e=>n.jsxs("div",{className:"text-[9px] space-y-0.5",children:[null!=e.previousValue&&null!=e.currentValue&&n.jsxs("div",{className:"flex items-center gap-1.5",children:[n.jsx("span",{className:"text-fg-muted font-mono",children:"number"==typeof e.previousValue?e.previousValue.toFixed(3):e.previousValue}),n.jsx("span",{className:"text-fg-muted/40",children:"→"}),n.jsx("span",{className:"text-fg-secondary font-mono",children:"number"==typeof e.currentValue?e.currentValue.toFixed(3):e.currentValue}),"number"==typeof e.previousValue&&"number"==typeof e.currentValue&&n.jsxs("span",{className:e.currentValue>e.previousValue?"text-sys-green":"text-signal-poor",children:["(",e.currentValue>e.previousValue?"+":"",(e.currentValue-e.previousValue).toFixed(3),")"]})]}),e.nodeDetail&&n.jsxs(n.Fragment,{children:[Hn("Class",e.nodeDetail.nodeClass),Hn("Degree",e.nodeDetail.degree),e.nodeDetail.betweenness>.01&&Hn("Betweenness",e.nodeDetail.betweenness.toFixed(3))]})]}),zn=s.useCallback(e=>{vs(t=>t===e?null:e)},[]),An=n.jsxs(it,{id:"anomaly",title:"Anomaly Log",icon:n.jsx(te,{}),open:us,onClose:()=>ms(!1),defaultPosition:{x:"undefined"!=typeof window?window.innerWidth-328:600,y:100},defaultSize:{width:308,height:400},minSize:{width:260,height:180},maxSize:{width:440,height:700},headerActions:hs.length>0?n.jsx("button",{onClick:()=>{bs.current.clear(),xs([]),vs(null)},className:"p-0.5 radius-badge hover-bg transition-base",title:"Clear all",children:n.jsx(me,{className:"w-2.5 h-2.5 text-fg-muted"})}):void 0,children:[0===hs.length?n.jsxs("div",{className:"px-3 py-6 text-center",children:[n.jsx(te,{className:"w-5 h-5 text-fg-muted mx-auto mb-1.5"}),n.jsx("p",{className:"text-[11px] text-fg-muted",children:"No anomalies detected yet"}),n.jsx("p",{className:"text-[9px] text-fg-muted/60 mt-0.5",children:"Changes appear after topology recomputes"})]}):n.jsx("div",{className:"overflow-y-auto",children:hs.slice(0,50).map(e=>{const t=Rn[e.severity],s=P(e.detectedAt/1e3),a=fs===e.id,i=!(!e.edgeDetail&&!e.nodeDetail&&null==e.previousValue);return n.jsxs("div",{className:`border-b border-edge-subtle/50 last:border-0 transition-colors ${i?"cursor-pointer hover-bg":""} ${a?"bg-subtle-fill/50":""}`,onClick:i?()=>zn(e.id):void 0,children:[n.jsxs("div",{className:"flex items-start gap-2 px-3 py-1.5",children:[n.jsx("span",{className:`w-1.5 h-1.5 rounded-full shrink-0 mt-1.5 ${t.dot}`}),n.jsxs("div",{className:"flex-1 min-w-0",children:[n.jsx("p",{className:`text-[10px] leading-tight ${t.text}`,children:e.description}),n.jsxs("p",{className:"text-[9px] text-fg-muted/60 mt-0.5",children:[Mn[e.category]??e.category," · ",s]})]}),i&&n.jsx(E,{className:"w-3 h-3 text-fg-muted/40 shrink-0 mt-0.5 transition-transform duration-150 "+(a?"rotate-180":"")})]}),a&&n.jsx("div",{className:"px-3 pb-2 pl-6",children:n.jsxs("div",{className:"border-l-2 border-edge-subtle/60 pl-2 py-0.5",children:[e.edgeDetail&&(l=e.edgeDetail,o=e.category,n.jsxs("div",{className:"text-[9px] space-y-0.5",children:[(l.fromClass||l.toClass)&&n.jsxs("div",{className:"flex items-center gap-1 text-fg-muted",children:[n.jsx("span",{className:"capitalize",children:l.fromClass??"?"}),n.jsx("span",{className:"text-fg-muted/40",children:"↔"}),n.jsx("span",{className:"capitalize",children:l.toClass??"?"})]}),"edge-appeared"===o&&l.packetCount>0&&n.jsxs(n.Fragment,{children:[Hn("Packets",l.packetCount),Hn("Confidence",`${(100*l.confidence).toFixed(0)}%`,l.confidence>=.8?"text-sys-green":l.confidence>=.5?"text-sys-indigo":"text-signal-poor"),Hn("Symmetry",`${(100*l.symmetryRatio).toFixed(0)}%`)]}),l.isZeroHop&&null!=l.avgRssi&&Hn("RSSI",`${l.avgRssi.toFixed(0)} dBm`),l.isZeroHop&&null!=l.avgSnr&&Hn("SNR",`${l.avgSnr.toFixed(1)} dB`),null!=l.fromBetweenness&&l.fromBetweenness>.01&&Hn(`${l.fromName??"A"} centrality`,l.fromBetweenness.toFixed(3)),null!=l.toBetweenness&&l.toBetweenness>.01&&Hn(`${l.toName??"B"} centrality`,l.toBetweenness.toFixed(3)),Bn(l)]})),e.nodeDetail&&!e.edgeDetail&&("node-appeared"===e.category||"node-disappeared"===e.category)&&Pn(e.nodeDetail),("betweenness-shift"===e.category||"community-change"===e.category||"class-change"===e.category)&&En(e)]})})]},e.id);var l,o})}),hs.length>0&&n.jsx("div",{className:"px-3 py-1.5 border-t border-edge-subtle",children:n.jsxs("span",{className:"text-[9px] text-fg-muted",children:[hs.length," total · showing ",Math.min(hs.length,50)]})})]}),Tn=s.useMemo(()=>{const e={};for(const t of Ts)e[t.edgeType]=(e[t.edgeType]??0)+1;return e},[Ts]),$n=n.jsxs(it,{id:"legend",title:"Legend",icon:n.jsx(ne,{}),open:Je,onClose:()=>Qe(!1),defaultPosition:{x:12,y:60},defaultSize:{width:224,height:400},minSize:{width:200,height:150},maxSize:{width:360,height:700},autoHeight:!0,children:[n.jsxs("div",{className:"border-b border-edge-subtle",children:[n.jsxs("button",{onClick:()=>st(e=>!e),className:"w-full flex items-center gap-1.5 px-3 py-1.5 text-[10px] font-medium text-fg-secondary hover-bg transition-base",children:[tt?n.jsx(E,{className:"w-3 h-3"}):n.jsx(le,{className:"w-3 h-3"}),"Nodes",n.jsx("span",{className:"text-fg-muted ml-auto tabular-nums",children:qs.length})]}),tt&&n.jsx("div",{className:"px-2 pb-2 space-y-0.5",children:[["local","Local"],["hub","Hub"],["gateway","Gateway"],["backbone","Backbone"],["neighbor","Neighbor"],["mobile","Mobile"],["ghost","Ghost"],["standard","Standard"]].map(([e,t])=>{const s=pe[e]??0;if(0===s&&"local"!==e)return null;const a=Lt.has(e);return n.jsx(R,{content:Nt[e],children:n.jsxs("button",{onClick:()=>dn(e),className:"w-full flex items-center gap-2 px-2 py-1 radius-badge transition-base text-left "+(a?"opacity-40":"hover-bg"),children:[n.jsx("span",{className:"w-2.5 h-2.5 rounded-full shrink-0",style:{backgroundColor:ye[e]}}),n.jsx("span",{className:"text-[10px] text-fg-secondary flex-1",children:t}),n.jsx("span",{className:"text-[10px] text-fg-muted tabular-nums",children:s})]})},e)})})]}),n.jsxs("div",{className:"border-b border-edge-subtle",children:[n.jsxs("button",{onClick:()=>at(e=>!e),className:"w-full flex items-center gap-1.5 px-3 py-1.5 text-[10px] font-medium text-fg-secondary hover-bg transition-base",children:[nt?n.jsx(E,{className:"w-3 h-3"}):n.jsx(le,{className:"w-3 h-3"}),"Edges",n.jsx("span",{className:"text-fg-muted ml-auto tabular-nums",children:Us.length})]}),nt&&n.jsx("div",{className:"px-2 pb-2 space-y-0.5",children:[{type:"zero-hop",label:"Zero-Hop RF"},{type:"direct-path",label:"Direct Path"},{type:"loop",label:"Loop"},{type:"backbone",label:"Backbone"},{type:"standard",label:"Standard"},{type:"ghost",label:"Ghost"}].map(({type:e,label:t})=>{const s=Tn[e]??0;if(0===s)return null;const a=St(e,.8,be);return n.jsx(R,{content:Dt[e],children:n.jsxs("div",{className:"flex items-center gap-2 px-2 py-1 cursor-help",children:[n.jsx("span",{className:"w-4 h-0.5 shrink-0 rounded-full",style:{backgroundColor:a}}),n.jsx("span",{className:"text-[10px] text-fg-secondary flex-1",children:t}),n.jsx("span",{className:"text-[10px] text-fg-muted tabular-nums",children:s})]})},e)})})]}),Xt&&Ks&&n.jsxs("div",{className:"border-b border-edge-subtle",children:[n.jsxs("div",{className:"px-3 py-1.5 text-[10px] font-medium text-sys-green flex items-center gap-1.5",children:[n.jsx(B,{className:"w-3 h-3"}),"Link Budget",n.jsxs("span",{className:"text-fg-muted ml-auto tabular-nums",children:[Ks.analyzedEdges+Ks.rssiOnlyEdges,"/",Ks.totalEdges]})]}),n.jsxs("div",{className:"px-3 pb-2 space-y-0.5",children:[(()=>{const e=$s&&$s>1e5?$s/1e6:$s||915,t=es??Gs??12,s=ss??(Is&&Is>1e3?Is/1e3:Is||125),a=as??Zs??5,i=Jt??Os??22,l=Ae(t,s,a),o=ls??l,r=Te(1e3*s),c=rs??r,d=(null==Ws?void 0:Ws.filter(e=>e.isTraceEstimated).length)??0,u=(null==Ws?void 0:Ws.filter(e=>e.isZeroHop).length)??0,m=null!=Jt||null!=es||null!=ss||null!=as||null!=ls,h="w-10 px-1 py-0 text-[10px] text-right tabular-nums bg-subtle-fill border border-edge-subtle rounded text-fg-secondary focus:outline-none focus:border-sys-blue";return n.jsxs("div",{className:"pb-1 mb-1 border-b border-edge-subtle space-y-0.5",children:[n.jsxs("div",{className:"flex items-center justify-between text-[10px]",children:[n.jsx("span",{className:"text-fg-muted",children:"Frequency"}),n.jsxs("span",{className:"text-fg-secondary tabular-nums",children:[e.toFixed(3)," MHz"]})]}),n.jsxs("div",{className:"flex items-center justify-between text-[10px] gap-1",children:[n.jsx("span",{className:"text-fg-muted",children:"SF"}),n.jsxs("div",{className:"flex items-center gap-1",children:[n.jsx("select",{value:t,onChange:e=>{const t=parseInt(e.target.value,10);ts(t===(Gs??12)?null:t)},className:h+" w-12 appearance-none",children:[7,8,9,10,11,12].map(e=>n.jsxs("option",{value:e,children:["SF",e]},e))}),null!=es&&n.jsx("button",{onClick:()=>ts(null),className:"text-[8px] text-sys-blue hover:underline",title:"Reset",children:"↺"})]})]}),n.jsxs("div",{className:"flex items-center justify-between text-[10px] gap-1",children:[n.jsx("span",{className:"text-fg-muted",children:"BW"}),n.jsxs("div",{className:"flex items-center gap-1",children:[n.jsx("select",{value:s,onChange:e=>{const t=parseFloat(e.target.value);ns(t===(Is&&Is>1e3?Is/1e3:Is||125)?null:t)},className:h+" w-14 appearance-none",children:[62.5,125,250,500].map(e=>n.jsxs("option",{value:e,children:[e," kHz"]},e))}),null!=ss&&n.jsx("button",{onClick:()=>ns(null),className:"text-[8px] text-sys-blue hover:underline",title:"Reset",children:"↺"})]})]}),n.jsxs("div",{className:"flex items-center justify-between text-[10px] gap-1",children:[n.jsx("span",{className:"text-fg-muted",children:"CR"}),n.jsxs("div",{className:"flex items-center gap-1",children:[n.jsx("select",{value:a,onChange:e=>{const t=parseInt(e.target.value,10);is(t===(Zs??5)?null:t)},className:h+" w-12 appearance-none",children:[5,6,7,8].map(e=>n.jsxs("option",{value:e,children:["4/",e]},e))}),null!=as&&n.jsx("button",{onClick:()=>is(null),className:"text-[8px] text-sys-blue hover:underline",title:"Reset",children:"↺"})]})]}),n.jsxs("div",{className:"flex items-center justify-between text-[10px] gap-1",children:[n.jsx("span",{className:"text-fg-muted",children:"TX Power"}),n.jsxs("div",{className:"flex items-center gap-1",children:[n.jsx("input",{type:"number",min:1,max:36,step:1,value:i,onChange:e=>{const t=parseInt(e.target.value,10);isNaN(t)||Qt(t)},onBlur:e=>{const t=parseInt(e.target.value,10);isNaN(t)?Qt(null):Qt(Math.max(1,Math.min(36,t)))},className:h}),n.jsx("span",{className:"text-fg-muted",children:"dBm"}),null!=Jt&&n.jsx("button",{onClick:()=>Qt(null),className:"text-[8px] text-sys-blue hover:underline",title:"Reset",children:"↺"})]})]}),n.jsxs("div",{className:"flex items-center justify-between text-[10px] gap-1",children:[n.jsx("span",{className:"text-fg-muted",children:"Sensitivity"}),n.jsxs("div",{className:"flex items-center gap-1",children:[n.jsx("input",{type:"number",min:-150,max:-80,step:.5,value:Math.round(10*o)/10,onChange:e=>{const t=parseFloat(e.target.value);isNaN(t)||os(t)},onBlur:e=>{const t=parseFloat(e.target.value);isNaN(t)?os(null):os(Math.max(-150,Math.min(-80,t)))},className:h+" w-12"}),n.jsx("span",{className:"text-fg-muted",children:"dBm"}),null!=ls&&n.jsx("button",{onClick:()=>os(null),className:"text-[8px] text-sys-blue hover:underline",title:"Reset",children:"↺"})]})]}),d>0&&n.jsxs("div",{className:"flex items-center justify-between text-[10px]",children:[n.jsx("span",{className:"text-fg-muted",children:"Noise Floor"}),n.jsxs("span",{className:"text-fg-secondary tabular-nums "+(null!=rs?"":"italic text-fg-muted"),children:[c.toFixed(1)," dBm",null!=rs?"":" (est.)"]})]}),m&&n.jsx("button",{onClick:()=>{Qt(null),ts(null),ns(null),is(null),os(null)},className:"w-full text-[9px] text-sys-blue hover:underline text-center pt-0.5",children:"Reset all to radio config"}),(u>0||d>0)&&n.jsxs("div",{className:"flex items-center justify-between text-[10px] pt-0.5",children:[n.jsx("span",{className:"text-fg-muted",children:"Sources"}),n.jsxs("span",{className:"text-fg-secondary tabular-nums",children:[u>0&&n.jsxs("span",{children:[u," direct"]}),u>0&&d>0&&n.jsx("span",{className:"text-fg-muted",children:" · "}),d>0&&n.jsxs("span",{className:"text-sys-indigo",children:[d," trace"]})]})]})]})})(),null!=Ks.avgMarginDb&&n.jsxs("div",{className:"flex items-center justify-between text-[10px]",children:[n.jsx("span",{className:"text-fg-muted",children:"Avg Margin"}),n.jsxs("span",{className:"text-fg-secondary tabular-nums",children:[Ks.avgMarginDb>0?"+":"",Ks.avgMarginDb.toFixed(1)," dB"]})]}),["excellent","good","fair","marginal","critical"].map(e=>{const t=Ks.marginCounts[e];return 0===t?null:n.jsxs("div",{className:"flex items-center gap-2 px-1 py-0.5",children:[n.jsx("span",{className:"w-3 h-0.5 shrink-0 rounded-full",style:{backgroundColor:We[e]}}),n.jsx("span",{className:"text-[10px] text-fg-secondary flex-1 capitalize",children:e}),n.jsx("span",{className:"text-[10px] text-fg-muted tabular-nums",children:t})]},e)}),Ks.anomalousCount>0&&n.jsxs("div",{className:"flex items-center justify-between text-[10px] pt-0.5",children:[n.jsx("span",{className:"text-status-warning",children:"Anomalous"}),n.jsx("span",{className:"text-status-warning tabular-nums",children:Ks.anomalousCount})]})]})]}),bn&&bn.atRiskPaths.length>0&&n.jsxs("div",{className:"border-b border-edge-subtle",children:[n.jsxs("div",{className:"flex items-center",children:[n.jsxs("button",{onClick:()=>wt(e=>!e),className:"flex-1 flex items-center gap-1.5 px-3 py-1.5 text-[10px] font-medium text-status-warning hover-bg transition-base",children:[ut?n.jsx(E,{className:"w-3 h-3"}):n.jsx(le,{className:"w-3 h-3"}),"At-Risk Paths",n.jsxs("span",{className:"text-fg-muted ml-auto tabular-nums",children:[bn.criticalCount>0&&n.jsxs("span",{className:"text-status-danger",children:[bn.criticalCount,"c"]}),bn.criticalCount>0&&bn.highCount>0&&" ",bn.highCount>0&&n.jsxs("span",{className:"text-status-warning",children:[bn.highCount,"h"]}),(bn.criticalCount>0||bn.highCount>0)&&bn.moderateCount>0&&" ",bn.moderateCount>0&&n.jsxs("span",{className:"text-fg-muted",children:[bn.moderateCount,"m"]})]})]}),n.jsx(R,{content:n.jsxs("div",{className:"max-w-xs space-y-1.5",children:[n.jsx("div",{className:"font-semibold text-fg-primary",children:"Predictive Path Failure"}),n.jsx("div",{className:"text-fg-secondary text-[11px]",children:"Identifies paths at risk of failure by combining four weighted factors. Paths below the moderate threshold (35%) are not shown."}),n.jsxs("div",{className:"pt-1 border-t border-edge-subtle/30 space-y-0.5 text-[10px]",children:[n.jsx("div",{className:"text-fg-muted font-medium",children:"Factor weights"}),n.jsxs("div",{className:"flex justify-between",children:[n.jsx("span",{className:"text-fg-secondary",children:"Declining usage"}),n.jsx("span",{className:"text-fg-muted tabular-nums",children:"35%"})]}),n.jsxs("div",{className:"flex justify-between",children:[n.jsx("span",{className:"text-fg-secondary",children:"Weak link certainty"}),n.jsx("span",{className:"text-fg-muted tabular-nums",children:"30%"})]}),n.jsxs("div",{className:"flex justify-between",children:[n.jsx("span",{className:"text-fg-secondary",children:"No alternate paths"}),n.jsx("span",{className:"text-fg-muted tabular-nums",children:"20%"})]}),n.jsxs("div",{className:"flex justify-between",children:[n.jsx("span",{className:"text-fg-secondary",children:"Low signal margin"}),n.jsx("span",{className:"text-fg-muted tabular-nums",children:"15%"})]})]}),n.jsxs("div",{className:"pt-1 border-t border-edge-subtle/30 space-y-0.5 text-[10px]",children:[n.jsx("div",{className:"text-fg-muted font-medium",children:"Risk thresholds"}),n.jsxs("div",{className:"flex justify-between",children:[n.jsx("span",{className:"text-status-danger",children:"Critical"}),n.jsx("span",{className:"text-fg-muted tabular-nums",children:"≥75% — failure likely imminent"})]}),n.jsxs("div",{className:"flex justify-between",children:[n.jsx("span",{className:"text-status-warning",children:"High"}),n.jsx("span",{className:"text-fg-muted tabular-nums",children:"55-74% — significant risk"})]}),n.jsxs("div",{className:"flex justify-between",children:[n.jsx("span",{className:"text-fg-muted",children:"Moderate"}),n.jsx("span",{className:"text-fg-muted tabular-nums",children:"35-54% — worth monitoring"})]})]}),n.jsxs("div",{className:"pt-1 border-t border-edge-subtle/30 text-[10px] text-fg-muted font-mono space-y-0.5",children:[n.jsxs("div",{className:"flex justify-between",children:[n.jsx("span",{children:"Edges analyzed"}),n.jsx("span",{className:"tabular-nums",children:bn.edgesAnalyzed})]}),n.jsxs("div",{className:"flex justify-between",children:[n.jsx("span",{children:"With signal data"}),n.jsx("span",{className:"tabular-nums",children:bn.edgesWithSignal})]})]})]}),children:n.jsx("span",{className:"px-2 py-1.5 text-fg-muted cursor-help",children:n.jsx(te,{className:"w-3 h-3"})})})]}),ut&&n.jsx("div",{className:"px-2 pb-2 space-y-1",children:bn.atRiskPaths.slice(0,8).map(e=>{const t="critical"===e.riskLevel?"#EF4444":"high"===e.riskLevel?"#F97316":"#FBBF24",s="imminent"===e.urgency?"IMM":"near-term"===e.urgency?"NEAR":"WATCH";return n.jsx(R,{content:n.jsxs("div",{className:"max-w-xs space-y-1.5",children:[n.jsx("div",{className:"font-semibold text-fg-primary font-mono text-[11px]",children:e.hops.join(" → ")}),n.jsxs("div",{className:"space-y-0.5 text-[10px]",children:[n.jsxs("div",{className:"flex justify-between",children:[n.jsx("span",{className:"text-fg-muted",children:"Risk score"}),n.jsxs("span",{className:"font-semibold tabular-nums",style:{color:t},children:[(100*e.riskScore).toFixed(1),"%"]})]}),n.jsxs("div",{className:"flex justify-between",children:[n.jsx("span",{className:"text-fg-muted",children:"Health score"}),n.jsxs("span",{className:"text-fg-primary tabular-nums",children:[(100*e.healthScore).toFixed(0),"%"]})]}),n.jsxs("div",{className:"flex justify-between",children:[n.jsx("span",{className:"text-fg-muted",children:"Obs. trend"}),n.jsxs("span",{className:"tabular-nums "+(e.observationTrend<0?"text-status-danger":"text-fg-secondary"),children:[e.observationTrend>0?"+":"",e.observationTrend.toFixed(3)]})]}),n.jsxs("div",{className:"flex justify-between",children:[n.jsx("span",{className:"text-fg-muted",children:"Alt. paths"}),n.jsx("span",{className:"tabular-nums "+(0===e.alternatePathsCount?"text-status-danger":"text-fg-secondary"),children:e.alternatePathsCount})]}),n.jsxs("div",{className:"flex justify-between",children:[n.jsx("span",{className:"text-fg-muted",children:"Urgency"}),n.jsx("span",{className:"capitalize",style:{color:t},children:e.urgency})]})]}),e.factors.length>0&&n.jsxs("div",{className:"pt-1 border-t border-edge-subtle/30 space-y-0.5 text-[10px]",children:[n.jsx("div",{className:"text-fg-muted font-medium",children:"Contributing factors"}),e.factors.map((e,t)=>n.jsxs("div",{className:"space-y-0.5",children:[n.jsxs("div",{className:"flex justify-between",children:[n.jsx("span",{className:"text-fg-secondary",children:e.name}),n.jsxs("span",{className:"text-fg-muted tabular-nums",children:[(e.score*e.weight*100).toFixed(1),"% (",(100*e.weight).toFixed(0),"w × ",(100*e.score).toFixed(0),"s)"]})]}),n.jsx("div",{className:"text-fg-muted pl-1",children:e.description})]},t))]})]}),children:n.jsxs("div",{className:"px-2 py-1 radius-badge bg-subtle-fill/30 cursor-help",children:[n.jsxs("div",{className:"flex items-center gap-1.5",children:[n.jsx("span",{className:"w-1.5 h-1.5 rounded-full shrink-0",style:{backgroundColor:t}}),n.jsx("span",{className:"text-[10px] text-fg-secondary font-mono truncate flex-1",children:e.hops.join(" → ")}),n.jsx("span",{className:"text-[8px] uppercase tracking-wide px-1 py-px radius-badge",style:{backgroundColor:`${t}20`,color:t},children:s}),n.jsxs("span",{className:"text-[10px] tabular-nums font-semibold",style:{color:t},children:[(100*e.riskScore).toFixed(0),"%"]})]}),n.jsx("div",{className:"flex flex-wrap gap-1 mt-0.5 pl-3",children:e.factors.map((t,s)=>n.jsxs("span",{className:"text-[8px] text-fg-muted",children:[t.name," (",(t.score*t.weight*100).toFixed(0),"%)",s<e.factors.length-1?" ·":""]},s))})]})},e.pathKey)})})]}),n.jsxs("div",{className:"px-3 py-2 space-y-1",children:[n.jsxs("div",{className:"flex items-center justify-between text-[10px]",children:[n.jsx(R,{content:"Number of detected community clusters via graph partitioning",children:n.jsx("span",{className:"text-fg-muted cursor-help",children:"Communities"})}),n.jsx("span",{className:"text-fg-secondary tabular-nums",children:"louvain"===Tt&&jn?jn.numCommunities:ge})]}),n.jsxs("div",{className:"flex items-center justify-between text-[10px]",children:[n.jsx(R,{content:"Spectral uses eigenvector decomposition; Louvain maximizes modularity iteratively. Click to switch.",children:n.jsx("span",{className:"text-fg-muted cursor-help",children:"Algorithm"})}),n.jsx("button",{onClick:()=>$t(e=>"spectral"===e?"louvain":"spectral"),className:"text-sys-blue hover:underline cursor-pointer",children:"spectral"===Tt?"Spectral":"Louvain"})]}),"louvain"===Tt&&jn&&n.jsxs("div",{className:"flex items-center justify-between text-[10px]",children:[n.jsx(R,{content:"Louvain modularity score — quality of community partition (higher = better defined communities)",children:n.jsx("span",{className:"text-fg-muted cursor-help",children:"Modularity Q"})}),n.jsx("span",{className:"text-fg-secondary tabular-nums",children:jn.modularity.toFixed(4)})]}),"louvain"===Tt&&n.jsxs("div",{className:"mt-1.5 pt-1.5 border-t border-edge-subtle space-y-1.5",children:[n.jsx(Pt,{label:"Resolution γ",value:It,onChange:Gt,min:.01,max:5,step:.01}),n.jsx(Pt,{label:"K-weight",value:Ot,onChange:Zt,min:.01,max:5,step:.01}),(1!==It||1!==Ot)&&n.jsx("button",{onClick:()=>{Gt(1),Zt(1)},className:"w-full text-[10px] text-sys-blue hover:underline text-center",children:"Reset defaults"})]}),n.jsxs("div",{className:"flex items-center justify-between text-[10px]",children:[n.jsx(R,{content:"Redundant path cycles in the topology — indicates alternate routing options",children:n.jsx("span",{className:"text-fg-muted cursor-help",children:"Loops"})}),n.jsx("span",{className:"text-fg-secondary tabular-nums",children:(null==(I=null==re?void 0:re.loops)?void 0:I.length)??0})]}),n.jsxs("div",{className:"flex items-center justify-between text-[10px]",children:[n.jsx(R,{content:"High-betweenness edges that carry disproportionate traffic flow",children:n.jsx("span",{className:"text-fg-muted cursor-help",children:"Backbone"})}),n.jsx("span",{className:"text-fg-secondary tabular-nums",children:(null==(G=null==re?void 0:re.backboneEdges)?void 0:G.length)??0})]}),n.jsxs("div",{className:"flex items-center justify-between text-[10px]",children:[n.jsx(R,{content:"Unresolved prefix nodes inferred by Viterbi HMM from repeated path patterns",children:n.jsx("span",{className:"text-fg-muted cursor-help",children:"Ghosts"})}),n.jsx("span",{className:"text-fg-secondary tabular-nums",children:xe.length})]}),n.jsxs("div",{className:"flex items-center justify-between text-[10px]",children:[n.jsx(R,{content:"Community-aware node coloring — groups nodes by cluster assignment",children:n.jsx("span",{className:"text-fg-muted cursor-help",children:"Clustering"})}),n.jsx("span",{className:"tabular-nums "+(zt?"text-sys-blue":"text-fg-muted"),children:zt?"On":"Off"})]}),null!=yn&&n.jsxs("div",{className:"flex items-center justify-between text-[10px]",children:[n.jsx(R,{content:"Algebraic connectivity — 2nd-smallest eigenvalue of the graph Laplacian. Near-zero = one bridge from network partition.",children:n.jsx("span",{className:"text-fg-muted cursor-help",children:"Fiedler λ₂"})}),n.jsx("span",{className:"tabular-nums "+(yn<.01?"text-status-warning":"text-fg-secondary"),children:yn.toFixed(4)})]}),Lt.size>0&&n.jsxs("button",{onClick:()=>Ft(new Set),className:"w-full mt-1 text-[10px] text-sys-blue hover:underline text-center",children:["Clear filters (",Lt.size,")"]})]})]}),In=n.jsx(m,{children:ze&&n.jsx(h.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},transition:{duration:.15},className:"absolute top-4 left-1/2 -translate-x-1/2 z-30 w-80",children:n.jsxs("div",{className:"surface-elevated radius-inset shadow-2xl overflow-hidden",children:[n.jsxs("div",{className:"flex items-center gap-2 px-3 py-2.5 border-b border-edge-subtle",children:[n.jsx(ae,{className:"w-4 h-4 text-fg-muted shrink-0"}),n.jsx("input",{ref:ys,type:"text",value:Pe,onChange:e=>Ee(e.target.value),placeholder:"Search by name or prefix...",className:"flex-1 bg-transparent text-sm text-fg-primary placeholder:text-fg-muted focus:outline-none",onKeyDown:e=>{"Escape"===e.key?($e(!1),Ee("")):"Enter"===e.key&&on.length>0&&rn(on[0])}}),Pe&&n.jsx("button",{onClick:()=>Ee(""),className:"p-0.5 radius-badge hover-bg transition-base",children:n.jsx(p,{className:"w-3 h-3 text-fg-muted"})})]}),on.length>0&&n.jsx("div",{className:"max-h-64 overflow-y-auto",children:on.map((e,t)=>n.jsxs("button",{onClick:()=>rn(e),className:"w-full flex items-center gap-3 px-3 py-2 text-left hover-bg transition-base "+(0===t?"bg-subtle-fill/50":""),children:[n.jsx("span",{className:"w-2.5 h-2.5 rounded-full shrink-0",style:{backgroundColor:ye[e.nodeClass]}}),n.jsxs("div",{className:"flex-1 min-w-0",children:[n.jsx("div",{className:"text-sm text-fg-primary truncate",children:e.name||e.prefix}),e.name&&n.jsx("div",{className:"text-[10px] text-fg-muted",children:e.prefix})]}),n.jsx(se,{className:"w-3 h-3 text-fg-muted shrink-0"})]},e.id))}),Pe&&0===on.length&&n.jsx("div",{className:"px-3 py-4 text-center text-sm text-fg-muted",children:"No nodes found"}),!Pe&&n.jsx("div",{className:"px-3 py-2 type-data-xs text-fg-muted",children:"Type to search • Enter to select • Esc to close"})]})})});return Z?0===Es.length?n.jsxs("div",{className:"relative h-[calc(100dvh-56px)] lg:h-dvh min-h-[500px] -mx-4 sm:-mx-6 lg:-mx-8 -mt-5 -mb-4 sm:-mb-6 lg:-mb-8 overflow-hidden",children:[Cn,n.jsx("div",{className:"absolute inset-0 bg-body flex items-center justify-center",children:n.jsx(Bt,{})})]}):Ns?Me?n.jsxs("div",{className:"fixed inset-0 z-50 bg-body flex flex-col overflow-hidden",children:[n.jsxs("div",{className:"flex items-center justify-between px-4 py-2.5 surface-header z-10",children:[n.jsxs("div",{className:"flex items-center gap-3",children:[n.jsx(D,{className:"w-5 h-5 text-icon-page-title"}),n.jsxs("h1",{className:"type-title text-fg-primary flex items-center gap-2",children:["MeshGraph",n.jsx(F,{color:"violet",compact:!0,children:"Analytics"})]}),n.jsxs("span",{className:"text-[10px] text-fg-muted tabular-nums",children:[qs.length," nodes • ",Us.length," edges"]})]}),n.jsx(R,{content:"Exit fullscreen",children:n.jsx("button",{onClick:cn,className:"p-1.5 radius-inner hover-bg transition-base",children:n.jsx(_,{className:"w-4 h-4 text-fg-muted"})})})]}),n.jsxs("div",{className:"flex-1 relative min-h-0 m-2 surface-base radius-inset overflow-hidden border border-edge-subtle",children:[n.jsx(a,{className:"absolute inset-0",points:Ns,links:Cs,...Ss,...Ds,backgroundColor:Ne,fitViewOnInit:!0,fitViewPadding:.15,showLabels:Ue,showDynamicLabels:!1,showTopLabels:Ue,showTopLabelsLimit:200,showHoveredPointLabel:!0,pointLabelColor:we,pointClusterBy:zt?"communityId":void 0,onPolygonSelected:Wt?hn:void 0,polygonalSelectorStrokeColor:be?"#FBBF24":"#D97706",onClick:ln,onLinkClick:an,onMount:Qs,hoveredPointRingColor:be?"#FBBF24":"#D97706",hoveredPointCursor:"pointer",hoveredLinkCursor:"pointer"}),In,$n,Ln,Dn,Fn,An,n.jsxs(m,{children:[Se&&n.jsx(Mt,{node:Se,egoMetrics:pn,onExpandEgo:fn,neighbors:gn,onSelectNeighbor:sn,onClose:()=>{var e;Le(null),null==(e=js.current)||e.unselectAllPoints()}}),De&&!Se&&n.jsx(Rt,{edge:De,onClose:()=>Re(null)}),Kt&&!Se&&!De&&n.jsx(Ht,{metrics:Kt,onClose:xn})]})]})]}):n.jsxs("div",{className:"relative h-[calc(100dvh-56px)] lg:h-dvh min-h-[500px] -mx-4 sm:-mx-6 lg:-mx-8 -mt-5 -mb-4 sm:-mb-6 lg:-mb-8 overflow-hidden",children:[Cn,n.jsxs("div",{className:"absolute inset-0",children:[n.jsx(a,{className:"absolute inset-0",points:Ns,links:Cs,...Ss,...Ds,backgroundColor:Ne,fitViewOnInit:!0,fitViewPadding:.15,showLabels:Ue,showDynamicLabels:!1,showTopLabels:Ue,showTopLabelsLimit:200,showHoveredPointLabel:!0,pointLabelColor:we,pointClusterBy:zt?"communityId":void 0,onPolygonSelected:Wt?hn:void 0,polygonalSelectorStrokeColor:be?"#FBBF24":"#D97706",onClick:ln,onLinkClick:an,onMount:Qs,hoveredPointRingColor:be?"#FBBF24":"#D97706",hoveredPointCursor:"pointer",hoveredLinkCursor:"pointer"}),In,$n,Ln,Dn,Fn,An,n.jsxs("div",{className:"absolute bottom-4 right-4 z-10 hidden lg:flex items-center gap-3 type-data-xs text-fg-muted/60",children:[n.jsxs("span",{children:[n.jsx("kbd",{className:"px-1 py-0.5 radius-badge bg-subtle-fill/50 font-mono",children:"/"})," Search"]}),n.jsxs("span",{children:[n.jsx("kbd",{className:"px-1 py-0.5 radius-badge bg-subtle-fill/50 font-mono",children:"F"})," Fit"]}),n.jsxs("span",{children:[n.jsx("kbd",{className:"px-1 py-0.5 radius-badge bg-subtle-fill/50 font-mono",children:"L"})," Labels"]}),n.jsxs("span",{children:[n.jsx("kbd",{className:"px-1 py-0.5 radius-badge bg-subtle-fill/50 font-mono",children:"Space"})," Pause"]}),n.jsxs("span",{children:[n.jsx("kbd",{className:"px-1 py-0.5 radius-badge bg-subtle-fill/50 font-mono",children:"Esc"})," Clear"]})]}),n.jsxs(m,{children:[Se&&n.jsx(Mt,{node:Se,egoMetrics:pn,onExpandEgo:fn,neighbors:gn,onSelectNeighbor:sn,onClose:()=>{var e;Le(null),null==(e=js.current)||e.unselectAllPoints()}}),De&&!Se&&n.jsx(Rt,{edge:De,onClose:()=>Re(null)}),Kt&&!Se&&!De&&n.jsx(Ht,{metrics:Kt,onClose:xn})]})]})]}):n.jsxs("div",{className:"relative h-[calc(100dvh-56px)] lg:h-dvh min-h-[500px] -mx-4 sm:-mx-6 lg:-mx-8 -mt-5 -mb-4 sm:-mb-6 lg:-mb-8 overflow-hidden",children:[Cn,n.jsxs("div",{className:"absolute inset-0 bg-body flex flex-col items-center justify-center gap-3",children:[n.jsx(z,{className:"w-8 h-8 text-sys-blue animate-spin"}),n.jsx("span",{className:"type-body text-fg-muted",children:"Preparing graph..."})]})]}):n.jsxs("div",{className:"relative h-[calc(100dvh-56px)] lg:h-dvh min-h-[500px] -mx-4 sm:-mx-6 lg:-mx-8 -mt-5 -mb-4 sm:-mb-6 lg:-mb-8 overflow-hidden",children:[Cn,n.jsxs("div",{className:"absolute inset-0 bg-body flex items-center justify-center",children:[n.jsx(q,{isOpen:X,onClose:oe}),!X&&n.jsx(z,{className:"w-8 h-8 text-sys-blue animate-spin"})]})]})}export{zt as default};
