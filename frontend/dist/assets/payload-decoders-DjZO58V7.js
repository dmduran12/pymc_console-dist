var t=Object.defineProperty,e=(e,a,s)=>((e,a,s)=>a in e?t(e,a,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[a]=s)(e,"symbol"!=typeof a?a+"":a,s);import{ae as a,cv as s,cw as r,cx as n,cy as h,ac as c,cz as i,cA as o,c9 as p,c7 as l,c8 as u,cB as d,cC as y,bB as g,cD as f,cE as m,cF as x,cG as T,cH as H,cI as C,cJ as w,cK as L,cL as S,cM as N,cN as b,cO as A,cP as _,cQ as $,cR as V,cS as F,cT as U,cU as D,cg as E,cf as M,cV as v,cj as P,cW as B,cX as O,cY as R,cZ as j,c_ as k,c$ as I,d0 as K,d1 as W,d2 as q,d3 as Q,ch as z,ci as G,d4 as J,d5 as X,d6 as Y,d7 as Z,d8 as tt}from"./index-D7i6lQrq.js";class et{constructor(){e(this,"header",0),e(this,"transportCodes",[0,0]),e(this,"pathLen",0),e(this,"path",new Uint8Array(0)),e(this,"payload",new Uint8Array(0)),e(this,"decrypted",{}),e(this,"_rssi",0),e(this,"_snr",0)}static fromBytes(t){const e=new et;try{return e.readFrom(t),{success:!0,packet:e}}catch(a){return{success:!1,error:a instanceof Error?a.message:String(a)}}}static fromHex(t){try{const e=a(t);return et.fromBytes(e)}catch(e){return{success:!1,error:e instanceof Error?e.message:String(e)}}}get routeType(){return this.header&s}get routeTypeName(){return r[this.routeType]??`UNKNOWN(${this.routeType})`}get payloadType(){return this.header>>n&h}get payloadTypeName(){return c[this.payloadType]??`UNKNOWN(${this.payloadType})`}get payloadVersion(){return this.header>>i&o}hasTransportCodes(){return p(this.routeType)}isFlood(){return l(this.routeType)}isDirect(){return u(this.routeType)}get pathBytes(){return Array.from(this.path)}get pathString(){return d(this.path)}get pathHexArray(){return Array.from(this.path).map(t=>y(t,!0))}get payloadLen(){return this.payload.length}get payloadHex(){return g(this.payload,!0)}getPayloadAppData(){const t=N+b+A;return this.payload.length>=t?this.payload.slice(t):new Uint8Array(0)}get rssi(){return this._rssi}set rssi(t){this._rssi=t}get snr(){return this._snr}set snr(t){this._snr=t}readFrom(t){let e=0;const a=t.length;f(e,1,a,"Missing header byte"),this.header=t[e++];const s=this.payloadVersion;if(s>m)throw new Error(`Unsupported packet version: ${s}`);if(this.hasTransportCodes()?(f(e,4,a,"Missing transport codes"),this.transportCodes=[x(t,e),x(t,e+2)],e+=4):this.transportCodes=[0,0],f(e,1,a,"Missing path_len"),this.pathLen=t[e++],this.pathLen>T)throw new Error(`path_len too large: ${this.pathLen} > ${T}`);return f(e,this.pathLen,a,"Truncated path"),this.path=t.slice(e,e+this.pathLen),e+=this.pathLen,this.payload=t.slice(e),H(this.payload.length),!0}writeTo(){let t=1;this.hasTransportCodes()&&(t+=4),t+=1,t+=this.path.length,t+=this.payload.length;const e=new Uint8Array(t);let a=0;return e[a++]=this.header,this.hasTransportCodes()&&(C(this.transportCodes[0],e,a),C(this.transportCodes[1],e,a+2),a+=4),e[a++]=this.path.length,e.set(this.path,a),a+=this.path.length,e.set(this.payload,a),e}toHex(){return g(this.writeTo(),!0)}async calculateHash(){return w(this.payloadType,this.pathLen,this.payload)}async calculateHashString(t){return L(this.payloadType,this.pathLen,this.payload,t)}async calculateCRC(){return S(this.payloadType,this.pathLen,this.payload)}getRawLength(){let t=2+this.pathLen+this.payload.length;return this.hasTransportCodes()&&(t+=4),t}getSummary(){return{header:y(this.header,!0),routeType:this.routeTypeName,payloadType:this.payloadTypeName,version:this.payloadVersion,pathLen:this.pathLen,pathStr:this.pathString,transportCodes:this.hasTransportCodes()?[this.transportCodes[0].toString(16).toUpperCase().padStart(4,"0"),this.transportCodes[1].toString(16).toUpperCase().padStart(4,"0")]:null,payloadLen:this.payload.length,payloadHex:this.payloadHex,rawLength:this.getRawLength()}}toString(){const t=[`[${this.routeTypeName}/${this.payloadTypeName} v${this.payloadVersion}]`,`path=${this.pathString||"(empty)"}`,`payload=${this.payload.length}B`];return this.hasTransportCodes()&&t.push(`transport=[${this.transportCodes[0]},${this.transportCodes[1]}]`),t.join(" ")}}function at(t){const e=N+b+A+1;if(t.length<e)return null;let a=0;const s=g(t.slice(a,a+N));a+=N;const r=k(t,a);a+=b;const n=g(t.slice(a,a+A));a+=A;const h=t[a++],c=I(h);let i="unknown";switch(h&tt){case Z:i="chat";break;case Y:i="repeater";break;case X:i="room_server";break;case J:i="sensor"}const o={type:"advert",publicKey:s,timestamp:r,signature:n,flags:h,flagsDescription:c,nodeType:i,rawAppData:g(t.slice(N+b+A))};if(h&K&&a+8<=t.length){const e=t.slice(a,a+8),s=new ArrayBuffer(8);new Uint8Array(s).set(e);const r=new DataView(s),n=r.getInt32(0,!0),h=r.getInt32(4,!0);o.latitude=n/1e6,o.longitude=h/1e6,a+=8}if(h&W&&(a+=2),h&q&&(a+=2),h&Q&&a<t.length){let e=a;for(;e<t.length&&0!==t[e];)e++;e>a&&(o.name=(new TextDecoder).decode(t.slice(a,e)))}return o}function st(t,e){const a=function(t){if(t.length<9)return{type:"trace",traceTag:"00000000",traceTagValue:0,authCode:0,flags:0,pathHashes:[],pathString:"",snrValues:[],isComplete:!1,path:[],targetHash:""};const e=k(t,0),a=e.toString(16).toUpperCase().padStart(8,"0"),s=k(t,4),r=t[8],n=t.slice(9),h=Array.from(n).map(t=>y(t,!0)),c=h.join("->");return{type:"trace",traceTag:a,traceTagValue:e,authCode:s,flags:r,pathHashes:h,pathString:c,snrValues:[],isComplete:!1,path:h,targetHash:h.length>0?h[0]:""}}(t);if(!a)return null;const s=[],r=e instanceof Uint8Array?Array.from(e):e;for(let h=0;h<r.length;h++){let t=r[h];t>127&&(t-=256);const e=t/4;s.push(Math.max(-20,Math.min(15,e)))}const n=s.length>=a.pathHashes.length;return{...a,snrValues:s,isComplete:n}}function rt(t,e=0){const a=e>=1?2:1,s=j,r=2*a+s;if(t.length<r)return null;const n=g(t.slice(0,a),!0),h=g(t.slice(a,2*a),!0),c=2*a,i=g(t.slice(c,c+s)),o=t.slice(c+s);let p="",l=!0;try{const t=new TextDecoder("utf-8",{fatal:!0}).decode(o);/^[\x20-\x7E\u00A0-\uFFFF\n\r\t]*$/.test(t)&&(p=t,l=!1)}catch{}return l&&(p=g(o)),{type:"txt_msg",destHash:n,srcHash:h,cipherMac:i,timestamp:0,text:p,ciphertextHex:l?g(o):void 0,encrypted:l}}async function nt(t,e=0){const a=e>=1?4:j,s=1+a+1;if(t.length<s)return null;const r=t[0],n=y(r,!0),h=t.slice(1,1+a),c=t.slice(1+a),i={type:"grp_txt",channelHash:n,text:g(c),decrypted:!1,ciphertextHex:g(c),macHex:g(h)};try{const t=await z(r,h,c);if(t&&t.plaintext.length>=5){i.channelName=t.channelName;const e=t.plaintext,a=k(e,0),s=e[4],r=new TextDecoder("utf-8",{fatal:!1}).decode(e.slice(5)).replace(/\uFFFD/g,"").replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F-\x9F]/g,"").replace(/\x00+$/,"").trim();i.decrypted=!0,i.isPublicHashChannel=!0,i.timestamp=a,i.flags=s,t.macCorrupted&&(i.macCorrupted=!0);const n=r.indexOf(": ");n>0?(i.senderName=r.slice(0,n),i.text=r.slice(n+2)):i.text=r}else{const t=await G(r);i.isPublicHashChannel=t.length>0}}catch{}return i}async function ht(t){if(t.length<1+j+1)return null;const e=t[0],a=y(e,!0),s=t.slice(1,1+j),r=t.slice(1+j),n={type:"grp_data",channelHash:a,dataHex:g(r),dataLength:r.length,decrypted:!1,macHex:g(s)};try{const t=await z(e,s,r);t&&(n.channelName=t.channelName,n.decrypted=!0,n.decryptedHex=g(t.plaintext))}catch{}return n}function ct(t,e,a){return{type:"generic",payloadType:e,payloadTypeName:a,rawHex:g(t),length:t.length}}function it(t){const{payload:e,payloadType:a,payloadTypeName:s}=t;switch(a){case R:return at(e)??ct(e,a,s);case O:return function(t){if(t.length<4)return null;const e=k(t,0);return{type:"ack",crc:e.toString(16).toUpperCase().padStart(8,"0"),crcValue:e}}(e)??ct(e,a,s);case B:return function(t){if(0===t.length)return{type:"path",pathLength:0,path:[],pathString:""};const e=t[0];if(t.length<1+e+1){const a=Math.min(e,t.length-1),s=Array.from(t.slice(1,1+a)).map(t=>y(t,!0));return{type:"path",pathLength:e,path:s,pathString:s.join("->")}}const a=Array.from(t.slice(1,1+e)).map(t=>y(t,!0)),s=a.join("->"),r=t[1+e],n=c[r]??`UNKNOWN(${r})`;let h;return t.length>1+e+1&&(h=g(t.slice(1+e+1))),{type:"path",pathLength:e,path:a,pathString:s,extraType:r,extraTypeName:n,extraData:h}}(e)??ct(e,a,s);case P:return st(e,t.path)??ct(e,a,s);case v:return rt(e,t.payloadVersion)??ct(e,a,s);case M:return function(t,e=0){const a=e>=1?4:j,s=1+a+1;if(t.length<s)return null;const r=t[0],n=y(r,!0),h=t.slice(1,1+a),c=t.slice(1+a);return{type:"grp_txt",channelHash:n,text:g(c),decrypted:!1,ciphertextHex:g(c),macHex:g(h)}}(e,t.payloadVersion)??ct(e,a,s);case E:return function(t){if(t.length<1+j+1)return null;const e=t[0],a=y(e,!0),s=t.slice(1,1+j),r=t.slice(1+j);return{type:"grp_data",channelHash:a,dataHex:g(r),dataLength:r.length,decrypted:!1,macHex:g(s)}}(e)??ct(e,a,s);case D:return function(t){return t.length<4?null:{type:"multipart",messageId:g(t.slice(0,2)),partNumber:t[2],totalParts:t[3],partData:g(t.slice(4))}}(e)??ct(e,a,s);case U:return function(t){if(t.length<1)return null;const e=t[0],a=e>>4&15,s=15&e,r={8:"DISCOVER_REQ",9:"DISCOVER_RESP"}[a]??`0x${a.toString(16)}`;return{type:"control",controlType:e,subtype:a,subtypeFlags:s,subtypeName:r,dataHex:g(t.slice(1)),dataLength:t.length-1,isInternal:a>=8}}(e)??ct(e,a,s);case F:return function(t){if(t.length<4)return null;const e=y(t[0],!0),a=y(t[1],!0),s=g(t.slice(2,4)),r=t.slice(4);return{type:"req",destHash:e,srcHash:a,cipherMac:s,ciphertextHex:g(r),ciphertextLength:r.length}}(e)??ct(e,a,s);case V:return function(t){if(t.length<4)return null;const e=y(t[0],!0),a=y(t[1],!0),s=g(t.slice(2,4)),r=t.slice(4);return{type:"response",destHash:e,srcHash:a,cipherMac:s,ciphertextHex:g(r),ciphertextLength:r.length}}(e)??ct(e,a,s);case $:return function(t){if(t.length<35)return null;const e=y(t[0],!0),a=g(t.slice(1,33)),s=g(t.slice(33,35)),r=t.slice(35);return{type:"anon_req",destHash:e,senderPublicKey:a,cipherMac:s,ciphertextHex:g(r),ciphertextLength:r.length}}(e)??ct(e,a,s);default:return ct(e,a,s)}}export{et as P,nt as a,ht as b,it as c,rt as d,st as e,at as f};
