import{H as e,B as t}from"./index-CkRTgHHA.js";import{r as n,j as s}from"./vendor-react-alRNW2nb.js";import{c as a}from"./node-types-DRVunROD.js";import{aI as r,aJ as o,Y as l,X as i,R as d,at as c,j as u,a2 as m,au as h}from"./vendor-icons-TO0PZKGR.js";function p(){return{timeStart:null,timeEnd:null,deviceTypes:new Set,nodeIds:new Set,disabledNodeIds:new Set,nodeFilterMode:"source"}}function b(t,n,s,a){const r=function(t,n){const{timeStart:s,timeEnd:a,deviceTypes:r,nodeIds:o,disabledNodeIds:l,nodeFilterMode:i}=t,d=null!==s||null!==a,c=r.size>0;let u;if(l.size>0){u=new Set;for(const e of o)l.has(e)||u.add(e)}else u=o;const m=u.size>0;let h=null;if(m){h=new Set;for(const t of u)h.add(e(t))}return{hasTime:d,hasDevice:c,hasNode:m,tStart:s??n.start,tEnd:a??n.end,deviceTypes:r,effectiveNodeIds:u,nodeIdPrefixes:h,nodeFilterMode:i,needsDisambiguation:c||m}}(n,a);return r.hasTime||r.hasDevice||r.hasNode?t.filter(t=>function(t,n,s){if(n.hasTime&&(t.timestamp<n.tStart||t.timestamp>n.tEnd))return!1;if(n.needsDisambiguation){const a=s(t);if(n.hasDevice&&!n.deviceTypes.has(a.type))return!1;if(n.hasNode)if("observed"===n.nodeFilterMode){let s=!1;if(a.hash&&n.effectiveNodeIds.has(a.hash)&&(s=!0),!s&&t.dst_hash&&(n.effectiveNodeIds.has(t.dst_hash)||n.nodeIdPrefixes.has(e(t.dst_hash)))&&(s=!0),!s){const e=t.forwarded_path??t.original_path;if(e&&Array.isArray(e))for(const t of e){const e=String(t).toUpperCase();if(n.nodeIdPrefixes.has(e)){s=!0;break}}}if(!s)return!1}else if(!a.hash||!n.effectiveNodeIds.has(a.hash))return!1}return!0}(t,r,s)):t}function x(e,t){const n=new Date(1e3*e),s=e=>e.toString().padStart(2,"0"),a=`${s(n.getHours())}:${s(n.getMinutes())}`;return t<24?a:`${["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][n.getMonth()]} ${n.getDate()} ${a}`}const f=[{type:"repeater",label:"Repeater",icon:d,buttonColor:"primary",iconColor:"text-sys-blue",hoverClass:"hover:border-sys-blue hover:text-sys-blue hover:!bg-transparent"},{type:"companion",label:"Companion",icon:c,buttonColor:"indigo",iconColor:"text-sys-indigo",hoverClass:"hover:border-sys-indigo hover:text-sys-indigo hover:!bg-transparent"},{type:"room_server",label:"Room",icon:u,buttonColor:"purple",iconColor:"text-sys-purple",hoverClass:"hover:border-sys-purple hover:text-sys-purple hover:!bg-transparent"},{type:"unknown",label:"Unknown",icon:m,buttonColor:"zinc",iconColor:"text-zinc-400",hoverClass:"hover:border-zinc-400 hover:text-zinc-400 hover:!bg-transparent"}],v=60,g=.005;function y({min:e,max:t,valueStart:a,valueEnd:r,onChange:o}){const l=n.useRef(null),[i,d]=n.useState(null),c=n.useRef({valueStart:a,valueEnd:r,min:e,max:t});c.current={valueStart:a,valueEnd:r,min:e,max:t};const u=n.useRef({offset:0,width:0}),m=t-e||1,h=m/3600,p=a??e,b=r??t,f=(p-e)/m*100,y=(b-e)/m*100,w=null!==a||null!==r,N=n.useCallback(e=>{const t=l.current.getBoundingClientRect(),n=Math.max(0,Math.min(1,(e-t.left)/t.width)),{min:s,max:a}=c.current;return Math.round(s+n*(a-s||1))},[]),j=n.useCallback((e,t)=>{t.preventDefault(),t.stopPropagation();const n=t.currentTarget;n.setPointerCapture(t.pointerId),d(e);const s=t=>{const n=N(t.clientX),{valueStart:s,valueEnd:a,min:r,max:l}=c.current,i=l-r||1;if("start"===e){const e=Math.min(n,(a??l)-v);o(e<=r+i*g?null:e,a)}else{const e=Math.max(n,(s??r)+v);o(s,e>=l-i*g?null:e)}},a=()=>{d(null),n.removeEventListener("pointermove",s),n.removeEventListener("pointerup",a),n.removeEventListener("pointercancel",a)};n.addEventListener("pointermove",s),n.addEventListener("pointerup",a),n.addEventListener("pointercancel",a)},[N,o]),C=n.useCallback(e=>{e.preventDefault(),e.stopPropagation();const t=e.currentTarget;t.setPointerCapture(e.pointerId),d("range");const n=c.current.valueStart??c.current.min,s=c.current.valueEnd??c.current.max;u.current={offset:N(e.clientX)-n,width:s-n};const a=e=>{const t=N(e.clientX),{min:n,max:s}=c.current,{offset:a,width:r}=u.current;let l=t-a;l=Math.max(n,Math.min(s-r,l));const i=l+r;o(Math.round(l)<=n?null:Math.round(l),Math.round(i)>=s?null:Math.round(i))},r=()=>{d(null),t.removeEventListener("pointermove",a),t.removeEventListener("pointerup",r),t.removeEventListener("pointercancel",r)};t.addEventListener("pointermove",a),t.addEventListener("pointerup",r),t.addEventListener("pointercancel",r)},[N,o]),k=n.useCallback(e=>{const t=N(e.clientX),{valueStart:n,valueEnd:s,min:a,max:r}=c.current,l=r-a||1,i=n??a,d=s??r;if(Math.abs(t-i)<=Math.abs(t-d)){const e=Math.min(t,d-v);o(e<=a+l*g?null:e,s)}else{const e=Math.max(t,i+v);o(n,e>=r-l*g?null:e)}},[N,o]),S=n.useCallback(()=>o(null,null),[o]),M=n.useCallback((e,t)=>{const n="ArrowRight"===t.key||"ArrowUp"===t.key?1:"ArrowLeft"===t.key||"ArrowDown"===t.key?-1:0;if(!n)return;t.preventDefault();const s=(t.shiftKey?.1:.01)*m,{valueStart:a,valueEnd:r,min:l,max:i}=c.current,d=i-l||1;if("start"===e){const e=Math.max(l,Math.min((a??l)+n*s,(r??i)-v));o(e<=l+d*g?null:e,r)}else{const e=Math.min(i,Math.max((r??i)+n*s,(a??l)+v));o(a,e>=i-d*g?null:e)}},[m,o]),I=e=>{const t=i===e;return["absolute top-1/2 -translate-y-1/2 -translate-x-1/2 w-1 h-4 rounded-full","before:content-[''] before:absolute before:-inset-x-3 before:-inset-y-1","touch-none outline-none",t?"cursor-grabbing":"cursor-ew-resize",t?"bg-sys-blue shadow-[0_0_8px_var(--sys-blue)] scale-x-150 z-20":("start"===e?null!==a:null!==r)?"bg-sys-blue shadow-[0_0_4px_var(--sys-blue)] hover:shadow-[0_0_8px_var(--sys-blue)] hover:scale-x-150 z-10":"bg-edge-subtle hover:bg-fg-muted hover:scale-x-150 z-10",t?"":"transition-[transform,box-shadow,background-color] duration-150 ease-out","focus-visible:ring-2 focus-visible:ring-sys-blue/50"].filter(Boolean).join(" ")};return s.jsxs("div",{className:"flex flex-col gap-0.5 min-w-[160px] sm:min-w-[220px]",children:[s.jsxs("div",{className:"flex items-center justify-between type-data-xs text-fg-muted tabular-nums select-none",children:[s.jsx("span",{className:w&&null!==a?"text-sys-blue":"",children:x(p,h)}),s.jsx("span",{className:w&&null!==r?"text-sys-blue":"",children:x(b,h)})]}),s.jsxs("div",{ref:l,className:"relative h-5 select-none",onPointerDown:k,onDoubleClick:S,children:[s.jsx("div",{className:"absolute inset-x-0 top-1/2 -translate-y-1/2 h-1.5 rounded-full bg-white/[0.06] pointer-events-none"}),w?s.jsx("div",{className:["group/band absolute inset-y-0 touch-none","range"===i?"cursor-grabbing":"cursor-grab"].join(" "),style:{left:`${f}%`,right:100-y+"%"},onPointerDown:C,children:s.jsx("div",{className:["absolute inset-x-0 top-1/2 -translate-y-1/2 h-1.5 rounded-full pointer-events-none transition-colors","range"===i?"bg-sys-blue/40":"bg-sys-blue/25 group-hover/band:bg-sys-blue/35"].join(" ")})}):s.jsx("div",{className:"absolute inset-x-0 top-1/2 -translate-y-1/2 h-1.5 rounded-full bg-white/[0.04] pointer-events-none"}),s.jsx("div",{role:"slider",tabIndex:0,"aria-label":"Range start","aria-valuenow":p,className:I("start"),style:{left:`${f}%`},onPointerDown:e=>j("start",e),onKeyDown:e=>M("start",e)}),s.jsx("div",{role:"slider",tabIndex:0,"aria-label":"Range end","aria-valuenow":b,className:I("end"),style:{left:`${y}%`},onPointerDown:e=>j("end",e),onKeyDown:e=>M("end",e)})]})]})}function w({parentStartTs:e,parentEndTs:d,neighbors:c,filter:u,onChange:m,scatterDotSize:p,onScatterDotSizeChange:b,scatterOpacity:x,onScatterOpacityChange:v}){const[g,w]=n.useState(""),[j,C]=n.useState(!1),k=n.useRef(null);n.useEffect(()=>{function e(e){k.current&&!k.current.contains(e.target)&&C(!1)}if(j)return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[j]);const S=n.useMemo(()=>Object.entries(c).map(([e,t])=>{const n=a(t);return{hash:e,name:t.name??t.node_name??e.slice(0,8),type:n.type,label:n.label}}).sort((e,t)=>e.name.localeCompare(t.name)),[c]),M=n.useMemo(()=>{if(!g)return S;const e=g.toLowerCase();return S.filter(t=>t.name.toLowerCase().includes(e)||t.hash.toLowerCase().includes(e))},[S,g]),I=null!==u.timeStart||null!==u.timeEnd||u.deviceTypes.size>0||u.nodeIds.size>0,E=n.useCallback((e,t)=>{m({...u,timeStart:e,timeEnd:t})},[u,m]),D=n.useCallback(e=>{const t=new Set(u.deviceTypes);t.has(e)?t.delete(e):t.add(e),m({...u,deviceTypes:t})},[u,m]),z=n.useCallback(e=>{const t=new Set(u.nodeIds);t.has(e)?t.delete(e):t.add(e),m({...u,nodeIds:t}),w("")},[u,m]),L=n.useCallback(e=>{const t=new Set(u.nodeIds);t.delete(e);const n=new Set(u.disabledNodeIds);n.delete(e),m({...u,nodeIds:t,disabledNodeIds:n})},[u,m]),T=n.useCallback(e=>{const t=new Set(u.disabledNodeIds);t.has(e)?t.delete(e):t.add(e),m({...u,disabledNodeIds:t})},[u,m]),_=n.useCallback(()=>{m({...u,nodeFilterMode:"source"===u.nodeFilterMode?"observed":"source"})},[u,m]),F=n.useCallback(()=>{m({timeStart:null,timeEnd:null,deviceTypes:new Set,nodeIds:new Set,disabledNodeIds:new Set,nodeFilterMode:"source"}),w("")},[m]),P=n.useMemo(()=>{const e=new Map;for(const t of u.nodeIds){const n=c[t];e.set(t,(null==n?void 0:n.name)??(null==n?void 0:n.node_name)??t.slice(0,8))}return e},[u.nodeIds,c]),R=!(!b||!v);return s.jsxs("div",{className:"flex flex-col gap-2 card-padding",children:[s.jsxs("div",{className:"flex items-center gap-3",children:[R&&s.jsxs(s.Fragment,{children:[s.jsx(N,{icon:s.jsx(r,{className:"w-3 h-3"}),label:"Size",value:p??.8,onChange:b,min:.3,max:3,step:.1,format:e=>e.toFixed(1)}),s.jsx(N,{icon:s.jsx(o,{className:"w-3 h-3"}),label:"Opacity",value:x??50,onChange:v,min:5,max:100,step:5,format:e=>`${Math.round(e)}%`}),s.jsx("div",{className:"w-px h-4 bg-edge-subtle shrink-0 hidden sm:block"})]}),s.jsx("div",{className:"flex items-center gap-1.5 text-fg-muted shrink-0",children:s.jsx(l,{className:"w-3.5 h-3.5"})}),s.jsx("div",{className:"flex-1 min-w-[120px]",children:s.jsx(y,{min:e,max:d,valueStart:u.timeStart,valueEnd:u.timeEnd,onChange:E})}),I&&s.jsxs("button",{type:"button",onClick:F,className:"flex items-center gap-1 px-2 py-0.5 rounded-full type-data-xs text-fg-muted hover:text-fg-primary border border-edge-subtle hover:border-fg-muted/40 transition-colors shrink-0",title:"Clear all filters",children:[s.jsx(i,{className:"w-3 h-3"}),s.jsx("span",{className:"hidden sm:inline",children:"Clear"})]})]}),s.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[s.jsx("div",{className:"flex items-center gap-1.5 overflow-x-auto pb-0.5 -mb-0.5 shrink-0",children:f.map(({type:e,label:n,icon:a,buttonColor:r,iconColor:o,hoverClass:l})=>{const i=u.deviceTypes.has(e);return s.jsxs(t,{color:i?r:"zinc",outline:!i,className:`!h-8 !py-0 ${i?"":l}`,onClick:()=>D(e),title:`Filter by ${n}`,children:[s.jsx(a,{"data-slot":"icon",className:i?"":o}),s.jsx("span",{className:"hidden sm:inline "+(i?"":"text-fg-muted"),children:n})]},e)})}),s.jsx("div",{className:"w-px h-4 bg-edge-subtle shrink-0 hidden md:block"}),s.jsxs("div",{className:"relative flex items-center gap-1.5 flex-1 min-w-[120px] sm:min-w-[180px] h-8 px-2 rounded-md border border-edge-subtle bg-white/[0.03] transition-colors focus-within:border-sys-blue",ref:k,children:[s.jsx(h,{className:"w-3 h-3 text-fg-muted/50 shrink-0"}),s.jsx("input",{type:"text",className:"flex-1 min-w-[60px] type-data-xs py-0.5 bg-transparent text-fg-secondary placeholder:text-fg-muted/40 border-none focus:outline-none",placeholder:"Search nodes...",value:g,onChange:e=>{w(e.target.value),C(!0)},onFocus:()=>C(!0)}),j&&M.length>0&&s.jsx("div",{className:"absolute top-full left-0 right-0 mt-1 z-[200] surface-popover border border-edge-subtle radius-inner max-h-48 overflow-y-auto",children:M.slice(0,20).map(e=>{const t=u.nodeIds.has(e.hash);return s.jsxs("button",{type:"button",onClick:()=>z(e.hash),className:`\n                      w-full flex items-center gap-2 px-2.5 py-1.5 type-data-xs text-left transition-colors\n                      ${t?"bg-sys-indigo/15 text-sys-indigo":"text-fg-secondary hover:bg-subtle-fill"}\n                    `,children:[s.jsx("span",{className:"flex-1 truncate",children:e.name}),s.jsx("span",{className:"text-fg-muted type-data-xs shrink-0",children:e.label})]},e.hash)})})]})]}),u.nodeIds.size>0&&s.jsxs("div",{className:"flex flex-wrap items-center gap-1.5",children:[Array.from(u.nodeIds).map(e=>{const t=u.disabledNodeIds.has(e);return s.jsxs("span",{role:"button",tabIndex:0,onClick:()=>T(e),onKeyDown:t=>{"Enter"!==t.key&&" "!==t.key||(t.preventDefault(),T(e))},className:"inline-flex items-center gap-1 px-2 py-0.5 rounded-full type-data-xs border transition-colors select-none "+(t?"bg-zinc-500/10 text-fg-muted border-edge-subtle cursor-pointer hover:bg-zinc-500/15":"bg-sys-indigo/15 text-sys-indigo border-sys-indigo/25 cursor-pointer hover:bg-sys-indigo/25"),title:e,children:[P.get(e)??e.slice(0,8),s.jsx("button",{type:"button",onClick:t=>{t.stopPropagation(),L(e)},className:"hover:text-fg-primary transition-colors -mr-0.5",title:"Remove from filter",children:s.jsx(i,{className:"w-3 h-3"})})]},e)}),s.jsx("button",{type:"button",onClick:_,className:"inline-flex items-center gap-1 px-2 py-0.5 rounded-full type-data-xs border transition-colors "+("observed"===u.nodeFilterMode?"bg-sys-blue/15 text-sys-blue border-sys-blue/25 hover:bg-sys-blue/25":"bg-white/[0.04] text-fg-muted border-edge-subtle hover:text-fg-secondary hover:border-fg-muted/40"),title:"source"===u.nodeFilterMode?"Source Only — showing packets sent by selected node(s)":"Total Observed — showing all packets where selected node(s) appear (source, path, or destination)",children:"source"===u.nodeFilterMode?"Source Only":"Total Observed"})]})]})}const N=n.memo(function({icon:e,label:t,value:n,onChange:a,min:r,max:o,step:l,format:i}){return s.jsxs("div",{className:"flex items-center gap-2 min-w-0 flex-1",children:[s.jsxs("div",{className:"flex items-center gap-1.5 text-fg-muted shrink-0",children:[e,s.jsx("span",{className:"type-data-xs font-medium hidden sm:inline",children:t})]}),s.jsx("input",{type:"range",min:r,max:o,step:l,value:n,onChange:e=>a(parseFloat(e.target.value)),className:"flex-1 h-1 min-w-[60px] bg-subtle-fill rounded appearance-none cursor-pointer [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:w-2.5 [&::-webkit-slider-thumb]:h-2.5 [&::-webkit-slider-thumb]:bg-sys-blue [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:cursor-pointer"}),s.jsx("span",{className:"type-data-xs text-fg-secondary tabular-nums shrink-0 w-8 text-right",children:i?i(n):n})]})});export{w as A,b as a,p as c};
