import{a as C}from"./vendor-core-CgllfypI.js";import{r as l}from"./vendor-react-CHg3w57L.js";import{u as x}from"./maplibre-gl-B21pqYGi.js";const w="pymc-basemap-mode",S="dark";function M(){if(typeof window>"u")return S;try{const e=localStorage.getItem(w);if(e==="light"||e==="dark")return e}catch{}return S}function b(e){if(!(typeof window>"u"))try{localStorage.setItem(w,e)}catch{}}const v=C(e=>({mode:M(),toggle:()=>e(o=>{const t=o.mode==="light"?"dark":"light";return b(t),{mode:t}}),setMode:o=>{b(o),e({mode:o})}})),P=()=>v(e=>e.mode),_=()=>v(e=>e.toggle),O={light:"https://basemaps.cartocdn.com/gl/positron-gl-style/style.json",dark:"https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json"},R={light:"basemap-light-",dark:"basemap-dark-"},p={};async function j(e){if(p[e])return p[e];const t=await(await fetch(O[e])).json();return p[e]=t,t}function U({mode:e}){const{current:o}=x(),[t,E]=l.useState(null),u=l.useRef({light:!1,dark:!1}),k=l.useRef({light:[],dark:[]});l.useEffect(()=>{const r=()=>{var n;const a=(n=o==null?void 0:o.getMap)==null?void 0:n.call(o);a&&!t&&E(a)};r();const s=setInterval(r,50),c=setTimeout(()=>clearInterval(s),5e3);return()=>{clearInterval(s),clearTimeout(c)}},[o,t]);const g=l.useCallback(async(r,s,c)=>{var L,I;if(u.current[s])return;const a=R[s],n=await j(s),f=[];for(const[y,d]of Object.entries(n.sources||{})){const i=a+y;r.getSource(i)||r.addSource(i,d)}const T=(I=(((L=r.getStyle())==null?void 0:L.layers)||[]).find(y=>!y.id.startsWith("basemap-light-")&&!y.id.startsWith("basemap-dark-")))==null?void 0:I.id;for(const y of n.layers||[]){const d=a+y.id;if(f.push(d),r.getLayer(d))continue;const i={...y,id:d};"source"in i&&typeof i.source=="string"&&(i.source=a+i.source),i.layout||(i.layout={}),i.layout.visibility=c?"visible":"none";try{r.addLayer(i,T)}catch(B){console.warn(`[BasemapLayer] Failed to add layer ${d}:`,B)}}k.current[s]=f,u.current[s]=!0},[]),h=l.useCallback((r,s,c)=>{const a=k.current[s],n=c?"visible":"none";for(const f of a)if(r.getLayer(f))try{r.setLayoutProperty(f,"visibility",n)}catch{}},[]),m=l.useCallback(r=>{var a;const c=(((a=r.getStyle())==null?void 0:a.layers)||[]).filter(n=>!n.id.startsWith("basemap-light-")&&!n.id.startsWith("basemap-dark-"));for(const n of c)try{r.moveLayer(n.id)}catch{}},[]);return l.useEffect(()=>{if(!t)return;const r=s=>{t.hasImage(s.id)||t.addImage(s.id,{width:1,height:1,data:new Uint8Array([0,0,0,0])})};return t.on("styleimagemissing",r),()=>{t.off("styleimagemissing",r)}},[t]),l.useEffect(()=>{if(!t)return;let r=!1;const s=async()=>{if(!r)try{await Promise.all([g(t,"light",e==="light"),g(t,"dark",e==="dark")]),r||m(t)}catch(a){console.error("[BasemapLayer] Setup error:",a)}};t.isStyleLoaded()?s():(t.once("style.load",s),t.once("load",()=>{!r&&!u.current.light&&s()}));const c=()=>{r||setTimeout(()=>{!r&&u.current.light&&u.current.dark&&m(t)},100)};return t.on("styledata",c),()=>{r=!0,t.off("styledata",c)}},[t,g,m,e]),l.useEffect(()=>{t&&(!u.current.light||!u.current.dark||(h(t,"light",e==="light"),h(t,"dark",e==="dark")))},[t,e,h]),null}export{U as B,_ as a,P as u};
