import{j as e,r as t,p as s,y as a,g as n,A as l,T as i,z as r,D as o,E as c,x as d,H as u,I as m,J as x,Z as h,K as p,O as v,Q as g,U as f,o as j}from"./vendor-react-CUlQ5-Td.js";import{u as b,a as y,b as N,c as k,d as w,e as M,f as _,g as L,h as S,j as B,D as C,k as F,m as R}from"./index-C1whtcFB.js";import{u as T,a as D}from"./useThemeColors-8RSyMp_o.js";import{C as P,a as H,P as $,b as A,c as W}from"./PageLayout-CViR4hDG.js";import{g as E,P as z,a as I,b as K}from"./PacketDetailModal-BvhyK15u.js";import{T as O}from"./TimeRangeSelector-Pa-lVKQc.js";import{H as V}from"./HashBadge-Do84dDmK.js";import{R as U,L as Q,a as X,A as q,C as J,X as G,Y,T as Z,b as ee}from"./recharts-7RsRrQtf.js";import{R as te}from"./Grid-HJLNnEZz.js";import"./vendor-core-XI_xDZ-M.js";import"./deckgl-MTXp-Y3t.js";import"./SignalIndicator-DOiETQwB.js";const se={received:{value:"text-[var(--metric-received)]",barBase:"var(--metric-received)"},forwarded:{value:"text-[var(--metric-forwarded)]",barBase:"var(--metric-forwarded)"},transmitted:{value:"text-[var(--metric-transmitted)]",barBase:"var(--metric-transmitted)"},dropped:{value:"text-[var(--metric-dropped)]",barBase:"var(--metric-dropped)"},neutral:{value:"text-text-secondary",barBase:"var(--metric-neutral)"}};function ae({buckets:s,colorType:a,height:n=64}){const l=se[a],{bars:i}=t.useMemo(()=>{var e,t;if(!s||0===s.length)return{bars:[]};const a=[],n=s.length/60;if(n<=1)a.push(...s);else for(let l=0;l<60;l++){const i=Math.floor(l*n),r=Math.floor((l+1)*n),o=s.slice(i,r),c=o.reduce((e,t)=>e+t.count,0),d=o.length>0?o.reduce((e,t)=>e+t.avg_snr,0)/o.length:0;a.push({bucket:l,start:(null==(e=o[0])?void 0:e.start)??0,end:(null==(t=o[o.length-1])?void 0:t.end)??0,count:c,airtime_ms:o.reduce((e,t)=>e+t.airtime_ms,0),avg_snr:d,avg_rssi:0})}const i=Math.max(...a.map(e=>e.count),1);return{bars:a.map(e=>({height:e.count>0?Math.max(e.count/i*100,8):0,color:e.count>0?l.barBase:"transparent",count:e.count,snr:e.avg_snr}))}},[s,l]);return s&&0!==s.length?e.jsx("div",{className:"w-full flex items-end gap-[1px]",style:{height:n},children:i.map((t,s)=>{var a;return e.jsx("div",{className:"flex-1 rounded-t-sm",style:{height:`${t.height}%`,backgroundColor:t.color,opacity:t.count>0?.8:.1,minHeight:t.count>0?"4px":"2px",maxWidth:"4px"},title:t.count>0?`${t.count} packets, SNR: ${null==(a=t.snr)?void 0:a.toFixed(1)}dB`:"No packets"},s)})}):e.jsx("div",{className:"w-full flex items-end justify-center gap-[2px] opacity-20",style:{height:n},children:e.jsx("span",{className:"type-data-xs text-text-muted",children:"No data"})})}const ne={received:"text-text-secondary",forwarded:"text-text-secondary",transmitted:"text-text-secondary",dropped:"text-text-secondary",neutral:"text-text-secondary"},le={sm:"card-sm",md:"card-md",lg:"card-lg",hero:"card-hero",auto:""};function ie({title:t,value:s,color:a="neutral",subtitle:n,buckets:l,timeRangeLabel:i,icon:r,size:o="md",isLoaded:c=!0}){const d=se[a],u="string"==typeof s?s:s.toLocaleString();return e.jsxs("div",{className:`data-card flex flex-col relative ${le[o]}`,children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[r&&e.jsx("span",{className:`icon-sm ${ne[a]}`,children:r}),e.jsx("span",{className:"type-micro",children:t}),i&&e.jsx("span",{className:"pill-tag",children:i})]}),e.jsx("div",{className:"data-card-value",children:u}),e.jsx("div",{className:"flex-1 py-2 mt-2",children:l?e.jsx(ae,{buckets:l,colorType:a,height:64}):e.jsx("div",{className:"w-full h-16 flex items-center justify-center",children:e.jsx("div",{className:"w-full h-0.5 rounded-full",style:{backgroundColor:d.barBase,opacity:.15}})})}),e.jsx("div",{className:"type-label text-text-muted border-t border-border-subtle pt-3 mt-2",children:n||`Total ${t.toLowerCase()}`}),!c&&e.jsx(P,{})]})}function re(){const i=b(),r=y(),o=N(),c=k(),[d,u]=t.useState(null),[m,x]=t.useState(null),h=t.useRef(0);t.useEffect(()=>{if(c>0&&c!==h.current&&i.length>0){h.current=c;const e=i.find(e=>(e.payload_type_name||E(e.payload_type??e.type)).toLowerCase().includes("advert"));if(e){const t=requestAnimationFrame(()=>u(e.packet_hash)),s=setTimeout(()=>u(null),600);return()=>{cancelAnimationFrame(t),clearTimeout(s)}}}},[c,i]);const p=i.slice(-15).reverse();return e.jsxs("div",{className:"chart-container h-full flex flex-col",children:[e.jsxs("div",{className:"chart-header",children:[e.jsxs("div",{className:"chart-title",children:[e.jsx(s,{className:"chart-title-icon"}),"Recent Packets"]}),e.jsxs("div",{className:"flex items-center gap-3",children:[o&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(a,{className:"w-2 h-2 fill-accent-success text-accent-success animate-pulse"}),e.jsx("span",{className:"type-data-xs text-text-muted",children:"LIVE"})]}),e.jsxs(n,{to:"/packets",className:"pill-subtle",children:["View all ",e.jsx(l,{className:"w-3 h-3"})]})]})]}),e.jsxs("div",{className:"sm:hidden flex items-center gap-1.5 px-3 py-1.5 border-b border-border-subtle/50 bg-bg-elevated/20",children:[e.jsx("span",{className:"text-[9px] font-semibold text-text-muted uppercase tracking-wider w-14 flex-shrink-0",children:"Dir"}),e.jsx("span",{className:"text-[9px] font-semibold text-text-muted uppercase tracking-wider w-7 flex-shrink-0",children:"Time"}),e.jsx("span",{className:"text-[9px] font-semibold text-text-muted uppercase tracking-wider w-9 flex-shrink-0",children:"Src"}),e.jsx("span",{className:"text-[9px] font-semibold text-text-muted uppercase tracking-wider flex-1 min-w-0",children:"Type"}),e.jsx("span",{className:"text-[9px] font-semibold text-text-muted uppercase tracking-wider w-14 flex-shrink-0",children:"Route"}),e.jsx("span",{className:"text-[9px] font-semibold text-text-muted uppercase tracking-wider w-10 text-right flex-shrink-0",children:"Signal"})]}),e.jsx("div",{className:"hidden sm:block flex-1 overflow-hidden",children:e.jsx("div",{className:"h-full overflow-y-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"sticky top-0 bg-bg-elevated/95 backdrop-blur-sm",children:e.jsxs("tr",{className:"border-b border-border-subtle/50",children:[e.jsx("th",{className:"text-left py-1.5 px-3 text-[9px] font-semibold text-text-muted uppercase tracking-wider w-16",children:"Dir"}),e.jsx("th",{className:"text-left py-1.5 px-3 text-[9px] font-semibold text-text-muted uppercase tracking-wider",children:"Time"}),e.jsx("th",{className:"text-left py-1.5 px-3 text-[9px] font-semibold text-text-muted uppercase tracking-wider",children:"Source"}),e.jsx("th",{className:"text-left py-1.5 px-3 text-[9px] font-semibold text-text-muted uppercase tracking-wider",children:"Type"}),e.jsx("th",{className:"text-left py-1.5 px-3 text-[9px] font-semibold text-text-muted uppercase tracking-wider",children:"Route"}),e.jsx("th",{className:"text-right py-1.5 px-3 pr-4 text-[9px] font-semibold text-text-muted uppercase tracking-wider",children:"Signal"})]})}),e.jsx("tbody",{className:"divide-y divide-border-subtle/30",children:r&&0===i.length?e.jsx("tr",{children:e.jsx("td",{colSpan:6,className:"text-center py-8 text-text-muted",children:"Loading packets..."})}):0===p.length?e.jsx("tr",{children:e.jsxs("td",{colSpan:6,className:"text-center py-8",children:[e.jsx(s,{className:"w-6 h-6 text-text-muted mx-auto mb-2"}),e.jsx("div",{className:"text-sm text-text-primary",children:"No packets received"}),e.jsx("div",{className:"text-xs text-text-muted",children:"Packets will appear here"})]})}):p.map((t,s)=>{const a=(t.payload_type_name||E(t.payload_type??t.type)).toLowerCase().includes("advert");return e.jsx(z,{packet:t,onClick:x,isFlashing:a&&d===t.packet_hash},`${t.packet_hash}_${t.timestamp}_${s}`)})})]})})}),e.jsx("div",{className:"sm:hidden flex-1 overflow-y-auto divide-y divide-border-subtle/30",children:r&&0===i.length?e.jsx("div",{className:"p-8 text-center text-text-muted",children:"Loading packets..."}):0===p.length?e.jsxs("div",{className:"p-8 text-center",children:[e.jsx(s,{className:"w-6 h-6 text-text-muted mx-auto mb-2"}),e.jsx("div",{className:"text-sm text-text-primary",children:"No packets received"}),e.jsx("div",{className:"text-xs text-text-muted",children:"Packets will appear here"})]}):p.map((t,s)=>{const a=(t.payload_type_name||E(t.payload_type??t.type)).toLowerCase().includes("advert");return e.jsx(I,{packet:t,onClick:x,isFlashing:a&&d===t.packet_hash},`${t.packet_hash}_${t.timestamp}_${s}`)})}),e.jsxs("div",{className:"px-3 py-1.5 border-t border-border-subtle/50 text-[10px] text-text-muted bg-bg-elevated/20 text-center",children:["Showing ",p.length," of ",i.length," packets"]}),m&&e.jsx(K,{packet:m,onClose:()=>x(null)})]})}t.memo(function({active:t,payload:s,label:a,formatValue:n,labelKey:l}){var i;if(!t||!s||0===s.length)return null;const r=l&&(null==(i=s[0])?void 0:i.payload)?s[0].payload[l]:a;return e.jsxs("div",{className:"bg-tooltip-bg border border-border-subtle rounded-lg px-4 py-3 shadow-xl",children:[r&&e.jsx("p",{className:"type-data-xs text-white/50 mb-2",children:r}),e.jsx("div",{className:"space-y-1.5",children:s.map((t,s)=>e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"w-2 h-2 rounded-full flex-shrink-0",style:{backgroundColor:t.color}}),e.jsx("span",{className:"type-body-sm text-white/70 capitalize min-w-[60px]",children:t.name}),e.jsx("span",{className:"type-data-sm text-white tabular-nums",children:n?n(t.value,t.name):t.value.toLocaleString()})]},s))})]})});const oe=t.memo(function({active:t,payload:s,color:a,labelKey:n,unit:l=""}){var i,r;if(!t||!s||0===s.length)return null;const o=s[0],c=null==(i=null==o?void 0:o.payload)?void 0:i[n];return e.jsxs("div",{className:"bg-tooltip-bg border border-border-subtle rounded-lg px-3 py-2 shadow-xl",children:[e.jsx("p",{className:"type-data-xs text-white/50 mb-1",children:c}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"w-2 h-2 rounded-full",style:{backgroundColor:a}}),e.jsxs("span",{className:"type-data-sm text-white tabular-nums",children:[null==(r=null==o?void 0:o.value)?void 0:r.toLocaleString(),l]})]})]})});t.memo(function({payload:t}){return t&&0!==t.length?e.jsx("div",{className:"flex items-center justify-center gap-6 mt-4 pt-4 border-t border-white/5",children:t.map((t,s)=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"w-2 h-2 rounded-full",style:{backgroundColor:t.color}}),e.jsx("span",{className:"type-body-sm text-white/60 capitalize",children:t.value})]},s))}):null});const ce=.2;function de(e,t=1){return Math.floor(5*t*e)}function ue(e){const t=Math.round(e/ce)*ce;return Math.max(0,Math.min(5,t))}function me({stats:s,receivedBuckets:a,droppedBuckets:n,forwardedBuckets:l,bucketDurationSeconds:d,timeRangeLabel:u,isLoaded:m=!0}){var x,h,p,v;const g=t.useMemo(()=>function(e,t,s,a,n){var l,i;const r=(null==t?void 0:t.reduce((e,t)=>e+t.count,0))??0,o=(null==s?void 0:s.reduce((e,t)=>e+t.count,0))??0,c=(null==a?void 0:a.reduce((e,t)=>e+t.count,0))??0,d=r>0?r:(null==e?void 0:e.rx_count)||1,u=o>0?o:(null==e?void 0:e.dropped_count)||0,m=d>0?u/(d+u)*100:0;let x=0;if(a&&a.length>0&&n)x=100*c/(a.length*n*1e3)*100;else if(e){const t=1e3*(e.uptime_seconds||1);x=(e.total_airtime_ms||e.airtime_used_ms||0)/t*100}const h=(null==e?void 0:e.neighbors)||{},p=Object.values(h).filter(e=>!0===e.zero_hop).length;let v=1;m<3?v-=ce:m>15?v+=.4:m>10&&(v+=ce),x>5&&(v+=ce),p>10&&(v+=ce);const g=ue(v),f=ue(.28*g),j=de(g),b=de(f),y=de((null==(i=null==(l=null==e?void 0:e.config)?void 0:l.delays)?void 0:i.tx_delay_factor)??1);let N;return N=j>y?"increase":j<y?"decrease":"stable",{floodFactor:g,directFactor:f,floodSlots:j,directSlots:b,adjustment:N,duplicateRate:Math.round(100*m)/100,txUtilization:Math.round(1e3*x)/1e3,zeroHopCount:p,totalReceived:r,totalDropped:o}}(s,a,n,l,d),[s,a,n,l,d]),f=(null==(h=null==(x=null==s?void 0:s.config)?void 0:x.delays)?void 0:h.tx_delay_factor)??null,j=(null==(v=null==(p=null==s?void 0:s.config)?void 0:p.delays)?void 0:v.direct_tx_delay_factor)??null,b=null!==f?de(f):null,y=null!==b&&g.floodSlots!==b,N="increase"===g.adjustment?i:"decrease"===g.adjustment?r:o;return e.jsxs("div",{className:"data-card flex flex-col relative",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3 flex-wrap",children:[e.jsx(c,{className:"w-4 h-4 text-[var(--metric-transmitted)] flex-shrink-0"}),e.jsx("span",{className:"type-micro",children:"TX DELAY"}),u&&e.jsx("span",{className:"pill-tag",children:u}),y&&e.jsxs("span",{className:"pill-tag flex items-center gap-1 "+("increase"===g.adjustment?"bg-accent-warning/20 text-accent-warning border-accent-warning/30":"bg-accent-success/20 text-accent-success border-accent-success/30"),children:[e.jsx(N,{className:"w-3 h-3"}),"increase"===g.adjustment?"+":"-",Math.abs(g.floodSlots-(b??0))]})]}),e.jsxs("div",{className:"data-card-value",children:["×",g.floodFactor.toFixed(1)]}),e.jsxs("div",{className:"flex-1 grid grid-cols-2 gap-x-3 gap-y-1 py-2 mt-2 text-xs",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-text-muted",children:"Flood"}),e.jsxs("span",{className:"tabular-nums text-accent-secondary font-medium",children:[g.floodSlots," slots"]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-text-muted",children:"Direct"}),e.jsxs("span",{className:"tabular-nums text-accent-secondary font-medium",children:[g.directSlots," slots"]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-text-muted",children:"Dup Rate"}),e.jsxs("span",{className:"tabular-nums "+(g.duplicateRate>10?"text-accent-warning":"text-text-secondary"),children:[g.duplicateRate.toFixed(1),"%"]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-text-muted",children:"TX Util"}),e.jsxs("span",{className:"tabular-nums text-text-secondary",children:[g.txUtilization.toFixed(2),"%"]})]})]}),e.jsx("div",{className:"type-label text-text-muted border-t border-border-subtle pt-3 mt-2 truncate",children:null!==f?e.jsxs("span",{children:["Current: ×",f.toFixed(1)," / ×",(null==j?void 0:j.toFixed(1))??"—"]}):e.jsx("span",{children:"Slot-aligned factors"})}),!m&&e.jsx(P,{})]})}function xe({trend:t}){return"stable"===t?e.jsx("span",{className:"mini-widget-trend stable",children:e.jsx("svg",{className:"w-3 h-3",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 12h14"})})}):"up"===t?e.jsx("span",{className:"mini-widget-trend up",children:e.jsx("svg",{className:"w-3 h-3",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 15l7-7 7 7"})})}):e.jsx("span",{className:"mini-widget-trend down",children:e.jsx("svg",{className:"w-3 h-3",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})})}function he(){return e.jsx("div",{className:"mini-widget-loading",children:e.jsx("div",{className:"mini-widget-loading-spinner"})})}function pe({message:t}){return e.jsx("div",{className:"mini-widget-error",children:e.jsx("span",{title:t,children:"No data"})})}function ve({title:t,icon:s,value:a,unit:n,valueSize:l="md",status:i,subtitle:r,trend:o,children:c,isLoading:d=!1,error:u,className:m="",onClick:x}){const h=["mini-widget-value","lg"===l&&"mini-widget-value-lg","sm"===l&&"mini-widget-value-sm",""].filter(Boolean).join(" "),p=["mini-widget",x&&"cursor-pointer",m].filter(Boolean).join(" ");return e.jsxs("div",{className:p,onClick:x,role:x?"button":void 0,children:[e.jsxs("div",{className:"mini-widget-header",children:[s,e.jsx("span",{className:"mini-widget-title",children:t}),i&&"unknown"!==i&&e.jsx("div",{className:`mini-widget-status-dot ${i}`}),o&&e.jsx(xe,{trend:o})]}),d?e.jsx(he,{}):u?e.jsx(pe,{message:u}):e.jsxs(e.Fragment,{children:[void 0!==a&&e.jsxs("div",{className:h,children:[a,n&&e.jsx("span",{className:"mini-widget-unit",children:n})]}),r&&e.jsx("div",{className:"mini-widget-subtitle",children:r}),c]})]})}const ge=t.createContext({lbtStats:null,noiseFloor:null,hourlyNoiseFloor:[],linkQuality:null,channelHealth:null,trends:null,stats:null,recentPackets:[],quickNeighbors:[],isLoading:!0,error:null,refresh:async()=>{}});function fe(e){if(!e)return[];try{const t=JSON.parse(e);if(Array.isArray(t))return t.map(Number).filter(e=>!isNaN(e))}catch{}return[]}function je(e,t,s=2,a=!1){if(null===t)return"stable";const n=e-t;return(0!==t?100*Math.abs(n/t):Math.abs(n))<s?"stable":a?n>0?"up":"down":n>0?"down":"up"}function be({children:s}){const a=w(),n=b(),l=M(),i=_(),r=null===a,o=t.useMemo(()=>function(e){const t=Math.floor(Date.now()/1e3),s=t-86400,a=e.filter(e=>e.timestamp>=s&&void 0!==e.lbt_attempts&&e.lbt_attempts>0),n=a.length,l=a.filter(e=>(e.lbt_attempts??0)>1).length,i=n>0?l/n*100:0,r=a.filter(e=>(e.lbt_attempts??0)>1),o=r.length>0?r.reduce((e,t)=>e+(t.lbt_attempts??0),0)/r.length:0,c=a.filter(e=>!0===e.lbt_channel_busy||1===e.lbt_channel_busy).length,d=n>0?c/n*100:0,u=[];for(const f of a){const e=fe(f.lbt_backoff_delays_ms);u.push(...e)}const m=u.reduce((e,t)=>e+t,0),x=u.length>0?m/u.length:0,h=u.length>0?Math.max(...u):0,p=[],v=[],g=[];for(let f=0;f<24;f++){const e=t-3600*(24-f),s=e+3600,n=a.filter(t=>t.timestamp>=e&&t.timestamp<s),l=n.filter(e=>(e.lbt_attempts??0)>1).length,i=n.length>0?l/n.length*100:0;p.push(i);const r=[];for(const t of n){const e=fe(t.lbt_backoff_delays_ms);r.push(...e)}const o=r.length>0?r.reduce((e,t)=>e+t,0)/r.length:0;if(g.push(o),0===n.length)v.push(0);else{const e=n.filter(e=>!0===e.lbt_channel_busy||1===e.lbt_channel_busy).length,t=r.length>0?Math.max(...r):0,s=Math.min(n.length/5,1),a=.15,l=Math.log(1+i*a)/Math.log(1+100*a)*40,c=e/n.length*100,d=Math.min(.5*c,25);let u=0;o>100&&(u=Math.min(8*Math.log10(o/100),15));let m=0;t>500&&o>0&&t>2*o&&(m=Math.min((t-500)/200,5));const x=l+d+u+m;v.push(Math.min(x*s,85))}}return{totalPacketsWithLBT:n,packetsWithRetries:l,retryRate:i,avgRetries:o,channelBusyCount:c,channelBusyRate:d,avgBackoffMs:x,maxBackoffMs:h,totalBackoffMs:m,hourlyRetryRates:p,hourlyCollisionRisk:v,hourlyAvgBackoffMs:g,windowHours:24,packetCount:e.length}}(n),[n]),c=(null==a?void 0:a.noise_floor_dbm)??null,[d,u]=t.useState([]),m=t.useRef(0);t.useEffect(()=>{const e=async()=>{var e;const t=Date.now();if(!(t-m.current<6e4)){m.current=t;try{const t=await L(24);if(t.success&&(null==(e=t.data)?void 0:e.history)){const e=Math.floor(Date.now()/1e3),s=[];for(let a=0;a<24;a++){const n=e-3600*(24-a),l=n+3600,i=t.data.history.filter(e=>e.timestamp>=n&&e.timestamp<l);if(i.length>0){const e=i.reduce((e,t)=>e+t.noise_floor_dbm,0)/i.length;s.push(e)}else s.push(s.length>0?s[s.length-1]:-100)}u(s)}}catch{}}};e();const t=setInterval(e,6e4);return()=>clearInterval(t)},[]);const x=null==a?void 0:a.neighbors,h=t.useMemo(()=>{const e=x??{};return Object.fromEntries(Object.entries(e).filter(([e])=>!i.has(e)))},[x,i]),p=t.useMemo(()=>l.filter(e=>!i.has(e.hash)),[l,i]),v=t.useMemo(()=>function(e,t){if(0===e.length)return{neighbors:[],networkScore:0,neighborCount:0,bestLink:null,worstLink:null};const s=e.map(e=>{const s=function(e,t){let s=50;void 0!==e&&(s=e>=10?100:e>=5?80:e>=0?60:e>=-5?40:20);let a=50;return void 0!==t&&(a=t>=-70?100:t>=-80?80:t>=-90?60:t>=-100?40:20),Math.round(.6*s+.4*a)}(e.avgSnr??void 0,e.avgRssi??void 0),a=t[e.hash];return{name:(null==a?void 0:a.name)||(null==a?void 0:a.node_name)||e.prefix,hash:e.hash,rssi:e.avgRssi??-100,snr:e.avgSnr??-10,score:s,advertCount:e.count}});s.sort((e,t)=>t.score-e.score);const a=s.length>0?s.reduce((e,t)=>e+t.score,0)/s.length:0;return{neighbors:s,networkScore:Math.round(a),neighborCount:s.length,bestLink:s.length>0?{name:s[0].name,score:s[0].score}:null,worstLink:s.length>0?{name:s[s.length-1].name,score:s[s.length-1].score}:null}}(p,h),[p,h]),g=t.useMemo(()=>function(e,t,s){const a=e?Math.max(0,Math.min(100,100-5*e.retryRate)):50;let n=50;null!==t&&(n=Math.max(0,Math.min(100,(t+120)/30*100)));const l=(null==s?void 0:s.networkScore)??50,i=Math.round(.35*a+.25*n+.4*l);let r;return r=i>=85?"excellent":i>=70?"good":i>=50?"fair":i>=30?"congested":"critical",{score:i,status:r,components:{lbtHealth:Math.round(a),noiseHealth:Math.round(n),linkHealth:Math.round(l)}}}(o,c,v),[o,c,v]),[f,j]=t.useState({noiseFloor:null,networkScore:null,channelHealth:null}),y=t.useRef(0);t.useEffect(()=>{const e=()=>{const e=Date.now();e-y.current>3e4&&(y.current=e,j({noiseFloor:c,networkScore:(null==v?void 0:v.networkScore)??null,channelHealth:(null==g?void 0:g.score)??null}))};e();const t=setInterval(e,5e3);return()=>clearInterval(t)},[c,null==v?void 0:v.networkScore,null==g?void 0:g.score]);const N=t.useMemo(()=>({noiseFloor:{current:c,previous:f.noiseFloor,trend:null!==c?je(c,f.noiseFloor,2,!0):"stable"},networkScore:{current:(null==v?void 0:v.networkScore)??0,previous:f.networkScore,trend:je((null==v?void 0:v.networkScore)??0,f.networkScore,3,!1)},channelHealth:{current:(null==g?void 0:g.score)??0,previous:f.channelHealth,trend:je((null==g?void 0:g.score)??0,f.channelHealth,3,!1)}}),[c,null==v?void 0:v.networkScore,null==g?void 0:g.score,f]),k={lbtStats:o,noiseFloor:c,hourlyNoiseFloor:d,linkQuality:v,channelHealth:g,trends:N,stats:a,recentPackets:n,quickNeighbors:l,isLoading:r,error:null,refresh:async()=>{}};return e.jsx(ge.Provider,{value:k,children:s})}function ye(){const e=t.useContext(ge);if(void 0===e)throw new Error("useLBTData must be used within an LBTDataProvider");return e}const Ne={excellent:"var(--signal-excellent)",good:"var(--signal-good)",fair:"var(--signal-fair)",congested:"var(--signal-poor)",critical:"var(--signal-critical)",unknown:"var(--text-muted)"};function ke(e,t){return 0===e?"No backoffs":`${t.toFixed(0)}% retry rate`}function we(){const{lbtStats:s,isLoading:a,error:n}=ye(),l=d(),i=(null==s?void 0:s.avgBackoffMs)??0,r=(null==s?void 0:s.retryRate)??0,o=s?(u=i)<100?"excellent":u<250?"good":u<500?"fair":u<1e3?"congested":"critical":"unknown";var u;const m=null==s?void 0:s.hourlyAvgBackoffMs,x=t.useMemo(()=>!m||m.length<2?[]:m.map(e=>({value:e})),[m]),h=Ne[o];return e.jsx(ve,{title:"LBT Backoff",icon:e.jsx(c,{className:"mini-widget-icon"}),value:Math.round(i),unit:"ms",status:o,subtitle:s?ke(i,r):void 0,isLoading:a,error:n,onClick:()=>l("/packets"),children:e.jsx("div",{className:"mini-widget-sparkline",children:x.length>0?e.jsx(U,{width:"100%",height:24,children:e.jsx(Q,{data:x,margin:{top:2,right:2,bottom:2,left:2},children:e.jsx(X,{type:"monotone",dataKey:"value",stroke:h,strokeWidth:1,dot:!1,isAnimationActive:!1})})}):e.jsx("div",{className:"h-full"})})})}function Me(){const{lbtStats:t,isLoading:s,error:a}=ye(),n=d(),l=(null==t?void 0:t.channelBusyCount)??0,i=(null==t?void 0:t.totalPacketsWithLBT)??0,r=(null==t?void 0:t.channelBusyRate)??0,o=t?(c=r)<.5?"excellent":c<1?"good":c<2?"fair":c<5?"congested":"critical":"unknown";var c;return e.jsx(ve,{title:"Ch. Busy",icon:e.jsx(u,{className:"mini-widget-icon"}),value:l,status:o,subtitle:t?`${r.toFixed(2)}% of ${i} TX`:void 0,isLoading:s,error:a,onClick:()=>n("/packets")})}function _e(e){return null===e?"No reading":e<-115?"Very quiet":e<-105?"Quiet":e<-95?"Moderate":e<-85?"Elevated":"High interference"}const Le={excellent:"var(--signal-excellent)",good:"var(--signal-good)",fair:"var(--signal-fair)",congested:"var(--signal-poor)",critical:"var(--signal-critical)",unknown:"var(--text-muted)"};function Se(){const{noiseFloor:s,hourlyNoiseFloor:a,trends:n,isLoading:l,error:i}=ye(),r=null===(o=s)||o<-110?"excellent":o<-100?"good":o<-90?"fair":o<-80?"congested":"critical";var o;const c=null==n?void 0:n.noiseFloor.trend,d=t.useMemo(()=>!a||a.length<2?[]:a.map(e=>({value:e})),[a]),u=Le[r];return e.jsx(ve,{title:"Noise Floor",icon:e.jsx(m,{className:"mini-widget-icon"}),value:null!==s?Math.round(s):"—",unit:null!==s?"dBm":void 0,status:r,trend:c,subtitle:_e(s),isLoading:l,error:i,children:e.jsx("div",{className:"mini-widget-sparkline",children:d.length>0?e.jsx(U,{width:"100%",height:24,children:e.jsx(Q,{data:d,margin:{top:2,right:2,bottom:2,left:2},children:e.jsx(X,{type:"monotone",dataKey:"value",stroke:u,strokeWidth:1,dot:!1,isAnimationActive:!1})})}):e.jsx("div",{className:"h-full"})})})}function Be(e,t=8){return e.length<=t?e:e.substring(0,t-1)+"…"}function Ce(){const{linkQuality:t,isLoading:s,error:a}=ye(),n=d(),l=null==t?void 0:t.bestLink,i=null==t?void 0:t.worstLink,r=i?(o=i.score)>=60?"excellent":o>=40?"good":o>=25?"fair":o>=10?"congested":"critical":"unknown";var o;const c=t&&l&&i?e.jsxs("div",{className:"flex flex-col gap-0.5 mt-auto",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsx("span",{className:"text-text-muted",children:"Best:"}),e.jsxs("span",{className:"font-mono text-signal-excellent",children:[Be(l.name)," (",Math.round(l.score),")"]})]}),e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsx("span",{className:"text-text-muted",children:"Worst:"}),e.jsxs("span",{className:"font-mono "+(i.score>=40?"text-signal-fair":"text-signal-critical"),children:[Be(i.name)," (",Math.round(i.score),")"]})]})]}):t&&0===t.neighborCount?e.jsx("div",{className:"flex items-center justify-center text-xs text-text-muted mt-auto",children:"No direct neighbors"}):null;return e.jsx(ve,{title:"Link Range",icon:e.jsx(x,{className:"mini-widget-icon"}),status:r,isLoading:s,error:a,onClick:()=>n("/contacts"),children:c})}const Fe={excellent:"var(--signal-excellent)",good:"var(--signal-good)",fair:"var(--signal-fair)",congested:"var(--signal-poor)",critical:"var(--signal-critical)",unknown:"var(--text-muted)"};function Re(){const{lbtStats:s,isLoading:a,error:n}=ye(),l=s?function(e){const{retryRate:t,channelBusyCount:s,totalPacketsWithLBT:a,avgBackoffMs:n,maxBackoffMs:l}=e;if(0===a)return 0;const i=Math.min(a/10,1),r=Math.log(1+.15*t)/Math.log(16)*40,o=s/a*100,c=Math.min(.5*o,25);let d=0;n>100&&(d=Math.min(8*Math.log10(n/100),15));let u=0;l>500&&n>0&&l>2*n&&(u=Math.min((l-500)/200,5));const m=(r+c+d+u)*i;return Math.min(m,85)}(s):0,i=s?(r=l)<15?"excellent":r<30?"good":r<45?"fair":r<60?"congested":"critical":"unknown";var r;const o=(null==s?void 0:s.maxBackoffMs)??0,c=s?o>200?`Max backoff: ${Math.round(o)}ms`:function(e){return e<15?"Clear channel":e<30?"Light traffic":e<45?"Moderate traffic":e<60?"Heavy traffic":e<75?"Congested":"Severe congestion"}(l):void 0,d=null==s?void 0:s.hourlyCollisionRisk,u=t.useMemo(()=>!d||d.length<2?[]:d.map(e=>({value:e})),[d]),m=Fe[i];return e.jsx(ve,{title:"Collision Risk",icon:e.jsx(h,{className:"mini-widget-icon"}),value:l.toFixed(1),unit:"%",status:i,subtitle:c,isLoading:a,error:n,children:e.jsx("div",{className:"mini-widget-sparkline",children:u.length>0?e.jsx(U,{width:"100%",height:24,children:e.jsx(Q,{data:u,margin:{top:2,right:2,bottom:2,left:2},children:e.jsx(X,{type:"monotone",dataKey:"value",stroke:m,strokeWidth:1,dot:!1,isAnimationActive:!1})})}):e.jsx("div",{className:"h-full"})})})}function Te(){const[a,n]=t.useState(!1),[l]=t.useState(0),{stats:i,lbtStats:r,isLoading:o}=ye(),c=t.useMemo(()=>{if(!i)return null;const e=i.airtime_used_ms??0,t=i.max_airtime_ms??1;return{usedMs:e,maxMs:t,remainingMs:i.airtime_remaining_ms??0,utilizationPercent:i.utilization_percent??(t>0?e/t*100:0)}},[i]),d=t.useMemo(()=>{if(!r||0===r.totalPacketsWithLBT)return 100;const e=r.channelBusyCount,t=r.totalPacketsWithLBT;return(t-e)/t*100},[r]),u=(null==c?void 0:c.utilizationPercent)??0,m=(x=u)<30?"excellent":x<50?"good":x<70?"fair":x<90?"congested":"critical";var x;const h=(null==c?void 0:c.remainingMs)??0,p=d<99?`${d.toFixed(0)}% TX success`:((v=h)<1e3?`${Math.round(v)}ms`:v<6e4?`${(v/1e3).toFixed(1)}s`:`${(v/6e4).toFixed(1)}m`)+" remaining";var v;const g=c?e.jsx("div",{className:"mini-widget-progress mt-auto",children:e.jsx("div",{className:`mini-widget-progress-bar ${m}`,style:{width:`${Math.min(u,100)}%`}})}):null;return e.jsx(ve,{title:"Duty Cycle",icon:e.jsx(s,{className:"mini-widget-icon"}),value:u.toFixed(1),unit:"%",status:m,subtitle:p,isLoading:o,children:g})}function De({className:t=""}){return e.jsx(be,{children:e.jsxs("div",{className:`mesh-health-container ${t}`,children:[e.jsxs("div",{className:"mesh-health-header",children:[e.jsx(p,{className:"w-4 h-4 text-accent-primary"}),e.jsx("span",{className:"type-label text-text-muted",children:"MESH HEALTH"})]}),e.jsxs("div",{className:"widget-row",children:[e.jsx(we,{}),e.jsx(Re,{}),e.jsx(Se,{}),e.jsx(Te,{}),e.jsx(Me,{}),e.jsx(Ce,{})]})]})})}function Pe(){var a,n,l,r,o,c,d,u,m;const x=w(),h=S(),p=b(),y=B(),N=T(),k=D(),[M,_]=t.useState(4),L=C[M],P=t.useMemo(()=>{var e;if(!(null==(e=null==x?void 0:x.config)?void 0:e.radio))return null;const t=x.config.radio;return{sf:t.spreading_factor??10,bw:t.bandwidth??25e4,cr:t.coding_rate??5,preamble:t.preamble_length??8}},[null==(n=null==(a=null==x?void 0:x.config)?void 0:a.radio)?void 0:n.spreading_factor,null==(r=null==(l=null==x?void 0:x.config)?void 0:l.radio)?void 0:r.bandwidth,null==(c=null==(o=null==x?void 0:x.config)?void 0:o.radio)?void 0:c.coding_rate,null==(u=null==(d=null==x?void 0:x.config)?void 0:d.radio)?void 0:u.preamble_length]),E=p.length,z=L.buckets,I=t.useMemo(()=>0===E?null:F(L.minutes,z,p,x),[E,L.minutes,z,P]),K=t.useMemo(()=>function(e,t){if(!e||0===e.length)return[];const s=t>1440;return e.map(e=>{const t=new Date(1e3*e.start);return{time:s?t.toLocaleDateString([],{weekday:"short",hour:"2-digit",minute:"2-digit",hour12:!1}):t.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hour12:!1}),received:e.count}})}(null==I?void 0:I.received,L.minutes),[null==I?void 0:I.received,L.minutes]),Q=t.useMemo(()=>{const e=K.length;return e<=12?0:e<=24?2:e<=48?5:e<=72?8:Math.floor(e/7)},[K.length]),X=t.useMemo(()=>{if(0===K.length)return[0,"auto"];const e=K.map(e=>e.received),t=Math.min(...e),s=Math.max(...e);if(t===s)return[Math.max(0,t-1),s+1];const a=.1*(s-t);return[Math.max(0,Math.floor(t-a)),Math.ceil(s+a)]},[K]),se=(null==x?void 0:x.uptime_seconds)?R(x.uptime_seconds):"0m",ae=(null==x?void 0:x.node_name)||(null==(m=null==x?void 0:x.config)?void 0:m.node_name)||"Unknown Node",ne=t.useMemo(()=>{var e,t,s,a;const n=(null==(e=null==I?void 0:I.received)?void 0:e.reduce((e,t)=>e+t.count,0))??0,l=(null==(t=null==I?void 0:I.forwarded)?void 0:t.reduce((e,t)=>e+t.count,0))??0,i=(null==(s=null==I?void 0:I.dropped)?void 0:s.reduce((e,t)=>e+t.count,0))??0,r=(null==(a=null==I?void 0:I.transmitted)?void 0:a.reduce((e,t)=>e+t.count,0))??0,o=((null==I?void 0:I.time_range_minutes)??L.minutes)/60;return{received:n,forwarded:l,dropped:i,transmitted:r,rxPerHour:o>0?Math.round(n/o):0,fwdPerHour:o>0?Math.round(l/o):0}},[I,L.minutes]);return h?e.jsxs(H,{className:"p-8 text-center",children:[e.jsx("p",{className:"type-subheading text-accent-red mb-2",children:"Failed to connect to backend"}),e.jsx("p",{className:"type-body text-white/50",children:h}),e.jsx("p",{className:"type-data-sm text-white/40 mt-4",children:"Make sure the Python backend is running on port 8000"})]}):e.jsxs($,{children:[e.jsx(A,{title:ae,icon:e.jsx(v,{}),controls:e.jsx(O,{ranges:C,selectedIndex:M,onSelect:_})}),e.jsx(te,{template:"hero",children:e.jsxs(H,{isLoaded:y,skeletonType:"chart",children:[e.jsx(W,{icon:e.jsx(i,{}),title:"RECEIVED",badge:L.label,iconColor:"text-accent-success"}),e.jsx("div",{className:"type-hero font-semibold min-h-[3rem]",style:{color:N.received},children:ne.received.toLocaleString()}),e.jsxs("div",{className:"type-body-sm text-text-secondary mt-1",children:[ne.rxPerHour,"/hr rate"]}),e.jsx("div",{className:"mt-4",children:K.length>0?e.jsx(U,{width:"100%",height:180,children:e.jsxs(q,{data:K,children:[e.jsx("defs",{children:e.jsxs("linearGradient",{id:"gradient-received",x1:"0",y1:"0",x2:"0",y2:"1",children:[e.jsx("stop",{offset:"5%",stopColor:N.received,stopOpacity:.3}),e.jsx("stop",{offset:"95%",stopColor:N.received,stopOpacity:0})]})}),e.jsx(J,{strokeDasharray:"3 3",stroke:k.grid,vertical:!1}),e.jsx(G,{dataKey:"time",axisLine:!1,tickLine:!1,tick:{fill:k.axisTick,fontSize:10,fontFamily:"'JetBrains Mono', monospace"},dy:8,interval:Q,minTickGap:20}),e.jsx(Y,{domain:X,axisLine:!1,tickLine:!1,tick:{fill:k.axisTick,fontSize:10,fontFamily:"'JetBrains Mono', monospace"},dx:-8,width:40}),e.jsx(Z,{content:e.jsx(oe,{color:N.received,labelKey:"time",unit:" packets"}),cursor:{stroke:k.cursor,strokeWidth:1}}),e.jsx(ee,{type:"stepAfter",dataKey:"received",stroke:N.received,fill:"url(#gradient-received)",strokeWidth:1,dot:!1,activeDot:{r:4,strokeWidth:0,fill:N.received},isAnimationActive:!1})]})}):e.jsx("div",{className:"h-full flex items-center justify-center text-text-muted",children:"No data available for this time range"})})]})}),e.jsxs(te,{template:"compact",children:[e.jsx(ie,{title:"FORWARDED",value:ne.forwarded,subtitle:`${ne.fwdPerHour}/hr rate`,color:"forwarded",buckets:null==I?void 0:I.forwarded,timeRangeLabel:L.label,icon:e.jsx(g,{className:"w-4 h-4"}),isLoaded:y}),e.jsx(ie,{title:"DROPPED",value:ne.dropped,subtitle:"Filtered or duplicate",color:"dropped",buckets:null==I?void 0:I.dropped,timeRangeLabel:L.label,icon:e.jsx(f,{className:"w-4 h-4"}),isLoaded:y}),e.jsx(me,{stats:x,receivedBuckets:null==I?void 0:I.received,droppedBuckets:null==I?void 0:I.dropped,forwardedBuckets:null==I?void 0:I.forwarded,bucketDurationSeconds:null==I?void 0:I.bucket_duration_seconds,timeRangeLabel:L.label,isLoaded:y}),e.jsx(ie,{title:"UPTIME",value:se,subtitle:"Since last restart",color:"neutral",icon:e.jsx(j,{className:"w-4 h-4"}),isLoaded:y})]}),e.jsx(De,{}),e.jsx(re,{}),x&&e.jsx(te,{template:"auto",children:e.jsxs(H,{children:[e.jsx(W,{icon:e.jsx(s,{}),title:"Node Information",largeTitle:!0}),e.jsxs("div",{className:"grid grid-cols-2 lg:grid-cols-4 gap-4",children:[e.jsxs("div",{children:[e.jsx("span",{className:"type-label text-text-muted",children:"Node Name"}),e.jsx("p",{className:"type-body text-text-primary mt-1",children:ae})]}),e.jsxs("div",{children:[e.jsx("span",{className:"type-label text-text-muted",children:"Version"}),e.jsxs("p",{className:"type-data text-text-primary mt-1",children:["v",x.version]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"type-label text-text-muted",children:"Core Version"}),e.jsxs("p",{className:"type-data text-text-primary mt-1",children:["v",x.core_version]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"type-label text-text-muted",children:"Local Hash"}),e.jsx("div",{className:"mt-1",children:x.local_hash?e.jsx(V,{hash:x.local_hash,size:"sm"}):e.jsx("span",{className:"type-data-sm text-text-muted",children:"N/A"})})]})]}),x.public_key&&e.jsxs("div",{className:"mt-4 pt-4 border-t border-border-subtle",children:[e.jsx("span",{className:"type-label text-text-muted",children:"Public Key"}),e.jsx("div",{className:"mt-1",children:e.jsx(V,{hash:x.public_key,prefixLength:12,suffixLength:8})})]})]})})]})}export{Pe as default};
