var Gr=Object.defineProperty;var Wr=(e,n,t)=>n in e?Gr(e,n,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[n]=t;var y=(e,n,t)=>Wr(e,typeof n!="symbol"?n+"":n,t);import{j as d,r as C,X as qr,x as Kr,d as Xr}from"./vendor-react-CHg3w57L.js";import{a as lr,c as et}from"./vendor-core-CgllfypI.js";import{D as Vr,o as Yr,L as Qr}from"./xterm-DM1Y9ba-.js";import{Z as Be,bb as P,bu as Jr,bv as re,bw as tt,bx as Zr,aG as dr,k as mr,by as en,bz as tn,bA as rn,b1 as nn,ae as ur,bB as H,a4 as sn,a3 as an,av as pe,bC as on,bD as cn,bE as ln,bF as dn,bm as Tt,Y as pr,bG as fr,_ as hr,B as mn,bH as Nt,bI as Rt,b0 as un,p as pn,bJ as fn,bK as hn,bL as gn}from"./index-B4woLUMa.js";import{h as gr,c as yn}from"./geo-utils-BP1zBK9h.js";import{a as xn}from"./ping-C2srVunZ.js";import{P as bn,c as $n}from"./payload-decoders-CXnzAzcz.js";import{g as wn,r as vn}from"./system-Cr_VsHsZ.js";import{g as Oe,B as yr,r as xr,T as br}from"./ascii-burst-DN6etEs5.js";import{P as _n,B as Cn,C as Sn}from"./PageLayout-vzO_WRlt.js";import{K as $r,S as kn}from"./KeycapButton-uU2GmxYw.js";import{aR as Et,a$ as Tn,b0 as Nn,b1 as wr,au as At,D as Rn,b2 as En}from"./vendor-icons-rRVc_l7g.js";import{A as st,m as qe}from"./vendor-motion-CXybMqb1.js";import"./cosmograph-RBQGoH9-.js";import"./vendor-charts-DuSK2RSZ.js";import"./vendor-fonts-CgDm-k6O.js";import"./keycap-sfx-ByZp-njj.js";class An{constructor(){y(this,"commands",[])}register(...n){this.commands.push(...n)}find(n){let t;for(const r of this.commands)r.matches(n)&&(!t||r.name.length>t.name.length)&&(t=r);return t}all(){return this.commands}}class j{constructor(){y(this,"aliases",[]);y(this,"params")}matches(n){const t=n.toLowerCase().trim(),r=s=>t===s||t.startsWith(s+" ");return r(this.name)||this.aliases.some(r)}argsAfterName(n){const t=n.toLowerCase().trim(),r=[this.name,...this.aliases].sort((s,a)=>a.length-s.length);for(const s of r)if(t.startsWith(s))return n.trim().slice(s.length).trim();return n.trim()}}const J="\x1B[",A=`${J}0m`,fe=`${J}1m`,jn=`${J}2m`,Ln=`${J}3m`,rt=`${J}32m`,Ae=`${J}31m`,Ue=`${J}33m`,vr=`${J}36m`,He=`${J}34m`,ve=`${J}90m`,Mn=`${J}92m`,Bn=`${J}96m`;function jt(e,n){switch(n){case"success":return`${rt}${e}${A}`;case"error":return`${Ae}${e}${A}`;case"warning":return`${Ue}${e}${A}`;case"info":return`${vr}${e}${A}`;case"value":return`${He}${e}${A}`;case"system":return`${ve}${e}${A}`;default:return e}}function ee(e){return`${fe}${e}${A}`}function q(e){return`${jn}${e}${A}`}function In(e){return`${Ue}${e}${A}`}function m(e){return`${He}${e}${A}`}function u(e){return`${ve}${e}${A}`}function p(e,n){return`${ve}${e}: ${A}${He}${fe}${n}${A}`}function h(e,n,t=22){const r=e.split(" "),s=r[0];let a=vr;s==="get"?a=rt:s==="set"&&(a=Ue);const i=r.length>1?`${a}${fe}${s}${A} ${He}${r.slice(1).join(" ")}${A}`:`${a}${fe}${e}${A}`,o=" ".repeat(Math.max(1,t-e.length));return`  ${i}${o}${ve}${n}${A}`}function _(e){return`${fe}${He}${e}${A}`}function te(e){return`${ve}${Ln}${e}${A}`}function Fn(e){return`\x1B[1;92m${e||"user"}@pyMC${A}: \x1B[38;2;91;91;214m$${A} `}function at(e){return`${Ae}${fe}●${A} ${ve}${e}${A}`}function Dn(e){return e<1500?Mn:e<4e3?rt:e<8e3?Ue:e<15e3?Ae:`${Ae}${fe}`}function On(e){const n=e<1e3?`${e.toFixed(0)}ms`:`${(e/1e3).toFixed(1)}s`;return`${Dn(e)}${n}${A}`}function wt(e){switch(e){case"excellent":return Bn;case"good":return rt;case"fair":return Ue;case"poor":return Ae;case"critical":return`${Ae}${fe}`;default:return ve}}function Pn(e,n){return`${wt(n)}${e}${A}`}function Lt(e){return e.replace(/[\p{Emoji_Presentation}\p{Extended_Pictographic}\uFE0F\u200D]/gu,"").trim()}const Ke="\x1B[2K\r";function Un(e=1){return`\x1B[${e}A`}const Hn="\x1B[K",zn="\x1B[H",Gn="\x1B[J",Wn="\x1B[?1049h",Mt="\x1B[?1049l",qn="\x1B[?25l",Bt="\x1B[?25h";function _r(e){return e.replace(/\x1b\[[0-9;]*m/g,"")}function Kn(e){return _r(e).length}function ht(e,n){let t=0;for(const r of e){const s=_r(r).length;t+=s===0?1:Math.ceil(s/n)}return t}function Xn(e){return getComputedStyle(document.documentElement).getPropertyValue(e).trim()}function Z(e,n){return Xn(e)||n}function Vn(){return document.documentElement.dataset.mode==="light"}function Cr(){const e=Vn(),n=Z("--terminal-bg","#0d0d0d"),t=Z("--sys-blue",P.blue);if(e){const v="#EFF0F1";return{background:v,foreground:"#111314",cursor:P.blue,cursorAccent:v,selectionBackground:`${P.blue}30`,selectionForeground:"#111314",black:"#111314",red:P.red,green:P.green,yellow:P.amber,blue:P.blue,magenta:P.purple,cyan:P.cyan,white:v,brightBlack:Be[500],brightRed:P.red,brightGreen:P.green,brightYellow:P.orange,brightBlue:P.indigo,brightMagenta:P.pink,brightCyan:P.teal,brightWhite:Be[600]}}const r=Z("--text-primary","#e0e0e0"),s=t+"40",a=Z("--sys-red",P.red),i=Z("--sys-green",P.green),o=Z("--sys-purple",P.purple),c=Z("--sys-blue",P.blue),l=Z("--sys-cyan",P.cyan),f=Z("--text-muted",Be[500]),x=Z("--text-secondary",Be[400]),b=Z("--bg-surface",Be[900]);return{background:n,foreground:r,cursor:t,cursorAccent:n,selectionBackground:s,selectionForeground:r,black:b,red:a,green:i,yellow:o,blue:c,magenta:o,cyan:l,white:r,brightBlack:f,brightRed:a,brightGreen:"#4ADE80",brightYellow:o,brightBlue:c,brightMagenta:o,brightCyan:l,brightWhite:x}}function Yn(e){return Jr.subscribe(()=>{e.options.theme=Cr()})}const ze="\x1B[",he=`${ze}0m`,Qn=`${ze}1m`,Jn=`${ze}2m`,Sr=`${ze}34m`,Ge=`${ze}90m`,ot=24,it=13,It="  ",Ft="        ",Zn=[{label:"INFORMATION",entries:[{cmd:"status",desc:"Repeater status summary",alias:"st"},{cmd:"top",desc:"Live system overview (Ctrl+C to exit)",alias:"htop"},{cmd:"ver",desc:"Version info",alias:"version"},{cmd:"clock",desc:"System UTC time"},{cmd:"uptime",desc:"System uptime"},{cmd:"board",desc:"Board / platform info"},{cmd:"packets",desc:"Packet statistics"},{cmd:"stats-packets",desc:"Packet counters (firmware compat)"},{cmd:"stats-radio",desc:"Radio health stats (firmware compat)"},{cmd:"stats-core",desc:"Engine vitals (firmware compat)"}]},{label:"NETWORK",entries:[{cmd:"neighbors [sort]",desc:"Direct RF neighbors",alias:"nb",sub:"sig · name · rssi · snr · dist · heard"},{cmd:"ping {name}",desc:"Ping neighbor (name or 0xXX)"},{cmd:"identities",desc:"List configured identities",alias:"id ids"},{cmd:"keys",desc:"Transport keys"},{cmd:"acl",desc:"ACL statistics"},{cmd:"rooms",desc:"Room statistics"}]},{label:"RADIO",entries:[{cmd:"get {param}",desc:"Read parameter"},{cmd:"set {param} {value}",desc:"Write parameter"},{cmd:"advert",desc:"Send advertisement"}]},{label:"SYSTEM",entries:[{cmd:"restart",desc:"Restart service",alias:"reboot"},{cmd:"start cap [seconds]",desc:"Start packet capture"},{cmd:"end cap",desc:"Stop capture"},{cmd:"list cap",desc:"List captures"},{cmd:"export cap [id]",desc:"Download capture"}]},{label:"TOOLS",entries:[{cmd:"convert hex {value}",desc:"Hex → base64"},{cmd:"convert base64 {value}",desc:"Base64 → hex"},{cmd:"clear",desc:"Clear terminal",alias:"cls"},{cmd:"help [command]",desc:"Show this help",alias:"? h"}]}],es=[{cat:"Identity",params:["name","role","lat","lon","public.key"]},{cat:"Radio",params:["radio","freq","tx","bw","sf","cr"]},{cat:"Timing",params:["txdelay","direct.txdelay","rxdelay"]},{cat:"Repeater",params:["mode","duty","repeat","flood.max","advert.interval"]},{cat:"Advanced",params:["multi.acks","int.thresh","agc.reset.interval"]},{cat:"set only",params:["log","prv.key"]}];function kr(e){return`${Ge}${"─".repeat(e)}${he}`}function ts(e){const n="pymc console",t="terminal",r=Math.max(3,e-n.length-t.length-6);return`  ${Sr}${Qn}${n}${he} ${kr(r)} ${Ge}${t}${he}`}function Tr(e){return`  ${Ge}${e}${he}`}function rs(e,n){const t=[],r=e.alias?`  ${Jn}${e.alias}${he}`:"";return 4+Math.max(e.cmd.length,ot)+e.desc.length+(e.alias?2+e.alias.length:0)<=n?t.push(It+h(e.cmd,e.desc,ot)+r):(t.push(It+h(e.cmd,"",ot)),t.push(Ft+u(e.desc)+r)),e.sub&&t.push(`${Ft}${q("└ "+e.sub)}`),t}function Dt(e){return e.split(" · ").map(n=>`${Sr}${n}${he}`).join(`${Ge} · ${he}`)}function ns(e,n){const r=[];let s=[],a=0;for(const i of e){const o=s.length>0?3+i.length:i.length;a+o>n&&s.length>0?(r.push(s),s=[i],a=i.length):(s.push(i),a+=o)}return s.length>0&&r.push(s),r}function ss(e){const n=["",Tr("GET/SET QUALIFIERS")],t=Math.max(20,e-4-it);for(const r of es){const s=`${Ge}${r.cat.padEnd(it)}${he}`,a=ns(r.params,t),i=" ".repeat(4+it);n.push(`    ${s}${Dt(a[0].join(" · "))}`);for(let o=1;o<a.length;o++)n.push(`${i}${Dt(a[o].join(" · "))}`)}return n}function as(e){const n=Math.min(e-4,56);return[`  ${kr(n)}`,`  ${te("<command> help for detailed usage")}`]}class os extends j{constructor(t){super();y(this,"name","help");y(this,"description","Show available commands");y(this,"aliases",["?","h"]);this.registry=t}execute({output:t,rawInput:r,cols:s}){const a=this.argsAfterName(r).toLowerCase().trim();if(a&&a!=="help"){const o=this.registry.find(a+" help")||this.registry.find(a);if(o){o.execute({output:t,rawInput:o.name+" help",args:[o.name,"help"],cols:s,signal:new AbortController().signal});return}t.write(`Unknown command: ${m(a)}`,"warning");return}const i=[ts(s),""];for(const o of Zn){i.push(Tr(o.label));for(const c of o.entries)i.push(...rs(c,s));o.label==="RADIO"&&i.push(...ss(s)),i.push("")}i.push(...as(s)),t.write(i.join(`
`))}}class is extends j{constructor(){super(...arguments);y(this,"name","clear");y(this,"description","Clear terminal screen");y(this,"aliases",["cls"])}execute({output:t,rawInput:r}){if(this.argsAfterName(r).toLowerCase().trim()==="help"){t.write([_("clear"),`  ${u("Clear all terminal output.")}`,"",h("clear","clear the screen"),"",_("Aliases"),`  ${u("cls")}`].join(`
`));return}t.clear()}}function vt(e){const n=Math.floor(e/86400),t=Math.floor(e%86400/3600),r=Math.floor(e%3600/60);return n>0?`${n}d ${t}h ${r}m`:t>0?`${t}h ${r}m`:`${r}m`}class cs extends j{constructor(){super(...arguments);y(this,"name","status");y(this,"description","Get repeater status summary");y(this,"aliases",["st"])}async execute({output:t,rawInput:r}){var a,i,o;if(this.argsAfterName(r).toLowerCase().trim()==="help"){t.write([_("status"),`  ${u("Show a quick summary of mode, neighbor count, and uptime.")}`,"",h("status","show summary"),"",_("Aliases"),`  ${u("st")}`].join(`
`));return}const s=t.write("processing...","system");try{const c=await re(),l=((i=(a=c.config)==null?void 0:a.repeater)==null?void 0:i.mode)||"unknown",f=Object.keys(c.neighbors||{}).length,x=Object.values(c.neighbors||{}).filter(w=>w.zero_hop).length,b=((o=c.config)==null?void 0:o.node_name)||c.node_name||"unknown",v=vt(c.uptime_seconds||0);t.update(s,[`${ee(b)}  ${u("repeater")}`,"",`  ${p("Mode",m(l))}`,`  ${p("Neighbors",`${m(String(x))} direct  ${u(`${f} total`)}`)}`,`  ${p("RX / TX",`${m(String(c.rx_count??0))} / ${m(String(c.tx_count??0))}`)}`,`  ${p("Uptime",m(v))}`].join(`
`))}catch(c){t.update(s,`Error: ${c instanceof Error?c.message:"Command failed"}`,"error")}}}class ls extends j{constructor(){super(...arguments);y(this,"name","uptime");y(this,"description","Show system uptime")}async execute({output:t,rawInput:r}){if(this.argsAfterName(r).toLowerCase().trim()==="help"){t.write([_("uptime"),`  ${u("Display how long the repeater service has been running.")}`,"",h("uptime","show uptime")].join(`
`));return}const s=t.write("processing...","system");try{const a=await re();t.update(s,p("Uptime",m(vt(a.uptime_seconds||0))))}catch(a){t.update(s,`Error: ${a instanceof Error?a.message:"Command failed"}`,"error")}}}class ds extends j{constructor(){super(...arguments);y(this,"name","packets");y(this,"description","Show packet statistics")}async execute({output:t,rawInput:r}){if(this.argsAfterName(r).toLowerCase().trim()==="help"){t.write([_("packets"),`  ${u("Display packet counters (received, transmitted, forwarded, dropped).")}`,"",h("packets","show packet stats")].join(`
`));return}const s=t.write("processing...","system");try{const a=await re(),i=(a.rx_count??0)+(a.tx_count??0);t.update(s,[_("Packet Stats")+`  ${u(`${i} total`)}`,"",`  ${p("Received",m(String(a.rx_count??0)))}`,`  ${p("Transmitted",m(String(a.tx_count??0)))}`,`  ${p("Forwarded",m(String(a.forwarded_count??0)))}`,`  ${p("Dropped",m(String(a.dropped_count??0)))}`].join(`
`))}catch(a){t.update(s,`Error: ${a instanceof Error?a.message:"Command failed"}`,"error")}}}function Se(e){return e>=1073741824?`${(e/1073741824).toFixed(1)} GB`:e>=1048576?`${(e/1048576).toFixed(0)} MB`:`${(e/1024).toFixed(0)} KB`}function ct(e){const n=Math.floor(e/86400),t=Math.floor(e%86400/3600),r=Math.floor(e%3600/60);return n>0?`${n}d ${t}h ${r}m`:t>0?`${t}h ${r}m`:`${r}m`}class ms extends j{constructor(){super(...arguments);y(this,"name","board");y(this,"description","Show board/platform info")}async execute({output:t,rawInput:r}){var a;if(this.argsAfterName(r).toLowerCase().trim()==="help"){t.write([_("board"),`  ${u("Display platform and hardware information.")}`,"",h("board","show board info")].join(`
`));return}const s=t.write("loading...","system");try{const[i,o]=await Promise.all([tt(),re()]),c=[];if(c.push(`  ${p("Node",m(o.node_name||"Unknown"))}`),c.push(`  ${p("Runtime",m(`pyMC_Repeater v${o.version||"?"}`))}`),o.core_version&&c.push(`  ${p("Core",m(o.core_version))}`),c.push(""),i.success&&i.data){const l=i.data;c.push(`  ${p("CPU",m(`${l.cpu.usage_percent.toFixed(1)}%`))}  ${u(`${l.cpu.count} core${l.cpu.count>1?"s":""}`)}`),l.cpu.load_avg&&c.push(`  ${p("Load",m(`${l.cpu.load_avg["1min"].toFixed(2)} / ${l.cpu.load_avg["5min"].toFixed(2)} / ${l.cpu.load_avg["15min"].toFixed(2)}`))}`);const f=Object.entries(l.temperatures||{});if(f.length>0){const x=f[0];c.push(`  ${p("Temp",m(`${x[1].toFixed(1)}°C`))}${f.length>1?`  ${u(f.slice(1).map(([b,v])=>`${b}: ${v.toFixed(1)}°C`).join(", "))}`:""}`)}c.push(""),c.push(`  ${p("Memory",m(`${Se(l.memory.used)} / ${Se(l.memory.total)}`))}  ${u(`${l.memory.usage_percent.toFixed(0)}%`)}`),c.push(`  ${p("Disk",m(`${Se(l.disk.used)} / ${Se(l.disk.total)}`))}  ${u(`${l.disk.usage_percent.toFixed(0)}%`)}`),c.push(""),(a=l.system)!=null&&a.uptime&&c.push(`  ${p("System uptime",m(ct(l.system.uptime)))}`),c.push(`  ${p("Service uptime",m(ct(o.uptime_seconds)))}`),l.network&&c.push(`  ${p("Net TX/RX",m(`${Se(l.network.bytes_sent)} / ${Se(l.network.bytes_recv)}`))}`)}else c.push(`  ${p("Platform",m("Linux"))}`),c.push(`  ${p("Service uptime",m(ct(o.uptime_seconds)))}`),c.push(`  ${u("Hardware stats unavailable")}`);t.update(s,c.join(`
`),"value")}catch(i){t.update(s,`Error: ${i instanceof Error?i.message:"Failed to load hardware stats"}`,"error")}}}const Ve="\x1B[0m",Ye="\x1B[1m",gt="\x1B[2m",Ot="\x1B[36m",Pt="\x1B[96m",us="\x1B[97m",ps="\x1B[93m",Y=48,fs=14,me=22,De=5,Qe=22,hs=5,gs=me+De+Qe+hs,ys=50;function Nr(e,n,t,r){return s=>{if(s<=0)return 0;if(s>=1)return 1;let a=s;for(let i=0;i<8;i++){const o=3*(1-a)*(1-a)*a*e+3*(1-a)*a*a*t+a*a*a-s,c=3*(1-a)*(1-a)*e+6*(1-a)*a*(t-e)+3*a*a*(1-t);if(Math.abs(c)<1e-7)break;a=Math.max(0,Math.min(1,a-o/c))}return 3*(1-a)*(1-a)*a*n+3*(1-a)*a*a*r+a*a*a}}const xs=Nr(.25,1,.5,1),bs=Nr(.4,0,1,1);function $s(e,n){const t=e%fs;return Math.sin(.45*t+.04*t*t+n*.25)}const ws=[1,2,4,64],vs=[8,16,32,128],Ut=ws.map((e,n)=>e|vs[n]);function Ne(e,n,t,r){r<4?e[t]|=Ut[r]:n[t]|=Ut[r-4]}function _s(e){return e>.8?us+Ye:e>.6?ps+Ye:e>.4?Pt+Ye:e>.2?Pt:e>.08?Ot:Ot+gt}function Ht(e,n,t){const r=new Uint8Array(Y),s=new Uint8Array(Y),a=new Float32Array(Y),i=e*.35;for(let o=0;o<Y;o++){const c=t?Y-1-o:o;if(c>=n)continue;const l=n-c,f=Math.min(1,l/3),x=Math.min(1,c/2),b=l<5?1+.3*(1-l/5):1,v=Math.min(1,f*x*b);if(v<.04)continue;const w=1+.06*Math.sin(e*.7+c*.3),T=$s(c,i)*v*w*3.5+3.5,B=Math.abs(T-3.5)/3.5,M=l<6?1-l/6:0;a[o]=Math.min(1,B*.65+M*.35)*v;const D=Math.max(0,Math.min(7,Math.round(T)));if(T>=3.5){for(let R=3;R<=D;R++)Ne(r,s,o,R);const I=Math.round((T-3.5)*.4);for(let R=Math.max(0,3-I);R<3;R++)Ne(r,s,o,R)}else{for(let R=D;R<=4;R++)Ne(r,s,o,R);const I=Math.round((3.5-T)*.4);for(let R=5;R<=Math.min(7,4+I);R++)Ne(r,s,o,R)}}return{top:r,bot:s,heat:a}}function zt(e,n,t){const r=new Uint8Array(Y),s=new Uint8Array(Y),a=new Float32Array(Y),i=Math.exp(-n*.5),o=Math.max(0,10-n*2.5),c=.7+n*.2;for(let l=0;l<Math.ceil(o);l++){const f=e?Y-1-l:l;if(f<0||f>=Y)continue;const x=i*(1-l/o);if(x<.04)continue;a[f]=x;const v=Math.sin(l*c+t*.6)*x*3.5+3.5,w=Math.max(0,Math.min(7,Math.round(v)));if(v>=3.5)for(let k=3;k<=w;k++)Ne(r,s,f,k);else for(let k=w;k<=4;k++)Ne(r,s,f,k)}return{top:r,bot:s,heat:a}}function Gt(e,n){let t="",r="";for(let s=0;s<Y;s++){const a=String.fromCodePoint(10240+e[s]),i=e[s]?_s(n[s]):"";i!==r&&(t+=i,r=i),t+=a}return t+Ve}function Wt(e,n,t){const r=e%gs;let s,a,i;if(r<me){const l=r/(me-1);({top:s,bot:a,heat:i}=Ht(e,Math.round(xs(l)*Y),!1))}else if(r<me+De)({top:s,bot:a,heat:i}=zt(!0,r-me,e));else if(r<me+De+Qe){const l=(r-me-De)/(Qe-1);({top:s,bot:a,heat:i}=Ht(e,Math.round(bs(l)*Y),!0))}else({top:s,bot:a,heat:i}=zt(!1,r-me-De-Qe,e));const o=(t/1e3).toFixed(1),c=`${gt} ── chirp → ${Ve}${Ye}${n}${Ve}${gt} ── ${o}s${Ve}`;return[Gt(s,i),Gt(a,i),c]}function Rr(e,n){const t=Date.now();let r=0;const s=e.write(Wt(0,n,0).join(`
`)),a=setInterval(()=>{r++,e.update(s,Wt(r,n,Date.now()-t).join(`
`))},ys);return{id:s,stop:()=>clearInterval(a)}}class Cs extends j{constructor(){super(...arguments);y(this,"name","advert");y(this,"description","Send repeater advertisement")}async execute({output:t,rawInput:r}){if(this.argsAfterName(r).toLowerCase().trim()==="help"){t.write([_("advert"),`  ${u("Broadcast a repeater advertisement to the mesh network.")}`,"",h("advert","send advert now"),"",te("Adverts announce this repeater's presence to neighbors.")].join(`
`));return}const s=Rr(t,"broadcast");try{const a=await Zr();s.stop(),a.success?t.update(s.id,`✓ ${m("Advert sent")}`,"success"):t.update(s.id,`Error: ${a.error||"Failed"}`,"error")}catch(a){s.stop(),t.update(s.id,`Error: ${a instanceof Error?a.message:"Command failed"}`,"error")}}}const Ss=["sig","name","rssi","snr","dist","heard"],qt={excellent:5,good:4,fair:3,poor:2,critical:1};function Kt(e){const n=Math.floor(Date.now()/1e3-e);return n<60?`${n}s ago`:n<3600?`${Math.floor(n/60)}m ago`:n<86400?`${Math.floor(n/3600)}h ago`:`${Math.floor(n/86400)}d ago`}function ks(e,n){return e.length>=n?e.slice(0,n):e+" ".repeat(n-e.length)}function Xt(e){return e<1e3?`${Math.round(e)}m`:`${(e/1e3).toFixed(1)}km`}const Ts={excellent:5,good:4,fair:3,poor:2,critical:1};function Vt(e){const n=Ts[e]??0,t=wt(e),r=n>0?`${t}${"█".repeat(n)}${A}`:"",s=u("⣿".repeat(5-n));return r+s}const Yt=3.5;function Ns(e){var t;const n=(t=e.config)==null?void 0:t.radio;return!(n!=null&&n.spreading_factor)||!(n!=null&&n.bandwidth)?null:{sf:n.spreading_factor,bwHz:n.bandwidth}}function Rs(e){var t;const n=(t=e.config)==null?void 0:t.repeater;return!n||!gr(n.latitude,n.longitude)?null:{lat:n.latitude,lon:n.longitude}}function ke(e,n=t=>t){return{text:e,color:n}}function Es(e,n){return{text:e,color:t=>t,rendered:n}}function lt(e){return u("+"+e.map(n=>"-".repeat(n+2)).join("+")+"+")}function Qt(e,n){const t=e.map((r,s)=>{if(r.rendered!=null){const a=Math.max(0,n[s]-r.text.length);return" "+r.rendered+" ".repeat(a)+" "}return" "+r.color(ks(r.text,n[s]))+" "});return u("|")+t.join(u("|"))+u("|")}const As=70,js=55;class Ls extends j{constructor(){super(...arguments);y(this,"name","neighbors");y(this,"description","Show direct RF neighbors with signal stats");y(this,"aliases",["nb","get neighbors","get neighbor"]);y(this,"params","[sig|name|rssi|snr|dist|heard]")}async execute(t){const{output:r,cols:s}=t,a=this.argsAfterName(t.rawInput).toLowerCase().trim();if(a==="help"){this.printUsage(r);return}const i=Ss.includes(a)?a:null,o=r.write("processing...","system");try{const c=await re(),l=c.neighbors||{},f=Object.entries(l).filter(([,T])=>T.zero_hop);if(f.length===0){const T=Object.keys(l).length;r.update(o,T>0?`No direct neighbors. ${T} relayed neighbor${T!==1?"s":""} known.`:"No neighbors discovered yet.","warning");return}const x=Ns(c),b=Rs(c),v=c.noise_floor_dbm;this.sortNeighbors(f,i,x,b,v);const w=i?`  ${q(`sorted by ${i}`)}`:"",k=[_(`Direct Neighbors (${f.length})`)+w,""];if(s<js)for(const[T,B]of f)k.push(...this.cardLayout(T,B,x,b,v));else{const T=s>=As&&b!=null,B=f.map(([U,ae])=>this.buildRow(U,ae,x,b,v,T)),M=T?["SIG","NAME","RSSI","SNR","DIST","HEARD"]:["SIG","NAME","RSSI","SNR","HEARD"],D=M.slice(1).map((U,ae)=>Math.max(U.length,...B.map(oe=>oe[ae+1].text.length))),I=5,R=D.reduce((U,ae)=>U+ae+3,0),le=Math.max(4,s-R-I-7),je=Math.min(le,Math.max(4,...B.map(U=>U[1].text.length))),Q=[I,je,...D.slice(1)];k.push(lt(Q),...B.map(U=>Qt(U,Q)),lt(Q),Qt(M.map(U=>ke(U,ee)),Q),lt(Q)),k.push(this.footer(x,v))}r.update(o,k.join(`
`))}catch(c){r.update(o,`Error: ${c instanceof Error?c.message:"Command failed"}`,"error")}}sortNeighbors(t,r,s,a,i){switch(r){case"sig":t.sort(([,o],[,c])=>{const l=qt[this.gradeNeighbor(o,s,i)]??0,f=qt[this.gradeNeighbor(c,s,i)]??0;return l-f});break;case"name":t.sort(([o,c],[l,f])=>{const x=(c.name||c.node_name||o.slice(0,8)).toLowerCase(),b=(f.name||f.node_name||l.slice(0,8)).toLowerCase();return x.localeCompare(b)});break;case"rssi":t.sort(([,o],[,c])=>(o.rssi??-999)-(c.rssi??-999));break;case"snr":t.sort(([,o],[,c])=>(o.snr??-999)-(c.snr??-999));break;case"dist":t.sort(([,o],[,c])=>{const l=this.distTo(o,a)??1/0,f=this.distTo(c,a)??1/0;return l-f});break;case"heard":t.sort(([,o],[,c])=>(o.last_seen||0)-(c.last_seen||0));break;default:t.sort(([,o],[,c])=>(c.last_seen||0)-(o.last_seen||0))}}gradeNeighbor(t,r,s){const a=t.rssi!=null?t.rssi-Yt:null,i=s!=null&&s>-100?1:0,o=dr(t.snr??null,a,r,i);return(o==null?void 0:o.finalGrade)??"critical"}distTo(t,r){return!r||!gr(t.latitude,t.longitude)?null:yn(r.lat,r.lon,t.latitude,t.longitude)}buildRow(t,r,s,a,i,o){const c=this.gradeNeighbor(r,s,i),l=Lt(r.name||r.node_name||t.slice(0,8))||t.slice(0,8),f=r.rssi!=null?`${r.rssi} dBm`:"-",x=r.snr!=null?`${r.snr} dB`:"-",b=r.last_seen?Kt(r.last_seen):"-",v=Vt(c),w=[Es("|||||",v),ke(l,ee),ke(f,m),ke(x,m)];if(o){const k=this.distTo(r,a);w.push(ke(k!=null?Xt(k):"-",q))}return w.push(ke(b,q)),w}cardLayout(t,r,s,a,i){const o=this.gradeNeighbor(r,s,i),c=Lt(r.name||r.node_name||t.slice(0,8))||t.slice(0,8),l=r.rssi!=null?`${r.rssi}`:"-",f=r.snr!=null?`${r.snr}`:"-",x=r.last_seen?Kt(r.last_seen):"-",b=this.distTo(r,a),v=b!=null?`  ${u("dist")} ${m(Xt(b))}`:"";return[`${Vt(o)} ${ee(c)}`,`  ${u("rssi")} ${m(l)}  ${u("snr")} ${m(f)}${v}  ${q(x)}`,""]}footer(t,r){const s=[];return t&&s.push(`SF${t.sf}/${t.bwHz>=1e3?t.bwHz/1e3+"kHz":t.bwHz+"Hz"}`),s.push(`ant ${Yt}dBi`),r!=null&&s.push(`nf ${r}dBm`),u(s.join("  "))}printUsage(t){const r=[_("neighbors"),`  ${u("Show direct RF neighbors with signal quality, RSSI, SNR, and distance.")}`,"",_("Usage"),h("neighbors","default sort (most recent)"),h("neighbors sig","sort by signal grade (weakest first)"),h("neighbors name","sort alphabetically"),h("neighbors rssi","sort by RSSI (weakest first)"),h("neighbors snr","sort by SNR (lowest first)"),h("neighbors dist","sort by distance (closest first)"),h("neighbors heard","sort by last seen (oldest first)"),h("neighbors help","show this help"),"",_("Aliases"),`  ${u("nb, get neighbors, get neighbor")}`,"",te("Signal bars factor radio config, noise floor, and 3.5 dBi antenna gain."),te("Only zero-hop (direct RF) neighbors are shown.")];t.write(r.join(`
`))}}class Ms extends j{constructor(){super(...arguments);y(this,"name","get");y(this,"description","Get repeater parameter");y(this,"params","{parameter}")}async execute({output:t,rawInput:r}){const s=this.argsAfterName(r).toLowerCase().trim();if(s==="help"||!s){t.write([_("get"),`  ${u("Read a repeater configuration parameter.")}`,"",_("Identity"),h("get name","node name"),h("get role","node role"),h("get public.key","public key"),"",_("Location"),h("get lat","latitude"),h("get lon","longitude"),"",_("Radio"),h("get radio","full radio summary"),h("get freq","frequency (MHz)"),h("get tx","TX power (dBm)"),h("get bw","bandwidth (kHz)"),h("get sf","spreading factor"),h("get cr","coding rate"),"",_("Timing"),h("get af","airtime factor (pending backend)"),h("get txdelay","TX delay factor"),h("get direct.txdelay","direct TX delay"),h("get rxdelay","RX delay base"),"",_("Repeater"),h("get mode","forward or monitor"),h("get flood.max","max flood hops"),h("get advert.interval","advert interval"),h("get duty","duty cycle state"),"",_("Advanced"),h("get multi.acks","multi-ack count"),h("get int.thresh","interference threshold (dBm)"),h("get agc.reset.interval","AGC reset interval")].join(`
`));return}const a=t.write("processing...","system");try{const i=await re(),{result:o,type:c}=Bs(s,i);t.update(a,o,c)}catch(i){t.update(a,`Error: ${i instanceof Error?i.message:"Command failed"}`,"error")}}}function Bs(e,n){const t=n.config||{},r=t.radio||{},s=t.repeater||{},a=t.delays||{},i=t.duty_cycle||{},o=(c,l)=>({result:p(c,m(l)),type:"value"});switch(e){case"name":return o("name",t.node_name||"Unknown");case"role":return o("role","repeater");case"lat":return o("lat",s.latitude!=null?String(s.latitude):"not set");case"lon":return o("lon",s.longitude!=null?String(s.longitude):"not set");case"freq":return o("freq",r.frequency?`${(r.frequency/1e6).toFixed(3)} MHz`:"?");case"tx":return o("tx",r.tx_power!=null?`${r.tx_power} dBm`:"?");case"bw":return o("bw",r.bandwidth?`${r.bandwidth/1e3} kHz`:"?");case"sf":return o("sf",String(r.spreading_factor??"?"));case"cr":return o("cr",r.coding_rate?`4/${r.coding_rate}`:"?");case"radio":return r.frequency?{result:[`  ${p("freq",m(`${(r.frequency/1e6).toFixed(3)} MHz`))}`,`  ${p("bw",m(`${r.bandwidth/1e3} kHz`))}`,`  ${p("sf",m(String(r.spreading_factor)))}`,`  ${p("cr",m(`4/${r.coding_rate}`))}`,`  ${p("tx",m(`${r.tx_power} dBm`))}`].join(`
`),type:"value"}:o("radio","?");case"af":case"airtime.factor":return{result:`${u("airtime_factor is not yet exposed by the pyMC_Repeater API.")}
${u("Firmware range: 0-9. Controls airtime budget fraction.")}
${u("Tracked in CLI-Alignment.md — needs backend support.")}`,type:"warning"};case"txdelay":return o("txdelay",String(a.tx_delay_factor??"1.0"));case"direct.txdelay":return o("direct.txdelay",String(a.direct_tx_delay_factor??"0.5"));case"rxdelay":return o("rxdelay",String(a.rx_delay_base??"0.0"));case"mode":return o("mode",s.mode||"forward");case"repeat":return o("repeat",s.mode==="forward"?"on":"off");case"flood.max":return o("flood.max",String(s.max_flood_hops??"3"));case"flood.advert.interval":return o("flood.advert.interval",s.send_advert_interval_hours!=null?`${s.send_advert_interval_hours}h`:"?");case"advert.interval":return o("advert.interval",s.advert_interval_minutes!=null?`${s.advert_interval_minutes}m`:"120m");case"duty":case"duty.enabled":return o("duty",i.enforcement_enabled?"on":"off");case"duty.max":return o("duty.max",i.max_airtime_percent!=null?`${i.max_airtime_percent}%`:"?");case"multi.acks":return o("multi.acks",String(s.multi_acks??"0"));case"int.thresh":return o("int.thresh",`${s.interference_threshold??-120} dBm`);case"agc.reset.interval":return o("agc.reset.interval",String(s.agc_reset_interval??"0"));case"public.key":return o("public.key",n.public_key||"not available");case"prv.key":return{result:`${u("Private key stored in /etc/pymc_repeater/config.yaml")}

  ${p("view",m("sudo grep identity_key /etc/pymc_repeater/config.yaml"))}
  ${p("set",m("sudo ./convert_firmware_key.sh <64-byte-hex>"))}`,type:"info"};case"guest.password":case"allow.read.only":return{result:`${u("Security settings not exposed via stats API.")}
${u("Check /etc/pymc_repeater/config.yaml")}`,type:"warning"};default:return{result:`Unknown parameter: ${m(e)}
${u('Run "get help" to see available parameters.')}`,type:"error"}}}class Is extends j{constructor(){super(...arguments);y(this,"name","set");y(this,"description","Set repeater parameter");y(this,"params","{parameter} {value}")}async execute({output:t,rawInput:r}){var l;const a=this.argsAfterName(r).split(/\s+/),i=(l=a[0])==null?void 0:l.toLowerCase(),o=a.slice(1).join(" ");if(i==="help"||!i){t.write([_("set"),`  ${u("Write a repeater configuration parameter.")}`,"",_("Identity"),h("set name <name>","node name"),h("set lat <deg>","latitude (-90 to 90)"),h("set lon <deg>","longitude (-180 to 180)"),"",_("Radio"),h("set freq <MHz>","frequency"),h("set tx <dBm>","TX power (2-22)"),h("set bw <kHz>","bandwidth"),h("set sf <5-12>","spreading factor"),h("set cr <5-8>","coding rate"),"",_("Timing"),h("set af <0-9>","airtime factor (pending backend)"),h("set txdelay <0-5>","TX delay factor"),h("set direct.txdelay <0-5>","direct TX delay"),h("set rxdelay <n>","RX delay base"),"",_("Repeater"),h("set mode <fwd|mon>","forward or monitor"),h("set flood.max <0-64>","max flood hops"),h("set advert.interval <m>","advert interval (min)"),h("set duty <on|off>","duty cycle enforcement"),h("set log <level>","log level"),"",_("Advanced"),h("set multi.acks <n>","multi-ack count"),h("set int.thresh <dBm>","interference threshold"),h("set agc.reset.interval <n>","AGC reset interval (x4)"),"",te("Some changes require a service restart.")].join(`
`));return}const c=t.write("processing...","system");try{const{result:f,type:x}=await Fs(i,o,r);t.update(c,f,x)}catch(f){t.update(c,`Error: ${f instanceof Error?f.message:"Command failed"}`,"error")}}}async function Fs(e,n,t){switch(e){case"mode":return Ds(n);case"duty":return Os(n);case"tx":return V("tx_power",Te(n,2,22,"TX power must be 2-22 dBm"));case"sf":return V("spreading_factor",Te(n,5,12,"SF must be 5-12"));case"af":case"airtime.factor":return{result:`Error: airtime_factor is not yet exposed by the pyMC_Repeater API.
Firmware range: 0-9. Tracked in CLI-Alignment.md — needs backend support.`,type:"info"};case"txdelay":return V("tx_delay_factor",Ie(n,0,5,"TX delay must be 0.0-5.0"));case"direct.txdelay":return V("direct_tx_delay_factor",Ie(n,0,5,"Direct TX delay must be 0.0-5.0"));case"rxdelay":return V("rx_delay_base",Us(n,0,"RX delay must be >= 0"));case"flood.max":return V("max_flood_hops",Te(n,0,64,"Max flood hops must be 0-64"));case"log":return Ps(n);case"multi.acks":return V("multi_acks",Te(n,0,255,"Multi-acks must be 0-255"));case"int.thresh":return V("interference_threshold",Te(n,-200,0,"Interference threshold must be -200 to 0 dBm"));case"agc.reset.interval":{const r=mt(n);if(!r.ok)return F(r.error);if(r.value<0)return F("AGC reset interval must be >= 0");const s=Math.floor(r.value/4)*4;return dt("agc_reset_interval",s,`OK - AGC reset interval set to ${s}${s!==r.value?` (rounded from ${r.value})`:""}`)}case"name":{const r=t.trim().substring(t.toLowerCase().indexOf("name")+5).trim();return r?/[\[\]\\/\\:,?*]/.test(r)?F("Name contains invalid characters: [ ] \\ / : , ? * are not allowed"):V("node_name",{ok:!0,value:r}):F("Node name cannot be empty")}case"lat":return V("latitude",Ie(n,-90,90,"Latitude must be -90 to 90"));case"lon":return V("longitude",Ie(n,-180,180,"Longitude must be -180 to 180"));case"freq":{const r=Ie(n,100,1e3,"Frequency must be 100-1000 MHz");return r.ok?V("frequency",{ok:!0,value:r.value*1e6}):F(r.error)}case"bw":{const r=[7.8,10.4,15.6,20.8,31.25,41.7,62.5,125,250,500],s=parseFloat(n);return isNaN(s)||!r.includes(s)?F(`BW must be one of: ${r.join(", ")} kHz`):V("bandwidth",{ok:!0,value:s*1e3})}case"cr":return V("coding_rate",Te(n,5,8,"Coding rate must be 5-8"));case"advert.interval":{const r=mt(n);return r.ok?r.value!==0&&(r.value<1||r.value>10080)?F("Advert interval must be 0 (off) or 1-10080 minutes"):dt("advert_interval_minutes",r.value,r.value===0?"OK - Local adverts disabled":`OK - Local advert interval set to ${r.value}m`):F(r.error)}case"flood.advert.interval":{const r=mt(n);return r.ok?r.value!==0&&(r.value<3||r.value>168)?F("Flood advert interval must be 0 (off) or 3-168 hours"):dt("flood_advert_interval_hours",r.value,r.value===0?"OK - Flood adverts disabled":`OK - Flood advert interval set to ${r.value}h`):F(r.error)}case"prv.key":{const r=n.trim();return r?/^[0-9a-fA-F]+$/.test(r)?r.length!==128?F(`Key must be 64 bytes (128 hex chars), got ${r.length} chars`):{result:`To set this key, run on the Pi:

  sudo ./convert_firmware_key.sh ${r}

Then restart: sudo systemctl restart pymc-repeater`,type:"info"}:F("Private key must be a hex string"):F("Private key cannot be empty")}default:return F(`Unknown parameter: ${e}`)}}async function Ds(e){const n=e.toLowerCase();return n!=="forward"&&n!=="monitor"?F('Mode must be "forward" or "monitor"'):(await rn(n)).success?We(`OK - Mode set to ${n}`):F("Failed")}async function Os(e){const n=e.toLowerCase()==="on"||e==="1";return(await tn(n)).success?We(`OK - Duty cycle ${n?"enabled":"disabled"}`):F("Failed")}async function Ps(e){const n=e.toUpperCase();if(!["DEBUG","INFO","WARNING","ERROR"].includes(n))return F("Level must be debug, info, warning, or error");const t=await en(n);return t.success?We(`OK - Log level set to ${n}`):F(t.error||"Failed")}async function V(e,n){if(!n.ok)return F(n.error);const t=await mr({[e]:n.value});if(!t.success)return F(t.error||"Failed");let r=`OK - ${e} set to ${n.value}`;return t.restart_required&&(r+=`
⚠ Service restart required for changes to take effect
Run: sudo systemctl restart pymc_repeater`),We(r)}async function dt(e,n,t){const r=await mr({[e]:n});if(!r.success)return F(r.error||"Failed");let s=t;return r.restart_required&&(s+=`
⚠ Service restart required for changes to take effect
Run: sudo systemctl restart pymc_repeater`),We(s)}function Te(e,n,t,r){const s=parseInt(e);return isNaN(s)||s<n||s>t?{ok:!1,error:`Error: ${r}`}:{ok:!0,value:s}}function Ie(e,n,t,r){const s=parseFloat(e);return isNaN(s)||s<n||s>t?{ok:!1,error:`Error: ${r}`}:{ok:!0,value:s}}function Us(e,n,t){const r=parseFloat(e);return isNaN(r)||r<n?{ok:!1,error:`Error: ${t}`}:{ok:!0,value:r}}function mt(e){const n=parseInt(e);return isNaN(n)?{ok:!1,error:"Error: Expected a number"}:{ok:!0,value:n}}function We(e){return{result:e,type:"success"}}function F(e){return{result:`Error: ${e}`,type:"error"}}const Hs={excellent:5,good:4,fair:3,poor:2,critical:1};function zs(e){const n=Hs[e]??0,t=wt(e);return(n>0?`${t}${"█".repeat(n)}${A}`:"")+u("·".repeat(5-n))}const Jt=3.5;class Gs extends j{constructor(){super(...arguments);y(this,"name","ping");y(this,"description","Ping neighbor (name or 0xXX)");y(this,"params","{target} [timeout]")}async execute({output:t,rawInput:r}){var b,v,w,k;const s=this.argsAfterName(r).trim(),a=s.split(/\s+/);if(((b=a[0])==null?void 0:b.toLowerCase())==="help"){t.write([_("ping"),`  ${u("Send a ping to a neighbor and measure round-trip time, signal quality, and path.")}`,"",h("ping <name>","ping by node name"),h("ping 0xAB","ping by hex prefix"),h("ping <name> 60","ping with custom timeout (seconds)"),"",te("Default timeout: 30s. Signal bars factor radio config and noise floor.")].join(`
`));return}const i=a[a.length-1],o=parseInt(i),c=a.length>1&&!isNaN(o)&&o>0,l=c?a.slice(0,-1).join(" "):s,f=c?o:30;if(!l){t.write([_("ping"),`  ${u("Send a ping to a neighbor and measure round-trip time.")}`,"",h("ping <name>","ping by node name"),h("ping <name> 60","with custom timeout"),"",te('Run "ping help" for full usage.')].join(`
`));return}const x=Rr(t,l);try{const[T,B]=await Promise.all([xn(l,f),re()]);if(x.stop(),T.success&&T.data){const M=T.data,D=(v=B.config)==null?void 0:v.radio,I=D!=null&&D.spreading_factor&&(D!=null&&D.bandwidth)?{sf:D.spreading_factor,bwHz:D.bandwidth}:null,R=B.noise_floor_dbm,le=R!=null&&R>-100?1:0,je=M.rssi-Jt,Q=dr(M.snr_db,je,I,le),U=(Q==null?void 0:Q.finalGrade)??"critical",ae=zs(U),oe=(w=M.path)!=null&&w.length?M.path.length:0,ye=(k=M.path)!=null&&k.length?M.path.join(" > "):"direct",ie=U.charAt(0).toUpperCase()+U.slice(1),xe=[`${ae} ${ee("Reply from")} ${m(M.target_id)}`,"",`  ${p("RTT",On(M.rtt_ms))}`,`  ${p("RSSI",`${M.rssi} dBm`)}`,`  ${p("SNR",`${M.snr_db} dB`)}`,`  ${p("Path",ye)}${oe>0?u(` (${oe} hop${oe!==1?"s":""})`):""}`,`  ${p("Quality",Pn(ie,U))}`],K=[];I&&K.push(`SF${I.sf}/${I.bwHz>=1e3?I.bwHz/1e3+"kHz":I.bwHz+"Hz"}`),K.push(`ant ${Jt}dBi`),R!=null&&K.push(`nf ${R}dBm`),xe.push("",u(K.join("  "))),t.update(x.id,xe.join(`
`))}else t.update(x.id,T.error||"Ping failed","error")}catch(T){x.stop(),t.update(x.id,`Error: ${T instanceof Error?T.message:"Ping failed"}`,"error")}}}class Ws extends j{constructor(){super(...arguments);y(this,"name","convert");y(this,"description","Convert between hex and base64");y(this,"params","hex|base64 {value}")}execute({output:t,args:r}){var i;const s=(i=r[1])==null?void 0:i.toLowerCase(),a=r.slice(2).join(" ").trim();if(s==="help"||!s&&!a){t.write([_("convert"),`  ${u("Convert between hex and base64 encodings.")}`,"",h("convert hex <hex>","hex → base64"),h("convert base64 <b64>","base64 → hex"),"",te("Example: convert hex 48656C6C6F")].join(`
`));return}s==="hex"?this.hexToBase64(t,a):s==="base64"?this.base64ToHex(t,a):t.write([_("convert"),`  ${u("Convert between hex and base64 encodings.")}`,"",h("convert hex <hex>","hex → base64"),h("convert base64 <b64>","base64 → hex")].join(`
`))}hexToBase64(t,r){if(!r){t.write("Usage: convert hex <hex-string>","error");return}if(!/^[0-9a-fA-F]+$/.test(r)){t.write("Error: Input must be a hex string","error");return}if(r.length%2!==0){t.write("Error: Hex string must have even length","error");return}try{const s=new Uint8Array(r.length/2);for(let c=0;c<r.length;c+=2)s[c/2]=parseInt(r.substring(c,c+2),16);let a="";const i=8192;for(let c=0;c<s.length;c+=i)a+=String.fromCharCode.apply(null,Array.from(s.subarray(c,Math.min(c+i,s.length))));const o=typeof globalThis.btoa=="function"?globalThis.btoa(a):Buffer.from(a,"binary").toString("base64");t.write(`  ${p("hex",m(r))}
  ${p("base64",m(o))}`)}catch(s){t.write(`Error: Failed to convert - ${s instanceof Error?s.message:"unknown error"}`,"error")}}base64ToHex(t,r){if(!r){t.write("Usage: convert base64 <base64-string>","error");return}try{const s=typeof globalThis.atob=="function"?globalThis.atob(r):Buffer.from(r,"base64").toString("binary");let a="";for(let i=0;i<s.length;i++)a+=s.charCodeAt(i).toString(16).padStart(2,"0");t.write(`  ${p("base64",m(r))}
  ${p("hex",m(a.toUpperCase()))}`)}catch(s){t.write(`Error: Invalid base64 string - ${s instanceof Error?s.message:"unknown error"}`,"error")}}}const qs=10,Ks=500;function Xs(){const e=new Date;return`${e.toISOString().slice(0,10)}_${e.toTimeString().slice(0,8).replace(/:/g,"-")}`}function Vs(e,n){const t=e.toISOString().slice(0,10),r=e.toTimeString().slice(0,5).replace(":","");return`pymc-${t}-${r}-${n}s.json`}const ue=lr((e,n)=>({isCapturing:!1,captureStartTime:null,captureStartPacketHashes:new Set,captureTimer:null,reports:[],startCapture:t=>{const{captureTimer:r}=n();r&&clearTimeout(r),e({isCapturing:!0,captureStartTime:new Date,captureStartPacketHashes:new Set(t.map(s=>s.packet_hash))})},stopCapture:t=>{const{isCapturing:r,captureStartTime:s,captureStartPacketHashes:a,captureTimer:i}=n();if(!r||!s)return null;i&&clearTimeout(i);const o=new Date,c=Math.round((o.getTime()-s.getTime())/1e3),l=s.getTime()/1e3,f=t.filter(b=>!a.has(b.packet_hash)&&b.timestamp>=l).sort((b,v)=>b.timestamp-v.timestamp),x={id:Xs(),filename:Vs(s,c),startTime:s,endTime:o,durationSec:c,packetCount:f.length,packets:f,sizeBytes:f.length*Ks};return e(b=>({isCapturing:!1,captureStartTime:null,captureStartPacketHashes:new Set,captureTimer:null,reports:[x,...b.reports].slice(0,qs)})),x},getReport:t=>n().reports.find(r=>r.id===t),_setTimer:t=>e({captureTimer:t})})),Er=()=>ue(e=>e.reports);function z(e){var n;return((n=e.match(/.{1,2}/g))==null?void 0:n.join(" ").toUpperCase())||""}function Ar(e){return e===void 0?"UNKNOWN":an[e]??`TYPE_${e}`}function jr(e){return e===void 0?"UNKNOWN":sn[e]??`ROUTE_${e}`}function Ys(e){const n=[];let t=0;if(e.length>=32&&(n.push({name:"public_key",offset:t,length:32,bytes:z(H(e.slice(t,t+32))),decoded:{value:H(e.slice(t,t+32))}}),t+=32),e.length>=t+4){const r=e.slice(t,t+4),s=r[0]|r[1]<<8|r[2]<<16|r[3]<<24;n.push({name:"timestamp",offset:t,length:4,bytes:z(H(r)),decoded:{value:s>>>0,iso:new Date(s*1e3).toISOString()}}),t+=4}if(e.length>=t+64&&(n.push({name:"signature",offset:t,length:64,bytes:z(H(e.slice(t,t+64))),decoded:{value:H(e.slice(t,t+64))}}),t+=64),e.length>t){const r=e[t],s=[];if(r&1&&s.push("CHAT_NODE"),r&2&&s.push("REPEATER"),r&3&&s.push("ROOM_SERVER"),r&16&&s.push("HAS_LOCATION"),r&128&&s.push("HAS_NAME"),n.push({name:"flags",offset:t,length:1,bytes:z(H(e.slice(t,t+1))),decoded:{value:r,binary:r.toString(2).padStart(8,"0"),flags:s}}),t+=1,r&16&&e.length>=t+8){const a=e.slice(t,t+8),i=new ArrayBuffer(8);new Uint8Array(i).set(a);const o=new DataView(i),c=o.getInt32(0,!0),l=o.getInt32(4,!0);n.push({name:"location",offset:t,length:8,bytes:z(H(a)),decoded:{lat_raw:c,lon_raw:l,latitude:c/1e6,longitude:l/1e6}}),t+=8}if(r&128&&e.length>t){const a=e.slice(t);let i=a.indexOf(0);i===-1&&(i=a.length);const o=new TextDecoder().decode(a.slice(0,i));n.push({name:"name",offset:t,length:i+(a[i]===0?1:0),bytes:z(H(a.slice(0,i+1))),decoded:{value:o,encoding:"utf-8",null_terminated:a[i]===0}})}}return n}function Qs(e){if(e.length<4)return[];const n=e.slice(0,4),t=n[0]|n[1]<<8|n[2]<<16|n[3]<<24;return[{name:"crc",offset:0,length:4,bytes:z(H(n)),decoded:{value:t>>>0,hex:(t>>>0).toString(16).toUpperCase().padStart(8,"0"),note:"CRC of the acknowledged packet (little-endian)"}}]}function Js(e){const n=[];if(e.length<9)return n;const t=e.slice(0,4),r=t[0]|t[1]<<8|t[2]<<16|t[3]<<24;n.push({name:"trace_tag",offset:0,length:4,bytes:z(H(t)),decoded:{value:r>>>0,hex:(r>>>0).toString(16).toUpperCase().padStart(8,"0")}});const s=e.slice(4,8),a=s[0]|s[1]<<8|s[2]<<16|s[3]<<24;if(n.push({name:"auth_code",offset:4,length:4,bytes:z(H(s)),decoded:{value:a>>>0}}),n.push({name:"flags",offset:8,length:1,bytes:z(H(e.slice(8,9))),decoded:{value:e[8],binary:e[8].toString(2).padStart(8,"0")}}),e.length>9){const i=e.slice(9),o=Array.from(i).map(c=>c.toString(16).toUpperCase().padStart(2,"0"));n.push({name:"target_path",offset:9,length:i.length,bytes:z(H(i)),decoded:{hops:o,path_string:o.join("->")}})}return n}function Zs(e){if(e.length===0)return[];const n=Array.from(e).map(t=>t.toString(16).toUpperCase().padStart(2,"0"));return[{name:"path_hops",offset:0,length:e.length,bytes:z(H(e)),decoded:{hops:n,path_string:n.join("->")}}]}function ea(e){const n=[];if(e.length<1)return n;if(n.push({name:"channel_hash",offset:0,length:1,bytes:z(H(e.slice(0,1))),decoded:{value:e[0].toString(16).toUpperCase().padStart(2,"0")}}),e.length>13){const r=e.length-1-12;n.push({name:"ciphertext",offset:1,length:r,bytes:z(H(e.slice(1,1+r))),decoded:{length:r,note:"Encrypted message content"}}),n.push({name:"mac",offset:1+r,length:12,bytes:z(H(e.slice(-12))),decoded:{note:"Message authentication code"}})}return n}function ta(e){return e.length===0?[]:[{name:"raw_data",offset:0,length:e.length,bytes:z(H(e)),decoded:{length:e.length}}]}function Lr(e,n){switch(e){case 4:return Ys(n);case 3:return Qs(n);case 9:return Js(n);case 8:return Zs(n);case 5:return ea(n);default:return ta(n)}}function ra(e){const n=e.type??e.payload_type??0,t=e.route??e.route_type??0,r=e.raw_packet||"";let s,a=null;if(r){const i=bn.fromHex(r);if(i.success&&i.packet){const o=i.packet;try{a=$n(o)}catch{a=null}const c=ur(r);let l=0;const f={offset:0,length:1,bytes:z(r.slice(0,2)),decoded:{route_type:o.routeType,route_name:o.routeTypeName,payload_type:o.payloadType,payload_name:o.payloadTypeName,version:o.payloadVersion}};l+=1,o.hasTransportCodes()&&(l+=4);const b={offset:l,length:1,bytes:z(H(c.slice(l,l+1))),decoded:{value:o.pathLen}};l+=1;const v=l,w=c.slice(l,l+o.pathLen),k=Array.from(o.path).map(I=>I.toString(16).toUpperCase().padStart(2,"0")),T=o.payloadType===9,B={offset:v,length:o.pathLen,bytes:z(H(w)),decoded:{hops:k,path_string:k.length>0?k.join("->"):"(direct)",...T&&{note:"For TRACE packets, path bytes are SNR×4 values, not node hashes",snr_values:Array.from(o.path).map(I=>{let R=I;return R>127&&(R-=256),R/4})}}};l+=o.pathLen;const D={offset:l,length:o.payload.length,bytes:z(o.payloadHex),sections:Lr(o.payloadType,o.payload)};s={header:f,path_length:b,path:B,payload:D}}else s=Zt(e)}else s=Zt(e);return{timestamp:e.timestamp,packet_hash:e.packet_hash,type:n,type_name:Ar(n),route:t,route_name:jr(t),rssi:e.rssi,snr:e.snr,length:e.length??0,src_hash:e.src_hash,dst_hash:e.dst_hash,transmitted:e.transmitted,drop_reason:e.drop_reason,is_duplicate:e.is_duplicate,lbt_attempts:e.lbt_attempts,lbt_backoff_delays_ms:e.lbt_backoff_delays_ms,lbt_channel_busy:e.lbt_channel_busy,raw_packet:r,structure:s,decoded:a}}function Zt(e){var s;const n=e.type??e.payload_type??0,t=e.route??e.route_type??0,r=e.original_path??e.forwarded_path??[];return{header:{offset:0,length:1,bytes:"??",decoded:{route_type:t,route_name:jr(t),payload_type:n,payload_name:Ar(n),version:0}},path_length:{offset:1,length:1,bytes:r.length.toString(16).toUpperCase().padStart(2,"0"),decoded:{value:r.length}},path:{offset:2,length:r.length,bytes:r.join(" "),decoded:{hops:r,path_string:r.length>0?r.join("->"):"(direct)"}},payload:{offset:2+r.length,length:((s=e.payload)==null?void 0:s.length)??0,bytes:e.payload??"",sections:e.payload?Lr(n,ur(e.payload)):[]}}}function na(e,n){var t;return{capture:{start:e.startTime.toISOString(),end:e.endTime.toISOString(),duration_sec:e.durationSec,packet_count:e.packetCount,node_name:(n==null?void 0:n.node_name)??"unknown",local_hash:(n==null?void 0:n.local_hash)??"unknown",pymc_console_version:nn,pymc_repeater_version:(n==null?void 0:n.version)??"unknown",radio_config:(t=n==null?void 0:n.config)!=null&&t.radio?{frequency:n.config.radio.frequency,tx_power:n.config.radio.tx_power,bandwidth:n.config.radio.bandwidth,spreading_factor:n.config.radio.spreading_factor}:null},packets:e.packets.map(ra)}}function Mr(e,n){const t=na(e,n),r=JSON.stringify(t,null,2),s=new Blob([r],{type:"application/json"}),a=URL.createObjectURL(s),i=document.createElement("a");i.href=a,i.download=e.filename,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(a)}function Je(e){return e<1024?`${e} B`:e<1024*1024?`${(e/1024).toFixed(1)} KB`:`${(e/(1024*1024)).toFixed(1)} MB`}class sa extends j{constructor(){super(...arguments);y(this,"name","cap");y(this,"description","Packet capture (start/end/list/export)")}matches(t){const r=t.toLowerCase().trim();return r==="cap"||r==="cap help"||r.startsWith("start cap")||r.startsWith("end cap")||r.startsWith("list cap")||r.startsWith("export cap")}async execute({output:t,rawInput:r}){const s=r.toLowerCase().trim();if(s==="cap"||s==="cap help")return this.showHelp(t);if(s.startsWith("start cap"))return this.startCapture(t,s);if(s==="end cap")return this.endCapture(t);if(s==="list cap")return this.listCaptures(t);if(s.startsWith("export cap"))return this.exportCapture(t,s);this.showHelp(t)}showHelp(t){const r=ue.getState(),s=r.isCapturing?`
${at('Recording in progress... use "end cap" to stop')}`:"",a=r.reports.length,i=a>0?` (${a} saved)`:"",o=[_("Packet Capture"),"",h("start cap","Start capture (default: 120s)"),h("end cap","Stop capture early"),h("list cap",`List saved captures${i}`),h("export cap","Download capture by ID"),"",te("Captures stored in session memory. JSON includes decoded payloads."),s].filter(Boolean);t.write(o.join(`
`))}startCapture(t,r){const s=r.slice(9).trim(),a=s?parseInt(s):120;if(isNaN(a)||a<1||a>3600){t.write("Error: Duration must be 1-3600 seconds","error");return}const i=ue.getState();if(i.isCapturing){t.write('Error: Capture already in progress. Use "end cap" first.',"error");return}const o=pe.getState().packets;i.startCapture(o);let c=a;const l=t.write(at(`Capturing... ${c}s remaining`),"system"),f=setInterval(()=>{c--;const b=ue.getState();if(c>=0&&b.isCapturing){const w=pe.getState().packets.filter(T=>{if(!b.captureStartTime)return!1;const B=b.captureStartTime.getTime()/1e3;return T.timestamp>=B&&!b.captureStartPacketHashes.has(T.packet_hash)}).length,k=c>0?`${c}s remaining`:"finishing...";t.update(l,at(`Capturing... ${k} (${w} captured)`),"system")}},1e3),x=setTimeout(()=>{clearInterval(f);const b=ue.getState();if(b.isCapturing){const v=pe.getState().packets,w=b.stopCapture(v);w?t.write(`✓ Capture complete!
  Captured: ${w.packetCount} packets
  Duration: ${w.durationSec}s
  Size: ~${Je(w.sizeBytes)}

Run \`export cap ${w.id}\` to download.`,"value"):t.write("Capture completed with no packets.","warning")}},a*1e3);i._setTimer(x)}endCapture(t){const r=ue.getState();if(!r.isCapturing){t.write("No capture in progress.","warning");return}const s=pe.getState().packets,a=r.stopCapture(s);a?t.write(`✓ Capture stopped!
  Captured: ${a.packetCount} packets
  Duration: ${a.durationSec}s
  Size: ~${Je(a.sizeBytes)}

Run \`export cap ${a.id}\` to download.`,"value"):t.write("Capture stopped with no packets.","warning")}listCaptures(t){const{reports:r}=ue.getState();if(r.length===0){t.write(`No capture reports available.
Start a capture with: start cap [seconds]`,"info");return}const s=r.map((a,i)=>`  ${i+1}. ${a.packetCount} pkts • ${a.durationSec}s • ~${Je(a.sizeBytes)} (id: ${a.id})`);t.write(`Capture Reports (${r.length}):
${s.join(`
`)}`,"info")}exportCapture(t,r){const s=r.slice(10).trim(),a=ue.getState(),i=pe.getState().stats;if(!s){if(a.reports.length===0)t.write(`No capture reports available.
Start a capture with: start cap [seconds]`,"info");else{const c=a.reports.map((l,f)=>`  ${f+1}. ${l.id}`);t.write(`Usage: export cap <id>

Available reports:
${c.join(`
`)}`,"info")}return}let o=a.getReport(s);if(!o){const c=parseInt(s)-1;o=a.reports[c]}if(!o){t.write(`Error: Report "${s}" not found.
Use "list cap" to see available reports.`,"error");return}Mr(o,i),t.write(`✓ Downloading ${o.filename}...`,"value")}}class aa extends j{constructor(){super(...arguments);y(this,"name","identities");y(this,"description","List configured identities");y(this,"aliases",["id","ids"])}async execute({output:t,rawInput:r}){var a;if(this.argsAfterName(r).toLowerCase().trim()==="help"){t.write([_("identities"),`  ${u("List all configured repeater and room server identities.")}`,"",h("identities","list identities"),"",_("Aliases"),`  ${u("id, ids")}`].join(`
`));return}const s=t.write("processing...","system");try{const i=await on();if(!i.success||!i.data){t.update(s,i.error||"Failed to fetch identities","error");return}const o=i.data,c=(a=o.configured)!=null&&a.length?o.configured:o.registered||[];if(c.length===0){t.update(s,"No identities configured.","warning");return}const l=[_(`Identities (${c.length})`),"",...c.map((f,x)=>{var k;const b=f.name||"Unnamed",v=f.type||"unknown",w=((k=f.hash)==null?void 0:k.slice(0,8))||"—";return`  ${u(`${x+1}.`)} ${ee(b)}  ${q(v)}  ${m(w)}`})];t.update(s,l.join(`
`))}catch(i){t.update(s,`Error: ${i instanceof Error?i.message:"Command failed"}`,"error")}}}class oa extends j{constructor(){super(...arguments);y(this,"name","keys");y(this,"description","List transport keys")}async execute({output:t,rawInput:r}){if(this.argsAfterName(r).toLowerCase().trim()==="help"){t.write([_("keys"),`  ${u("List configured transport encryption keys.")}`,"",h("keys","list transport keys")].join(`
`));return}const s=t.write("processing...","system");try{const a=await wn();if(!a.success||!a.data){t.update(s,a.error||"Failed to fetch transport keys","error");return}const i=a.data;if(i.length===0){t.update(s,"No transport keys configured.","warning");return}const o=[_(`Transport Keys (${i.length})`),"",...i.map(c=>{const l=c.parent_id?`  ${q(`parent: ${c.parent_id}`)}`:"";return`  ${ee(c.name)}  ${p("flood",m(c.flood_policy))}${l}`})];t.update(s,o.join(`
`))}catch(a){t.update(s,`Error: ${a instanceof Error?a.message:"Command failed"}`,"error")}}}class ia extends j{constructor(){super(...arguments);y(this,"name","acl");y(this,"description","Show ACL statistics")}async execute({output:t,rawInput:r}){if(this.argsAfterName(r).toLowerCase().trim()==="help"){t.write([_("acl"),`  ${u("Display access control list statistics.")}`,"",h("acl","show ACL stats")].join(`
`));return}const s=t.write("processing...","system");try{const a=await cn();if(!a.success||!a.data){t.update(s,a.error||"Failed to fetch ACL stats","error");return}const i=a.data,o=[_("ACL Stats"),"",`  ${p("Identities",m(String(i.total_identities)))}`,`  ${p("Total clients",m(String(i.total_clients)))}`,`  ${p("Admin",m(String(i.admin_clients)))}`,`  ${p("Guest",m(String(i.guest_clients)))}`];if(i.by_identity_type){const c=i.by_identity_type.repeater,l=i.by_identity_type.room_server;c&&o.push(`  ${p("Repeater",`${m(String(c.count))} ids  ${u(`${c.clients} clients`)}`)}`),l&&o.push(`  ${p("Room Server",`${m(String(l.count))} ids  ${u(`${l.clients} clients`)}`)}`)}t.update(s,o.join(`
`))}catch(a){t.update(s,`Error: ${a instanceof Error?a.message:"Command failed"}`,"error")}}}class ca extends j{constructor(){super(...arguments);y(this,"name","rooms");y(this,"description","Show room server statistics")}async execute({output:t,rawInput:r}){if(this.argsAfterName(r).toLowerCase().trim()==="help"){t.write([_("rooms"),`  ${u("Display room server statistics and sync status.")}`,"",h("rooms","list rooms")].join(`
`));return}const s=t.write("processing...","system");try{const a=await ln();if(!a.success||!a.data){t.update(s,a.error||"Failed to fetch room stats","error");return}const i=a.data.rooms||[];if(i.length===0){t.update(s,"No room servers configured.","warning");return}const o=[_(`Rooms (${i.length})`),"",...i.map(c=>[`  ${ee(c.room_name)}`,`    ${p("msgs",m(String(c.total_messages)))}  ${p("clients",`${m(String(c.active_clients))}${q(`/${c.total_clients}`)}`)}  ${p("sync",c.sync_running?m("running"):q("idle"))}`]).flat()];t.update(s,o.join(`
`))}catch(a){t.update(s,`Error: ${a instanceof Error?a.message:"Command failed"}`,"error")}}}class la extends j{constructor(){super(...arguments);y(this,"name","restart");y(this,"description","Restart pymc-repeater service");y(this,"aliases",["reboot"])}async execute({output:t,rawInput:r}){if(this.argsAfterName(r).toLowerCase().trim()==="help"){t.write([_("restart"),`  ${u("Restart the pymc-repeater systemd service.")}`,"",h("restart","restart the service"),"",_("Aliases"),`  ${u("reboot")}`,"",te("Requires polkit permissions for the web user."),te("The page will need a manual refresh after restart.")].join(`
`));return}const s=t.write("Restarting service...","system");try{const a=await vn(AbortSignal.timeout(8e3));if(a.success){t.update(s,"Service restart initiated.","success"),await this.waitForService(t);return}const i=a.status;if(i===403||i===401){t.update(s,`Error: Permission denied.

The web user needs polkit permissions to restart the service.
See: /etc/polkit-1/localauthority/50-local.d/pymc-repeater.pkla`,"error");return}t.update(s,a.error||"Restart failed","error")}catch(a){const i=a instanceof Error?a.message:"";i.includes("ERR_NETWORK")||i.includes("ECONNRESET")||i.includes("Failed to fetch")||i.includes("Load failed")||i.includes("network connection was lost")||i.includes("abort")||i.includes("timeout")||a instanceof DOMException&&a.name==="TimeoutError"||a instanceof DOMException&&a.name==="AbortError"?(t.update(s,"Service is restarting (connection dropped).","success"),await this.waitForService(t)):t.update(s,`Error: ${i||"Restart failed"}`,"error")}}waitForService(t){return new Promise(r=>{const s=t.write("Waiting for service...","system");let a=0;const i=30;setTimeout(()=>{const o=setInterval(async()=>{a++,t.update(s,`Waiting for service... ${a}s`,"system");try{const c=new AbortController,l=setTimeout(()=>c.abort(),3e3);await fetch(`${dn}/api/stats`,{signal:c.signal}),clearTimeout(l),clearInterval(o),t.update(s,`Service connected. (${a+4}s)`,"success"),r();return}catch{}a>=i&&(clearInterval(o),t.update(s,`Service did not respond within ${i+4}s. Check manually.`,"warning"),r())},1e3)},4e3)})}}const _e="\x1B[",X=`${_e}0m`,Br=`${_e}32m`,_t=`${_e}33m`,Ct=`${_e}31m`,da=`${_e}36m`,ge=`${_e}90m`,Ir=`${_e}1m`;function Re(e){return e>=1073741824?`${(e/1073741824).toFixed(1)}G`:e>=1048576?`${(e/1048576).toFixed(0)}M`:e>=1024?`${(e/1024).toFixed(0)}K`:`${e}B`}function er(e){const n=Math.floor(e/86400),t=Math.floor(e%86400/3600),r=Math.floor(e%3600/60);return n>0?`${n}d ${t}h ${r}m`:t>0?`${t}h ${r}m`:`${r}m`}function ma(e,n){const t=Math.max(0,Math.min(100,e)),r=Math.round(t/100*n),s=n-r,a=t>=90?Ct:t>=70?_t:Br,i=`${a}${"█".repeat(r)}${X}${ge}${"░".repeat(s)}${X}`,o=`${t.toFixed(1)}%`.padStart(6);return`[${i}] ${a}${o}${X}`}function ua(e){return e>=80?`${Ct}${Ir}${e.toFixed(1)}°C${X}`:e>=60?`${_t}${e.toFixed(1)}°C${X}`:`${Br}${e.toFixed(1)}°C${X}`}const Pe=2,tr="  ";function Ee(e,n){const t=" ".repeat(Pe),r=n-Pe,s=tr.length,a=[];let i="",o=0;for(const c of e){const l=Kn(c);o===0?(i=c,o=l):o+s+l<=r?(i+=tr+c,o+=s+l):(a.push(t+i),i=c,o=l)}return o>0&&a.push(t+i),a}function pa(e,n,t){var x,b;const r=e.node_name||"unknown",s=e.version?`v${e.version}`:"",a=(x=n.system)!=null&&x.uptime?er(n.system.uptime):"?",i=er(e.uptime_seconds||0),o=Math.max(3,t-Pe*2),c=((b=n.cpu.load_avg)==null?void 0:b["1min"].toFixed(2))??"?",l=n.cpu.load_avg?`${c} ${n.cpu.load_avg["5min"].toFixed(2)} ${n.cpu.load_avg["15min"].toFixed(2)}`:"?",f=t>=60?l:c;return[`  ${da}${Ir}${r}${X}  ${ge}${s}${X}`,`  ${ge}${"─".repeat(o)}${X}`,...Ee([p("Sys",m(a)),p("Svc",m(i)),p("Load",m(f))],t)]}function fa(e,n){const r=Pe+4+1+2+6,s=Math.max(6,Math.min(30,n-r)),a=r+s,i=n-a-2,o=[""],c=`${e.cpu.count} core${e.cpu.count>1?"s":""}`,l=`${Re(e.memory.used)}/${Re(e.memory.total)}`,f=`${Re(e.disk.used)}/${Re(e.disk.total)}`,x=(v,w,k)=>{const T=ma(w,s),B=i>=k.length?`  ${q(k)}`:"";return`  ${u(v.padEnd(4))}${T}${B}`};o.push(x("CPU",e.cpu.usage_percent,c)),o.push(x("Mem",e.memory.usage_percent,l)),o.push(x("Dsk",e.disk.usage_percent,f));const b=Object.entries(e.temperatures||{});if(b.length>0){const v=b.map(([w,k])=>`${q(w+":")} ${ua(k)}`);o.push(...Ee(v,n))}return o}function ha(e,n){var l,f;const t=e.neighbors||{},r=Object.keys(t).length,s=Object.values(t).filter(x=>x.zero_hop).length,a=((f=(l=e.config)==null?void 0:l.repeater)==null?void 0:f.mode)||"?",i=e.noise_floor_dbm!=null?`${e.noise_floor_dbm}dBm`:"?",o=e.duty_cycle_percent??0,c=["",`  ${ge}MESH${X}`];return c.push(...Ee([p("Mode",m(a)),p("Nbrs",`${m(String(s))}${q(`/${r}`)}`),p("Noise",m(i)),p("Air",m(`${o.toFixed(1)}%`))],n)),c.push(...Ee([p("RX",m(String(e.rx_count??0))),p("TX",m(String(e.tx_count??0))),p("FWD",m(String(e.forwarded_count??0))),p("Drop",m(String(e.dropped_count??0)))],n)),c.push(...Ee([p("RX/h",m(String(Math.round(e.rx_per_hour??0)))),p("FWD/h",m(String(Math.round(e.forwarded_per_hour??0))))],n)),c}function ga(e,n){if(!e.network)return[];const t=["",`  ${ge}NET${X}`];return t.push(...Ee([p("TX",m(Re(e.network.bytes_sent))),p("RX",m(Re(e.network.bytes_recv))),p("Pkt",`${m(String(e.network.packets_sent))}${q("/")}${m(String(e.network.packets_recv))}`)],n)),t}function ya(e,n,t){if(e.length===0)return[];const r=n>=50,s=n>=50?6:5,a=n>=50?6:5,i=r?7:0,o=Pe+0,c=Math.max(4,n-o-i-s-a-4),l=3,f=n>=50?8:5,x=t!=null?Math.max(0,Math.min(f,t-l)):f;if(x<=0)return[];const b=["",`  ${ge}PROCS${X}`],v=(r?"PID".padEnd(i):"")+"CPU".padStart(s)+"MEM".padStart(a)+"  NAME";b.push(`  ${q(v)}`);for(const w of e.slice(0,x)){const k=r?q(String(w.pid).padEnd(i)):"",T=(n>=50?w.cpu_percent.toFixed(1):w.cpu_percent.toFixed(0)).padStart(s),B=(n>=50?w.memory_percent.toFixed(1):w.memory_percent.toFixed(0)).padStart(a),M=w.name.length>c?w.name.slice(0,c-1)+"…":w.name,D=w.cpu_percent>=50?Ct:w.cpu_percent>=20?_t:"",I=D?`${D}${T}${X}`:T;b.push(`  ${k}${I}${q(B)}  ${M}`)}return b}function xa(){return new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1})}function rr(e,n,t,r,s){if(!e||!n)return`  ${ge}Waiting for data…${X}`;const a=pa(e,n,r),i=fa(n,r),o=ha(e,r),c=ga(n,r),l=["",`  ${ge}${xa()}  ·  Ctrl+C to exit${X}`],f=[...a,...i,...o,...c,...l],x=s?ht(f,r):0,b=s?Math.max(0,s-x):void 0,v=ya(t,r,b),w=[...f.slice(0,-l.length),...v,...l];return s&&w.length>s&&(w.length=s),w.join(`
`)}const ba=3e3;class $a extends j{constructor(){super(...arguments);y(this,"name","top");y(this,"description","Live system overview (Ctrl+C to exit)");y(this,"aliases",["htop"])}async execute({output:t,rawInput:r,cols:s,signal:a}){var l,f;if(this.argsAfterName(r).toLowerCase().trim()==="help"){t.write([_("top"),`  ${u("Live-updating system overview combining hardware")}`,`  ${u("stats, mesh metrics, and running processes.")}`,`  ${u("Refreshes every 3s. Press Ctrl+C to exit.")}`,"",h("top","start live display"),"",_("Sections"),`  ${u("Header     Node name, version, uptime, load average")}`,`  ${u("Gauges     CPU, memory, disk usage with bar charts")}`,`  ${u("Mesh       Mode, neighbors, packet counts, airtime")}`,`  ${u("Network    TCP/IP bytes and packet counters")}`,`  ${u("Processes  Top 8 processes by CPU usage")}`,"",_("Aliases"),`  ${u("htop")}`].join(`
`));return}let i=null,o=[],c=pe.getState().stats;try{const[x,b]=await Promise.all([tt(),Tt()]);x.success&&x.data&&(i=x.data),b.success&&b.data&&(o=b.data.processes.sort((v,w)=>w.cpu_percent-v.cpu_percent))}catch{}if(!a.aborted){(l=t.enterFullscreen)==null||l.call(t);try{const x=t.write(rr(c,i,o,t.cols??s,t.rows));await new Promise(b=>{if(a.aborted){b();return}const v=async()=>{c=pe.getState().stats;try{const[k,T]=await Promise.all([tt(),Tt()]);k.success&&k.data&&(i=k.data),T.success&&T.data&&(o=T.data.processes.sort((B,M)=>M.cpu_percent-B.cpu_percent))}catch{}a.aborted||t.update(x,rr(c,i,o,t.cols??s,t.rows))},w=setInterval(()=>{if(a.aborted){clearInterval(w),b();return}v()},ba);a.addEventListener("abort",()=>{clearInterval(w),b()},{once:!0})})}finally{(f=t.exitFullscreen)==null||f.call(t)}}}}const nr=["DONT PANIC","C0FFEE","FEED C0DE","LOL","I CANNOT DO THAT"];function St(){return nr[Math.floor(Math.random()*nr.length)]}const yt=new EventTarget,xt="shell-phrase";function Fr(e){yt.dispatchEvent(new CustomEvent(xt,{detail:e??St()}))}function wa(e){const n=t=>e(t.detail);return yt.addEventListener(xt,n),()=>yt.removeEventListener(xt,n)}class va extends j{constructor(){super(...arguments);y(this,"name","fortune");y(this,"description","Display a fortune on the header");y(this,"aliases",["lol"])}execute({output:t}){const r=St();Fr(r),t.write(u(`  ${r}`))}}const bt=new EventTarget,$t="party-time";function _a(){bt.dispatchEvent(new Event($t))}function Ca(e){return bt.addEventListener($t,e),()=>bt.removeEventListener($t,e)}class Sa extends j{constructor(){super(...arguments);y(this,"name","partytime");y(this,"description","Party on, Garth!");y(this,"aliases",["party","excellent","waynesworld"])}execute({output:t}){_a(),Fr("PARTY 0N GARTH"),t.write(u("  SCHWING!"))}}class ka extends j{constructor(){super(...arguments);y(this,"name","ver");y(this,"description","Show version info");y(this,"aliases",["version"])}async execute({output:t,rawInput:r}){if(this.argsAfterName(r).toLowerCase().trim()==="help"){t.write([_("ver"),`  ${u("Display pyMC_Repeater, core, and console version.")}`,`  ${u('Equivalent to firmware serial CLI "ver" command.')}`,"",h("ver","show version"),"",_("Aliases"),`  ${u("version")}`].join(`
`));return}const s=t.write("processing...","system");try{const a=await re();t.update(s,[`  ${p("pyMC_Repeater",m(`v${a.version||"?"}`))}`,`  ${p("pyMC_Core",m(a.core_version||"?"))}`,`  ${p("pyMC_Console",m("v0.9.288"))}`].join(`
`),"value")}catch(a){t.update(s,`Error: ${a instanceof Error?a.message:"Command failed"}`,"error")}}}class Ta extends j{constructor(){super(...arguments);y(this,"name","clock");y(this,"description","Show system UTC time")}execute({output:t,rawInput:r}){if(this.argsAfterName(r).toLowerCase().trim()==="help"){t.write([_("clock"),`  ${u("Display the current system UTC time.")}`,`  ${u('Equivalent to firmware serial CLI "clock" command.')}`,`  ${u("Use to verify NTP sync and correlate packet timestamps.")}`,"",h("clock","show UTC time")].join(`
`));return}const s=new Date;t.write([`  ${p("UTC",m(s.toUTCString()))}`,`  ${p("ISO",m(s.toISOString()))}`,`  ${p("Unix",m(String(Math.floor(s.getTime()/1e3))))}`].join(`
`),"value")}}class Na extends j{constructor(){super(...arguments);y(this,"name","stats-packets");y(this,"description","Packet counters")}async execute({output:t,rawInput:r}){if(this.argsAfterName(r).toLowerCase().trim()==="help"){t.write([_("stats-packets"),`  ${u("Display packet counters: sent, received, forwarded, dropped.")}`,`  ${u('Equivalent to firmware serial CLI "stats-packets" command.')}`,"",h("stats-packets","show packet counters")].join(`
`));return}const s=t.write("processing...","system");try{const a=await re(),i=a.rx_count??0,o=a.tx_count??0,c=a.forwarded_count??0,l=a.dropped_count??0,f=a.rx_per_hour??0,x=a.forwarded_per_hour??0,b=a.duplicate_cache_size??0;t.update(s,[`  ${ee("Packet Counters")}`,"",`  ${p("RX",m(String(i)))}        ${u(`${f.toFixed(1)}/hr`)}`,`  ${p("TX",m(String(o)))}`,`  ${p("Forwarded",m(String(c)))}  ${u(`${x.toFixed(1)}/hr`)}`,`  ${p("Dropped",m(String(l)))}`,"",`  ${p("Dup cache",m(String(b)))}`].join(`
`),"value")}catch(a){t.update(s,`Error: ${a instanceof Error?a.message:"Command failed"}`,"error")}}}function ut(e){return e>=6e4?`${(e/6e4).toFixed(1)}m`:e>=1e3?`${(e/1e3).toFixed(1)}s`:`${e.toFixed(0)}ms`}class Ra extends j{constructor(){super(...arguments);y(this,"name","stats-radio");y(this,"description","Radio health stats")}async execute({output:t,rawInput:r}){var a;if(this.argsAfterName(r).toLowerCase().trim()==="help"){t.write([_("stats-radio"),`  ${u("Display radio health: airtime, noise floor, duty cycle.")}`,`  ${u('Equivalent to firmware serial CLI "stats-radio" command.')}`,"",h("stats-radio","show radio stats")].join(`
`));return}const s=t.write("processing...","system");try{const i=await re(),o=(a=i.config)==null?void 0:a.radio,c=i.noise_floor_dbm,l=i.airtime_used_ms??0,f=i.airtime_remaining_ms??0,x=i.duty_cycle_percent??0,b=i.utilization_percent??0,v=i.total_airtime_ms??0,w=[`  ${ee("Radio Stats")}`,""];if(o){const k=o.frequency?`${(o.frequency/1e6).toFixed(3)} MHz`:"?",T=o.bandwidth?`${o.bandwidth/1e3} kHz`:"?";w.push(`  ${p("Radio",m(`${k}  SF${o.spreading_factor??"?"}  BW ${T}  CR 4/${o.coding_rate??"?"}  ${o.tx_power??"?"} dBm`))}`),w.push("")}w.push(`  ${p("Noise floor",c!=null?m(`${c} dBm`):u("N/A"))}`),w.push(`  ${p("Airtime used",m(ut(l)))}  ${u(`remaining: ${ut(f)}`)}`),w.push(`  ${p("Total airtime",m(ut(v)))}`),w.push(`  ${p("Duty cycle",m(`${x.toFixed(1)}%`))}`),w.push(`  ${p("Utilization",m(`${b.toFixed(1)}%`))}`),t.update(s,w.join(`
`),"value")}catch(i){t.update(s,`Error: ${i instanceof Error?i.message:"Command failed"}`,"error")}}}function sr(e){return e>=1073741824?`${(e/1073741824).toFixed(1)} GB`:e>=1048576?`${(e/1048576).toFixed(0)} MB`:`${(e/1024).toFixed(0)} KB`}class Ea extends j{constructor(){super(...arguments);y(this,"name","stats-core");y(this,"description","Engine vitals")}async execute({output:t,rawInput:r}){if(this.argsAfterName(r).toLowerCase().trim()==="help"){t.write([_("stats-core"),`  ${u("Display engine vitals: uptime, memory, CPU, queue depth.")}`,`  ${u('Equivalent to firmware serial CLI "stats-core" command.')}`,`  ${u("On firmware this shows free heap — here we show Linux process health.")}`,"",h("stats-core","show core stats")].join(`
`));return}const s=t.write("processing...","system");try{const[a,i]=await Promise.all([re(),tt()]),o=[`  ${ee("Core Stats")}`,"",`  ${p("Uptime",m(vt(a.uptime_seconds??0)))}`,`  ${p("Dup cache",m(`${a.duplicate_cache_size??0} entries`))}  ${u(`TTL ${a.cache_ttl??"?"}s`)}`];if(i.success&&i.data){const c=i.data;o.push(""),o.push(`  ${p("CPU",m(`${c.cpu.usage_percent.toFixed(1)}%`))}  ${u(`${c.cpu.count} core${c.cpu.count>1?"s":""}`)}`),c.cpu.load_avg&&o.push(`  ${p("Load",m(`${c.cpu.load_avg["1min"].toFixed(2)} / ${c.cpu.load_avg["5min"].toFixed(2)} / ${c.cpu.load_avg["15min"].toFixed(2)}`))}`),o.push(`  ${p("Memory",m(`${sr(c.memory.used)} / ${sr(c.memory.total)}`))}  ${u(`${c.memory.usage_percent.toFixed(0)}%`)}`);const l=Object.entries(c.temperatures||{});l.length>0&&o.push(`  ${p("Temp",m(`${l[0][1].toFixed(1)}°C`))}`)}t.update(s,o.join(`
`),"value")}catch(a){t.update(s,`Error: ${a instanceof Error?a.message:"Command failed"}`,"error")}}}const pt=["@@@@@@@   @@@ @@@  @@@@@@@@@@    @@@@@@@  ","@@@@@@@@  @@@ @@@  @@@@@@@@@@@  @@@@@@@@  ","@@!  @@@  @@! !@@  @@! @@! @@!  !@@       ","!@!  @!@  !@! @!!  !@! !@! !@!  !@!       ","@!@@!@!    !@!@!   @!! !!@ @!@  !@!       ","!!@!!!      @!!!   !@!   ! !@!  !!!       ","!!:         !!:    !!:     !!:  :!!       ",":!:         :!:    :!:     :!:  :!:       "," ::          ::    :::     ::    ::: :::  "," :           :      :      :     :: :: :  "],ar=br-1;class Aa extends j{constructor(){super(...arguments);y(this,"name","hello");y(this,"description","Play the PYMC burst intro");y(this,"aliases",["hi","intro"])}async execute({output:t,signal:r}){if(r.aborted)return;let s=0;const a=t.write(Oe(pt,0).join(`
`));try{await new Promise(i=>{const o=setInterval(()=>{if(r.aborted||s>=ar){clearInterval(o),r.aborted||t.update(a,Oe(pt,ar).join(`
`)),i();return}s++,t.update(a,Oe(pt,s).join(`
`))},yr);r.addEventListener("abort",()=>{clearInterval(o),i()},{once:!0})})}finally{xr()}}}function ja(){const e=new An,n=new os(e);return e.register(n,new is,new cs,new ka,new Ta,new ls,new ds,new ms,new Na,new Ra,new Ea,new Cs,new Ls,new Gs,new Ms,new Is,new Ws,new sa,new aa,new oa,new ia,new ca,new la,new $a,new va,new Sa,new Aa),e}const La=()=>typeof crypto<"u"&&crypto.randomUUID?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const n=Math.random()*16|0;return(e==="x"?n:n&3|8).toString(16)}),or=lr(e=>({entries:[],commandHistory:[],isInitialized:!1,addEntry:n=>{const t=La(),r={...n,id:t,timestamp:Date.now()};return e(s=>({entries:[...s.entries,r]})),t},updateEntry:(n,t)=>{e(r=>({entries:r.entries.map(s=>s.id===n?{...s,...t}:s)}))},addCommand:n=>{e(t=>({commandHistory:[...t.commandHistory,n]}))},clearEntries:()=>{e({entries:[],commandHistory:[]})},setInitialized:n=>{e({isInitialized:n})}}));function Ma({isOpen:e,onClose:n}){const t=Er(),r=pe(a=>a.stats),s=a=>{const i=t.find(o=>o.id===a);i&&Mr(i,r)};return d.jsxs(pr,{open:e,onClose:n,size:"sm",children:[d.jsx(fr,{icon:d.jsx(Et,{size:20}),title:"Download Captures",onClose:n}),d.jsx(hr,{className:"flex flex-col gap-2",children:t.length===0?d.jsxs("div",{className:"flex flex-col items-center gap-2 py-6 text-fg-muted",children:[d.jsx(Tn,{className:"w-8 h-8 opacity-40"}),d.jsx("p",{className:"text-sm",children:"No captures available."})]}):t.map(a=>d.jsxs("div",{className:"flex items-center gap-3 px-4 py-3 radius-inset bg-elevated/50 border border-edge-subtle",children:[d.jsxs("div",{className:"flex-1 min-w-0",children:[d.jsx("p",{className:"type-label text-fg-primary truncate",children:a.filename}),d.jsxs("p",{className:"text-xs text-fg-muted mt-0.5",children:[a.packetCount," packets · ",a.durationSec,"s · ~",Je(a.sizeBytes)]})]}),d.jsx(mn,{plain:!0,color:"primary",onClick:()=>s(a.id),title:"Download",className:"flex-shrink-0",children:d.jsx(Et,{"data-slot":"icon"})})]},a.id))})]})}function Ba(){const e=Er(),[n,t]=C.useState(!1);return d.jsxs(d.Fragment,{children:[d.jsx($r,{icon:d.jsx(Nn,{size:20}),onClick:()=>t(!0),title:e.length>0?`Download captures (${e.length})`:"Captures",variant:"red",iconActiveColor:P.red}),d.jsx(Ma,{isOpen:n,onClose:()=>t(!1)})]})}const ir=[{name:"acl",description:"Access control list statistics — identity and client counts.",body:["```","> acl","ACL Stats","","  Identities     2","  Total clients  5","  Admin          2","  Guest          3","  Repeater       1 ids  3 clients","  Room Server    1 ids  2 clients","```"],searchText:"acl access control list statistics identity client"},{name:"advert",description:"Broadcast a repeater advertisement to the mesh.",body:["```","> advert","✓ Advert sent","```"],searchText:"advert advertisement broadcast mesh"},{name:"board",description:"Hardware and platform info — CPU, memory, disk, temperatures, network I/O.",body:["```","> board","  Node     Local-Node","  Runtime  pyMC_Repeater v1.0.0","  Core     v1.12.0","","  CPU      12.3%  4 cores","  Load     0.42 / 0.38 / 0.35","  Temp     48.2°C","","  Memory   412 MB / 664 MB  62%","  Disk     5.2 GB / 28.7 GB  18%","","  System uptime   14d 3h 22m","  Service uptime  2d 14h 32m","  Net TX/RX       128 MB / 342 MB","```"],searchText:"board hardware platform cpu memory disk temperature network"},{name:"cap",description:"Packet capture — start, stop, list, and export captures.",body:["**Sub-commands:** `start cap [sec]` · `end cap` · `list cap` · `export cap [id]`","","**`start cap [seconds]`** — Begin capture (default 120s, max 3600):","```","> start cap","Capturing... 118s remaining (4 captured)","","✓ Capture complete!","  Captured: 23 packets","  Duration: 120s","  Size: ~14.2 KB","```","","**`end cap`** — Stop capture early:","```","> end cap","✓ Capture stopped!","  Captured: 12 packets","```","","**`list cap`** — List saved captures:","```","> list cap","Capture Reports (2):","  1. 23 pkts • 120s • ~14.2 KB (id: abc123)","  2. 12 pkts • 34s • ~7.1 KB (id: def456)","```","","**`export cap [id]`** — Download by ID or index:","```","> export cap 1","✓ Downloading capture-abc123.json...","```"],searchText:"cap capture packet start end list export download diagnostic"},{name:"clear",description:"Clear the terminal screen.",body:["**Alias:** `cls`","```","> clear","```"],searchText:"clear cls screen"},{name:"clock",description:"Current system UTC time. Useful for NTP sync and packet timestamp correlation.",body:["```","> clock","  UTC   Wed, 12 Feb 2026 00:01:34 GMT","  ISO   2026-02-12T00:01:34.000Z","  Unix  1770768094","```"],searchText:"clock time utc ntp unix iso timestamp"},{name:"convert",description:"Convert between hex and base64 encodings.",body:["**Usage:** `convert hex <value>` · `convert base64 <value>`","```","> convert hex 48656C6C6F","  hex     48656C6C6F","  base64  SGVsbG8=","","> convert base64 SGVsbG8=","  base64  SGVsbG8=","  hex     48656C6C6F","```"],searchText:"convert hex base64 encoding decode"},{name:"get",description:"Read a configuration parameter.",body:[],interactive:"get",searchText:"get read config parameter name role lat lon radio freq tx bw sf cr txdelay mode duty flood advert"},{name:"help",description:"Show all commands, or detailed help for a specific command.",body:["**Alias:** `?` · `h`","```","> help           Full command listing","> help ping      Detailed help for ping","> ping help      Same thing","```"],searchText:"help commands reference guide"},{name:"identities",description:"List all configured repeater and room server identities.",body:["**Alias:** `id` · `ids`","```","> identities","Identities (2)","","  1. Local-Node   repeater     0A1B2C3D","  2. local-room   room_server  0E5F6A7B","```"],searchText:"identities id ids repeater room server identity"},{name:"keys",description:"List configured transport encryption keys.",body:["```","> keys","Transport Keys (1)","","  main-transport  flood: allow","```"],searchText:"keys transport encryption"},{name:"neighbors",description:"Direct RF neighbors with signal quality, RSSI, SNR, distance, and last-heard.",body:["**Alias:** `nb`","","**Sort qualifiers:** `sig` · `name` · `rssi` · `snr` · `dist` · `heard`","```","> neighbors","Direct Neighbors (4)","","+-------+-----------+-----------+--------+-------+--------+","| ▁▃▅▇█ | Node-1 | -87 dBm  | 8.5 dB | 2.1km | 3m ago |","| ▁▃▅▇. | Relay-2   | -94 dBm  | 5.2 dB | 4.8km | 1m ago |","| ▁▃▅.. | Node-3   | -108 dBm | 1.0 dB | 8.3km | 5m ago |","| ▁▃... | Node-4  | -118 dBm | -3 dB  | 14km  | 12m ago|","+-------+-----------+-----------+--------+-------+--------+","| SIG   | NAME      | RSSI      | SNR    | DIST  | HEARD  |","+-------+-----------+-----------+--------+-------+--------+","SF11/250kHz  ant 3.5dBi  nf -112dBm","```","","- **sig** — signal grade (weakest first)","- **name** — alphabetical","- **rssi** — RSSI (weakest first)","- **snr** — SNR (lowest first)","- **dist** — distance (closest first)","- **heard** — last seen (oldest first)"],searchText:"neighbors nb signal rssi snr distance sort direct rf"},{name:"packets",description:"Packet counters — received, transmitted, forwarded, dropped.",body:["```","> packets","Packet Stats  1321 total","","  Received     1284","  Transmitted  37","  Forwarded    891","  Dropped      14","```"],searchText:"packets received transmitted forwarded dropped counter"},{name:"ping",description:"Ping a neighbor by name or hex prefix. Shows RTT, signal quality, and path.",body:["**Usage:** `ping <target> [timeout]`","```","> ping Node-1","▁▃▅▇█ Reply from Node-1","","  RTT      342ms","  RSSI     -87 dBm","  SNR      8.5 dB","  Path     direct","  Quality  Excellent","```","","Custom timeout (default 30s):","```","> ping Node-4 60","```"],searchText:"ping rtt round trip time signal quality path neighbor"},{name:"restart",description:"Restart the pymc-repeater systemd service.",body:["**Alias:** `reboot`","```","> restart","Service is restarting (connection dropped).","Waiting for service... 8s","Service connected. (12s)","```","","The terminal polls automatically until the service comes back up."],searchText:"restart reboot service systemd"},{name:"rooms",description:"Room server statistics — message counts, active clients, sync status.",body:["```","> rooms","Rooms (1)","","  Local Room","    msgs 142  clients 3/5  sync running","```"],searchText:"rooms room server messages clients sync"},{name:"set",description:"Write a configuration parameter.",body:[],interactive:"set",searchText:"set write config parameter name lat lon freq tx bw sf cr txdelay mode duty log flood advert"},{name:"stats-core",description:"Engine vitals — uptime, duplicate cache, CPU, memory, temperature.",body:["```","> stats-core","  Core Stats","","  Uptime     2d 14h 32m","  Dup cache  128 entries  TTL 900s","","  CPU        12.3%  4 cores","  Load       0.42 / 0.38 / 0.35","  Memory     412 MB / 664 MB  62%","  Temp       48.2°C","```"],searchText:"stats core engine vitals uptime cache cpu memory temperature"},{name:"stats-packets",description:"Firmware-compatible packet counters with rates and duplicate cache depth.",body:["```","> stats-packets","  Packet Counters","","  RX         1284        22.4/hr","  TX         37","  Forwarded  891   15.2/hr","  Dropped    14","","  Dup cache  128","```"],searchText:"stats packets firmware counter rate duplicate cache"},{name:"stats-radio",description:"Radio health — noise floor, airtime, duty cycle, and radio configuration.",body:["```","> stats-radio","  Radio Stats","","  Radio        906.875 MHz  SF11  BW 250 kHz  CR 4/5  22 dBm","","  Noise floor  -112 dBm","  Airtime used 4.2s  remaining: 55.8m","  Total airtime 1.2m","  Duty cycle   1.2%","  Utilization  0.8%","```"],searchText:"stats radio noise floor airtime duty cycle utilization"},{name:"status",description:"Quick summary of mode, neighbors, and uptime.",body:["**Alias:** `st`","```","> status","Local-Node  repeater","","  Mode       forward","  Neighbors  4 direct  12 total","  RX / TX    1284 / 37","  Uptime     2d 14h 32m","```"],searchText:"status st summary mode neighbors uptime"},{name:"top",description:"Live-updating system overview — CPU/memory gauges, mesh counters, processes.",body:["**Alias:** `htop`","","Refreshes every 3s. Press **Ctrl+C** to exit.","```","> top","Local-Node  v1.0.0","──────────────────────────────────","  Sys 14d 3h 22m  Svc 2d 14h 32m  Load 0.42 0.38 0.35","","  CPU [████░░░░░░░░░░░░]  12.3%  4 cores","  Mem [██████████░░░░░░]  62.1%  412M/664M","  Dsk [███░░░░░░░░░░░░░]  18.4%  5.2G/28.7G","  cpu_thermal: 48.2°C","","  MESH","  Mode forward  Nbrs 4/12  Noise -112dBm  Air 1.2%","  RX 1284  TX 37  FWD 891  Drop 14","  RX/h 22  FWD/h 15","","  PROCS","    CPU   MEM  NAME","    8.2   3.1  python3","    2.1   1.4  cherrypy","","  14:32:08  ·  Ctrl+C to exit","```","","Uses alternate screen buffer — scrollback is preserved."],searchText:"top htop live system overview cpu memory gauges mesh processes"},{name:"uptime",description:"How long the repeater service has been running.",body:["```","> uptime","Uptime  2d 14h 32m","```"],searchText:"uptime service running duration"},{name:"ver",description:"Version info for all three components.",body:["**Alias:** `version`","```","> ver","  pyMC_Repeater  v1.0.0","  pyMC_Core      v1.12.0","  pyMC_Console   v1.0.0","```"],searchText:"ver version pymc repeater core console"}],Ia=[{param:"name",category:"Identity",example:["> get name","name  Local-Node"]},{param:"role",category:"Identity",example:["> get role","role  repeater"]},{param:"lat",category:"Identity",example:["> get lat","lat  34.0522"],range:"-90 to 90"},{param:"lon",category:"Identity",example:["> get lon","lon  -118.2437"],range:"-180 to 180"},{param:"public.key",category:"Identity",example:["> get public.key","public.key  0A1B2C3D4E5F..."]},{param:"radio",category:"Radio",example:["> get radio","  freq  906.875 MHz","  bw    250 kHz","  sf    11","  cr    4/5","  tx    22 dBm"]},{param:"freq",category:"Radio",example:["> get freq","freq  906.875 MHz"],range:"100–1000 MHz"},{param:"tx",category:"Radio",example:["> get tx","tx  22 dBm"],range:"2–22 dBm"},{param:"bw",category:"Radio",example:["> get bw","bw  250 kHz"],range:"7.8–500 kHz"},{param:"sf",category:"Radio",example:["> get sf","sf  11"],range:"5–12"},{param:"cr",category:"Radio",example:["> get cr","cr  4/5"],range:"5–8"},{param:"af",category:"Timing",example:["> get af","⚠ airtime_factor not yet exposed by pyMC_Repeater API.","  Firmware range: 0-9. Tracked in CLI-Alignment.md."],range:"0–9 (pending)"},{param:"txdelay",category:"Timing",example:["> get txdelay","txdelay  1.0"],range:"0.0–5.0"},{param:"direct.txdelay",category:"Timing",example:["> get direct.txdelay","direct.txdelay  0.5"],range:"0.0–5.0"},{param:"rxdelay",category:"Timing",example:["> get rxdelay","rxdelay  0.0"],range:"≥ 0"},{param:"mode",category:"Repeater",example:["> get mode","mode  forward"],range:"forward / monitor"},{param:"duty",category:"Repeater",example:["> get duty","duty  on"],range:"on / off"},{param:"flood.max",category:"Repeater",example:["> get flood.max","flood.max  3"],range:"0–64"},{param:"advert.interval",category:"Repeater",example:["> get advert.interval","advert.interval  120m"],range:"0 (off) or 1–10080 min"},{param:"multi.acks",category:"Advanced",example:["> get multi.acks","multi.acks  0"],range:"0–255"},{param:"int.thresh",category:"Advanced",example:["> get int.thresh","int.thresh  -120 dBm"],range:"-200 to 0 dBm"},{param:"agc.reset.interval",category:"Advanced",example:["> get agc.reset.interval","agc.reset.interval  0"],range:"≥ 0 (×4)"}],Fa=[{param:"name",category:"Identity",example:["> set name Local-Node","OK - node_name set to Local-Node"],range:"text (no [ ] \\ / : , ? *)"},{param:"lat",category:"Identity",example:["> set lat 34.0522","OK - latitude set to 34.0522"],range:"-90 to 90"},{param:"lon",category:"Identity",example:["> set lon -118.2437","OK - longitude set to -118.2437"],range:"-180 to 180"},{param:"freq",category:"Radio",example:["> set freq 906.875","OK - frequency set to 906875000"],range:"100–1000 MHz"},{param:"tx",category:"Radio",example:["> set tx 22","OK - tx_power set to 22"],range:"2–22 dBm"},{param:"bw",category:"Radio",example:["> set bw 250","OK - bandwidth set to 250000"],range:"7.8, 10.4, 15.6, 20.8, 31.25, 41.7, 62.5, 125, 250, 500 kHz"},{param:"sf",category:"Radio",example:["> set sf 11","OK - spreading_factor set to 11"],range:"5–12"},{param:"cr",category:"Radio",example:["> set cr 5","OK - coding_rate set to 5"],range:"5–8"},{param:"af",category:"Timing",example:["> set af 2","⚠ airtime_factor not yet exposed by pyMC_Repeater API.","  Firmware range: 0-9. Needs backend support."],range:"0–9 (pending)"},{param:"txdelay",category:"Timing",example:["> set txdelay 1.0","OK - tx_delay_factor set to 1"],range:"0.0–5.0"},{param:"direct.txdelay",category:"Timing",example:["> set direct.txdelay 0.5","OK - direct_tx_delay_factor set to 0.5"],range:"0.0–5.0"},{param:"rxdelay",category:"Timing",example:["> set rxdelay 0","OK - rx_delay_base set to 0"],range:"≥ 0"},{param:"mode",category:"Repeater",example:["> set mode forward","OK - Mode set to forward"],range:"forward / monitor"},{param:"flood.max",category:"Repeater",example:["> set flood.max 3","OK - max_flood_hops set to 3"],range:"0–64"},{param:"advert.interval",category:"Repeater",example:["> set advert.interval 120","OK - Local advert interval set to 120m"],range:"0 (off) or 1–10080 min"},{param:"duty",category:"Repeater",example:["> set duty on","OK - Duty cycle enabled"],range:"on / off"},{param:"log",category:"Repeater",example:["> set log info","OK - Log level set to INFO"],range:"debug, info, warning, error"},{param:"multi.acks",category:"Advanced",example:["> set multi.acks 0","OK - multi_acks set to 0"],range:"0–255"},{param:"int.thresh",category:"Advanced",example:["> set int.thresh -120","OK - interference_threshold set to -120"],range:"-200 to 0 dBm"},{param:"agc.reset.interval",category:"Advanced",example:["> set agc.reset.interval 8","OK - AGC reset interval set to 8"],range:"≥ 0 (rounded to ×4)"},{param:"prv.key",category:"Advanced",example:["> set prv.key <128-hex>","To set this key, run on the Pi:","","  sudo ./convert_firmware_key.sh <key>","","Then restart: sudo systemctl restart pymc-repeater"],range:"128-char hex (SSH only)"}];function Da({mode:e}){const n=e==="get"?Ia:Fa,[t,r]=C.useState(0),s=n[t],a=C.useMemo(()=>{const i=new Map;for(const o of n){const c=i.get(o.category)||[];c.push(o),i.set(o.category,c)}return Array.from(i.entries())},[n]);return d.jsxs("div",{className:"flex flex-col gap-2",children:[d.jsx("div",{className:"flex flex-col gap-1.5",children:a.map(([i,o])=>d.jsxs("div",{className:"flex flex-wrap items-center gap-1",children:[d.jsx("span",{className:"text-xs text-fg-muted w-16 shrink-0 text-right pr-1",children:i}),o.map(c=>{const l=n.indexOf(c),f=l===t;return d.jsx("button",{onClick:()=>r(l),className:et("px-1.5 py-0.5 type-data-xs radius-badge transition-colors cursor-pointer",f?"bg-sys-blue text-fg-invert font-semibold":"bg-elevated text-fg-secondary hover:bg-elevated/80 hover:text-sys-blue"),children:c.param},c.param)})]},i))}),d.jsx("pre",{className:"px-3 py-2.5 radius-inner bg-body text-fg-secondary type-code overflow-x-auto border border-edge-subtle",children:s.example.map((i,o)=>d.jsx("div",{children:i||" "},o))}),s.range&&d.jsxs("p",{className:"text-xs text-fg-muted",children:[d.jsx("span",{className:"text-fg-secondary font-medium",children:s.param})," — ",s.range]})]})}function cr(e,n){const t=e.split(/(\*\*[^*]+\*\*)/g);return d.jsx("span",{children:t.map((r,s)=>r.startsWith("**")&&r.endsWith("**")?d.jsx("strong",{className:"text-fg-primary font-semibold",children:r.slice(2,-2)},s):r.split(/(`[^`]+`)/g).map((i,o)=>i.startsWith("`")&&i.endsWith("`")?d.jsx("code",{className:"px-1 py-0.5 radius-badge bg-elevated text-sys-blue type-data-xs",children:i.slice(1,-1)},`${s}-${o}`):d.jsx("span",{children:i},`${s}-${o}`)))},n)}function Oa({lines:e}){const n=[];let t=0;for(;t<e.length;){const r=e[t];if(r==="```"){const s=[];for(t++;t<e.length&&e[t]!=="```";)s.push(e[t]),t++;t++,n.push(d.jsx("pre",{className:"px-3 py-2.5 my-2 radius-inner bg-body text-fg-secondary type-code overflow-x-auto border border-edge-subtle",children:s.map((a,i)=>d.jsx("div",{children:a||" "},i))},n.length));continue}if(!r.trim()){n.push(d.jsx("div",{className:"h-1.5"},n.length)),t++;continue}if(r.startsWith("- ")){n.push(d.jsxs("div",{className:"flex gap-2 text-sm text-fg-secondary pl-2 py-0.5",children:[d.jsx("span",{className:"text-fg-muted shrink-0",children:"•"}),d.jsx("span",{children:cr(r.slice(2),0)})]},n.length)),t++;continue}n.push(d.jsx("p",{className:"text-sm text-fg-secondary py-0.5",children:cr(r,0)},n.length)),t++}return d.jsx(d.Fragment,{children:n})}function Pa({isOpen:e,onClose:n,onUseCommand:t}){const[r,s]=C.useState(""),a=C.useMemo(()=>{if(!r.trim())return ir;const o=r.toLowerCase();return ir.filter(c=>c.name.includes(o)||c.searchText.includes(o)||c.description.toLowerCase().includes(o))},[r]),i=r.trim().length>0;return d.jsxs(pr,{open:e,onClose:n,size:"3xl",motionPlus:!0,className:"sm:min-w-[540px] md:min-w-[680px]",children:[d.jsx(fr,{icon:d.jsx(wr,{size:20}),title:"Terminal Command Guide",onClose:n}),d.jsxs(hr,{className:"flex flex-col gap-0 !px-0 !py-0",children:[d.jsx("div",{className:"sticky top-0 z-10 px-5 py-3 border-b border-edge-subtle bg-surface/95 backdrop-blur-sm",children:d.jsxs("div",{className:"relative",children:[d.jsx(At,{size:14,className:"absolute left-2.5 top-1/2 -translate-y-1/2 text-fg-muted"}),d.jsx("input",{type:"text",value:r,onChange:o=>s(o.target.value),placeholder:"Search commands...",className:"w-full pl-8 pr-3 py-1.5 text-sm bg-elevated border border-edge-subtle radius-inner text-fg-primary placeholder:text-fg-muted focus:outline-none focus:ring-1 focus:ring-sys-blue/50",autoFocus:!0})]})}),d.jsxs("div",{className:"overflow-y-auto px-5 py-3 h-[420px] sm:h-[520px] md:h-[600px]",children:[d.jsx(st,{mode:"popLayout",children:a.length===0?d.jsxs(qe.div,{initial:{opacity:0,scale:.96},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.96},transition:{duration:Rt.normal,ease:Nt.easeOut},className:"flex flex-col items-center gap-2 py-10 text-fg-muted",children:[d.jsx(At,{className:"w-6 h-6 opacity-40"}),d.jsxs("p",{className:"text-sm",children:['No commands match "',r,'"']})]},"empty"):d.jsx(qe.div,{initial:!1,className:"flex flex-col gap-1",children:d.jsx(st,{initial:!1,children:a.map(o=>d.jsx(qe.div,{layout:"position",initial:{opacity:0,y:-4},animate:{opacity:1,y:0},exit:{opacity:0,y:-4},transition:un.fade,className:"min-w-0",children:d.jsx(qr,{children:({open:c})=>d.jsxs("div",{className:et("radius-inner border transition-colors",c?"border-edge-subtle bg-elevated/50":"border-transparent hover:bg-elevated/30"),children:[d.jsxs("div",{className:"flex items-center w-full min-w-0",children:[d.jsxs(Kr,{className:"flex items-center gap-3 flex-1 min-w-0 px-3 py-2 text-left cursor-pointer",children:[d.jsx(Rn,{size:14,className:et("shrink-0 text-fg-muted transition-transform duration-150",c&&"rotate-90")}),d.jsx("code",{className:"text-sm font-semibold text-sys-blue font-mono shrink-0",children:o.name}),d.jsx("span",{className:"text-xs text-fg-muted truncate min-w-0",children:o.description})]}),t&&d.jsx("button",{onClick:l=>{l.stopPropagation(),t(o.name)},className:"shrink-0 mr-2 px-2 py-0.5 text-xs font-semibold uppercase tracking-wider radius-badge bg-elevated text-fg-muted hover:text-sys-blue hover:bg-elevated/80 transition-colors cursor-pointer",title:`Use "${o.name}" in terminal`,children:"use"})]}),d.jsx(Xr,{className:"px-3 pb-3 pt-0 pl-9",children:o.interactive?d.jsx(Da,{mode:o.interactive}):d.jsx(Oa,{lines:o.body})})]})})},o.name))})},"list")}),d.jsx(st,{children:!i&&d.jsxs(qe.div,{initial:{opacity:0,y:6},animate:{opacity:1,y:0},exit:{opacity:0,y:6},transition:{duration:Rt.normal,ease:Nt.easeOut},className:"mt-4 px-3 py-3 radius-inner border border-edge-subtle bg-elevated/30",children:[d.jsx("p",{className:"text-xs font-semibold text-fg-muted mb-2",children:"Tips"}),d.jsxs("div",{className:"flex flex-col gap-1 text-xs text-fg-muted",children:[d.jsxs("p",{children:["Type ",d.jsx("code",{className:"px-1 py-0.5 radius-badge bg-elevated text-sys-blue font-mono",children:"<command> help"})," in the terminal for detailed usage."]}),d.jsxs("p",{children:["Most commands have shorter aliases (e.g. ",d.jsx("code",{className:"px-1 py-0.5 radius-badge bg-elevated text-sys-blue font-mono",children:"st"}),", ",d.jsx("code",{className:"px-1 py-0.5 radius-badge bg-elevated text-sys-blue font-mono",children:"nb"}),", ",d.jsx("code",{className:"px-1 py-0.5 radius-badge bg-elevated text-sys-blue font-mono",children:"id"}),")."]}),d.jsxs("p",{children:["Signal bars ",d.jsx("span",{className:"font-mono",children:"▁▃▅▇█"})," are colored by link quality grade based on RSSI, SNR, and radio config."]}),d.jsx("p",{children:"Captures are stored in browser session only — export before closing the tab."})]})]})})]})]})]})}function Ua({onUseCommand:e}){const[n,t]=C.useState(!1),r=e?s=>{t(!1),e(s)}:void 0;return d.jsxs(d.Fragment,{children:[d.jsx($r,{icon:d.jsx(wr,{size:17,className:"translate-y-px"}),onClick:()=>t(!0),title:"CLI Command Guide"}),d.jsx(Pa,{isOpen:n,onClose:()=>t(!1),onUseCommand:r})]})}const Dr=ja(),Ze=Dr.all().flatMap(e=>[{cmd:e.name,desc:e.description,params:e.params,required:!!e.params},...e.aliases.filter(n=>n.includes(" ")).map(n=>({cmd:n,desc:e.description,params:e.params,required:!!e.params}))]);Ze.push({cmd:"start cap",desc:"Start packet capture",params:"[seconds]",required:!0},{cmd:"end cap",desc:"Stop capture"},{cmd:"list cap",desc:"List captures"},{cmd:"export cap",desc:"Download capture",params:"[id]",required:!0});const Xe=["sig","name","rssi","snr","dist","heard"],Ha={get:["name","role","lat","lon","radio","freq","tx","bw","sf","cr","af","txdelay","direct.txdelay","rxdelay","mode","repeat","flood.max","flood.advert.interval","advert.interval","duty","duty.max","multi.acks","int.thresh","agc.reset.interval","public.key","prv.key"],set:["name","lat","lon","freq","tx","bw","sf","cr","af","txdelay","direct.txdelay","rxdelay","mode","repeat","flood.max","flood.advert.interval","advert.interval","duty","log","multi.acks","int.thresh","agc.reset.interval","prv.key"],convert:["hex","base64"],neighbors:Xe,nb:Xe,"get neighbors":Xe,"get neighbor":Xe,"set mode":["forward","monitor"],"set duty":["on","off"],"set repeat":["on","off"],"set tx":["10","14","17","20","22"],"set sf":["7","8","9","10","11","12"],"set bw":["125","250","500"],"set cr":["5","6","7","8"],"set af":["0.5","1.0","1.5","2.0"],"set txdelay":["0.5","0.7","1.0","1.5"],"set direct.txdelay":["0.3","0.5","0.7"],"set log":["debug","info","warning","error"],"start cap":["30","60","120","300"]},ft=["@@@@@@@   @@@ @@@  @@@@@@@@@@    @@@@@@@  ","@@@@@@@@  @@@ @@@  @@@@@@@@@@@  @@@@@@@@  ","@@!  @@@  @@! !@@  @@! @@! @@!  !@@       ","!@!  @!@  !@! @!!  !@! !@! !@!  !@!       ","@!@@!@!    !@!@!   @!! !!@ @!@  !@!       ","!!@!!!      @!!!   !@!   ! !@!  !!!       ","!!:         !!:    !!:     !!:  :!!       ",":!:         :!:    :!:     :!:  :!:       "," ::          ::    :::     ::    ::: :::  "," :           :      :      :     :: :: :  "];function Fe(){return/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)||window.innerWidth<640}function za(e,n){const t=e.toLowerCase(),r=t.trim();if(!r)return[];const s=t.length>r.length&&t.endsWith(" ");if(!r.includes(" ")&&!s)return Ze.filter(c=>c.cmd.toLowerCase().startsWith(r));const a=s?r:r.substring(0,r.lastIndexOf(" ")),i=s?"":r.substring(r.lastIndexOf(" ")+1);if(a==="ping"&&n.length>0)return n.filter(c=>c.toLowerCase().startsWith(i)).slice(0,10).map(c=>({cmd:`ping ${c}`,desc:`→ ${c}`}));const o=Ha[a];if(o){const c=o.filter(l=>l.toLowerCase().startsWith(i)).map(l=>({cmd:`${a} ${l}`,desc:`→ ${l}`}));if(!s&&i){const l=new Set(c.map(f=>f.cmd));for(const f of Ze){const x=f.cmd.toLowerCase();x.startsWith(r)&&!l.has(x)&&(c.push(f),l.add(x))}}return c}return Ze.filter(c=>c.cmd.toLowerCase().startsWith(r))}function co(){const e=pn(),{addCommand:n}=or(),t=C.useRef(null),r=C.useRef(null),s=C.useRef(null),a=C.useRef(null),i=C.useRef(""),o=C.useRef(-1),c=C.useRef(""),l=C.useRef(!1),f=C.useRef(null),x=C.useRef(!1),b=C.useRef(!1),v=C.useRef(!1),w=C.useRef([]),k=C.useRef(()=>{}),T=fn(),[B,M]=C.useState("C0dE"),[D,I]=C.useState(!1),R=C.useRef(null),le=7,je=280,Q="C0dE",U=C.useCallback(g=>{R.current&&(clearInterval(R.current),R.current=null);const $=Q.padEnd(le),S=$+"  "+g+"  "+$;let E=0;const N=S.length-le;I(!0),M(S.slice(0,le)),R.current=setInterval(()=>{if(E++,E>N){clearInterval(R.current),R.current=null,I(!1),M(Q);return}M(S.slice(E,E+le))},je)},[]);C.useEffect(()=>{const g=wa(U),$=setInterval(()=>{Math.random()<.02&&U(St())},45e3);return()=>{g(),clearInterval($),R.current&&clearInterval(R.current)}},[U]);const[ae,oe]=C.useState(!1),ye=C.useRef(null);C.useEffect(()=>{const g=Ca(()=>{ye.current&&clearTimeout(ye.current),oe(!0),ye.current=setTimeout(()=>oe(!1),5e3)});return()=>{g(),ye.current&&clearTimeout(ye.current)}},[]);const[ie,xe]=C.useState({show:!1,options:[],selectedIndex:0,input:""}),K=C.useRef([]),de=C.useRef(0);C.useEffect(()=>{e!=null&&e.neighbors&&(w.current=Object.values(e.neighbors).map(g=>g.node_name||g.name).filter(g=>!!g).sort())},[e==null?void 0:e.neighbors]);const ce=C.useCallback(()=>{var g;(g=r.current)==null||g.write(Fn(hn()))},[]),ne=C.useCallback(()=>{const g=r.current;g&&(g.write(Ke),ce(),g.write(i.current))},[ce]),be=C.useCallback(g=>{const $=za(g,w.current);K.current=$,de.current=0;const S=$.length>0&&g.trim().length>0;xe({show:S,options:$,selectedIndex:0,input:g.trim()})},[]),$e=C.useCallback(()=>{K.current=[],de.current=0,xe({show:!1,options:[],selectedIndex:0,input:""})},[]),nt=C.useCallback(g=>{var S;const $=K.current[g];$&&(i.current=$.required?$.cmd+" ":$.cmd,ne(),$.required?be(i.current):$e(),(S=r.current)==null||S.focus())},[ne,be,$e]),kt=C.useCallback(async g=>{const $=r.current;if(!$)return;const S=g.trim();if(!S){ce();return}l.current=!0;const E=new AbortController;f.current=E,n(S),o.current=-1;let N=0;const O={get cols(){return $.cols},get rows(){return $.rows},write(L,W="default"){const Me=(W==="default"?L:jt(L,W)).split(`
`);for(const we of Me)$.writeln(we);return N=ht(Me,$.cols),String(N)},update(L,W,Le){if(v.current)$.write(zn);else if(N>0)for(let Ce=0;Ce<N;Ce++)$.write(Un()),$.write(Ke);const we=(Le?jt(W,Le):W).split(`
`);if(v.current){for(const Ce of we)$.write(Ce+Hn+`\r
`);$.write(Gn)}else for(const Ce of we)$.writeln(Ce);N=ht(we,$.cols)},clear(){$.clear(),N=0},enterFullscreen(){$.write(Wn+qn),v.current=!0,N=0},exitFullscreen(){$.write(Bt+Mt),v.current=!1,N=0}};$.writeln("");const G=Dr.find(S);if(G){const L=S.split(/\s+/);try{await G.execute({output:O,args:L,rawInput:S,cols:$.cols,signal:E.signal})}catch(W){W instanceof DOMException&&W.name==="AbortError"||O.write(`Error: ${W instanceof Error?W.message:"Command failed"}`,"error")}}else O.write(`Unknown command: ${S}
Type 'help' for available commands.`,"error");f.current=null,l.current=!1,$.writeln(""),ce()},[n,ce]),se=C.useCallback(g=>{const $=r.current;if(!$||!b.current)return;if(l.current){for(let N=0;N<g.length;N++)g.charCodeAt(N)===3&&f.current&&(f.current.abort(),$.writeln("^C"));return}const S=or.getState().commandHistory,E=N=>requestAnimationFrame(()=>{var O;return(O=document.querySelector(`[data-ac-index="${N}"]`))==null?void 0:O.scrollIntoView({block:"nearest"})});for(let N=0;N<g.length;N++){const O=g.charCodeAt(N);if(O===13){if(K.current.length>0){const L=K.current[de.current];L&&(i.current=L.cmd,ne())}$e();const G=i.current;i.current="",$.writeln(""),kt(G);continue}if(O===127||O===8){i.current.length>0&&(i.current=i.current.slice(0,-1),$.write("\b \b"),be(i.current));continue}if(O===3){i.current="",$e(),$.writeln("^C"),ce();continue}if(O===12){$.clear(),$e(),ne();continue}if(O===9){K.current.length>0&&nt(de.current);continue}if(O===27){if(g.charCodeAt(N+1)===91){const G=g.charCodeAt(N+2);if(N+=2,G===65){if(K.current.length>0){const L=Math.max(de.current-1,0);de.current=L,xe(W=>({...W,selectedIndex:L})),E(L)}else S.length>0&&(o.current===-1&&(c.current=i.current),o.current<S.length-1&&(o.current++,i.current=S[S.length-1-o.current]||"",ne()));continue}if(G===66){if(K.current.length>0){const L=Math.min(de.current+1,K.current.length-1);de.current=L,xe(W=>({...W,selectedIndex:L})),E(L)}else o.current>0?(o.current--,i.current=S[S.length-1-o.current]||"",ne()):o.current===0&&(o.current=-1,i.current=c.current,ne());continue}if(G===67||G===68)continue;continue}K.current.length>0&&$e();continue}O>=32&&(i.current+=g[N],$.write(g[N]),o.current=-1,be(i.current))}},[$e,be,nt,ce,ne,kt]);C.useEffect(()=>{k.current=se},[se]);const Or=C.useCallback(async()=>{const g=r.current;if(!g||x.current)return;x.current=!0;const $="\x1B[94m",S="\x1B[0m",E=ft.length,N=br-1;try{const G=Oe(ft,0);for(const L of G)g.writeln(L);await new Promise(L=>{let W=0;const Le=setInterval(()=>{if(W>=N){clearInterval(Le),L();return}W++,g.write(`\x1B[${E}F`);const Me=Oe(ft,W);for(const we of Me)g.write(`\x1B[2K${we}
`)},yr)})}finally{xr()}g.writeln(""),g.write(u("● Initializing terminal...")),await new Promise(G=>setTimeout(G,300)),g.write(Ke),g.writeln(`${$}✓ Initializing terminal...${S}`),g.write(u("● Connecting to repeater...")),await new Promise(G=>setTimeout(G,500)),g.write(Ke),gn.getState().health==="connected"?g.writeln(`${$}✓ Connected to repeater${S}`):g.writeln(In("~ Connection status unknown")),g.writeln(u("Ready. Type 'help' for commands.")),g.writeln(""),ce(),b.current=!0},[ce]);C.useEffect(()=>{const g=t.current;if(!g)return;const $=Fe()?12:13,S=new Vr({theme:Cr(),fontFamily:'"JetBrains Mono", "IBM Plex Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace',fontSize:$,lineHeight:Fe()?1.1:.65,cursorBlink:!1,cursorStyle:"underline",scrollback:1e4,convertEol:!0,allowTransparency:!0,rightClickSelectsWord:!1}),E=new Yr;S.loadAddon(E),S.loadAddon(new Qr),S.open(g),E.fit(),r.current=S,s.current=E;const N=S.onData(L=>k.current(L)),O=Yn(S),G=new ResizeObserver(()=>{requestAnimationFrame(()=>E.fit())});return G.observe(g),Or(),Fe()||S.focus(),()=>{var L;(L=f.current)==null||L.abort(),v.current&&(S.write(Bt+Mt),v.current=!1),N.dispose(),O(),G.disconnect(),S.dispose(),r.current=null,s.current=null}},[]);const Pr=C.useCallback(g=>{const $=g.target.value;$.length>0&&(se($),g.target.value="")},[se]),Ur=C.useCallback(g=>{g.key==="Enter"?(g.preventDefault(),se("\r")):g.key==="Backspace"?(g.preventDefault(),se("")):g.key==="ArrowUp"?(g.preventDefault(),se("\x1B[A")):g.key==="ArrowDown"&&(g.preventDefault(),se("\x1B[B"))},[se]),Hr=C.useCallback(()=>{var g,$;Fe()?(g=a.current)==null||g.focus():($=r.current)==null||$.focus()},[]);C.useEffect(()=>{if(!Fe())return;const g=()=>{var N;const E=(N=t.current)==null?void 0:N.querySelector(".xterm-viewport");E&&(E.scrollTop=E.scrollHeight),requestAnimationFrame(()=>{var O;return(O=s.current)==null?void 0:O.fit()})},$=window.visualViewport;if($){const E=()=>{$.height<window.innerHeight*.75&&g()};return $.addEventListener("resize",E),()=>$.removeEventListener("resize",E)}const S=a.current;if(S){const E=()=>setTimeout(g,300);return S.addEventListener("focus",E),()=>S.removeEventListener("focus",E)}},[]);const zr=C.useCallback(g=>{i.current=g+" ",ne(),be(i.current),setTimeout(()=>{var $;($=t.current)==null||$.click()},400)},[ne,be]);return d.jsx(_n,{children:d.jsx(Cn,{children:d.jsxs("div",{className:"terminal-card flex flex-col gap-1 sm:gap-1.5",children:[d.jsxs("div",{className:"card-terminal-header flex-wrap",children:[d.jsx("span",{className:"seven-seg-panel",children:d.jsx(kn,{text:B,minChars:7,size:24,noCycle:D})}),d.jsx("div",{className:"header-well self-stretch flex-col sm:order-first",children:d.jsxs("div",{className:`indicator-key${T==="connected"?" indicator-key--active":T==="degraded"?" indicator-key--sending":""}`,children:[d.jsx("span",{className:"indicator-key__label",children:"ONLINE"}),d.jsx("span",{className:"indicator-key__led"})]})}),d.jsx("div",{className:"card-terminal-ridge flex-1 min-w-4 sm:hidden"}),d.jsxs("div",{className:"header-well flex items-center gap-1 sm:order-last",children:[d.jsx(Ua,{onUseCommand:zr}),d.jsx(Ba,{})]}),d.jsx("div",{className:"card-terminal-ridge flex-1 min-w-8 hidden sm:block"})]}),d.jsx(Sn,{noPadding:!0,className:"flex flex-col flex-1 min-h-0 overflow-hidden card-terminal",onClick:Hr,children:d.jsxs("div",{className:"card-terminal-well flex-1 min-h-0 flex flex-col overflow-hidden",children:[d.jsxs("div",{className:"flex-1 min-h-0 terminal-gutter relative",children:[d.jsx("div",{ref:t,className:"h-full w-full"}),ae&&d.jsxs("div",{className:"absolute inset-0 z-10 flex items-center justify-center",onClick:()=>oe(!1),children:[d.jsx("div",{className:"absolute inset-0 animate-[partytime-bg_5s_ease-out_forwards]",style:{background:"rgba(0,0,0,0.82)"}}),d.jsxs("div",{className:"relative z-10 animate-[partytime-crt_5s_ease-out_forwards] partytime-glow",children:[d.jsx("img",{src:"/assets/partytime.gif",alt:"No way.",className:"max-h-[60vh] max-w-[70vw] object-contain rounded"}),d.jsx("div",{className:"absolute inset-0 pointer-events-none rounded partytime-scanlines"})]})]})]}),ie.show&&ie.options.length>0&&d.jsxs("div",{className:"flex-shrink-0 overflow-hidden terminal-completions",style:{borderTop:"1px solid var(--terminal-border)",background:"var(--terminal-bg-input)"},children:[d.jsx("div",{className:"overflow-y-auto",style:{maxHeight:"176px"},children:ie.options.map((g,$)=>{const S=$===ie.selectedIndex,E=ie.input.length;return d.jsxs("div",{"data-ac-index":$,onClick:()=>nt($),className:et("terminal-ac-option",S?"text-sys-blue":"text-fg-primary"),style:{background:S?"var(--terminal-autocomplete-hover)":void 0},onMouseEnter:N=>{S||(N.currentTarget.style.background="var(--terminal-autocomplete-hover)")},onMouseLeave:N=>{S||(N.currentTarget.style.background="")},children:[d.jsx("span",{className:"terminal-ac-option__indicator",children:S?"▸":""}),d.jsxs("span",{className:"terminal-ac-option__cmd",children:[d.jsx("span",{className:"font-semibold text-sys-blue",children:g.cmd.substring(0,E)}),g.cmd.substring(E)]}),d.jsx("span",{className:"terminal-ac-option__desc",children:g.desc})]},g.cmd)})}),d.jsxs("div",{className:"terminal-ac-hints",children:[d.jsx("span",{className:"hidden sm:inline",children:"Tab · ↑↓ · Esc"}),d.jsx("span",{className:"sm:hidden",children:"Tap to select"}),d.jsxs("span",{children:[ie.options.length," match",ie.options.length!==1?"es":""]})]})]}),d.jsxs("div",{className:"terminal-mobile-input-bar sm:hidden",children:[d.jsx("input",{ref:a,type:"text",className:"terminal-mobile-input",onChange:Pr,onKeyDown:Ur,autoComplete:"off",autoCorrect:"off",autoCapitalize:"off",spellCheck:!1,enterKeyHint:"send","aria-label":"Terminal input",placeholder:"Type command..."}),d.jsx("button",{type:"button",className:"terminal-send-btn",onClick:()=>se("\r"),"aria-label":"Run command",children:d.jsx(En,{})})]}),d.jsxs("div",{className:"terminal-status-bar",children:[d.jsx("span",{className:"hidden sm:inline",children:"↑↓ History · Tab · Esc"}),d.jsx("span",{className:"sm:hidden",children:"Tap input to type"}),(e==null?void 0:e.version)&&d.jsxs("span",{children:["pyMC v",e.version]})]})]})})]})})})}export{co as default};
