import{r as e,j as t,c as s}from"./vendor-react-j_fHog8x.js";import{c as a,b as n,aJ as l,aK as i,aL as r,ai as o,aM as c,f as m,aN as d,aO as u,u as h,aP as x,$ as p,aQ as f,aR as g,aS as y,aT as b,aU as j,aV as v,am as N,aW as w,aX as k,ax as M,aY as S,aZ as C,ay as T,a_ as A,o as F,q as P,p as R,j as L,aF as D,Y as _,r as $,J as E,a$ as z,t as B,b0 as H,_ as q,R as O,b1 as W}from"./index-Bt1KDuaU.js";import{u as G}from"./usePolling-B1kG3uqm.js";import{L as I}from"./layers-Cdgw_0Y_.js";import{C as Y,e as V}from"./easing-LmR6eRHf.js";import{E as X,A as U,T as K}from"./TimeRangeSelector-BCL5rzPK.js";import{a as Q,P as Z,b as J,B as ee}from"./PageLayout-D8vz2ocg.js";import{D as te}from"./DataBox-DPgMXR-x.js";import{C as se}from"./CollisionExplorerModal-C8S5sHsV.js";import{C as ae,a as ne}from"./Card-3mNdXzAx.js";import{H as le,R as ie}from"./route-DZ7Dc8dm.js";import{I as re}from"./info-CSQbqnly.js";import{T as oe}from"./triangle-alert-2e9gOTqR.js";import{G as ce}from"./git-branch-CwXrKJUX.js";import{L as me}from"./LightSparkline-96Ro4wc3.js";import{A as de}from"./activity-JsU-Cz5Q.js";import{R as ue,C as he}from"./Grid-OFJ4oe0a.js";import{S as xe}from"./settings-2-DPq78iIB.js";import{N as pe}from"./network-ir0q8-pH.js";import"./maplibre-gl-b91ci4Kr.js";import"./vendor-core-CDNU4oKM.js";import"./index-BUkvedki.js";import"./config-Cu72TjJC.js";import"./copy-NRQvf5_q.js";import"./BasemapLayer-Dkb0XoZP.js";import"./map-pin-CySB8aJ2.js";const fe=a("chart-line",[["path",{d:"M3 3v16a2 2 0 0 0 2 2h16",key:"c24i48"}],["path",{d:"m19 9-5 5-4-4-3 3",key:"2osh9i"}]]),ge=a("circle-check-big",[["path",{d:"M21.801 10A10 10 0 1 1 17 3.335",key:"yps3ct"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]]),ye=a("grid-3x3",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}],["path",{d:"M3 9h18",key:"1pudct"}],["path",{d:"M3 15h18",key:"5xshup"}],["path",{d:"M9 3v18",key:"fh3hqa"}],["path",{d:"M15 3v18",key:"14nvp0"}]]),be=a("grip",[["circle",{cx:"12",cy:"5",r:"1",key:"gxeob9"}],["circle",{cx:"19",cy:"5",r:"1",key:"w8mnmm"}],["circle",{cx:"5",cy:"5",r:"1",key:"lttvr7"}],["circle",{cx:"12",cy:"12",r:"1",key:"41hilf"}],["circle",{cx:"19",cy:"12",r:"1",key:"1wjl8i"}],["circle",{cx:"5",cy:"12",r:"1",key:"1pcz8c"}],["circle",{cx:"12",cy:"19",r:"1",key:"lyex9k"}],["circle",{cx:"19",cy:"19",r:"1",key:"shf9b7"}],["circle",{cx:"5",cy:"19",r:"1",key:"bfqh0e"}]]),je=a("id-card",[["path",{d:"M16 10h2",key:"8sgtl7"}],["path",{d:"M16 14h2",key:"epxaof"}],["path",{d:"M6.17 15a3 3 0 0 1 5.66 0",key:"n6f512"}],["circle",{cx:"9",cy:"11",r:"2",key:"yxgjnd"}],["rect",{x:"2",y:"5",width:"20",height:"14",rx:"2",key:"qneu4z"}]]),ve=a("radar",[["path",{d:"M19.07 4.93A10 10 0 0 0 6.99 3.34",key:"z3du51"}],["path",{d:"M4 6h.01",key:"oypzma"}],["path",{d:"M2.29 9.62A10 10 0 1 0 21.31 8.35",key:"qzzz0"}],["path",{d:"M16.24 7.76A6 6 0 1 0 8.23 16.67",key:"1yjesh"}],["path",{d:"M12 18h.01",key:"mhygvu"}],["path",{d:"M17.99 11.66A6 6 0 0 1 15.77 16.67",key:"1u2y91"}],["circle",{cx:"12",cy:"12",r:"2",key:"1c9p78"}],["path",{d:"m13.41 10.59 5.66-5.66",key:"mhq4k0"}]]),Ne=a("sparkle",[["path",{d:"M11.017 2.814a1 1 0 0 1 1.966 0l1.051 5.558a2 2 0 0 0 1.594 1.594l5.558 1.051a1 1 0 0 1 0 1.966l-5.558 1.051a2 2 0 0 0-1.594 1.594l-1.051 5.558a1 1 0 0 1-1.966 0l-1.051-5.558a2 2 0 0 0-1.594-1.594l-5.558-1.051a1 1 0 0 1 0-1.966l5.558-1.051a2 2 0 0 0 1.594-1.594z",key:"1s2grr"}]]),we=a("waves",[["path",{d:"M2 6c.6.5 1.2 1 2.5 1C7 7 7 5 9.5 5c2.6 0 2.4 2 5 2 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1",key:"knzxuh"}],["path",{d:"M2 12c.6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 2.6 0 2.4 2 5 2 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1",key:"2jd2cc"}],["path",{d:"M2 18c.6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 2.6 0 2.4 2 5 2 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1",key:"rd2r6e"}]]),ke={useAbsoluteThresholds:!0,baselinePercentile:6,spikePercentile:50,baselineDbm:-107,spikeDbm:-100,mergeGapSeconds:45,minSequenceLength:16,similarityToleranceDbm:5};function Me(e,t){if(0===e.length)return 0;const s=t/100*(e.length-1),a=Math.floor(s),n=Math.ceil(s);return a===n?e[a]:e[a]+(e[n]-e[a])*(s-a)}function Se(e){if(0===e.length)return{median:0,p90:0,p95:0,p99:0,max:0,min:0};const t=[...e].sort((e,t)=>e-t);return{median:Me(t,50),p90:Me(t,90),p95:Me(t,95),p99:Me(t,99),max:t[t.length-1],min:t[0]}}function Ce(e,t,s){const a=s-t;if(0===a)return"moderate";const n=(e-t)/a;return n>.66?"critical":n>.33?"severe":"moderate"}function Te({sortedTypes:a,highlightedType:l,onTypeHover:i,aggregateShares:r,hoverData:o}){const c=e.useMemo(()=>{if(!o)return null;const e=new Map;for(const t of o.items)e.set(t.key,t.value);return e},[o]),m=null!==c;return t.jsx("div",{className:"flex-shrink-0 pt-3 mt-2",children:t.jsx("div",{className:"flex flex-wrap gap-x-4 gap-y-1 font-mono text-xs ml-9",onMouseLeave:()=>i(null),children:a.map(e=>{const a=n(e.typeNum),o=(null==c?void 0:c.get(e.key))??0,d=r.get(e.key)??0,u=m?o:d,h=u>1e-4,x=l===e.key,p=l&&!x||m&&o<=1e-4;return t.jsxs("div",{className:s("flex items-center gap-1.5 transition-opacity cursor-pointer hover:opacity-80",p&&"opacity-30"),onMouseEnter:()=>i(e.key),children:[t.jsx("div",{className:"shrink-0 w-3 h-3 rounded-xs",style:{backgroundColor:a}}),t.jsx("span",{className:"text-text-secondary whitespace-nowrap",children:e.label}),h&&t.jsxs("span",{className:s("tabular-nums",m?"text-text-primary":"text-text-muted"),children:[(100*u).toFixed(1),"%"]})]},e.key)})})})}const Ae='ui-monospace, SFMono-Regular, "SF Mono", Menlo, Consolas, monospace';function Fe(e,t,s,a,n){const l=e.reduce((e,t)=>e+t,0);if(l<=0||0===e.length)return[];const i=e.map((e,t)=>t).sort((t,s)=>e[s]-e[t]),r=i.map(t=>e[t]),o=new Array(e.length);return Pe(r,i,l,t,s,a,n,o),o}function Pe(e,t,s,a,n,l,i,r){if(0===e.length)return;if(1===e.length)return void(r[t[0]]={x:a,y:n,w:l,h:i,index:t[0]});const o=l*i/s,c=l>=i,m=c?i:l;let d=0,u=1/0,h=0;for(let b=0;b<e.length;b++){const t=d+e[b],s=t*o/m;if(s<=0){h=b+1,d=t;continue}const a=e[0]*o/s,n=e[b]*o/s,l=Math.max(a>s?a/s:s/a,n>s?n/s:s/n);if(!(l<=u))break;u=l,h=b+1,d=t}const x=m>0?d*o/m:0;let p=0;for(let b=0;b<h;b++){const s=(d>0?e[b]/d:0)*m;r[t[b]]=c?{x:a,y:n+p,w:x,h:s,index:t[b]}:{x:a+p,y:n,w:s,h:x,index:t[b]},p+=s}const f=e.slice(h),g=t.slice(h),y=s-d;c?Pe(f,g,y,a+x,n,l-x,i,r):Pe(f,g,y,a,n+x,l,i-x,r)}function Re(e,t,s,a,l,i){for(const r of t){const t=s[r.index];if(!t)continue;const o=2*i,c=r.x*i+o/2,m=r.y*i+o/2,d=r.w*i-o,u=r.h*i-o;if(d<=0||u<=0)continue;const h=n(t.typeNum),x=null!==l&&l!==r.index;e.save(),e.globalAlpha=x?.4:1;const p=3*i;e.beginPath(),e.moveTo(c+p,m),e.lineTo(c+d-p,m),e.quadraticCurveTo(c+d,m,c+d,m+p),e.lineTo(c+d,m+u-p),e.quadraticCurveTo(c+d,m+u,c+d-p,m+u),e.lineTo(c+p,m+u),e.quadraticCurveTo(c,m+u,c,m+u-p),e.lineTo(c,m+p),e.quadraticCurveTo(c,m,c+p,m),e.closePath(),e.fillStyle=h,e.fill(),e.strokeStyle="rgba(0,0,0,0.2)",e.lineWidth=1*i,e.stroke();const f=4*i,g=r.w>36&&r.h>20,y=r.w>36&&r.h>32;if(g){const s=11*i;if(y){const n=a>0?t.size/a*100:0;e.font=`500 ${8*i}px ${Ae}`,e.fillStyle="rgba(0,0,0,0.6)",e.textBaseline="alphabetic",e.textAlign="left",e.fillText(`${n.toFixed(1)}%`,c+f,m+u-f-s)}e.font=`600 ${9*i}px ${Ae}`,e.fillStyle="rgba(0,0,0,0.85)",e.textBaseline="alphabetic",e.textAlign="left",e.fillText(t.name,c+f,m+u-f)}e.restore()}}function Le({data:e,total:s,color:a,position:n,containerWidth:l,isAirtime:i}){if(!e||!n)return null;const r=(e.value/s*100).toFixed(1),o=l-n.x<184?Math.max(8,n.x-160-8):n.x+16;return t.jsx("div",{className:"absolute z-50 pointer-events-none",style:{left:o,top:Math.max(8,n.y-60)},children:t.jsxs("div",{className:"bg-tooltip-bg border border-border-subtle rounded-lg px-3 py-2 shadow-xl min-w-[140px]",children:[t.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[t.jsx("span",{className:"w-2.5 h-2.5 rounded-sm flex-shrink-0",style:{backgroundColor:a}}),t.jsx("span",{className:"type-data-sm font-semibold text-text-primary",children:e.name})]}),t.jsxs("div",{className:"space-y-0.5 type-data-xs text-text-muted",children:[t.jsxs("div",{className:"flex justify-between gap-4",children:[t.jsx("span",{children:i?"Airtime":"Count"}),t.jsx("span",{className:"text-text-primary tabular-nums font-medium",children:i?De(e.value):e.value.toLocaleString()})]}),t.jsxs("div",{className:"flex justify-between gap-4",children:[t.jsx("span",{children:"Share"}),t.jsxs("span",{className:"text-text-primary tabular-nums font-medium",children:[r,"%"]})]}),t.jsxs("div",{className:"flex justify-between gap-4",children:[t.jsx("span",{children:"Total"}),t.jsx("span",{className:"text-text-primary tabular-nums font-medium",children:i?De(s):s.toLocaleString()})]})]})]})})}function De(e){return e>=6e4?`${(e/6e4).toFixed(1)}m`:e>=1e3?`${(e/1e3).toFixed(1)}s`:`${Math.round(e)}ms`}function _e({sortedTypes:s,aggregateShares:a,mode:l="share"}){var i,r,o;const[c,m]=e.useState(null),[d,u]=e.useState(null),[h,x]=e.useState(0),[p,f]=e.useState(null),g=e.useRef(null),y=e.useRef(null),b=e.useRef([]),j="airtime"===l,v=e.useMemo(()=>s.reduce((e,t)=>e+(j?t.totalAirtime:t.totalCount),0),[s,j]),N=e.useMemo(()=>s.map((e,t)=>({name:e.label,size:j?e.totalAirtime:e.totalCount,index:t,typeNum:e.typeNum,key:e.key})),[s,j]);e.useEffect(()=>{const e=y.current;if(!e)return;const t=e.parentElement;if(!t)return;const s=t.getBoundingClientRect(),a=s.width,n=s.height;if(a<=0||n<=0)return;const l=window.devicePixelRatio||1;e.width=Math.floor(a*l),e.height=Math.floor(n*l),e.style.width=`${a}px`,e.style.height=`${n}px`;const i=Fe(N.map(e=>e.size),0,0,a,n);b.current=i;const r=e.getContext("2d");r&&(r.clearRect(0,0,e.width,e.height),Re(r,i,N,v,c,l))},[N,v,c]),e.useEffect(()=>{const e=g.current;if(!e)return;const t=new ResizeObserver(()=>{const t=y.current;if(!t)return;const s=e.getBoundingClientRect(),a=s.width,n=s.height;if(a<=0||n<=0)return;const l=window.devicePixelRatio||1;t.width=Math.floor(a*l),t.height=Math.floor(n*l),t.style.width=`${a}px`,t.style.height=`${n}px`;const i=Fe(N.map(e=>e.size),0,0,a,n);b.current=i;const r=t.getContext("2d");r&&(r.clearRect(0,0,t.width,t.height),Re(r,i,N,v,c,l))});return t.observe(e),()=>t.disconnect()},[N,v]);const w=e.useCallback(e=>{const t=g.current;if(!t)return;const s=t.getBoundingClientRect(),a=e.clientX-s.left,n=e.clientY-s.top,l=function(e,t,s){for(const a of e)if(t>=a.x&&t<=a.x+a.w&&s>=a.y&&s<=a.y+a.h)return a.index;return null}(b.current,a,n);m(l),null!==l?(x(s.width),u({x:a,y:n})):u(null)},[]),k=e.useCallback(()=>{m(null),u(null)},[]),M=e.useCallback(e=>{if(f(e),e){const t=N.findIndex(t=>t.key===e);m(t>=0?t:null)}else m(null)},[N]),S=null!==c?{name:(null==(i=N[c])?void 0:i.name)??"",value:(null==(r=N[c])?void 0:r.size)??0}:null,C=null!==c?n(null==(o=N[c])?void 0:o.typeNum):"";return 0===s.length||0===v?t.jsxs("div",{className:"h-full flex items-center justify-center text-text-muted",children:[t.jsx(I,{className:"w-6 h-6 mr-2 opacity-50"}),t.jsx("span",{children:"No packet type data available"})]}):t.jsxs("div",{className:"flex flex-col h-full",children:[t.jsxs("div",{className:"flex-1 min-h-0 relative",ref:g,onMouseMove:w,onMouseLeave:k,children:[t.jsx("canvas",{ref:y,className:"absolute inset-0",style:{cursor:"default"}}),t.jsx(Le,{data:S,total:v,color:C,position:d,containerWidth:h,isAirtime:j})]}),t.jsx(Te,{sortedTypes:s,highlightedType:p,onTypeHover:M,aggregateShares:a})]})}function $e(e){return e>=1e9?`${(e/1e9).toFixed(1)} Gb`:e>=1e6?`${(e/1e6).toFixed(1)} Mb`:e>=1e3?`${(e/1e3).toFixed(1)} Kb`:`${e.toFixed(0)} B`}function Ee({packets:s,mode:a,startTs:n,endTs:d,radioConfig:u,bucketCount:h}){const x=e.useMemo(()=>l(),[]),p=x.blue,f=x.red,g=x.yellow,[y,b]=e.useState(null),{trendData:j,totals:v}=e.useMemo(()=>{if(0===s.length)return{trendData:[],totals:{rxBytes:0,txBytes:0,rxAirtime:0,txAirtime:0}};const e=d-n,t=Math.min(Math.ceil(e/300),h),l=e/t,o=[];let c=0,m=0,x=0,p=0;for(const a of s){const e=a.timestamp;if(e<n||e>=d)continue;const t=i(a),s=r(a,{spreadingFactor:u.sf,bandwidthHz:u.bw,codingRate:u.cr,preambleLength:u.preamble}),l={timestamp:e,rxAirtime:0,txAirtime:0,rxBytes:0,txBytes:0};a.transmitted?(l.txAirtime=s,l.txBytes=t,m+=t,p+=s):(l.rxAirtime=s,l.rxBytes=t,c+=t,x+=s),o.push(l)}o.sort((e,t)=>e.timestamp-t.timestamp);const f=new Float64Array(o.length+1),g=new Float64Array(o.length+1),y=new Float64Array(o.length+1),b=new Float64Array(o.length+1),j=new Float64Array(o.length);for(let s=0;s<o.length;s++)f[s+1]=f[s]+o[s].rxAirtime,g[s+1]=g[s]+o[s].txAirtime,y[s+1]=y[s]+o[s].rxBytes,b[s+1]=b[s]+o[s].txBytes,j[s]=o[s].timestamp;const v=e=>{let t=0,s=j.length;for(;t<s;){const a=t+s>>>1;j[a]<e?t=a+1:s=a}return t},N=[],w=1e3*l;for(let s=0;s<t;s++){const e=n+s*l,t=e+l,i=v(e),r=v(t);if("share"===a){const t=y[r]-y[i],s=b[r]-b[i];N.push({timestamp:e,rx:t>0?t:null,tx:s>0?s:null})}else{const t=(f[r]-f[i])/w*100,s=(g[r]-g[i])/w*100;N.push({timestamp:e,rx:t>0?t:null,tx:s>0?s:null})}}const k=2/31;let M=null;return{trendData:N.map(e=>{const t=e.rx;return null!==t&&t>0&&(M=null===M?t:k*t+(1-k)*M),{...e,rxSmooth:null!==M&&M>0?M:null}}),totals:{rxBytes:c,txBytes:m,rxAirtime:x,txAirtime:p}}},[s,n,d,h,a,u]),N=e.useMemo(()=>{if(0===j.length)return"share"===a?100:10;let e=0;for(const s of j){const t=s.rx??0,a=s.tx??0;t>e&&(e=t),a>e&&(e=a)}const t=1.1*e;return"share"===a?t<=100?100:t<=500?100*Math.ceil(t/100):t<=1e3?200*Math.ceil(t/200):t<=5e3?500*Math.ceil(t/500):t<=1e4?1e3*Math.ceil(t/1e3):5e3*Math.ceil(t/5e3):Math.max(1,Math.ceil(t))},[j,a]),w=e.useMemo(()=>{if(null!==y&&j[y]){const e=j[y],t=e.rx??0,s=e.tx??0;return"share"===a?{rx:$e(t),tx:$e(s),total:$e(t+s),isHovered:!0}:{rx:`${t.toFixed(2)}%`,tx:`${s.toFixed(2)}%`,total:`${(t+s).toFixed(2)}%`,isHovered:!0}}if("share"===a)return{rx:$e(v.rxBytes),tx:$e(v.txBytes),total:$e(v.rxBytes+v.txBytes),isHovered:!1};{let e=0,t=0,s=0;for(const l of j)null===l.rx&&null===l.tx||(e+=l.rx??0,t+=l.tx??0,s++);const a=s>0?e/s:0,n=s>0?t/s:0;return{rx:`${a.toFixed(2)}%`,tx:`${n.toFixed(2)}%`,total:`${(a+n).toFixed(2)}%`,isHovered:!1}}},[y,j,v,a]),k=e.useMemo(()=>{const e=d-n,t=e/3600;return[0,.25,.5,.75,1].map(s=>{const a=new Date(1e3*(n+e*s)),l=a.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hour12:!1}),i=a.toLocaleDateString([],{weekday:"short"});return{pct:s,label:t>24?`${i} ${l}`:l,mobileHidden:.25===s||.75===s}})},[n,d]),M=e.useCallback(e=>{b(e)},[]);return 0===j.length?t.jsxs("div",{className:"h-full flex items-center justify-center text-text-muted",children:[t.jsx(I,{className:"w-6 h-6 mr-2 opacity-50"}),t.jsx("span",{children:"No packet data available"})]}):t.jsxs("div",{className:"flex flex-col h-full",children:[t.jsxs("div",{className:"flex-1 min-h-0 relative",children:[t.jsx("div",{className:"absolute top-0 left-0 right-0 z-10 flex items-center text-text-secondary",style:{height:20,paddingLeft:44,paddingRight:8},children:t.jsx("div",{className:"relative w-full h-full flex items-center",children:k.map((e,s)=>t.jsxs("div",{className:"absolute flex items-center gap-0.5 sm:gap-1 type-data-xs "+(e.mobileHidden?"hidden sm:flex":""),style:{left:100*e.pct+"%",transform:0===e.pct?"translateX(0)":1===e.pct?"translateX(-100%)":"translateX(-50%)"},children:[t.jsx(o,{className:"w-2.5 h-2.5 opacity-60 hidden sm:block"}),t.jsx("span",{className:"tabular-nums",children:e.label})]},s))})}),t.jsx("div",{className:"absolute inset-0 rounded-lg overflow-hidden",style:{paddingTop:20},children:t.jsx(c,{data:j,yAxisMode:"share"===a?"share":"airtime",yMax:N,onHover:M})})]}),t.jsxs("div",{className:"flex items-center justify-between mt-1.5 sm:mt-2",children:[t.jsxs("div",{className:"flex items-center gap-2 sm:gap-4 text-xs font-mono pl-2 sm:pl-11",children:[t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx("div",{className:"w-3 sm:w-4 h-0.5",style:{backgroundColor:p}}),t.jsx("span",{className:"text-text-secondary",children:"RX"})]}),t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx("div",{className:"w-3 sm:w-4 h-0.5",style:{backgroundColor:f}}),t.jsx("span",{className:"text-text-secondary",children:"TX"})]}),t.jsxs("div",{className:"hidden sm:flex items-center gap-1.5",children:[t.jsx("div",{className:"w-4 h-0.5",style:{backgroundColor:g}}),t.jsx("span",{className:"text-text-secondary",children:"Avg"})]})]}),t.jsxs("div",{className:"flex flex-wrap gap-4 sm:gap-8",children:[t.jsxs("div",{className:"flex items-end gap-2",children:[t.jsx("div",{className:"type-data-xl text-text-primary",children:w.rx}),t.jsx(m,{color:"zinc",className:"mb-0.5 sm:mb-1",children:"RX"})]}),t.jsxs("div",{className:"flex items-end gap-2",children:[t.jsx("div",{className:"type-data-xl text-text-primary",children:w.tx}),t.jsx(m,{color:"zinc",className:"mb-0.5 sm:mb-1",children:"TX"})]})]})]})]})}const ze=d;function Be({mode:s,packets:a,startTs:n,endTs:l,radioConfig:o,sortedTypes:c,aggregateShares:m,noiseFloorAnomalies:d,showNoiseFloorOverlay:h,overlayOpacity:x=.5}){const[p,f]=e.useState(null),[g,y]=e.useState(null),b=e.useMemo(()=>(l-n)/3600,[n,l]),j=e.useCallback(e=>{y(e)},[]),v=function(t,s,a,n,l){return e.useMemo(()=>{if(0===t.length||!l)return null;const e=t.filter(e=>e.timestamp>=s&&e.timestamp<=a);if(0===e.length)return null;const o=[],c=new Map;for(const t of e){const e=t.type??t.payload_type??-1,a=i(t);let m;if(m="airtime"===n?r(t,{spreadingFactor:l.sf,bandwidthHz:l.bw,codingRate:l.cr,preambleLength:l.preamble}):1,a<=0)continue;const d=Math.floor((t.timestamp-s)/300),u={timestamp:t.timestamp,airtimeMs:m,byteSize:a,packetType:e,bucketIndex:d};o.push(u),c.has(d)||c.set(d,[]),c.get(d).push(u)}if(0===o.length)return null;const m=[],d=[],u=[],h=new Map;if("share"===n)for(const[,t]of c)for(const e of t)h.set(e,e.byteSize);else for(const[,t]of c){const e=t.reduce((e,t)=>e+t.airtimeMs,0)/3e5*100;let s=0;for(const a of t)a.airtimeMs>s&&(s=a.airtimeMs);for(const a of t){const t=a.airtimeMs/s*e;h.set(a,t)}}for(const t of o){const e=h.get(t);void 0!==e&&(m.push(e),d.push(t.timestamp),u.push(t.packetType))}let x=d[0],p=d[0];for(let t=1;t<d.length;t++)d[t]<x&&(x=d[t]),d[t]>p&&(p=d[t]);const f=p-x||1,g=[...m].sort((e,t)=>e-t),y=g[0],b=g[g.length-1],j=Math.floor(.05*g.length),v=Math.floor(.5*g.length),N=Math.min(Math.ceil(.95*g.length),g.length-1),w=g[j],k=g[v],M=g[N],S=new Map;for(const t of m){const e=Math.round(100*t)/100;S.set(e,(S.get(e)??0)+1)}const C=S.size,T=[...S.entries()].sort((e,t)=>t[1]-e[1]).slice(0,5).map(([e,t])=>({value:e,count:t,percent:t/m.length*100}));let A;if("share"===n)A=200;else{const e=5,t=Math.ceil(b/e)*e;A=t<=10?10:t+e}const F=new Float32Array(2*m.length),P=new Float32Array(m.length),R=new Uint8Array(m.length),L=new Float32Array(m.length);for(let t=0;t<m.length;t++){const e=(d[t]-x)/f,s=1-Math.max(0,Math.min(A,m[t]))/A;F[2*t]=e,F[2*t+1]=s,P[t]=m[t],R[t]=u[t]>=0?u[t]:255,L[t]=d[t]}return{points:F,rawValues:P,packetTypes:R,timestamps:L,count:m.length,minTime:x,maxTime:p,minValue:0,maxValue:A,rawMinValue:y,rawMaxValue:b,unit:"%",stats:{p5:w,p50:k,p95:M,uniqueValues:C,topValues:T}}},[t,s,a,n,l])}(a,n,l,"share"===s?"share":"airtime",o),[N,w]=e.useState(null),k=e.useCallback((e,t)=>{f(e),w(t??null)},[]),M=e.useMemo(()=>{if(null===N||!v||0===v.count)return null;const e=v.maxTime-v.minTime||1,t=v.minTime+N*e;let s;s=b>=168?75:b>=72?35:b>=24?15:b>=3?10:5;const a=60*s/2;return{start:t-a,end:t+a}},[N,v,b]),S=e.useMemo(()=>M?new Date((M.start+M.end)/2*1e3).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hour12:!1}):null,[M]),C=e.useMemo(()=>{if(null===p||!M)return null;const e=S??"",{start:t,end:n}=M,l=a.filter(e=>e.timestamp>=t&&e.timestamp<n);if(0===l.length)return{timestamp:(t+n)/2,timeLabel:e,items:c.map(e=>({key:e.key,label:e.label,value:0,color:ze(e.typeNum)}))};const i=new Map,m=new Map;let d=0,u=0;for(const s of l){const e=`TYPE_${s.type??s.payload_type??-1}`;if(i.set(e,(i.get(e)??0)+1),d++,o){const t=r(s,{spreadingFactor:o.sf,bandwidthHz:o.bw,codingRate:o.cr,preambleLength:o.preamble});m.set(e,(m.get(e)??0)+t),u+=t}}const h=c.map(e=>{let t;return t="airtime"===s?u>0?(m.get(e.key)??0)/u:0:d>0?(i.get(e.key)??0)/d:0,{key:e.key,label:e.label,value:t,color:ze(e.typeNum)}});return{timestamp:(t+n)/2,timeLabel:e,items:h}},[p,M,S,a,c,s,o]);return v&&0!==v.count?t.jsxs("div",{className:"flex flex-col h-full",children:[t.jsxs("div",{className:"flex-1 min-h-0 relative",children:[t.jsx("div",{className:"absolute inset-0 rounded-lg overflow-hidden",children:t.jsx(u,{scatterData:v,yAxisMode:"share"===s?"share":"airtime",onHover:k,noiseFloorAnomalies:d,showNoiseFloorOverlay:h,overlayOpacity:x,highlightedType:g,timeRangeHours:b})}),S&&t.jsx("div",{className:"absolute top-1 right-1 px-2 py-0.5 bg-bg-elevated/90 rounded text-xs text-accent-secondary font-mono pointer-events-none",children:S})]}),t.jsx(Te,{sortedTypes:c,highlightedType:g,onTypeHover:j,aggregateShares:m,hoverData:C})]}):t.jsxs("div",{className:"h-full flex items-center justify-center text-text-muted",children:[t.jsx(I,{className:"w-6 h-6 mr-2 opacity-50"}),t.jsx("span",{children:"No packet data available"})]})}function He({mode:e,onChange:s}){return t.jsxs("div",{className:"toggle-group toggle-group-sm",children:[t.jsx("button",{onClick:()=>s("share"),className:"toggle-group-item "+("share"===e?"active":""),children:"Total"}),t.jsx("button",{onClick:()=>s("airtime"),className:"toggle-group-item "+("airtime"===e?"active":""),children:"Airtime"})]})}function qe({smoothing:e,onChange:s}){return t.jsxs("div",{className:"toggle-group toggle-group-sm",children:[t.jsx("button",{onClick:()=>s("stats"),className:"toggle-group-item "+("stats"===e?"active":""),title:"Statistics view (scatter plot)",children:t.jsx(be,{className:"w-3.5 h-3.5"})}),t.jsx("button",{onClick:()=>s("trend"),className:"toggle-group-item "+("trend"===e?"active":""),title:"Trend line chart",children:t.jsx(fe,{className:"w-3.5 h-3.5"})}),t.jsx("button",{onClick:()=>s("ema"),className:"toggle-group-item "+("ema"===e?"active":""),title:"Stacked area (moderate smoothing)",children:t.jsx(I,{className:"w-3.5 h-3.5"})}),t.jsx("button",{onClick:()=>s("ultra"),className:"toggle-group-item "+("ultra"===e?"active":""),title:"Stacked area (heavy smoothing)",children:t.jsx(we,{className:"w-3.5 h-3.5"})}),t.jsx("button",{onClick:()=>s("mosaic"),className:"toggle-group-item "+("mosaic"===e?"active":""),title:"Mosaic view (treemap)",children:t.jsx(ye,{className:"w-3.5 h-3.5"})})]})}function Oe({enabled:e,onChange:s,anomalyCount:a=0,showTuning:n=!1,onTuningChange:l}){return t.jsxs("div",{className:"relative inline-flex items-center gap-1",children:[e&&l&&t.jsx("button",{onClick:()=>l(!n),className:"toggle-group toggle-group-sm "+(n?"active":""),title:n?"Hide tuning panel":"Show tuning panel",children:t.jsx("span",{className:"toggle-group-item "+(n?"active":""),children:t.jsx(xe,{className:"w-3.5 h-3.5"})})}),t.jsx("button",{onClick:()=>s(!e),className:"toggle-group toggle-group-sm "+(e?"active":""),title:e?"Hide noise floor anomalies":"Show noise floor anomalies",children:t.jsx("span",{className:"toggle-group-item "+(e?"active":""),children:t.jsx(X,{className:"w-3.5 h-3.5"})})}),a>0&&t.jsx("span",{className:"absolute -top-2 -right-2 min-w-[18px] h-[18px] px-1 rounded-full bg-accent-danger text-white text-[10px] font-bold flex items-center justify-center pointer-events-none z-10",children:a>99?"99+":a})]})}const We={sf:10,bw:25e4,cr:5,preamble:8};function Ge(e){return p[e]??`TYPE_${e.toString(16).toUpperCase()}`}function Ie(e,t,s,a){const n=2*a+1;let l=0;for(let i=0;i<=a;i++)l+=e[Math.min(i,s-1)];for(let i=0;i<a;i++)l+=e[0];for(let i=0;i<s;i++){t[i]=l/n;const r=i-a,o=i+a+1;l-=e[Math.max(0,Math.min(r,s-1))],l+=e[Math.max(0,Math.min(o,s-1))]}}const Ye={ema:1800,ultra:14400},Ve={ema:"sma",ultra:"gaussian"};function Xe(e,t,s){const a=Ye[e],n=Ve[e]??"sma";if(!a)return{sigma:0,window:1,handleSize:0};let l=Math.round(a/t);l=Math.max(3,Math.min(l,Math.floor(s/3))),l%2==0&&(l+=1);const i="gaussian"===n?Math.ceil(l*Math.sqrt(4/12)*3):Math.ceil(l/2);return"gaussian"===n?{sigma:l*Math.sqrt(4/12),window:l,handleSize:i}:{sigma:0,window:l,handleSize:i}}const Ue=e.memo(function({packets:s,startTs:a,endTs:l,bucketCount:i,radioConfig:o=We,mode:c="share",smoothing:m="stats",noiseFloorAnomalies:d=null,showNoiseFloorOverlay:u=!1,overlayOpacity:p=.5}){const f=h(),[g,y]=e.useState(null),[b,j]=e.useState(null),[v,N]=e.useState([]),w=e.useRef(null),k=e.useRef(0);e.useEffect(()=>{const e=Math.abs(s.length-k.current);if(0===e&&v.length>0)return;w.current&&clearTimeout(w.current);const t=e>100?50:500;return w.current=setTimeout(()=>{k.current=s.length,N(s)},t),()=>{w.current&&clearTimeout(w.current)}},[s,v.length]);const M=e.useMemo(()=>function(e,t){const s=new Map;for(const n of e){const e=n.type??n.payload_type??-1,a=r(n,{spreadingFactor:t.sf,bandwidthHz:t.bw,codingRate:t.cr,preambleLength:t.preamble}),l=s.get(e)??{count:0,airtime:0};s.set(e,{count:l.count+1,airtime:l.airtime+a})}const a=[];for(const[n,l]of s)a.push({typeNum:n,key:`TYPE_${n}`,label:Ge(n),totalCount:l.count,totalAirtime:l.airtime});return a.sort((e,t)=>t.totalCount-e.totalCount)}(v,o),[v,o]),S=e.useMemo(()=>{if("ema"!==m&&"ultra"!==m)return 0;const e=(l-a)/i,{handleSize:t}=Xe(m,e,i);return t},[m,a,l,i]),C=e.useMemo(()=>function(e,t,s,a,n,l,i=0){const o=s-t,c=o/a,m=1e3*c,d=o/3600,u=t-i*c,h=s+i*c,x=a+2*i,p=[];for(let r=0;r<x;r++){const e=u+r*c,t=new Date(1e3*e),s={timestamp:e,time:d>24?t.toLocaleDateString([],{weekday:"short",hour:"2-digit",minute:"2-digit",hour12:!1}):t.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hour12:!1}),counts:{},shares:{},airtimes:{},total:0,totalAirtime:0,bucketDurationMs:m};for(const a of l)s.counts[a.key]=0,s.airtimes[a.key]=0;p.push(s)}for(const f of e){const e=f.timestamp;if(e<u||e>=h)continue;const t=Math.min(Math.floor((e-u)/c),x-1),s=`TYPE_${f.type??f.payload_type??-1}`;p[t].counts[s]=(p[t].counts[s]??0)+1,p[t].total++;const a=r(f,{spreadingFactor:n.sf,bandwidthHz:n.bw,codingRate:n.cr,preambleLength:n.preamble});p[t].airtimes[s]=(p[t].airtimes[s]??0)+a,p[t].totalAirtime+=a}for(const r of p)for(const e of l)r.shares[e.key]=r.total>0?r.counts[e.key]/r.total*100:0;return{buckets:p,visibleStart:i,visibleEnd:i+a}}(v,a,l,i,o,M,S),[v,a,l,i,o,M,S]),T=e.useMemo(()=>M.reduce((e,t)=>e+t.totalCount,0),[M]),A=e.useMemo(()=>M.reduce((e,t)=>e+t.totalAirtime,0),[M]),{sortedTypes:F,aggregateShares:P}=e.useMemo(()=>{const e=new Map,t="share"===c?T:A;if(t>0)for(const s of M){const a="share"===c?s.totalCount:s.totalAirtime;e.set(s.key,a/t)}return{sortedTypes:[...M].sort((t,s)=>(e.get(s.key)??0)-(e.get(t.key)??0)),aggregateShares:e}},[M,T,A,c]),R=e.useMemo(()=>function(e,t,s,a="ultra",n,l,i){var r;const{buckets:o,visibleStart:c,visibleEnd:m}=e,d=o.length,u=s.length,h=m-c;if(0===d||0===u)return[];const x=i&&void 0!==n&&void 0!==l?(l-n)/i:(null==(r=o[0])?void 0:r.bucketDurationMs)?o[0].bucketDurationMs/1e3:240,p=Array.from({length:u},()=>new Array(d).fill(0));for(let N=0;N<d;N++){const e=o[N];if("share"===t){if(e.total>0)for(let t=0;t<u;t++)p[t][N]=(e.counts[s[t].key]??0)/e.total}else{let t=0;for(let a=0;a<u;a++)t+=e.airtimes[s[a].key]??0;if(t>0)for(let a=0;a<u;a++)p[a][N]=(e.airtimes[s[a].key]??0)/t}}const{sigma:f,window:g}=Xe(a,x,h);let y;y=f>0?p.map(e=>function(e,t){const s=e.length;if(0===s)return[];if(t<.5)return[...e];const a=Math.sqrt(12*t*t/3+1);let n=Math.floor(a);n%2==0&&n--;const l=n+2,i=(12*t*t-3*n*n-12*n-9)/(-4*n-4),r=Math.round(i),o=[r>0?n:l,r>1?n:l,r>2?n:l];let c=new Float32Array(e);const m=new Float32Array(s);for(const d of o){Ie(c,m,s,(d-1)/2);const e=c;c=m,m.set(e)}return Array.from(c)}(e,f)):p.map(e=>function(e,t){if(0===e.length)return[];if(t<=1)return[...e];const s=e.length,a=new Float32Array(s),n=Math.floor(t/2);let l=0,i=0;for(let r=0;r<=Math.min(n,s-1);r++)l+=e[r],i++;for(let r=0;r<s;r++){a[r]=l/i;const t=r-n,o=r+n+1;t>=0&&(l-=e[t],i--),o<s&&(l+=e[o],i++)}return Array.from(a)}(e,g));for(let N=0;N<d;N++){let e=0;for(let t=0;t<u;t++)y[t][N]=Math.max(0,y[t][N]),e+=y[t][N];if(e>0){const t=1/e;for(let e=0;e<u;e++)y[e][N]*=t}}const b=h>360?Math.ceil(h/360):1,j=Math.ceil(h/b),v=[];for(let N=0;N<j;N++){const e=c+N*b,t=Math.min(c+(N+1)*b,m),a=t-e,n=new Array(u).fill(0);for(let s=e;s<t;s++)for(let e=0;e<u;e++)n[e]+=y[e][s];for(let s=0;s<u;s++)n[s]/=a;let l=0;for(let s=0;s<u;s++)l+=n[s];if(l>0){const e=1/l;for(let t=0;t<u;t++)n[t]*=e}const i={timestamp:o[e].timestamp,time:o[e].time};for(let r=0;r<u;r++)i[s[r].key]=n[r];v.push(i)}return v}(C,c,F,m,a,l,i),[C,c,F,m,a,l,i]),L=e.useCallback(e=>y(e),[]),D=e.useCallback(e=>j(e),[]),_=e.useCallback(e=>y(e),[]),$=e.useMemo(()=>{if(null===b||!R[b])return null;const e=R[b];return{timestamp:e.timestamp,timeLabel:e.time,items:F.map(t=>({key:t.key,label:t.label,value:e[t.key]??0,color:n(t.typeNum)}))}},[b,R,F]),E=e.useMemo(()=>({timestamps:R.map(e=>e.timestamp),series:F.map(e=>({key:e.key,label:e.label,color:n(e.typeNum),values:R.map(t=>t[e.key]??0)}))}),[R,F]);return 0===v.length?0===s.length?t.jsxs("div",{className:"h-full flex items-center justify-center text-text-muted",children:[t.jsx(I,{className:"w-6 h-6 mr-2 opacity-50"}),t.jsx("span",{children:"No packet data available"})]}):null:"mosaic"===m?t.jsx(_e,{sortedTypes:F,aggregateShares:P,mode:c}):"stats"===m?t.jsx(Be,{mode:c,packets:v,startTs:a,endTs:l,radioConfig:o,sortedTypes:F,aggregateShares:P,noiseFloorAnomalies:d,showNoiseFloorOverlay:u,overlayOpacity:p}):"trend"===m?t.jsx(Ee,{packets:v,mode:c,startTs:a,endTs:l,radioConfig:o,bucketCount:i}):t.jsxs("div",{className:"flex flex-col h-full",children:[t.jsx("div",{className:"flex-1 min-h-0 relative",children:t.jsx("div",{className:"absolute inset-0 rounded-lg overflow-hidden",children:t.jsx(x,{timestamps:E.timestamps,series:E.series,highlightedKey:g,cursorColor:f.cursor,onHover:D,onSeriesHover:_,overlayLine:null})})}),t.jsx(Te,{sortedTypes:F,highlightedType:g,onTypeHover:L,aggregateShares:P,hoverData:$})]})}),Ke={"1x":1,"2x":2,"4x":4,"8x":8,"16x":16,"36x":36},Qe=[1,5,10,25,50,100,150];function Ze(e,t,s,a){const n=Math.PI/180,l=(a-t)*n,i=e*n,r=s*n,o=Math.sin(l)*Math.cos(r),c=Math.cos(i)*Math.sin(r)-Math.sin(i)*Math.cos(r)*Math.cos(l);return(180*Math.atan2(o,c)/Math.PI+360)%360}function Je(e,t,s,a){const n=Math.PI/180,l=(s-e)*n,i=(a-t)*n,r=Math.sin(l/2)**2+Math.cos(e*n)*Math.cos(s*n)*Math.sin(i/2)**2;return 12742*Math.atan2(Math.sqrt(r),Math.sqrt(1-r))}const et=[{min:10,label:"Excellent"},{min:7,label:"Very Good"},{min:4,label:"Good"},{min:1,label:"Fair+"},{min:-2,label:"Fair"},{min:-5,label:"Fair-"},{min:-8,label:"Poor"},{min:-11,label:"Bad"},{min:-1/0,label:"Critical"}];function tt(e,t){return t[N(e)]||"#808080"}const st=e.memo(function({neighbors:s,quickNeighbors:a,localLat:n,localLon:l,onStatsChange:i,title:r,badge:o,stats:c}){const[d,u]=e.useState(null),[h,x]=e.useState(new Set),[p,N]=e.useState({width:0,height:0}),[w,k]=e.useState("1x"),[M,S]=e.useState(1),C=e.useRef(null),T=e.useRef({}),A=e.useRef(null),F=e.useRef(M);F.current=M;const P=f(),R=g(),L=y(),D=b(),_=j(),$=_?D.primary:D.secondary,E=_?.15:.4,z=_?.08:.25,B=_?R.primary:D.primary;e.useEffect(()=>{const e=A.current;if(!e)return;const t=new ResizeObserver(e=>{for(const t of e){const{width:e,height:s}=t.contentRect;e>0&&s>0&&N({width:e,height:s})}});t.observe(e);const s=e.getBoundingClientRect();return s.width>0&&s.height>0&&N({width:s.width,height:s.height}),()=>t.disconnect()},[]);const H=e.useMemo(()=>{const e=new Set;if(a)for(const t of a)e.add(t.hash);return e},[a]),q=e.useMemo(()=>{const e=new Map;if(a)for(const t of a)e.set(t.hash,{snr:t.avgSnr,rssi:t.avgRssi});return e},[a]),{processedNeighbors:O,maxDistance:W,totalNeighbors:G,zeroHopCount:I}=e.useMemo(()=>{const e=[];for(const[a,i]of Object.entries(s)){if(!i.latitude||!i.longitude||0===i.latitude||0===i.longitude)continue;if(!H.has(a))continue;const t=Ze(n,l,i.latitude,i.longitude),s=Je(n,l,i.latitude,i.longitude),r=q.get(a);e.push({hash:a.slice(0,8),name:i.node_name||i.name||"Unknown",snr:(null==r?void 0:r.snr)??i.snr??null,rssi:(null==r?void 0:r.rssi)??i.rssi??null,bearing:t,distance:s,normalizedDistance:0,lastSeen:i.last_seen,isZeroHop:!0})}const t=1.08*(e.length>0?Math.max(...e.map(e=>e.distance)):0);return e.sort((e,t)=>(e.snr??-1/0)-(t.snr??-1/0)),{processedNeighbors:e,maxDistance:t,totalNeighbors:e.length,zeroHopCount:e.length}},[s,n,l,H,q]);e.useEffect(()=>{null==i||i({zeroHopCount:I,totalCount:G,maxDistanceKm:W})},[I,G,W]),e.useEffect(()=>{const e=Ke[w],t=F.current;C.current&&cancelAnimationFrame(C.current);const s=performance.now(),a=n=>{const l=n-s,i=Math.min(l/400,1),r=V(i);S(t+(e-t)*r),C.current=i<1?requestAnimationFrame(a):null};return C.current=requestAnimationFrame(a),()=>{C.current&&cancelAnimationFrame(C.current)}},[w]);const X=W/M,U=e.useMemo(()=>Qe.filter(e=>e<=1.1*X),[X]);e.useEffect(()=>{const e=[];for(const s of O){const t=T.current[s.hash];void 0!==t&&t!==s.lastSeen&&e.push(s.hash),T.current[s.hash]=s.lastSeen}if(0===e.length)return;queueMicrotask(()=>{x(t=>new Set([...t,...e]))});const t=setTimeout(()=>{x(t=>{const s=new Set(t);return e.forEach(e=>s.delete(e)),s})},600);return()=>clearTimeout(t)},[O]);const K=0!==n&&0!==l,Q=e.useMemo(()=>{const{width:e,height:t}=p,s=r?22:0,a=e/2,n=t/2+s,l=t-2*s,i=Math.min(e,l),o=Math.max(10,i/2-6);return{width:e,height:t,centerX:a,centerY:n,radius:Math.max(10,o-8),labelRadius:o}},[p,r]),{width:Z,height:J,centerX:ee,centerY:te,radius:se,labelRadius:ae}=Q,ne=e.useId(),le=e.useCallback((e,t)=>{const s=e*Math.PI/180;return{x:ee+se*t*Math.sin(s),y:te-se*t*Math.cos(s)}},[ee,te,se]),ie=e.useCallback(e=>{const t={N:0,NE:45,E:90,SE:135,S:180,SW:225,W:270,NW:315}[e]*Math.PI/180;return{x:ee+ae*Math.sin(t),y:te-ae*Math.cos(t)}},[ee,te,ae]),re=e.useCallback(e=>{u(e)},[]),oe=e.useCallback(e=>{k(e)},[]),ce=e.useCallback(e=>W<=0?0:e/W*M,[W,M]),me=e=>`${e}km`,de=e.useMemo(()=>{const e=U.map(e=>{const t=e/W*M;return{km:e,scale:t,labelY:te-se*t*Math.SQRT1_2}}).filter(e=>e.scale<=1.05&&e.scale>=.02).sort((e,t)=>t.km-e.km),t=[];for(const s of e)t.some(e=>Math.abs(e.labelY-s.labelY)<28)||t.push(s);return t},[U,W,M,te,se]),ue=p.width>0&&p.height>0;return K?0===G?t.jsxs("div",{ref:A,className:"flex flex-col items-center justify-center h-full text-text-secondary",children:[t.jsx(Y,{className:"w-8 h-8 mb-2 opacity-50"}),t.jsx("p",{children:"No nodes with location data"})]}):t.jsxs("div",{ref:A,className:"relative h-full w-full overflow-hidden",children:[r&&t.jsx("div",{className:"absolute top-0 left-0 right-0 z-20 pointer-events-none",children:t.jsx("div",{className:"flex flex-col gap-1 flex-shrink-0 px-4 pt-4 pb-2 sm:px-5 sm:pt-5",children:t.jsxs("div",{className:"flex items-center justify-between gap-2 min-h-[32px] whitespace-nowrap",children:[t.jsxs("div",{className:"flex items-center gap-3 pointer-events-auto flex-shrink-0",children:[t.jsx("span",{className:"icon-md flex items-center justify-center text-icon-card-title",children:t.jsx(Y,{className:"w-4 h-4"})}),t.jsx("span",{className:"type-subheading text-text-primary",children:r}),o&&t.jsx(m,{color:"teal",children:o})]}),c&&t.jsx("div",{className:"pointer-events-auto hidden sm:flex items-center gap-1.5 min-w-0 overflow-hidden",children:c})]})})}),ue&&t.jsxs("svg",{width:Z,height:J,className:"absolute inset-0 z-0",children:[t.jsxs("defs",{children:[t.jsx("style",{children:"\n                @keyframes neighbor-blink-scale {\n                  0%, 100% {\n                    transform: scale(1);\n                    opacity: 0;\n                  }\n                  50% {\n                    transform: scale(1.3);\n                    opacity: 0.8;\n                  }\n                }\n                .neighbor-blink-ring {\n                  transform-origin: center;\n                  animation: neighbor-blink-scale 600ms ease-out forwards;\n                }\n              "}),t.jsx("clipPath",{id:ne,children:t.jsx("circle",{cx:ee,cy:te,r:se})})]}),U.map(e=>{const s=ce(e);if(s>1.05||s<.02)return null;const a=de.some(t=>t.km===e),n=ee+se*s*Math.SQRT1_2,l=te-se*s*Math.SQRT1_2;return t.jsxs("g",{children:[t.jsx("circle",{cx:ee,cy:te,r:se*s,fill:"none",stroke:$,strokeOpacity:E,strokeWidth:1}),a&&t.jsx("text",{x:n+4,y:l-2,textAnchor:"start",dominantBaseline:"auto",className:"fill-text-secondary",fontSize:10,fontFamily:v,children:me(e)})]},`ring-${e}`)}),["N","E","S","W"].map(e=>{const s={N:0,E:90,S:180,W:270}[e]*Math.PI/180;return t.jsx("line",{x1:ee,y1:te,x2:ee+se*Math.sin(s),y2:te-se*Math.cos(s),stroke:$,strokeOpacity:E,strokeWidth:1,strokeDasharray:"4 4"},e)}),["NE","SE","SW","NW"].map(e=>{const s={NE:45,SE:135,SW:225,NW:315}[e]*Math.PI/180;return t.jsx("line",{x1:ee,y1:te,x2:ee+se*Math.sin(s),y2:te-se*Math.cos(s),stroke:$,strokeOpacity:z,strokeWidth:1,strokeDasharray:"4 4"},`diag-${e}`)}),["N","E","S","W"].map(e=>{const s=ie(e),a="E"===e?"end":"W"===e?"start":"middle",n="N"===e?"hanging":"S"===e?"auto":"middle";return t.jsx("text",{x:s.x,y:s.y,textAnchor:a,dominantBaseline:n,fill:B,fontSize:10,fontWeight:700,fontFamily:v,"aria-hidden":"true",children:e},e)}),["NE","SE","SW","NW"].map(e=>{const s=ie(e),a="NE"===e||"SE"===e?"end":"start",n="NE"===e||"NW"===e?"hanging":"auto";return t.jsx("text",{x:s.x,y:s.y,textAnchor:a,dominantBaseline:n,fill:B,fontSize:9,fontWeight:600,fontFamily:v,"aria-hidden":"true",children:e},e)}),t.jsx("circle",{cx:ee,cy:te,r:5,fill:L.chart6,stroke:_?"rgba(255,255,255,0.3)":"rgba(0,0,0,0.2)",strokeWidth:1,role:"img","aria-label":"Local node"}),t.jsx("g",{clipPath:`url(#${ne})`,children:O.map(e=>{const s=W>0?e.distance/W*M:0;if(s>1)return null;const{x:a,y:n}=le(e.bearing,s),l=null!==e.snr?tt(e.snr,P):"#808080",i=(null==d?void 0:d.hash)===e.hash,r=h.has(e.hash);return t.jsxs("g",{role:"img","aria-label":`${e.name}: ${e.distance.toFixed(1)}km ${e.bearing.toFixed(0)}°`,children:[r&&t.jsx("circle",{cx:a,cy:n,r:10.5,fill:"none",stroke:_?"rgba(255,255,255,0.9)":"rgba(0,0,0,0.7)",strokeWidth:2,className:"neighbor-blink-ring"}),i&&t.jsx("circle",{cx:a,cy:n,r:10.5,fill:l,opacity:.3}),t.jsx("circle",{cx:a,cy:n,r:i?7:5,fill:l,stroke:_?"rgba(0,0,0,0.5)":"rgba(0,0,0,0.25)",strokeWidth:1,style:{cursor:"pointer",transition:"r 0.15s"},onMouseEnter:()=>re(e),onMouseLeave:()=>re(null)})]},e.hash)})})]}),t.jsx("div",{className:"absolute z-10 flex flex-col gap-1",role:"group","aria-label":"Zoom level",style:{left:ue?ee+ae+8:void 0,top:ue?te:void 0,transform:"translateY(-50%)"},children:["1x","2x","4x","8x","16x","36x"].map(e=>t.jsx("button",{onClick:()=>oe(e),"aria-pressed":w===e,className:"flex items-center justify-center w-7 h-7 text-[10px] font-medium rounded transition-colors "+(w===e?"bg-accent-primary/20 text-accent-primary":"bg-subtle-fill/80 text-text-secondary hover:bg-subtle-fill-strong hover:text-text-primary"),children:e},e))}),d&&t.jsxs("div",{className:"absolute bg-tooltip-bg border border-border-subtle rounded-lg px-3 py-2 text-sm pointer-events-none z-10 shadow-xl",style:{left:"50%",bottom:8,transform:"translateX(-50%)"},children:[t.jsx("div",{className:"font-medium text-text-primary",children:d.name}),t.jsx("div",{className:"text-text-secondary text-xs font-mono",children:d.hash}),null!==d.snr?t.jsx("div",{className:"flex gap-3 mt-1 text-xs",children:t.jsxs("span",{children:[t.jsx("span",{className:"text-text-secondary",children:"SNR:"})," ",t.jsxs("span",{className:"tabular-nums",style:{color:tt(d.snr,P)},children:[d.snr.toFixed(1)," dB"]}),t.jsxs("span",{className:"text-text-secondary ml-1",children:["(",(he=d.snr,(null==(xe=et.find(e=>he>=e.min))?void 0:xe.label)??"Critical"),")"]})]})}):t.jsx("div",{className:"text-xs text-text-secondary mt-1",children:"No SNR data"}),t.jsxs("div",{className:"flex gap-3 text-xs",children:[t.jsxs("span",{children:[t.jsx("span",{className:"text-text-secondary",children:"Distance:"})," ",t.jsxs("span",{className:"tabular-nums text-text-primary",children:[d.distance.toFixed(2)," km"]})]}),t.jsxs("span",{children:[t.jsx("span",{className:"text-text-secondary",children:"Bearing:"})," ",t.jsxs("span",{className:"tabular-nums text-text-primary",children:[d.bearing.toFixed(0),"°"]})]})]})]})]}):t.jsxs("div",{ref:A,className:"flex flex-col items-center justify-center h-full text-text-secondary",children:[t.jsx(Y,{className:"w-8 h-8 mb-2 opacity-50"}),t.jsx("p",{children:"Local node coordinates not configured"}),t.jsx("p",{className:"text-xs mt-1",children:"Set latitude/longitude in config to enable"})]});var he,xe}),at={repeater:"var(--accent-primary)",companion:"var(--accent-tertiary)",room_server:"var(--accent-secondary)"};function nt(e){if(e.contact_type){const t=e.contact_type.toLowerCase();if("repeater"===t||"rep"===t)return"repeater";if("room server"===t||"room_server"===t||"room"===t||"server"===t)return"room_server";if("companion"===t||"client"===t||"cli"===t)return"companion"}return e.is_repeater?"repeater":"companion"}const lt=e.memo(function({neighbors:s}){const a=e.useMemo(()=>{const e={repeater:0,companion:0,room_server:0};for(const a of Object.values(s)){const t=nt(a);e[t]=(e[t]||0)+1}const t=Object.values(e).reduce((e,t)=>e+t,0);return{items:[{label:"Repeaters",count:e.repeater,percent:0,color:at.repeater},{label:"Companions",count:e.companion,percent:0,color:at.companion},{label:"Room Servers",count:e.room_server,percent:0,color:at.room_server}].map(e=>({...e,percent:t>0?e.count/t*100:0})).filter(e=>e.count>0).sort((e,t)=>t.count-e.count),total:t}},[s]);return 0===a.total?t.jsx("div",{className:"h-full flex items-center justify-center text-text-muted type-body-sm",children:"No neighbors discovered yet"}):t.jsxs("div",{className:"h-full flex flex-col",children:[t.jsx("div",{className:"flex-1 flex flex-col justify-evenly",children:a.items.map(e=>t.jsxs("div",{className:"flex flex-col gap-1.5",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("span",{className:"type-data-sm text-text-secondary",children:e.label}),t.jsxs("span",{className:"type-data-sm text-text-secondary tabular-nums",children:[e.count," ",t.jsxs("span",{className:"text-text-secondary/60",children:["(",e.percent.toFixed(0),"%)"]})]})]}),t.jsx("div",{className:"h-2.5 bg-bg-elevated overflow-hidden",children:t.jsx("div",{className:"h-full transition-all duration-500 ease-out",style:{width:`${e.percent}%`,backgroundColor:e.color,minWidth:e.count>0?"4px":"0"}})})]},e.label))}),t.jsxs("div",{className:"flex items-center justify-between pt-2 border-t border-border-subtle",children:[t.jsx("span",{className:"type-data-xs text-text-secondary",children:"Total Nodes"}),t.jsx("span",{className:"type-data-sm text-text-primary font-medium tabular-nums",children:a.total})]})]})});function it({children:s,minHeight:a="100%",rootMargin:n="200px 0px",keepMounted:l=!0,className:i=""}){const r=e.useRef(null),[o,c]=e.useState(!1),[m,d]=e.useState(!1);e.useEffect(()=>{const e=r.current;if(!e)return;const t=new IntersectionObserver(([e])=>{const t=e.isIntersecting;d(t),t&&c(!0)},{rootMargin:n,threshold:0});return t.observe(e),()=>{t.disconnect()}},[n]);const u=m||l&&o;return t.jsx("div",{ref:r,className:`h-full w-full ${i}`,style:{minHeight:a},children:u?s:t.jsx("div",{className:"h-full w-full flex items-center justify-center text-text-muted/50",children:t.jsx("div",{className:"animate-pulse text-xs",children:"Loading chart..."})})})}const rt={excellent:"text-signal-excellent",good:"text-signal-good",fair:"text-signal-fair",poor:"text-accent-primary"},ot={excellent:"bg-signal-excellent/10",good:"bg-signal-good/10",fair:"bg-signal-fair/10",poor:"bg-accent-primary/10"};function ct(){const s=w(),a=k(),[n,l]=e.useState(null),i=e.useCallback((e,t)=>{l({prefix:e,candidateHashes:t})},[]),r=e.useCallback(()=>{l(null)},[]);if(!a)return t.jsxs(Q,{neomorphic:!0,children:[t.jsx(ae,{icon:t.jsx(le,{}),title:"Prefix Conflicts",largeTitle:!0}),t.jsx("div",{className:"flex-1 flex items-center justify-center",children:t.jsxs("div",{className:"text-center text-text-secondary",children:[t.jsx(re,{className:"w-8 h-8 mx-auto mb-2 opacity-50"}),t.jsx("p",{className:"type-data-xs",children:"No topology data available"}),t.jsx("p",{className:"type-data-xs opacity-70",children:"Run deep analysis to see stats"})]})})]});const o=(c=s.avgConfidence)>=.9?"excellent":c>=.7?"good":c>=.5?"fair":"poor";var c;const m=(d=s.collisionRate)<=10?"excellent":d<=25?"good":"poor";var d;const u="poor"===o||"poor"===m?"poor":"fair"===o||"fair"===m?"fair":"good"===o||"good"===m?"good":"excellent",h="excellent"===u||"good"===u?ge:oe;return t.jsxs(Q,{neomorphic:!0,className:"flex flex-col overflow-hidden",children:[t.jsx(ae,{icon:t.jsx(le,{}),title:"Prefix Conflicts",largeTitle:!0,actions:t.jsxs("div",{className:`flex items-center gap-1.5 px-2.5 py-1 rounded-full ${ot[u]}`,children:[t.jsx(h,{className:`w-3.5 h-3.5 ${rt[u]}`}),t.jsx("span",{className:`type-data-xs font-medium ${rt[u]}`,children:"excellent"===u?"Excellent":"good"===u?"Good":"fair"===u?"Fair":"Needs Attention"})]})}),t.jsxs("div",{className:"flex-1 flex flex-col min-h-0",children:[t.jsxs("div",{className:"grid grid-cols-3 gap-1.5 sm:gap-2 py-3 sm:py-4",children:[t.jsxs("div",{className:"flex flex-col items-center cursor-help bg-subtle-fill radius-inner sm:radius-inset py-2 sm:py-3 px-1.5 sm:px-2",title:"Total unique 2-character prefixes observed in packet paths.",children:[t.jsx(U,{value:s.totalPrefixes,className:"font-mono text-2xl sm:text-3xl font-semibold tabular-nums text-text-primary",priority:"low"}),t.jsx("span",{className:"type-data-xs sm:type-data-sm text-text-secondary mt-0.5 sm:mt-1",children:"Prefixes"})]}),t.jsxs("div",{className:"flex flex-col items-center cursor-help bg-subtle-fill radius-inner sm:radius-inset py-2 sm:py-3 px-1.5 sm:px-2",title:"Prefixes that map to exactly one known node. No disambiguation needed.",children:[t.jsx(U,{value:s.unambiguousPrefixes,className:"font-mono text-2xl sm:text-3xl font-semibold tabular-nums text-text-primary",priority:"low"}),t.jsx("span",{className:"type-data-xs sm:type-data-sm text-text-secondary mt-0.5 sm:mt-1",children:"Unique"})]}),t.jsxs("div",{className:"flex flex-col items-center cursor-help radius-inner sm:radius-inset py-2 sm:py-3 px-1.5 sm:px-2 "+(s.collisionPrefixes>0?"bg-accent-primary/15":"bg-subtle-fill"),title:"Prefixes matching multiple known nodes. Click a prefix below to explore candidates.",children:[t.jsx(U,{value:s.collisionPrefixes,className:"font-mono text-2xl sm:text-3xl font-semibold tabular-nums "+(s.collisionPrefixes>0?"text-accent-primary":"text-text-primary"),priority:"low"}),t.jsx("span",{className:"type-data-xs sm:type-data-sm mt-0.5 sm:mt-1 "+(s.collisionPrefixes>0?"text-accent-primary":"text-text-secondary"),children:"Conflicts"})]})]}),s.highCollisionPrefixes.length>0&&t.jsxs("div",{children:[t.jsx("div",{className:"type-data-xs text-text-secondary mb-1.5",children:"Problem Prefixes"}),t.jsx("div",{className:"flex flex-wrap gap-1.5 content-start",children:s.highCollisionPrefixes.map(({prefix:e,candidateCount:s,candidateHashes:a})=>t.jsxs("button",{type:"button",onClick:()=>i(e,a),className:"inline-flex items-center gap-0.5 group",title:`${s} candidates - click to explore`,children:[t.jsx(te,{children:e}),t.jsxs("span",{className:"text-text-muted type-data-xs group-hover:text-text-secondary transition-colors",children:["×",s]})]},e))})]}),0===s.lowConfidencePrefixes.length&&0===s.collisionPrefixes&&t.jsx("div",{className:"flex-1 flex items-center",children:t.jsxs("div",{className:"flex items-center gap-1.5",children:[t.jsx(ge,{className:"w-3.5 h-3.5 text-signal-excellent"}),t.jsx("span",{className:"type-data-xs text-signal-excellent",children:"All prefixes uniquely identified"})]})}),t.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-4 mt-auto pt-3",children:[t.jsxs("div",{className:"flex items-center gap-2 cursor-help",title:"Average confidence score across all disambiguated prefixes. Higher = more certain node identification.",children:[t.jsx("span",{className:"type-data-xs text-text-secondary",children:"Confidence"}),t.jsxs("span",{className:`data-box ${rt[o]}`,children:[(100*s.avgConfidence).toFixed(1),"%"]})]}),t.jsxs("div",{className:"flex items-center gap-2 cursor-help",title:"Percentage of 2-character prefixes that match multiple known nodes. Lower is better.",children:[t.jsx("span",{className:"type-data-xs text-text-secondary",children:"Collisions"}),t.jsxs("span",{className:`data-box ${rt[m]}`,children:[s.collisionRate.toFixed(1),"%"]})]})]})]}),t.jsx(se,{isOpen:!!n,prefix:(null==n?void 0:n.prefix)||"",candidateHashes:(null==n?void 0:n.candidateHashes)||[],onClose:r})]})}function mt({icon:e,label:s,value:a,sublabel:n,highlight:l,tooltip:i}){return t.jsxs("div",{className:"flex items-center justify-between gap-2 py-1.5 "+(i?"cursor-help":""),title:i,children:[t.jsxs("div",{className:"flex items-center gap-1.5 sm:gap-2 min-w-0",children:[t.jsx("span",{className:"icon-xs text-icon-widget flex-shrink-0",children:e}),t.jsx("span",{className:"type-body-sm text-text-secondary truncate",children:s})]}),t.jsxs("div",{className:"flex items-center gap-1 sm:gap-1.5 flex-shrink-0",children:[t.jsx("span",{className:"data-box",style:l?{"--data-box-color":"var(--accent-primary)"}:void 0,children:a}),n&&t.jsx("span",{className:"type-data-xs text-text-secondary hidden sm:inline",children:n})]})]})}function dt(){const e=M(),s=S().length;if(!e||0===e.totalPaths)return null;const{totalPaths:a,pathsWithGhosts:n,observationOverrideCount:l,tracePacketsProcessed:i,pathPacketsProcessed:r,distantEdgesDiscovered:o,duplicateGroupsFound:c,duplicatePathsUnique:m,echolocationEdgesInferred:d}=e,u=a>0?((a-n)/a*100).toFixed(1):"0",h=a>0?(l/a*100).toFixed(1):"0",x=i+r,p=x>0||o>0,f=c>0||d>0;return t.jsxs(Q,{neomorphic:!0,children:[t.jsx(ae,{title:"Path Decoder",icon:t.jsx(ie,{}),largeTitle:!0,badge:s>0?`${s} hidden`:void 0}),t.jsxs(ne,{children:[t.jsxs("div",{children:[t.jsx(mt,{icon:t.jsx(je,{className:"w-3.5 h-3.5"}),label:"Traceable",value:`${u}%`,sublabel:`of ${a.toLocaleString()} paths`,tooltip:"Percentage of packet journeys where every hop was identified. Higher = better visibility into how traffic flows through your mesh."}),t.jsx(mt,{icon:t.jsx(Ne,{className:"w-3.5 h-3.5"}),label:"Learning Rate",value:`${h}%`,sublabel:"adapted",tooltip:"How often real traffic patterns improved our predictions over geography alone. Higher values mean the decoder is learning your mesh's actual behavior — which routes are preferred, which nodes are most active."})]}),p&&t.jsxs("div",{className:"mt-3",children:[t.jsx("p",{className:"type-micro mb-2",children:"Beyond Line-of-Sight"}),t.jsxs("div",{children:[t.jsx(mt,{icon:t.jsx(ve,{className:"w-3.5 h-3.5"}),label:"Route Reports",value:x.toLocaleString(),sublabel:i>0?`(${i} TRACE)`:void 0,tooltip:"TRACE/PATH packets from distant nodes share their routing tables. This reveals connections we can't directly observe — mapping parts of the mesh we don't touch."}),t.jsx(mt,{icon:t.jsx(ce,{className:"w-3.5 h-3.5"}),label:"Remote Links",value:o.toLocaleString(),highlight:o>0,tooltip:"Node-to-node connections discovered from route reports. These links exist outside our RF range but help complete the topology picture."})]})]}),f&&t.jsx(mt,{icon:t.jsx(C,{className:"w-3.5 h-3.5"}),label:"Multi-Path Packets",value:c.toLocaleString(),sublabel:m>0?`(${m} routes)`:void 0,tooltip:"Packets received via multiple paths simultaneously. Like sonar, these 'echoes' reveal redundant routes — important for understanding mesh resilience."}),s>0&&t.jsx(mt,{icon:t.jsx(T,{className:"w-3.5 h-3.5 text-accent-primary"}),label:"Ghost Repeaters",value:s,highlight:!0,tooltip:"High-confidence hidden repeaters: appear in 10+ paths, have 2+ known neighbors, ≥30% confidence, and plausible location. View them on the Contacts map."})]})]})}const ut=new Set(["Duplicate","Empty payload","Path too long","Unknown"]),ht={excellent:"bg-status-success",good:"bg-accent-primary",fair:"bg-status-warning",poor:"bg-status-danger"};function xt({packets:s,rangeMinutes:a,rangeHours:n,timeRangeLabel:l,isLoaded:i=!0}){const r=e.useMemo(()=>function(e,t){const s=Date.now()/1e3,a=60*t,n=s-a,l=a/24,i=new Array(24).fill(0),r=new Array(24).fill(0);let o=0,c=0,m=0,d=0;for(const h of e){if("tx_local"===h.packet_origin)continue;const e=h.timestamp;if(e<n||e>s)continue;o++;const t=Math.min(23,Math.floor((e-n)/l));r[t]++,h.transmitted||"tx_forward"===h.packet_origin?(c++,i[t]++):(h.is_duplicate||"Duplicate"===h.drop_reason)&&m++,h.drop_reason&&ut.has(h.drop_reason)&&d++}const u=[];for(let h=0;h<24;h++){const e=r[h],t=i[h];u.push({count:e>0?Math.round(t/e*100):0,timestamp:1e3*(n+h*l)})}return{totalRx:o,forwarded:c,duplicates:m,waste:d,efficiency:o>0?c/o*100:0,duplicateRate:o>0?m/o*100:0,wasteRate:o>0?d/o*100:0,sparkline:u}}(s,a),[s,a]),[o,c]=e.useState(null),m=e.useCallback(async()=>{try{const e=await A(n);e.success&&e.data&&c(e.data.count)}catch{}},[n]);e.useEffect(()=>{m()},[m]);const d=(u=r.efficiency)>=90?"excellent":u>=75?"good":u>=60?"fair":"poor";var u;const h=r.totalRx>0;return t.jsx(Q,{neomorphic:!0,isLoaded:i,skeletonType:"chart",children:i&&t.jsxs(t.Fragment,{children:[t.jsx(ae,{icon:t.jsx(de,{}),title:"Packet Health",badge:l,largeTitle:!0}),t.jsx(ne,{children:t.jsxs("div",{className:"flex flex-col h-full",children:[t.jsxs("div",{className:"flex items-baseline gap-2",children:[t.jsxs("div",{className:"type-data-xl text-text-primary",children:[h?t.jsx(U,{value:Math.round(10*r.efficiency)/10,className:"font-mono tabular-nums",priority:"medium",format:{minimumFractionDigits:1,maximumFractionDigits:1}}):t.jsx("span",{className:"opacity-30",children:"—"}),t.jsx("span",{className:"type-data-sm text-text-muted ml-0.5",children:"%"})]}),h&&t.jsx("div",{className:`w-2 h-2 rounded-full ${ht[d]}`})]}),t.jsx("div",{className:"type-micro mb-2 cursor-help",title:"Forwarded packets / total received. CRC failures, garbled packets, and RF collisions that destroy packets before reaching software are not included in this ratio — see CRC Errors for hardware-level failures.",children:"FORWARDING RATE"}),t.jsx("div",{className:"flex-1 min-h-[28px] max-h-[48px] mb-2",children:t.jsx(me,{data:r.sparkline,width:9999,height:36,color:"var(--accent-primary)",className:"w-full"})}),t.jsxs("div",{className:"flex gap-2 sm:gap-3 mt-auto",children:[t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsx("div",{className:"data-box-label",children:"Dupes"}),t.jsx("div",{className:"data-box data-box-fill data-box-left",children:h?`${r.duplicateRate.toFixed(1)}%`:"—"})]}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsx("div",{className:"data-box-label",children:"Waste"}),t.jsx("div",{className:"data-box data-box-fill data-box-left",children:h?`${r.wasteRate.toFixed(1)}%`:"—"})]}),null!==o&&o>0&&t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsxs("div",{className:"data-box-label flex items-center gap-1",children:[t.jsx(oe,{className:"w-3 h-3 text-status-warning"}),"CRC"]}),t.jsx("div",{className:"data-box data-box-fill data-box-left text-status-warning",children:o})]})]})]})})]})})}function pt(){var s,a,n,l,i,r,o,c,m,d,u,h,x,p,f,g,y;const b=F(),j=P(),v=R(),N=L(),w=D(),k=_(),M=$(),S=E(),[C,T]=e.useState([]),[A,Y]=e.useState(null),[V,X]=e.useState(null),[U,te]=e.useState(!0),[se,ne]=e.useState(null),[le,ie]=e.useState(()=>{const e=localStorage.getItem("statistics-view-mode");return"share"===e||"airtime"===e?e:"airtime"});e.useEffect(()=>{localStorage.setItem("statistics-view-mode",le)},[le]);const[re,oe]=e.useState(()=>{const e=localStorage.getItem("statistics-smoothing-mode");return["ema","ultra","mosaic","stats","trend"].includes(e)?e:"stats"});e.useEffect(()=>{localStorage.setItem("statistics-smoothing-mode",re)},[re]);const[ce,me]=e.useState(!1),[de,xe]=e.useState(!1),[fe,ge]=e.useState(ke),[ye,be]=e.useState(.5),je=e.useMemo(()=>({0:0,1:0,2:1,3:2,4:3,5:4,6:5,7:6}[M]??3),[M]),ve=z[je].hours,Ne=60*ve,we=z[je],Te=H(ve),Ae=k.isBackgroundLoading,Fe=e.useCallback(e=>{S({0:1,1:2,2:3,3:4,4:5,5:6,6:7}[e]??4)},[S]),Pe=e.useMemo(()=>{var e;if(!(null==(e=null==b?void 0:b.config)?void 0:e.radio))return null;const t=b.config.radio;return{sf:t.spreading_factor??10,bw:t.bandwidth??25e4,cr:t.coding_rate??5,preamble:t.preamble_length??8}},[null==(a=null==(s=null==b?void 0:b.config)?void 0:s.radio)?void 0:a.spreading_factor,null==(l=null==(n=null==b?void 0:b.config)?void 0:n.radio)?void 0:l.bandwidth,null==(r=null==(i=null==b?void 0:b.config)?void 0:i.radio)?void 0:r.coding_rate,null==(c=null==(o=null==b?void 0:b.config)?void 0:o.radio)?void 0:c.preamble_length]);e.useEffect(()=>{!async function(){var e;ne(null);try{const t=await B(ve);t.success&&(null==(e=t.data)?void 0:e.history)&&T(t.data.history)}catch(t){ne(t instanceof Error?t.message:"Failed to load chart data")}finally{te(!1)}}()},[ve]);const Re=e.useMemo(()=>72===ve?6e5:168===ve?18e5:336===ve?36e5:3e5,[ve]),Le=e.useCallback(async()=>{var e;try{const t=await B(ve);t.success&&(null==(e=t.data)?void 0:e.history)&&T(t.data.history)}catch{}},[ve]);G(Le,Re,!0,!0);const De=e.useMemo(()=>0===C.length?{timestamps:[],values:[]}:{timestamps:C.map(e=>e.timestamp),values:C.map(e=>e.noise_floor_dbm)},[C]),_e=e.useMemo(()=>{if(C.length<10)return{anomalies:[],debug:void 0};const e=function(e,t={}){const s={...ke,...t};if(e.length<10)return{anomalies:[],thresholds:Se([]),totalSamples:e.length,anomalySamples:0};const a=e.map(e=>e.noise_floor_dbm),n=Se(a),l=[...a].sort((e,t)=>e-t);let i,r;s.useAbsoluteThresholds?(i=s.baselineDbm,r=s.spikeDbm):(i=Me(l,s.baselinePercentile),r=Me(l,s.spikePercentile));const o=[...e].sort((e,t)=>e.timestamp-t.timestamp),c=[];let m=null,d=0;for(const u of o)if(u.noise_floor_dbm>i&&u.noise_floor_dbm<r)if(d++,m){const e=Math.abs(u.noise_floor_dbm-m.rollingAvg)<=s.similarityToleranceDbm,t=u.timestamp-m.endTs<=s.mergeGapSeconds;e&&t?(m.endTs=u.timestamp,m.values.push(u.noise_floor_dbm),m.timestamps.push(u.timestamp),m.rollingAvg=m.values.reduce((e,t)=>e+t,0)/m.values.length):(m.values.length>=s.minSequenceLength&&c.push(m),m={startTs:u.timestamp,endTs:u.timestamp,values:[u.noise_floor_dbm],timestamps:[u.timestamp],rollingAvg:u.noise_floor_dbm})}else m={startTs:u.timestamp,endTs:u.timestamp,values:[u.noise_floor_dbm],timestamps:[u.timestamp],rollingAvg:u.noise_floor_dbm};else m&&m.values.length>=s.minSequenceLength&&c.push(m),m=null;return m&&m.values.length>=s.minSequenceLength&&c.push(m),0===c.length?{anomalies:[],thresholds:n,totalSamples:e.length,anomalySamples:d,debug:{baselineCutoff:i,spikeCutoff:r,midBandSamples:d}}:{anomalies:c.map(e=>{const t=Math.max(...e.values),s=e.values.reduce((e,t)=>e+t,0)/e.values.length;return{startTs:e.startTs,endTs:e.endTs,peakValue:t,avgValue:s,severity:Ce(s,i,r),sampleCount:e.values.length}}),thresholds:n,totalSamples:e.length,anomalySamples:d,debug:{baselineCutoff:i,spikeCutoff:r,midBandSamples:d}}}(C,fe);return{anomalies:e.anomalies,debug:e.debug}},[C,fe]),$e=_e.anomalies,Ee=e.useMemo(()=>{const e=(null==b?void 0:b.neighbors)??{};return Object.fromEntries(Object.entries(e).filter(([e])=>!j.has(e)))},[null==b?void 0:b.neighbors,j]),ze=e.useMemo(()=>{const e=Date.now()/1e3-3600*ve;return Object.fromEntries(Object.entries(Ee).filter(([,t])=>t.last_seen>=e))},[Ee,ve]),Be=e.useMemo(()=>{const e=60*Ne/Te,t=Math.floor(Date.now()/1e3),s=Math.floor(t/e)*e;return{start:s-60*Ne,end:s}},[Ne,Te]);return t.jsxs(Z,{children:[t.jsx(J,{title:"Statistics",icon:t.jsx(q,{}),controls:t.jsx(K,{ranges:z,selectedIndex:je,onSelect:Fe,isPending:Ae})}),se&&t.jsx(Q,{className:"border border-accent-red/50 bg-accent-red/10",children:t.jsx("p",{className:"text-accent-red",children:se})}),ce&&de&&t.jsxs(Q,{className:"border border-accent-purple/30 bg-glass-surface/50",children:[t.jsxs("div",{className:"flex items-center justify-between mb-3",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("span",{className:"type-label",children:"Anomaly Detection Tuning"}),t.jsxs("span",{className:"type-data-xs text-text-muted",children:["(",we.label,")"]})]}),t.jsx("button",{onClick:()=>ge(e=>({...e,useAbsoluteThresholds:!e.useAbsoluteThresholds})),className:"type-data-xs px-2 py-1 rounded transition-colors "+(fe.useAbsoluteThresholds?"bg-accent-purple/30 text-accent-purple":"bg-glass-elevated text-text-muted hover:text-text-secondary"),children:fe.useAbsoluteThresholds?"Absolute dBm":"Percentile"})]}),t.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-4 gap-4",children:[t.jsxs("div",{children:[t.jsx("span",{className:"type-micro",children:"Baseline"}),t.jsxs("span",{className:"ml-2 type-data-sm text-status-warning",children:[(null==(d=null==(m=_e.debug)?void 0:m.baselineCutoff)?void 0:d.toFixed(1))??"—"," dBm"]})]}),t.jsxs("div",{children:[t.jsx("span",{className:"type-micro",children:"Spike"}),t.jsxs("span",{className:"ml-2 type-data-sm text-status-warning",children:[(null==(h=null==(u=_e.debug)?void 0:u.spikeCutoff)?void 0:h.toFixed(1))??"—"," dBm"]})]}),t.jsxs("div",{children:[t.jsx("span",{className:"type-micro",children:"Mid-band"}),t.jsx("span",{className:"ml-2 type-data-sm text-accent-purple",children:(null==(x=_e.debug)?void 0:x.midBandSamples)??0})]}),t.jsxs("div",{children:[t.jsx("span",{className:"type-micro",children:"Anomalies"}),t.jsx("span",{className:"ml-2 type-data-sm text-status-danger",children:$e.length})]})]}),t.jsxs("div",{className:"mt-4 pt-4 border-t border-border-subtle space-y-4",children:[fe.useAbsoluteThresholds?t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-4",children:[t.jsxs("div",{children:[t.jsxs("label",{className:"type-micro block mb-1",children:["Baseline (",fe.baselineDbm," dBm)"]}),t.jsx("input",{type:"range",min:"-120",max:"-60",value:fe.baselineDbm,onChange:e=>ge(t=>({...t,baselineDbm:Number(e.target.value)})),className:"w-full accent-accent-purple"})]}),t.jsxs("div",{children:[t.jsxs("label",{className:"type-micro block mb-1",children:["Spike (",fe.spikeDbm," dBm)"]}),t.jsx("input",{type:"range",min:"-100",max:"-20",value:fe.spikeDbm,onChange:e=>ge(t=>({...t,spikeDbm:Number(e.target.value)})),className:"w-full accent-accent-purple"})]}),t.jsxs("div",{children:[t.jsxs("label",{className:"type-micro block mb-1",children:["Merge Gap (",fe.mergeGapSeconds,"s)"]}),t.jsx("input",{type:"range",min:"5",max:"120",step:"5",value:fe.mergeGapSeconds,onChange:e=>ge(t=>({...t,mergeGapSeconds:Number(e.target.value)})),className:"w-full accent-accent-purple"})]})]}),t.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-4",children:[t.jsxs("div",{children:[t.jsxs("label",{className:"type-micro block mb-1",children:["Min Sequence (",fe.minSequenceLength,")"]}),t.jsx("input",{type:"range",min:"2",max:"20",value:fe.minSequenceLength,onChange:e=>ge(t=>({...t,minSequenceLength:Number(e.target.value)})),className:"w-full accent-accent-purple"})]}),t.jsxs("div",{children:[t.jsxs("label",{className:"type-micro block mb-1",children:["Similarity (±",fe.similarityToleranceDbm," dBm)"]}),t.jsx("input",{type:"range",min:"1",max:"15",value:fe.similarityToleranceDbm,onChange:e=>ge(t=>({...t,similarityToleranceDbm:Number(e.target.value)})),className:"w-full accent-accent-purple"})]}),t.jsxs("div",{children:[t.jsxs("label",{className:"type-micro block mb-1",children:["Opacity (",Math.round(100*ye),"%)"]}),t.jsx("input",{type:"range",min:"0.1",max:"1",step:"0.05",value:ye,onChange:e=>be(Number(e.target.value)),className:"w-full accent-accent-purple"})]})]})]}):t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-4",children:[t.jsxs("div",{children:[t.jsxs("label",{className:"type-micro block mb-1",children:["Baseline (P",fe.baselinePercentile,")"]}),t.jsx("input",{type:"range",min:"1",max:"50",value:fe.baselinePercentile,onChange:e=>ge(t=>({...t,baselinePercentile:Number(e.target.value)})),className:"w-full accent-accent-purple"})]}),t.jsxs("div",{children:[t.jsxs("label",{className:"type-micro block mb-1",children:["Spike (P",fe.spikePercentile,")"]}),t.jsx("input",{type:"range",min:"50",max:"99",value:fe.spikePercentile,onChange:e=>ge(t=>({...t,spikePercentile:Number(e.target.value)})),className:"w-full accent-accent-purple"})]}),t.jsxs("div",{children:[t.jsxs("label",{className:"type-micro block mb-1",children:["Merge Gap (",fe.mergeGapSeconds,"s)"]}),t.jsx("input",{type:"range",min:"5",max:"120",step:"5",value:fe.mergeGapSeconds,onChange:e=>ge(t=>({...t,mergeGapSeconds:Number(e.target.value)})),className:"w-full accent-accent-purple"})]})]}),t.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-4",children:[t.jsxs("div",{children:[t.jsxs("label",{className:"type-micro block mb-1",children:["Min Sequence (",fe.minSequenceLength,")"]}),t.jsx("input",{type:"range",min:"2",max:"20",value:fe.minSequenceLength,onChange:e=>ge(t=>({...t,minSequenceLength:Number(e.target.value)})),className:"w-full accent-accent-purple"})]}),t.jsxs("div",{children:[t.jsxs("label",{className:"type-micro block mb-1",children:["Similarity (±",fe.similarityToleranceDbm," dBm)"]}),t.jsx("input",{type:"range",min:"1",max:"15",value:fe.similarityToleranceDbm,onChange:e=>ge(t=>({...t,similarityToleranceDbm:Number(e.target.value)})),className:"w-full accent-accent-purple"})]}),t.jsxs("div",{children:[t.jsxs("label",{className:"type-micro block mb-1",children:["Opacity (",Math.round(100*ye),"%)"]}),t.jsx("input",{type:"range",min:"0.1",max:"1",step:"0.05",value:ye,onChange:e=>be(Number(e.target.value)),className:"w-full accent-accent-purple"})]})]})]}),t.jsxs("div",{className:"mt-4 p-3 bg-glass-elevated radius-inner",children:[t.jsx("div",{className:"type-micro mb-1",children:"Config output"}),t.jsxs("div",{className:"type-data-sm text-status-success",children:[fe.useAbsoluteThresholds?`useAbsoluteThresholds: true, baselineDbm: ${fe.baselineDbm}, spikeDbm: ${fe.spikeDbm}`:`useAbsoluteThresholds: false, baselinePercentile: ${fe.baselinePercentile}, spikePercentile: ${fe.spikePercentile}`,", mergeGapSeconds: ",fe.mergeGapSeconds,", minSequenceLength: ",fe.minSequenceLength,", similarityToleranceDbm: ",fe.similarityToleranceDbm]})]})]})]}),t.jsxs(ee,{children:[Ae&&t.jsx(ue,{template:"auto",children:t.jsx(Q,{className:"border border-accent-primary/30 bg-accent-primary/5",children:t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsxs("div",{className:"relative flex h-3 w-3",children:[t.jsx("span",{className:"animate-ping absolute inline-flex h-full w-full rounded-full bg-accent-primary opacity-75"}),t.jsx("span",{className:"relative inline-flex rounded-full h-3 w-3 bg-accent-primary"})]}),t.jsxs("div",{className:"flex-1",children:[t.jsxs("p",{className:"type-body-sm text-text-primary",children:["Loading ",we.label," data..."]}),k.loadProgress&&t.jsxs("p",{className:"type-data-xs text-text-muted mt-0.5",children:[k.loadProgress.loaded.toLocaleString()," packets (",k.loadProgress.percent,"%)"]})]})]})})}),U?t.jsx(ue,{template:"auto",children:t.jsx(Q,{neomorphic:!0,className:"text-center py-12",children:t.jsx("div",{className:"animate-pulse text-text-muted",children:"Loading statistics..."})})}):t.jsxs(t.Fragment,{children:[t.jsx(ue,{template:"hero-auto",children:t.jsx(Q,{neomorphic:!0,isLoaded:w,skeletonType:"chart",children:w&&t.jsxs(t.Fragment,{children:[t.jsx(ae,{icon:t.jsx(I,{}),title:"Packet Analyzer",badge:we.label,largeTitle:!0,stackActionsOnMobile:!0,actions:t.jsxs("div",{className:"flex flex-wrap items-center gap-2 justify-end",children:["stats"===re&&t.jsx(Oe,{enabled:ce,onChange:me,anomalyCount:$e.length,showTuning:de,onTuningChange:xe}),t.jsx(qe,{smoothing:re,onChange:oe}),t.jsx(He,{mode:le,onChange:ie})]})}),t.jsx("div",{className:"flex-1 min-h-0",children:t.jsx(Ue,{packets:N,startTs:Be.start,endTs:Be.end,bucketCount:Te,radioConfig:Pe??void 0,mode:le,smoothing:re,noiseFloorAnomalies:$e,showNoiseFloorOverlay:ce,overlayOpacity:ye})})]})})}),t.jsxs(ue,{template:"panel",children:[t.jsx(he,{span:12,md:6,children:t.jsx(Q,{neomorphic:!0,isLoaded:w,skeletonType:"chart",noPadding:w,children:w&&t.jsx(it,{children:t.jsx(st,{neighbors:ze,quickNeighbors:v,localLat:(null==(f=null==(p=null==b?void 0:b.config)?void 0:p.repeater)?void 0:f.latitude)??0,localLon:(null==(y=null==(g=null==b?void 0:b.config)?void 0:g.repeater)?void 0:y.longitude)??0,onStatsChange:X,title:"Link Quality",badge:we.label,stats:V?t.jsxs("span",{className:"type-data-xs text-text-muted tabular-nums whitespace-nowrap",children:[t.jsx("span",{className:"text-text-secondary font-medium",children:V.zeroHopCount}),"/",t.jsx("span",{className:"text-text-secondary font-medium",children:V.totalCount})," nbr · ",t.jsx("span",{className:"text-text-secondary font-medium",children:V.maxDistanceKm.toFixed(0)}),"km"]}):void 0})})})}),t.jsx(he,{span:12,md:6,children:t.jsx(Q,{neomorphic:!0,isLoaded:w,skeletonType:"chart",children:w&&t.jsxs(t.Fragment,{children:[t.jsx(ae,{icon:t.jsx(pe,{}),title:"Network Composition",badge:we.label,largeTitle:!0}),t.jsx("div",{className:"flex-1 min-h-0",children:t.jsx(it,{children:t.jsx(lt,{neighbors:ze})})})]})})})]}),t.jsxs(ue,{template:"panel",children:[t.jsx(he,{span:12,md:6,children:t.jsx(ct,{})}),t.jsx(he,{span:12,md:6,children:t.jsx(dt,{})})]}),t.jsxs(ue,{template:"panel",children:[t.jsx(he,{span:12,md:8,children:t.jsx(Q,{neomorphic:!0,isLoaded:w,skeletonType:"chart",children:w&&t.jsxs(t.Fragment,{children:[t.jsx(ae,{icon:t.jsx(O,{}),title:"RF Noise Floor",largeTitle:!0,stackActionsOnMobile:!0,actions:A?t.jsxs("div",{className:"flex items-center gap-2 sm:gap-3",children:[t.jsxs("span",{className:"type-data-xs text-text-muted whitespace-nowrap",children:["min ",t.jsx("span",{className:"text-text-secondary tabular-nums",children:A.min.toFixed(0)})]}),t.jsxs("span",{className:"type-data-xs text-text-muted whitespace-nowrap",children:["avg ",t.jsx("span",{className:"text-text-secondary tabular-nums",children:A.avg.toFixed(0)})]}),t.jsxs("span",{className:"type-data-xs text-text-muted whitespace-nowrap",children:["max ",t.jsx("span",{className:"text-text-secondary tabular-nums",children:A.max.toFixed(0)})]}),t.jsx("span",{className:"type-data-xs text-text-muted",children:"dBm"})]}):t.jsx("span",{className:"type-data-xs text-text-muted",children:"dBm"})}),t.jsx("div",{className:"flex-1 min-h-0",children:t.jsx(it,{children:t.jsx(W,{timestamps:De.timestamps,values:De.values,onStatsChange:Y})})})]})})}),t.jsx(he,{span:12,md:4,children:t.jsx(xt,{packets:N,rangeMinutes:Ne,rangeHours:ve,timeRangeLabel:we.label,isLoaded:w})})]})]})]})]})}export{pt as default};
