var e,t,s=Object.defineProperty,a=(e,t,a)=>((e,t,a)=>t in e?s(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a)(e,"symbol"!=typeof t?t+"":t,a);import{j as n,r,ay as l,H as i,az as o,aA as c,aB as d,aC as u,aD as m,aE as h,aF as x,aG as p,aH as g,o as f,aI as b,aJ as y,aK as v,aL as j,aM as N,aN as w,a4 as k,J as M,ag as C,h as S,aa as T,aO as $,a8 as P,p as R,C as A,ap as F}from"./vendor-react-LGx7x4bU.js";import{L as D,M as L,N as E,O as B,U as _,p as H,Q as z,S as O,z as W,T as V,d as q,f as G,e as I,u as X,k as K,V as Y,h as J,X as U}from"./index-EBBmAeaQ.js";import{T as Q}from"./TimeRangeSelector--BNTWnYM.js";import{u as Z}from"./usePolling-Cg1HN7dQ.js";import{a as ee,u as te,b as se,c as ae,d as ne,e as re,s as le,p as ie}from"./useThemeColors-CDku3_24.js";import{c as oe,R as ce,d as de,L as ue,C as me,X as he,Y as xe,T as pe,a as ge}from"./recharts-BJfdDyUB.js";import{a as fe,c as be,P as ye,b as ve}from"./PageLayout-CnsL5xgB.js";import{C as je}from"./CollisionExplorerModal-a_jQ8jpb.js";import{R as Ne,C as we}from"./Grid-DPCXRg-g.js";import"./vendor-core-XI_xDZ-M.js";import"./deckgl-DTsmDcfs.js";import"./leaflet-D_ckmI2R.js";function ke({children:e,centered:t,className:s}){return n.jsx("div",{className:oe("flex-1 min-h-0",t&&"flex items-center justify-center",s),children:e})}r.memo(function({options:e,data:t,className:s="",onCreate:a}){const l=r.useRef(null),i=r.useRef(null);return r.useEffect(()=>{const s=l.current;if(!s)return;const n=s.getBoundingClientRect(),r=Math.floor(n.width)||400,o=Math.floor(n.height)||200,c=new E({...e,width:r,height:o},t,s);return i.current=c,null==a||a(c),()=>{c.destroy(),i.current=null}},[e]),r.useEffect(()=>{i.current&&t&&i.current.setData(t)},[t]),r.useEffect(()=>{const e=l.current;if(!e)return;const t=new ResizeObserver(e=>{const t=e[0];if(!t||!i.current)return;const{width:s,height:a}=t.contentRect;s>0&&a>0&&i.current.setSize({width:Math.floor(s),height:Math.floor(a)})});return t.observe(e),()=>{t.disconnect()}},[]),n.jsx("div",{ref:l,className:`w-full h-full ${s}`,style:{minHeight:100}})});const Me=new Map;function Ce(e){var t;if(!e.startsWith("var("))return e;const s=Me.get(e);if(s)return s;const a=e.match(/var\(([^,)]+)(?:,\s*([^)]+))?\)/);if(!a)return e;const n=a[1].trim(),r=(null==(t=a[2])?void 0:t.trim())||"#888888",l=getComputedStyle(document.documentElement).getPropertyValue(n).trim()||r;return Me.set(e,l),l}function Se(e,t,s=!1){if(t.length<2)return;if(e.beginPath(),e.moveTo(t[0].x,t[0].y),2===t.length)return void e.lineTo(t[1].x,t[1].y);const a=.5;for(let n=0;n<t.length-1;n++){const s=t[Math.max(0,n-1)],r=t[n],l=t[n+1],i=t[Math.min(t.length-1,n+2)],o=r.x+(l.x-s.x)/6*a,c=r.y+(l.y-s.y)/6*a,d=l.x-(i.x-r.x)/6*a,u=l.y-(i.y-r.y)/6*a;e.bezierCurveTo(o,c,d,u,l.x,l.y)}s&&e.closePath()}function Te(e,t,s,a){return{hooks:{draw:n=>{const r=e.current,l=t.current,i=s.current;if(0===r.length)return;const o=n.ctx,c=n.bbox,d=c.left,u=c.top,m=c.width,h=c.height;if(m<=0||h<=0)return;const x=n.data[0],p=x.length;if(0===p)return;const g=x[0],f=x[p-1]-g||1,b=e=>d+(e-g)/f*m,y=e=>u+h*(1-e/l),v={min:r.map(e=>({x:b(e.timestamp),y:y(e.min)})),max:r.map(e=>({x:b(e.timestamp),y:y(e.max)})),p5:r.map(e=>({x:b(e.timestamp),y:y(e.p5)})),p95:r.map(e=>({x:b(e.timestamp),y:y(e.p95)})),p25:r.map(e=>({x:b(e.timestamp),y:y(e.p25)})),p75:r.map(e=>({x:b(e.timestamp),y:y(e.p75)})),mean:r.map(e=>({x:b(e.timestamp),y:y(e.mean)})),median:r.map(e=>({x:b(e.timestamp),y:y(e.median)})),average:r.map(e=>({x:b(e.timestamp),y:y(e.average)}))},j=(e,t)=>i?i===e?Math.min(1,1.5*t):"minMax"===i||"p5p95"===i||"p25p75"===i?.3*t:t:t,N=e=>i?i===e?1:"mean"===i||"median"===i||"average"===i?.3:1:1,w={band:Ce(a.band),innerBand:Ce(a.innerBand),mean:Ce(a.mean),median:Ce(a.median),average:Ce(a.average)};o.save(),o.strokeStyle=w.average,o.lineWidth=4,o.globalAlpha=N("average"),Se(o,v.average),o.stroke(),o.globalAlpha=j("minMax",.15),o.fillStyle=w.band,o.beginPath(),Se(o,v.max);const k=[...v.min].reverse();for(const e of k)o.lineTo(e.x,e.y);o.closePath(),o.fill(),o.globalAlpha=j("p5p95",.3),o.fillStyle=w.band,o.beginPath(),Se(o,v.p95);const M=[...v.p5].reverse();for(const e of M)o.lineTo(e.x,e.y);o.closePath(),o.fill(),o.globalAlpha=j("p25p75",.55),o.fillStyle=w.innerBand,o.beginPath(),Se(o,v.p75);const C=[...v.p25].reverse();for(const e of C)o.lineTo(e.x,e.y);o.closePath(),o.fill(),o.strokeStyle=w.median,o.lineWidth=1.5,o.globalAlpha=N("median"),o.setLineDash([4,4]),Se(o,v.median),o.stroke(),o.strokeStyle=w.mean,o.lineWidth=1.5,o.globalAlpha=N("mean"),o.setLineDash([]),Se(o,v.mean),o.stroke(),o.restore()}}}}r.memo(function({data:e,maxValue:t,onHover:s,highlightedItem:a=null,bandColor:l="#E12672",innerBandColor:i="#FF2D7A",meanColor:o="#FF6B9D",medianColor:c="#FF85AD",averageColor:d="#FFE135",cursorColor:u="rgba(255,255,255,0.5)"}){const m=r.useRef(null),h=r.useRef(null),x=r.useRef(e),p=r.useRef(t),g=r.useRef(a),f=r.useRef(s),b=r.useRef(e.length);x.current=e,p.current=t,g.current=a,f.current=s;const y=r.useMemo(()=>({band:l,innerBand:i,mean:o,median:c,average:d,cursor:u}),[l,i,o,c,d,u]),v=r.useMemo(()=>[e.map(e=>e.timestamp),e.map(e=>e.max)],[e]),j=r.useMemo(()=>({width:400,height:200,padding:[4,4,4,4],cursor:{show:!0,x:!0,y:!1,drag:{x:!1,y:!1},points:{show:!1}},scales:{x:{time:!0},y:{range:[0,t]}},axes:[{show:!1},{show:!1}],series:[{},{show:!1}],hooks:{setCursor:[e=>{var t,s;const a=e.cursor.idx;null!=a&&a>=0?null==(t=f.current)||t.call(f,a):null==(s=f.current)||s.call(f,null)}]},plugins:[Te(x,p,g,y)]}),[t,y]);r.useEffect(()=>{const t=m.current;if(!t||0===e.length)return;const s=b.current,a=e.length,n=Math.abs(a-s);if(!(!h.current||n>100||s>0&&n/s>.1)&&h.current)return h.current.setData(v),void(b.current=a);h.current&&h.current.destroy();const r=t.getBoundingClientRect(),l=Math.floor(r.width)||400,i=Math.floor(r.height)||200,o=new E({...j,width:l,height:i},v,t);return h.current=o,b.current=a,()=>{o.destroy(),h.current=null}},[j,v,e.length]),r.useEffect(()=>{const e=m.current;if(!e)return;const t=new ResizeObserver(e=>{const t=e[0];if(!t||!h.current)return;const{width:s,height:a}=t.contentRect;s>0&&a>0&&h.current.setSize({width:Math.floor(s),height:Math.floor(a)})});return t.observe(e),()=>{t.disconnect()}},[]),r.useEffect(()=>{h.current&&h.current.redraw()},[a,e]);const N=r.useCallback(()=>{null==s||s(null)},[s]);return 0===e.length?n.jsx("div",{className:"h-full flex items-center justify-center text-text-muted",children:"No data available"}):n.jsx("div",{ref:m,className:"w-full h-full rounded-2xl overflow-hidden",onMouseLeave:N})});const $e="undefined"!=typeof window&&(null==(t=null==(e=window.matchMedia)?void 0:e.call(window,"(color-gamut: p3)"))?void 0:t.matches);function Pe(){const e=getComputedStyle(document.documentElement);return{fontFamily:e.getPropertyValue("--font-data").trim()||'"JetBrains Mono", ui-monospace, monospace',axisColor:e.getPropertyValue("--chart-axis-tick").trim()||"rgba(255, 255, 255, 0.4)",gridColor:e.getPropertyValue("--chart-grid").trim()||"rgba(255, 255, 255, 0.06)",textMuted:e.getPropertyValue("--text-muted").trim()||"#727272",textPrimary:e.getPropertyValue("--text-primary").trim()||"#FFFFFF"}}const Re=["min","max","p75","p95","p99","mean","median","average","midpoint"];let Ae=null,Fe=0;const De={0:{r:0,g:144,b:255},7:{r:0,g:102,b:204},1:{r:102,g:204,b:255},3:{r:0,g:230,b:153},4:{r:255,g:242,b:0},2:{r:255,g:179,b:0},5:{r:255,g:128,b:192},6:{r:255,g:102,b:0},10:{r:179,g:179,b:179},15:{r:230,g:102,b:204},8:{r:102,g:179,b:255},9:{r:51,g:255,b:179},255:{r:128,g:128,b:128}};function Le(e){return De[e]??De[255]}function Ee(e){const t=Date.now();(!Ae||t-Fe>1e3)&&(Ae={green:{r:34,g:197,b:94,p3:"color(display-p3 0.13 0.77 0.37)"},good:{r:132,g:204,b:22,p3:"color(display-p3 0.52 0.80 0.09)"},fair:{r:250,g:204,b:21,p3:"color(display-p3 0.98 0.80 0.08)"},poor:{r:249,g:115,b:22,p3:"color(display-p3 0.98 0.45 0.09)"},critical:{r:239,g:68,b:68,p3:"color(display-p3 0.94 0.27 0.27)"}},Fe=t);const s=Ae;return e>=1?s.critical:e>=.75?s.poor:e>=.5?s.fair:e>=.25?s.good:s.green}function Be(e,t,s,a,n,r,l,i,o,c=null,d=null,u=1,m=null,h="airtime",x=.5){if(0===t.length)return;const p=e.ctx,{left:g,top:f,width:b,height:y}=e.bbox,v=window.devicePixelRatio||1;if(b<=0||y<=0)return;const j=e.data[0],N=j.length;if(0===N)return;const w=j[0],k=j[N-1],M=s,C="share"===h,S=C?function(e){const t=[10,20,25,50,100,200,250,500,1e3],s=e/4.5;for(const a of t)if(a>=s)return a;return e>5e3?1e3*Math.ceil(s/1e3):100*Math.ceil(s/100)}(M):5,T=getComputedStyle(document.documentElement),$=T.getPropertyValue("--signal-critical").trim()||"#EF4444",P=T.getPropertyValue("--bg-elevated").trim()||"#333233";p.save(),p.fillStyle="rgba(0, 0, 0, 0.4)";const R=8*v;if(p.beginPath(),p.roundRect(g,f,b,y,R),p.fill(),p.restore(),!C&&M>=20){p.save();const e=f+y*(1-20/M);p.fillStyle=P,p.globalAlpha=.5,p.fillRect(g,f,b,e-f),p.restore()}p.save(),p.lineWidth=1*v,p.setLineDash([4*v,4*v]);for(let F=S;F<M;F+=S){const e=F/M,t=Math.round(f+y*(1-e))+.5;C||20!==F?(p.strokeStyle=r.textPrimary,p.globalAlpha=.25):(p.strokeStyle=$,p.globalAlpha=1),p.beginPath(),p.moveTo(Math.round(g),t),p.lineTo(Math.round(g+b),t),p.stroke()}p.restore(),p.save(),p.font=`bold ${10*v}px ${r.fontFamily}`,p.fillStyle=r.textPrimary,p.textBaseline="middle",p.textAlign="left";const A=8*v;for(let F=0;F<=M;F+=S){const e=f+y*(1-F/M),t=Math.max(f+A,Math.min(f+y-A,e)),s=C?`${F}B`:`${F}%`;p.fillText(s,0,t)}if(p.restore(),function(e,t,s,a,n,r,l){if(null===t)return;if(t<s||t>s+n)return;const i=getComputedStyle(document.documentElement).getPropertyValue("--text-primary").trim()||"#FFFFFF";e.save(),e.strokeStyle=i,e.globalAlpha=.5,e.lineWidth=1*l,e.setLineDash([4*l,4*l]),e.beginPath(),e.moveTo(Math.round(t)+.5,a),e.lineTo(Math.round(t)+.5,a+r),e.stroke(),e.restore()}(p,m,g,f,b,y,v),l){!function(e,t,s,a,n,r,l=null,i=null,o=1,c=25){const{points:d,rawValues:u,count:m,packetTypes:h,timestamps:x,maxValue:p}=t,g=1*o*(window.devicePixelRatio||1);e.globalCompositeOperation="source-over";const f=l?parseInt(l.replace("TYPE_",""),10):null;for(let b=0;b<m;b++){const t=d[2*b],l=1-u[b]/c,o=s+t*n,m=a+Math.max(0,Math.min(1,l))*r,p=h[b],y=Le(p);let v=!0;if(i&&x){const e=x[b];v=e>=i.start&&e<i.end}const j=!v||null!==f&&p!==f?.03:.5;e.fillStyle=`rgba(${y.r}, ${y.g}, ${y.b}, ${j})`,e.beginPath(),e.arc(o,m,g,0,2*Math.PI),e.fill()}e.globalCompositeOperation="source-over"}(p,l,g,f,b,y,c,d,u,M),p.save(),p.font=`bold ${9*v}px ${r.fontFamily}`,p.textBaseline="middle",p.textAlign="left";const e=l.maxValue,t=[{pct:0,label:`${e.toFixed(0)}%`},{pct:.25,label:`${(.75*e).toFixed(0)}%`},{pct:.5,label:`${(.5*e).toFixed(0)}%`},{pct:.75,label:`${(.25*e).toFixed(0)}%`},{pct:1,label:"0%"}];for(const{pct:s,label:a}of t){const e=f+y*s,t=Ee(s);p.fillStyle=`rgb(${t.r}, ${t.g}, ${t.b})`,p.fillText(a,g+b+8*v,e)}p.restore()}o&&i&&i.length>0&&function(e,t,s,a,n,r,l,i,o,c,d=.5){if(0===t.length)return;const u=o-i||1,m=function(e,t=1.3,s=.15){const a=function(e){const t=e.match(/color\(display-p3\s+([\d.]+)\s+([\d.]+)\s+([\d.]+)/);if(t){const e=parseFloat(t[1]),s=parseFloat(t[2]),a=parseFloat(t[3]);return{r:Math.round(255*e),g:Math.round(255*s),b:Math.round(255*a),p3r:e,p3g:s,p3b:a}}if(e.startsWith("#")){const t=e.replace("#",""),s=parseInt(t.slice(0,2),16),a=parseInt(t.slice(2,4),16),n=parseInt(t.slice(4,6),16);return{r:s,g:a,b:n,p3r:s/255,p3g:a/255,p3b:n/255}}const s=e.match(/rgba?\(([\d.]+),?\s*([\d.]+),?\s*([\d.]+)/);if(s){const e=Math.round(parseFloat(s[1])),t=Math.round(parseFloat(s[2])),a=Math.round(parseFloat(s[3]));return{r:e,g:t,b:a,p3r:e/255,p3g:t/255,p3b:a/255}}return{r:255,g:255,b:255,p3r:1,p3g:1,p3b:1}}(e),n=function(e,t,s,a=1.25,n=.15){const r=(Math.max(e,t,s)+Math.min(e,t,s))/2;return{p3r:Math.min(1,r+(e-r)*a+n),p3g:Math.min(1,r+(t-r)*a+n),p3b:Math.min(1,r+(s-r)*a+n)}}(a.p3r,a.p3g,a.p3b,t,s);return{r:Math.round(255*Math.min(1,n.p3r)),g:Math.round(255*Math.min(1,n.p3g)),b:Math.round(255*Math.min(1,n.p3b)),p3r:Math.min(1,n.p3r),p3g:Math.min(1,n.p3g),p3b:Math.min(1,n.p3b)}}(getComputedStyle(document.documentElement).getPropertyValue("--signal-critical").trim()||"#EF4444");e.save(),e.globalAlpha=d,e.fillStyle=$e?`color(display-p3 ${m.p3r} ${m.p3g} ${m.p3b})`:`rgb(${m.r}, ${m.g}, ${m.b})`;for(const h of t){if(h.endTs<i||h.startTs>o)continue;const t=a+(Math.max(h.startTs,i)-i)/u*r,s=a+(Math.min(h.endTs,o)-i)/u*r,d=Math.max(s-t,2*c);e.fillRect(t,n,d,l)}e.restore()}(p,i,0,g,f,b,y,w,k,v,d?Math.max(.03,.03*x):x)}const _e=r.memo(function({data:e,maxValue:t,visibleLines:s=Re,highlightedLine:a=null,onHover:l,scatterData:i=null,noiseFloorAnomalies:o=null,showNoiseFloorOverlay:c=!1,overlayOpacity:d=.5,highlightedType:u=null,hoveredTimeRange:m=null,timeRangeHours:h=24,yAxisMode:x="airtime"}){const p=r.useRef(null),g=r.useRef(null),f=r.useRef(e),b=r.useRef(t),y=r.useRef(s),v=r.useRef(a),j=r.useRef(l),N=r.useRef(i),w=r.useRef(o),k=r.useRef(c),M=r.useRef(u),C=r.useRef(m),S=r.useRef(null),T=r.useRef(null),$=r.useRef(x),P=r.useRef(d),R=h<=12?1.2:1,A=r.useRef(R),F=r.useRef(e.length);f.current=e,b.current=t,y.current=s,v.current=a,j.current=l,N.current=i,w.current=o,k.current=c,M.current=u,C.current=m,A.current=R,$.current=x,P.current=d,r.useEffect(()=>{S.current=Pe()},[]);const D=r.useMemo(()=>[e.map(e=>e.timestamp),new Array(e.length).fill(1)],[e]),L=r.useMemo(()=>({hooks:{draw:e=>{const t=S.current||Pe();Be(e,f.current,b.current,y.current,v.current,t,N.current,w.current,k.current,M.current,C.current,A.current,T.current,$.current,P.current)}}}),[]),B=r.useMemo(()=>({width:400,height:200,padding:[8,0,8,28],cursor:{show:!1,x:!1,y:!1,drag:{x:!1,y:!1},points:{show:!1}},scales:{x:{time:!0},y:{range:[0,1]}},axes:[{show:!1},{show:!1}],series:[{},{show:!1}],plugins:[L]}),[L]);r.useEffect(()=>{const t=p.current;if(!t||0===e.length)return;const s=F.current,a=e.length,n=Math.abs(a-s);if(!(!g.current||n>100||s>0&&n/s>.1)&&g.current)return g.current.setData(D),void(F.current=a);g.current&&g.current.destroy();const r=t.getBoundingClientRect(),l=Math.floor(r.width)||400,i=Math.floor(r.height)||200,o=new E({...B,width:l,height:i},D,t);return g.current=o,F.current=a,()=>{o.destroy(),g.current=null}},[B,D,e.length]),r.useEffect(()=>{const e=p.current;if(!e)return;const t=new ResizeObserver(e=>{const t=e[0];if(!t||!g.current)return;const{width:s,height:a}=t.contentRect;s>0&&a>0&&g.current.setSize({width:Math.floor(s),height:Math.floor(a)})});return t.observe(e),()=>{t.disconnect()}},[]),r.useEffect(()=>{g.current&&g.current.redraw()},[a,s,e,i,o,c,d,u,m,R]);const _=r.useCallback(t=>{var s,a;const n=p.current,r=g.current;if(!n||!r||0===e.length)return;const l=n.getBoundingClientRect(),i=t.clientX-l.left,o=window.devicePixelRatio||1,c=r.bbox,d=c.left/o,u=c.width/o;if(i<d||i>d+u)return T.current=null,r.redraw(),void(null==(s=j.current)||s.call(j,null));T.current=i*o;const m=(i-d)/u,h=e.length,x=Math.floor(m*h),f=Math.max(0,Math.min(h-1,x));r.redraw(),null==(a=j.current)||a.call(j,f)},[e.length]),H=r.useCallback(()=>{var e;T.current=null,g.current&&g.current.redraw(),null==(e=j.current)||e.call(j,null)},[]);return 0===e.length?n.jsx("div",{className:"h-full flex items-center justify-center text-text-muted",children:"No data available"}):n.jsx("div",{ref:p,className:"w-full h-full rounded-lg overflow-hidden",onMouseMove:_,onMouseLeave:H})}),He={[B.REQ]:"var(--pkt-science-req)",[B.ANON_REQ]:"var(--pkt-science-anon-req)",[B.RESPONSE]:"var(--pkt-science-response)",[B.ACK]:"var(--pkt-science-ack)",[B.ADVERT]:"var(--pkt-science-advert)",[B.TXT_MSG]:"var(--pkt-science-txt-msg)",[B.GRP_TXT]:"var(--pkt-science-grp-txt)",[B.GRP_DATA]:"var(--pkt-science-grp-data)",[B.PATH]:"var(--pkt-science-path)",[B.TRACE]:"var(--pkt-science-trace)",[B.MULTIPART]:"var(--pkt-science-multipart)",[B.RAW_CUSTOM]:"var(--pkt-science-raw-custom)"},ze="var(--pkt-science-unknown)";function Oe(e){return"number"!=typeof e?ze:He[e]??ze}const We=new class{constructor(){a(this,"buckets",new Map),a(this,"lastProcessedTimestamp",0),a(this,"processedPacketCount",0),a(this,"cacheKey",null),a(this,"bucketDuration",60),a(this,"bucketDurationMs",6e4)}getBuckets(e,t,s,a){const n={startTs:t,endTs:s,radioConfigHash:this.hashRadioConfig(a)};return this.isCacheValid(n)?this.processPackets(e,t,s,a,!1):(this.invalidate(n),this.processPackets(e,t,s,a,!0)),this.toBucketDataArray(t,s)}processPackets(e,t,s,a,n){const r=Math.ceil((s-t)/this.bucketDuration);let l=0;for(const i of e){const e=i.timestamp;if(e<t||e>=s)continue;if(!n&&e<=this.lastProcessedTimestamp)continue;const o=Math.min(Math.floor((e-t)/this.bucketDuration),r-1),c=this.buckets.get(o)??{total:0,totalAirtime:0};c.total+=1;const d=D(i);c.totalAirtime+=L(d,{spreadingFactor:a.sf,bandwidthHz:a.bw,codingRate:a.cr,preambleLength:a.preamble}),this.buckets.set(o,c),e>this.lastProcessedTimestamp&&(this.lastProcessedTimestamp=e),l++}this.processedPacketCount+=l}toBucketDataArray(e,t){const s=t-e,a=Math.ceil(s/this.bucketDuration),n=s/3600,r=[];for(let l=0;l<a;l++){const t=e+l*this.bucketDuration,s=new Date(1e3*t),a=n>24?s.toLocaleDateString([],{weekday:"short",hour:"2-digit",minute:"2-digit",hour12:!1}):s.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hour12:!1}),i=this.buckets.get(l)??{total:0,totalAirtime:0};r.push({timestamp:t,time:a,total:i.total,totalAirtime:i.totalAirtime,bucketDurationMs:this.bucketDurationMs})}return r}isCacheValid(e){return!!this.cacheKey&&this.cacheKey.startTs===e.startTs&&this.cacheKey.endTs===e.endTs&&this.cacheKey.radioConfigHash===e.radioConfigHash}invalidate(e){this.buckets.clear(),this.lastProcessedTimestamp=0,this.processedPacketCount=0,this.cacheKey=e}hashRadioConfig(e){return`${e.sf}-${e.bw}-${e.cr}-${e.preamble}`}clear(){this.buckets.clear(),this.lastProcessedTimestamp=0,this.processedPacketCount=0,this.cacheKey=null}getStats(){return{bucketCount:this.buckets.size,processedPackets:this.processedPacketCount,lastTimestamp:this.lastProcessedTimestamp,cacheKey:this.cacheKey}}};function Ve(e){return H[e]??`TYPE_${e.toString(16).toUpperCase()}`}const qe={sf:10,bw:25e4,cr:5,preamble:8};function Ge(e,t){if(0===e.length)return[];const s=Math.floor((t-1)/2),a=[];for(let n=0;n<e.length;n++){const t=n>=s?e[n-s]:e[0];a.push(e[n]+(e[n]-t))}return function(e,t){if(0===e.length)return[];const s=2/(t+1),a=[e[0]];for(let n=1;n<e.length;n++)a.push(s*e[n]+(1-s)*a[n-1]);return a}(a,t)}function Ie({sortedTypes:e,highlightedType:t,onTypeHover:s,aggregateShares:a,hoverData:l}){const i=r.useMemo(()=>{if(!l)return null;const e=new Map;for(const t of l.items)e.set(t.key,t.value);return e},[l]),o=null!==i;return n.jsx("div",{className:"flex-shrink-0 pt-3 mt-2",children:n.jsx("div",{className:"grid ml-9 gap-y-0.5",style:{gridTemplateColumns:"repeat(auto-fill, minmax(105px, 1fr))"},onMouseLeave:()=>s(null),children:e.map(e=>{const r=Oe(e.typeNum),l=(null==i?void 0:i.get(e.key))??0,c=a.get(e.key)??0,d=o?l:c,u=d>1e-4,m=t===e.key,h=t&&t!==e.key;let x="legend-item";return m?x+=" legend-item-active":h?x+=" legend-item-dimmed":o&&l>1e-4?x+=" legend-item-chart-active":o&&l<=1e-4&&(x+=" legend-item-dimmed"),n.jsxs("div",{className:x,onMouseEnter:()=>s(e.key),children:[n.jsx("div",{className:"w-2.5 h-2.5 rounded flex-shrink-0",style:{backgroundColor:r}}),n.jsx("span",{className:"legend-label",children:e.label}),u&&n.jsxs("span",{className:"legend-value "+(o?"legend-value-live":""),children:[(100*d).toFixed(1),"%"]})]},e.key)})})})}function Xe({x:e,y:t,width:s,height:a,name:r,size:l,index:i,depth:o,hoveredIndex:c,onHover:d,total:u,typeNum:m}){if(1!==o)return null;const h=null!==c&&!(c===i),x=Oe(m),p=u>0?l/u*100:0,g=s>36&&a>20,f=s>36&&a>32;return n.jsxs("g",{onMouseEnter:e=>d(i,e),onMouseLeave:()=>d(null),style:{cursor:"default"},children:[n.jsx("rect",{x:e,y:t,width:s,height:a,fill:x,opacity:h?.4:1,stroke:"rgba(0,0,0,0.2)",strokeWidth:1,rx:3,style:{transition:"opacity 150ms ease"}}),g&&n.jsxs(n.Fragment,{children:[f&&n.jsxs("text",{x:e+4,y:t+a-4-11,textAnchor:"start",dominantBaseline:"auto",fill:"rgba(0,0,0,0.6)",fontSize:8,fontFamily:"'JetBrains Mono', monospace",fontWeight:500,style:{pointerEvents:"none"},children:[p.toFixed(1),"%"]}),n.jsx("text",{x:e+4,y:t+a-4,textAnchor:"start",dominantBaseline:"auto",fill:"rgba(0,0,0,0.85)",fontSize:9,fontFamily:"'JetBrains Mono', monospace",fontWeight:600,style:{pointerEvents:"none"},children:r})]})]})}function Ke({data:e,total:t,color:s,position:a,containerWidth:r}){if(!e||!a)return null;const l=(e.value/t*100).toFixed(1),i=r-a.x<184?Math.max(8,a.x-160-8):a.x+16;return n.jsx("div",{className:"absolute z-50 pointer-events-none",style:{left:i,top:Math.max(8,a.y-60)},children:n.jsxs("div",{className:"bg-tooltip-bg border border-border-subtle rounded-lg px-3 py-2 shadow-xl min-w-[140px]",children:[n.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[n.jsx("span",{className:"w-2.5 h-2.5 rounded-sm flex-shrink-0",style:{backgroundColor:s}}),n.jsx("span",{className:"type-data-sm font-semibold text-text-primary",children:e.name})]}),n.jsxs("div",{className:"space-y-0.5 type-data-xs text-text-muted",children:[n.jsxs("div",{className:"flex justify-between gap-4",children:[n.jsx("span",{children:"Count"}),n.jsx("span",{className:"text-text-primary tabular-nums font-medium",children:e.value.toLocaleString()})]}),n.jsxs("div",{className:"flex justify-between gap-4",children:[n.jsx("span",{children:"Share"}),n.jsxs("span",{className:"text-text-primary tabular-nums font-medium",children:[l,"%"]})]}),n.jsxs("div",{className:"flex justify-between gap-4",children:[n.jsx("span",{children:"Total"}),n.jsx("span",{className:"text-text-primary tabular-nums font-medium",children:t.toLocaleString()})]})]})]})})}function Ye({sortedTypes:e,aggregateShares:t}){var s,a,l;const[i,o]=r.useState(null),[c,d]=r.useState(null),[u,m]=r.useState(0),[h,x]=r.useState(null),p=r.useRef(null),f=r.useMemo(()=>e.reduce((e,t)=>e+t.totalCount,0),[e]),b=r.useMemo(()=>e.map((e,t)=>({name:e.label,size:e.totalCount,index:t,typeNum:e.typeNum,key:e.key})),[e]),y=r.useCallback((e,t)=>{if(o(e),t&&null!==e){const e=p.current;if(e){const s=e.getBoundingClientRect();m(s.width),d({x:t.clientX-s.left,y:t.clientY-s.top})}}else d(null)},[]),v=r.useCallback(e=>{if(x(e),e){const t=b.findIndex(t=>t.key===e);o(t>=0?t:null)}else o(null)},[b]),j=null!==i?{name:(null==(s=b[i])?void 0:s.name)??"",value:(null==(a=b[i])?void 0:a.size)??0}:null,N=null!==i?Oe(null==(l=b[i])?void 0:l.typeNum):"";return 0===e.length||0===f?n.jsxs("div",{className:"h-full flex items-center justify-center text-text-muted",children:[n.jsx(g,{className:"w-6 h-6 mr-2 opacity-50"}),n.jsx("span",{children:"No packet type data available"})]}):n.jsxs("div",{className:"flex flex-col",children:[n.jsxs("div",{className:"analyzer-chart-height relative flex-shrink-0",ref:p,children:[n.jsx(ce,{width:"100%",height:"100%",children:n.jsx(de,{data:b,dataKey:"size",aspectRatio:4/3,stroke:"none",isAnimationActive:!1,content:n.jsx(Xe,{x:0,y:0,width:0,height:0,name:"",size:0,index:0,depth:0,hoveredIndex:i,onHover:y,total:f,typeNum:0})})}),n.jsx(Ke,{data:j,total:f,color:N,position:c,containerWidth:u})]}),n.jsx(Ie,{sortedTypes:e,highlightedType:h,onTypeHover:v,aggregateShares:t})]})}function Je(e){const{values:t,sum:s}=e;if(0===t.length)return{min:0,mean:0,median:0,p75:0,p95:0,p99:0,max:0};const a=[...t].sort((e,t)=>e-t),n=a.length,r=s/n,l=a[0],i=a[n-1],o=e=>{const t=Math.min(Math.ceil(e*n)-1,n-1);return a[Math.max(0,t)]};return{min:l,mean:r,median:n%2==0?(a[n/2-1]+a[n/2])/2:a[Math.floor(n/2)],p75:o(.75),p95:o(.95),p99:o(.99),max:i}}function Ue({statsBuckets:e,bucketData:t,mode:s,packets:a,startTs:l,endTs:i,radioConfig:o,sortedTypes:c,aggregateShares:d,noiseFloorAnomalies:u,showNoiseFloorOverlay:m,overlayOpacity:h=.5}){const[x,p]=r.useState(null),[f,b]=r.useState(null),y=r.useMemo(()=>(i-l)/3600,[l,i]),v=r.useCallback(e=>{b(e)},[]),j=function(e,t,s,a,n){return r.useMemo(()=>{if(0===e.length||!n)return null;const r=e.filter(e=>e.timestamp>=t&&e.timestamp<=s);if(0===r.length)return null;const l=[],i=new Map;for(const e of r){const s=e.type??e.payload_type??-1,r=D(e);let o;if(o="airtime"===a?L(r,{spreadingFactor:n.sf,bandwidthHz:n.bw,codingRate:n.cr,preambleLength:n.preamble}):1,r<=0)continue;const c=Math.floor((e.timestamp-t)/300),d={timestamp:e.timestamp,airtimeMs:o,byteSize:r,packetType:s,bucketIndex:c};l.push(d),i.has(c)||i.set(c,[]),i.get(c).push(d)}if(0===l.length)return null;const o=[],c=[],d=[],u=new Map;if("share"===a)for(const[,e]of i)for(const t of e)u.set(t,t.byteSize);else for(const[,e]of i){const t=e.reduce((e,t)=>e+t.airtimeMs,0)/3e5*100,s=Math.max(...e.map(e=>e.airtimeMs));for(const a of e){const e=a.airtimeMs/s*t;u.set(a,e)}}for(const e of l){const t=u.get(e);void 0!==t&&(o.push(t),c.push(e.timestamp),d.push(e.packetType))}const m=Math.min(...c),h=Math.max(...c),x=h-m||1,p=[...o].sort((e,t)=>e-t),g=p[0],f=p[p.length-1],b=Math.floor(.05*p.length),y=Math.floor(.5*p.length),v=Math.min(Math.ceil(.95*p.length),p.length-1),j=p[b],N=p[y],w=p[v],k=new Map;for(const e of o){const t=Math.round(100*e)/100;k.set(t,(k.get(t)??0)+1)}const M=k.size,C=[...k.entries()].sort((e,t)=>t[1]-e[1]).slice(0,5).map(([e,t])=>({value:e,count:t,percent:t/o.length*100}));let S;if("share"===a){const e=50,t=Math.ceil(f/e)*e;S=Math.max(t,50)}else{const e=5,t=5,s=Math.ceil(f/e)*e;S=Math.max(s+t,10)}const T=new Float32Array(2*o.length),$=new Float32Array(o.length),P=new Uint8Array(o.length),R=new Float32Array(o.length);for(let e=0;e<o.length;e++){const t=(c[e]-m)/x,s=1-Math.max(0,Math.min(S,o[e]))/S;T[2*e]=t,T[2*e+1]=s,$[e]=o[e],P[e]=d[e]>=0?d[e]:255,R[e]=c[e]}return{points:T,rawValues:$,packetTypes:P,timestamps:R,count:o.length,minTime:m,maxTime:h,minValue:0,maxValue:S,rawMinValue:g,rawMaxValue:f,unit:"%",stats:{p5:j,p50:N,p95:w,uniqueValues:M,topValues:C}}},[e,t,s,a,n])}(a,l,i,"share"===s?"share":"airtime",o),{data:N}=r.useMemo(()=>function(e,t){var s;const a=e.length;if(0===a)return{data:[],windowSize:0,windowDurationMs:0};const n=(null==(s=e[0])?void 0:s.bucketDurationMs)??1e3,r=Math.min(Math.max(5,Math.round(3e5/n)),a),l=Math.floor(r/2),i=[];let o=0,c=0;for(let d=0;d<a;d++){const s=e[d],n=Math.max(0,d-l),r=Math.min(a,d+l+1),u=[];let m,h=0;for(let a=n;a<r;a++){const s=e[a];let n;n="share"===t?s.total/Math.max(1,s.bucketDurationMs/1e3):s.totalAirtime/s.bucketDurationMs*100,u.push(n),h+=n}m="share"===t?s.total/Math.max(1,s.bucketDurationMs/1e3):s.totalAirtime/s.bucketDurationMs*100,o+=m,c++;const x=Je({values:u,sum:h}),p=(x.min+x.max)/2;i.push({timestamp:s.timestamp,time:s.time,min:x.min,max:x.max,p75:x.p75,p95:x.p95,p99:x.p99,mean:x.mean,median:x.median,average:o/c,midpoint:p})}return{data:i,windowSize:r,windowDurationMs:r*n}}(e,s),[e,s]),w=r.useMemo(()=>N.map(e=>({timestamp:e.timestamp,min:e.min,max:e.max,p75:e.p75,p95:e.p95,p99:e.p99,mean:e.mean,median:e.median,average:e.average,midpoint:e.midpoint})),[N]),k=r.useMemo(()=>(null==j?void 0:j.maxValue)?j.maxValue:"share"===s?200:10,[j,s]),M=r.useCallback(e=>{p(e)},[]),C=r.useMemo(()=>{if(null===x||!N[x])return null;const e=N[x];let t;t=y>=168?75:y>=72?35:y>=24?15:y>=3?10:5;const s=60*t/2,a=e.timestamp;return{start:a-s,end:a+s}},[x,N,y]),S=r.useMemo(()=>{if(null===x||!N[x]||!C)return null;const e=N[x].time,{start:t,end:n}=C,r=a.filter(e=>e.timestamp>=t&&e.timestamp<n);if(0===r.length)return{timestamp:N[x].timestamp,timeLabel:e,items:c.map(e=>({key:e.key,label:e.label,value:0,color:Oe(e.typeNum)}))};const l=new Map,i=new Map;let d=0,u=0;for(const s of r){const e=`TYPE_${s.type??s.payload_type??-1}`;if(l.set(e,(l.get(e)??0)+1),d++,o){const t=D(s),a=L(t,{spreadingFactor:o.sf,bandwidthHz:o.bw,codingRate:o.cr,preambleLength:o.preamble});i.set(e,(i.get(e)??0)+a),u+=a}}const m=c.map(e=>{let t;return t="airtime"===s?u>0?(i.get(e.key)??0)/u:0:d>0?(l.get(e.key)??0)/d:0,{key:e.key,label:e.label,value:t,color:Oe(e.typeNum)}});return{timestamp:N[x].timestamp,timeLabel:e,items:m}},[x,N,C,a,c,s,o]);if(0===N.length)return n.jsxs("div",{className:"h-full flex items-center justify-center text-text-muted",children:[n.jsx(g,{className:"w-6 h-6 mr-2 opacity-50"}),n.jsx("span",{children:"No packet data available"})]});const T=(null==S?void 0:S.timeLabel)??null;return n.jsxs("div",{className:"flex flex-col",children:[n.jsxs("div",{className:"analyzer-chart-height relative flex-shrink-0",children:[n.jsx("div",{className:"absolute inset-0 rounded-lg overflow-hidden",children:n.jsx(_e,{data:w,maxValue:k,onHover:M,scatterData:j,noiseFloorAnomalies:u,showNoiseFloorOverlay:m,overlayOpacity:h,highlightedType:f,hoveredTimeRange:C,timeRangeHours:y,yAxisMode:"share"===s?"share":"airtime"})}),T&&n.jsx("div",{className:"absolute top-1 right-1 px-2 py-0.5 bg-bg-elevated/90 rounded text-xs text-accent-secondary font-mono pointer-events-none",children:T})]}),n.jsx(Ie,{sortedTypes:c,highlightedType:f,onTypeHover:v,aggregateShares:d,hoverData:S})]})}function Qe({active:e,payload:t,label:s,mode:a}){if(!e||!t||0===t.length)return null;const r=t.filter(e=>null!==e.value&&void 0!==e.value);if(0===r.length)return null;const l=s?new Date(1e3*s).toLocaleString([],{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit",hour12:!1}):"";return n.jsxs("div",{className:"bg-tooltip-bg border border-border-subtle rounded-lg px-3 py-2 text-sm shadow-xl",children:[n.jsx("div",{className:"font-medium text-text-primary mb-1 font-mono",children:l}),r.map((e,t)=>n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsx("div",{className:"w-3 h-0.5",style:{backgroundColor:e.color}}),n.jsxs("span",{className:"text-text-muted",children:[e.name,":"]}),n.jsx("span",{className:"text-text-primary tabular-nums font-mono",children:"share"===a?`${Number(e.value).toLocaleString()} B`:`${Number(e.value).toFixed(2)}%`})]},t))]})}function Ze(e){return e>=1e9?`${(e/1e9).toFixed(1)}G`:e>=1e6?`${(e/1e6).toFixed(1)}M`:e>=1e3?`${(e/1e3).toFixed(1)}K`:e.toFixed(0)}function et({packets:e,mode:t,startTs:s,endTs:a,radioConfig:l,bucketCount:i}){const o=te(),c=se(),d=ae(),u=c.critical,m=o.neutral,[h,x]=r.useState(null),{trendData:p,totals:b,actualBucketCount:y}=r.useMemo(()=>{if(0===e.length)return{trendData:[],totals:{rxBytes:0,txBytes:0,rxAirtime:0,txAirtime:0},actualBucketCount:0};const n=a-s,r=Math.min(Math.ceil(n/300),i),o=n/r,c=1e3*o,d=[];for(let e=0;e<r;e++)d.push({timestamp:s+e*o,rxBytes:0,txBytes:0,rxAirtime:0,txAirtime:0});let u=0,m=0,h=0,x=0;for(const t of e){const e=t.timestamp;if(e<s||e>=a)continue;const n=Math.min(Math.floor((e-s)/o),r-1),i=D(t),c=L(i,{spreadingFactor:l.sf,bandwidthHz:l.bw,codingRate:l.cr,preambleLength:l.preamble});t.transmitted?(d[n].txBytes+=i,d[n].txAirtime+=c,m+=i,x+=c):(d[n].rxBytes+=i,d[n].rxAirtime+=c,u+=i,h+=c)}return{trendData:d.map(e=>{if("share"===t)return{timestamp:e.timestamp,rx:e.rxBytes>0?e.rxBytes:null,tx:e.txBytes>0?e.txBytes:null};{const t=c>0?e.rxAirtime/c*100:0,s=c>0?e.txAirtime/c*100:0;return{timestamp:e.timestamp,rx:t>0?t:null,tx:s>0?s:null}}}),totals:{rxBytes:u,txBytes:m,rxAirtime:h,txAirtime:x},actualBucketCount:r}},[e,s,a,i,t,l,300]),v=r.useMemo(()=>{if(0===p.length)return"share"===t?100:10;let e=0;for(const t of p){const s=t.rx??0,a=t.tx??0;s>e&&(e=s),a>e&&(e=a)}const s=1.1*e;return"share"===t?s<=100?100:s<=500?100*Math.ceil(s/100):s<=1e3?200*Math.ceil(s/200):s<=5e3?500*Math.ceil(s/500):s<=1e4?1e3*Math.ceil(s/1e3):5e3*Math.ceil(s/5e3):Math.max(1,Math.ceil(s))},[p,t]),j=r.useMemo(()=>{if(null!==h&&p[h]){const e=p[h],s=e.rx??0,a=e.tx??0;return"share"===t?{rx:Ze(s),tx:Ze(a),total:Ze(s+a),isHovered:!0}:{rx:`${s.toFixed(2)}%`,tx:`${a.toFixed(2)}%`,total:`${(s+a).toFixed(2)}%`,isHovered:!0}}if("share"===t)return{rx:Ze(b.rxBytes),tx:Ze(b.txBytes),total:Ze(b.rxBytes+b.txBytes),isHovered:!1};{let e=0,t=0,s=0;for(const r of p)null===r.rx&&null===r.tx||(e+=r.rx??0,t+=r.tx??0,s++);const a=s>0?e/s:0,n=s>0?t/s:0;return{rx:`${a.toFixed(2)}%`,tx:`${n.toFixed(2)}%`,total:`${(a+n).toFixed(2)}%`,isHovered:!1}}},[h,p,b,t]),N=r.useMemo(()=>{const e=a-s,t=e/3600;return[0,.25,.5,.75,1].map(a=>{const n=new Date(1e3*(s+e*a)),r=n.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hour12:!1}),l=n.toLocaleDateString([],{weekday:"short"});return{pct:a,label:t>24?`${l} ${r}`:r}})},[s,a]),w=r.useCallback(e=>{x(e.activeTooltipIndex??null)},[]),k=r.useMemo(()=>{const e=a-s,t=Math.round(e/3600);return t>=24?`${Math.round(t/24)}d`:`${t}h`},[s,a]),M=r.useCallback(e=>"share"===t?e>=1e6?`${(e/1e6).toFixed(1)}M`:e>=1e3?`${(e/1e3).toFixed(0)}K`:e.toFixed(0):`${e.toFixed(0)}%`,[t]);return 0===p.length?n.jsxs("div",{className:"h-full flex items-center justify-center text-text-muted",children:[n.jsx(g,{className:"w-6 h-6 mr-2 opacity-50"}),n.jsx("span",{children:"No packet data available"})]}):n.jsxs("div",{className:"flex flex-col h-full min-h-0",children:[n.jsx("div",{className:"flex items-center flex-shrink-0 text-text-muted",style:{height:20,paddingLeft:44,paddingRight:8},children:n.jsx("div",{className:"relative w-full h-full flex items-center",children:N.map((e,t)=>n.jsxs("div",{className:"absolute flex items-center gap-1 type-data-xs",style:{left:100*e.pct+"%",transform:0===e.pct?"translateX(0)":1===e.pct?"translateX(-100%)":"translateX(-50%)"},children:[n.jsx(f,{className:"w-2.5 h-2.5 opacity-60"}),n.jsx("span",{className:"tabular-nums",children:e.label})]},t))})}),n.jsxs("div",{className:"flex-1 min-h-0 relative",children:[n.jsx("div",{className:"absolute left-0 top-1/2 -translate-y-1/2 type-data-xs text-text-muted font-mono",style:{width:44},children:n.jsx("div",{className:"text-center",children:k})}),n.jsx(ce,{width:"100%",height:"100%",minWidth:1,minHeight:1,children:n.jsxs(ue,{data:p,margin:{top:4,right:8,bottom:4,left:0},onMouseMove:w,onMouseLeave:()=>x(null),children:[n.jsx(me,{strokeDasharray:"3 3",stroke:d.primary,strokeOpacity:.15,vertical:!1}),n.jsx(he,{dataKey:"timestamp",type:"number",domain:[s,a],axisLine:!1,tickLine:!1,tick:!1,height:0}),n.jsx(xe,{axisLine:!1,tickLine:!1,tick:{fill:d.primary,fontSize:10,fontFamily:"'JetBrains Mono', monospace"},dx:-8,width:44,tickFormatter:M,domain:[0,v]}),n.jsx(pe,{content:n.jsx(Qe,{mode:t})}),n.jsx(ge,{type:"linear",dataKey:"rx",name:"RX",stroke:u,strokeWidth:2.5,strokeOpacity:.9,dot:!1,connectNulls:!1,isAnimationActive:!1}),n.jsx(ge,{type:"linear",dataKey:"tx",name:"TX",stroke:m,strokeWidth:2.5,strokeOpacity:.9,dot:!1,connectNulls:!1,isAnimationActive:!1})]})})]}),n.jsxs("div",{className:"flex-shrink-0 flex items-center justify-between mt-2",children:[n.jsxs("div",{className:"flex items-center gap-4 text-xs font-mono pl-11",children:[n.jsxs("div",{className:"flex items-center gap-1.5",children:[n.jsx("div",{className:"w-4 h-0.5",style:{backgroundColor:u}}),n.jsx("span",{className:"text-text-muted",children:"RX"})]}),n.jsxs("div",{className:"flex items-center gap-1.5",children:[n.jsx("div",{className:"w-4 h-0.5",style:{backgroundColor:m}}),n.jsx("span",{className:"text-text-muted",children:"TX"})]}),n.jsx("span",{className:"text-text-muted",children:"share"===t?"Bytes":"Utilization"})]}),n.jsxs("div",{className:"text-right pr-2",children:[n.jsx("span",{className:"font-mono font-bold text-xl text-text-primary",children:j.total}),n.jsx("span",{className:"text-xs text-text-muted ml-2",children:j.isHovered?"bucket":"total"})]})]})]})}function tt({mode:e,onChange:t}){return n.jsxs("div",{className:"toggle-group toggle-group-sm",children:[n.jsx("button",{onClick:()=>t("share"),className:"toggle-group-item "+("share"===e?"active":""),children:"Total"}),n.jsx("button",{onClick:()=>t("airtime"),className:"toggle-group-item "+("airtime"===e?"active":""),children:"Airtime"})]})}function st({enabled:e,onChange:t,anomalyCount:s=0,showTuning:a=!1,onTuningChange:r}){return n.jsxs("div",{className:"relative inline-flex items-center gap-1",children:[e&&r&&n.jsx("button",{onClick:()=>r(!a),className:"toggle-group toggle-group-sm "+(a?"active":""),title:a?"Hide tuning panel":"Show tuning panel",children:n.jsx("span",{className:"toggle-group-item "+(a?"active":""),children:n.jsx(l,{className:"w-3.5 h-3.5"})})}),n.jsx("button",{onClick:()=>t(!e),className:"toggle-group toggle-group-sm "+(e?"active":""),title:e?"Hide noise floor anomalies":"Show noise floor anomalies",children:n.jsx("span",{className:"toggle-group-item "+(e?"active":""),children:n.jsx(i,{className:"w-3.5 h-3.5"})})}),s>0&&n.jsx("span",{className:"absolute -top-2 -right-2 min-w-[18px] h-[18px] px-1 rounded-full bg-accent-danger text-white text-[10px] font-bold flex items-center justify-center pointer-events-none z-10",children:s>99?"99+":s})]})}function at({smoothing:e,onChange:t}){return n.jsxs("div",{className:"toggle-group toggle-group-sm",children:[n.jsx("button",{onClick:()=>t("stats"),className:"toggle-group-item "+("stats"===e?"active":""),title:"Statistics view (scatter plot)",children:n.jsx(o,{className:"w-3.5 h-3.5"})}),n.jsx("button",{onClick:()=>t("trend"),className:"toggle-group-item "+("trend"===e?"active":""),title:"Trend line chart",children:n.jsx(c,{className:"w-3.5 h-3.5"})}),n.jsx("button",{onClick:()=>t("raw"),className:"toggle-group-item "+("raw"===e?"active":""),title:"No smoothing (raw values)",children:n.jsx(d,{className:"w-3.5 h-3.5"})}),n.jsx("button",{onClick:()=>t("zlema"),className:"toggle-group-item "+("zlema"===e?"active":""),title:"6-period Zero-Lag EMA (light smoothing)",children:n.jsx(u,{className:"w-3.5 h-3.5"})}),n.jsx("button",{onClick:()=>t("ema"),className:"toggle-group-item "+("ema"===e?"active":""),title:"12-period Zero-Lag EMA (moderate smoothing)",children:n.jsx(m,{className:"w-3.5 h-3.5"})}),n.jsx("button",{onClick:()=>t("smooth"),className:"toggle-group-item "+("smooth"===e?"active":""),title:"24-period Zero-Lag EMA (heavy smoothing)",children:n.jsx(h,{className:"w-3.5 h-3.5"})}),n.jsx("button",{onClick:()=>t("ultra"),className:"toggle-group-item "+("ultra"===e?"active":""),title:"96-period Zero-Lag EMA (ultra smoothing)",children:n.jsx(x,{className:"w-3.5 h-3.5"})}),n.jsx("button",{onClick:()=>t("mosaic"),className:"toggle-group-item "+("mosaic"===e?"active":""),title:"Mosaic view (treemap chart)",children:n.jsx(p,{className:"w-3.5 h-3.5"})})]})}const nt=r.memo(function({packets:e,startTs:t,endTs:s,bucketCount:a,radioConfig:l=qe,mode:i="share",smoothing:o="raw",noiseFloorAnomalies:c=null,showNoiseFloorOverlay:d=!1,overlayOpacity:u=.5}){const m=ee(),[h,x]=r.useState(null),[p,f]=r.useState([]),b=r.useRef(null),y=r.useRef(0);r.useEffect(()=>{const t=Math.abs(e.length-y.current);if(0===t&&p.length>0)return;b.current&&clearTimeout(b.current);const s=t>100?50:500;return b.current=setTimeout(()=>{y.current=e.length,f(e)},s),()=>{b.current&&clearTimeout(b.current)}},[e,p.length]);const v=r.useMemo(()=>function(e){const t=new Map;for(const a of e){const e=a.type??a.payload_type??-1;t.set(e,(t.get(e)??0)+1)}const s=[];for(const[a,n]of t)s.push({typeNum:a,key:`TYPE_${a}`,label:Ve(a),totalCount:n});return s.sort((e,t)=>t.totalCount-e.totalCount)}(p),[p]),j=r.useMemo(()=>function(e,t,s,a,n,r){const l=s-t,i=l/a,o=1e3*i,c=[];for(let d=0;d<a;d++){const e=t+d*i,s=new Date(1e3*e),a=l/3600>24?s.toLocaleDateString([],{weekday:"short",hour:"2-digit",minute:"2-digit",hour12:!1}):s.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hour12:!1});c.push({timestamp:e,time:a,counts:{},shares:{},airtimes:{},total:0,totalAirtime:0,bucketDurationMs:o});for(const t of r)c[d].counts[t.key]=0,c[d].airtimes[t.key]=0}for(const d of e){const e=d.timestamp;if(e<t||e>=s)continue;const r=Math.min(Math.floor((e-t)/i),a-1),l=`TYPE_${d.type??d.payload_type??-1}`;c[r].counts[l]=(c[r].counts[l]??0)+1,c[r].total++;const o=D(d),u=L(o,{spreadingFactor:n.sf,bandwidthHz:n.bw,codingRate:n.cr,preambleLength:n.preamble});c[r].airtimes[l]=(c[r].airtimes[l]??0)+u,c[r].totalAirtime+=u}for(const d of c)for(const e of r)d.total>0?d.shares[e.key]=d.counts[e.key]/d.total*100:d.shares[e.key]=0;return c}(p,t,s,a,l,v),[p,t,s,a,l,v]),N=r.useMemo(()=>We.getBuckets(p,t,s,l),[p,t,s,l]),w=r.useMemo(()=>v.reduce((e,t)=>e+t.totalCount,0),[v]),{sortedTypes:k,aggregateShares:M}=r.useMemo(()=>{const e=new Map;if("share"===i){if(w>0)for(const t of v)e.set(t.key,t.totalCount/w)}else{let t=0;const s=new Map;for(const e of j){t+=e.totalAirtime;for(const t of v){const a=s.get(t.key)??0;s.set(t.key,a+(e.airtimes[t.key]??0))}}if(t>0)for(const a of v)e.set(a.key,(s.get(a.key)??0)/t)}return{sortedTypes:[...v].sort((t,s)=>{const a=e.get(t.key)??0;return(e.get(s.key)??0)-a}),aggregateShares:e}},[v,w,i,j]),C=r.useMemo(()=>function(e,t,s,a="raw"){const n=function(e,t,s){if(e.length<=360)return e;const a=Math.ceil(e.length/360),n=[];for(let r=0;r<e.length;r+=a){const t=e.slice(r,Math.min(r+a,e.length));if(0===t.length)continue;const l={timestamp:t[0].timestamp,time:t[0].time,counts:{},shares:{},airtimes:{},total:0,totalAirtime:0,bucketDurationMs:t[0].bucketDurationMs*t.length};for(const e of t){l.total+=e.total,l.totalAirtime+=e.totalAirtime;for(const t of s)l.counts[t.key]=(l.counts[t.key]??0)+(e.counts[t.key]??0),l.airtimes[t.key]=(l.airtimes[t.key]??0)+(e.airtimes[t.key]??0)}for(const e of s)l.shares[e.key]=l.total>0?l.counts[e.key]/l.total*100:0;n.push(l)}return n}(e,0,s),r=n.length,l=s.length,i=Array.from({length:l},()=>new Array(r).fill(0));for(let m=0;m<r;m++){const e=n[m];if("share"===t)for(let t=0;t<l;t++){const a=s[t].key;i[t][m]=e.total>0?(e.counts[a]??0)/e.total:0}else{let t=0;for(let a=0;a<l;a++)t+=e.airtimes[s[a].key]??0;for(let a=0;a<l;a++){const n=s[a].key,r=e.airtimes[n]??0;i[a][m]=t>0?r/t:0}}}const o=Array.from({length:l},()=>new Array(r).fill(0));for(let m=0;m<l;m++)for(let e=0;e<r;e++){let t=0;for(let s=0;s<=m;s++)t+=i[s][e];o[m][e]=t}const c=o.map(e=>function(e,t){switch(t){case"zlema":return Ge(e,6);case"ema":return Ge(e,12);case"smooth":return Ge(e,24);case"ultra":return Ge(e,96);default:return e}}(e,a)),d=Array.from({length:l},()=>new Array(r).fill(0));for(let m=0;m<l;m++)for(let e=0;e<r;e++){const t=m>0?c[m-1][e]:0;let s=c[m][e]-t;s<0&&(s=0),s>1&&(s=1),d[m][e]=s}for(let m=0;m<r;m++){let e=0;for(let t=0;t<l;t++)e+=d[t][m];if(e>0&&Math.abs(e-1)>1e-6){const t=1/e;for(let e=0;e<l;e++)d[e][m]*=t}}const u=[];for(let m=0;m<r;m++){const e={timestamp:n[m].timestamp,time:n[m].time};for(let t=0;t<l;t++)e[s[t].key]=d[t][m];u.push(e)}return u}(j,i,k,o),[j,i,k,o]),S=r.useCallback(e=>{x(e)},[]),[T,$]=r.useState(null),P=r.useCallback(e=>{$(e)},[]),R=r.useMemo(()=>{if(null===T||!C[T])return null;const e=C[T];return{timestamp:e.timestamp,timeLabel:e.time,items:k.map(t=>({key:t.key,label:t.label,value:e[t.key]??0,color:Oe(t.typeNum)}))}},[T,C,k]),A=r.useMemo(()=>({timestamps:C.map(e=>e.timestamp),series:k.map(e=>({key:e.key,label:e.label,color:Oe(e.typeNum),values:C.map(t=>t[e.key]??0)}))}),[C,k]);return 0===p.length?0===e.length?n.jsxs("div",{className:"h-full flex items-center justify-center text-text-muted",children:[n.jsx(g,{className:"w-6 h-6 mr-2 opacity-50"}),n.jsx("span",{children:"No packet data available"})]}):null:"mosaic"===o?n.jsx(Ye,{sortedTypes:k,aggregateShares:M}):"stats"===o?n.jsx(Ue,{statsBuckets:N,bucketData:j,mode:i,packets:p,startTs:t,endTs:s,radioConfig:l,sortedTypes:k,aggregateShares:M,noiseFloorAnomalies:c,showNoiseFloorOverlay:d,overlayOpacity:u}):"trend"===o?n.jsx(et,{packets:p,mode:i,startTs:t,endTs:s,radioConfig:l,bucketCount:a}):n.jsxs("div",{className:"flex flex-col",children:[n.jsx("div",{className:"analyzer-chart-height relative flex-shrink-0",children:n.jsx("div",{className:"absolute inset-0 rounded-lg overflow-hidden",children:n.jsx(_,{timestamps:A.timestamps,series:A.series,highlightedKey:h,cursorColor:m.cursor,onHover:P})})}),n.jsx(Ie,{sortedTypes:k,highlightedType:h,onTypeHover:S,aggregateShares:M,hoverData:R})]})}),rt={"1x":1,"2x":2,"4x":4,"8x":8,"16x":16,"36x":36},lt=[1,5,10,25,50,100,150];function it(e,t,s,a){const n=Math.PI/180,r=(a-t)*n,l=e*n,i=s*n,o=Math.sin(r)*Math.cos(i),c=Math.cos(l)*Math.sin(i)-Math.sin(l)*Math.cos(i)*Math.cos(r);return(180*Math.atan2(o,c)/Math.PI+360)%360}function ot(e,t,s,a){const n=Math.PI/180,r=(s-e)*n,l=(a-t)*n,i=Math.sin(r/2)**2+Math.cos(e*n)*Math.cos(s*n)*Math.sin(l/2)**2;return 12742*Math.atan2(Math.sqrt(i),Math.sqrt(1-i))}const ct=[{min:10,label:"Excellent"},{min:7,label:"Very Good"},{min:4,label:"Good"},{min:1,label:"Fair+"},{min:-2,label:"Fair"},{min:-5,label:"Fair-"},{min:-8,label:"Poor"},{min:-11,label:"Bad"},{min:-1/0,label:"Critical"}];function dt(e,t){return t[le(e)]||"#808080"}const ut=r.memo(function({neighbors:e,quickNeighbors:t,localLat:s,localLon:a,onStatsChange:l}){const[i,o]=r.useState(null),[c,d]=r.useState(new Set),[u,m]=r.useState({width:0,height:0}),[h,x]=r.useState("1x"),[p,g]=r.useState(1),f=r.useRef(null),y=r.useRef({}),v=r.useRef(null),j=r.useRef(null),N=r.useRef(p);N.current=p;const w=ne(),k=se(),M=re(),C=ae();r.useEffect(()=>{const e=j.current;if(!e)return;const t=new ResizeObserver(e=>{for(const t of e){const{width:e,height:s}=t.contentRect;e>0&&s>0&&m({width:e,height:s})}});t.observe(e);const s=e.getBoundingClientRect();return s.width>0&&s.height>0&&m({width:s.width,height:s.height}),()=>t.disconnect()},[]);const S=r.useMemo(()=>{const e=new Set;if(t)for(const s of t)e.add(s.hash);return e},[t]),T=r.useMemo(()=>{const e=new Map;if(t)for(const s of t)e.set(s.hash,{snr:s.avgSnr,rssi:s.avgRssi});return e},[t]),{processedNeighbors:$,maxDistance:P,totalNeighbors:R,zeroHopCount:A}=r.useMemo(()=>{const t=[];for(const[r,l]of Object.entries(e)){if(!l.latitude||!l.longitude||0===l.latitude||0===l.longitude)continue;if(!S.has(r))continue;const e=it(s,a,l.latitude,l.longitude),n=ot(s,a,l.latitude,l.longitude),i=T.get(r);t.push({hash:r.slice(0,8),name:l.node_name||l.name||"Unknown",snr:(null==i?void 0:i.snr)??l.snr??null,rssi:(null==i?void 0:i.rssi)??l.rssi??null,bearing:e,distance:n,normalizedDistance:0,lastSeen:l.last_seen,isZeroHop:!0})}const n=1.08*(t.length>0?Math.max(...t.map(e=>e.distance)):0);return t.sort((e,t)=>(e.snr??-1/0)-(t.snr??-1/0)),{processedNeighbors:t,maxDistance:n,totalNeighbors:t.length,zeroHopCount:t.length}},[e,s,a,S,T]);r.useEffect(()=>{null==l||l({zeroHopCount:A,totalCount:R,maxDistanceKm:P})},[A,R,P]),r.useEffect(()=>{const e=rt[h],t=N.current;f.current&&cancelAnimationFrame(f.current);const s=performance.now(),a=n=>{const r=n-s,l=Math.min(r/400,1),i=(o=l)<.5?8*o*o*o*o:1-Math.pow(-2*o+2,4)/2;var o;g(t+(e-t)*i),f.current=l<1?requestAnimationFrame(a):null};return f.current=requestAnimationFrame(a),()=>{f.current&&cancelAnimationFrame(f.current)}},[h]);const F=P/p,D=r.useMemo(()=>lt.filter(e=>e<=1.1*F),[F]);r.useEffect(()=>{const e=[];for(const s of $){const t=y.current[s.hash];void 0!==t&&t!==s.lastSeen&&e.push(s.hash),y.current[s.hash]=s.lastSeen}if(0===e.length)return;queueMicrotask(()=>{d(t=>new Set([...t,...e]))});const t=setTimeout(()=>{d(t=>{const s=new Set(t);return e.forEach(e=>s.delete(e)),s})},600);return()=>clearTimeout(t)},[$]);const L=0!==s&&0!==a,E=r.useMemo(()=>{const{width:e,height:t}=u,s=e/2,a=t/2,n=Math.max(10,e/2-12),r=Math.max(10,t/2-12),l=Math.max(10,n-16),i=Math.max(10,r-16);return{width:e,height:t,centerX:s,centerY:a,maxRadiusX:l,maxRadiusY:i,labelRadiusX:n,labelRadiusY:r,cornerRadius:.2*Math.min(l,i)}},[u]),{width:B,height:_,centerX:H,centerY:z,maxRadiusX:O,maxRadiusY:W,labelRadiusX:V,labelRadiusY:q,cornerRadius:G}=E,I=r.useCallback((e,t=1)=>{const s=O*t,a=W*t,n=Math.min(G*t,s,a),r=(e%360+360)%360,l=r*Math.PI/180,i=180*Math.atan2(a-n,s-n)/Math.PI;let o,c;if(r<=45-i||r>315+i){const e=Math.tan(l);o=Math.max(H-s+n,Math.min(H+s-n,H+a*e*(s/a))),c=z-a}else if(r>45-i&&r<=45+i)o=H+s-n+n*Math.sin(l),c=z-a+n-n*Math.cos(l);else if(r>45+i&&r<=135-i){const e=1/Math.tan(l);c=Math.max(z-a+n,Math.min(z+a-n,z-s*e*(a/s))),o=H+s}else if(r>135-i&&r<=135+i)o=H+s-n+n*Math.sin(l),c=z+a-n-n*Math.cos(l);else if(r>135+i&&r<=225-i){const e=Math.tan(l);o=Math.max(H-s+n,Math.min(H+s-n,H-a*e*(s/a))),c=z+a}else if(r>225-i&&r<=225+i)o=H-s+n+n*Math.sin(l),c=z+a-n-n*Math.cos(l);else if(r>225+i&&r<=315-i){const e=1/Math.tan(l);c=Math.max(z-a+n,Math.min(z+a-n,z-s*e*(a/s))),o=H-s}else o=H-s+n+n*Math.sin(l),c=z-a+n-n*Math.cos(l);return{x:o,y:c}},[H,z,O,W,G]),X=r.useCallback((e,t)=>{const s=I(e,1);return{x:H+(s.x-H)*t,y:z+(s.y-z)*t}},[I,H,z]),K=r.useCallback(e=>({N:{x:H,y:z-q},S:{x:H,y:z+q},E:{x:H+V,y:z},W:{x:H-V,y:z},NE:{x:H+V,y:z-q},SE:{x:H+V,y:z+q},SW:{x:H-V,y:z+q},NW:{x:H-V,y:z-q}}[e]),[H,z,V,q]),Y=r.useCallback(e=>{const t=O*e,s=W*e,a=Math.min(G*e,t,s),n=H-t,r=H+t,l=z-s,i=z+s;return[`M ${n+a} ${l}`,`L ${r-a} ${l}`,`Q ${r} ${l} ${r} ${l+a}`,`L ${r} ${i-a}`,`Q ${r} ${i} ${r-a} ${i}`,`L ${n+a} ${i}`,`Q ${n} ${i} ${n} ${i-a}`,`L ${n} ${l+a}`,`Q ${n} ${l} ${n+a} ${l}`,"Z"].join(" ")},[H,z,O,W,G]),J=r.useCallback(e=>{o(e)},[]),U=r.useCallback(e=>{x(e)},[]),Q=r.useCallback(e=>P<=0?0:e/P*p,[P,p]),Z=e=>`${e}km`,ee=r.useMemo(()=>{const e=D.map(e=>{const t=e/P*p;return{km:e,scale:t,labelY:z-W*t*.71}}).filter(e=>e.scale<=1.05&&e.scale>=.02).sort((e,t)=>t.km-e.km),t=[];for(const s of e)t.some(e=>Math.abs(e.labelY-s.labelY)<28)||t.push(s);return t},[D,P,p,z,W]),te=u.width>0&&u.height>0;return L?0===R?n.jsxs("div",{ref:v,className:"flex flex-col items-center justify-center h-full text-text-muted",children:[n.jsx(b,{className:"w-8 h-8 mb-2 opacity-50"}),n.jsx("p",{children:"No nodes with location data"})]}):n.jsxs("div",{ref:v,className:"relative h-full w-full flex overflow-hidden",children:[n.jsx("div",{ref:j,className:"relative flex-1 min-w-0 h-full",children:te&&n.jsxs("svg",{width:B,height:_,className:"absolute inset-0 z-0",children:[n.jsxs("defs",{children:[n.jsx("style",{children:"\n                @keyframes neighbor-blink-scale {\n                  0%, 100% {\n                    transform: scale(1);\n                    opacity: 0;\n                  }\n                  50% {\n                    transform: scale(1.3);\n                    opacity: 0.8;\n                  }\n                }\n                .neighbor-blink-ring {\n                  transform-origin: center;\n                  animation: neighbor-blink-scale 600ms ease-out forwards;\n                }\n              "}),n.jsx("clipPath",{id:"radar-clip",children:n.jsx("path",{d:Y(1)})})]}),D.map(e=>{const t=Q(e);if(t>1.05||t<.02)return null;const s=ee.some(t=>t.km===e),a=H+O*t*.71,r=z-W*t*.71;return n.jsxs("g",{children:[n.jsx("path",{d:Y(t),fill:"none",stroke:C.primary,strokeOpacity:.15,strokeWidth:1}),s&&n.jsx("text",{x:a+4,y:r-2,textAnchor:"start",dominantBaseline:"auto",className:"fill-text-secondary",fontSize:10,fontFamily:"'JetBrains Mono', monospace",children:Z(e)})]},`ring-${e}`)}),["N","E","S","W"].map(e=>{const t="N"===e||"S"===e,s=t?H:"E"===e?H+O:H-O,a=t?"N"===e?z-W:z+W:z;return n.jsx("line",{x1:H,y1:z,x2:s,y2:a,stroke:C.primary,strokeOpacity:.15,strokeWidth:1,strokeDasharray:"4 4"},e)}),["NE","SE","SW","NW"].map(e=>{const t=K(e);return n.jsx("line",{x1:H,y1:z,x2:t.x,y2:t.y,stroke:C.primary,strokeOpacity:.08,strokeWidth:1,strokeDasharray:"4 4"},`diag-${e}`)}),["N","E","S","W"].map(e=>{const t=K(e),s="E"===e?"end":"W"===e?"start":"middle",a="N"===e?"hanging":"S"===e?"auto":"middle";return n.jsx("text",{x:t.x,y:t.y,textAnchor:s,dominantBaseline:a,fill:k.critical,fontSize:16,fontWeight:600,fontFamily:"'JetBrains Mono', monospace","aria-hidden":"true",children:e},e)}),["NE","SE","SW","NW"].map(e=>{const t=K(e),s="NE"===e||"SE"===e?"end":"start",a="NE"===e||"NW"===e?"hanging":"auto";return n.jsx("text",{x:t.x,y:t.y,textAnchor:s,dominantBaseline:a,fill:k.critical,fontSize:16,fontWeight:600,fontFamily:"'JetBrains Mono', monospace","aria-hidden":"true",children:e},e)}),n.jsx("circle",{cx:H,cy:z,r:5,fill:M.chart6,stroke:"rgba(255,255,255,0.3)",strokeWidth:1,role:"img","aria-label":"Local node"}),n.jsx("g",{clipPath:"url(#radar-clip)",children:$.map(e=>{const t=P>0?e.distance/P*p:0;if(t>1)return null;const{x:s,y:a}=X(e.bearing,t),r=null!==e.snr?dt(e.snr,w):"#808080",l=(null==i?void 0:i.hash)===e.hash,o=c.has(e.hash);return n.jsxs("g",{role:"img","aria-label":`${e.name}: ${e.distance.toFixed(1)}km ${e.bearing.toFixed(0)}`,children:[o&&n.jsx("circle",{cx:s,cy:a,r:10.5,fill:"none",stroke:"rgba(255,255,255,0.9)",strokeWidth:2,className:"neighbor-blink-ring"}),l&&n.jsx("circle",{cx:s,cy:a,r:10.5,fill:r,opacity:.3}),n.jsx("circle",{cx:s,cy:a,r:l?7:5,fill:r,stroke:"rgba(0,0,0,0.5)",strokeWidth:1,style:{cursor:"pointer",transition:"r 0.15s"},onMouseEnter:()=>J(e),onMouseLeave:()=>J(null)})]},e.hash)})})]})}),n.jsx("div",{className:"flex flex-col h-full items-stretch gap-1 py-2 pl-2 flex-shrink-0",role:"group","aria-label":"Zoom level",children:["1x","2x","4x","8x","16x","36x"].map(e=>n.jsx("button",{onClick:()=>U(e),"aria-pressed":h===e,className:"flex flex-1 items-center justify-center px-1.5 text-xs font-medium rounded transition-colors "+(h===e?"bg-accent-primary/20 text-accent-primary":"bg-white/5 text-text-muted hover:bg-white/10 hover:text-text-secondary"),children:e},e))}),i&&n.jsxs("div",{className:"absolute bg-tooltip-bg border border-border-subtle rounded-lg px-3 py-2 text-sm pointer-events-none z-10 shadow-xl",style:{left:"50%",bottom:8,transform:"translateX(-50%)"},children:[n.jsx("div",{className:"font-medium text-text-primary",children:i.name}),n.jsx("div",{className:"text-text-muted text-xs font-mono",children:i.hash}),null!==i.snr?n.jsx("div",{className:"flex gap-3 mt-1 text-xs",children:n.jsxs("span",{children:[n.jsx("span",{className:"text-text-muted",children:"SNR:"})," ",n.jsxs("span",{className:"tabular-nums",style:{color:dt(i.snr,w)},children:[i.snr.toFixed(1)," dB"]}),n.jsxs("span",{className:"text-text-muted ml-1",children:["(",(le=i.snr,(null==(ie=ct.find(e=>le>=e.min))?void 0:ie.label)??"Critical"),")"]})]})}):n.jsx("div",{className:"text-xs text-text-muted mt-1",children:"No SNR data"}),n.jsxs("div",{className:"flex gap-3 text-xs",children:[n.jsxs("span",{children:[n.jsx("span",{className:"text-text-muted",children:"Distance:"})," ",n.jsxs("span",{className:"tabular-nums text-text-secondary",children:[i.distance.toFixed(2)," km"]})]}),n.jsxs("span",{children:[n.jsx("span",{className:"text-text-muted",children:"Bearing:"})," ",n.jsxs("span",{className:"tabular-nums text-text-secondary",children:[i.bearing.toFixed(0),""]})]})]})]})]}):n.jsxs("div",{ref:v,className:"flex flex-col items-center justify-center h-full text-text-muted",children:[n.jsx(b,{className:"w-8 h-8 mb-2 opacity-50"}),n.jsx("p",{children:"Local node coordinates not configured"}),n.jsx("p",{className:"text-xs mt-1",children:"Set latitude/longitude in config to enable"})]});var le,ie});function mt(e,t){if(0===e.length)return 0;const s=t/100*(e.length-1),a=Math.floor(s),n=Math.ceil(s);return a===n?e[a]:e[a]+(e[n]-e[a])*(s-a)}const ht=r.memo(function({timestamps:e,values:t,onStatsChange:s}){var a,l;const i=se(),[o,c]=r.useState(!0),d=r.useMemo(()=>{if(0===t.length)return null;const e=Math.min(...t),s=Math.max(...t),a=t.reduce((e,t)=>e+t,0)/t.length,n=[...t].sort((e,t)=>e-t);return{min:e,max:s,avg:a,p5:mt(n,5),p95:mt(n,95)}},[t]);r.useEffect(()=>{null==s||s(d)},[d]);const u=r.useCallback(()=>{c(e=>!e)},[]),{heatmapData:m,xLabels:h,yLabels:x}=r.useMemo(()=>{if(0===e.length||0===t.length||!d)return{heatmapData:null,xLabels:[],yLabels:[]};let s,a;if(o){const e=.1*(d.p95-d.p5||1);s=d.p5-e,a=d.p95+e}else{const e=.1*(d.max-d.min||1);s=d.min-e,a=d.max+e}const n=a-s,r=e[0],l=e[e.length-1]-r||1,i=new Float32Array(2*e.length);for(let o=0;o<e.length;o++){const c=(e[o]-r)/l,d=1-(Math.max(s,Math.min(a,t[o]))-s)/n;i[2*o]=c,i[2*o+1]=d}const c=[];for(let e=0;e<=5;e++){const t=r+l*e/5;c.push({pos:e/5*100,label:new Date(1e3*t).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})}const u=[];for(let e=0;e<=4;e++){const t=s+n*e/4;u.push({pos:100*(1-e/4),label:`${Math.round(t)}`})}return{heatmapData:{points:i,count:e.length},xLabels:c,yLabels:u}},[e,t,d,o]),p=r.useRef(null),g=r.useRef(null),[f,b]=r.useState({width:0,height:0}),j=i.critical,N=r.useMemo(()=>ie(j)??{r:225,g:38,b:114},[j]);return r.useEffect(()=>{const e=g.current;if(!e)return;const t=new ResizeObserver(e=>{for(const t of e){const{width:e,height:s}=t.contentRect;e>0&&s>0&&b({width:e,height:s})}});t.observe(e);const s=e.getBoundingClientRect();return s.width>0&&s.height>0&&b({width:s.width,height:s.height}),()=>t.disconnect()},[]),r.useEffect(()=>{const e=p.current;if(!e||!m||0===f.width)return;const t=e.getContext("2d");if(!t)return;const{width:s,height:a}=f,n=window.devicePixelRatio||1;e.width=s*n,e.height=a*n,e.style.width=`${s}px`,e.style.height=`${a}px`,t.scale(n,n),t.clearRect(0,0,s,a);const{points:r,count:l}=m,{r:i,g:o,b:c}=N,d=Math.max(3,Math.min(8,s/l*4));t.globalCompositeOperation="source-over";for(let u=0;u<l;u++){const e=r[2*u]*s,n=r[2*u+1]*a,l=t.createRadialGradient(e,n,0,e,n,d);l.addColorStop(0,`rgba(${i}, ${o}, ${c}, 0.8)`),l.addColorStop(.19,`rgba(${i}, ${o}, ${c}, 0.8)`),l.addColorStop(.2,`rgba(${i}, ${o}, ${c}, 0.1)`),l.addColorStop(1,`rgba(${i}, ${o}, ${c}, 0)`),t.fillStyle=l,t.beginPath(),t.arc(e,n,d,0,2*Math.PI),t.fill()}},[m,f,N]),m?n.jsxs("div",{className:"relative w-full h-full",role:"img","aria-label":`RF noise floor heatmap showing values from ${(null==(a=null==d?void 0:d.min)?void 0:a.toFixed(0))??"N/A"} to ${(null==(l=null==d?void 0:d.max)?void 0:l.toFixed(0))??"N/A"} dBm`,children:[n.jsx("div",{className:"absolute top-0 left-0 flex flex-col justify-between",style:{width:32,bottom:20},"aria-hidden":"true",children:x.map((e,t)=>n.jsx("span",{className:"type-data-xs text-text-muted tabular-nums text-right pr-1.5",style:{position:"absolute",top:`${e.pos}%`,transform:"translateY(-50%)",right:0},children:e.label},t))}),n.jsxs("div",{ref:g,className:"absolute overflow-hidden",style:{left:32,right:0,top:0,bottom:20},children:[n.jsx("svg",{className:"absolute inset-0 w-full h-full",preserveAspectRatio:"none","aria-hidden":"true",children:[0,25,50,75,100].map(e=>n.jsx("line",{x1:"0",y1:`${e}%`,x2:"100%",y2:`${e}%`,stroke:"rgba(255,255,255,0.06)",strokeDasharray:"3 3"},e))}),n.jsx("canvas",{ref:p,className:"absolute inset-0 w-full h-full","aria-hidden":"true"}),n.jsx("button",{type:"button",onClick:u,className:"absolute bottom-1 right-1 p-1.5 rounded bg-tooltip-bg/80 hover:bg-tooltip-bg active:bg-tooltip-bg transition-colors touch-manipulation",title:o?"Show full range (min/max)":"Show trimmed range (P5-P95)","aria-label":o?"Expand to show full data range":"Shrink to show trimmed percentile range","aria-pressed":!o,children:o?n.jsx(y,{className:"w-3.5 h-3.5 text-text-muted","aria-hidden":"true"}):n.jsx(v,{className:"w-3.5 h-3.5 text-text-muted","aria-hidden":"true"})})]}),n.jsx("div",{className:"absolute left-0 right-0 bottom-0",style:{left:32,height:20},"aria-hidden":"true",children:h.map((e,t)=>n.jsx("span",{className:"type-data-xs text-text-muted tabular-nums absolute top-1",style:{left:`${e.pos}%`,transform:"translateX(-50%)"},children:e.label},t))})]}):n.jsx("div",{className:"h-full flex items-center justify-center text-text-muted",children:"No noise floor data available"})}),xt={repeater:"var(--signal-critical)",companion:"var(--accent-tertiary)",room_server:"var(--accent-secondary)"};function pt(e){if(e.contact_type){const t=e.contact_type.toLowerCase();if("repeater"===t||"rep"===t)return"repeater";if("room server"===t||"room_server"===t||"room"===t||"server"===t)return"room_server";if("companion"===t||"client"===t||"cli"===t)return"companion"}return e.is_repeater?"repeater":"companion"}const gt=r.memo(function({neighbors:e}){const t=r.useMemo(()=>{const t={repeater:0,companion:0,room_server:0};for(const a of Object.values(e)){const e=pt(a);t[e]=(t[e]||0)+1}const s=Object.values(t).reduce((e,t)=>e+t,0);return{items:[{label:"Repeaters",count:t.repeater,percent:0,color:xt.repeater},{label:"Companions",count:t.companion,percent:0,color:xt.companion},{label:"Room Servers",count:t.room_server,percent:0,color:xt.room_server}].map(e=>({...e,percent:s>0?e.count/s*100:0})).filter(e=>e.count>0).sort((e,t)=>t.count-e.count),total:s}},[e]);return 0===t.total?n.jsx("div",{className:"h-full flex items-center justify-center text-text-muted type-body-sm",children:"No neighbors discovered yet"}):n.jsxs("div",{className:"h-full flex flex-col",children:[n.jsx("div",{className:"flex-1 flex flex-col justify-evenly",children:t.items.map(e=>n.jsxs("div",{className:"flex flex-col gap-1.5",children:[n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsx("span",{className:"type-data-sm text-text-secondary",children:e.label}),n.jsxs("span",{className:"type-data-sm text-text-muted tabular-nums",children:[e.count," ",n.jsxs("span",{className:"text-text-muted/60",children:["(",e.percent.toFixed(0),"%)"]})]})]}),n.jsx("div",{className:"h-2.5 bg-bg-elevated rounded-full overflow-hidden",children:n.jsx("div",{className:"h-full rounded-full transition-all duration-500 ease-out",style:{width:`${e.percent}%`,backgroundColor:e.color,minWidth:e.count>0?"4px":"0"}})})]},e.label))}),n.jsxs("div",{className:"flex items-center justify-between pt-2 border-t border-border-subtle",children:[n.jsx("span",{className:"type-data-xs text-text-muted",children:"Total Nodes"}),n.jsx("span",{className:"type-data-sm text-text-primary font-medium tabular-nums",children:t.total})]})]})});function ft({children:e,minHeight:t="100%",rootMargin:s="200px 0px",keepMounted:a=!0,className:l=""}){const i=r.useRef(null),[o,c]=r.useState(!1),[d,u]=r.useState(!1);r.useEffect(()=>{const e=i.current;if(!e)return;const t=new IntersectionObserver(([e])=>{const t=e.isIntersecting;u(t),t&&c(!0)},{rootMargin:s,threshold:0});return t.observe(e),()=>{t.disconnect()}},[s]);const m=d||a&&o;return n.jsx("div",{ref:i,className:`h-full w-full ${l}`,style:{minHeight:t},children:m?e:n.jsx("div",{className:"h-full w-full flex items-center justify-center text-text-muted/50",children:n.jsx("div",{className:"animate-pulse text-xs",children:"Loading chart..."})})})}const bt={excellent:"text-signal-excellent",good:"text-signal-good",fair:"text-signal-fair",poor:"text-signal-critical"},yt={excellent:"bg-signal-excellent/10",good:"bg-signal-good/10",fair:"bg-signal-fair/10",poor:"bg-signal-critical/10"};function vt({value:e,status:t}){const s={excellent:"bg-signal-excellent",good:"bg-signal-good",fair:"bg-signal-fair",poor:"bg-signal-critical"}[t];return n.jsx("div",{className:"w-full h-2 bg-surface-elevated rounded-full overflow-hidden",children:n.jsx("div",{className:`h-full ${s} transition-all duration-300`,style:{width:`${Math.min(100,Math.max(0,e))}%`}})})}function jt(){const e=z(),t=O(),[s,a]=r.useState(null),l=r.useCallback((e,t)=>{a({prefix:e,candidateHashes:t})},[]),i=r.useCallback(()=>{a(null)},[]);if(!t)return n.jsxs(fe,{children:[n.jsx(be,{icon:n.jsx(j,{}),title:"Prefix Conflicts",largeTitle:!0}),n.jsx("div",{className:"flex-1 flex items-center justify-center",children:n.jsxs("div",{className:"text-center text-text-muted",children:[n.jsx(N,{className:"w-8 h-8 mx-auto mb-2 opacity-50"}),n.jsx("p",{className:"type-data-xs",children:"No topology data available"}),n.jsx("p",{className:"type-data-xs opacity-70",children:"Run deep analysis to see stats"})]})})]});const o=(c=e.avgConfidence)>=.9?"excellent":c>=.7?"good":c>=.5?"fair":"poor";var c;const d=(u=e.collisionRate)<=10?"excellent":u<=25?"good":"poor";var u;const m="poor"===o||"poor"===d?"poor":"fair"===o||"fair"===d?"fair":"good"===o||"good"===d?"good":"excellent",h="excellent"===m||"good"===m?w:k;return n.jsxs(fe,{className:"flex flex-col overflow-hidden",children:[n.jsx(be,{icon:n.jsx(j,{}),title:"Prefix Conflicts",largeTitle:!0,actions:n.jsxs("div",{className:`flex items-center gap-1.5 px-2.5 py-1 rounded-full ${yt[m]}`,children:[n.jsx(h,{className:`w-3.5 h-3.5 ${bt[m]}`}),n.jsx("span",{className:`type-data-xs font-medium ${bt[m]}`,children:"excellent"===m?"Excellent":"good"===m?"Good":"fair"===m?"Fair":"Needs Attention"})]})}),n.jsxs("div",{className:"flex-1 overflow-y-auto min-h-0",children:[n.jsxs("div",{className:"grid grid-cols-2 gap-3 mb-3",children:[n.jsxs("div",{className:"cursor-help",title:"Average confidence score across all disambiguated prefixes. Higher = more certain node identification. Based on geographic proximity, co-occurrence patterns, and observation recency.",children:[n.jsxs("div",{className:"flex items-baseline justify-between mb-1",children:[n.jsx("span",{className:"type-data-xs text-text-muted",children:"Avg Confidence"}),n.jsxs("span",{className:`type-data-lg font-semibold ${bt[o]}`,children:[(100*e.avgConfidence).toFixed(1),"%"]})]}),n.jsx(vt,{value:100*e.avgConfidence,status:o})]}),n.jsxs("div",{className:"cursor-help",title:"Percentage of 2-character prefixes that match multiple known nodes. Lower is better. Collisions require disambiguation to determine the correct node.",children:[n.jsxs("div",{className:"flex items-baseline justify-between mb-1",children:[n.jsx("span",{className:"type-data-xs text-text-muted",children:"Collision Rate"}),n.jsxs("span",{className:`type-data-lg font-semibold ${bt[d]}`,children:[e.collisionRate.toFixed(1),"%"]})]}),n.jsx(vt,{value:e.collisionRate,status:d})]})]}),n.jsxs("div",{className:"grid grid-cols-3 gap-2 mb-3",children:[n.jsxs("div",{className:"text-center cursor-help px-2 py-1.5 rounded",style:{backgroundColor:"var(--hover-tint)"},title:"Total unique 2-character prefixes observed in packet paths. Each prefix represents the first 2 hex digits of a node's full hash.",children:[n.jsx("div",{className:"type-data-lg font-semibold text-text-primary",children:e.totalPrefixes}),n.jsx("div",{className:"type-data-xs text-text-muted",children:"Prefixes"})]}),n.jsxs("div",{className:"text-center cursor-help px-2 py-1.5 rounded",style:{backgroundColor:"var(--hover-tint)"},title:"Prefixes that map to exactly one known node. No disambiguation neededthese are definitive identifications.",children:[n.jsx("div",{className:"type-data-lg font-semibold text-signal-good",children:e.unambiguousPrefixes}),n.jsx("div",{className:"type-data-xs text-text-muted",children:"Unique"})]}),n.jsxs("div",{className:"text-center cursor-help px-2 py-1.5 rounded",style:{backgroundColor:"var(--hover-tint)"},title:"Prefixes matching multiple known nodes. Click a prefix below to explore candidates and see how disambiguation scores them.",children:[n.jsx("div",{className:"type-data-lg font-semibold "+(e.collisionPrefixes>0?"text-signal-critical":"text-text-primary"),children:e.collisionPrefixes}),n.jsx("div",{className:"type-data-xs "+(e.collisionPrefixes>0?"text-signal-critical":"text-text-muted"),children:"Collisions"})]})]}),e.highCollisionPrefixes.length>0&&n.jsxs("div",{className:"mb-2",children:[n.jsx("div",{className:"type-data-xs text-text-muted mb-1.5",children:"Highest Collisions"}),n.jsx("div",{className:"flex flex-wrap gap-1",children:e.highCollisionPrefixes.map(({prefix:e,candidateCount:t,candidateHashes:s})=>n.jsxs("button",{type:"button",onClick:()=>l(e,s),className:"inline-flex items-center gap-1 px-1.5 py-0.5 min-h-[24px] rounded bg-surface-elevated text-text-secondary type-data-xs font-mono hover:bg-signal-critical/20 hover:text-signal-critical focus:outline-none focus:ring-2 focus:ring-signal-critical/50 transition-colors cursor-pointer touch-manipulation",title:`Click to explore ${t} candidates matching this prefix`,"aria-label":`Explore prefix ${e} with ${t} colliding candidates`,children:[e,n.jsxs("span",{className:"text-signal-critical",children:["",t]})]},e))})]}),e.lowConfidencePrefixes.length>0&&n.jsx("div",{className:"mt-auto pt-2",children:n.jsxs("div",{className:"flex items-start gap-1.5",children:[n.jsx(k,{className:"w-3.5 h-3.5 text-signal-critical mt-0.5 flex-shrink-0"}),n.jsxs("div",{className:"min-w-0",children:[n.jsxs("div",{className:"type-data-xs text-signal-critical font-medium",children:[n.jsx("span",{className:"text-signal-critical",children:e.lowConfidencePrefixes.length})," prefix",1!==e.lowConfidencePrefixes.length?"es":""," with low confidence"]}),n.jsxs("div",{className:"type-data-xs text-text-muted font-mono truncate",children:[e.lowConfidencePrefixes.slice(0,5).join(", "),e.lowConfidencePrefixes.length>5&&n.jsxs("span",{className:"text-signal-critical",children:[" +",e.lowConfidencePrefixes.length-5," more"]})]})]})]})}),0===e.lowConfidencePrefixes.length&&0===e.collisionPrefixes&&n.jsx("div",{className:"mt-auto pt-2",children:n.jsxs("div",{className:"flex items-center gap-1.5",children:[n.jsx(w,{className:"w-3.5 h-3.5 text-signal-excellent"}),n.jsx("span",{className:"type-data-xs text-signal-excellent",children:"All prefixes uniquely identified"})]})})]}),n.jsx(je,{isOpen:!!s,prefix:(null==s?void 0:s.prefix)||"",candidateHashes:(null==s?void 0:s.candidateHashes)||[],onClose:i})]})}function Nt({icon:e,label:t,value:s,sublabel:a,highlight:r,tooltip:l}){return n.jsxs("div",{className:"flex items-center justify-between py-2 "+(l?"cursor-help":""),title:l,children:[n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsx("span",{className:"icon-xs text-icon-widget",children:e}),n.jsx("span",{className:"type-label text-text-secondary",children:t})]}),n.jsxs("div",{className:"text-right",children:[n.jsx("span",{className:"type-data-sm "+(r?"text-accent-tertiary":"text-text-primary"),children:s}),a&&n.jsx("span",{className:"type-data-xs text-text-muted ml-1",children:a})]})]})}function wt(){const e=W(),t=V().length;if(!e||0===e.totalPaths)return null;const{totalPaths:s,pathsWithGhosts:a,observationOverrideCount:r,tracePacketsProcessed:l,pathPacketsProcessed:i,distantEdgesDiscovered:o,duplicateGroupsFound:c,duplicatePathsUnique:d,echolocationEdgesInferred:u}=e,m=s>0?((s-a)/s*100).toFixed(1):"0",h=s>0?(a/s*100).toFixed(1):"0",p=s>0?(r/s*100).toFixed(1):"0",g=l+i,f=g>0||o>0,b=c>0||u>0;return n.jsxs(fe,{children:[n.jsx(be,{title:"Path Decoder",icon:n.jsx(M,{}),largeTitle:!0,badge:t>0?`${t} hidden`:void 0}),n.jsxs(ke,{children:[n.jsx("p",{className:"type-data-xs text-text-muted mb-3",children:"Decodes packet routes to map your mesh topology and discover hidden repeaters."}),n.jsxs("div",{className:"divide-y divide-white/5",children:[n.jsx(Nt,{icon:n.jsx(C,{className:"w-3.5 h-3.5"}),label:"Traceable",value:`${m}%`,sublabel:`of ${s.toLocaleString()} paths`,highlight:parseFloat(m)>=90,tooltip:"Percentage of packet journeys where every hop was identified. Higher = better visibility into how traffic flows through your mesh."}),n.jsx(Nt,{icon:n.jsx(S,{className:"w-3.5 h-3.5"}),label:"Hidden Nodes",value:a.toLocaleString(),sublabel:`paths (${h}%)`,highlight:a>0,tooltip:"Paths containing unidentified repeaters. These 'ghost' nodes forward traffic but haven't announced themselves via ADVERT  possibly distant or newly added nodes."}),n.jsx(Nt,{icon:n.jsx(T,{className:"w-3.5 h-3.5"}),label:"Learning Rate",value:`${p}%`,sublabel:"adapted",tooltip:"How often real traffic patterns improved our predictions over geography alone. Higher values mean the decoder is learning your mesh's actual behavior  which routes are preferred, which nodes are most active."})]}),f&&n.jsxs("div",{className:"mt-3 pt-3 border-t border-border-subtle",children:[n.jsx("p",{className:"type-micro mb-2",children:"Beyond Line-of-Sight"}),n.jsxs("div",{className:"divide-y divide-white/5",children:[n.jsx(Nt,{icon:n.jsx($,{className:"w-3.5 h-3.5"}),label:"Route Reports",value:g.toLocaleString(),sublabel:l>0?`(${l} TRACE)`:void 0,tooltip:"TRACE/PATH packets from distant nodes share their routing tables. This reveals connections we can't directly observe  mapping parts of the mesh we don't touch."}),n.jsx(Nt,{icon:n.jsx(P,{className:"w-3.5 h-3.5"}),label:"Remote Links",value:o.toLocaleString(),highlight:o>0,tooltip:"Node-to-node connections discovered from route reports. These links exist outside our RF range but help complete the topology picture."})]})]}),b&&n.jsxs("div",{className:"mt-3 pt-3 border-t border-border-subtle",children:[n.jsx("p",{className:"type-micro mb-2",children:"Echo Analysis"}),n.jsxs("div",{className:"divide-y divide-white/5",children:[n.jsx(Nt,{icon:n.jsx(R,{className:"w-3.5 h-3.5"}),label:"Multi-Path Packets",value:c.toLocaleString(),sublabel:d>0?`(${d} routes)`:void 0,tooltip:"Packets received via multiple paths simultaneously. Like sonar, these 'echoes' reveal redundant routes  important for understanding mesh resilience."}),n.jsx(Nt,{icon:n.jsx(x,{className:"w-3.5 h-3.5"}),label:"Inferred Links",value:u.toLocaleString(),highlight:u>0,tooltip:"Connections discovered from echo patterns. When the same packet arrives via different forwarders nearly simultaneously, those forwarders likely hear each other."})]})]}),t>0&&n.jsx("div",{className:"mt-3 pt-3 border-t border-border-subtle cursor-help",title:"High-confidence hidden repeaters: appear in 10+ paths, have 2+ known neighbors, 30% confidence, and plausible location. View them on the Contacts map.",children:n.jsxs("p",{className:"type-label text-text-muted",children:[n.jsx("span",{className:"text-accent-tertiary type-data-sm",children:t})," ","likely repeater",1!==t?"s":""," discovered from traffic patterns"]})})]})]})}const kt={useAbsoluteThresholds:!0,baselinePercentile:6,spikePercentile:50,baselineDbm:-107,spikeDbm:-100,mergeGapSeconds:45,minSequenceLength:16,similarityToleranceDbm:5};function Mt(e,t){if(0===e.length)return 0;const s=t/100*(e.length-1),a=Math.floor(s),n=Math.ceil(s);return a===n?e[a]:e[a]+(e[n]-e[a])*(s-a)}function Ct(e){if(0===e.length)return{median:0,p90:0,p95:0,p99:0,max:0,min:0};const t=[...e].sort((e,t)=>e-t);return{median:Mt(t,50),p90:Mt(t,90),p95:Mt(t,95),p99:Mt(t,99),max:t[t.length-1],min:t[0]}}function St(e,t,s){const a=s-t;if(0===a)return"moderate";const n=(e-t)/a;return n>.66?"critical":n>.33?"severe":"moderate"}function Tt(){var e,t,s,a,l,i,o,c,d,u,m,h,x,p,f,y,v;const j=q(),N=G(),w=I(),k=X(),M=K(),[C,S]=r.useState([]),[T,$]=r.useState(null),[P,D]=r.useState(null),[L,E]=r.useState(!0),[B,_]=r.useState(null),[H,z]=r.useState(5),[O,W]=r.useState("share"),[V,ee]=r.useState("stats"),[te,se]=r.useState(!1),[ae,ne]=r.useState(!1),[re,le]=r.useState(kt),[ie,oe]=r.useState(.5),ce=r.useCallback(e=>{r.startTransition(()=>{z(e)})},[]),de=Y[H].hours,ue=60*de,me=r.useMemo(()=>{var e;if(!(null==(e=null==j?void 0:j.config)?void 0:e.radio))return null;const t=j.config.radio;return{sf:t.spreading_factor??10,bw:t.bandwidth??25e4,cr:t.coding_rate??5,preamble:t.preamble_length??8}},[null==(t=null==(e=null==j?void 0:j.config)?void 0:e.radio)?void 0:t.spreading_factor,null==(a=null==(s=null==j?void 0:j.config)?void 0:s.radio)?void 0:a.bandwidth,null==(i=null==(l=null==j?void 0:j.config)?void 0:l.radio)?void 0:i.coding_rate,null==(c=null==(o=null==j?void 0:j.config)?void 0:o.radio)?void 0:c.preamble_length]);r.useEffect(()=>{!async function(){var e;_(null);try{const t=await J(de);t.success&&(null==(e=t.data)?void 0:e.history)&&S(t.data.history)}catch(t){_(t instanceof Error?t.message:"Failed to load chart data")}finally{E(!1)}}()},[de]);const he=r.useMemo(()=>{switch(de){case 72:return 6e5;case 168:return 18e5;default:return 3e5}},[de]),xe=r.useCallback(async()=>{var e;try{const t=await J(de);t.success&&(null==(e=t.data)?void 0:e.history)&&S(t.data.history)}catch{}},[de]);Z(xe,he,!0,!0);const pe=r.useMemo(()=>0===C.length?{timestamps:[],values:[]}:{timestamps:C.map(e=>e.timestamp),values:C.map(e=>e.noise_floor_dbm)},[C]),ge=r.useMemo(()=>{if(C.length<10)return{anomalies:[],debug:void 0};const e=function(e,t={}){const s={...kt,...t};if(e.length<10)return{anomalies:[],thresholds:Ct([]),totalSamples:e.length,anomalySamples:0};const a=e.map(e=>e.noise_floor_dbm),n=Ct(a),r=[...a].sort((e,t)=>e-t);let l,i;s.useAbsoluteThresholds?(l=s.baselineDbm,i=s.spikeDbm):(l=Mt(r,s.baselinePercentile),i=Mt(r,s.spikePercentile));const o=[...e].sort((e,t)=>e.timestamp-t.timestamp),c=[];let d=null,u=0;for(const m of o)if(m.noise_floor_dbm>l&&m.noise_floor_dbm<i)if(u++,d){const e=Math.abs(m.noise_floor_dbm-d.rollingAvg)<=s.similarityToleranceDbm,t=m.timestamp-d.endTs<=s.mergeGapSeconds;e&&t?(d.endTs=m.timestamp,d.values.push(m.noise_floor_dbm),d.timestamps.push(m.timestamp),d.rollingAvg=d.values.reduce((e,t)=>e+t,0)/d.values.length):(d.values.length>=s.minSequenceLength&&c.push(d),d={startTs:m.timestamp,endTs:m.timestamp,values:[m.noise_floor_dbm],timestamps:[m.timestamp],rollingAvg:m.noise_floor_dbm})}else d={startTs:m.timestamp,endTs:m.timestamp,values:[m.noise_floor_dbm],timestamps:[m.timestamp],rollingAvg:m.noise_floor_dbm};else d&&d.values.length>=s.minSequenceLength&&c.push(d),d=null;return d&&d.values.length>=s.minSequenceLength&&c.push(d),0===c.length?{anomalies:[],thresholds:n,totalSamples:e.length,anomalySamples:u,debug:{baselineCutoff:l,spikeCutoff:i,midBandSamples:u}}:{anomalies:c.map(e=>{const t=Math.max(...e.values),s=e.values.reduce((e,t)=>e+t,0)/e.values.length;return{startTs:e.startTs,endTs:e.endTs,peakValue:t,avgValue:s,severity:St(s,l,i),sampleCount:e.values.length}}),thresholds:n,totalSamples:e.length,anomalySamples:u,debug:{baselineCutoff:l,spikeCutoff:i,midBandSamples:u}}}(C,re);return{anomalies:e.anomalies,debug:e.debug}},[C,re]),je=ge.anomalies,ke=Y[H],Me=r.useMemo(()=>{const e=(null==j?void 0:j.neighbors)??{};return Object.fromEntries(Object.entries(e).filter(([e])=>!N.has(e)))},[null==j?void 0:j.neighbors,N]),Ce=r.useMemo(()=>{const e=Date.now()/1e3-3600*de;return Object.fromEntries(Object.entries(Me).filter(([,t])=>t.last_seen>=e))},[Me,de]),Se=U(de),Te=r.useMemo(()=>{const e=60*ue/Se,t=Math.floor(Date.now()/1e3),s=Math.floor(t/e)*e;return{start:s-60*ue,end:s}},[ue,Se]);return n.jsxs(ye,{children:[n.jsx(ve,{title:"Statistics",icon:n.jsx(A,{}),controls:n.jsx(Q,{ranges:Y,selectedIndex:H,onSelect:ce})}),B&&n.jsx(fe,{className:"border border-accent-red/50 bg-accent-red/10",children:n.jsx("p",{className:"text-accent-red",children:B})}),te&&ae&&n.jsxs(fe,{className:"border border-accent-purple/30 bg-glass-surface/50",children:[n.jsxs("div",{className:"flex items-center justify-between mb-3",children:[n.jsxs("div",{className:"flex items-center gap-2",children:[n.jsx("span",{className:"type-label",children:"Anomaly Detection Tuning"}),n.jsxs("span",{className:"type-data-xs text-text-muted",children:["(",ke.label,")"]})]}),n.jsx("button",{onClick:()=>le(e=>({...e,useAbsoluteThresholds:!e.useAbsoluteThresholds})),className:"type-data-xs px-2 py-1 rounded transition-colors "+(re.useAbsoluteThresholds?"bg-accent-purple/30 text-accent-purple":"bg-glass-elevated text-text-muted hover:text-text-secondary"),children:re.useAbsoluteThresholds?"Absolute dBm":"Percentile"})]}),n.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-4 gap-4",children:[n.jsxs("div",{children:[n.jsx("span",{className:"type-micro",children:"Baseline"}),n.jsxs("span",{className:"ml-2 type-data-sm text-status-warning",children:[(null==(u=null==(d=ge.debug)?void 0:d.baselineCutoff)?void 0:u.toFixed(1))??""," dBm"]})]}),n.jsxs("div",{children:[n.jsx("span",{className:"type-micro",children:"Spike"}),n.jsxs("span",{className:"ml-2 type-data-sm text-status-warning",children:[(null==(h=null==(m=ge.debug)?void 0:m.spikeCutoff)?void 0:h.toFixed(1))??""," dBm"]})]}),n.jsxs("div",{children:[n.jsx("span",{className:"type-micro",children:"Mid-band"}),n.jsx("span",{className:"ml-2 type-data-sm text-accent-purple",children:(null==(x=ge.debug)?void 0:x.midBandSamples)??0})]}),n.jsxs("div",{children:[n.jsx("span",{className:"type-micro",children:"Anomalies"}),n.jsx("span",{className:"ml-2 type-data-sm text-status-danger",children:je.length})]})]}),n.jsxs("div",{className:"mt-4 pt-4 border-t border-border-subtle space-y-4",children:[re.useAbsoluteThresholds?n.jsxs(n.Fragment,{children:[n.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-4",children:[n.jsxs("div",{children:[n.jsxs("label",{className:"type-micro block mb-1",children:["Baseline (",re.baselineDbm," dBm)"]}),n.jsx("input",{type:"range",min:"-120",max:"-60",value:re.baselineDbm,onChange:e=>le(t=>({...t,baselineDbm:Number(e.target.value)})),className:"w-full accent-accent-purple"})]}),n.jsxs("div",{children:[n.jsxs("label",{className:"type-micro block mb-1",children:["Spike (",re.spikeDbm," dBm)"]}),n.jsx("input",{type:"range",min:"-100",max:"-20",value:re.spikeDbm,onChange:e=>le(t=>({...t,spikeDbm:Number(e.target.value)})),className:"w-full accent-accent-purple"})]}),n.jsxs("div",{children:[n.jsxs("label",{className:"type-micro block mb-1",children:["Merge Gap (",re.mergeGapSeconds,"s)"]}),n.jsx("input",{type:"range",min:"5",max:"120",step:"5",value:re.mergeGapSeconds,onChange:e=>le(t=>({...t,mergeGapSeconds:Number(e.target.value)})),className:"w-full accent-accent-purple"})]})]}),n.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-4",children:[n.jsxs("div",{children:[n.jsxs("label",{className:"type-micro block mb-1",children:["Min Sequence (",re.minSequenceLength,")"]}),n.jsx("input",{type:"range",min:"2",max:"20",value:re.minSequenceLength,onChange:e=>le(t=>({...t,minSequenceLength:Number(e.target.value)})),className:"w-full accent-accent-purple"})]}),n.jsxs("div",{children:[n.jsxs("label",{className:"type-micro block mb-1",children:["Similarity (",re.similarityToleranceDbm," dBm)"]}),n.jsx("input",{type:"range",min:"1",max:"15",value:re.similarityToleranceDbm,onChange:e=>le(t=>({...t,similarityToleranceDbm:Number(e.target.value)})),className:"w-full accent-accent-purple"})]}),n.jsxs("div",{children:[n.jsxs("label",{className:"type-micro block mb-1",children:["Opacity (",Math.round(100*ie),"%)"]}),n.jsx("input",{type:"range",min:"0.1",max:"1",step:"0.05",value:ie,onChange:e=>oe(Number(e.target.value)),className:"w-full accent-accent-purple"})]})]})]}):n.jsxs(n.Fragment,{children:[n.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-4",children:[n.jsxs("div",{children:[n.jsxs("label",{className:"type-micro block mb-1",children:["Baseline (P",re.baselinePercentile,")"]}),n.jsx("input",{type:"range",min:"1",max:"50",value:re.baselinePercentile,onChange:e=>le(t=>({...t,baselinePercentile:Number(e.target.value)})),className:"w-full accent-accent-purple"})]}),n.jsxs("div",{children:[n.jsxs("label",{className:"type-micro block mb-1",children:["Spike (P",re.spikePercentile,")"]}),n.jsx("input",{type:"range",min:"50",max:"99",value:re.spikePercentile,onChange:e=>le(t=>({...t,spikePercentile:Number(e.target.value)})),className:"w-full accent-accent-purple"})]}),n.jsxs("div",{children:[n.jsxs("label",{className:"type-micro block mb-1",children:["Merge Gap (",re.mergeGapSeconds,"s)"]}),n.jsx("input",{type:"range",min:"5",max:"120",step:"5",value:re.mergeGapSeconds,onChange:e=>le(t=>({...t,mergeGapSeconds:Number(e.target.value)})),className:"w-full accent-accent-purple"})]})]}),n.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-4",children:[n.jsxs("div",{children:[n.jsxs("label",{className:"type-micro block mb-1",children:["Min Sequence (",re.minSequenceLength,")"]}),n.jsx("input",{type:"range",min:"2",max:"20",value:re.minSequenceLength,onChange:e=>le(t=>({...t,minSequenceLength:Number(e.target.value)})),className:"w-full accent-accent-purple"})]}),n.jsxs("div",{children:[n.jsxs("label",{className:"type-micro block mb-1",children:["Similarity (",re.similarityToleranceDbm," dBm)"]}),n.jsx("input",{type:"range",min:"1",max:"15",value:re.similarityToleranceDbm,onChange:e=>le(t=>({...t,similarityToleranceDbm:Number(e.target.value)})),className:"w-full accent-accent-purple"})]}),n.jsxs("div",{children:[n.jsxs("label",{className:"type-micro block mb-1",children:["Opacity (",Math.round(100*ie),"%)"]}),n.jsx("input",{type:"range",min:"0.1",max:"1",step:"0.05",value:ie,onChange:e=>oe(Number(e.target.value)),className:"w-full accent-accent-purple"})]})]})]}),n.jsxs("div",{className:"mt-4 p-3 bg-glass-elevated rounded-lg",children:[n.jsx("div",{className:"type-micro mb-1",children:"Config output"}),n.jsxs("div",{className:"type-data-sm text-status-success",children:[re.useAbsoluteThresholds?`useAbsoluteThresholds: true, baselineDbm: ${re.baselineDbm}, spikeDbm: ${re.spikeDbm}`:`useAbsoluteThresholds: false, baselinePercentile: ${re.baselinePercentile}, spikePercentile: ${re.spikePercentile}`,", mergeGapSeconds: ",re.mergeGapSeconds,", minSequenceLength: ",re.minSequenceLength,", similarityToleranceDbm: ",re.similarityToleranceDbm]})]})]})]}),L?n.jsx(Ne,{template:"auto",children:n.jsx(fe,{className:"text-center py-12",children:n.jsx("div",{className:"animate-pulse text-text-muted",children:"Loading statistics..."})})}):n.jsxs(n.Fragment,{children:[n.jsx(Ne,{template:"hero-auto",children:n.jsxs(fe,{isLoaded:M,skeletonType:"chart",children:[n.jsx(be,{icon:n.jsx(g,{}),title:"Packet Analyzer",badge:ke.label,largeTitle:!0,actions:n.jsxs("div",{className:"flex flex-wrap items-center gap-2 justify-end",children:["stats"===V&&n.jsx(st,{enabled:te,onChange:se,anomalyCount:je.length,showTuning:ae,onTuningChange:ne}),n.jsx(at,{smoothing:V,onChange:ee}),n.jsx(tt,{mode:O,onChange:W})]})}),n.jsx("div",{className:"flex-1 min-h-0",children:n.jsx(nt,{packets:k,startTs:Te.start,endTs:Te.end,bucketCount:Se,radioConfig:me??void 0,mode:O,smoothing:V,noiseFloorAnomalies:je,showNoiseFloorOverlay:te,overlayOpacity:ie})})]})}),n.jsxs(Ne,{template:"panel",children:[n.jsx(we,{span:12,md:6,children:n.jsxs(fe,{isLoaded:M,skeletonType:"chart",children:[n.jsx(be,{icon:n.jsx(b,{}),title:"Link Quality",badge:ke.label,largeTitle:!0,actions:P?n.jsxs("div",{className:"flex items-center gap-2 sm:gap-3 type-data-xs text-text-muted",children:[n.jsxs("span",{children:[n.jsx("span",{className:"text-text-secondary tabular-nums font-medium",children:P.zeroHopCount})," nbr"]}),n.jsxs("span",{children:[n.jsx("span",{className:"text-text-secondary tabular-nums font-medium",children:P.totalCount})," obs"]}),n.jsxs("span",{children:[n.jsx("span",{className:"text-text-secondary tabular-nums font-medium",children:P.maxDistanceKm.toFixed(0)})," km"]})]}):null}),n.jsx("div",{className:"flex-1 min-h-0",children:n.jsx(ft,{children:n.jsx(ut,{neighbors:Ce,quickNeighbors:w,localLat:(null==(f=null==(p=null==j?void 0:j.config)?void 0:p.repeater)?void 0:f.latitude)??0,localLon:(null==(v=null==(y=null==j?void 0:j.config)?void 0:y.repeater)?void 0:v.longitude)??0,onStatsChange:D})})})]})}),n.jsx(we,{span:12,md:6,children:n.jsxs(fe,{isLoaded:M,skeletonType:"chart",children:[n.jsx(be,{icon:n.jsx(F,{}),title:"Network Composition",badge:ke.label,largeTitle:!0}),n.jsx("div",{className:"flex-1 min-h-0",children:n.jsx(ft,{children:n.jsx(gt,{neighbors:Ce})})})]})})]}),n.jsxs(Ne,{template:"panel",children:[n.jsx(we,{span:12,md:6,children:n.jsx(jt,{})}),n.jsx(we,{span:12,md:6,children:n.jsx(wt,{})})]}),n.jsx(Ne,{template:"panel",children:n.jsx(we,{span:12,children:n.jsxs(fe,{isLoaded:M,skeletonType:"chart",children:[n.jsx(be,{icon:n.jsx(R,{}),title:"RF Noise Floor",largeTitle:!0,actions:T?n.jsxs("div",{className:"flex items-center gap-1.5 sm:gap-2 md:gap-3",children:[n.jsxs("span",{className:"type-data-xs text-text-muted whitespace-nowrap",children:["min ",n.jsx("span",{className:"text-text-secondary tabular-nums",children:T.min.toFixed(0)})]}),n.jsxs("span",{className:"type-data-xs text-text-muted whitespace-nowrap",children:["avg ",n.jsx("span",{className:"text-text-secondary tabular-nums",children:T.avg.toFixed(0)})]}),n.jsxs("span",{className:"type-data-xs text-text-muted whitespace-nowrap",children:["max ",n.jsx("span",{className:"text-text-secondary tabular-nums",children:T.max.toFixed(0)})]}),n.jsx("span",{className:"type-data-xs text-text-muted",children:"dBm"})]}):n.jsx("span",{className:"type-data-xs text-text-muted",children:"dBm"})}),n.jsx("div",{className:"flex-1 min-h-0",children:n.jsx(ft,{children:n.jsx(ht,{timestamps:pe.timestamps,values:pe.values,onStatsChange:$})})})]})})})]})]})}export{Tt as default};
