import{j as e,W as s,c as t,Z as a,M as n,r as l}from"./vendor-react-j_fHog8x.js";import{a as i,P as r,b as c,B as o}from"./PageLayout-BbUZPUXO.js";import{R as d,C as m}from"./Grid-OFJ4oe0a.js";import{c as x,cl as u,b2 as p,R as h,K as g,cv as j,N as f,e as y,I as v,cw as N,B as b,aj as k,O as C,f as w,cx as _,cy as S,cz as F,cA as M,cB as A,cC as T,cD as R,cE as D,cF as E,n as $,cp as L,aA as I}from"./index-BXGLLJB2.js";import{L as z,a as P,b as B}from"./listbox-BN6ZK80U.js";import{P as O,T as K,C as U}from"./ConfirmModal-CjDLUxOY.js";import{M as q}from"./map-pin-D8b3pTeJ.js";import{S as H,C as G,e as V,g as W,a as J,M as Q}from"./ChatBubble-DoXwEwwz.js";import{C as Y}from"./Card-BhfXmsl8.js";import{K as Z}from"./key-round-BtUstcjc.js";import{C as X}from"./copy-gotHysUv.js";import{U as ee}from"./users-u3MX8Xwj.js";import"./maplibre-gl-b91ci4Kr.js";import"./vendor-core-CDNU4oKM.js";import"./config-CTM8_93T.js";import"./triangle-alert-jtl14R73.js";const se=x("message-circle",[["path",{d:"M2.992 16.342a2 2 0 0 1 .094 1.167l-1.065 3.29a1 1 0 0 0 1.236 1.168l3.413-.998a2 2 0 0 1 1.099.092 10 10 0 1 0-4.777-4.719",key:"1sd12s"}]]),te=x("message-square-plus",[["path",{d:"M22 17a2 2 0 0 1-2 2H6.828a2 2 0 0 0-1.414.586l-2.202 2.202A.71.71 0 0 1 2 21.286V5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2z",key:"18887p"}],["path",{d:"M12 8v6",key:"1ib9pf"}],["path",{d:"M9 11h6",key:"1fldmi"}]]),ae=x("repeat",[["path",{d:"m17 2 4 4-4 4",key:"nntrym"}],["path",{d:"M3 11v-1a4 4 0 0 1 4-4h14",key:"84bu3i"}],["path",{d:"m7 22-4-4 4-4",key:"1wqhfi"}],["path",{d:"M21 13v1a4 4 0 0 1-4 4H3",key:"1rx37r"}]]),ne=x("terminal",[["path",{d:"M12 19h8",key:"baeox8"}],["path",{d:"m4 17 6-6-6-6",key:"1yngyt"}]]),le=x("user-x",[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["line",{x1:"17",x2:"22",y1:"8",y2:"13",key:"3nzzx3"}],["line",{x1:"22",x2:"17",y1:"8",y2:"13",key:"1swrse"}]]);function ie({disabled:a,className:n,children:l}){return e.jsx(s,{disabled:a,className:t("flex flex-col gap-2",n),children:l})}function re({required:s,className:n,children:l,...i}){return e.jsxs(a,{className:t("text-sm font-medium text-text-primary select-none","data-[disabled]:opacity-50",i.title&&"cursor-help",n),...i,children:[l,s&&e.jsx("span",{className:"text-accent-danger ml-0.5","aria-hidden":"true",children:"*"})]})}function ce({className:s,children:a,...l}){return e.jsx(n,{className:t("text-sm text-text-muted","data-[disabled]:opacity-50",s),...l,children:a})}function oe({icon:s,title:a,description:n,onClick:l,accent:i}){return e.jsxs("button",{onClick:l,className:t("flex flex-col items-center gap-3 p-6 rounded-2xl text-center","ring-1 ring-border-subtle hover:ring-2 transition-all duration-150","w-full max-w-[260px]","primary"===i?"hover:ring-accent-primary hover:bg-accent-primary/5":"hover:ring-accent-secondary hover:bg-accent-secondary/5"),children:[e.jsx("div",{className:t("p-3 rounded-xl","primary"===i?"bg-accent-primary/10 text-accent-primary":"bg-accent-secondary/10 text-accent-secondary"),children:s}),e.jsx("p",{className:"type-body-sm font-medium text-text-primary",children:a}),e.jsx("p",{className:"type-data-xs text-text-muted leading-relaxed",children:n})]})}function de({onCreateRoom:s}){return e.jsxs("div",{className:"flex flex-col items-center justify-center py-16 px-4",children:[e.jsx(p,{className:"w-12 h-12 text-text-muted opacity-30 mb-4"}),e.jsx("p",{className:"type-subheading text-text-secondary mb-1",children:"Add a Room Server"}),e.jsx("p",{className:"type-body-sm text-text-muted mb-8",children:"Choose how this device should operate."}),e.jsxs("div",{className:"flex flex-col sm:flex-row items-center gap-4",children:[e.jsx(oe,{icon:e.jsx(ae,{className:"w-6 h-6"}),title:"Repeater + Room Server",description:"Keep forwarding packets and add group messaging.",onClick:()=>s("hybrid"),accent:"primary"}),e.jsx(oe,{icon:e.jsx(h,{className:"w-6 h-6"}),title:"Dedicated Room Server",description:"Stop repeating. Focus entirely on room server duties.",onClick:()=>s("dedicated"),accent:"secondary"})]})]})}function me({rooms:s,selected:a,onSelect:n,onAdd:l}){const i=l?e.jsx("button",{onClick:l,className:t("flex items-center justify-center px-2 py-1 rounded-md","text-text-muted hover:text-text-primary hover:bg-bg-surface/60","transition-all duration-150"),title:"Add room server",children:e.jsx(O,{className:"w-4 h-4"})}):null;return s.length<=1?i:s.length<=3?e.jsxs("div",{className:"flex items-center gap-0.5 p-0.5 rounded-lg bg-subtle-fill",children:[s.map(s=>e.jsx("button",{onClick:()=>n(s.room_name),className:t("px-3 py-1 rounded-md text-sm font-medium transition-all duration-150",s.room_name===a?"bg-bg-surface text-text-primary shadow-sm":"text-text-muted hover:text-text-secondary"),children:s.room_name},s.room_name)),i]}):e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(z,{value:a??"",onChange:n,children:s.map(s=>e.jsx(P,{value:s.room_name,children:e.jsx(B,{children:s.room_name})},s.room_name))}),i]})}function xe({open:s,onClose:t,mode:a,identity:n,repeaterConfig:i,onCreate:r,onUpdate:c,onDelete:o,onSendAdvert:d}){var m,x,u,p,h,C,w,_,S;const F="edit"===a&&n,M=`${s}-${(null==n?void 0:n.name)??""}-${a}`,[A,T]=l.useState(""),[R,D]=l.useState(""),[E,$]=l.useState(!1),[L,I]=l.useState(""),[z,P]=l.useState(""),[B,O]=l.useState(""),[U,H]=l.useState(""),[G,V]=l.useState(!1),[W,J]=l.useState(!1),[Q,Y]=l.useState(!1),[Z,X]=l.useState(null),[ee,se]=l.useState(M);if(M!==ee)if(se(M),X(null),V(!1),J(!1),Y(!1),F)T((null==(m=n.settings)?void 0:m.node_name)??n.name),D(n.identity_key??""),$(!1),I((null==(x=n.settings)?void 0:x.admin_password)??""),P((null==(u=n.settings)?void 0:u.guest_password)??""),O((null==(h=null==(p=n.settings)?void 0:p.latitude)?void 0:h.toString())??""),H((null==(w=null==(C=n.settings)?void 0:C.longitude)?void 0:w.toString())??"");else{const e=i;T(""),D(""),$(!1),I(""),P(""),O(null!=(null==(_=null==e?void 0:e.repeater)?void 0:_.latitude)?e.repeater.latitude.toString():""),H(null!=(null==(S=null==e?void 0:e.repeater)?void 0:S.longitude)?e.repeater.longitude.toString():"")}const ae=l.useCallback(()=>{const e={};return A&&(e.node_name=A),L&&(e.admin_password=L),z&&(e.guest_password=z),""!==B&&(e.latitude=parseFloat(B)),""!==U&&(e.longitude=parseFloat(U)),e},[A,L,z,B,U]),ne=l.useCallback(async()=>{if(!A.trim())return void X("Room name is required");V(!0),X(null);const e=F?n.name:function(e){if(!e)return"";const s=e.trim().toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-|-$/g,"");return s?`${s}-room`:""}(A);let s;if(F)s=await c({name:n.name,settings:ae()});else{const t={name:e,type:"room_server",settings:ae()};R.trim()&&(t.identity_key=R.trim()),s=await r(t)}V(!1),s?t():X("Failed to save. Check that the name is unique and passwords differ.")},[A,F,n,ae,r,c,t]),le=l.useCallback(async()=>{if(!F)return;J(!0);const e=await o(n.name);J(!1),e&&t()},[F,n,o,t]),oe=l.useCallback(async()=>{F&&(Y(!0),await d(n.name),Y(!1))},[F,n,d]);return e.jsxs(g,{open:s,onClose:t,size:"md",children:[e.jsx(j,{icon:F?void 0:e.jsx(te,{className:"w-5 h-5"}),title:F?"Edit Room Server":"Add Room Server"}),e.jsx(f,{children:e.jsxs("div",{className:"space-y-5",children:[F&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(y,{color:n.registered?"green":"red",children:n.registered?"Active":"Inactive"}),n.identity_key&&e.jsxs("span",{className:"type-data-xs text-text-muted truncate",title:n.identity_key,children:["Key: ",n.identity_key.slice(0,16),"…"]})]}),e.jsxs(ie,{children:[e.jsx(re,{title:"What people see on the mesh",children:"Room Name"}),e.jsx(v,{value:A,onChange:e=>T(e.target.value),placeholder:"Room Name"})]}),!F&&e.jsxs(ie,{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(re,{title:"The unique hex public ID",children:["Identity Key ",e.jsx("span",{className:"text-text-muted font-normal",children:"(Optional)"})]}),e.jsx("button",{type:"button",onClick:()=>$(e=>!e),className:"type-data-xs text-text-muted underline hover:text-text-secondary",children:E?"Hide":"Show"})]}),E&&e.jsxs(e.Fragment,{children:[e.jsx(v,{value:R,onChange:e=>D(e.target.value),placeholder:"Leave empty to auto-generate"}),e.jsx(ce,{children:"Leave empty to automatically generate a secure key"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs(ie,{children:[e.jsxs(re,{children:[e.jsx(q,{className:"inline w-3.5 h-3.5 -mt-0.5 mr-1 text-text-muted"}),"Latitude"]}),e.jsx(v,{type:"number",step:"any",value:B,onChange:e=>O(e.target.value),placeholder:"0"})]}),e.jsxs(ie,{children:[e.jsxs(re,{children:[e.jsx(q,{className:"inline w-3.5 h-3.5 -mt-0.5 mr-1 text-text-muted"}),"Longitude"]}),e.jsx(v,{type:"number",step:"any",value:U,onChange:e=>H(e.target.value),placeholder:"0"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs(ie,{children:[e.jsxs(re,{title:"Full access to room server",children:["Admin Password ",e.jsx("span",{className:"text-text-muted font-normal",children:"(Optional)"})]}),e.jsx(v,{type:"password",value:L,onChange:e=>I(e.target.value),placeholder:"None Set"})]}),e.jsxs(ie,{children:[e.jsxs(re,{title:"Can post and read, but not administer the room",children:["Guest Password ",e.jsx("span",{className:"text-text-muted font-normal",children:"(Optional)"})]}),e.jsx(v,{type:"password",value:z,onChange:e=>P(e.target.value),placeholder:"None Set"})]})]}),Z&&e.jsx("p",{className:"type-data-xs text-accent-danger",children:Z})]})}),e.jsxs(N,{children:[F&&e.jsxs("div",{className:"flex items-center gap-2 mr-auto",children:[e.jsxs(b,{color:"danger",plain:!0,onClick:le,disabled:W,children:[e.jsx(K,{"data-slot":"icon"}),W?"Deleting…":"Delete"]}),e.jsxs(b,{color:"primary",plain:!0,onClick:oe,disabled:Q,children:[e.jsx(k,{"data-slot":"icon"}),Q?"Sending…":"Send Advert"]})]}),e.jsx(b,{plain:!0,onClick:t,children:"Cancel"}),e.jsx(b,{color:"primary",onClick:ne,disabled:G,children:G?"Saving…":F?"Save Changes":"Create"})]})]})}const ue=l.createContext(null),pe="room-tui";function he({children:s}){const[t,a]=l.useState(()=>"1"===localStorage.getItem(pe)),n=l.useCallback(()=>{a(e=>{const s=!e;return localStorage.setItem(pe,s?"1":"0"),s})},[]);return e.jsx(ue.Provider,{value:{terminalMode:t,toggleTerminalMode:n},children:s})}function ge(){const e=l.useContext(ue);if(!e)throw new Error("useTerminalMode must be used within RoomTerminalProvider");return e}const je={a:"24,3 76,3 83,7 76,11 24,11 17,7",b:"88,22 93,27 93,71 88,76 83,71 83,27",c:"88,106 93,111 93,155 88,160 83,155 83,111",d:"24,171 76,171 83,175 76,179 24,179 17,175",e:"12,106 17,111 17,155 12,160 7,155 7,111",f:"12,22 17,27 17,71 12,76 7,71 7,27",g:"24,86 76,86 83,91 76,96 24,96 17,91"},fe=Object.keys(je),ye={0:"abcdef",1:"bc",2:"abdeg",3:"abcdg",4:"bcfg",5:"acdfg",6:"acdefg",7:"abc",8:"abcdefg",9:"abcdfg",A:"abcefg",B:"cdefg",C:"adef",D:"bcdeg",E:"adefg",F:"aefg",G:"acdef",H:"bcefg",I:"ef",J:"bcde",L:"def",M:"abcefg",N:"ceg",O:"abcdef",P:"abefg",Q:"abcfg",R:"eg",S:"acdfg",T:"defg",U:"bcdef",Y:"bcdfg",Z:"abdeg",a:"abcefg",b:"cdefg",c:"deg",d:"bcdeg",e:"adefg",f:"aefg",g:"abcdfg",h:"cefg",i:"c",j:"bcde",l:"def",m:"abcef",n:"ceg",o:"cdeg",p:"abefg",r:"eg",s:"acdfg",t:"defg",u:"cde",v:"cde",y:"bcdfg"," ":"",_:"d","-":"g","=":"dg","°":"abfg",'"':"bf","'":"f","(":"adef",")":"abcd","[":"adef","]":"abcd"};function ve(e,s){const t=Array.from(e).map(e=>ye[e.toUpperCase()]??ye[e]??""),a=Math.max(0,(s??0)-e.length);for(let n=0;n<a;n++)t.push("");return t}function Ne({text:s,color:t="#FF8C00",size:a=18,minChars:n,noCycle:i=!1,className:r}){const c=Math.round(a*(100/182)),[o,d]=l.useState(null);l.useEffect(()=>{if(i)return;const e=ve(s,n),t=6+2*(e.length-1);let a,l=0,r=!1;const c=()=>{r||(l++,l>=t?d(null):(d(e.map((e,s)=>l>=6+2*s?e:fe.filter(()=>Math.random()>.45).join(""))),a=setTimeout(c,56)))};return c(),()=>{r=!0,clearTimeout(a)}},[s,n,i]);const m=ve(s,n),x=o??m;return e.jsxs("span",{className:"seven-seg"+(r?` ${r}`:""),children:[x.map((s,n)=>((s,n)=>e.jsx("svg",{viewBox:"0 0 100 182",width:c,height:a,className:"seven-seg__char","aria-hidden":"true",children:fe.map(a=>e.jsx("polygon",{points:je[a],fill:t,stroke:t,strokeWidth:4,strokeLinejoin:"round",opacity:s.includes(a)?1:.16},a))},n))(s,`${n}-${s}`)),e.jsx("span",{className:"sr-only",children:s})]})}function be({icon:s,onClick:t,title:a,iconColor:n="#000000",iconActiveColor:i="#FFDEB0",disabled:r=!1,className:c,keycapSrc:o="/assets/keycap.svg"}){const[d,m]=l.useState(!1),x=l.useCallback(()=>{r||m(!0)},[r]),u=l.useCallback(()=>{d&&(m(!1),t())},[d,t]),p=l.useCallback(()=>{m(!1)},[]);return e.jsx("button",{onMouseDown:x,onMouseUp:u,onMouseLeave:p,onTouchStart:x,onTouchEnd:u,onTouchCancel:p,disabled:r,className:`keycap-btn${d?" keycap-btn--pressed":""}${c?` ${c}`:""}`,title:a,children:e.jsxs("div",{className:"keycap-wrap",children:[e.jsx("img",{src:o,alt:"",className:"keycap-btn__img",draggable:!1}),e.jsx("span",{className:"keycap-icon-overlay",style:{color:d?i:n},children:s})]})})}const ke=e=>"server"===e.author_pubkey||"system"===e.author_pubkey;function Ce({messages:s,onDelete:t,terminalMode:a,serverName:n}){const i=l.useRef(null),[r,c]=l.useState(!1),o=l.useMemo(()=>[...s].sort((e,s)=>e.post_timestamp-s.post_timestamp),[s]);l.useEffect(()=>{!r&&i.current&&(i.current.scrollTop=0)},[o.length,r]);const d=l.useCallback(()=>{i.current&&c(i.current.scrollTop<-100)},[]),m=l.useCallback(()=>{i.current&&i.current.scrollTo({top:0,behavior:"smooth"}),c(!1)},[]);return 0===o.length?e.jsx("div",{className:"flex-1 flex flex-col items-center justify-center py-12 min-h-0"+(a?" font-mono":""),children:a?e.jsx("p",{className:"text-[#FF8C00]/40 text-sm font-mono",children:"> no messages in buffer_"}):e.jsxs(e.Fragment,{children:[e.jsx(p,{className:"w-10 h-10 text-text-muted opacity-20 mb-2"}),e.jsx("p",{className:"type-data-sm text-text-muted",children:"No messages yet"})]})}):a?e.jsxs("div",{className:"relative flex-1 min-h-0",children:[e.jsx("div",{ref:i,onScroll:d,className:"h-full overflow-y-auto scroll-smooth p-4 font-mono text-sm leading-relaxed flex flex-col-reverse",children:e.jsx("div",{children:o.map(s=>{const a=ke(s),l=new Date(1e3*s.post_timestamp).toLocaleTimeString(void 0,{hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}),i=a?"SYS":s.author_name||s.author_prefix,r=!a&&n&&i===n;return e.jsxs("div",{className:"group flex items-start gap-0 -mx-4 px-4 py-px hover:bg-[#1a1f2e] hover:shadow-[inset_2px_0_0_#3b82f6]",children:[e.jsxs("span",{className:"select-none shrink-0 text-[#666]",children:["[",l,"]"]}),e.jsxs("span",{className:"mx-1.5 shrink-0",children:[e.jsx("span",{className:r?"text-[#3B82F6]":"text-[#FF8C00]",children:"<"}),e.jsx("span",{className:r?"text-[#3B82F6]":"text-[#FF8C00]",children:i}),e.jsx("span",{className:r?"text-[#3B82F6]":"text-[#FF8C00]",children:">"})]}),e.jsx("span",{className:a?"text-[#888] italic":r?"text-white":"text-[#FF8C00]",children:s.message_text}),e.jsx("button",{onClick:()=>t(s.id),className:"opacity-0 group-hover:opacity-100 ml-auto pl-2 text-[#666] hover:text-[#E5484D] shrink-0",title:"Delete",children:"×"})]},s.id)})})}),r&&e.jsxs("button",{onClick:m,className:"absolute bottom-3 left-1/2 -translate-x-1/2 flex items-center gap-1.5 px-3 py-1 font-mono text-xs bg-[#1a1a1a] border border-[#333] text-[#FF8C00] hover:bg-[#222] transition-colors duration-150",children:[e.jsx(C,{className:"w-3 h-3"}),"↓ scroll"]})]}):e.jsxs("div",{className:"relative flex-1 min-h-0",children:[e.jsx("div",{ref:i,onScroll:d,className:"h-full overflow-y-auto scroll-smooth flex flex-col-reverse",children:e.jsx("div",{className:"space-y-3 p-4",children:o.map(s=>ke(s)?e.jsx(H,{text:s.message_text},s.id):e.jsx(G,{senderName:s.author_name||s.author_prefix,text:s.message_text,timestamp:s.post_timestamp,bubbleAccessory:e.jsx("button",{onClick:()=>t(s.id),className:"opacity-0 group-hover:opacity-100 transition-opacity duration-150 p-1 text-text-muted hover:text-accent-danger flex-shrink-0",title:"Delete message",children:e.jsx(K,{className:"w-3.5 h-3.5"})})},s.id))})}),r&&e.jsxs("button",{onClick:m,className:"absolute bottom-3 left-1/2 -translate-x-1/2 flex items-center gap-1.5 px-3 py-1.5 rounded-full bg-bg-surface/90 backdrop-blur-sm ring-1 ring-border-subtle shadow-md text-text-secondary hover:text-text-primary transition-colors duration-150",children:[e.jsx(C,{className:"w-3.5 h-3.5"}),e.jsx("span",{className:"type-data-xs",children:"New messages"})]})]})}function we({roomName:s,onSend:t,disabled:a,terminalMode:n}){const[i,r]=l.useState(""),[c,o]=l.useState(!1),d=l.useRef(null),m=l.useCallback(async()=>{var e;const s=i.trim();if(!s||c)return;o(!0);const a=await t(s);o(!1),a&&(r(""),null==(e=d.current)||e.focus())},[i,c,t]),x=l.useCallback(e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),m())},[m]);return n?e.jsxs("div",{className:"flex items-center gap-0 px-4 py-2 font-mono text-sm",children:[e.jsx("input",{ref:d,type:"text",value:i,onChange:e=>r(e.target.value),onKeyDown:x,placeholder:"type message...",disabled:a||c,className:"flex-1 bg-transparent text-white placeholder:text-[#666] outline-none ring-0 shadow-none border-none focus:outline-none focus:ring-0 font-mono"}),e.jsx("button",{onClick:m,disabled:!i.trim()||c||a,className:"text-[#FF8C00] disabled:text-[#333] hover:text-[#FFA540] transition-colors duration-100 px-1 font-mono text-xs",title:"Send",children:"[↵]"})]}):e.jsxs("div",{className:"flex items-center gap-2 p-3 border-t border-border-subtle",children:[e.jsx("input",{ref:d,type:"text",value:i,onChange:e=>r(e.target.value),onKeyDown:x,placeholder:`Message ${s}…`,disabled:a||c,className:"flex-1 surface-input radius-inner px-3 py-2 type-body-sm text-text-primary placeholder:text-text-muted outline-none ring-focus"}),e.jsx("button",{onClick:m,disabled:!i.trim()||c||a,className:"p-2 rounded-lg text-accent-primary hover:bg-accent-primary/10 disabled:opacity-30 disabled:hover:bg-transparent transition-colors duration-150",title:"Send message",children:e.jsx(k,{className:"w-4.5 h-4.5"})})]})}function _e({selectedName:s,selectedIdentity:t,messages:a,onSend:n,onDelete:r,onClear:c}){var o;const{terminalMode:d,toggleTerminalMode:m}=ge(),[x,u]=l.useState(!1),p=(null==(o=null==t?void 0:t.settings)?void 0:o.node_name)??s??void 0,h=l.useCallback(()=>{u(!1),c()},[c]);return d?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex flex-col h-full gap-1.5",children:[e.jsxs("div",{className:"card-terminal-header flex-shrink-0",children:[e.jsx("span",{className:"seven-seg-panel",children:e.jsx(Ne,{text:"chat",minChars:7,size:24})}),e.jsx("div",{className:"card-terminal-ridge flex-1"}),e.jsxs("div",{className:"keycap-well keycap-well--rounded flex items-center gap-1",children:[e.jsx(be,{icon:e.jsx(ne,{className:"!w-4.5 !h-4.5"}),onClick:m,title:"Exit terminal mode"}),a.length>0&&e.jsx(be,{icon:e.jsx(K,{className:"!w-4 !h-4"}),onClick:()=>u(!0),title:"Clear all messages",iconActiveColor:"#E5484D",keycapSrc:"/assets/keycap-red.svg"})]})]}),e.jsx(i,{noPadding:!0,className:"flex flex-col flex-1 min-h-0 overflow-hidden card-terminal",children:e.jsxs("div",{className:"card-terminal-well flex-1 min-h-0 flex flex-col overflow-hidden",children:[e.jsx(Ce,{messages:a,onDelete:r,terminalMode:!0,serverName:p}),e.jsx("div",{className:"card-terminal-divider"}),s&&e.jsx(we,{roomName:s,onSend:n,disabled:!(null==t?void 0:t.registered),terminalMode:!0})]})})]}),e.jsx(U,{isOpen:x,title:"Clear All Messages",message:`This will permanently delete all ${a.length} message${1===a.length?"":"s"} from this room. This cannot be undone.`,confirmLabel:"Clear Messages",variant:"danger",onConfirm:h,onCancel:()=>u(!1)})]}):e.jsxs(e.Fragment,{children:[e.jsxs(i,{noPadding:!0,className:"flex flex-col h-full overflow-hidden",children:[e.jsx(Y,{listHeader:!0,icon:e.jsx(se,{className:"icon-sm"}),title:"Messages",actions:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(b,{plain:!0,onClick:m,title:"Terminal mode",children:e.jsx(ne,{"data-slot":"icon",className:"!w-4 !h-4"})}),a.length>0&&e.jsx(b,{plain:!0,color:"danger",onClick:()=>u(!0),title:"Clear all messages",children:e.jsx(K,{"data-slot":"icon",className:"!w-4 !h-4"})})]})}),e.jsx(Ce,{messages:a,onDelete:r,terminalMode:!1,serverName:p}),s&&e.jsx(we,{roomName:s,onSend:n,disabled:!(null==t?void 0:t.registered),terminalMode:!1})]}),e.jsx(U,{isOpen:x,title:"Clear All Messages",message:`This will permanently delete all ${a.length} message${1===a.length?"":"s"} from this room. This cannot be undone.`,confirmLabel:"Clear Messages",variant:"danger",onConfirm:h,onCancel:()=>u(!1)})]})}function Se({state:s}){const t="held"===s?"#FFDEB0":"#000000",a="sent"===s?"keycap-wifi-blink-all":void 0;return e.jsxs("svg",{className:"keycap-wifi"+("sending"===s||"sent"===s?" keycap-wifi--active":""),viewBox:"0 0 24 24",fill:"none",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M12 20h.01",stroke:t,className:a}),e.jsx("path",{d:"M8.5 16.429a5 5 0 0 1 7 0",stroke:t,className:"sending"===s?"keycap-wifi-arc keycap-wifi-arc-1":a}),e.jsx("path",{d:"M5 12.859a10 10 0 0 1 14 0",stroke:t,className:"sending"===s?"keycap-wifi-arc keycap-wifi-arc-2":a}),e.jsx("path",{d:"M2 8.82a15 15 0 0 1 20 0",stroke:t,className:"sending"===s?"keycap-wifi-arc keycap-wifi-arc-3":a})]})}function Fe({name:s,onSend:t,isActive:a=!1}){const[n,i]=l.useState("idle"),r="held"===n,c="sending"===n||"sent"===n,o=l.useRef(),d=l.useCallback(()=>{c||i("held")},[c]),m=l.useCallback(async()=>{if("held"!==n)return;i("sending");const e=await t(s);i(e?"sent":"idle"),e&&(o.current=setTimeout(()=>i("idle"),2e3))},[s,t,n]),x=l.useCallback(()=>{"held"===n&&i("idle")},[n]);return l.useEffect(()=>()=>clearTimeout(o.current),[]),e.jsxs("div",{className:"keycap-group",children:[e.jsx("button",{onMouseDown:d,onMouseUp:m,onMouseLeave:x,onTouchStart:d,onTouchEnd:m,onTouchCancel:x,disabled:c,className:"keycap-btn"+(r||"sending"===n?" keycap-btn--pressed":""),title:"Send room server advert",children:e.jsx("div",{className:"keycap-well keycap-well--rounded",children:e.jsxs("div",{className:"keycap-wrap",children:[e.jsx("img",{src:"/assets/keycap.svg",alt:"",className:"keycap-btn__img",draggable:!1}),e.jsx(Se,{state:n})]})})}),e.jsx("div",{className:"keycap-well keycap-well--fill",children:e.jsxs("div",{className:"indicator-key-pair",children:[e.jsxs("div",{className:`indicator-key indicator-key--${n}`,children:[e.jsx("span",{className:"indicator-key__label",children:"ADVERTISE"}),e.jsx("span",{className:"indicator-key__led"})]}),e.jsxs("div",{className:"indicator-key"+(a?" indicator-key--active":""),children:[e.jsx("span",{className:"indicator-key__label",children:"ACTIVE"}),e.jsx("span",{className:"indicator-key__led"})]})]})})]})}function Me({pubkey:s,className:t}){const[a,n]=l.useState(!1),i=l.useCallback(()=>{navigator.clipboard.writeText(s),n(!0),setTimeout(()=>n(!1),1500)},[s]);return e.jsxs("button",{onClick:i,title:a?"Copied!":"Copy public key",className:`inline-flex items-center gap-1 font-mono text-[10px] leading-tight text-text-muted hover:text-text-secondary transition-colors duration-150 cursor-copy ${t??""}`,children:[e.jsx("span",{className:"truncate min-w-0",children:s.slice(0,8)}),a&&e.jsx(w,{className:"w-2.5 h-2.5 text-accent-success flex-shrink-0"})]})}const Ae=l.memo(function({client:s,resolvedName:a,onRemove:n}){const l=s.name||a,i=0===s.unsynced_count,r=s.last_activity?new Date(1e3*s.last_activity).toLocaleString(void 0,{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}):"Never",{emoji:c,cleanName:o}=l?V(l):{emoji:null,cleanName:s.pubkey_prefix},d=l?W(o):void 0,m=l?J(l):s.pubkey_prefix.slice(0,2).toUpperCase();return e.jsxs("div",{className:"group flex items-center gap-3 px-3 py-2.5 radius-inner row-hover transition-base",children:[e.jsxs("div",{className:"relative flex-shrink-0",children:[e.jsx("div",{className:t("w-8 h-8 rounded-full flex items-center justify-center",!d&&"bg-accent-primary/12"),style:d?{backgroundColor:d}:void 0,children:c?e.jsx("span",{className:"text-base leading-none",children:c}):e.jsx("span",{className:t("leading-none",d?"text-white text-[11px] font-bold tracking-tight":"text-accent-primary font-mono text-[11px]"),children:m})}),e.jsx("span",{className:"absolute -bottom-0.5 -right-0.5 w-2.5 h-2.5 rounded-sm ring-2 ring-bg-surface "+(i?"bg-accent-success":"bg-accent-secondary")})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[l?e.jsx("p",{className:"text-[13px] font-medium leading-tight text-text-primary truncate",children:l}):e.jsx("p",{className:"font-mono text-[13px] leading-tight text-text-primary truncate",children:s.pubkey_prefix}),e.jsxs("div",{className:"flex items-center gap-1.5 mt-0.5",children:[l&&e.jsx(Me,{pubkey:s.pubkey}),l&&e.jsx("span",{className:"text-[10px] text-text-muted/40",children:"·"}),e.jsxs("span",{className:"text-[10px] leading-tight text-text-muted truncate",children:[!i&&e.jsxs("span",{className:"text-accent-secondary",children:[s.unsynced_count," unsynced · "]}),r]})]})]}),e.jsx("button",{onClick:()=>n(s.pubkey),className:"opacity-0 group-hover:opacity-100 transition-opacity duration-150 p-1.5 -mr-1 rounded-md text-text-muted hover:text-accent-danger hover:bg-accent-danger/8",title:"Remove client",children:e.jsx(le,{className:"w-3.5 h-3.5"})})]})});function Te({clients:s,onRemove:t,messages:a,terminalMode:n}){const i=l.useMemo(()=>{const e=new Map;if(!a)return e;for(let s=a.length-1;s>=0;s--){const t=a[s];t.author_name&&t.author_pubkey&&"server"!==t.author_pubkey&&"system"!==t.author_pubkey&&e.set(t.author_pubkey,t.author_name)}return e},[a]);return 0===s.length?n?e.jsx("p",{className:"text-[#FF8C00] font-mono text-sm text-left px-4 py-4",children:"<NO CLIENTS CONNECTED>"}):e.jsx("p",{className:"type-data-xs text-text-muted text-center py-4",children:"No clients connected"}):n?e.jsx("div",{className:"font-mono text-sm pt-2",children:s.map(s=>{const a=s.name||i.get(s.pubkey),n=0===s.unsynced_count,l=s.pubkey_prefix;return e.jsxs("div",{className:"group flex items-center gap-0 -mx-0 px-4 py-0.5 hover:bg-[#1a1f2e] hover:shadow-[inset_2px_0_0_#3b82f6]",children:[e.jsx("span",{className:n?"text-[#FF8C00]":"text-[#f59e0b]",children:"■"}),e.jsx("span",{className:"text-[#FF8C00] ml-2 shrink-0",children:a||l}),a&&e.jsxs("span",{className:"text-[#FF8C00] ml-1.5 shrink-0",children:["[",l,"]"]}),!n&&e.jsxs("span",{className:"text-[#f59e0b] ml-1.5",children:[s.unsynced_count,"unsync"]}),e.jsx("button",{onClick:()=>t(s.pubkey),className:"opacity-0 group-hover:opacity-100 ml-auto pl-2 text-[#666] hover:text-[#E5484D] shrink-0",title:"Remove",children:"×"})]},s.pubkey)})}):e.jsx("div",{className:"space-y-0.5 pt-1",children:s.map(s=>e.jsx(Ae,{client:s,resolvedName:i.get(s.pubkey),onRemove:t},s.pubkey))})}function Re({name:s,onSend:t}){const{terminalMode:a}=ge(),[n,i]=l.useState("idle"),r=l.useRef(),c=l.useCallback(async()=>{if("sending"===n)return;i("sending");const e=await t(s);i(e?"sent":"idle"),e&&(r.current=setTimeout(()=>i("idle"),2e3))},[s,t,n]);return l.useEffect(()=>()=>clearTimeout(r.current),[]),a?e.jsxs("button",{className:"btn-terminal",onClick:c,disabled:"sending"===n,children:["idle"===n&&"[ send_advert ]","sending"===n&&"[ broadcasting... ]","sent"===n&&"[ sent ✓ ]"]}):e.jsxs(b,{color:"sent"===n?"success":"primary",className:"w-full",onClick:c,disabled:"sending"===n,children:[e.jsx(k,{"data-slot":"icon"}),"idle"===n&&"Send Advert","sending"===n&&"Broadcasting…","sent"===n&&"Advert Sent"]})}function De({identity:s,onSendAdvert:t}){var a,n,i,r,c,o,d,m,x,u,p,h,g,j,f,v,N,b,k,C,_,S,F,M,A,T,R,D,E,$;const{terminalMode:L}=ge(),[I,z]=l.useState(!1),P=l.useCallback(()=>{(null==s?void 0:s.identity_key)&&(navigator.clipboard.writeText(s.identity_key),z(!0),setTimeout(()=>z(!1),1500))},[null==s?void 0:s.identity_key]);return L?s?e.jsxs("div",{className:"space-y-1",children:[(null==(a=s.settings)?void 0:a.node_name)&&e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-[#666]",children:"node"}),e.jsx("span",{className:"text-[#FF8C00]",children:s.settings.node_name})]}),(s.address||(null==(n=s.runtime)?void 0:n.address))&&e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-[#666]",children:"addr"}),e.jsx("span",{className:"text-[#FF8C00]",children:s.address||(null==(i=s.runtime)?void 0:i.address)})]}),s.identity_key&&e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-[#666]",children:"key"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-[#FF8C00] truncate max-w-[140px]",title:s.identity_key,children:[s.identity_key.slice(0,16),"…"]}),e.jsx("button",{type:"button",onClick:P,className:I?"text-[#666] text-xs":"text-[#666] hover:text-[#888] text-xs",children:I?"[copied ✓]":"[copy]"})]})]}),(null!=(null==(r=s.settings)?void 0:r.latitude)||null!=(null==(c=s.settings)?void 0:c.longitude))&&e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-[#666]",children:"loc"}),e.jsxs("span",{className:"text-[#FF8C00]",title:`${(null==(o=s.settings)?void 0:o.latitude)??"—"}, ${(null==(d=s.settings)?void 0:d.longitude)??"—"}`,children:[(null==(x=null==(m=s.settings)?void 0:m.latitude)?void 0:x.toFixed(4))??"—",", ",(null==(p=null==(u=s.settings)?void 0:u.longitude)?void 0:p.toFixed(4))??"—"]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-[#666]",children:"pass"}),e.jsxs("span",{className:"flex items-center gap-1.5",children:[e.jsx("span",{className:(null==(h=s.settings)?void 0:h.admin_password)?"text-[#FF8C00]":"text-[#666]",children:(null==(g=s.settings)?void 0:g.admin_password)?"[✓ admin]":"[— admin]"}),e.jsx("span",{className:(null==(j=s.settings)?void 0:j.guest_password)?"text-[#FF8C00]":"text-[#666]",children:(null==(f=s.settings)?void 0:f.guest_password)?"[✓ guest]":"[— guest]"})]})]})]}):e.jsx("span",{className:"text-[#666]",children:"no identity configured"}):e.jsxs("div",{className:"flex-shrink-0 border-t border-border-subtle",children:[e.jsx(Y,{listHeader:!0,icon:e.jsx(Q,{className:"icon-sm"}),title:"Room Info"}),s?e.jsxs("div",{className:"space-y-2 px-4 py-3",children:[(null==(v=s.settings)?void 0:v.node_name)&&e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"type-data-xs text-text-muted",children:"Node"}),e.jsx("span",{className:"type-data-sm text-text-primary",children:s.settings.node_name})]}),(s.address||(null==(N=s.runtime)?void 0:N.address))&&e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"type-data-xs text-text-muted",children:"Address"}),e.jsx("span",{className:"type-data-sm font-mono text-text-primary",children:s.address||(null==(b=s.runtime)?void 0:b.address)})]}),s.identity_key&&e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("span",{className:"type-data-xs text-text-muted flex items-center gap-1",title:"The unique hex public ID",children:[e.jsx(Z,{className:"w-3 h-3"}),"Key"]}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsxs("span",{className:"type-data-sm font-mono text-text-primary truncate max-w-[140px]",title:s.identity_key,children:[s.identity_key.slice(0,16),"…"]}),e.jsx("button",{type:"button",onClick:P,className:"inline-flex items-center gap-0.5",children:e.jsx(y,{color:I?"green":"zinc",children:I?e.jsxs(e.Fragment,{children:[e.jsx(w,{className:"w-3 h-3"}),"Copied"]}):e.jsxs(e.Fragment,{children:[e.jsx(X,{className:"w-3 h-3"}),"Copy"]})})})]})]}),(null!=(null==(k=s.settings)?void 0:k.latitude)||null!=(null==(C=s.settings)?void 0:C.longitude))&&e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("span",{className:"type-data-xs text-text-muted flex items-center gap-1",children:[e.jsx(q,{className:"w-3 h-3"}),"Location"]}),e.jsxs("span",{className:"type-data-sm font-mono text-text-primary",title:`${(null==(_=s.settings)?void 0:_.latitude)??"—"}, ${(null==(S=s.settings)?void 0:S.longitude)??"—"}`,children:[(null==(M=null==(F=s.settings)?void 0:F.latitude)?void 0:M.toFixed(4))??"—",", ",(null==(T=null==(A=s.settings)?void 0:A.longitude)?void 0:T.toFixed(4))??"—"]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"type-data-xs text-text-muted",children:"Passwords"}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsxs(y,{color:(null==(R=s.settings)?void 0:R.admin_password)?"green":"zinc",children:[(null==(D=s.settings)?void 0:D.admin_password)&&e.jsx(w,{className:"w-3 h-3"}),"Admin"]}),e.jsxs(y,{color:(null==(E=s.settings)?void 0:E.guest_password)?"green":"zinc",children:[(null==($=s.settings)?void 0:$.guest_password)&&e.jsx(w,{className:"w-3 h-3"}),"Guest"]})]})]}),e.jsx("div",{className:"pt-3",children:e.jsx(Re,{name:s.name,onSend:t})})]}):e.jsx("p",{className:"type-data-xs text-text-muted text-center py-3",children:"No identity configured"})]})}function Ee({selectedIdentity:s,clients:t,messages:a,onSendAdvert:n}){const{terminalMode:r}=ge(),c=l.useCallback(async e=>{_.setState(s=>({clients:s.clients.filter(s=>s.pubkey!==e)})),await async function(e){return u("/api/acl_remove_client",{method:"POST",body:JSON.stringify(e)})}({public_key:e})},[]);return r?e.jsxs("div",{className:"flex flex-col h-full gap-1.5",children:[s&&e.jsx("div",{className:"card-terminal-header flex-shrink-0",children:e.jsx(Fe,{name:s.name,onSend:n,isActive:s.registered})}),e.jsxs("div",{className:"flex flex-col flex-1 min-h-0 gap-1.5",children:[e.jsxs("div",{className:"card-terminal-header flex-shrink-0",children:[e.jsx("span",{className:"seven-seg-panel",children:e.jsx(Ne,{text:"peers",minChars:7,size:24})}),e.jsx("div",{className:"card-terminal-ridge flex-1"}),e.jsx("span",{className:"seven-seg-panel",children:e.jsx(Ne,{text:String(t.length).padStart(3,"0"),size:24})})]}),e.jsx(i,{noPadding:!0,className:"!h-auto flex flex-col flex-1 min-h-0 overflow-hidden card-terminal",children:e.jsx("div",{className:"card-terminal-well flex-1 min-h-0 overflow-y-auto",children:e.jsx(Te,{clients:t,onRemove:c,messages:a,terminalMode:!0})})}),e.jsxs("div",{className:"card-terminal-header flex-shrink-0",children:[e.jsx("span",{className:"seven-seg-panel",children:e.jsx(Ne,{text:"status",minChars:8,size:24})}),e.jsx("div",{className:"card-terminal-ridge flex-1"}),e.jsx("span",{className:"seven-seg-panel",children:e.jsx(Ne,{text:(null==s?void 0:s.registered)?"on":"off",minChars:3,size:24})})]}),e.jsx(i,{noPadding:!0,className:"!h-auto flex-shrink-0 overflow-hidden card-terminal",children:e.jsx("div",{className:"card-terminal-well px-4 py-3 font-mono text-sm",children:e.jsx(De,{identity:s,onSendAdvert:n})})})]})]}):e.jsxs(i,{compact:!0,className:"flex-1 min-h-0 flex flex-col overflow-hidden",children:[e.jsx(Y,{listHeader:!0,icon:e.jsx(ee,{className:"icon-sm"}),title:"Clients",actions:t.length>0?e.jsx("span",{className:"type-data-xs text-text-muted",children:t.length}):void 0}),e.jsx("div",{className:"flex-1 min-h-0 overflow-y-auto",children:e.jsx(Te,{clients:t,onRemove:c,messages:a,terminalMode:!1})}),e.jsx(De,{identity:s,onSendAdvert:n})]})}function $e(){const s=S(),t=F(),a=M(),n=A(),i=T(),x=R(),u=D(),h=E(),g=$(),{selectRoom:j,postMessage:f,deleteMessage:v,clearMessages:N,createRoom:k,updateRoom:C,deleteRoom:w,sendAdvert:z,markAsRead:P,startActivePolling:B}=_.getState(),[O,K]=l.useState(!1),[U,q]=l.useState("create"),[H,G]=l.useState("hybrid");l.useEffect(()=>{P()},[t,P]),l.useEffect(()=>B(),[B]);const V=l.useCallback(async e=>!!t&&f({room_name:t,message:e,author_pubkey:"server"}),[t,f]),W=l.useCallback((e="hybrid")=>{G(e),q("create"),K(!0)},[]),J=l.useCallback(()=>{q("edit"),K(!0)},[]),Q=a?e.jsxs("span",{className:"type-data-sm text-text-muted",children:[a.total_messages," messages · ",a.total_clients," clients",n&&e.jsxs(e.Fragment,{children:[" · ",e.jsx(y,{color:n.registered?"green":"red",className:"ml-0.5",children:n.registered?"Active":"Inactive"})]})]}):void 0,Y=e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(me,{rooms:s,selected:t,onSelect:j,onAdd:()=>W("hybrid")}),s.length>0&&e.jsx(b,{plain:!0,onClick:J,title:"Manage room server",children:e.jsx(L,{"data-slot":"icon"})})]});return 0!==s.length||0!==u.length||h?e.jsx(he,{children:e.jsxs(r,{children:[e.jsx(c,{title:"Room Server",icon:e.jsx(p,{}),subtitle:Q,controls:Y}),e.jsx(o,{children:e.jsxs(d,{template:"hero-tall",className:"!h-[calc(100vh-11rem)] !min-h-[400px]",children:[e.jsx(m,{span:12,lg:8,className:"h-full",children:e.jsx(_e,{selectedName:t,selectedIdentity:n,messages:i,onSend:V,onDelete:v,onClear:N})}),e.jsx(m,{span:12,lg:4,className:"h-full",children:e.jsx(Ee,{selectedIdentity:n,clients:x,messages:i,onSendAdvert:z})})]})}),e.jsx(xe,{open:O,onClose:()=>K(!1),mode:U,identity:n,repeaterConfig:null==g?void 0:g.config,onCreate:k,onUpdate:C,onDelete:w,onSendAdvert:z})]})}):e.jsx(he,{children:e.jsxs(r,{children:[e.jsx(c,{title:"Room Server",icon:e.jsx(p,{})}),e.jsx(de,{onCreateRoom:e=>W(e)}),e.jsx(xe,{open:O,onClose:()=>K(!1),mode:"create",repeaterConfig:null==g?void 0:g.config,onCreate:async e=>{const s=await k(e);return s&&"dedicated"===H&&(await I.getState().setMode("monitor"),I.getState().clearModeMutation()),s},onUpdate:C,onDelete:w,onSendAdvert:z})]})})}export{$e as default};
