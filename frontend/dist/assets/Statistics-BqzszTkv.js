var e=Object.defineProperty,t=(t,s,a)=>((t,s,a)=>s in t?e(t,s,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[s]=a)(t,"symbol"!=typeof s?s+"":s,a);import{r as s,j as a,c as n}from"./vendor-react-Co0R0q1H.js";import{c as i,e as l,aa as r,aY as o,aZ as c,a_ as d,a$ as m,j as u,b0 as h,b1 as x,u as p,b2 as g,b3 as f,b4 as y,b5 as b,b6 as j,b7 as v,aw as N,b8 as k,b9 as w,ba as M,bb as S,v as C,y as T,x as A,q as F,a6 as P,a7 as L,z as R,a0 as D,bc as $,bd as _,be as E,P as z,R as H,bf as B}from"./index-a2wAGVcz.js";import{L as O}from"./layers-CGwgl2ZN.js";import{C as q,T as W}from"./TimeRangeStepper-CY6q67uW.js";import{u as I,h as G,r as V}from"./consumer-registry-CMeHuEqF.js";import{C as X,e as Y}from"./easing-dk8iTigG.js";import{a as K,P as U,b as Q,B as J}from"./PageLayout-DUTKTAj2.js";import{D as Z}from"./DataBox-BDnsDPpd.js";import{E as ee,A as te}from"./AnimatedNumber-CzwFkjut.js";import{C as se}from"./CollisionExplorerModal-abSN67dU.js";import{C as ae,a as ne}from"./Card-DP8_Dv-I.js";import{H as ie}from"./hash-CQ9tNSW0.js";import{T as le}from"./triangle-alert-DfcDkGFE.js";import{L as re}from"./LightSparkline-DnTPTfQA.js";import{A as oe}from"./activity-4IyPHKV3.js";import{c as ce,a as de,A as me}from"./AnalyzerFilterPanel-CaQjL8gG.js";import{a as ue}from"./usePipelineStore-D52QB09z.js";import{R as he,C as xe}from"./Grid-CTmu8x0g.js";import{S as pe}from"./settings-2-d1Yq5pJY.js";import{N as ge}from"./network-D3HWM48N.js";import"./maplibre-gl-b91ci4Kr.js";import"./vendor-core-B_fdKJ1g.js";import"./chevron-right-pNyMwg-g.js";import"./index-ifFqsD_I.js";import"./BasemapLayer-DRuifqX0.js";import"./map-pin-DilOP-Hq.js";import"./monitor-smartphone-DvNIRrGB.js";import"./node-types-D_Jpnr7C.js";import"./circle-question-mark-DaxlgSKZ.js";import"./search-C7j29NEZ.js";import"./geo-utils-DJn8DnxF.js";const fe=i("chart-line",[["path",{d:"M3 3v16a2 2 0 0 0 2 2h16",key:"c24i48"}],["path",{d:"m19 9-5 5-4-4-3 3",key:"2osh9i"}]]),ye=i("circle-check-big",[["path",{d:"M21.801 10A10 10 0 1 1 17 3.335",key:"yps3ct"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]]),be=i("grid-3x3",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}],["path",{d:"M3 9h18",key:"1pudct"}],["path",{d:"M3 15h18",key:"5xshup"}],["path",{d:"M9 3v18",key:"fh3hqa"}],["path",{d:"M15 3v18",key:"14nvp0"}]]),je=i("grip",[["circle",{cx:"12",cy:"5",r:"1",key:"gxeob9"}],["circle",{cx:"19",cy:"5",r:"1",key:"w8mnmm"}],["circle",{cx:"5",cy:"5",r:"1",key:"lttvr7"}],["circle",{cx:"12",cy:"12",r:"1",key:"41hilf"}],["circle",{cx:"19",cy:"12",r:"1",key:"1wjl8i"}],["circle",{cx:"5",cy:"12",r:"1",key:"1pcz8c"}],["circle",{cx:"12",cy:"19",r:"1",key:"lyex9k"}],["circle",{cx:"19",cy:"19",r:"1",key:"shf9b7"}],["circle",{cx:"5",cy:"19",r:"1",key:"bfqh0e"}]]),ve=i("waves",[["path",{d:"M2 6c.6.5 1.2 1 2.5 1C7 7 7 5 9.5 5c2.6 0 2.4 2 5 2 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1",key:"knzxuh"}],["path",{d:"M2 12c.6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 2.6 0 2.4 2 5 2 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1",key:"2jd2cc"}],["path",{d:"M2 18c.6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 2.6 0 2.4 2 5 2 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1",key:"rd2r6e"}]]),Ne={useAbsoluteThresholds:!0,baselinePercentile:6,spikePercentile:50,baselineDbm:-107,spikeDbm:-100,mergeGapSeconds:45,minSequenceLength:16,similarityToleranceDbm:5};function ke(e,t){if(0===e.length)return 0;const s=t/100*(e.length-1),a=Math.floor(s),n=Math.ceil(s);return a===n?e[a]:e[a]+(e[n]-e[a])*(s-a)}function we(e){if(0===e.length)return{median:0,p90:0,p95:0,p99:0,max:0,min:0};const t=[...e].sort((e,t)=>e-t);return{median:ke(t,50),p90:ke(t,90),p95:ke(t,95),p99:ke(t,99),max:t[t.length-1],min:t[0]}}function Me(e,t,s){const a=s-t;if(0===a)return"moderate";const n=(e-t)/a;return n>.66?"critical":n>.33?"severe":"moderate"}const Se=Object.entries(r).map(([e,t])=>{const s=parseInt(e,10);return{typeNum:s,key:`TYPE_${s}`,label:t}});function Ce({sortedTypes:e,highlightedType:t,onTypeHover:i,aggregateShares:r,hoverData:o}){const c=s.useMemo(()=>{if(!o)return null;const e=new Map;for(const t of o.items)e.set(t.key,t.value);return e},[o]),d=null!==c,m=s.useMemo(()=>{const t=new Set(e.map(e=>e.key));return[...e.map(e=>({typeNum:e.typeNum,key:e.key,label:e.label})),...Se.filter(e=>!t.has(e.key))]},[e]);return a.jsxs("div",{className:"flex-shrink-0 pt-2 sm:pt-3 mt-1 sm:mt-2 px-0 sm:pr-0",children:[a.jsxs("div",{className:"flex items-center gap-2 mx-0 sm:ml-9 sm:mr-0 mb-1 sm:mb-1.5 type-data-xs",children:[a.jsx("span",{className:"text-fg-muted",children:"Packet Types"}),d&&(null==o?void 0:o.timeLabel)&&a.jsx("span",{className:"text-sys-indigo tabular-nums",children:o.timeLabel})]}),a.jsx("div",{className:"flex flex-wrap gap-x-3 sm:gap-x-4 gap-y-1 type-data-xs mx-0 sm:ml-9 sm:mr-0",onMouseLeave:()=>i(null),children:m.map(e=>{const s=l(e.typeNum),o=(null==c?void 0:c.get(e.key))??0,m=r.get(e.key)??0,u=d?o:m,h=u>1e-4,x=r.has(e.key),p=t===e.key,g=t&&!p||d&&o<=1e-4||!d&&!t&&!x;return a.jsxs("div",{className:n("flex items-center gap-1.5 transition-opacity cursor-pointer hover:opacity-80",g&&"opacity-30"),onMouseEnter:()=>i(e.key),children:[a.jsx("div",{className:"shrink-0 w-3 h-3 rounded-xs",style:{backgroundColor:s}}),a.jsx("span",{className:"text-fg-secondary whitespace-nowrap",children:e.label}),h&&a.jsxs("span",{className:n("tabular-nums",d?"text-fg-primary":"text-fg-muted"),children:[(100*u).toFixed(1),"%"]})]},e.key)})})]})}const Te='ui-monospace, SFMono-Regular, "SF Mono", Menlo, Consolas, monospace';function Ae(e,t,s,a,n){const i=e.reduce((e,t)=>e+t,0);if(i<=0||0===e.length)return[];const l=e.map((e,t)=>t).sort((t,s)=>e[s]-e[t]),r=l.map(t=>e[t]),o=new Array(e.length);return Fe(r,l,i,t,s,a,n,o),o}function Fe(e,t,s,a,n,i,l,r){if(0===e.length)return;if(1===e.length)return void(r[t[0]]={x:a,y:n,w:i,h:l,index:t[0]});const o=i*l/s,c=i>=l,d=c?l:i;let m=0,u=1/0,h=0;for(let b=0;b<e.length;b++){const t=m+e[b],s=t*o/d;if(s<=0){h=b+1,m=t;continue}const a=e[0]*o/s,n=e[b]*o/s,i=Math.max(a>s?a/s:s/a,n>s?n/s:s/n);if(!(i<=u))break;u=i,h=b+1,m=t}const x=d>0?m*o/d:0;let p=0;for(let b=0;b<h;b++){const s=(m>0?e[b]/m:0)*d;r[t[b]]=c?{x:a,y:n+p,w:x,h:s,index:t[b]}:{x:a+p,y:n,w:s,h:x,index:t[b]},p+=s}const g=e.slice(h),f=t.slice(h),y=s-m;c?Fe(g,f,y,a+x,n,i-x,l,r):Fe(g,f,y,a,n+x,i,l-x,r)}function Pe(e,t,s,a,n,i){for(const r of t){const t=s[r.index];if(!t)continue;const o=2*i,c=r.x*i+o/2,d=r.y*i+o/2,m=r.w*i-o,u=r.h*i-o;if(m<=0||u<=0)continue;const h=l(t.typeNum),x=null!==n&&n!==r.index;e.save(),e.globalAlpha=x?.4:1;const p=3*i;e.beginPath(),e.moveTo(c+p,d),e.lineTo(c+m-p,d),e.quadraticCurveTo(c+m,d,c+m,d+p),e.lineTo(c+m,d+u-p),e.quadraticCurveTo(c+m,d+u,c+m-p,d+u),e.lineTo(c+p,d+u),e.quadraticCurveTo(c,d+u,c,d+u-p),e.lineTo(c,d+p),e.quadraticCurveTo(c,d,c+p,d),e.closePath(),e.fillStyle=h,e.fill(),e.strokeStyle="rgba(0,0,0,0.2)",e.lineWidth=1*i,e.stroke();const g=4*i,f=r.w>36&&r.h>20,y=r.w>36&&r.h>32;if(f){const s=11*i;if(y){const n=a>0?t.size/a*100:0;e.font=`500 ${8*i}px ${Te}`,e.fillStyle="rgba(0,0,0,0.6)",e.textBaseline="alphabetic",e.textAlign="left",e.fillText(`${n.toFixed(1)}%`,c+g,d+u-g-s)}e.font=`600 ${9*i}px ${Te}`,e.fillStyle="rgba(0,0,0,0.85)",e.textBaseline="alphabetic",e.textAlign="left",e.fillText(t.name,c+g,d+u-g)}e.restore()}}function Le({data:e,total:t,color:s,position:n,containerWidth:i,isAirtime:l}){if(!e||!n)return null;const r=(e.value/t*100).toFixed(1),o=i-n.x<184?Math.max(8,n.x-160-8):n.x+16;return a.jsx("div",{className:"absolute z-50 pointer-events-none",style:{left:o,top:Math.max(8,n.y-60)},children:a.jsxs("div",{className:"bg-tooltip-bg border border-edge-subtle rounded-lg px-3 py-2 shadow-xl min-w-[140px]",children:[a.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[a.jsx("span",{className:"w-2.5 h-2.5 rounded-sm flex-shrink-0",style:{backgroundColor:s}}),a.jsx("span",{className:"type-data-sm font-semibold text-fg-primary",children:e.name})]}),a.jsxs("div",{className:"space-y-0.5 type-data-xs text-fg-muted",children:[a.jsxs("div",{className:"flex justify-between gap-4",children:[a.jsx("span",{children:l?"Airtime":"Count"}),a.jsx("span",{className:"text-fg-primary tabular-nums font-medium",children:l?Re(e.value):e.value.toLocaleString()})]}),a.jsxs("div",{className:"flex justify-between gap-4",children:[a.jsx("span",{children:"Share"}),a.jsxs("span",{className:"text-fg-primary tabular-nums font-medium",children:[r,"%"]})]}),a.jsxs("div",{className:"flex justify-between gap-4",children:[a.jsx("span",{children:"Total"}),a.jsx("span",{className:"text-fg-primary tabular-nums font-medium",children:l?Re(t):t.toLocaleString()})]})]})]})})}function Re(e){return e>=6e4?`${(e/6e4).toFixed(1)}m`:e>=1e3?`${(e/1e3).toFixed(1)}s`:`${Math.round(e)}ms`}function De({sortedTypes:e,aggregateShares:t,mode:n="share"}){var i,r,o;const[c,d]=s.useState(null),[m,u]=s.useState(null),[h,x]=s.useState(0),[p,g]=s.useState(null),f=s.useRef(null),y=s.useRef(null),b=s.useRef([]),j="airtime"===n,v=s.useMemo(()=>e.reduce((e,t)=>e+(j?t.totalAirtime:t.totalCount),0),[e,j]),N=s.useMemo(()=>e.map((e,t)=>({name:e.label,size:j?e.totalAirtime:e.totalCount,index:t,typeNum:e.typeNum,key:e.key})),[e,j]);s.useEffect(()=>{const e=y.current;if(!e)return;const t=e.parentElement;if(!t)return;const s=t.getBoundingClientRect(),a=s.width,n=s.height;if(a<=0||n<=0)return;const i=window.devicePixelRatio||1;e.width=Math.floor(a*i),e.height=Math.floor(n*i),e.style.width=`${a}px`,e.style.height=`${n}px`;const l=Ae(N.map(e=>e.size),0,0,a,n);b.current=l;const r=e.getContext("2d");r&&(r.clearRect(0,0,e.width,e.height),Pe(r,l,N,v,c,i))},[N,v,c]),s.useEffect(()=>{const e=f.current;if(!e)return;const t=new ResizeObserver(()=>{const t=y.current;if(!t)return;const s=e.getBoundingClientRect(),a=s.width,n=s.height;if(a<=0||n<=0)return;const i=window.devicePixelRatio||1;t.width=Math.floor(a*i),t.height=Math.floor(n*i),t.style.width=`${a}px`,t.style.height=`${n}px`;const l=Ae(N.map(e=>e.size),0,0,a,n);b.current=l;const r=t.getContext("2d");r&&(r.clearRect(0,0,t.width,t.height),Pe(r,l,N,v,c,i))});return t.observe(e),()=>t.disconnect()},[N,v]);const k=s.useCallback(e=>{const t=f.current;if(!t)return;const s=t.getBoundingClientRect(),a=e.clientX-s.left,n=e.clientY-s.top,i=function(e,t,s){for(const a of e)if(t>=a.x&&t<=a.x+a.w&&s>=a.y&&s<=a.y+a.h)return a.index;return null}(b.current,a,n);d(i),null!==i?(x(s.width),u({x:a,y:n})):u(null)},[]),w=s.useCallback(()=>{d(null),u(null)},[]),M=s.useCallback(e=>{if(g(e),e){const t=N.findIndex(t=>t.key===e);d(t>=0?t:null)}else d(null)},[N]),S=null!==c?{name:(null==(i=N[c])?void 0:i.name)??"",value:(null==(r=N[c])?void 0:r.size)??0}:null,C=null!==c?l(null==(o=N[c])?void 0:o.typeNum):"";return 0===e.length||0===v?a.jsxs("div",{className:"h-full flex items-center justify-center text-fg-muted",children:[a.jsx(O,{className:"w-6 h-6 mr-2 opacity-50"}),a.jsx("span",{children:"No packet type data available"})]}):a.jsxs("div",{className:"flex flex-col h-full",children:[a.jsxs("div",{className:"flex-1 min-h-0 relative",ref:f,onMouseMove:k,onMouseLeave:w,children:[a.jsx("canvas",{ref:y,className:"absolute inset-0",style:{cursor:"default"}}),a.jsx(Le,{data:S,total:v,color:C,position:m,containerWidth:h,isAirtime:j})]}),a.jsx("div",{style:{minHeight:80},children:a.jsx(Ce,{sortedTypes:e,highlightedType:p,onTypeHover:M,aggregateShares:t})})]})}function $e(e){return e>=1e9?`${(e/1e9).toFixed(1)} Gb`:e>=1e6?`${(e/1e6).toFixed(1)} Mb`:e>=1e3?`${(e/1e3).toFixed(1)} Kb`:`${e.toFixed(0)} B`}function _e({packets:e,mode:t,startTs:n,endTs:i,radioConfig:l,bucketCount:r,lockedYMax:h,legendMinH:x}){const p=s.useMemo(()=>o(),[]),g=p.blue,f=p.red,y=p.yellow,[b,j]=s.useState(null),{trendData:v,totals:N}=s.useMemo(()=>{if(0===e.length)return{trendData:[],totals:{rxBytes:0,txBytes:0,rxAirtime:0,txAirtime:0}};const s=i-n,a=Math.min(Math.ceil(s/300),r),o=s/a,m=[];let u=0,h=0,x=0,p=0;for(const t of e){const e=t.timestamp;if(e<n||e>=i)continue;const s=c(t),a=d(t,{spreadingFactor:l.sf,bandwidthHz:l.bw,codingRate:l.cr,preambleLength:l.preamble}),r={timestamp:e,rxAirtime:0,txAirtime:0,rxBytes:0,txBytes:0};t.transmitted?(r.txAirtime=a,r.txBytes=s,h+=s,p+=a):(r.rxAirtime=a,r.rxBytes=s,u+=s,x+=a),m.push(r)}m.sort((e,t)=>e.timestamp-t.timestamp);const g=new Float64Array(m.length+1),f=new Float64Array(m.length+1),y=new Float64Array(m.length+1),b=new Float64Array(m.length+1),j=new Float64Array(m.length);for(let e=0;e<m.length;e++)g[e+1]=g[e]+m[e].rxAirtime,f[e+1]=f[e]+m[e].txAirtime,y[e+1]=y[e]+m[e].rxBytes,b[e+1]=b[e]+m[e].txBytes,j[e]=m[e].timestamp;const v=e=>{let t=0,s=j.length;for(;t<s;){const a=t+s>>>1;j[a]<e?t=a+1:s=a}return t},N=[],k=1e3*o;for(let e=0;e<a;e++){const s=n+e*o,a=s+o,i=v(s),l=v(a);if("share"===t){const e=y[l]-y[i],t=b[l]-b[i];N.push({timestamp:s,rx:e>0?e:null,tx:t>0?t:null})}else{const e=(g[l]-g[i])/k*100,t=(f[l]-f[i])/k*100;N.push({timestamp:s,rx:e>0?e:null,tx:t>0?t:null})}}const w=2/31;let M=null;return{trendData:N.map(e=>{const t=e.rx;return null!==t&&t>0&&(M=null===M?t:w*t+(1-w)*M),{...e,rxSmooth:null!==M&&M>0?M:null}}),totals:{rxBytes:u,txBytes:h,rxAirtime:x,txAirtime:p}}},[e,n,i,r,t,l]),k=s.useMemo(()=>{if(0===v.length)return"share"===t?100:10;let e=0;for(const t of v){const s=t.rx??0,a=t.tx??0;s>e&&(e=s),a>e&&(e=a)}const s=1.1*e;return"share"===t?s<=100?100:s<=500?100*Math.ceil(s/100):s<=1e3?200*Math.ceil(s/200):s<=5e3?500*Math.ceil(s/500):s<=1e4?1e3*Math.ceil(s/1e3):5e3*Math.ceil(s/5e3):Math.max(1,Math.ceil(s))},[v,t]),w=h??k,M=s.useMemo(()=>{if(null!==b&&v[b]){const e=v[b],s=e.rx??0,a=e.tx??0;return"share"===t?{rx:$e(s),tx:$e(a),total:$e(s+a),isHovered:!0}:{rx:`${s.toFixed(2)}%`,tx:`${a.toFixed(2)}%`,total:`${(s+a).toFixed(2)}%`,isHovered:!0}}if("share"===t)return{rx:$e(N.rxBytes),tx:$e(N.txBytes),total:$e(N.rxBytes+N.txBytes),isHovered:!1};{let e=0,t=0,s=0;for(const i of v)null===i.rx&&null===i.tx||(e+=i.rx??0,t+=i.tx??0,s++);const a=s>0?e/s:0,n=s>0?t/s:0;return{rx:`${a.toFixed(2)}%`,tx:`${n.toFixed(2)}%`,total:`${(a+n).toFixed(2)}%`,isHovered:!1}}},[b,v,N,t]),S=s.useMemo(()=>{const e=i-n,t=e/3600;return[0,.25,.5,.75,1].map(s=>{const a=new Date(1e3*(n+e*s)),i=a.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hour12:!1}),l=a.toLocaleDateString([],{weekday:"short"});return{pct:s,label:t>24?`${l} ${i}`:i,mobileHidden:.25===s||.75===s}})},[n,i]),C=s.useCallback(e=>{j(e)},[]);return 0===v.length?a.jsxs("div",{className:"h-full flex items-center justify-center text-fg-muted",children:[a.jsx(O,{className:"w-6 h-6 mr-2 opacity-50"}),a.jsx("span",{children:"No packet data available"})]}):a.jsxs("div",{className:"flex flex-col h-full",children:[a.jsxs("div",{className:"flex-1 min-h-0 relative",children:[a.jsx("div",{className:"absolute top-0 left-0 right-0 z-10 flex items-center text-fg-secondary",style:{height:20,paddingLeft:44,paddingRight:8},children:a.jsx("div",{className:"relative w-full h-full flex items-center",children:S.map((e,t)=>a.jsxs("div",{className:"absolute flex items-center gap-0.5 sm:gap-1 type-data-xs "+(e.mobileHidden?"hidden sm:flex":""),style:{left:100*e.pct+"%",transform:0===e.pct?"translateX(0)":1===e.pct?"translateX(-100%)":"translateX(-50%)"},children:[a.jsx(q,{className:"w-2.5 h-2.5 opacity-60 hidden sm:block"}),a.jsx("span",{className:"tabular-nums",children:e.label})]},t))})}),a.jsx("div",{className:"absolute inset-0 rounded-lg overflow-hidden",style:{paddingTop:20},children:a.jsx(m,{data:v,yAxisMode:"share"===t?"share":"airtime",yMax:w,onHover:C,startTs:n,endTs:i})})]}),a.jsxs("div",{className:"flex items-center justify-between mt-1.5 sm:mt-2",style:{minHeight:x},children:[a.jsxs("div",{className:"flex items-center gap-2 sm:gap-4 type-data-xs pl-2 sm:pl-11",children:[a.jsxs("div",{className:"flex items-center gap-1",children:[a.jsx("div",{className:"w-3 sm:w-4 h-0.5",style:{backgroundColor:g}}),a.jsx("span",{className:"text-fg-secondary",children:"RX"})]}),a.jsxs("div",{className:"flex items-center gap-1",children:[a.jsx("div",{className:"w-3 sm:w-4 h-0.5",style:{backgroundColor:f}}),a.jsx("span",{className:"text-fg-secondary",children:"TX"})]}),a.jsxs("div",{className:"hidden sm:flex items-center gap-1.5",children:[a.jsx("div",{className:"w-4 h-0.5",style:{backgroundColor:y}}),a.jsx("span",{className:"text-fg-secondary",children:"Avg"})]})]}),a.jsxs("div",{className:"flex flex-wrap gap-4 sm:gap-8",children:[a.jsxs("div",{className:"flex items-end gap-2",children:[a.jsx("div",{className:"type-data-xl text-fg-primary",children:M.rx}),a.jsx(u,{color:"zinc",className:"mb-0.5 sm:mb-1",children:"RX"})]}),a.jsxs("div",{className:"flex items-end gap-2",children:[a.jsx("div",{className:"type-data-xl text-fg-primary",children:M.tx}),a.jsx(u,{color:"zinc",className:"mb-0.5 sm:mb-1",children:"TX"})]})]})]})]})}const Ee=h,ze=new class{constructor(){t(this,"worker",null),t(this,"listeners",new Set),t(this,"currentResult",null),t(this,"isComputing",!1),t(this,"debounceTimer",null),t(this,"debounceMs",250),t(this,"lastCacheKey",null)}ensureWorker(){if(this.worker)return this.worker;if("undefined"==typeof window)return null;try{this.worker=new Worker(new URL("/assets/bucketing.worker-CgIH5X6q.js",import.meta.url),{type:"module"}),this.worker.onmessage=e=>{this.handleWorkerMessage(e.data)},this.worker.onerror=e=>{this.isComputing=!1,this.notifyListeners()}}catch(e){}return this.worker}handleWorkerMessage(e){if(this.isComputing=!1,"error"===e.type)return this.currentResult=null,void this.notifyListeners();const t=e.payload;this.currentResult={points:t.points,rawValues:t.rawValues,packetTypes:t.packetTypes,timestamps:t.timestamps,count:t.count,minTime:t.minTime,maxTime:t.maxTime,minValue:t.minValue,maxValue:t.maxValue,rawMinValue:t.rawMinValue,rawMaxValue:t.rawMaxValue,unit:"%",stats:{p5:t.p5,p50:t.p50,p95:t.p95,uniqueValues:t.uniqueValues,topValues:t.topValues}},this.notifyListeners()}notifyListeners(){for(const t of this.listeners)try{t(this.currentResult,this.isComputing)}catch(e){}}isCacheHit(e){return!(!this.lastCacheKey||!this.currentResult)&&this.lastCacheKey.startTs===e.startTs&&this.lastCacheKey.endTs===e.endTs&&this.lastCacheKey.mode===e.mode&&this.lastCacheKey.packetCount===e.packetCount}compute(e,t,s,a,n){if(0===e.length||!n)return this.currentResult=null,void this.notifyListeners();const i={startTs:t,endTs:s,mode:a,packetCount:e.length};this.isCacheHit(i)||(this.debounceTimer&&clearTimeout(this.debounceTimer),this.debounceTimer=setTimeout(()=>{this.debounceTimer=null,this.computeInternal(e,t,s,a,n,i)},this.debounceMs))}computeInternal(e,t,s,a,n,i){const l=this.ensureWorker();if(!l)return;const r=e.length,o=new Float64Array(r),m=new Float64Array(r),u=new Uint16Array(r),h=new Uint8Array(r),x={spreadingFactor:n.sf,bandwidthHz:n.bw,codingRate:n.cr,preambleLength:n.preamble};for(let g=0;g<r;g++){const t=e[g];o[g]=t.timestamp??0,h[g]=255&(t.type??t.payload_type??255),u[g]=Math.min(c(t),65535),m[g]="airtime"===a?d(t,x):1}this.isComputing=!0,this.lastCacheKey=i,this.notifyListeners();const p={type:"compute",payload:{timestamps:o,airtimeMs:m,byteSizes:u,packetTypes:h,startTs:t,endTs:s,mode:a}};l.postMessage(p,[o.buffer,m.buffer,u.buffer,h.buffer])}getResult(){return this.currentResult}isWorking(){return this.isComputing}subscribe(e){return this.listeners.add(e),e(this.currentResult,this.isComputing),()=>{this.listeners.delete(e)}}clear(){this.currentResult=null,this.lastCacheKey=null,this.notifyListeners()}terminate(){this.debounceTimer&&clearTimeout(this.debounceTimer),this.worker&&(this.worker.terminate(),this.worker=null),this.listeners.clear()}};function He({mode:e,packets:t,startTs:n,endTs:i,radioConfig:l,sortedTypes:r,aggregateShares:o,noiseFloorAnomalies:c,showNoiseFloorOverlay:m,overlayOpacity:u=.5,startLabel:h,endLabel:p,yAxisPad:g=28,lockedYMax:f,legendMinH:y,dotSize:b,dotOpacity:j}){const[v,N]=s.useState(null),[k,w]=s.useState(null),M=s.useMemo(()=>(i-n)/3600,[n,i]),S=s.useCallback(e=>{w(e)},[]),C=function(e,t,a,n,i){const[l,r]=s.useState(()=>ze.getResult());return s.useEffect(()=>ze.subscribe(e=>{r(e)}),[]),s.useEffect(()=>{ze.compute(e,t,a,n,i)},[e,t,a,n,i]),l}(t,n,i,"share"===e?"share":"airtime",l),[T,A]=s.useState(null),F=s.useCallback((e,t)=>{N(e),A(t??null)},[]),P=s.useMemo(()=>{if(null===T||!C||0===C.count)return null;const e=C.maxTime-C.minTime||1,t=C.minTime+T*e;let s;s=M>=168?75:M>=72?35:M>=24?15:M>=3?10:5;const a=60*s/2;return{start:t-a,end:t+a}},[T,C,M]),L=s.useMemo(()=>P?new Date((P.start+P.end)/2*1e3).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hour12:!1}):null,[P]),R=s.useMemo(()=>{if(null===v||!P)return null;const s=L??"",{start:a,end:n}=P,i=t.filter(e=>e.timestamp>=a&&e.timestamp<n);if(0===i.length)return{timestamp:(a+n)/2,timeLabel:s,items:r.map(e=>({key:e.key,label:e.label,value:0,color:Ee(e.typeNum)}))};const o=new Map,c=new Map;let m=0,u=0;for(const e of i){const t=`TYPE_${e.type??e.payload_type??-1}`;if(o.set(t,(o.get(t)??0)+1),m++,l){const s=d(e,{spreadingFactor:l.sf,bandwidthHz:l.bw,codingRate:l.cr,preambleLength:l.preamble});c.set(t,(c.get(t)??0)+s),u+=s}}const h=r.map(t=>{let s;return s="airtime"===e?u>0?(c.get(t.key)??0)/u:0:m>0?(o.get(t.key)??0)/m:0,{key:t.key,label:t.label,value:s,color:Ee(t.typeNum)}});return{timestamp:(a+n)/2,timeLabel:s,items:h}},[v,P,L,t,r,e,l]);return C&&0!==C.count?a.jsxs("div",{className:"flex flex-col h-full",children:[a.jsxs("div",{className:"flex-1 min-h-0 relative",children:[a.jsx("div",{className:"absolute inset-0 rounded-lg overflow-hidden",children:a.jsx(x,{scatterData:C,yAxisMode:"share"===e?"share":"airtime",onHover:F,noiseFloorAnomalies:c,showNoiseFloorOverlay:m,overlayOpacity:u,highlightedType:k,timeRangeHours:M,yAxisMaxOverride:f,dotSize:b,dotOpacity:j,startTs:n,endTs:i})}),L&&a.jsx("div",{className:"absolute top-1 right-1 px-2 py-0.5 bg-elevated/90 rounded type-data-xs text-sys-indigo pointer-events-none",children:L}),h&&p&&a.jsxs("div",{className:"absolute bottom-0.5 left-0 right-0 flex justify-between pointer-events-none type-data-xs text-fg-muted/60",style:{paddingLeft:g},children:[a.jsx("span",{children:h}),a.jsx("span",{children:p})]})]}),a.jsx("div",{style:{minHeight:y},children:a.jsx(Ce,{sortedTypes:r,highlightedType:k,onTypeHover:S,aggregateShares:o,hoverData:R})})]}):a.jsxs("div",{className:"h-full flex items-center justify-center text-fg-muted",children:[a.jsx(O,{className:"w-6 h-6 mr-2 opacity-50"}),a.jsx("span",{children:"No packet data available"})]})}function Be({mode:e,onChange:t}){return a.jsxs("div",{className:"toggle-group toggle-group-sm",children:[a.jsx("button",{onClick:()=>t("share"),className:"toggle-group-item "+("share"===e?"active":""),children:"Total"}),a.jsx("button",{onClick:()=>t("airtime"),className:"toggle-group-item "+("airtime"===e?"active":""),children:"Airtime"})]})}function Oe({smoothing:e,onChange:t}){return a.jsxs("div",{className:"toggle-group toggle-group-sm",children:[a.jsx("button",{onClick:()=>t("stats"),className:"toggle-group-item "+("stats"===e?"active":""),title:"Statistics view (scatter plot)",children:a.jsx(je,{className:"w-3.5 h-3.5"})}),a.jsx("button",{onClick:()=>t("trend"),className:"toggle-group-item "+("trend"===e?"active":""),title:"Trend line chart",children:a.jsx(fe,{className:"w-3.5 h-3.5"})}),a.jsx("button",{onClick:()=>t("ema"),className:"toggle-group-item "+("ema"===e?"active":""),title:"Stacked area (moderate smoothing)",children:a.jsx(O,{className:"w-3.5 h-3.5"})}),a.jsx("button",{onClick:()=>t("ultra"),className:"toggle-group-item "+("ultra"===e?"active":""),title:"Stacked area (heavy smoothing)",children:a.jsx(ve,{className:"w-3.5 h-3.5"})}),a.jsx("button",{onClick:()=>t("mosaic"),className:"toggle-group-item "+("mosaic"===e?"active":""),title:"Mosaic view (treemap)",children:a.jsx(be,{className:"w-3.5 h-3.5"})})]})}function qe({enabled:e,onChange:t,anomalyCount:s=0,showTuning:n=!1,onTuningChange:i}){return a.jsxs("div",{className:"relative inline-flex items-center gap-1",children:[e&&i&&a.jsx("button",{onClick:()=>i(!n),className:"toggle-group toggle-group-sm "+(n?"active":""),title:n?"Hide tuning panel":"Show tuning panel",children:a.jsx("span",{className:"toggle-group-item "+(n?"active":""),children:a.jsx(pe,{className:"w-3.5 h-3.5"})})}),a.jsx("button",{onClick:()=>t(!e),className:"toggle-group toggle-group-sm "+(e?"active":""),title:e?"Hide noise floor anomalies":"Show noise floor anomalies",children:a.jsx("span",{className:"toggle-group-item "+(e?"active":""),children:a.jsx(ee,{className:"w-3.5 h-3.5"})})}),s>0&&a.jsx("span",{className:"absolute -top-2 -right-2 min-w-[18px] h-[18px] px-1 rounded-full bg-sys-red text-white text-xs font-bold flex items-center justify-center pointer-events-none z-10",children:s>99?"99+":s})]})}const We=[{target:"PacketAnalyzer",fn:"type",minStage:1},{target:"PacketAnalyzer",fn:"airtime",minStage:1,when:G}];V(We);const Ie={sf:10,bw:25e4,cr:5,preamble:8};function Ge(e,t){const s=new Date(1e3*e),a=e=>e.toString().padStart(2,"0"),n=`${a(s.getHours())}:${a(s.getMinutes())}`;return t<=24?n:`${["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][s.getMonth()]} ${s.getDate()} ${n}`}function Ve(e){return r[e]??`TYPE_${e.toString(16).toUpperCase()}`}function Xe(e,t,s,a){const n=2*a+1;let i=0;for(let l=0;l<=a;l++)i+=e[Math.min(l,s-1)];for(let l=0;l<a;l++)i+=e[0];for(let l=0;l<s;l++){t[l]=i/n;const r=l-a,o=l+a+1;i-=e[Math.max(0,Math.min(r,s-1))],i+=e[Math.max(0,Math.min(o,s-1))]}}const Ye={ema:1800,ultra:14400},Ke={ema:"sma",ultra:"gaussian"};function Ue(e,t,s){const a=Ye[e],n=Ke[e]??"sma";if(!a)return{sigma:0,window:1,handleSize:0};let i=Math.round(a/t);i=Math.max(3,Math.min(i,Math.floor(s/3))),i%2==0&&(i+=1);const l="gaussian"===n?Math.ceil(i*Math.sqrt(4/12)*3):Math.ceil(i/2);return"gaussian"===n?{sigma:i*Math.sqrt(4/12),window:i,handleSize:l}:{sigma:0,window:i,handleSize:l}}const Qe=s.memo(function({packets:e,allPackets:t,startTs:n,endTs:i,parentStartTs:r,parentEndTs:o,bucketCount:m,radioConfig:u=Ie,mode:h="share",smoothing:x="stats",noiseFloorAnomalies:f=null,showNoiseFloorOverlay:y=!1,overlayOpacity:b=.5,dotSize:j,dotOpacity:v}){I(We);const N=p(),[k,w]=s.useState(null),[M,S]=s.useState(null),[C,T]=s.useState([]),A=s.useRef(null),F=s.useRef(0);s.useEffect(()=>{const t=Math.abs(e.length-F.current);if(0===t&&C.length>0)return;A.current&&clearTimeout(A.current);const s=t>100?50:500;return A.current=setTimeout(()=>{F.current=e.length,T(e)},s),()=>{A.current&&clearTimeout(A.current)}},[e,C.length]);const P=s.useMemo(()=>function(e,t){const s=new Map;for(const n of e){const e=n.type??n.payload_type??-1,a=d(n,{spreadingFactor:t.sf,bandwidthHz:t.bw,codingRate:t.cr,preambleLength:t.preamble}),i=s.get(e)??{count:0,airtime:0};s.set(e,{count:i.count+1,airtime:i.airtime+a})}const a=[];for(const[n,i]of s)a.push({typeNum:n,key:`TYPE_${n}`,label:Ve(n),totalCount:i.count,totalAirtime:i.airtime});return a.sort((e,t)=>t.totalCount-e.totalCount)}(C,u),[C,u]),L=s.useMemo(()=>{if("ema"!==x&&"ultra"!==x)return 0;const e=(i-n)/m,{handleSize:t}=Ue(x,e,m);return t},[x,n,i,m]),R=s.useMemo(()=>function(e,t,s,a,n,i,l=0){const r=s-t,o=r/a,c=1e3*o,m=r/3600,u=t-l*o,h=s+l*o,x=a+2*l,p=[];for(let d=0;d<x;d++){const e=u+d*o,t=new Date(1e3*e),s={timestamp:e,time:m>24?t.toLocaleDateString([],{weekday:"short",hour:"2-digit",minute:"2-digit",hour12:!1}):t.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hour12:!1}),counts:{},shares:{},airtimes:{},total:0,totalAirtime:0,bucketDurationMs:c};for(const a of i)s.counts[a.key]=0,s.airtimes[a.key]=0;p.push(s)}for(const g of e){const e=g.timestamp;if(e<u||e>=h)continue;const t=Math.min(Math.floor((e-u)/o),x-1),s=`TYPE_${g.type??g.payload_type??-1}`;p[t].counts[s]=(p[t].counts[s]??0)+1,p[t].total++;const a=d(g,{spreadingFactor:n.sf,bandwidthHz:n.bw,codingRate:n.cr,preambleLength:n.preamble});p[t].airtimes[s]=(p[t].airtimes[s]??0)+a,p[t].totalAirtime+=a}for(const d of p)for(const e of i)d.shares[e.key]=d.total>0?d.counts[e.key]/d.total*100:0;return{buckets:p,visibleStart:l,visibleEnd:l+a}}(C,n,i,m,u,P,L),[C,n,i,m,u,P,L]),D=s.useMemo(()=>P.reduce((e,t)=>e+t.totalCount,0),[P]),$=s.useMemo(()=>P.reduce((e,t)=>e+t.totalAirtime,0),[P]),{sortedTypes:_,aggregateShares:E}=s.useMemo(()=>{const e=new Map,t="share"===h?D:$;if(t>0)for(const s of P){const a="share"===h?s.totalCount:s.totalAirtime;e.set(s.key,a/t)}return{sortedTypes:[...P].sort((t,s)=>(e.get(s.key)??0)-(e.get(t.key)??0)),aggregateShares:e}},[P,D,$,h]),z=s.useMemo(()=>function(e,t,s,a="ultra",n,i,l){var r;const{buckets:o,visibleStart:c,visibleEnd:d}=e,m=o.length,u=s.length,h=d-c;if(0===m||0===u)return[];const x=l&&void 0!==n&&void 0!==i?(i-n)/l:(null==(r=o[0])?void 0:r.bucketDurationMs)?o[0].bucketDurationMs/1e3:240,p=Array.from({length:u},()=>new Array(m).fill(0));for(let N=0;N<m;N++){const e=o[N];if("share"===t){if(e.total>0)for(let t=0;t<u;t++)p[t][N]=(e.counts[s[t].key]??0)/e.total}else{let t=0;for(let a=0;a<u;a++)t+=e.airtimes[s[a].key]??0;if(t>0)for(let a=0;a<u;a++)p[a][N]=(e.airtimes[s[a].key]??0)/t}}const{sigma:g,window:f}=Ue(a,x,h);let y;y=g>0?p.map(e=>function(e,t){const s=e.length;if(0===s)return[];if(t<.5)return[...e];const a=Math.sqrt(12*t*t/3+1);let n=Math.floor(a);n%2==0&&n--;const i=n+2,l=(12*t*t-3*n*n-12*n-9)/(-4*n-4),r=Math.round(l),o=[r>0?n:i,r>1?n:i,r>2?n:i];let c=new Float32Array(e);const d=new Float32Array(s);for(const m of o){Xe(c,d,s,(m-1)/2);const e=c;c=d,d.set(e)}return Array.from(c)}(e,g)):p.map(e=>function(e,t){if(0===e.length)return[];if(t<=1)return[...e];const s=e.length,a=new Float32Array(s),n=Math.floor(t/2);let i=0,l=0;for(let r=0;r<=Math.min(n,s-1);r++)i+=e[r],l++;for(let r=0;r<s;r++){a[r]=i/l;const t=r-n,o=r+n+1;t>=0&&(i-=e[t],l--),o<s&&(i+=e[o],l++)}return Array.from(a)}(e,f));for(let N=0;N<m;N++){let e=0;for(let t=0;t<u;t++)y[t][N]=Math.max(0,y[t][N]),e+=y[t][N];if(e>0){const t=1/e;for(let e=0;e<u;e++)y[e][N]*=t}}const b=h>360?Math.ceil(h/360):1,j=Math.ceil(h/b),v=[];for(let N=0;N<j;N++){const e=c+N*b,t=Math.min(c+(N+1)*b,d),a=t-e,n=new Array(u).fill(0);for(let s=e;s<t;s++)for(let e=0;e<u;e++)n[e]+=y[e][s];for(let s=0;s<u;s++)n[s]/=a;let i=0;for(let s=0;s<u;s++)i+=n[s];if(i>0){const e=1/i;for(let t=0;t<u;t++)n[t]*=e}const l={timestamp:o[e].timestamp,time:o[e].time};for(let r=0;r<u;r++)l[s[r].key]=n[r];v.push(l)}return v}(R,h,_,x,n,i,m),[R,h,_,x,n,i,m]),H=s.useCallback(e=>w(e),[]),B=s.useCallback(e=>S(e),[]),q=s.useCallback(e=>w(e),[]),W=s.useMemo(()=>{if(null===M||!z[M])return null;const e=z[M];return{timestamp:e.timestamp,timeLabel:e.time,items:_.map(t=>({key:t.key,label:t.label,value:e[t.key]??0,color:l(t.typeNum)}))}},[M,z,_]),G=s.useMemo(()=>({timestamps:z.map(e=>e.timestamp),series:_.map(e=>({key:e.key,label:e.label,color:l(e.typeNum),values:z.map(t=>t[e.key]??0)}))}),[z,_]),V=t&&void 0!==r&&void 0!==o&&(n!==r||i!==o),X=s.useMemo(()=>{if(V&&t&&void 0!==r&&void 0!==o)return function(e,t,s,a,n){const i=Math.max(1,Math.ceil((s-t)/300));if("airtime"===a){const a=new Float64Array(i);for(const r of e){const e=r.timestamp;e<t||e>=s||(a[Math.min(Math.floor((e-t)/300),i-1)]+=d(r,{spreadingFactor:n.sf,bandwidthHz:n.bw,codingRate:n.cr,preambleLength:n.preamble}))}let l=0;for(let e=0;e<i;e++){const t=a[e]/3e5*100;t>l&&(l=t)}return Math.max(1,Math.ceil(1.1*l))}{let a=0;for(const n of e){const e=n.timestamp;if(e<t||e>=s)continue;const i=c(n);i>a&&(a=i)}return a<=200?200:50*Math.ceil(1.1*a/50)}}(t,r,o,h,u)},[V,t,r,o,h,u]);if(0===C.length)return 0===e.length?a.jsxs("div",{className:"h-full flex items-center justify-center text-fg-muted",children:[a.jsx(O,{className:"w-6 h-6 mr-2 opacity-50"}),a.jsx("span",{children:"No packet data available"})]}):null;if("mosaic"===x)return a.jsx(De,{sortedTypes:_,aggregateShares:E,mode:h});const Y=(i-n)/3600,K=Ge(n,Y),U=Ge(i,Y);return"stats"===x?a.jsx(He,{mode:h,packets:C,startTs:n,endTs:i,radioConfig:u,sortedTypes:_,aggregateShares:E,noiseFloorAnomalies:f,showNoiseFloorOverlay:y,overlayOpacity:b,startLabel:K,endLabel:U,yAxisPad:28,lockedYMax:X,legendMinH:80,dotSize:j,dotOpacity:v}):"trend"===x?a.jsx(_e,{packets:C,mode:h,startTs:n,endTs:i,radioConfig:u,bucketCount:m,lockedYMax:X,legendMinH:80}):a.jsxs("div",{className:"flex flex-col h-full",children:[a.jsxs("div",{className:"flex-1 min-h-0 relative",children:[a.jsx("div",{className:"absolute inset-0 rounded-lg overflow-hidden",children:a.jsx(g,{timestamps:G.timestamps,series:G.series,highlightedKey:k,cursorColor:N.cursor,onHover:B,onSeriesHover:q,overlayLine:null,startTs:n,endTs:i})}),a.jsxs("div",{className:"absolute bottom-0.5 left-0 right-0 flex justify-between pointer-events-none type-data-xs text-fg-muted/60",style:{paddingLeft:32},children:[a.jsx("span",{children:K}),a.jsx("span",{children:U})]})]}),a.jsx("div",{style:{minHeight:80},children:a.jsx(Ce,{sortedTypes:_,highlightedType:k,onTypeHover:H,aggregateShares:E,hoverData:W})})]})}),Je={"1x":1,"2x":2,"4x":4,"8x":8,"16x":16,"36x":36},Ze=[1,5,10,25,50,100,150],et=22.5*Math.PI/180,tt=Math.sin(et),st=Math.cos(et);function at(e,t,s,a){const n=Math.PI/180,i=(a-t)*n,l=e*n,r=s*n,o=Math.sin(i)*Math.cos(r),c=Math.cos(l)*Math.sin(r)-Math.sin(l)*Math.cos(r)*Math.cos(i);return(180*Math.atan2(o,c)/Math.PI+360)%360}function nt(e,t,s,a){const n=Math.PI/180,i=(s-e)*n,l=(a-t)*n,r=Math.sin(i/2)**2+Math.cos(e*n)*Math.cos(s*n)*Math.sin(l/2)**2;return 12742*Math.atan2(Math.sqrt(r),Math.sqrt(1-r))}const it=[{min:10,label:"Excellent"},{min:7,label:"Very Good"},{min:4,label:"Good"},{min:1,label:"Fair+"},{min:-2,label:"Fair"},{min:-5,label:"Fair-"},{min:-8,label:"Poor"},{min:-11,label:"Bad"},{min:-1/0,label:"Critical"}];function lt(e,t){return t[N(e)]||"#808080"}const rt=s.memo(function({neighbors:e,quickNeighbors:t,localLat:n,localLon:i,onStatsChange:l,title:r,badge:c,stats:d}){const[m,h]=s.useState(null),[x,p]=s.useState(new Set),[g,N]=s.useState({width:0,height:0}),[k,w]=s.useState("1x"),[M,S]=s.useState(1),C=s.useRef(null),T=s.useRef({}),A=s.useRef(null),F=s.useRef(M);F.current=M;const P=f(),L=y(),R=b(),D=j(),$=o(),_=D?R.primary:R.secondary,E=D?.15:.4,z=D?.08:.25,H=D?$.blue:R.primary;s.useEffect(()=>{const e=A.current;if(!e)return;const t=new ResizeObserver(e=>{for(const t of e){const{width:e,height:s}=t.contentRect;e>0&&s>0&&N({width:e,height:s})}});t.observe(e);const s=e.getBoundingClientRect();return s.width>0&&s.height>0&&N({width:s.width,height:s.height}),()=>t.disconnect()},[]);const B=s.useMemo(()=>{const e=new Set;if(t)for(const s of t)e.add(s.hash);return e},[t]),O=s.useMemo(()=>{const e=new Map;if(t)for(const s of t)e.set(s.hash,{snr:s.avgSnr,rssi:s.avgRssi});return e},[t]),{processedNeighbors:q,maxDistance:W,totalNeighbors:I,zeroHopCount:G}=s.useMemo(()=>{const t=[];for(const[a,l]of Object.entries(e)){if(!l.latitude||!l.longitude||0===l.latitude||0===l.longitude)continue;if(!B.has(a))continue;const e=at(n,i,l.latitude,l.longitude),s=nt(n,i,l.latitude,l.longitude),r=O.get(a);t.push({hash:a.slice(0,8),name:l.node_name||l.name||"Unknown",snr:(null==r?void 0:r.snr)??l.snr??null,rssi:(null==r?void 0:r.rssi)??l.rssi??null,bearing:e,distance:s,normalizedDistance:0,lastSeen:l.last_seen,isZeroHop:!0})}const s=1.08*(t.length>0?Math.max(...t.map(e=>e.distance)):0);return t.sort((e,t)=>(e.snr??-1/0)-(t.snr??-1/0)),{processedNeighbors:t,maxDistance:s,totalNeighbors:t.length,zeroHopCount:t.length}},[e,n,i,B,O]);s.useEffect(()=>{null==l||l({zeroHopCount:G,totalCount:I,maxDistanceKm:W})},[G,I,W]),s.useEffect(()=>{const e=Je[k],t=F.current;C.current&&cancelAnimationFrame(C.current);const s=performance.now(),a=n=>{const i=n-s,l=Math.min(i/400,1),r=Y(l);S(t+(e-t)*r),C.current=l<1?requestAnimationFrame(a):null};return C.current=requestAnimationFrame(a),()=>{C.current&&cancelAnimationFrame(C.current)}},[k]);const V=W/M,K=s.useMemo(()=>Ze.filter(e=>e<=1.1*V),[V]);s.useEffect(()=>{const e=[];for(const s of q){const t=T.current[s.hash];void 0!==t&&t!==s.lastSeen&&e.push(s.hash),T.current[s.hash]=s.lastSeen}if(0===e.length)return;queueMicrotask(()=>{p(t=>new Set([...t,...e]))});const t=setTimeout(()=>{p(t=>{const s=new Set(t);return e.forEach(e=>s.delete(e)),s})},600);return()=>clearTimeout(t)},[q]);const U=0!==n&&0!==i,Q=s.useMemo(()=>{const{width:e,height:t}=g,s=e/2,a=t/2,n=Math.min(e,t),i=Math.max(10,n/2-6);return{width:e,height:t,centerX:s,centerY:a,radius:Math.max(10,i-8),labelRadius:i}},[g]),{width:J,height:Z,centerX:ee,centerY:te,radius:se,labelRadius:ae}=Q,ne=s.useId(),ie=s.useCallback((e,t)=>{const s=e*Math.PI/180;return{x:ee+se*t*Math.sin(s),y:te-se*t*Math.cos(s)}},[ee,te,se]),le=s.useCallback(e=>{const t={N:0,NE:45,E:90,SE:135,S:180,SW:225,W:270,NW:315}[e]*Math.PI/180;return{x:ee+ae*Math.sin(t),y:te-ae*Math.cos(t)}},[ee,te,ae]),re=s.useCallback(e=>{h(e)},[]),oe=s.useCallback(e=>{w(e)},[]),ce=s.useCallback(e=>W<=0?0:e/W*M,[W,M]),de=e=>`${e}km`,me=s.useMemo(()=>{const e=[{x:ee,y:te-ae},{x:ee+ae*Math.SQRT1_2,y:te-ae*Math.SQRT1_2}],t=K.map(e=>{const t=e/W*M;return{km:e,scale:t,lx:ee+se*t*tt,ly:te-se*t*st}}).filter(e=>e.scale<=1.05&&e.scale>=.02).sort((e,t)=>t.km-e.km),s=[];for(const a of t){const t=s.some(e=>{const t=e.lx-a.lx,s=e.ly-a.ly;return Math.sqrt(t*t+s*s)<28}),n=e.some(e=>{const t=e.x-a.lx,s=e.y-a.ly;return Math.sqrt(t*t+s*s)<28});t||n||s.push(a)}return s},[K,W,M,ee,te,se,ae]),ue=g.width>0&&g.height>0;return U?0===I?a.jsxs("div",{ref:A,className:"flex flex-col items-center justify-center h-full text-fg-secondary",children:[a.jsx(X,{className:"w-8 h-8 mb-2 opacity-50"}),a.jsx("p",{children:"No nodes with location data"})]}):a.jsxs("div",{className:"flex h-full w-full overflow-visible",children:[a.jsxs("div",{ref:A,className:"relative flex-1 min-w-0 h-full overflow-visible -ml-4 sm:-ml-5",children:[ue&&a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"absolute neomorphic-outer-soft",style:{left:ee-se-8-4,top:te-se-8-4,width:2*(se+8)+8,height:2*(se+8)+8,borderRadius:"50%",padding:4,boxSizing:"border-box"}}),a.jsxs("svg",{width:J,height:Z,className:"absolute inset-0 z-0",style:{overflow:"visible"},children:[a.jsxs("defs",{children:[a.jsx("style",{children:"\n                @keyframes neighbor-blink-scale {\n                  0%, 100% {\n                    transform: scale(1);\n                    opacity: 0;\n                  }\n                  50% {\n                    transform: scale(1.3);\n                    opacity: 0.8;\n                  }\n                }\n                .neighbor-blink-ring {\n                  transform-origin: center;\n                  animation: neighbor-blink-scale 600ms ease-out forwards;\n                }\n              "}),a.jsx("clipPath",{id:ne,children:a.jsx("circle",{cx:ee,cy:te,r:se})})]}),(()=>{const e=se+8+12,t=D?"rgba(255, 255, 255, 0.12)":"rgba(0, 0, 0, 0.15)",s=D?"rgba(59, 130, 246, 0.4)":"rgba(59, 130, 246, 0.5)",n=[45,135,225,315];return a.jsxs("g",{className:"radar-frame","aria-hidden":"true",children:[a.jsx("circle",{cx:ee,cy:te,r:e,fill:"none",stroke:t,strokeWidth:1,strokeDasharray:"2 6"}),n.map(t=>{const n=t*Math.PI/180,i=Math.cos(n),l=Math.sin(n),r=e+4,o=e+4+16,c=ee+r*l,d=te-r*i,m=ee+o*l,u=te-o*i;return a.jsxs("g",{children:[a.jsx("line",{x1:c,y1:d,x2:m,y2:u,stroke:s,strokeWidth:1}),a.jsx("line",{x1:m-4*i,y1:u-4*l,x2:m+4*i,y2:u+4*l,stroke:s,strokeWidth:1})]},`corner-${t}`)}),[0,90,180,270].map(s=>{const n=s*Math.PI/180,i=ee+(e-6)*Math.sin(n),l=te-(e-6)*Math.cos(n),r=ee+(e+2)*Math.sin(n),o=te-(e+2)*Math.cos(n);return a.jsx("line",{x1:i,y1:l,x2:r,y2:o,stroke:t,strokeWidth:1},`tick-cardinal-${s}`)}),n.map(s=>{const n=s*Math.PI/180,i=ee+(e-4)*Math.sin(n),l=te-(e-4)*Math.cos(n),r=ee+(e+1)*Math.sin(n),o=te-(e+1)*Math.cos(n);return a.jsx("line",{x1:i,y1:l,x2:r,y2:o,stroke:t,strokeWidth:1},`tick-intercardinal-${s}`)})]})})(),K.map(e=>{const t=ce(e);if(t>1.05||t<.02)return null;const s=me.some(t=>t.km===e),n=ee+se*t*tt,i=te-se*t*st;return a.jsxs("g",{children:[a.jsx("circle",{cx:ee,cy:te,r:se*t,fill:"none",stroke:_,strokeOpacity:E,strokeWidth:1}),s&&a.jsx("text",{x:n+4,y:i-2,textAnchor:"start",dominantBaseline:"auto",fill:R.secondary,fontSize:10,fontFamily:v,children:de(e)})]},`ring-${e}`)}),["N","E","S","W"].map(e=>{const t={N:0,E:90,S:180,W:270}[e]*Math.PI/180;return a.jsx("line",{x1:ee,y1:te,x2:ee+se*Math.sin(t),y2:te-se*Math.cos(t),stroke:_,strokeOpacity:E,strokeWidth:1,strokeDasharray:"4 4"},e)}),["NE","SE","SW","NW"].map(e=>{const t={NE:45,SE:135,SW:225,NW:315}[e]*Math.PI/180;return a.jsx("line",{x1:ee,y1:te,x2:ee+se*Math.sin(t),y2:te-se*Math.cos(t),stroke:_,strokeOpacity:z,strokeWidth:1,strokeDasharray:"4 4"},`diag-${e}`)}),["N","E","S","W"].map(e=>{const t=le(e),s="E"===e?"end":"W"===e?"start":"middle",n="N"===e?"hanging":"S"===e?"auto":"middle";return a.jsx("text",{x:t.x,y:t.y,textAnchor:s,dominantBaseline:n,fill:H,fontSize:10,fontWeight:700,fontFamily:v,"aria-hidden":"true",children:e},e)}),["NE","SE","SW","NW"].map(e=>{const t=le(e),s="NE"===e||"SE"===e?"end":"start",n="NE"===e||"NW"===e?"hanging":"auto";return a.jsx("text",{x:t.x,y:t.y,textAnchor:s,dominantBaseline:n,fill:H,fontSize:9,fontWeight:600,fontFamily:v,"aria-hidden":"true",children:e},e)}),a.jsx("circle",{cx:ee,cy:te,r:5,fill:L.chart6,stroke:D?"rgba(255,255,255,0.3)":"rgba(0,0,0,0.2)",strokeWidth:1,role:"img","aria-label":"Local node"}),a.jsx("g",{clipPath:`url(#${ne})`,children:q.map(e=>{const t=W>0?e.distance/W*M:0;if(t>1)return null;const{x:s,y:n}=ie(e.bearing,t),i=null!==e.snr?lt(e.snr,P):"#808080",l=(null==m?void 0:m.hash)===e.hash,r=x.has(e.hash);return a.jsxs("g",{role:"img","aria-label":`${e.name}: ${e.distance.toFixed(1)}km ${e.bearing.toFixed(0)}°`,children:[r&&a.jsx("circle",{cx:s,cy:n,r:10.5,fill:"none",stroke:D?"rgba(255,255,255,0.9)":"rgba(0,0,0,0.7)",strokeWidth:2,className:"neighbor-blink-ring"}),l&&a.jsx("circle",{cx:s,cy:n,r:10.5,fill:i,opacity:.3}),a.jsx("circle",{cx:s,cy:n,r:l?7:5,fill:i,stroke:D?"rgba(0,0,0,0.5)":"rgba(0,0,0,0.25)",strokeWidth:1,style:{cursor:"pointer",transition:"r 0.15s"},onMouseEnter:()=>re(e),onMouseLeave:()=>re(null)})]},e.hash)})})]})]}),m&&a.jsxs("div",{className:"absolute bg-tooltip-bg border border-edge-subtle rounded-lg px-3 py-2 text-sm pointer-events-none z-10 shadow-xl",style:{left:"50%",bottom:8,transform:"translateX(-50%)"},children:[a.jsx("div",{className:"font-medium text-fg-primary",children:m.name}),a.jsx("div",{className:"type-data-xs text-fg-secondary",children:m.hash}),null!==m.snr?a.jsx("div",{className:"flex gap-3 mt-1 text-xs",children:a.jsxs("span",{children:[a.jsx("span",{className:"text-fg-secondary",children:"SNR:"})," ",a.jsxs("span",{className:"tabular-nums",style:{color:lt(m.snr,P)},children:[m.snr.toFixed(1)," dB"]}),a.jsxs("span",{className:"text-fg-secondary ml-1",children:["(",(he=m.snr,(null==(xe=it.find(e=>he>=e.min))?void 0:xe.label)??"Critical"),")"]})]})}):a.jsx("div",{className:"text-xs text-fg-secondary mt-1",children:"No SNR data"}),a.jsxs("div",{className:"flex gap-3 text-xs",children:[a.jsxs("span",{children:[a.jsx("span",{className:"text-fg-secondary",children:"Distance:"})," ",a.jsxs("span",{className:"tabular-nums text-fg-primary",children:[m.distance.toFixed(2)," km"]})]}),a.jsxs("span",{children:[a.jsx("span",{className:"text-fg-secondary",children:"Bearing:"})," ",a.jsxs("span",{className:"tabular-nums text-fg-primary",children:[m.bearing.toFixed(0),"°"]})]})]})]})]}),a.jsxs("div",{className:"flex flex-col gap-1 px-2 py-2 flex-shrink-0 neomorphic-outer-soft rounded-l-[12px] rounded-r-none self-stretch",children:[r&&a.jsxs("div",{className:"flex flex-col items-center gap-1 pb-2 border-b border-edge-subtle mb-1",children:[a.jsx("span",{className:"icon-md flex items-center justify-center text-icon-card-title",children:a.jsx(X,{className:"w-4 h-4"})}),a.jsx("span",{className:"type-micro text-center text-[10px] leading-tight",children:r}),c&&a.jsx(u,{color:"zinc",children:c})]}),a.jsx("div",{className:"flex flex-col gap-1 flex-1",role:"group","aria-label":"Zoom level",children:["1x","2x","4x","8x","16x","36x"].map(e=>a.jsx("button",{onClick:()=>oe(e),"aria-pressed":k===e,className:"flex flex-1 items-center justify-center min-w-[44px] sm:min-w-[32px] text-xs font-medium radius-inner transition-colors "+(k===e?"bg-sys-blue/20 text-sys-blue":"bg-subtle-fill/80 text-fg-secondary hover:bg-subtle-fill-strong hover:text-fg-primary"),children:e},e))})]})]}):a.jsxs("div",{ref:A,className:"flex flex-col items-center justify-center h-full text-fg-secondary",children:[a.jsx(X,{className:"w-8 h-8 mb-2 opacity-50"}),a.jsx("p",{children:"Local node coordinates not configured"}),a.jsx("p",{className:"text-xs mt-1",children:"Set latitude/longitude in config to enable"})]});var he,xe}),ot={repeater:"var(--sys-blue)",companion:"var(--sys-cyan)",room_server:"var(--sys-indigo)"};function ct(e){if(e.contact_type){const t=e.contact_type.toLowerCase();if("repeater"===t||"rep"===t)return"repeater";if("room server"===t||"room_server"===t||"room"===t||"server"===t)return"room_server";if("companion"===t||"client"===t||"cli"===t)return"companion"}return e.is_repeater?"repeater":"companion"}const dt=s.memo(function({neighbors:e}){const t=s.useMemo(()=>{const t={repeater:0,companion:0,room_server:0};for(const a of Object.values(e)){const e=ct(a);t[e]=(t[e]||0)+1}const s=Object.values(t).reduce((e,t)=>e+t,0);return{items:[{label:"Repeaters",count:t.repeater,percent:0,color:ot.repeater},{label:"Companions",count:t.companion,percent:0,color:ot.companion},{label:"Room Servers",count:t.room_server,percent:0,color:ot.room_server}].map(e=>({...e,percent:s>0?e.count/s*100:0})).filter(e=>e.count>0).sort((e,t)=>t.count-e.count),total:s}},[e]);return 0===t.total?a.jsx("div",{className:"h-full flex items-center justify-center text-fg-muted type-body-sm",children:"No neighbors discovered yet"}):a.jsxs("div",{className:"h-full flex flex-col",children:[a.jsx("div",{className:"flex-1 flex flex-col justify-evenly",children:t.items.map(e=>a.jsxs("div",{className:"flex flex-col gap-1.5",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsx("span",{className:"type-data-sm text-fg-secondary",children:e.label}),a.jsxs("span",{className:"type-data-sm text-fg-secondary tabular-nums",children:[e.count," ",a.jsxs("span",{className:"text-fg-secondary/60",children:["(",e.percent.toFixed(0),"%)"]})]})]}),a.jsx("div",{className:"h-2.5 bg-elevated overflow-hidden",children:a.jsx("div",{className:"h-full transition-all duration-500 ease-out",style:{width:`${e.percent}%`,backgroundColor:e.color,minWidth:e.count>0?"4px":"0"}})})]},e.label))}),a.jsxs("div",{className:"flex items-center justify-between pt-2 border-t border-edge-subtle",children:[a.jsx("span",{className:"type-data-xs text-fg-secondary",children:"Total Nodes"}),a.jsx("span",{className:"type-data-sm text-fg-primary font-medium tabular-nums",children:t.total})]})]})});function mt({children:e,minHeight:t="100%",rootMargin:n="200px 0px",keepMounted:i=!0,className:l=""}){const r=s.useRef(null),[o,c]=s.useState(!1),[d,m]=s.useState(!1);s.useEffect(()=>{const e=r.current;if(!e)return;const t=new IntersectionObserver(([e])=>{const t=e.isIntersecting;m(t),t&&c(!0)},{rootMargin:n,threshold:0});return t.observe(e),()=>{t.disconnect()}},[n]);const u=d||i&&o;return a.jsx("div",{ref:r,className:`h-full w-full ${l}`,style:{minHeight:t},children:u?e:a.jsx("div",{className:"h-full w-full flex items-center justify-center text-fg-muted/50",children:a.jsx("div",{className:"animate-pulse text-xs",children:"Loading chart..."})})})}const ut=[{target:"DisambiguationCard",fn:"disambiguation.collisions",minStage:2}];V(ut);const ht={excellent:"text-signal-excellent",good:"text-signal-good",fair:"text-signal-fair",poor:"text-sys-blue"},xt={excellent:"bg-signal-excellent/10",good:"bg-signal-good/10",fair:"bg-signal-fair/10",poor:"bg-sys-blue/10"};function pt(){I(ut);const e=k(),t=w(),[n,i]=s.useState(null),l=s.useCallback((e,t)=>{i({prefix:e,candidateHashes:t})},[]),r=s.useCallback(()=>{i(null)},[]);if(!t)return a.jsxs(K,{neomorphic:!0,children:[a.jsx(ae,{icon:a.jsx(ie,{}),title:"Prefix Conflicts"}),a.jsx("div",{className:"flex-1 flex items-center justify-center",children:a.jsxs("div",{className:"text-center text-fg-secondary",children:[a.jsx(M,{className:"w-8 h-8 mx-auto mb-2 opacity-50"}),a.jsx("p",{className:"type-data-xs",children:"No topology data available"}),a.jsx("p",{className:"type-data-xs opacity-70",children:"Run deep analysis to see stats"})]})})]});const o=(c=e.avgConfidence)>=.9?"excellent":c>=.7?"good":c>=.5?"fair":"poor";var c;const d=(m=e.collisionRate)<=10?"excellent":m<=25?"good":"poor";var m;const h="poor"===o||"poor"===d?"poor":"fair"===o||"fair"===d?"fair":"good"===o||"good"===d?"good":"excellent",x="excellent"===h||"good"===h?ye:le;return a.jsxs(K,{neomorphic:!0,className:"flex flex-col overflow-hidden",children:[a.jsx(ae,{icon:a.jsx(ie,{}),title:"Prefix Conflicts",badgeColor:"zinc",actions:"poor"===h?a.jsxs(u,{color:"red",children:[a.jsx(le,{className:"w-3 h-3"}),"Needs Attention"]}):a.jsxs("div",{className:`flex items-center gap-1.5 px-2.5 py-1 rounded-full ${xt[h]}`,children:[a.jsx(x,{className:`w-3.5 h-3.5 ${ht[h]}`}),a.jsx("span",{className:`type-data-xs font-medium ${ht[h]}`,children:"excellent"===h?"Excellent":"good"===h?"Good":"Fair"})]})}),a.jsxs("div",{className:"flex-1 flex flex-col min-h-0",children:[a.jsxs("div",{className:"flex gap-2 sm:gap-3 py-3 sm:py-4",children:[a.jsxs("div",{className:"flex-1 flex flex-col neomorphic-outer-soft radius-inner px-3 py-2.5 sm:py-3 cursor-help",title:"Total unique 2-character prefixes observed in packet paths.",children:[a.jsx("span",{className:"type-data-xl text-fg-primary",children:a.jsx(te,{value:e.totalPrefixes,priority:"low"})}),a.jsx("span",{className:"type-micro text-fg-muted mt-0.5 sm:mt-1",children:"Prefixes"})]}),a.jsxs("div",{className:"flex-1 flex flex-col neomorphic-outer-soft radius-inner px-3 py-2.5 sm:py-3 cursor-help",title:"Prefixes that map to exactly one known node. No disambiguation needed.",children:[a.jsx("span",{className:"type-data-xl text-fg-primary",children:a.jsx(te,{value:e.unambiguousPrefixes,priority:"low"})}),a.jsx("span",{className:"type-micro text-fg-muted mt-0.5 sm:mt-1",children:"Unique"})]}),a.jsxs("div",{className:"flex-1 flex flex-col neomorphic-outer-soft radius-inner px-3 py-2.5 sm:py-3 cursor-help",title:"Prefixes matching multiple known nodes. Click a prefix below to explore candidates.",children:[a.jsx("span",{className:"type-data-xl "+(e.collisionPrefixes>0?"text-sys-blue":"text-fg-primary"),children:a.jsx(te,{value:e.collisionPrefixes,priority:"low"})}),a.jsx("span",{className:"type-micro mt-0.5 sm:mt-1 "+(e.collisionPrefixes>0?"text-sys-blue":"text-fg-muted"),children:"Conflicts"})]})]}),e.highCollisionPrefixes.length>0&&a.jsxs("div",{className:"pt-2",children:[a.jsx("div",{className:"type-data-xs text-fg-secondary mb-1.5",children:"Problem Prefixes"}),a.jsx("div",{className:"flex flex-wrap gap-1.5 content-start",children:e.highCollisionPrefixes.map(({prefix:e,candidateCount:t,candidateHashes:s})=>a.jsxs("button",{type:"button",onClick:()=>l(e,s),className:"inline-flex items-center gap-0.5 group",title:`${t} candidates - click to explore`,children:[a.jsx(Z,{children:e}),a.jsxs("span",{className:"text-fg-muted type-data-xs group-hover:text-fg-secondary transition-colors",children:["×",t]})]},e))})]}),0===e.lowConfidencePrefixes.length&&0===e.collisionPrefixes&&a.jsx("div",{className:"flex-1 flex items-center",children:a.jsxs("div",{className:"flex items-center gap-1.5",children:[a.jsx(ye,{className:"w-3.5 h-3.5 text-signal-excellent"}),a.jsx("span",{className:"type-data-xs text-signal-excellent",children:"All prefixes uniquely identified"})]})}),a.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-4 mt-auto pt-1.5",children:[a.jsxs("div",{className:"flex items-center gap-2 cursor-help",title:"Average confidence score across all disambiguated prefixes. Higher = more certain node identification.",children:[a.jsx("span",{className:"type-data-xs text-fg-secondary",children:"Confidence"}),a.jsxs("span",{className:`data-box ${ht[o]}`,children:[(100*e.avgConfidence).toFixed(1),"%"]})]}),a.jsxs("div",{className:"flex items-center gap-2 cursor-help",title:"Percentage of 2-character prefixes that match multiple known nodes. Lower is better.",children:[a.jsx("span",{className:"type-data-xs text-fg-secondary",children:"Collisions"}),a.jsxs("span",{className:`data-box ${ht[d]}`,children:[e.collisionRate.toFixed(1),"%"]})]})]})]}),a.jsx(se,{isOpen:!!n,prefix:(null==n?void 0:n.prefix)||"",candidateHashes:(null==n?void 0:n.candidateHashes)||[],onClose:r})]})}const gt=[{target:"PacketHealth",fn:"type",minStage:1},{target:"PacketHealth",fn:"duplicates",minStage:1}];V(gt);const ft=new Set(["Duplicate","Empty payload","Path too long","Unknown"]),yt={excellent:"bg-status-success",good:"bg-sys-blue",fair:"bg-status-warning",poor:"bg-status-danger"};function bt({packets:e,rangeMinutes:t,rangeHours:n,timeRangeLabel:i,isLoaded:l=!0}){I(gt);const r=s.useMemo(()=>function(e,t){const s=Date.now()/1e3,a=60*t,n=s-a,i=a/24,l=new Array(24).fill(0),r=new Array(24).fill(0);let o=0,c=0,d=0,m=0;for(const h of e){if("tx_local"===h.packet_origin)continue;const e=h.timestamp;if(e<n||e>s)continue;o++;const t=Math.min(23,Math.floor((e-n)/i));r[t]++,h.transmitted||"tx_forward"===h.packet_origin?(c++,l[t]++):(h.is_duplicate||"Duplicate"===h.drop_reason)&&d++,h.drop_reason&&ft.has(h.drop_reason)&&m++}const u=[];for(let h=0;h<24;h++){const e=r[h],t=l[h];u.push({count:e>0?Math.round(t/e*100):0,timestamp:1e3*(n+h*i)})}return{totalRx:o,forwarded:c,duplicates:d,waste:m,efficiency:o>0?c/o*100:0,duplicateRate:o>0?d/o*100:0,wasteRate:o>0?m/o*100:0,sparkline:u}}(e,t),[e,t]),[o,c]=s.useState(null),d=s.useCallback(async()=>{try{const e=await S(n);e.success&&e.data&&c(e.data.count)}catch{}},[n]);s.useEffect(()=>{d()},[d]);const m=(u=r.efficiency)>=90?"excellent":u>=75?"good":u>=60?"fair":"poor";var u;const h=r.totalRx>0;return a.jsx(K,{neomorphic:!0,isLoaded:l,skeletonType:"chart",children:l&&a.jsxs(a.Fragment,{children:[a.jsx(ae,{icon:a.jsx(oe,{}),title:"Packet Health",badge:i,badgeColor:"zinc"}),a.jsx(ne,{children:a.jsxs("div",{className:"flex flex-col h-full",children:[a.jsxs("div",{className:"flex items-baseline gap-2",children:[a.jsxs("div",{className:"type-data-xl text-fg-primary",children:[h?a.jsx(te,{value:Math.round(10*r.efficiency)/10,className:"font-mono tabular-nums",priority:"medium",format:{minimumFractionDigits:1,maximumFractionDigits:1}}):a.jsx("span",{className:"opacity-30",children:"—"}),a.jsx("span",{className:"type-data-sm text-fg-muted ml-0.5",children:"%"})]}),h&&a.jsx("div",{className:`w-2 h-2 rounded-full ${yt[m]}`})]}),a.jsx("div",{className:"type-micro mb-2 cursor-help",title:"Forwarded packets / total received. CRC failures, garbled packets, and RF collisions that destroy packets before reaching software are not included in this ratio — see CRC Errors for hardware-level failures.",children:"FORWARDING RATE"}),a.jsx("div",{className:"flex-1 min-h-[28px] max-h-[48px] mb-2",children:a.jsx(re,{data:r.sparkline,width:9999,height:36,color:"var(--sys-blue)",className:"w-full"})}),a.jsxs("div",{className:"flex gap-2 sm:gap-3 mt-auto",children:[a.jsxs("div",{className:"flex-1 min-w-0",children:[a.jsx("div",{className:"data-box-label",children:"Dupes"}),a.jsx("div",{className:"data-box data-box-fill data-box-left",children:h?`${r.duplicateRate.toFixed(1)}%`:"—"})]}),a.jsxs("div",{className:"flex-1 min-w-0",children:[a.jsx("div",{className:"data-box-label",children:"Waste"}),a.jsx("div",{className:"data-box data-box-fill data-box-left",children:h?`${r.wasteRate.toFixed(1)}%`:"—"})]}),null!==o&&o>0&&a.jsxs("div",{className:"flex-1 min-w-0",children:[a.jsxs("div",{className:"data-box-label flex items-center gap-1",children:[a.jsx(le,{className:"w-3 h-3 text-status-warning"}),"CRC"]}),a.jsx("div",{className:"data-box data-box-fill data-box-left text-status-warning",children:o})]})]})]})})]})})}function jt(){var e,t,n,i,l,r,o,c,d,m,u,h,x,p,g,f,y;const b=C(),j=T(),v=A(),N=F(),k=P(),w=L(),M=null!==b&&k,S=s.useRef(!1);M&&!S.current&&(S.current=!0);const q=S.current,I=R(),G=D(),V=$(),[X,Y]=s.useState(null),[,Z]=s.useState(null),[ee]=s.useState(null),[te,se]=s.useState(()=>{const e=localStorage.getItem("statistics-view-mode");return"share"===e||"airtime"===e?e:"airtime"});s.useEffect(()=>{localStorage.setItem("statistics-view-mode",te)},[te]);const[ne,ie]=s.useState(()=>{const e=localStorage.getItem("statistics-smoothing-mode");return["ema","ultra","mosaic","stats","trend"].includes(e)?e:"stats"});s.useEffect(()=>{localStorage.setItem("statistics-smoothing-mode",ne)},[ne]);const[le,re]=s.useState(!1),[oe,pe]=s.useState(!1),[fe,ye]=s.useState(Ne),[be,je]=s.useState(.5),[ve,Se]=s.useState(ce),[Ce,Te]=s.useState(.8),[Ae,Fe]=s.useState(50),Pe=s.useMemo(()=>({0:0,1:0,2:1,3:2,4:3,5:4,6:5,7:6,8:7,9:8,10:9}[I]??3),[I]),Le=_[Pe].hours,Re=60*Le,De=_[Pe],$e=E(Le),_e=w.isBackgroundLoading,Ee=s.useCallback(e=>{G({0:1,1:2,2:3,3:4,4:5,5:6,6:7,7:8,8:9,9:10}[e]??4)},[G]),ze=s.useMemo(()=>{var e;if(!(null==(e=null==b?void 0:b.config)?void 0:e.radio))return null;const t=b.config.radio;return{sf:t.spreading_factor??10,bw:t.bandwidth??25e4,cr:t.coding_rate??5,preamble:t.preamble_length??8}},[null==(t=null==(e=null==b?void 0:b.config)?void 0:e.radio)?void 0:t.spreading_factor,null==(i=null==(n=null==b?void 0:b.config)?void 0:n.radio)?void 0:i.bandwidth,null==(r=null==(l=null==b?void 0:b.config)?void 0:l.radio)?void 0:r.coding_rate,null==(c=null==(o=null==b?void 0:b.config)?void 0:o.radio)?void 0:c.preamble_length]),He=s.useMemo(()=>0===V.length?{timestamps:[],values:[]}:{timestamps:V.map(e=>e.timestamp),values:V.map(e=>e.noise_floor_dbm)},[V]),We=s.useMemo(()=>{if(V.length<10)return{anomalies:[],debug:void 0};const e=function(e,t={}){const s={...Ne,...t};if(e.length<10)return{anomalies:[],thresholds:we([]),totalSamples:e.length,anomalySamples:0};const a=e.map(e=>e.noise_floor_dbm),n=we(a),i=[...a].sort((e,t)=>e-t);let l,r;s.useAbsoluteThresholds?(l=s.baselineDbm,r=s.spikeDbm):(l=ke(i,s.baselinePercentile),r=ke(i,s.spikePercentile));const o=[...e].sort((e,t)=>e.timestamp-t.timestamp),c=[];let d=null,m=0;for(const u of o)if(u.noise_floor_dbm>l&&u.noise_floor_dbm<r)if(m++,d){const e=Math.abs(u.noise_floor_dbm-d.rollingAvg)<=s.similarityToleranceDbm,t=u.timestamp-d.endTs<=s.mergeGapSeconds;e&&t?(d.endTs=u.timestamp,d.values.push(u.noise_floor_dbm),d.timestamps.push(u.timestamp),d.rollingAvg=d.values.reduce((e,t)=>e+t,0)/d.values.length):(d.values.length>=s.minSequenceLength&&c.push(d),d={startTs:u.timestamp,endTs:u.timestamp,values:[u.noise_floor_dbm],timestamps:[u.timestamp],rollingAvg:u.noise_floor_dbm})}else d={startTs:u.timestamp,endTs:u.timestamp,values:[u.noise_floor_dbm],timestamps:[u.timestamp],rollingAvg:u.noise_floor_dbm};else d&&d.values.length>=s.minSequenceLength&&c.push(d),d=null;return d&&d.values.length>=s.minSequenceLength&&c.push(d),0===c.length?{anomalies:[],thresholds:n,totalSamples:e.length,anomalySamples:m,debug:{baselineCutoff:l,spikeCutoff:r,midBandSamples:m}}:{anomalies:c.map(e=>{const t=Math.max(...e.values),s=e.values.reduce((e,t)=>e+t,0)/e.values.length;return{startTs:e.startTs,endTs:e.endTs,peakValue:t,avgValue:s,severity:Me(s,l,r),sampleCount:e.values.length}}),thresholds:n,totalSamples:e.length,anomalySamples:m,debug:{baselineCutoff:l,spikeCutoff:r,midBandSamples:m}}}(V,fe);return{anomalies:e.anomalies,debug:e.debug}},[V,fe]),Ie=We.anomalies,Ge=s.useMemo(()=>{const e=(null==b?void 0:b.neighbors)??{};return Object.fromEntries(Object.entries(e).filter(([e])=>!j.has(e)))},[null==b?void 0:b.neighbors,j]),Ve=s.useMemo(()=>{const e=Date.now()/1e3-3600*Le;return Object.fromEntries(Object.entries(Ge).filter(([,t])=>t.last_seen>=e))},[Ge,Le]),Xe=s.useMemo(()=>{const e=60*Re/$e,t=Math.floor(Date.now()/1e3),s=Math.floor(t/e)*e;return{start:s-60*Re,end:s}},[Re,$e]),Ye=ve.timeStart??Xe.start,Ke=ve.timeEnd??Xe.end,Ue=E((Ke-Ye)/3600),Je=ue(),Ze=s.useMemo(()=>de(N,ve,Je,Xe),[N,ve,Je,Xe]);return a.jsxs(U,{children:[a.jsx(Q,{title:"Statistics",icon:a.jsx(z,{}),controls:a.jsx(W,{ranges:_,selectedIndex:Pe,onSelect:Ee,isPending:_e})}),ee&&a.jsx(K,{className:"border border-sys-red/50 bg-sys-red/10",children:a.jsx("p",{className:"text-sys-red",children:ee})}),le&&oe&&a.jsxs(K,{className:"border border-sys-indigo/30 bg-surface/50",children:[a.jsxs("div",{className:"flex items-center justify-between mb-3",children:[a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx("span",{className:"type-label",children:"Anomaly Detection Tuning"}),a.jsxs("span",{className:"type-data-xs text-fg-muted",children:["(",De.label,")"]})]}),a.jsx("button",{onClick:()=>ye(e=>({...e,useAbsoluteThresholds:!e.useAbsoluteThresholds})),className:"type-data-xs px-2 py-1 rounded transition-colors "+(fe.useAbsoluteThresholds?"bg-sys-indigo/30 text-sys-indigo":"bg-elevated text-fg-muted hover:text-fg-secondary"),children:fe.useAbsoluteThresholds?"Absolute dBm":"Percentile"})]}),a.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-4 gap-4",children:[a.jsxs("div",{children:[a.jsx("span",{className:"type-micro",children:"Baseline"}),a.jsxs("span",{className:"ml-2 type-data-sm text-status-warning",children:[(null==(m=null==(d=We.debug)?void 0:d.baselineCutoff)?void 0:m.toFixed(1))??"—"," dBm"]})]}),a.jsxs("div",{children:[a.jsx("span",{className:"type-micro",children:"Spike"}),a.jsxs("span",{className:"ml-2 type-data-sm text-status-warning",children:[(null==(h=null==(u=We.debug)?void 0:u.spikeCutoff)?void 0:h.toFixed(1))??"—"," dBm"]})]}),a.jsxs("div",{children:[a.jsx("span",{className:"type-micro",children:"Mid-band"}),a.jsx("span",{className:"ml-2 type-data-sm text-sys-indigo",children:(null==(x=We.debug)?void 0:x.midBandSamples)??0})]}),a.jsxs("div",{children:[a.jsx("span",{className:"type-micro",children:"Anomalies"}),a.jsx("span",{className:"ml-2 type-data-sm text-status-danger",children:Ie.length})]})]}),a.jsxs("div",{className:"mt-4 pt-4 border-t border-edge-subtle space-y-4",children:[fe.useAbsoluteThresholds?a.jsxs(a.Fragment,{children:[a.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-4",children:[a.jsxs("div",{children:[a.jsxs("label",{className:"type-micro block mb-1",children:["Baseline (",fe.baselineDbm," dBm)"]}),a.jsx("input",{type:"range",min:"-120",max:"-60",value:fe.baselineDbm,onChange:e=>ye(t=>({...t,baselineDbm:Number(e.target.value)})),className:"w-full accent-sys-indigo"})]}),a.jsxs("div",{children:[a.jsxs("label",{className:"type-micro block mb-1",children:["Spike (",fe.spikeDbm," dBm)"]}),a.jsx("input",{type:"range",min:"-100",max:"-20",value:fe.spikeDbm,onChange:e=>ye(t=>({...t,spikeDbm:Number(e.target.value)})),className:"w-full accent-sys-indigo"})]}),a.jsxs("div",{children:[a.jsxs("label",{className:"type-micro block mb-1",children:["Merge Gap (",fe.mergeGapSeconds,"s)"]}),a.jsx("input",{type:"range",min:"5",max:"120",step:"5",value:fe.mergeGapSeconds,onChange:e=>ye(t=>({...t,mergeGapSeconds:Number(e.target.value)})),className:"w-full accent-sys-indigo"})]})]}),a.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-4",children:[a.jsxs("div",{children:[a.jsxs("label",{className:"type-micro block mb-1",children:["Min Sequence (",fe.minSequenceLength,")"]}),a.jsx("input",{type:"range",min:"2",max:"20",value:fe.minSequenceLength,onChange:e=>ye(t=>({...t,minSequenceLength:Number(e.target.value)})),className:"w-full accent-sys-indigo"})]}),a.jsxs("div",{children:[a.jsxs("label",{className:"type-micro block mb-1",children:["Similarity (±",fe.similarityToleranceDbm," dBm)"]}),a.jsx("input",{type:"range",min:"1",max:"15",value:fe.similarityToleranceDbm,onChange:e=>ye(t=>({...t,similarityToleranceDbm:Number(e.target.value)})),className:"w-full accent-sys-indigo"})]}),a.jsxs("div",{children:[a.jsxs("label",{className:"type-micro block mb-1",children:["Opacity (",Math.round(100*be),"%)"]}),a.jsx("input",{type:"range",min:"0.1",max:"1",step:"0.05",value:be,onChange:e=>je(Number(e.target.value)),className:"w-full accent-sys-indigo"})]})]})]}):a.jsxs(a.Fragment,{children:[a.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-4",children:[a.jsxs("div",{children:[a.jsxs("label",{className:"type-micro block mb-1",children:["Baseline (P",fe.baselinePercentile,")"]}),a.jsx("input",{type:"range",min:"1",max:"50",value:fe.baselinePercentile,onChange:e=>ye(t=>({...t,baselinePercentile:Number(e.target.value)})),className:"w-full accent-sys-indigo"})]}),a.jsxs("div",{children:[a.jsxs("label",{className:"type-micro block mb-1",children:["Spike (P",fe.spikePercentile,")"]}),a.jsx("input",{type:"range",min:"50",max:"99",value:fe.spikePercentile,onChange:e=>ye(t=>({...t,spikePercentile:Number(e.target.value)})),className:"w-full accent-sys-indigo"})]}),a.jsxs("div",{children:[a.jsxs("label",{className:"type-micro block mb-1",children:["Merge Gap (",fe.mergeGapSeconds,"s)"]}),a.jsx("input",{type:"range",min:"5",max:"120",step:"5",value:fe.mergeGapSeconds,onChange:e=>ye(t=>({...t,mergeGapSeconds:Number(e.target.value)})),className:"w-full accent-sys-indigo"})]})]}),a.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-4",children:[a.jsxs("div",{children:[a.jsxs("label",{className:"type-micro block mb-1",children:["Min Sequence (",fe.minSequenceLength,")"]}),a.jsx("input",{type:"range",min:"2",max:"20",value:fe.minSequenceLength,onChange:e=>ye(t=>({...t,minSequenceLength:Number(e.target.value)})),className:"w-full accent-sys-indigo"})]}),a.jsxs("div",{children:[a.jsxs("label",{className:"type-micro block mb-1",children:["Similarity (±",fe.similarityToleranceDbm," dBm)"]}),a.jsx("input",{type:"range",min:"1",max:"15",value:fe.similarityToleranceDbm,onChange:e=>ye(t=>({...t,similarityToleranceDbm:Number(e.target.value)})),className:"w-full accent-sys-indigo"})]}),a.jsxs("div",{children:[a.jsxs("label",{className:"type-micro block mb-1",children:["Opacity (",Math.round(100*be),"%)"]}),a.jsx("input",{type:"range",min:"0.1",max:"1",step:"0.05",value:be,onChange:e=>je(Number(e.target.value)),className:"w-full accent-sys-indigo"})]})]})]}),a.jsxs("div",{className:"mt-4 p-3 bg-elevated radius-inner",children:[a.jsx("div",{className:"type-micro mb-1",children:"Config output"}),a.jsxs("div",{className:"type-data-sm text-status-success",children:[fe.useAbsoluteThresholds?`useAbsoluteThresholds: true, baselineDbm: ${fe.baselineDbm}, spikeDbm: ${fe.spikeDbm}`:`useAbsoluteThresholds: false, baselinePercentile: ${fe.baselinePercentile}, spikePercentile: ${fe.spikePercentile}`,", mergeGapSeconds: ",fe.mergeGapSeconds,", minSequenceLength: ",fe.minSequenceLength,", similarityToleranceDbm: ",fe.similarityToleranceDbm]})]})]})]}),a.jsxs(J,{children:[a.jsx("div",{className:"sm:hidden",children:_e&&a.jsx(he,{template:"auto",children:a.jsx(K,{className:"border border-sys-blue/30 bg-sys-blue/5",children:a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsxs("div",{className:"relative flex h-3 w-3",children:[a.jsx("span",{className:"animate-ping absolute inline-flex h-full w-full rounded-full bg-sys-blue opacity-75"}),a.jsx("span",{className:"relative inline-flex rounded-full h-3 w-3 bg-sys-blue"})]}),a.jsxs("div",{className:"flex-1",children:[a.jsxs("p",{className:"type-body-sm text-fg-primary",children:["Loading ",De.label," data..."]}),w.loadProgress&&a.jsxs("p",{className:"type-data-xs text-fg-muted mt-0.5",children:[w.loadProgress.loaded.toLocaleString()," packets (",w.loadProgress.percent,"%)"]})]})]})})})}),q?a.jsxs(a.Fragment,{children:[a.jsx(he,{template:"hero-auto",children:a.jsx(K,{neomorphic:!0,isLoaded:q,skeletonType:"chart",children:q&&a.jsxs(a.Fragment,{children:[a.jsx(ae,{icon:a.jsx(O,{}),title:"Packet Analyzer",badge:De.label,badgeColor:"zinc",stackActionsOnMobile:!0,actions:a.jsxs("div",{className:"flex flex-wrap items-center gap-2 justify-end",children:["stats"===ne&&a.jsx(qe,{enabled:le,onChange:re,anomalyCount:Ie.length,showTuning:oe,onTuningChange:pe}),a.jsx(Oe,{smoothing:ne,onChange:ie}),a.jsx(Be,{mode:te,onChange:se})]})}),a.jsx("div",{className:"flex-1 min-h-0",children:a.jsx(Qe,{packets:Ze,allPackets:N,startTs:Ye,endTs:Ke,parentStartTs:Xe.start,parentEndTs:Xe.end,bucketCount:Ue,radioConfig:ze??void 0,mode:te,smoothing:ne,noiseFloorAnomalies:Ie,showNoiseFloorOverlay:le,overlayOpacity:be,dotSize:Ce,dotOpacity:Ae/100})})]})})}),a.jsx(he,{template:"auto",className:"relative z-10",children:a.jsx(K,{neomorphic:!0,noPadding:!0,isLoaded:q,className:"overflow-visible",children:q&&a.jsx(me,{parentStartTs:Xe.start,parentEndTs:Xe.end,neighbors:Ge,filter:ve,onChange:Se,..."stats"===ne?{scatterDotSize:Ce,onScatterDotSizeChange:Te,scatterOpacity:Ae,onScatterOpacityChange:Fe}:{}})})}),a.jsxs(he,{template:"panel",children:[a.jsx(xe,{span:12,md:6,children:a.jsx(K,{neomorphic:!1,isLoaded:q,skeletonType:"chart",noPadding:q,className:"!bg-transparent !ring-0 !shadow-none !overflow-visible -mx-4 sm:mx-0 !px-0 !pr-0",children:q&&a.jsx(mt,{children:a.jsx(rt,{neighbors:Ve,quickNeighbors:v,localLat:(null==(g=null==(p=null==b?void 0:b.config)?void 0:p.repeater)?void 0:g.latitude)??0,localLon:(null==(y=null==(f=null==b?void 0:b.config)?void 0:f.repeater)?void 0:y.longitude)??0,onStatsChange:Z,title:"Link Quality",badge:De.label})})})}),a.jsx(xe,{span:12,md:6,children:a.jsx(K,{neomorphic:!0,isLoaded:q,skeletonType:"chart",children:q&&a.jsxs(a.Fragment,{children:[a.jsx(ae,{icon:a.jsx(ge,{}),title:"Network Composition",badge:De.label,badgeColor:"zinc"}),a.jsx("div",{className:"flex-1 min-h-0",children:a.jsx(mt,{children:a.jsx(dt,{neighbors:Ve})})})]})})})]}),a.jsxs(he,{template:"panel",children:[a.jsx(xe,{span:12,md:6,children:a.jsx(pt,{})}),a.jsx(xe,{span:12,md:6,children:a.jsx(bt,{packets:N,rangeMinutes:Re,rangeHours:Le,timeRangeLabel:De.label,isLoaded:q})})]}),a.jsx(he,{template:"panel",children:a.jsx(xe,{span:12,children:a.jsx(K,{neomorphic:!0,isLoaded:q,skeletonType:"chart",children:q&&a.jsxs(a.Fragment,{children:[a.jsx(ae,{icon:a.jsx(H,{}),title:"NOISE FLOOR dBm",stackActionsOnMobile:!0,actions:X?a.jsxs("div",{className:"flex items-center gap-2 sm:gap-3",children:[a.jsxs("span",{className:"type-data-xs text-fg-muted whitespace-nowrap",children:["min ",a.jsx("span",{className:"data-box",children:X.min.toFixed(0)})]}),a.jsxs("span",{className:"type-data-xs text-fg-muted whitespace-nowrap",children:["avg ",a.jsx("span",{className:"data-box",children:X.avg.toFixed(0)})]}),a.jsxs("span",{className:"type-data-xs text-fg-muted whitespace-nowrap",children:["max ",a.jsx("span",{className:"data-box",children:X.max.toFixed(0)})]})]}):null}),a.jsx("div",{className:"flex-1 min-h-0",children:a.jsx(mt,{children:a.jsx(B,{timestamps:He.timestamps,values:He.values,onStatsChange:Y})})})]})})})})]}):a.jsx(he,{template:"auto",children:a.jsx(K,{neomorphic:!0,className:"text-center py-12",children:a.jsx("div",{className:"animate-pulse text-fg-muted",children:"Loading statistics..."})})})]})]})}export{jt as default};
