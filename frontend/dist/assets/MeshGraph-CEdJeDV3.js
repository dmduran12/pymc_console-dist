import{r as e,j as t,p as s,q as a}from"./vendor-react-54o2BuWt.js";import{c as n,r,b0 as i,v as l,b1 as o,b2 as c,f as d,aL as u,aY as m,T as x,b3 as h,b4 as p,A as g,m as f,X as b,R as y,b5 as v,B as j,G as C}from"./index-Cj2TQb_l.js";import{D as w,M as k,a as N}from"./DeepAnalysisModal-BhC0FTfb.js";import{D as S}from"./DataBox-Ch1XBKAk.js";import{L as M}from"./loader-circle-IbAorEh9.js";import{S as L,T as F}from"./target-DLZQ8LQK.js";import{C as E,Z as P}from"./zap-DPCcu4k7.js";import{G as D}from"./git-branch-DNmkU8Ic.js";import{H}from"./house-DRBwj0--.js";import{N as B}from"./network-DOWmt9mx.js";import"./deckgl-DTsmDcfs.js";import"./vendor-core-dnrJb0w-.js";const z=n("circle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]]),R=n("focus",[["circle",{cx:"12",cy:"12",r:"3",key:"1v7zrd"}],["path",{d:"M3 7V5a2 2 0 0 1 2-2h2",key:"aa7l1z"}],["path",{d:"M17 3h2a2 2 0 0 1 2 2v2",key:"4qcy5o"}],["path",{d:"M21 17v2a2 2 0 0 1-2 2h-2",key:"6vwrx8"}],["path",{d:"M7 21H5a2 2 0 0 1-2-2v-2",key:"ioqczr"}]]),I=n("move",[["path",{d:"M12 2v20",key:"t6zp3m"}],["path",{d:"m15 19-3 3-3-3",key:"11eu04"}],["path",{d:"m19 9 3 3-3 3",key:"1mg7y2"}],["path",{d:"M2 12h20",key:"9i4pu4"}],["path",{d:"m5 9-3 3 3 3",key:"j64kie"}],["path",{d:"m9 5 3-3 3 3",key:"l8vdw6"}]]);function G(t,s=1e3){const[a,n]=e.useState(t),r=e.useRef(Date.now()),i=e.useRef(null);return e.useEffect(()=>{const e=Date.now(),a=s-(e-r.current);return a<=0?(n(t),r.current=e):(i.current&&clearTimeout(i.current),i.current=setTimeout(()=>{n(t),r.current=Date.now()},a)),()=>{i.current&&clearTimeout(i.current)}},[t,s]),a}const $=Math.PI/180;let T=null,Z=0;function A(){const e=Date.now();if(T&&e-Z<1e3)return T;Z=e;const t=getComputedStyle(document.documentElement).getPropertyValue("--accent-primary").trim();if(t.startsWith("color(display-p3")){const e=t.match(/color\(display-p3\s+([\d.]+)\s+([\d.]+)\s+([\d.]+)/);if(e){const t=Math.round(255*parseFloat(e[1])),s=Math.round(255*parseFloat(e[2])),a=Math.round(255*parseFloat(e[3]));return T=`#${t.toString(16).padStart(2,"0")}${s.toString(16).padStart(2,"0")}${a.toString(16).padStart(2,"0")}`,T}}if(t.startsWith("rgb")){const e=t.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);if(e){const t=parseInt(e[1]),s=parseInt(e[2]),a=parseInt(e[3]);return T=`#${t.toString(16).padStart(2,"0")}${s.toString(16).padStart(2,"0")}${a.toString(16).padStart(2,"0")}`,T}}return T=t.startsWith("#")?t:"#719CDF",T}function W(e,t){if(e<=0)return 0;const s=t-e;if(s>1209600)return 0;if(s<0)return 1;const a=s/3600;return Math.exp(-a/12)}const O={spaceSize:4096,simulationRepulsion:1.5,simulationLinkDistance:30,simulationGravity:.15,simulationCenter:.5,simulationFriction:.85,simulationDecay:800,simulationLinkSpring:.5,simulationClusterStrength:.4,simulationRepulsionTheta:1.2};function V(e,t,s,a,n=3){const r=e<=0?0:Math.log10(e+1),i=Math.log10(5001),l=Math.min(1,r/i),o=6+18*Math.pow(l,n);if(a)return o;const c=s-t;return c>=J?Math.max(6,.5*o):c>=Y?Math.max(6,.7*o):o}const _={local:"#FFFFFF",hub:"#E0E0E0",gateway:"#C8C8C8",backbone:"#B0B0B0",neighbor:"#F0F0F0",mobile:"#A0A0A0",ghost:"#505050",standard:"#808080"},q={local:"Local Node",hub:"Hub (≥10% traffic)",gateway:"Gateway (7-10%)",backbone:"Backbone",neighbor:"Direct RF Neighbor",mobile:"Mobile/Volatile",ghost:"Discovered (unconfirmed)",standard:"Standard Node"},K={local:H,hub:P,gateway:D,backbone:D,neighbor:y,mobile:I,ghost:E,standard:z},Y=432e3,J=864e3;function U(e,t,s,a,n={x:0,y:0}){const r=e*$,i=s*$,l=(t-a)*$,o=(e-s)*$,c=637100;return n.x=l*Math.cos(.5*(r+i))*c,n.y=o*c,n}const X={background:`linear-gradient(to right, ${["#2A2A2A","#3D3D3D","#505050","#636363","#767676","#898989","#9C9C9C","#AFAFAF","#C2C2C2","#D5D5D5","#E8E8E8","#F5F5F5","#FFFFFF"].join(", ")})`},Q=e.memo(function({nodeCount:e,edgeCount:s}){return t.jsxs("div",{className:"absolute top-4 right-4 z-10 bg-bg-elevated/95 rounded-lg border border-border-subtle shadow-xl min-w-[180px] type-data-xs",children:[t.jsxs("div",{className:"flex items-center justify-between px-3 py-2 border-b border-border-subtle/50",children:[t.jsx("span",{className:"font-medium text-text-primary",children:"Topology"}),t.jsxs("span",{className:"text-text-muted tabular-nums",children:[e,"n · ",s,"e"]})]}),t.jsxs("div",{className:"px-3 py-2",children:[t.jsx("div",{className:"text-text-muted text-[10px] mb-1",children:"Packet count"}),t.jsx("div",{className:"h-1 rounded-sm",style:X}),t.jsxs("div",{className:"flex justify-between text-[10px] text-text-muted mt-0.5",children:[t.jsx("span",{children:"0"}),t.jsx("span",{children:"10K+"})]}),t.jsxs("div",{className:"flex items-center gap-1.5 mt-2 pt-2 border-t border-border-subtle/30",children:[t.jsx("div",{className:"w-2 h-2 rounded-full bg-accent-primary"}),t.jsx("span",{className:"text-[10px] text-text-muted",children:"p99 outlier"})]})]})]})}),ee="▁▂▃▄▅▆▇█",te=[-5,0,4,7],se=[-115,-105,-95,-80],ae=["text-signal-critical","text-signal-poor","text-accent-secondary","text-accent-secondary","text-accent-success"],ne=["text-signal-critical","text-signal-poor","text-accent-secondary","text-accent-success","text-accent-success"],re=["░░░░","▂░░░","▂▃░░","▂▄▅░","▂▄▆█"],ie={active:{color:"green",label:"Active"},recent:{color:"yellow",label:"Recent"},stale:{color:"orange",label:"Stale"},inactive:{color:"zinc",label:"Offline"}},le=(e,t,s=6)=>{const a=t?Math.min(1,e/t):0,n=Math.floor(a*s),r=Math.floor(8*(a*s-n));return ee[7].repeat(n)+(n<s&&r?ee[r-1]:"")+" ".repeat(Math.max(0,s-n-(r?1:0)))},oe=(e,t=10)=>"●".repeat(Math.round(e*t))+"○".repeat(t-Math.round(e*t)),ce=(e,t)=>{const s=t?ae:ne,a=(t?te:se).findIndex(t=>e<t);return[re[a<0?4:a],s[a<0?4:a]]},de=e.memo(function({c:e,maxPkts:s}){const[a,n]=(e=>e.isZeroHop?["◉","text-yellow-400"]:e.isDirectPath?["→","text-cyan-400"]:e.isLoopEdge?["↺","text-purple-400"]:["─","text-text-muted"])(e);return t.jsxs("li",{className:"flex items-center gap-1.5 py-0.5 px-1 rounded hover:bg-subtle-fill/30 transition-colors",children:[t.jsx("span",{className:`w-3 text-center shrink-0 ${n}`,children:a}),t.jsx("span",{className:"size-1.5 shrink-0 rounded-full",style:{backgroundColor:_[e.nodeClass]}}),t.jsx("code",{className:"shrink-0 text-text-primary",children:e.prefix}),t.jsx("span",{className:"flex-1 min-w-0 truncate text-text-muted",children:e.name||""}),t.jsx("span",{className:"text-accent-secondary tracking-tighter shrink-0",children:le(e.packetCount,s,4)}),t.jsx("span",{className:"tabular-nums text-text-secondary shrink-0 w-8 text-right",children:e.packetCount>=1e3?`${(e.packetCount/1e3).toFixed(1)}k`:e.packetCount})]})}),ue=e.memo(function({node:s,connections:a,onClose:n}){const r=e.useMemo(()=>Math.max(s.packetCount,...a.map(e=>e.packetCount),1),[s.packetCount,a]),i=e.useMemo(()=>[...a].sort((e,t)=>e.isZeroHop!==t.isZeroHop?e.isZeroHop?-1:1:e.isDirectPath!==t.isDirectPath?e.isDirectPath?-1:1:t.packetCount-e.packetCount),[a]),l=ie[s.activityLevel]??{color:"zinc",label:s.activityLevel};return t.jsxs(f.div,{variants:v,initial:"hidden",animate:"visible",exit:"exit",className:"absolute inset-x-4 bottom-4 z-20 bg-bg-elevated/95 rounded-xl border border-border-subtle shadow-xl",children:[t.jsxs("div",{className:"flex items-center justify-between px-4 py-2 border-b border-border-subtle/50",children:[t.jsxs("div",{className:"flex items-center gap-2 min-w-0",children:[t.jsx("span",{className:"size-2 shrink-0 rounded-full",style:{backgroundColor:_[s.nodeClass]}}),t.jsx("code",{className:"text-sm font-semibold text-text-primary shrink-0",children:s.prefix}),s.name&&t.jsx("span",{className:"text-sm text-text-secondary truncate",children:s.name}),t.jsxs("div",{className:"flex gap-1 shrink-0",children:[s.isLocal&&t.jsx(j,{color:"yellow",compact:!0,children:"LOCAL"}),s.isHub&&t.jsx(j,{color:"indigo",compact:!0,children:"HUB"}),s.isGateway&&t.jsx(j,{color:"violet",compact:!0,children:"GW"}),s.isBackbone&&t.jsx(j,{color:"emerald",compact:!0,children:"BONE"}),s.isMobile&&t.jsx(j,{color:"orange",compact:!0,children:"MOB"}),s.isZeroHop&&t.jsx(j,{color:"amber",compact:!0,children:"RF"})]})]}),t.jsx(C,{plain:!0,onClick:n,title:"Close",className:"shrink-0",children:t.jsx(b,{className:"size-4"})})]}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 p-3 font-mono text-[11px]",children:[t.jsxs("div",{className:"space-y-3",children:[t.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[t.jsx(j,{color:l.color,compact:!0,children:l.label}),t.jsx("span",{className:"text-text-muted",children:"•"}),t.jsx("span",{className:"text-text-secondary",children:q[s.nodeClass]}),s.hasGeo&&t.jsx(j,{color:"cyan",compact:!0,children:"GPS"}),s.hasCollision&&t.jsx(j,{color:"red",compact:!0,children:"⚠ COLLISION"})]}),t.jsx(S,{copy:!0,size:"compact",truncate:[10,6],className:"w-full",children:s.hash}),t.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[t.jsxs("div",{children:[t.jsx("div",{className:"text-[9px] text-text-muted uppercase",children:"Packets"}),t.jsx("div",{className:"text-text-primary tabular-nums",children:s.packetCount.toLocaleString()}),t.jsx("div",{className:"text-accent-primary tracking-tighter",children:le(s.packetCount,r,6)})]}),t.jsxs("div",{children:[t.jsx("div",{className:"text-[9px] text-text-muted uppercase",children:"Degree"}),t.jsx("div",{className:"text-text-primary tabular-nums",children:s.degree}),t.jsx("div",{className:"text-accent-secondary tracking-tighter",children:le(s.degree,Math.max(s.degree,10),6)})]}),t.jsxs("div",{children:[t.jsx("div",{className:"text-[9px] text-text-muted uppercase",children:"Central"}),t.jsxs("div",{className:"text-text-primary tabular-nums",children:[(100*s.betweenness).toFixed(0),"%"]}),t.jsx("div",{className:"text-accent-primary tracking-tighter",children:oe(s.betweenness,6)})]})]}),s.isZeroHop&&(null!==s.avgRssi||null!==s.avgSnr)&&t.jsxs("div",{className:"flex gap-4 pt-2 border-t border-border-subtle/30",children:[null!==s.avgRssi&&(()=>{const[e,a]=ce(s.avgRssi,!1);return t.jsxs("div",{children:[t.jsx("div",{className:"text-[9px] text-text-muted uppercase",children:"RSSI"}),t.jsxs("div",{className:"flex items-baseline gap-1",children:[t.jsx("span",{className:`${a} tracking-tight`,children:e}),t.jsx("span",{className:"tabular-nums text-text-secondary",children:s.avgRssi.toFixed(0)}),t.jsx("span",{className:"text-[9px] text-text-muted",children:"dBm"})]})]})})(),null!==s.avgSnr&&(()=>{const[e,a]=ce(s.avgSnr,!0);return t.jsxs("div",{children:[t.jsx("div",{className:"text-[9px] text-text-muted uppercase",children:"SNR"}),t.jsxs("div",{className:"flex items-baseline gap-1",children:[t.jsx("span",{className:`${a} tracking-tight`,children:e}),t.jsx("span",{className:"tabular-nums text-text-secondary",children:s.avgSnr.toFixed(1)}),t.jsx("span",{className:"text-[9px] text-text-muted",children:"dB"})]})]})})()]})]}),t.jsxs("div",{className:"space-y-2",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("span",{className:"text-[9px] text-text-muted uppercase",children:"Connections"}),t.jsx(j,{color:"zinc",compact:!0,children:a.length})]}),i.length>0?t.jsxs("ul",{className:"max-h-32 overflow-y-auto space-y-0.5 scrollbar-thin",children:[i.slice(0,20).map(e=>t.jsx(de,{c:e,maxPkts:r},e.hash)),i.length>20&&t.jsxs("li",{className:"text-center text-text-muted py-1",children:["+",i.length-20," more"]})]}):t.jsx("p",{className:"text-text-muted italic",children:"No connections"})]}),t.jsxs("div",{className:"hidden lg:flex lg:flex-col lg:gap-3",children:[t.jsxs("div",{className:"grid grid-cols-2 gap-x-4 gap-y-1",children:[t.jsxs("div",{className:"flex justify-between",children:[t.jsx("span",{className:"text-text-muted",children:"Cluster"}),t.jsxs("span",{className:"text-text-secondary",children:["#",s.communityId]})]}),t.jsxs("div",{className:"flex justify-between",children:[t.jsx("span",{className:"text-text-muted",children:"Edges"}),t.jsx("span",{className:"text-text-secondary",children:s.edgeCount})]}),s.hasCollision&&t.jsxs("div",{className:"flex justify-between col-span-2",children:[t.jsx("span",{className:"text-signal-poor",children:"Prefix Conf."}),t.jsxs("span",{className:"text-signal-poor tabular-nums",children:[(100*s.prefixConfidence).toFixed(0),"%"]})]})]}),t.jsxs("div",{className:"mt-auto pt-2 border-t border-border-subtle/30",children:[t.jsx("div",{className:"text-[9px] text-text-muted uppercase mb-1.5",children:"Edge Types"}),t.jsxs("div",{className:"grid grid-cols-3 gap-1 text-[10px]",children:[t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx("span",{className:"text-yellow-400",children:"◉"}),t.jsx("span",{className:"text-text-muted",children:"RF"})]}),t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx("span",{className:"text-cyan-400",children:"→"}),t.jsx("span",{className:"text-text-muted",children:"Direct"})]}),t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx("span",{className:"text-purple-400",children:"↺"}),t.jsx("span",{className:"text-text-muted",children:"Loop"})]})]})]})]})]})]})});function me(){return t.jsxs("div",{className:"flex flex-col items-center justify-center gap-4 text-center px-8",children:[t.jsx("div",{className:"p-4 rounded-full bg-subtle-fill",children:t.jsx(B,{className:"w-8 h-8 text-text-muted"})}),t.jsxs("div",{className:"space-y-2",children:[t.jsx("h2",{className:"text-lg font-medium text-text-primary",children:"No Topology Data"}),t.jsx("p",{className:"text-sm text-text-muted max-w-sm",children:"The mesh topology will appear here once packets are received and processed. This typically takes a few minutes after starting."})]}),t.jsxs("div",{className:"flex items-center gap-2 text-xs text-text-muted mt-2",children:[t.jsx(y,{className:"w-4 h-4 animate-pulse"}),t.jsx("span",{children:"Waiting for mesh traffic..."})]})]})}function xe(){var n;const y=r(),[v,j]=e.useState(!1),C=i(),S=l(),[E,P]=e.useState(!1),[D,H]=e.useState("fetching"),[B,z]=e.useState(0),I=e.useRef(!1);e.useEffect(()=>{y&&!I.current&&(I.current=!0,(async()=>{P(!0),H("fetching"),z(0),await C(),H("analyzing"),await new Promise(e=>setTimeout(e,200)),H("building");const e=Date.now(),t=Date.now()-e;t<600&&await new Promise(e=>setTimeout(e,600-t)),H("discovering"),await new Promise(e=>setTimeout(e,400)),H("complete"),await new Promise(e=>setTimeout(e,800)),P(!1),j(!0)})())},[y,C]),e.useEffect(()=>{"fetching"===D&&(S.loadProgress?z(S.loadProgress.loaded):S.packetCount>0&&z(S.packetCount))},[D,S.loadProgress,S.packetCount]);const $=o(),T=G(c(),2e3),Z=d(),q=u(),[Y,J]=e.useState(!0),[X,ee]=e.useState(null),te=e.useRef(void 0),[se,ae]=e.useState(""),[ne,re]=e.useState(!1),ie=e.useRef(null),[le]=e.useState(1),[oe]=e.useState(.15),[ce]=e.useState(2.75),[de]=e.useState(3),xe=G(ce,300),he=G(de,300),pe=e.useRef(le),ge=e.useRef(oe);e.useEffect(()=>{pe.current=le},[le]),e.useEffect(()=>{ge.current=oe},[oe]);const fe=e.useRef({node:null,x:0,y:0}),be=e.useRef(null),[ye,ve]=e.useState(!1);e.useEffect(()=>{const e=e=>{var t,s;if(!(e.target instanceof HTMLInputElement))switch(e.key.toLowerCase()){case"f":e.metaKey||e.ctrlKey||(e.preventDefault(),null==(t=Ze.current)||t.fitView(800));break;case"escape":ne?(re(!1),ae("")):X&&(te.current=void 0,ee(null),null==(s=Ze.current)||s.unselectAllPoints());break;case"/":ne||(e.preventDefault(),re(!0),setTimeout(()=>{var e;return null==(e=ie.current)?void 0:e.focus()},50));break;case" ":e.preventDefault();{const e=Ze.current;e&&(Y?e.pause():e.start(),J(e=>!e))}}};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[ne,X,Y]);const je=(null==q?void 0:q.latitude)??0,Ce=(null==q?void 0:q.longitude)??0,we=null!==q,[ke,Ne]=e.useState(Math.floor(Date.now()/1e3));e.useEffect(()=>{const e=setInterval(()=>{Ne(Math.floor(Date.now()/1e3))},3e5);return()=>clearInterval(e)},[]);const Se=e.useMemo(()=>{var e;if(!T||0===T.size||!v)return[];const t=[],s=(null==Z?void 0:Z.node_name)??(null==(e=null==Z?void 0:Z.config)?void 0:e.node_name)??null,a={x:0,y:0},n=[];for(const r of T.values()){const e=r.isLocal?1:W(r.lastSeen,ke);if(0===e&&!r.isLocal)continue;r.isLocal||n.push(r.packetCount);const i=r.packetCount>0?Math.log10(r.packetCount+1):0,l=Math.log10(5001),o=Math.min(1,i/l);let c;c=r.isLocal?4:o<.2?0:o<.4?1:o<.6?2:o<.8?3:4;const d="#FFFFFF",u=V(r.packetCount,r.lastSeen,ke,r.isLocal,ce),m=r.isLocal?s??r.name:r.name;let x,h,p=!1;we&&(r.isLocal?(x=0,h=0,p=!0):r.latitude&&r.longitude&&(U(r.latitude,r.longitude,je,Ce,a),x=a.x,h=a.y,p=!0)),t.push({id:r.hash,label:m?`${r.prefix} ${m}`:r.prefix,color:d,trafficCategory:c,size:u,x:x,y:h,recencyWeight:e,nodeClass:r.nodeClass,name:m,prefix:r.prefix,packetCount:r.packetCount,betweenness:r.betweenness,communityId:r.communityId,isLocal:r.isLocal,isHub:r.isHub,isGateway:r.isGateway,isBackbone:r.isBackbone,isMobile:r.isMobile,isGhost:r.isGhost,isInLoop:r.isInLoop,isZeroHop:r.isZeroHop,hasGeo:p,avgRssi:r.avgRssi,avgSnr:r.avgSnr,degree:r.degree,activityLevel:r.activityLevel,prefixConfidence:r.prefixConfidence,hasCollision:r.hasCollision,lastSeen:r.lastSeen})}if(n.length>0){n.sort((e,t)=>e-t);const e=n[Math.floor(.99*n.length)]??n[n.length-1]??1/0;for(const s of t)!s.isLocal&&s.packetCount>=e&&(s.trafficCategory=5)}return t},[T,v,we,je,Ce,null==Z?void 0:Z.node_name,null==(n=null==Z?void 0:Z.config)?void 0:n.node_name,ke,ce]),Me=e.useMemo(()=>{const e=new Set;for(const t of Se)e.add(t.id);return e},[Se]),{rawLinks:Le}=e.useMemo(()=>{const e=(null==$?void 0:$.edges)??[];if(!e||0===e.length||!v)return{rawLinks:[],maxCertainCount:0,hasZeroHopEdges:!1,hasLoopEdges:!1,hasDirectPathEdges:!1};const t=A(),s=[];let a=!1,n=!1,r=!1;const i=[],l=5-4*Math.min(1,Math.max(0,(de-.05)/2.95));for(const o of e){if(!Me.has(o.fromHash)||!Me.has(o.toHash))continue;s.push(o.certainCount),a=a||!0===o.isZeroHop,n=n||!0===o.isLoopEdge,r=r||!0===o.isDirectPathEdge;const e=o.avgRecency,t=e<0,l=null==T?void 0:T.get(o.fromHash),c=null==T?void 0:T.get(o.toHash),d=(null==l?void 0:l.isHub)||(null==l?void 0:l.isGateway)||(null==l?void 0:l.isBackbone)||(null==l?void 0:l.isLocal),u=(null==c?void 0:c.isHub)||(null==c?void 0:c.isGateway)||(null==c?void 0:c.isBackbone)||(null==c?void 0:c.isLocal);let m=0,x=300;t||(d&&u?(m=.8,x=250):d||u?(m=.4,x=50):(m=.1,x=300)),i.push({source:o.fromHash,target:o.toHash,color:t?"#1E293B":"#808080",width:t?.1:1,strength:m,distance:x,arrow:!t,trafficCategory:t?0:2,recencyWeight:e,packetCount:o.packetCount,certainCount:o.certainCount,isZeroHop:o.isZeroHop??!1,isLoopEdge:o.isLoopEdge??!1,isDirectPath:o.isDirectPathEdge,avgConfidence:o.avgConfidence})}if(s.length>0){s.sort((e,t)=>e-t);const e=s[Math.floor(.98*s.length)]??s[s.length-1]??1,a=Math.max(1,e),n=Math.log10(a+1),r=s[Math.floor(.99*s.length)]??s[s.length-1]??1/0;for(const s of i){if(0===s.trafficCategory)continue;const e=s.certainCount>0?Math.log10(s.certainCount+1):0,a=Math.min(1,e/n),i=Math.pow(a,de),o=Math.pow(a,oe);if(s.width=.1+i*(l-.1),s.certainCount>=r)s.color=t,s.trafficCategory=5;else{const e=Math.round(80+144*o).toString(16).padStart(2,"0");s.color=`#${e}${e}${e}`,s.trafficCategory=a<.25?1:a<.5?2:a<.75?3:4}}}return{rawLinks:i,maxCertainCount:s.length>0?Math.max(...s):0,hasZeroHopEdges:a,hasLoopEdges:n,hasDirectPathEdges:r}},[null==$?void 0:$.validatedEdges,null==$?void 0:$.weakEdges,v,Me,T,de]),Fe=e.useMemo(()=>{const e=new Map;for(const t of Le)e.set(t.source,(e.get(t.source)??0)+1),e.set(t.target,(e.get(t.target)??0)+1);return e},[Le]),Ee=e.useMemo(()=>{const e=new Map;for(const t of Se)e.set(t.id,t);return e},[Se]),Pe=e.useMemo(()=>{const e=new Map;for(const t of Le)e.has(t.source)||e.set(t.source,[]),e.get(t.source).push({link:t,otherHash:t.target,direction:"outbound"}),e.has(t.target)||e.set(t.target,[]),e.get(t.target).push({link:t,otherHash:t.source,direction:"inbound"});return e},[Le]),De=e.useMemo(()=>{if(!X)return[];const e=Pe.get(X.hash);if(!e)return[];const t=[];for(const{link:s,otherHash:a,direction:n}of e){const e=Ee.get(a);e&&t.push({hash:a,prefix:e.prefix,name:e.name,nodeClass:e.nodeClass,packetCount:s.packetCount,certainCount:s.certainCount,isZeroHop:s.isZeroHop,isDirectPath:s.isDirectPath,isLoopEdge:s.isLoopEdge,direction:n})}return t},[X,Pe,Ee]),He=e.useMemo(()=>{const e=new Map;for(const t of Se)e.set(t.label,t.trafficCategory),e.set(t.prefix,t.trafficCategory);return e},[Se]),Be=e.useCallback(()=>{const e=document.querySelectorAll(".css-label--label");if(0===e.length||0===He.size)return;const t=["meshgraph-label-cat-0","meshgraph-label-cat-1","meshgraph-label-cat-2","meshgraph-label-cat-3","meshgraph-label-cat-4","meshgraph-label-cat-5"];e.forEach(e=>{var s;const a=(null==(s=e.textContent)?void 0:s.trim())??"",n=He.get(a);void 0!==n&&(e.classList.remove(...t),e.classList.add(`meshgraph-label-cat-${n}`))})},[He]),[ze,Re]=e.useState(null),[Ie,Ge]=e.useState(null),[$e,Te]=e.useState({}),Ze=e.useRef(null),Ae=e.useRef(!1),We=e.useRef(!1),Oe=e.useRef(!1),Ve=e.useRef(""),[_e,qe]=e.useState(!0);e.useEffect(()=>{if(0===Se.length)return Re(null),Ge(null),void(Ve.current="");const e=`${Se.length}-${Le.length}-${xe.toFixed(2)}-${he.toFixed(2)}`,t=Ve.current;if(t&&We.current){const[e,s]=t.split("-").map(Number),a=Math.abs(Se.length-e)/Math.max(e,1),n=Math.abs(Le.length-s)/Math.max(s,1),r=!t.endsWith(`${xe.toFixed(2)}-${he.toFixed(2)}`);if(a<.05&&n<.05&&!r)return}let s=!1,n=null;return n=setTimeout(async()=>{if(!Ae.current){Ae.current=!0,We.current=!0,qe(!0);try{const n=(e,t)=>"number"==typeof e&&Number.isFinite(e)?e:t,r=186,i=255,l=92,o=pe.current;let c;c=o<=1?i-o*(i-r):r-(o-1)*(r-l);const d=e=>{const t=Math.max(0,Math.min(255,Math.round(e))).toString(16).padStart(2,"0");return`#${t}${t}${t}`},u=e=>d(c+(i-c)*e),m=A(),x=document.documentElement;x.style.setProperty("--meshgraph-label-0",u(0)),x.style.setProperty("--meshgraph-label-1",u(.33)),x.style.setProperty("--meshgraph-label-2",u(.66)),x.style.setProperty("--meshgraph-label-3",u(1)),x.style.setProperty("--meshgraph-label-4","#FFFFFF"),x.style.setProperty("--meshgraph-label-5",m);const h=e=>e.isLocal?"Local":e.isHub?"Hub":e.isGateway?"Gateway":e.isBackbone?"Backbone":"Node",p=Se.sort((e,t)=>{const s=5===e.trafficCategory,a=5===t.trafficCategory;return s&&!a?1:!s&&a?-1:e.size-t.size}).map(e=>{let t;if(5===e.trafficCategory)t=m;else if(4===e.trafficCategory)t="#FFFFFF";else{const s=e.trafficCategory/3;t=u(s)}return{id:e.id,label:e.label,color:t,trafficCategory:e.trafficCategory,size:n(e.size,8),groupLabel:h(e)}}),g=[...Le].sort((e,t)=>(t.certainCount??t.packetCount??0)-(e.certainCount??e.packetCount??0)),f=Math.floor(1*g.length),b=new Set(g.slice(0,Math.max(f,10)).map(e=>`${e.source}-${e.target}`)),y=Le.filter(e=>b.has(`${e.source}-${e.target}`)).sort((e,t)=>{const s=5===e.trafficCategory,a=5===t.trafficCategory;return s&&!a?1:!s&&a?-1:e.width-t.width}).map(e=>({source:e.source,target:e.target,color:e.color,trafficCategory:e.trafficCategory,width:n(e.width,1),strength:1,distance:30})),v=p,j=y,C=v.length>0,w=new Set(j.map(e=>e.width)),k=j.length>0,N=1===w.size?w.values().next().value:null,S=new Set(j.map(e=>e.strength)),M=j.length>=2&&S.size>=2,L=new Set(j.map(e=>e.distance)),F=j.length>=2&&L.size>=2,E=new Set(v.map(e=>e.groupLabel)).size>=2,P=(e=!1)=>({points:{pointIdBy:"id",pointColorBy:"color",pointColorStrategy:"direct",pointDefaultColor:"#FFFFFF",pointLabelBy:"label",pointGreyoutOpacity:.5,pointDefaultSize:8,pointSizeScale:1,...e?{}:{pointMass:e=>1+((e.size??8)-6)/18*10},...!e&&C?{pointSizeBy:"size",pointSizeStrategy:"direct"}:{},...!e&&E?{pointClusterBy:"groupLabel"}:{},...!e&&k?{linkWidthBy:"width",linkWidthStrategy:"direct"}:{},...!e&&M?{linkStrengthBy:"strength",linkStrengthStrategy:"direct"}:{}},links:{linkSourceBy:"source",linkTargetsBy:["target"],linkColorBy:"color",linkColorStrategy:"direct",linkDefaultWidth:null!==N?N:1,linkWidthScale:1,linkDefaultColor:"#505050",linkGreyoutOpacity:.15,...!e&&k?{linkWidthBy:"width",linkWidthStrategy:"direct"}:{},...!e&&F?{linkDistanceBy:"distance",linkDistanceStrategy:"direct"}:{}}});let D;try{D=await a(P(!1),v,j)}catch(t){D=await a(P(!0),v,j)}if(s||!D)return;const H=D.points??null,B=D.links??null,z=D.cosmographConfig;Re(H),Ge(B),Te({...z,fitViewOnInit:!1,...O}),Je.current=!1,Ve.current=e}catch(n){qe(!1)}finally{Ae.current=!1}}},500),()=>{s=!0,n&&clearTimeout(n)}},[Se,Le,!1,null,xe,he]);const Ke=e.useCallback(e=>{Ze.current=e},[]),Ye=e.useCallback(()=>{var e;null==(e=Ze.current)||e.fitView(800)},[]),Je=e.useRef(!1),Ue=e.useCallback(()=>{var e,t,s,a;if(qe(!1),Oe.current||(Oe.current=!0,setTimeout(()=>{var e;null==(e=Ze.current)||e.fitView(800)},300)),!Je.current){Je.current=!0;const r=null==(e=Ze.current)?void 0:e._internalApi;if(r)try{null==(t=r.initializeLabels)||t.call(r),null==(a=null==(s=r.labels)?void 0:s.update)||a.call(s),setTimeout(()=>{Be()},100)}catch(n){}}J(!1)},[Be]),Xe=e.useCallback(()=>{const e=Ze.current;e&&(Y?e.pause():e.start(),J(!Y))},[Y]),Qe=e.useCallback(async e=>{const t=Ze.current;if(t)try{const s=await t.getPointIndicesByIds([e]);s&&s.length>0&&void 0!==s[0]&&t.zoomToPoint(s[0],400,2.5)}catch{}},[]),et=e.useMemo(()=>{if(!ne||!se.trim())return[];const e=se.toLowerCase();return Se.filter(t=>{var s;return t.prefix.toLowerCase().includes(e)||(null==(s=t.name)?void 0:s.toLowerCase().includes(e))||t.id.toLowerCase().includes(e)}).slice(0,8)},[Se,se,ne]),tt=e.useCallback(e=>{Qe(e.id),re(!1),ae(""),ee({hash:e.id,name:e.name,prefix:e.prefix,nodeClass:e.nodeClass,packetCount:e.packetCount,edgeCount:Fe.get(e.id)??0,betweenness:e.betweenness,communityId:e.communityId,degree:e.degree,hasGeo:e.hasGeo,isLocal:e.isLocal,isHub:e.isHub,isGateway:e.isGateway,isBackbone:e.isBackbone,isMobile:e.isMobile,isInLoop:e.isInLoop,isZeroHop:e.isZeroHop,avgRssi:e.avgRssi,avgSnr:e.avgSnr,activityLevel:e.activityLevel,prefixConfidence:e.prefixConfidence,hasCollision:e.hasCollision})},[Qe,Fe]),st=e.useRef(void 0),at=e.useRef(0),nt=e.useCallback(async(e,t,s)=>{const a=Date.now();if(s&&a-at.current>=16&&(at.current=a,fe.current.x=s.clientX,fe.current.y=s.clientY,fe.current.node&&window.dispatchEvent(new CustomEvent("meshgraph:hover"))),e===st.current)return;st.current=e,be.current&&(clearTimeout(be.current),be.current=null);const n=Ze.current;if(n)if(void 0!==e)try{const t=await n.getPointIdsByIndices([e]);if(!t||0===t.length)return;const s=t[0],a=Ee.get(s);if(!a)return;fe.current.node=a,window.dispatchEvent(new CustomEvent("meshgraph:hover")),n.selectPoint(e,!1,!0)}catch{fe.current.node=null,window.dispatchEvent(new CustomEvent("meshgraph:hover"))}else be.current=setTimeout(()=>{fe.current.node=null,window.dispatchEvent(new CustomEvent("meshgraph:hover")),void 0!==te.current?n.selectPoint(te.current,!1,!0):n.unselectAllPoints()},100)},[Ee,X]),rt=e.useCallback(()=>{ve(e=>!e)},[]),it=e.useCallback(async(e,t,s)=>{var a;if(fe.current.node=null,window.dispatchEvent(new CustomEvent("meshgraph:hover")),st.current=void 0,void 0===e)return te.current=void 0,ee(null),void(null==(a=Ze.current)||a.unselectAllPoints());const n=Ze.current;if(n)try{const t=await n.getPointIdsByIndices([e]);if(!t||0===t.length)return;const s=t[0],a=Ee.get(s);if(!a)return;te.current=e,n.selectPoint(e,!1,!0),ee({hash:s,name:a.name,prefix:a.prefix,nodeClass:a.nodeClass,packetCount:a.packetCount,edgeCount:Fe.get(s)??0,betweenness:a.betweenness,communityId:a.communityId,degree:a.degree,hasGeo:a.hasGeo,isLocal:a.isLocal,isHub:a.isHub,isGateway:a.isGateway,isBackbone:a.isBackbone,isMobile:a.isMobile,isInLoop:a.isInLoop,isZeroHop:a.isZeroHop,avgRssi:a.avgRssi,avgSnr:a.avgSnr,activityLevel:a.activityLevel,prefixConfidence:a.prefixConfidence,hasCollision:a.hasCollision})}catch{}},[Ee,Fe]);if(!v)return t.jsxs("div",{className:"-mx-4 sm:-mx-6 lg:-mx-8 -mt-5 -mb-4 sm:-mb-6 lg:-mb-8 h-[calc(100dvh-56px)] lg:h-dvh flex items-center justify-center bg-black",children:[t.jsx(w,{isOpen:E,currentStep:D,packetCount:B}),!E&&t.jsx(M,{className:"w-8 h-8 text-accent-primary animate-spin"})]});if(0===Se.length)return t.jsxs("div",{className:"-mx-4 sm:-mx-6 lg:-mx-8 -mt-5 -mb-4 sm:-mb-6 lg:-mb-8 h-[calc(100dvh-56px)] lg:h-dvh flex flex-col bg-black overflow-hidden",children:[t.jsx("div",{className:"flex items-center justify-between px-4 py-3 border-b border-border-subtle bg-bg-elevated/50",children:t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx(m,{className:"w-5 h-5 text-accent-primary"}),t.jsxs("h1",{className:"type-data-sm font-semibold text-text-primary flex items-center gap-2",children:["MeshGraph",t.jsx("span",{className:"px-1.5 py-0.5 text-[10px] font-medium uppercase tracking-wider bg-accent-primary/20 text-accent-primary rounded",children:"Beta"})]})]})}),t.jsx("div",{className:"flex-1 flex items-center justify-center",children:t.jsx(me,{})})]});if(!ze)return t.jsx("div",{className:"-mx-4 sm:-mx-6 lg:-mx-8 -mt-5 -mb-4 sm:-mb-6 lg:-mb-8 h-[calc(100dvh-56px)] lg:h-dvh flex items-center justify-center bg-black",children:t.jsxs("div",{className:"flex flex-col items-center gap-3",children:[t.jsx(M,{className:"w-8 h-8 text-accent-primary animate-spin"}),t.jsx("span",{className:"text-sm text-text-muted",children:"Preparing graph..."})]})});const lt=ye?"fixed inset-0 z-50 bg-black":"-mx-4 sm:-mx-6 lg:-mx-8 -mt-5 -mb-4 sm:-mb-6 lg:-mb-8 h-[calc(100dvh-56px)] lg:h-dvh bg-black";return t.jsxs("div",{className:`${lt} flex flex-col overflow-hidden`,children:[t.jsxs("div",{className:"flex items-center justify-between px-4 py-2 border-b border-border-subtle/50 bg-black/80 backdrop-blur-sm z-10",children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx(m,{className:"w-5 h-5 text-accent-primary"}),t.jsxs("h1",{className:"type-data-sm font-semibold text-text-primary flex items-center gap-2",children:["MeshGraph",t.jsx("span",{className:"px-1.5 py-0.5 text-[10px] font-medium uppercase tracking-wider bg-accent-primary/20 text-accent-primary rounded",children:"Beta"})]}),t.jsxs("span",{className:"type-data-xs text-text-muted tabular-nums",children:[Se.length," nodes • ",Le.length," edges"]}),_e&&t.jsxs("span",{className:"flex items-center gap-1.5 text-[10px] text-accent-primary animate-pulse",children:[t.jsx(M,{className:"w-3 h-3 animate-spin"}),"Stabilizing..."]})]}),t.jsxs("div",{className:"flex items-center gap-0.5",children:[t.jsx(x,{content:"Search nodes (/)",children:t.jsx("button",{onClick:()=>{re(!0),setTimeout(()=>{var e;return null==(e=ie.current)?void 0:e.focus()},50)},className:"p-2 rounded-lg transition-colors "+(ne?"bg-accent-primary/20 text-accent-primary":"hover:bg-subtle-fill text-text-muted"),children:t.jsx(L,{className:"w-4 h-4"})})}),t.jsx(x,{content:(Y?"Pause":"Resume")+" simulation (Space)",children:t.jsx("button",{onClick:Xe,className:"p-2 rounded-lg hover:bg-subtle-fill transition-colors",children:Y?t.jsx(h,{className:"w-4 h-4 text-accent-success"}):t.jsx(p,{className:"w-4 h-4 text-text-muted"})})}),t.jsx(x,{content:"Fit view (F)",children:t.jsx("button",{onClick:Ye,className:"p-2 rounded-lg hover:bg-subtle-fill transition-colors",children:t.jsx(R,{className:"w-4 h-4 text-text-muted"})})}),t.jsx(x,{content:ye?"Exit fullscreen":"Fullscreen",children:t.jsx("button",{onClick:rt,className:"p-2 rounded-lg hover:bg-subtle-fill transition-colors",children:ye?t.jsx(k,{className:"w-4 h-4 text-text-muted"}):t.jsx(N,{className:"w-4 h-4 text-text-muted"})})})]})]}),t.jsxs("div",{className:"flex-1 relative min-h-0",children:[t.jsx(s,{className:"absolute inset-0",points:ze,links:Ie,...$e,backgroundColor:"#000000",fitViewOnInit:!1,initialZoomLevel:10,simulationClusterStrength:.8,showLabels:!0,showDynamicLabels:!0,showTopLabels:!0,showTopLabelsLimit:100,showHoveredPointLabel:!0,pointLabelFontSize:11,showClusterLabels:!1,onClick:it,onMouseMove:nt,onMount:Ke,onSimulationEnd:Ue,renderHoveredPointRing:!0,hoveredPointRingColor:"#FBBF24",hoveredPointCursor:"pointer",pointGreyoutOpacity:.2,linkGreyoutOpacity:.15}),t.jsx(g,{children:ne&&t.jsx(f.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},transition:{duration:.15},className:"absolute top-4 left-1/2 -translate-x-1/2 z-30 w-80",children:t.jsxs("div",{className:"bg-bg-elevated/95 backdrop-blur-sm rounded-xl border border-border-subtle shadow-2xl overflow-hidden",children:[t.jsxs("div",{className:"flex items-center gap-2 px-3 py-2 border-b border-border-subtle",children:[t.jsx(L,{className:"w-4 h-4 text-text-muted shrink-0"}),t.jsx("input",{ref:ie,type:"text",value:se,onChange:e=>ae(e.target.value),placeholder:"Search by name or prefix...",className:"flex-1 bg-transparent text-sm text-text-primary placeholder:text-text-muted focus:outline-none",onKeyDown:e=>{"Escape"===e.key?(re(!1),ae("")):"Enter"===e.key&&et.length>0&&tt(et[0])}}),se&&t.jsx("button",{onClick:()=>ae(""),className:"p-0.5 rounded hover:bg-subtle-fill",children:t.jsx(b,{className:"w-3 h-3 text-text-muted"})})]}),et.length>0&&t.jsx("div",{className:"max-h-64 overflow-y-auto",children:et.map((e,s)=>{const a=K[e.nodeClass];return t.jsxs("button",{onClick:()=>tt(e),className:"w-full flex items-center gap-3 px-3 py-2 text-left hover:bg-subtle-fill transition-colors "+(0===s?"bg-subtle-fill/50":""),children:[t.jsx("span",{className:"w-2.5 h-2.5 rounded-full shrink-0",style:{backgroundColor:_[e.nodeClass]}}),t.jsx(a,{className:"w-3.5 h-3.5 text-text-muted shrink-0"}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsx("div",{className:"text-sm text-text-primary truncate",children:e.name||e.prefix}),e.name&&t.jsx("div",{className:"text-[10px] text-text-muted",children:e.prefix})]}),t.jsx(F,{className:"w-3 h-3 text-text-muted shrink-0"})]},e.id)})}),se&&0===et.length&&t.jsx("div",{className:"px-3 py-4 text-center text-sm text-text-muted",children:"No nodes found"}),!se&&t.jsx("div",{className:"px-3 py-2 text-[10px] text-text-muted",children:"Type to search • Enter to select • Esc to close"})]})})}),t.jsx(Q,{nodeCount:Se.length,edgeCount:Le.length}),!X&&t.jsxs("div",{className:"absolute bottom-4 right-4 z-10 hidden lg:flex items-center gap-3 text-[10px] text-text-muted/60",children:[t.jsxs("span",{children:[t.jsx("kbd",{className:"px-1 py-0.5 rounded bg-subtle-fill/50 font-mono",children:"/"})," Search"]}),t.jsxs("span",{children:[t.jsx("kbd",{className:"px-1 py-0.5 rounded bg-subtle-fill/50 font-mono",children:"F"})," Fit"]}),t.jsxs("span",{children:[t.jsx("kbd",{className:"px-1 py-0.5 rounded bg-subtle-fill/50 font-mono",children:"Space"})," Pause"]}),t.jsxs("span",{children:[t.jsx("kbd",{className:"px-1 py-0.5 rounded bg-subtle-fill/50 font-mono",children:"Esc"})," Clear"]})]}),t.jsx(g,{children:X&&t.jsx(ue,{node:X,connections:De,onClose:()=>{var e;te.current=void 0,ee(null),null==(e=Ze.current)||e.unselectAllPoints()}})})]})]})}export{xe as default};
