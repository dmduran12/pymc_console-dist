var w=Object.defineProperty;var Y=(s,t,e)=>t in s?w(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e;var T=(s,t,e)=>Y(s,typeof t!="symbol"?t+"":t,e);import{ae as M,cv as V,cw as F,cx as U,cy as I,ac as O,cz as b,cA as B,c9 as G,c7 as $,c8 as v,cB as K,cC as d,bB as a,cD as S,cE as z,cF as R,cG as C,cH as k,cI as D,cJ as W,cK as Z,cL as j,cM as E,cN as H,cO as x,cP as X,cQ as q,cR as Q,cS as J,cT as tt,cU as et,cg as st,cf as rt,cV as nt,cj as at,cW as ct,cX as it,cY as ht,cZ as f,c_ as m,c$ as ot,d0 as lt,d1 as ut,d2 as pt,d3 as dt,ch as N,ci as gt,d4 as Tt,d5 as ft,d6 as At,d7 as _t,d8 as yt}from"./index-B4woLUMa.js";class L{constructor(){T(this,"header",0);T(this,"transportCodes",[0,0]);T(this,"pathLen",0);T(this,"path",new Uint8Array(0));T(this,"payload",new Uint8Array(0));T(this,"decrypted",{});T(this,"_rssi",0);T(this,"_snr",0)}static fromBytes(t){const e=new L;try{return e.readFrom(t),{success:!0,packet:e}}catch(r){return{success:!1,error:r instanceof Error?r.message:String(r)}}}static fromHex(t){try{const e=M(t);return L.fromBytes(e)}catch(e){return{success:!1,error:e instanceof Error?e.message:String(e)}}}get routeType(){return this.header&V}get routeTypeName(){return F[this.routeType]??`UNKNOWN(${this.routeType})`}get payloadType(){return this.header>>U&I}get payloadTypeName(){return O[this.payloadType]??`UNKNOWN(${this.payloadType})`}get payloadVersion(){return this.header>>b&B}hasTransportCodes(){return G(this.routeType)}isFlood(){return $(this.routeType)}isDirect(){return v(this.routeType)}get pathBytes(){return Array.from(this.path)}get pathString(){return K(this.path)}get pathHexArray(){return Array.from(this.path).map(t=>d(t,!0))}get payloadLen(){return this.payload.length}get payloadHex(){return a(this.payload,!0)}getPayloadAppData(){const t=E+H+x;return this.payload.length>=t?this.payload.slice(t):new Uint8Array(0)}get rssi(){return this._rssi}set rssi(t){this._rssi=t}get snr(){return this._snr}set snr(t){this._snr=t}readFrom(t){let e=0;const r=t.length;S(e,1,r,"Missing header byte"),this.header=t[e++];const n=this.payloadVersion;if(n>z)throw new Error(`Unsupported packet version: ${n}`);if(this.hasTransportCodes()?(S(e,4,r,"Missing transport codes"),this.transportCodes=[R(t,e),R(t,e+2)],e+=4):this.transportCodes=[0,0],S(e,1,r,"Missing path_len"),this.pathLen=t[e++],this.pathLen>C)throw new Error(`path_len too large: ${this.pathLen} > ${C}`);return S(e,this.pathLen,r,"Truncated path"),this.path=t.slice(e,e+this.pathLen),e+=this.pathLen,this.payload=t.slice(e),k(this.payload.length),!0}writeTo(){let t=1;this.hasTransportCodes()&&(t+=4),t+=1,t+=this.path.length,t+=this.payload.length;const e=new Uint8Array(t);let r=0;return e[r++]=this.header,this.hasTransportCodes()&&(D(this.transportCodes[0],e,r),D(this.transportCodes[1],e,r+2),r+=4),e[r++]=this.path.length,e.set(this.path,r),r+=this.path.length,e.set(this.payload,r),e}toHex(){return a(this.writeTo(),!0)}async calculateHash(){return W(this.payloadType,this.pathLen,this.payload)}async calculateHashString(t){return Z(this.payloadType,this.pathLen,this.payload,t)}async calculateCRC(){return j(this.payloadType,this.pathLen,this.payload)}getRawLength(){let t=2+this.pathLen+this.payload.length;return this.hasTransportCodes()&&(t+=4),t}getSummary(){return{header:d(this.header,!0),routeType:this.routeTypeName,payloadType:this.payloadTypeName,version:this.payloadVersion,pathLen:this.pathLen,pathStr:this.pathString,transportCodes:this.hasTransportCodes()?[this.transportCodes[0].toString(16).toUpperCase().padStart(4,"0"),this.transportCodes[1].toString(16).toUpperCase().padStart(4,"0")]:null,payloadLen:this.payload.length,payloadHex:this.payloadHex,rawLength:this.getRawLength()}}toString(){const t=[`[${this.routeTypeName}/${this.payloadTypeName} v${this.payloadVersion}]`,`path=${this.pathString||"(empty)"}`,`payload=${this.payload.length}B`];return this.hasTransportCodes()&&t.push(`transport=[${this.transportCodes[0]},${this.transportCodes[1]}]`),t.join(" ")}}function Et(s){const t=E+H+x+1;if(s.length<t)return null;let e=0;const r=a(s.slice(e,e+E));e+=E;const n=m(s,e);e+=H;const o=a(s.slice(e,e+x));e+=x;const c=s[e++],i=ot(c),h=c&yt;let l="unknown";switch(h){case _t:l="chat";break;case At:l="repeater";break;case ft:l="room_server";break;case Tt:l="sensor";break}const u={type:"advert",publicKey:r,timestamp:n,signature:o,flags:c,flagsDescription:i,nodeType:l,rawAppData:a(s.slice(E+H+x))};if(c&lt&&e+8<=s.length){const p=s.slice(e,e+8),A=new ArrayBuffer(8);new Uint8Array(A).set(p);const P=new DataView(A),_=P.getInt32(0,!0),y=P.getInt32(4,!0);u.latitude=_/1e6,u.longitude=y/1e6,e+=8}if(c&ut&&(e+=2),c&pt&&(e+=2),c&dt&&e<s.length){let p=e;for(;p<s.length&&s[p]!==0;)p++;p>e&&(u.name=new TextDecoder().decode(s.slice(e,p)))}return u}function xt(s){if(s.length<4)return null;const t=m(s,0);return{type:"ack",crc:t.toString(16).toUpperCase().padStart(8,"0"),crcValue:t}}function mt(s){if(s.length===0)return{type:"path",pathLength:0,path:[],pathString:""};const t=s[0];if(s.length<1+t+1){const i=Math.min(t,s.length-1),h=Array.from(s.slice(1,1+i)).map(l=>d(l,!0));return{type:"path",pathLength:t,path:h,pathString:h.join("->")}}const e=Array.from(s.slice(1,1+t)).map(i=>d(i,!0)),r=e.join("->"),n=s[1+t],o=O[n]??`UNKNOWN(${n})`;let c;return s.length>1+t+1&&(c=a(s.slice(1+t+1))),{type:"path",pathLength:t,path:e,pathString:r,extraType:n,extraTypeName:o,extraData:c}}function St(s){if(s.length<9)return{type:"trace",traceTag:"00000000",traceTagValue:0,authCode:0,flags:0,pathHashes:[],pathString:"",snrValues:[],isComplete:!1,path:[],targetHash:""};const t=m(s,0),e=t.toString(16).toUpperCase().padStart(8,"0"),r=m(s,4),n=s[8],o=s.slice(9),c=Array.from(o).map(h=>d(h,!0)),i=c.join("->");return{type:"trace",traceTag:e,traceTagValue:t,authCode:r,flags:n,pathHashes:c,pathString:i,snrValues:[],isComplete:!1,path:c,targetHash:c.length>0?c[0]:""}}function Ht(s,t){const e=St(s);if(!e)return null;const r=[],n=t instanceof Uint8Array?Array.from(t):t;for(let c=0;c<n.length;c++){let i=n[c];i>127&&(i-=256);const h=i/4;r.push(Math.max(-20,Math.min(15,h)))}const o=r.length>=e.pathHashes.length;return{...e,snrValues:r,isComplete:o}}function Pt(s,t=0){const e=t>=1?2:1,r=f,n=e*2+r;if(s.length<n)return null;const o=a(s.slice(0,e),!0),c=a(s.slice(e,e*2),!0),i=e*2,h=a(s.slice(i,i+r)),l=s.slice(i+r);let u="",p=!0;try{const A=new TextDecoder("utf-8",{fatal:!0}).decode(l);/^[\x20-\x7E\u00A0-\uFFFF\n\r\t]*$/.test(A)&&(u=A,p=!1)}catch{}return p&&(u=a(l)),{type:"txt_msg",destHash:o,srcHash:c,cipherMac:h,timestamp:0,text:u,ciphertextHex:p?a(l):void 0,encrypted:p}}function Lt(s,t=0){const e=t>=1?4:f,r=1+e+1;if(s.length<r)return null;const n=s[0],o=d(n,!0),c=s.slice(1,1+e),i=s.slice(1+e);return{type:"grp_txt",channelHash:o,text:a(i),decrypted:!1,ciphertextHex:a(i),macHex:a(c)}}async function Vt(s,t=0){const e=t>=1?4:f,r=1+e+1;if(s.length<r)return null;const n=s[0],o=d(n,!0),c=s.slice(1,1+e),i=s.slice(1+e),h={type:"grp_txt",channelHash:o,text:a(i),decrypted:!1,ciphertextHex:a(i),macHex:a(c)};try{const l=await N(n,c,i);if(l&&l.plaintext.length>=5){h.channelName=l.channelName;const u=l.plaintext,p=m(u,0),A=u[4],_=new TextDecoder("utf-8",{fatal:!1}).decode(u.slice(5)).replace(/\uFFFD/g,"").replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F-\x9F]/g,"").replace(/\x00+$/,"").trim();h.decrypted=!0,h.isPublicHashChannel=!0,h.timestamp=p,h.flags=A,l.macCorrupted&&(h.macCorrupted=!0);const y=_.indexOf(": ");y>0?(h.senderName=_.slice(0,y),h.text=_.slice(y+2)):h.text=_}else{const u=await gt(n);h.isPublicHashChannel=u.length>0}}catch{}return h}function Rt(s){if(s.length<1+f+1)return null;const t=s[0],e=d(t,!0),r=s.slice(1,1+f),n=s.slice(1+f);return{type:"grp_data",channelHash:e,dataHex:a(n),dataLength:n.length,decrypted:!1,macHex:a(r)}}async function Ft(s){if(s.length<1+f+1)return null;const t=s[0],e=d(t,!0),r=s.slice(1,1+f),n=s.slice(1+f),o={type:"grp_data",channelHash:e,dataHex:a(n),dataLength:n.length,decrypted:!1,macHex:a(r)};try{const c=await N(t,r,n);c&&(o.channelName=c.channelName,o.decrypted=!0,o.decryptedHex=a(c.plaintext))}catch{}return o}function Ct(s){if(s.length<4)return null;const t=a(s.slice(0,2)),e=s[2],r=s[3],n=a(s.slice(4));return{type:"multipart",messageId:t,partNumber:e,totalParts:r,partData:n}}function Dt(s){if(s.length<1)return null;const t=s[0],e=t>>4&15,r=t&15,o={8:"DISCOVER_REQ",9:"DISCOVER_RESP"}[e]??`0x${e.toString(16)}`;return{type:"control",controlType:t,subtype:e,subtypeFlags:r,subtypeName:o,dataHex:a(s.slice(1)),dataLength:s.length-1,isInternal:e>=8}}function Ot(s){if(s.length<4)return null;const t=d(s[0],!0),e=d(s[1],!0),r=a(s.slice(2,4)),n=s.slice(4);return{type:"req",destHash:t,srcHash:e,cipherMac:r,ciphertextHex:a(n),ciphertextLength:n.length}}function Nt(s){if(s.length<4)return null;const t=d(s[0],!0),e=d(s[1],!0),r=a(s.slice(2,4)),n=s.slice(4);return{type:"response",destHash:t,srcHash:e,cipherMac:r,ciphertextHex:a(n),ciphertextLength:n.length}}function wt(s){if(s.length<35)return null;const t=d(s[0],!0),e=a(s.slice(1,33)),r=a(s.slice(33,35)),n=s.slice(35);return{type:"anon_req",destHash:t,senderPublicKey:e,cipherMac:r,ciphertextHex:a(n),ciphertextLength:n.length}}function g(s,t,e){return{type:"generic",payloadType:t,payloadTypeName:e,rawHex:a(s),length:s.length}}function Ut(s){const{payload:t,payloadType:e,payloadTypeName:r}=s;switch(e){case ht:return Et(t)??g(t,e,r);case it:return xt(t)??g(t,e,r);case ct:return mt(t)??g(t,e,r);case at:return Ht(t,s.path)??g(t,e,r);case nt:return Pt(t,s.payloadVersion)??g(t,e,r);case rt:return Lt(t,s.payloadVersion)??g(t,e,r);case st:return Rt(t)??g(t,e,r);case et:return Ct(t)??g(t,e,r);case tt:return Dt(t)??g(t,e,r);case J:return Ot(t)??g(t,e,r);case Q:return Nt(t)??g(t,e,r);case q:return wt(t)??g(t,e,r);case X:default:return g(t,e,r)}}export{L as P,Vt as a,Ft as b,Ut as c,Pt as d,Ht as e,Et as f};
