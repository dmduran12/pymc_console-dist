import{r as n,j as e,H as Z,k as $,B as ee,U as ae,f as se}from"./vendor-react-CHg3w57L.js";import{c as y}from"./vendor-core-CgllfypI.js";import{m as te,p as le,t as re,v as ie,W as ne,a1 as oe,D as B,a3 as q,a4 as G,B as U,q as I,T as ce}from"./index-B4woLUMa.js";import{C as de,a as ue,V as me,A as pe,Q as xe,o as he,U as be,Y as K,h as V,X as ge}from"./vendor-icons-rRVc_l7g.js";import{g as Y,u as fe,P as ve}from"./PacketList-Bg7bJx6b.js";import{u as je,a as ye}from"./usePipelineStore-CW29AYoP.js";import{c as Ne,a as we,A as Ce}from"./AnalyzerFilterPanel-BlxSmIeb.js";import{u as Se,r as ke}from"./consumer-registry-CWCmZQuW.js";import{P as Pe,a as Re,B as Fe,C as H}from"./PageLayout-vzO_WRlt.js";import{T as De}from"./TimeRangeStepper-CHvn0Aaa.js";import{R as Te}from"./Grid-C8oPbJfP.js";import"./cosmograph-RBQGoH9-.js";import"./vendor-charts-DuSK2RSZ.js";import"./vendor-motion-CXybMqb1.js";import"./vendor-fonts-CgDm-k6O.js";import"./primitives-DxP4M5z8.js";import"./payload-decoders-CXnzAzcz.js";import"./badge-colors-BNUqIXCA.js";import"./chat-utils-pV5FH_xH.js";import"./SignalIndicator-C8dAI7pL.js";import"./DataBox-CbYpEKKd.js";import"./useMapViewStore-Dxt0JgN_.js";import"./node-types-CTinVm-W.js";import"./geo-utils-BP1zBK9h.js";function Me({options:r,value:t,onChange:c,defaultValue:d,displayValue:o,filter:m,placeholder:b,disabled:p,invalid:l,name:N,"aria-label":P,className:h,children:R}){const[f,F]=n.useState(""),D=o??(x=>x!=null?String(x):""),C=m??((x,g)=>D(x).toLowerCase().includes(g.toLowerCase())),w=n.useMemo(()=>f?r.filter(x=>C(x,f)):r,[r,f,C]);return e.jsx(Z,{value:t,onChange:c,defaultValue:d,disabled:p,name:N,onClose:()=>F(""),children:e.jsxs("div",{className:y("relative",h),children:[e.jsxs("div",{className:"relative",children:[e.jsx($,{"aria-label":P,displayValue:D,onChange:x=>F(x.target.value),placeholder:b,className:y(["w-full radius-inner py-2 pl-3 pr-10","text-sm text-fg-primary placeholder:text-fg-muted","bg-input-bg",l?"border border-sys-red":"border border-input-border","ring-focus-inset","hover:border-edge-strong","disabled:opacity-40 disabled:pointer-events-none disabled:cursor-not-allowed","transition-colors"])}),e.jsx(ee,{className:"absolute inset-y-0 right-0 flex items-center pr-3 group",children:e.jsx(de,{className:"w-4 h-4 text-fg-muted transition-transform duration-200 group-data-[open]:rotate-180"})})]}),e.jsx(ae,{anchor:"bottom start",transition:!0,className:y(["w-[var(--input-width)] min-w-[180px]","max-h-60 overflow-y-auto overscroll-contain scroll-py-1","radius-inset p-1 mt-1","surface-elevated","focus:outline-none","transition-opacity","data-[closed]:opacity-0","data-[enter]:duration-150 data-[leave]:duration-100","z-50"]),children:w.length===0&&f!==""?e.jsx("div",{className:"px-3 py-2 text-sm text-fg-muted",children:"No results found"}):w.map((x,g)=>e.jsx(n.Fragment,{children:R(x)},g))})]})})}function Ae({value:r,disabled:t,className:c,children:d}){return e.jsx(se,{as:n.Fragment,value:r,disabled:t,children:({selected:o,focus:m})=>e.jsxs("div",{className:y("flex items-center gap-2 px-3 py-2 radius-control cursor-default","text-sm",m&&"bg-sys-blue text-white",!m&&"text-fg-primary",o&&!m&&"text-sys-blue",t&&"opacity-50 cursor-not-allowed",c),children:[e.jsx("span",{className:"w-4 flex-shrink-0",children:o&&e.jsx(ue,{className:"w-4 h-4"})}),e.jsx("span",{className:"truncate flex-1",children:d})]})})}function Le({className:r,...t}){return e.jsx("span",{...t,className:y("truncate",r)})}function j({value:r,onChange:t,options:c,placeholder:d,disabled:o,className:m,"aria-label":b}){const p=c.find(l=>l.value===r);return e.jsx(Me,{options:c,value:p,onChange:l=>{l&&t(l.value)},displayValue:l=>(l==null?void 0:l.label)??"",filter:(l,N)=>l.label.toLowerCase().includes(N.toLowerCase()),placeholder:d,disabled:o,className:m,"aria-label":b,children:l=>e.jsx(Ae,{value:l,disabled:l.disabled,children:e.jsx(Le,{children:l.label})})})}const W=[{target:"PacketStats",fn:"type",minStage:1}];ke(W);function k({icon:r,label:t,value:c,color:d,percentage:o}){return e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:y("p-1.5 rounded-md",d),children:r}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-sm font-semibold text-fg-primary",children:c.toLocaleString()}),e.jsxs("span",{className:"text-xs text-fg-muted leading-tight",children:[t,o!==void 0&&e.jsxs("span",{className:"ml-1 opacity-70",children:["(",o,"%)"]})]})]})]})}function He({packets:r}){Se(W);const t=n.useMemo(()=>{let c=0,d=0,o=0;const m=new Set;let b=0,p=0;for(const h of r){switch(Y(h)){case"forward":c++;break;case"dropped":d++;break;case"duplicate":o++;break}h.src_hash&&m.add(h.src_hash),h.rssi&&(b+=h.rssi,p++)}const l=r.length,N=p>0?Math.round(b/p):0;return{total:l,rx:l,fwd:c,dropped:d,duplicate:o,uniqueSources:m.size,avgRssi:N,rxPercent:100,fwdPercent:l>0?Math.round(c/l*100):0,droppedPercent:l>0?Math.round(d/l*100):0}},[r]);return r.length===0?null:e.jsx("div",{className:"surface-base depth-raised rounded-2xl p-3 pr-4",children:e.jsxs("div",{className:"grid grid-cols-2 gap-3 sm:flex sm:items-center sm:justify-between sm:gap-6",children:[e.jsx(k,{icon:e.jsx(me,{className:"w-3.5 h-3.5 text-sys-blue"}),label:"Received",value:t.rx,color:"bg-sys-blue/10",percentage:t.rxPercent}),e.jsx(k,{icon:e.jsx(pe,{className:"w-3.5 h-3.5 text-sys-green"}),label:"Forwarded",value:t.fwd,color:"bg-sys-green/10",percentage:t.fwdPercent}),e.jsx(k,{icon:e.jsx(xe,{className:"w-3.5 h-3.5 text-sys-red"}),label:"Dropped",value:t.dropped,color:"bg-sys-red/10",percentage:t.droppedPercent}),e.jsx(k,{icon:e.jsx(he,{className:"w-3.5 h-3.5 text-fg-muted"}),label:"Duplicates",value:t.duplicate,color:"bg-subtle-fill"}),e.jsxs("div",{className:"hidden sm:flex items-center gap-6 ml-auto",children:[e.jsx(k,{icon:e.jsx(be,{className:"w-3.5 h-3.5 text-sys-indigo"}),label:"Sources",value:t.uniqueSources,color:"bg-sys-indigo/10"}),e.jsxs("div",{className:"flex flex-col items-end pr-1",children:[e.jsxs("span",{className:"type-data-sm text-fg-secondary",children:[t.avgRssi," dBm"]}),e.jsx("span",{className:"text-xs text-fg-muted",children:"Avg Signal"})]})]})]})})}const _e=n.memo(He);function na(){const r=te(),t=le(),c=je(),d=fe(a=>a.requestChannel),o=re(),m=t==null?void 0:t.local_hash,b=t==null?void 0:t.neighbors,p=ie(),l=ne(),P=oe().isBackgroundLoading&&p>=5,[h,R]=n.useState(!1),[f,F]=n.useState(!0),D=n.useCallback(a=>F(a),[]),[s,C]=n.useState({limit:500,status:"all"}),[w,x]=n.useState(Ne),g=n.useMemo(()=>{const a=Math.floor(Date.now()/1e3),i=B[p].minutes;return{start:a-i*60,end:a}},[p]),_=n.useMemo(()=>{const a=(t==null?void 0:t.neighbors)??{};return Object.fromEntries(Object.entries(a).filter(([i])=>!o.has(i)))},[t==null?void 0:t.neighbors,o]),M=ye(),[E,Q]=n.useState(Date.now);n.useEffect(()=>{s.timeRange&&s.timeRange>0&&queueMicrotask(()=>Q(Date.now()))},[s.timeRange,r]);const T=n.useMemo(()=>we(r,w,M,g),[r,w,M,g]),O=n.useMemo(()=>{const a=s.limit??500;return[...T.length<=a?T:T.slice(-a)].sort((u,S)=>(S.timestamp??0)-(u.timestamp??0))},[T,s.limit]),X=r.length===0,z=n.useMemo(()=>{let a=O;if(s.type!==void 0){const i=q[s.type];a=a.filter(u=>{const S=u.type??u.payload_type,L=u.payload_type_name;return S===s.type||L===i})}if(s.route!==void 0){const i=G[s.route];a=a.filter(u=>{const S=u.route??u.route_type,L=u.route_type_name;return S===s.route||L===i})}if(s.status&&s.status!=="all"&&(a=a.filter(i=>Y(i)===s.status)),s.signalMin!==void 0&&(a=a.filter(i=>i.rssi>=s.signalMin)),s.timeRange&&s.timeRange>0){const i=E/1e3-s.timeRange*3600;a=a.filter(u=>u.timestamp>=i)}return a},[O,s.type,s.route,s.status,s.signalMin,s.timeRange,E]),v=(a,i)=>C(u=>({...u,[a]:i})),J=()=>C({limit:s.limit,status:"all"}),A=s.type!==void 0||s.route!==void 0||s.status&&s.status!=="all"||s.signalMin!==void 0||s.timeRange&&s.timeRange>0;return e.jsxs(Pe,{children:[e.jsx(Re,{title:"Packet History",icon:e.jsx(V,{}),controls:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(U,{outline:!0,color:A?"primary":"muted",onClick:()=>R(!h),className:"sm:hidden",children:[e.jsx(K,{"data-slot":"icon"}),A&&e.jsx("span",{className:"w-1.5 h-1.5 rounded-full bg-sys-blue"})]}),e.jsx(De,{ranges:B,selectedIndex:p,onSelect:l,isPending:P})]})}),e.jsxs(Fe,{children:[e.jsx(Te,{template:"auto",className:"relative z-10",children:e.jsx(H,{neomorphic:!0,className:"overflow-visible",children:e.jsx(Ce,{parentStartTs:g.start,parentEndTs:g.end,neighbors:_,filter:w,onChange:x})})}),e.jsxs(H,{neomorphic:!0,noPadding:!0,className:y("overflow-hidden transition-all duration-200",h?"max-h-96 opacity-100":"max-h-0 opacity-0 sm:max-h-96 sm:opacity-100"),children:[e.jsx(I,{listHeader:!0,icon:e.jsx(K,{className:"icon-sm"}),title:"Filters",actions:A?e.jsxs(U,{plain:!0,color:"muted",onClick:J,className:"!text-xs !py-0.5 !px-1.5",children:[e.jsx(ge,{"data-slot":"icon",className:"!w-3 !h-3"}),"Clear"]}):void 0}),e.jsx("div",{className:"p-3 sm:p-4",children:e.jsxs("div",{className:"grid grid-cols-2 sm:flex sm:flex-wrap gap-3",children:[e.jsxs("div",{className:"flex-1 min-w-[140px]",children:[e.jsx("label",{className:"type-micro block mb-1",children:"Type"}),e.jsx(j,{value:s.type??"",onChange:a=>v("type",a===""?void 0:Number(a)),options:[{value:"",label:"All Types"},...Object.entries(q).map(([a,i])=>({value:Number(a),label:i}))],placeholder:"Search types...","aria-label":"Filter by packet type"})]}),e.jsxs("div",{className:"flex-1 min-w-[140px]",children:[e.jsx("label",{className:"type-micro block mb-1",children:"Route"}),e.jsx(j,{value:s.route??"",onChange:a=>v("route",a===""?void 0:Number(a)),options:[{value:"",label:"All Routes"},...Object.entries(G).map(([a,i])=>({value:Number(a),label:i}))],placeholder:"Search routes...","aria-label":"Filter by route type"})]}),e.jsxs("div",{className:"flex-1 min-w-[140px]",children:[e.jsx("label",{className:"type-micro block mb-1",children:"Status"}),e.jsx(j,{value:s.status??"all",onChange:a=>v("status",a),options:[{value:"all",label:"All Status"},{value:"rx",label:"Received"},{value:"forward",label:"Forwarded"},{value:"dropped",label:"Dropped"},{value:"duplicate",label:"Duplicate"}],placeholder:"Search status...","aria-label":"Filter by status"})]}),e.jsxs("div",{className:"flex-1 min-w-[120px]",children:[e.jsx("label",{className:"type-micro block mb-1",children:"Time"}),e.jsx(j,{value:s.timeRange??0,onChange:a=>v("timeRange",a===0?void 0:a),options:[{value:0,label:"All Time"},{value:1,label:"Last 1h"},{value:6,label:"Last 6h"},{value:24,label:"Last 24h"},{value:168,label:"Last 7d"}],placeholder:"Search time...","aria-label":"Filter by time range"})]}),e.jsxs("div",{className:"flex-1 min-w-[130px]",children:[e.jsx("label",{className:"type-micro block mb-1",children:"Signal"}),e.jsx(j,{value:s.signalMin??"",onChange:a=>v("signalMin",a===""?void 0:Number(a)),options:[{value:"",label:"Any Signal"},{value:-90,label:"Strong (≥-90)"},{value:-100,label:"Good (≥-100)"},{value:-110,label:"Fair (≥-110)"},{value:-120,label:"Weak (≥-120)"}],placeholder:"Search signal...","aria-label":"Filter by signal strength"})]}),e.jsxs("div",{className:"flex-1 min-w-[100px]",children:[e.jsx("label",{className:"type-micro block mb-1",children:"Limit"}),e.jsx(j,{value:s.limit??500,onChange:a=>v("limit",a),options:[{value:100,label:"100"},{value:200,label:"200"},{value:500,label:"500"},{value:1e3,label:"1K"},{value:2e3,label:"2K"},{value:5e3,label:"5K"},{value:1e4,label:"10K"}],placeholder:"Limit...","aria-label":"Packet limit"})]}),e.jsxs("div",{className:"flex-1 min-w-[100px]",children:[e.jsx("label",{className:"type-micro block mb-1",children:"Per Page"}),e.jsx(j,{value:s.perPage??50,onChange:a=>v("perPage",a),options:[{value:25,label:"25"},{value:50,label:"50"},{value:100,label:"100"},{value:200,label:"200"},{value:500,label:"500"}],placeholder:"Per page...","aria-label":"Packets per page"})]})]})})]}),e.jsx(_e,{packets:z}),e.jsxs(H,{neomorphic:!0,noPadding:!0,className:"!overflow-visible",children:[e.jsx(I,{listHeader:!0,icon:e.jsx(V,{className:"icon-sm"}),title:"Packet History",actions:e.jsx(ce,{enabled:f,onChange:D,label:"Hide Dupes",size:"sm"})}),e.jsx(ve,{packets:z,allPackets:r,localHash:m,neighbors:b,resolveSource:M,getDecodedContent:c,onChannelClick:d,loading:X,showPagination:!0,perPage:s.perPage??50,hideDupes:f,emptyMessage:"No packets found"})]})]})]})}export{na as default};
