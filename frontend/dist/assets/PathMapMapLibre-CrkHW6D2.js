import{j as e}from"./index-CLi6xczL.js";import{b as t}from"./recharts-bmHCCfxU.js";import{M as o,d as n,a as r,b as s,P as a}from"./maplibre-gl-haoA4z5Y.js";import"./maplibre-gl-CFO9X1Ek.js";function i(e,t){if(!e)throw new Error(t)}let l=0;function d(e){const r=t.useContext(o).map.getMap(),s=t.useRef(e),[,a]=t.useState(0),d=t.useMemo(()=>e.id||"jsx-source-"+l++,[]);t.useEffect(()=>{if(r){const e=()=>setTimeout(()=>a(e=>e+1),0);return r.on("styledata",e),e(),()=>{var t;if(r.off("styledata",e),r.style&&r.style._loaded&&r.getSource(d)){const e=null==(t=r.getStyle())?void 0:t.layers;if(e)for(const t of e)t.source===d&&r.removeLayer(t.id);r.removeSource(d)}}}},[r]);let c=r&&r.style&&r.getSource(d);return c?function(e,t,o){var r,s,a;i(t.id===o.id,"source id changed"),i(t.type===o.type,"source type changed");let l="",d=0;for(const i in t)"children"===i||"id"===i||n(o[i],t[i])||(l=i,d++);if(!d)return;const c=t.type;if("geojson"===c)e.setData(t.data);else if("image"===c)e.updateImage({url:t.url,coordinates:t.coordinates});else switch(l){case"coordinates":null==(r=e.setCoordinates)||r.call(e,t.coordinates);break;case"url":null==(s=e.setUrl)||s.call(e,t.url);break;case"tiles":null==(a=e.setTiles)||a.call(e,t.tiles)}}(c,e,s.current):c=function(e,t,o){if(e.style&&e.style._loaded){const n={...o};return delete n.id,delete n.children,e.addSource(t,n),e.getSource(t)}return null}(r,d,e),s.current=e,c&&t.Children.map(e.children,e=>e&&t.cloneElement(e,{source:d}))||null}let c=0;function u(e){const r=t.useContext(o).map.getMap(),s=t.useRef(e),[,a]=t.useState(0),l=t.useMemo(()=>e.id||"jsx-layer-"+c++,[]);if(t.useEffect(()=>{if(r){const e=()=>a(e=>e+1);return r.on("styledata",e),e(),()=>{r.off("styledata",e),r.style&&r.style._loaded&&r.getLayer(l)&&r.removeLayer(l)}}},[r]),r&&r.style&&r.getLayer(l))try{!function(e,t,o,r){if(i(o.id===r.id,"layer id changed"),i(o.type===r.type,"layer type changed"),"custom"===o.type||"custom"===r.type)return;const{layout:s={},paint:a={},filter:l,minzoom:d,maxzoom:c,beforeId:u}=o;if(u!==r.beforeId&&e.moveLayer(t,u),s!==r.layout){const o=r.layout||{};for(const r in s)n(s[r],o[r])||e.setLayoutProperty(t,r,s[r]);for(const n in o)s.hasOwnProperty(n)||e.setLayoutProperty(t,n,void 0)}if(a!==r.paint){const o=r.paint||{};for(const r in a)n(a[r],o[r])||e.setPaintProperty(t,r,a[r]);for(const n in o)a.hasOwnProperty(n)||e.setPaintProperty(t,n,void 0)}n(l,r.filter)||e.setFilter(t,l),d===r.minzoom&&c===r.maxzoom||e.setLayerZoomRange(t,d,c)}(r,l,e,s.current)}catch(d){}else!function(e,t,o){if(e.style&&e.style._loaded&&(!("source"in o)||e.getSource(o.source))){const n={...o,id:t};delete n.beforeId,e.addLayer(n,o.beforeId)}}(r,l,e);return s.current=e,null}const p="#4F46E5",m="#F9D26F",f="#B49DFF",y="#39D98A",h="#B49DFF";function x(e,t,o,n=!1,r=!1,s=!1){let a;a=r?y:s?h:e?p:t?"#6366F1":o?"transparent":m;const i=e||t||!o||r||s;return`<div style="\n    width: 14px;\n    height: 14px;\n    background: ${a};\n    border-radius: 50%;\n    border: ${i?0:5}px solid ${i?"transparent":"#4338CA"};\n    box-sizing: border-box;\n    transition: box-shadow 0.15s ease;\n    ${n?`box-shadow: 0 0 0 3px ${f}40, 0 0 8px ${f}60;`:""}\n  "></div>`}const g={id:"path-line",type:"line",paint:{"line-color":"#3B3F4A","line-width":2,"line-opacity":.7},layout:{"line-cap":"round","line-join":"round"}};function b({resolvedPath:o,localNode:n,hubNodes:i=[],hoveredHopIndex:l,onHoverHop:c}){const f=t.useRef(null),b=t.useMemo(()=>new Set(i),[i]),[v,j]=t.useState(null),[k,S]=t.useState(0);t.useEffect(()=>{var e;const t=null==(e=f.current)?void 0:e.getMap();if(!t)return;const o=t.getCanvas();if(!o)return;const n=e=>{e.preventDefault()},r=()=>{S(e=>e+1)};return o.addEventListener("webglcontextlost",n),o.addEventListener("webglcontextrestored",r),()=>{o.removeEventListener("webglcontextlost",n),o.removeEventListener("webglcontextrestored",r)}},[k]);const{positions:C,markers:L,pathLineGeoJSON:w}=t.useMemo(()=>{const e=[],t=[],n=[];o.hops.forEach((o,r)=>{const s=o.candidates.filter(e=>{return t=e.latitude,o=e.longitude,0!==t||0!==o;var t,o});if(0===s.length)return;const a=[...s].sort((e,t)=>t.probability-e.probability)[0];n.push([a.longitude,a.latitude]);const i=!0===o.isSource,l=!0===o.isDestination;s.forEach((n,a)=>{const d=[n.latitude,n.longitude];e.push(d);const c=0===a;t.push({position:d,prefix:o.prefix,confidence:o.confidence,candidateCount:s.length,hopIndex:r,candidate:n,isHub:b.has(n.hash),isPrimary:c,isSource:i,isDestination:l})})});const r={type:"FeatureCollection",features:n.length>=2?[{type:"Feature",properties:{},geometry:{type:"LineString",coordinates:n}}]:[]};return{positions:e,markers:t,pathLineGeoJSON:r}},[o,b]),{center:N,zoom:E}=t.useMemo(()=>{if(0===C.length)return n?{center:[n.longitude,n.latitude],zoom:10}:{center:[0,0],zoom:2};let e=1/0,t=-1/0,o=1/0,r=-1/0;for(const[n,u]of C)n<e&&(e=n),n>t&&(t=n),u<o&&(o=u),u>r&&(r=u);const s=(e+t)/2,a=(o+r)/2,i=t-e,l=r-o,d=Math.max(i,l);let c;return c=d<.01?15:d<.05?13:d<.1?12:d<.5?10:d<1?9:d<5?7:5,{center:[a,s],zoom:c}},[C,n]);t.useEffect(()=>{if(!f.current||C.length<2)return;let e=1/0,t=-1/0,o=1/0,n=-1/0;for(const[r,s]of C)r<e&&(e=r),r>t&&(t=r),s<o&&(o=s),s>n&&(n=s);f.current.fitBounds([[o,e],[n,t]],{padding:30,maxZoom:16,duration:0})},[C]);const F=t.useCallback(e=>{j({longitude:e.position[1],latitude:e.position[0],marker:e})},[]);return 0===C.length?e.jsx("div",{className:"h-[200px] flex items-center justify-center text-text-muted text-sm bg-bg-elevated",children:"No mappable path data"}):e.jsxs(r,{ref:f,initialViewState:{longitude:N[0],latitude:N[1],zoom:E},style:{height:"200px",width:"100%"},mapStyle:"https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json",attributionControl:!1,children:[w.features.length>0&&e.jsx(d,{id:"path-line-source",type:"geojson",data:w,children:e.jsx(u,{...g})}),L.map(t=>{const o=l===t.hopIndex;return e.jsx(s,{longitude:t.position[1],latitude:t.position[0],anchor:"center",onClick:()=>F(t),children:e.jsx("div",{style:{cursor:"pointer",opacity:t.isPrimary?1:.5},onMouseEnter:()=>null==c?void 0:c(t.hopIndex),onMouseLeave:()=>null==c?void 0:c(null),dangerouslySetInnerHTML:{__html:x(t.candidate.isLocal||!1,t.isHub,t.isPrimary,o,t.isSource,t.isDestination)}})},`${t.hopIndex}-${t.candidate.hash}`)}),v&&e.jsx(a,{longitude:v.longitude,latitude:v.latitude,anchor:"bottom",offset:[0,-12],closeOnClick:!1,onClose:()=>j(null),className:"maplibre-popup",children:e.jsxs("div",{className:"text-xs",children:[e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("span",{className:"font-semibold",children:v.marker.candidate.name}),v.marker.isSource&&e.jsx("span",{className:"px-1 py-0.5 text-[8px] font-bold rounded",style:{backgroundColor:y,color:"#000"},children:"SRC"}),v.marker.isDestination&&e.jsx("span",{className:"px-1 py-0.5 text-[8px] font-bold rounded",style:{backgroundColor:h,color:"#000"},children:"DST"}),v.marker.isHub&&e.jsx("span",{className:"px-1 py-0.5 text-[8px] font-bold rounded",style:{backgroundColor:"#FBBF24",color:"#000"},children:"HUB"}),v.marker.candidate.isLocal&&e.jsx("span",{className:"px-1 py-0.5 text-[8px] font-bold rounded",style:{backgroundColor:p,color:"#fff"},children:"LOCAL"})]}),e.jsxs("div",{className:"text-text-muted font-mono text-[10px]",children:[v.marker.prefix," â€¢ ",v.marker.candidate.hash.slice(0,10),"..."]}),!v.marker.isPrimary&&v.marker.candidateCount>1&&e.jsxs("div",{style:{color:m},children:["Alternative (",(100*v.marker.candidate.probability).toFixed(0),"%)"]}),v.marker.isPrimary&&v.marker.candidateCount>1&&e.jsxs("div",{className:"text-text-muted",children:[v.marker.candidateCount," candidates"]})]})})]},k)}export{b as default};
