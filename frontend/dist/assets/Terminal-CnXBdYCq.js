var e=Object.defineProperty,t=(t,r,n)=>((t,r,n)=>r in t?e(t,r,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[r]=n)(t,"symbol"!=typeof r?r+"":r,n);import{j as r,r as n,c as s}from"./vendor-react-j_fHog8x.js";import{D as a,o,L as i}from"./xterm-Cq-DlOOL.js";import{c,bu as l,bv as u,bw as d,bx as p,by as m,bz as h,bA as f,bB as g,b3 as $,a7 as y,bC as w,$ as v,_ as x,aA as b,bD as _,bE as k,bF as S,bn as C,K as j,bG as N,N as T,B as E,n as R,bH as A,bI as I,bJ as F}from"./index-BO56Zu3W.js";import{s as M}from"./signal-scoring-CcBiRcks.js";import{h as L,c as D,D as O}from"./geo-utils-b9uKnmp6.js";import{a as B}from"./ping-Do7r7qh6.js";import{c as P}from"./vendor-core-CDNU4oKM.js";import{P as H,d as U}from"./payload-decoders-H_RJFKQm.js";import{g as z,r as q}from"./system-DNeFz7OB.js";import{g as W,K as X,F as K,S as G}from"./KeycapButton-Bid5uJVp.js";import{P as V,b as J,B as Y,a as Q}from"./PageLayout-BrLXEMTL.js";import"./maplibre-gl-b91ci4Kr.js";const Z=c("package",[["path",{d:"M11 21.73a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73z",key:"1a0edw"}],["path",{d:"M12 22V12",key:"d0xqtd"}],["polyline",{points:"3.29 7 12 12 20.71 7",key:"ousv84"}],["path",{d:"m7.5 4.27 9 5.15",key:"1c824w"}]]);class ee{constructor(){t(this,"commands",[])}register(...e){this.commands.push(...e)}find(e){let t;for(const r of this.commands)r.matches(e)&&(!t||r.name.length>t.name.length)&&(t=r);return t}all(){return this.commands}}class te{constructor(){t(this,"aliases",[]),t(this,"params")}matches(e){const t=e.toLowerCase().trim(),r=e=>t===e||t.startsWith(e+" ");return r(this.name)||this.aliases.some(r)}argsAfterName(e){const t=e.toLowerCase().trim(),r=[this.name,...this.aliases].sort((e,t)=>t.length-e.length);for(const n of r)if(t.startsWith(n))return e.trim().slice(n.length).trim();return e.trim()}}const re="[",ne=`${re}0m`,se=`${re}1m`,ae=`${re}2m`,oe=`${re}3m`,ie=`${re}32m`,ce=`${re}31m`,le=`${re}33m`,ue=`${re}36m`,de=`${re}34m`,pe=`${re}90m`,me=`${re}92m`,he=`${re}96m`;function fe(e,t){switch(t){case"success":return`${ie}${e}${ne}`;case"error":return`${ce}${e}${ne}`;case"warning":return`${le}${e}${ne}`;case"info":return`${ue}${e}${ne}`;case"value":return`${de}${e}${ne}`;case"system":return`${pe}${e}${ne}`;default:return e}}function ge(e){return`${se}${e}${ne}`}function $e(e){return`${ae}${e}${ne}`}function ye(e){return`${de}${e}${ne}`}function we(e){return`${pe}${e}${ne}`}function ve(e,t){return`${pe}${e}: ${ne}${de}${se}${t}${ne}`}function xe(e,t,r=22){const n=e.split(" "),s=n[0];let a=ue;return"get"===s?a=ie:"set"===s&&(a=le),`  ${n.length>1?`${a}${se}${s}${ne} ${de}${n.slice(1).join(" ")}${ne}`:`${a}${se}${e}${ne}`}${" ".repeat(Math.max(1,r-e.length))}${pe}${t}${ne}`}function be(e){return`${se}${de}${e}${ne}`}function _e(e){return`${pe}${oe}${e}${ne}`}const ke=`${pe}$ ${ne}`;function Se(e){return`${ce}${se}‚óè${ne} ${pe}${e}${ne}`}function Ce(e){const t=e<1e3?`${e.toFixed(0)}ms`:`${(e/1e3).toFixed(1)}s`;return`${function(e){return e<1500?me:e<4e3?ie:e<8e3?le:e<15e3?ce:`${ce}${se}`}(e)}${t}${ne}`}function je(e,t){return`${function(e){switch(e){case"excellent":return he;case"good":return ie;case"fair":return le;case"poor":return ce;case"critical":return`${ce}${se}`;default:return pe}}(t)}${e}${ne}`}const Ne=[ce,ce,le,ie,he];function Te(e,t){return`${Ne[t]??pe}${e}${ne}`}function Ee(e){return e.replace(/[\p{Emoji_Presentation}\p{Extended_Pictographic}\uFE0F\u200D]/gu,"").trim()}const Re="[2K\r";function Ae(e=1){return`[${e}A`}const Ie="[?1049l",Fe="[?25h";function Me(e){return e.replace(/\x1b\[[0-9;]*m/g,"")}function Le(e){return Me(e).length}function De(e,t){let r=0;for(const n of e){const e=Me(n).length;r+=0===e?1:Math.ceil(e/t)}return r}function Oe(e,t){const r=function(e){return getComputedStyle(document.documentElement).getPropertyValue(e).trim()}(e);return r||t}function Be(){const e=Oe("--terminal-bg","#0d0d0d"),t=Oe("--text-primary","#e0e0e0"),r=Oe("--accent-primary","#3b82f6"),n=Oe("--accent-primary","#3b82f6")+"40",s=Oe("--accent-danger","#ef4444"),a=Oe("--accent-success","#22c55e"),o=Oe("--accent-secondary","#f59e0b"),i=Oe("--accent-primary","#3b82f6"),c=Oe("--accent-tertiary","#06b6d4"),l=Oe("--text-muted","#666666"),u=Oe("--text-secondary","#a0a0a0");return{background:e,foreground:t,cursor:r,cursorAccent:e,selectionBackground:n,selectionForeground:t,black:Oe("--bg-surface","#1a1a1a"),red:s,green:a,yellow:o,blue:i,magenta:o,cyan:c,white:t,brightBlack:l,brightRed:s,brightGreen:a,brightYellow:o,brightBlue:i,brightMagenta:o,brightCyan:c,brightWhite:u}}const Pe="[",He=`${Pe}0m`,Ue=`${Pe}1m`,ze=`${Pe}2m`,qe=`${Pe}34m`,We=`${Pe}90m`,Xe="        ",Ke=[{label:"INFORMATION",entries:[{cmd:"status",desc:"Repeater status summary",alias:"st"},{cmd:"top",desc:"Live system overview (Ctrl+C to exit)",alias:"htop"},{cmd:"uptime",desc:"System uptime"},{cmd:"board",desc:"Board / platform info"},{cmd:"packets",desc:"Packet statistics"}]},{label:"NETWORK",entries:[{cmd:"neighbors [sort]",desc:"Direct RF neighbors",alias:"nb",sub:"sig ¬∑ name ¬∑ rssi ¬∑ snr ¬∑ dist ¬∑ heard"},{cmd:"ping {name}",desc:"Ping neighbor (name or 0xXX)"},{cmd:"identities",desc:"List configured identities",alias:"id ids"},{cmd:"keys",desc:"Transport keys"},{cmd:"acl",desc:"ACL statistics"},{cmd:"rooms",desc:"Room statistics"}]},{label:"RADIO",entries:[{cmd:"get {param}",desc:"Read parameter"},{cmd:"set {param} {value}",desc:"Write parameter"},{cmd:"advert",desc:"Send advertisement"}]},{label:"SYSTEM",entries:[{cmd:"restart",desc:"Restart service",alias:"reboot"},{cmd:"start cap [seconds]",desc:"Start packet capture"},{cmd:"end cap",desc:"Stop capture"},{cmd:"list cap",desc:"List captures"},{cmd:"export cap [id]",desc:"Download capture"}]},{label:"TOOLS",entries:[{cmd:"convert hex {value}",desc:"Hex ‚Üí base64"},{cmd:"convert base64 {value}",desc:"Base64 ‚Üí hex"},{cmd:"clear",desc:"Clear terminal",alias:"cls"},{cmd:"help [command]",desc:"Show this help",alias:"? h"}]}],Ge=[{cat:"Identity",params:["name","role","lat","lon","public.key"]},{cat:"Radio",params:["radio","freq","tx","bw","sf","cr"]},{cat:"Timing",params:["af","txdelay","direct.txdelay","rxdelay"]},{cat:"Repeater",params:["mode","duty","repeat","flood.max","advert.interval"]},{cat:"Advanced",params:["multi.acks","int.thresh","agc.reset.interval"]},{cat:"set only",params:["log","prv.key"]}];function Ve(e){return`${We}${"‚îÄ".repeat(e)}${He}`}function Je(e){const t=Math.max(3,e-12-8-6);return`  ${qe}${Ue}pymc console${He} ${Ve(t)} ${We}terminal${He}`}function Ye(e){return`  ${We}${e}${He}`}function Qe(e,t){const r=[],n=e.alias?`  ${ze}${e.alias}${He}`:"";return 4+Math.max(e.cmd.length,24)+e.desc.length+(e.alias?2+e.alias.length:0)<=t?r.push("  "+xe(e.cmd,e.desc,24)+n):(r.push("  "+xe(e.cmd,"",24)),r.push(Xe+we(e.desc)+n)),e.sub&&r.push(`${Xe}${$e("‚îî "+e.sub)}`),r}function Ze(e){return e.split(" ¬∑ ").map(e=>`${qe}${e}${He}`).join(`${We} ¬∑ ${He}`)}function et(e,t){const r=[];let n=[],s=0;for(const a of e){const e=n.length>0?3+a.length:a.length;s+e>t&&n.length>0?(r.push(n),n=[a],s=a.length):(n.push(a),s+=e)}return n.length>0&&r.push(n),r}function tt(e){const t=["",Ye("GET/SET QUALIFIERS")],r=Math.max(20,e-4-13);for(const n of Ge){const e=`${We}${n.cat.padEnd(13)}${He}`,s=et(n.params,r),a=" ".repeat(17);t.push(`    ${e}${Ze(s[0].join(" ¬∑ "))}`);for(let r=1;r<s.length;r++)t.push(`${a}${Ze(s[r].join(" ¬∑ "))}`)}return t}class rt extends te{constructor(e){super(),t(this,"name","help"),t(this,"description","Show available commands"),t(this,"aliases",["?","h"]),this.registry=e}execute({output:e,rawInput:t,cols:r}){const n=this.argsAfterName(t).toLowerCase().trim();if(n&&"help"!==n){const t=this.registry.find(n+" help")||this.registry.find(n);return t?void t.execute({output:e,rawInput:t.name+" help",args:[t.name,"help"],cols:r,signal:(new AbortController).signal}):void e.write(`Unknown command: ${ye(n)}`,"warning")}const s=[Je(r),""];for(const a of Ke){s.push(Ye(a.label));for(const e of a.entries)s.push(...Qe(e,r));"RADIO"===a.label&&s.push(...tt(r)),s.push("")}s.push(...function(e){return[`  ${Ve(Math.min(e-4,56))}`,`  ${_e("<command> help for detailed usage")}`]}(r)),e.write(s.join("\n"))}}class nt extends te{constructor(){super(...arguments),t(this,"name","clear"),t(this,"description","Clear terminal screen"),t(this,"aliases",["cls"])}execute({output:e,rawInput:t}){"help"!==this.argsAfterName(t).toLowerCase().trim()?e.clear():e.write([be("clear"),`  ${we("Clear all terminal output.")}`,"",xe("clear","clear the screen"),"",be("Aliases"),`  ${we("cls")}`].join("\n"))}}function st(e){const t=Math.floor(e/86400),r=Math.floor(e%86400/3600),n=Math.floor(e%3600/60);return t>0?`${t}d ${r}h ${n}m`:r>0?`${r}h ${n}m`:`${n}m`}class at extends te{constructor(){super(...arguments),t(this,"name","status"),t(this,"description","Get repeater status summary"),t(this,"aliases",["st"])}async execute({output:e,rawInput:t}){var r,n,s;if("help"===this.argsAfterName(t).toLowerCase().trim())return void e.write([be("status"),`  ${we("Show a quick summary of mode, neighbor count, and uptime.")}`,"",xe("status","show summary"),"",be("Aliases"),`  ${we("st")}`].join("\n"));const a=e.write("processing...","system");try{const t=await u(),o=(null==(n=null==(r=t.config)?void 0:r.repeater)?void 0:n.mode)||"unknown",i=Object.keys(t.neighbors||{}).length,c=Object.values(t.neighbors||{}).filter(e=>e.zero_hop).length,l=(null==(s=t.config)?void 0:s.node_name)||t.node_name||"unknown",d=st(t.uptime_seconds||0);e.update(a,[`${ge(l)}  ${we("repeater")}`,"",`  ${ve("Mode",ye(o))}`,`  ${ve("Neighbors",`${ye(String(c))} direct  ${we(`${i} total`)}`)}`,`  ${ve("RX / TX",`${ye(String(t.rx_count??0))} / ${ye(String(t.tx_count??0))}`)}`,`  ${ve("Uptime",ye(d))}`].join("\n"))}catch(o){e.update(a,`Error: ${o instanceof Error?o.message:"Command failed"}`,"error")}}}class ot extends te{constructor(){super(...arguments),t(this,"name","uptime"),t(this,"description","Show system uptime")}async execute({output:e,rawInput:t}){if("help"===this.argsAfterName(t).toLowerCase().trim())return void e.write([be("uptime"),`  ${we("Display how long the repeater service has been running.")}`,"",xe("uptime","show uptime")].join("\n"));const r=e.write("processing...","system");try{const t=await u();e.update(r,ve("Uptime",ye(st(t.uptime_seconds||0))))}catch(n){e.update(r,`Error: ${n instanceof Error?n.message:"Command failed"}`,"error")}}}class it extends te{constructor(){super(...arguments),t(this,"name","packets"),t(this,"description","Show packet statistics")}async execute({output:e,rawInput:t}){if("help"===this.argsAfterName(t).toLowerCase().trim())return void e.write([be("packets"),`  ${we("Display packet counters (received, transmitted, forwarded, dropped).")}`,"",xe("packets","show packet stats")].join("\n"));const r=e.write("processing...","system");try{const t=await u(),n=(t.rx_count??0)+(t.tx_count??0);e.update(r,[be("Packet Stats")+`  ${we(`${n} total`)}`,"",`  ${ve("Received",ye(String(t.rx_count??0)))}`,`  ${ve("Transmitted",ye(String(t.tx_count??0)))}`,`  ${ve("Forwarded",ye(String(t.forwarded_count??0)))}`,`  ${ve("Dropped",ye(String(t.dropped_count??0)))}`].join("\n"))}catch(n){e.update(r,`Error: ${n instanceof Error?n.message:"Command failed"}`,"error")}}}function ct(e){return e>=1073741824?`${(e/1073741824).toFixed(1)} GB`:e>=1048576?`${(e/1048576).toFixed(0)} MB`:`${(e/1024).toFixed(0)} KB`}function lt(e){const t=Math.floor(e/86400),r=Math.floor(e%86400/3600),n=Math.floor(e%3600/60);return t>0?`${t}d ${r}h ${n}m`:r>0?`${r}h ${n}m`:`${n}m`}class ut extends te{constructor(){super(...arguments),t(this,"name","board"),t(this,"description","Show board/platform info")}async execute({output:e,rawInput:t}){var r;if("help"===this.argsAfterName(t).toLowerCase().trim())return void e.write([be("board"),`  ${we("Display platform and hardware information.")}`,"",xe("board","show board info")].join("\n"));const n=e.write("loading...","system");try{const[t,s]=await Promise.all([d(),u()]),a=[];if(a.push(`  ${ve("Node",ye(s.node_name||"Unknown"))}`),a.push(`  ${ve("Runtime",ye(`pyMC_Repeater v${s.version||"?"}`))}`),s.core_version&&a.push(`  ${ve("Core",ye(s.core_version))}`),a.push(""),t.success&&t.data){const e=t.data;a.push(`  ${ve("CPU",ye(`${e.cpu.usage_percent.toFixed(1)}%`))}  ${we(`${e.cpu.count} core${e.cpu.count>1?"s":""}`)}`),e.cpu.load_avg&&a.push(`  ${ve("Load",ye(`${e.cpu.load_avg["1min"].toFixed(2)} / ${e.cpu.load_avg["5min"].toFixed(2)} / ${e.cpu.load_avg["15min"].toFixed(2)}`))}`);const n=Object.entries(e.temperatures||{});if(n.length>0){const e=n[0];a.push(`  ${ve("Temp",ye(`${e[1].toFixed(1)}¬∞C`))}${n.length>1?`  ${we(n.slice(1).map(([e,t])=>`${e}: ${t.toFixed(1)}¬∞C`).join(", "))}`:""}`)}a.push(""),a.push(`  ${ve("Memory",ye(`${ct(e.memory.used)} / ${ct(e.memory.total)}`))}  ${we(`${e.memory.usage_percent.toFixed(0)}%`)}`),a.push(`  ${ve("Disk",ye(`${ct(e.disk.used)} / ${ct(e.disk.total)}`))}  ${we(`${e.disk.usage_percent.toFixed(0)}%`)}`),a.push(""),(null==(r=e.system)?void 0:r.uptime)&&a.push(`  ${ve("System uptime",ye(lt(e.system.uptime)))}`),a.push(`  ${ve("Service uptime",ye(lt(s.uptime_seconds)))}`),e.network&&a.push(`  ${ve("Net TX/RX",ye(`${ct(e.network.bytes_sent)} / ${ct(e.network.bytes_recv)}`))}`)}else a.push(`  ${ve("Platform",ye("Linux"))}`),a.push(`  ${ve("Service uptime",ye(lt(s.uptime_seconds)))}`),a.push(`  ${we("Hardware stats unavailable")}`);e.update(n,a.join("\n"),"value")}catch(s){e.update(n,`Error: ${s instanceof Error?s.message:"Failed to load hardware stats"}`,"error")}}}class dt extends te{constructor(){super(...arguments),t(this,"name","advert"),t(this,"description","Send repeater advertisement")}async execute({output:e,rawInput:t}){if("help"===this.argsAfterName(t).toLowerCase().trim())return void e.write([be("advert"),`  ${we("Broadcast a repeater advertisement to the mesh network.")}`,"",xe("advert","send advert now"),"",_e("Adverts announce this repeater's presence to neighbors.")].join("\n"));const r=e.write("processing...","system");try{const t=await p();t.success?e.update(r,`‚úì ${ye("Advert sent")}`,"success"):e.update(r,`Error: ${t.error||"Failed"}`,"error")}catch(n){e.update(r,`Error: ${n instanceof Error?n.message:"Command failed"}`,"error")}}}const pt=["sig","name","rssi","snr","dist","heard"],mt={excellent:5,good:4,fair:3,poor:2,critical:1};function ht(e){const t=Math.floor(Date.now()/1e3-e);return t<60?`${t}s ago`:t<3600?`${Math.floor(t/60)}m ago`:t<86400?`${Math.floor(t/3600)}h ago`:`${Math.floor(t/86400)}d ago`}function ft(e){return e<1e3?`${Math.round(e)}m`:`${(e/1e3).toFixed(1)}km`}const gt=["‚ñÅ","‚ñÉ","‚ñÖ","‚ñá","‚ñà"],$t={excellent:5,good:4,fair:3,poor:2,critical:1};function yt(e){const t=$t[e]??0;return gt.slice(0,t).map((e,t)=>Te(e,t)).join("")+we(".".repeat(5-t))}function wt(e,t=e=>e){return{text:e,color:t}}function vt(e){return we("+"+e.map(e=>"-".repeat(e+2)).join("+")+"+")}function xt(e,t){const r=e.map((e,r)=>{if(null!=e.rendered){const n=Math.max(0,t[r]-e.text.length);return" "+e.rendered+" ".repeat(n)+" "}return" "+e.color((n=e.text,s=t[r],n.length>=s?n.slice(0,s):n+" ".repeat(s-n.length)))+" ";var n,s});return we("|")+r.join(we("|"))+we("|")}class bt extends te{constructor(){super(...arguments),t(this,"name","neighbors"),t(this,"description","Show direct RF neighbors with signal stats"),t(this,"aliases",["nb","get neighbors","get neighbor"]),t(this,"params","[sig|name|rssi|snr|dist|heard]")}async execute(e){const{output:t,cols:r}=e,n=this.argsAfterName(e.rawInput).toLowerCase().trim();if("help"===n)return void this.printUsage(t);const s=pt.includes(n)?n:null,a=t.write("processing...","system");try{const e=await u(),n=e.neighbors||{},o=Object.entries(n).filter(([,e])=>e.zero_hop);if(0===o.length){const e=Object.keys(n).length;return void t.update(a,e>0?`No direct neighbors. ${e} relayed neighbor${1!==e?"s":""} known.`:"No neighbors discovered yet.","warning")}const i=function(e){var t;const r=null==(t=e.config)?void 0:t.radio;return(null==r?void 0:r.spreading_factor)&&(null==r?void 0:r.bandwidth)?{sf:r.spreading_factor,bwHz:r.bandwidth}:null}(e),c=function(e){var t;const r=null==(t=e.config)?void 0:t.repeater;return r&&L(r.latitude,r.longitude)?{lat:r.latitude,lon:r.longitude}:null}(e),l=e.noise_floor_dbm;this.sortNeighbors(o,s,i,c,l);const d=s?`  ${$e(`sorted by ${s}`)}`:"",p=[be(`Direct Neighbors (${o.length})`)+d,""];if(r<55)for(const[t,r]of o)p.push(...this.cardLayout(t,r,i,c,l));else{const e=r>=70&&null!=c,t=o.map(([t,r])=>this.buildRow(t,r,i,c,l,e)),n=e?["SIG","NAME","RSSI","SNR","DIST","HEARD"]:["SIG","NAME","RSSI","SNR","HEARD"],s=n.slice(1).map((e,r)=>Math.max(e.length,...t.map(e=>e[r+1].text.length))),a=5,u=s.reduce((e,t)=>e+t+3,0),d=Math.max(4,r-u-a-7),m=[a,Math.min(d,Math.max(4,...t.map(e=>e[1].text.length))),...s.slice(1)];p.push(vt(m),...t.map(e=>xt(e,m)),vt(m),xt(n.map(e=>wt(e,ge)),m),vt(m)),p.push(this.footer(i,l))}t.update(a,p.join("\n"))}catch(o){t.update(a,`Error: ${o instanceof Error?o.message:"Command failed"}`,"error")}}sortNeighbors(e,t,r,n,s){switch(t){case"sig":e.sort(([,e],[,t])=>(mt[this.gradeNeighbor(e,r,s)]??0)-(mt[this.gradeNeighbor(t,r,s)]??0));break;case"name":e.sort(([e,t],[r,n])=>{const s=(t.name||t.node_name||e.slice(0,8)).toLowerCase(),a=(n.name||n.node_name||r.slice(0,8)).toLowerCase();return s.localeCompare(a)});break;case"rssi":e.sort(([,e],[,t])=>(e.rssi??-999)-(t.rssi??-999));break;case"snr":e.sort(([,e],[,t])=>(e.snr??-999)-(t.snr??-999));break;case"dist":e.sort(([,e],[,t])=>(this.distTo(e,n)??1/0)-(this.distTo(t,n)??1/0));break;case"heard":e.sort(([,e],[,t])=>(e.last_seen||0)-(t.last_seen||0));break;default:e.sort(([,e],[,t])=>(t.last_seen||0)-(e.last_seen||0))}}gradeNeighbor(e,t,r){const n=null!=e.rssi?e.rssi-3.5:null,s=null!=r&&r>-100?1:0,a=M(e.snr??null,n,t,s);return(null==a?void 0:a.finalGrade)??"critical"}distTo(e,t){return t&&L(e.latitude,e.longitude)?D(t.lat,t.lon,e.latitude,e.longitude):null}buildRow(e,t,r,n,s,a){const o=this.gradeNeighbor(t,r,s),i=Ee(t.name||t.node_name||e.slice(0,8))||e.slice(0,8),c=null!=t.rssi?`${t.rssi} dBm`:"-",l=null!=t.snr?`${t.snr} dB`:"-",u=t.last_seen?ht(t.last_seen):"-",d=[(p=yt(o),{text:"|||||",color:e=>e,rendered:p}),wt(i,ge),wt(c,ye),wt(l,ye)];var p;if(a){const e=this.distTo(t,n);d.push(wt(null!=e?ft(e):"-",$e))}return d.push(wt(u,$e)),d}cardLayout(e,t,r,n,s){const a=this.gradeNeighbor(t,r,s),o=Ee(t.name||t.node_name||e.slice(0,8))||e.slice(0,8),i=null!=t.rssi?`${t.rssi}`:"-",c=null!=t.snr?`${t.snr}`:"-",l=t.last_seen?ht(t.last_seen):"-",u=this.distTo(t,n),d=null!=u?`  ${we("dist")} ${ye(ft(u))}`:"";return[`${yt(a)} ${ge(o)}`,`  ${we("rssi")} ${ye(i)}  ${we("snr")} ${ye(c)}${d}  ${$e(l)}`,""]}footer(e,t){const r=[];return e&&r.push(`SF${e.sf}/${e.bwHz>=1e3?e.bwHz/1e3+"kHz":e.bwHz+"Hz"}`),r.push("ant 3.5dBi"),null!=t&&r.push(`nf ${t}dBm`),we(r.join("  "))}printUsage(e){const t=[be("neighbors"),`  ${we("Show direct RF neighbors with signal quality, RSSI, SNR, and distance.")}`,"",be("Usage"),xe("neighbors","default sort (most recent)"),xe("neighbors sig","sort by signal grade (weakest first)"),xe("neighbors name","sort alphabetically"),xe("neighbors rssi","sort by RSSI (weakest first)"),xe("neighbors snr","sort by SNR (lowest first)"),xe("neighbors dist","sort by distance (closest first)"),xe("neighbors heard","sort by last seen (oldest first)"),xe("neighbors help","show this help"),"",be("Aliases"),`  ${we("nb, get neighbors, get neighbor")}`,"",_e("Signal bars factor radio config, noise floor, and 3.5 dBi antenna gain."),_e("Only zero-hop (direct RF) neighbors are shown.")];e.write(t.join("\n"))}}class _t extends te{constructor(){super(...arguments),t(this,"name","get"),t(this,"description","Get repeater parameter"),t(this,"params","{parameter}")}async execute({output:e,rawInput:t}){const r=this.argsAfterName(t).toLowerCase().trim();if("help"===r||!r)return void e.write([be("get"),`  ${we("Read a repeater configuration parameter.")}`,"",be("Identity"),xe("get name","node name"),xe("get role","node role"),xe("get public.key","public key"),"",be("Location"),xe("get lat","latitude"),xe("get lon","longitude"),"",be("Radio"),xe("get radio","full radio summary"),xe("get freq","frequency (MHz)"),xe("get tx","TX power (dBm)"),xe("get bw","bandwidth (kHz)"),xe("get sf","spreading factor"),xe("get cr","coding rate"),"",be("Timing"),xe("get txdelay","TX delay factor"),xe("get direct.txdelay","direct TX delay"),xe("get rxdelay","RX delay base"),"",be("Repeater"),xe("get mode","forward or monitor"),xe("get flood.max","max flood hops"),xe("get advert.interval","advert interval"),xe("get duty","duty cycle state"),"",be("Advanced"),xe("get multi.acks","multi-ack count"),xe("get int.thresh","interference threshold (dBm)"),xe("get agc.reset.interval","AGC reset interval")].join("\n"));const n=e.write("processing...","system");try{const t=await u(),{result:s,type:a}=function(e,t){const r=t.config||{},n=r.radio||{},s=r.repeater||{},a=r.delays||{},o=r.duty_cycle||{},i=(e,t)=>({result:ve(e,ye(t)),type:"value"});switch(e){case"name":return i("name",r.node_name||"Unknown");case"role":return i("role","repeater");case"lat":return i("lat",null!=s.latitude?String(s.latitude):"not set");case"lon":return i("lon",null!=s.longitude?String(s.longitude):"not set");case"freq":return i("freq",n.frequency?`${(n.frequency/1e6).toFixed(3)} MHz`:"?");case"tx":return i("tx",null!=n.tx_power?`${n.tx_power} dBm`:"?");case"bw":return i("bw",n.bandwidth?n.bandwidth/1e3+" kHz":"?");case"sf":return i("sf",String(n.spreading_factor??"?"));case"cr":return i("cr",n.coding_rate?`4/${n.coding_rate}`:"?");case"radio":return n.frequency?{result:[`  ${ve("freq",ye(`${(n.frequency/1e6).toFixed(3)} MHz`))}`,`  ${ve("bw",ye(n.bandwidth/1e3+" kHz"))}`,`  ${ve("sf",ye(String(n.spreading_factor)))}`,`  ${ve("cr",ye(`4/${n.coding_rate}`))}`,`  ${ve("tx",ye(`${n.tx_power} dBm`))}`].join("\n"),type:"value"}:i("radio","?");case"af":case"txdelay":return i("txdelay",String(a.tx_delay_factor??"1.0"));case"direct.txdelay":return i("direct.txdelay",String(a.direct_tx_delay_factor??"0.5"));case"rxdelay":return i("rxdelay",String(a.rx_delay_base??"0.0"));case"mode":return i("mode",s.mode||"forward");case"repeat":return i("repeat","forward"===s.mode?"on":"off");case"flood.max":return i("flood.max",String(s.max_flood_hops??"3"));case"flood.advert.interval":return i("flood.advert.interval",null!=s.send_advert_interval_hours?`${s.send_advert_interval_hours}h`:"?");case"advert.interval":return i("advert.interval",null!=s.advert_interval_minutes?`${s.advert_interval_minutes}m`:"120m");case"duty":case"duty.enabled":return i("duty",o.enforcement_enabled?"on":"off");case"duty.max":return i("duty.max",null!=o.max_airtime_percent?`${o.max_airtime_percent}%`:"?");case"multi.acks":return i("multi.acks",String(s.multi_acks??"0"));case"int.thresh":return i("int.thresh",`${s.interference_threshold??-120} dBm`);case"agc.reset.interval":return i("agc.reset.interval",String(s.agc_reset_interval??"0"));case"public.key":return i("public.key",t.public_key||"not available");case"prv.key":return{result:`${we("Private key stored in /etc/pymc_repeater/config.yaml")}\n\n  ${ve("view",ye("sudo grep identity_key /etc/pymc_repeater/config.yaml"))}\n  ${ve("set",ye("sudo ./convert_firmware_key.sh <64-byte-hex>"))}`,type:"info"};case"guest.password":case"allow.read.only":return{result:`${we("Security settings not exposed via stats API.")}\n${we("Check /etc/pymc_repeater/config.yaml")}`,type:"warning"};default:return{result:`Unknown parameter: ${ye(e)}\n${we('Run "get help" to see available parameters.')}`,type:"error"}}}(r,t);e.update(n,s,a)}catch(s){e.update(n,`Error: ${s instanceof Error?s.message:"Command failed"}`,"error")}}}class kt extends te{constructor(){super(...arguments),t(this,"name","set"),t(this,"description","Set repeater parameter"),t(this,"params","{parameter} {value}")}async execute({output:e,rawInput:t}){var r;const n=this.argsAfterName(t).split(/\s+/),s=null==(r=n[0])?void 0:r.toLowerCase(),a=n.slice(1).join(" ");if("help"===s||!s)return void e.write([be("set"),`  ${we("Write a repeater configuration parameter.")}`,"",be("Identity"),xe("set name <name>","node name"),xe("set lat <deg>","latitude (-90 to 90)"),xe("set lon <deg>","longitude (-180 to 180)"),"",be("Radio"),xe("set freq <MHz>","frequency"),xe("set tx <dBm>","TX power (2-22)"),xe("set bw <kHz>","bandwidth"),xe("set sf <5-12>","spreading factor"),xe("set cr <5-8>","coding rate"),"",be("Timing"),xe("set txdelay <0-5>","TX delay factor"),xe("set direct.txdelay <0-5>","direct TX delay"),xe("set rxdelay <n>","RX delay base"),"",be("Repeater"),xe("set mode <fwd|mon>","forward or monitor"),xe("set flood.max <0-64>","max flood hops"),xe("set advert.interval <m>","advert interval (min)"),xe("set duty <on|off>","duty cycle enforcement"),xe("set log <level>","log level"),"",be("Advanced"),xe("set multi.acks <n>","multi-ack count"),xe("set int.thresh <dBm>","interference threshold"),xe("set agc.reset.interval <n>","AGC reset interval (x4)"),"",_e("Some changes require a service restart.")].join("\n"));const o=e.write("processing...","system");try{const{result:r,type:n}=await async function(e,t,r){switch(e){case"mode":return async function(e){const t=e.toLowerCase();return"forward"!==t&&"monitor"!==t?Rt('Mode must be "forward" or "monitor"'):(await g(t)).success?Et(`OK - Mode set to ${t}`):Rt("Failed")}(t);case"duty":return async function(e){const t="on"===e.toLowerCase()||"1"===e;return(await f(t)).success?Et("OK - Duty cycle "+(t?"enabled":"disabled")):Rt("Failed")}(t);case"tx":return St("tx_power",jt(t,2,22,"TX power must be 2-22 dBm"));case"sf":return St("spreading_factor",jt(t,5,12,"SF must be 5-12"));case"af":case"txdelay":return St("tx_delay_factor",Nt(t,0,5,"TX delay must be 0.0-5.0"));case"direct.txdelay":return St("direct_tx_delay_factor",Nt(t,0,5,"Direct TX delay must be 0.0-5.0"));case"rxdelay":return St("rx_delay_base",function(e){const t=parseFloat(e);return isNaN(t)||t<0?{ok:!1,error:"Error: RX delay must be >= 0"}:{ok:!0,value:t}}(t));case"flood.max":return St("max_flood_hops",jt(t,0,64,"Max flood hops must be 0-64"));case"log":return async function(e){const t=e.toUpperCase();if(!["DEBUG","INFO","WARNING","ERROR"].includes(t))return Rt("Level must be debug, info, warning, or error");const r=await h(t);return r.success?Et(`OK - Log level set to ${t}`):Rt(r.error||"Failed")}(t);case"multi.acks":return St("multi_acks",jt(t,0,255,"Multi-acks must be 0-255"));case"int.thresh":return St("interference_threshold",jt(t,-200,0,"Interference threshold must be -200 to 0 dBm"));case"agc.reset.interval":{const e=Tt(t);if(!e.ok)return Rt(e.error);if(e.value<0)return Rt("AGC reset interval must be >= 0");const r=4*Math.floor(e.value/4);return Ct("agc_reset_interval",r,`OK - AGC reset interval set to ${r}${r!==e.value?` (rounded from ${e.value})`:""}`)}case"name":{const e=r.trim().substring(r.toLowerCase().indexOf("name")+5).trim();return e?St("node_name",{ok:!0,value:e}):Rt("Node name cannot be empty")}case"lat":return St("latitude",Nt(t,-90,90,"Latitude must be -90 to 90"));case"lon":return St("longitude",Nt(t,-180,180,"Longitude must be -180 to 180"));case"freq":{const e=Nt(t,100,1e3,"Frequency must be 100-1000 MHz");return e.ok?St("frequency",{ok:!0,value:1e6*e.value}):Rt(e.error)}case"bw":{const e=[7.8,10.4,15.6,20.8,31.25,41.7,62.5,125,250,500],r=parseFloat(t);return isNaN(r)||!e.includes(r)?Rt(`BW must be one of: ${e.join(", ")} kHz`):St("bandwidth",{ok:!0,value:1e3*r})}case"cr":return St("coding_rate",jt(t,5,8,"Coding rate must be 5-8"));case"advert.interval":{const e=Tt(t);return e.ok?0!==e.value&&(e.value<1||e.value>10080)?Rt("Advert interval must be 0 (off) or 1-10080 minutes"):Ct("advert_interval_minutes",e.value,0===e.value?"OK - Local adverts disabled":`OK - Local advert interval set to ${e.value}m`):Rt(e.error)}case"flood.advert.interval":{const e=Tt(t);return e.ok?0!==e.value&&(e.value<3||e.value>48)?Rt("Flood advert interval must be 0 (off) or 3-48 hours"):Ct("flood_advert_interval_hours",e.value,0===e.value?"OK - Flood adverts disabled":`OK - Flood advert interval set to ${e.value}h`):Rt(e.error)}case"prv.key":{const e=t.trim();return e?/^[0-9a-fA-F]+$/.test(e)?128!==e.length?Rt(`Key must be 64 bytes (128 hex chars), got ${e.length} chars`):{result:`To set this key, run on the Pi:\n\n  sudo ./convert_firmware_key.sh ${e}\n\nThen restart: sudo systemctl restart pymc-repeater`,type:"info"}:Rt("Private key must be a hex string"):Rt("Private key cannot be empty")}default:return Rt(`Unknown parameter: ${e}`)}}(s,a,t);e.update(o,r,n)}catch(i){e.update(o,`Error: ${i instanceof Error?i.message:"Command failed"}`,"error")}}}async function St(e,t){if(!t.ok)return Rt(t.error);const r=await m({[e]:t.value});if(!r.success)return Rt(r.error||"Failed");let n=`OK - ${e} set to ${t.value}`;return r.restart_required&&(n+="\n‚ö† Service restart required for changes to take effect\nRun: sudo systemctl restart pymc_repeater"),Et(n)}async function Ct(e,t,r){const n=await m({[e]:t});if(!n.success)return Rt(n.error||"Failed");let s=r;return n.restart_required&&(s+="\n‚ö† Service restart required for changes to take effect\nRun: sudo systemctl restart pymc_repeater"),Et(s)}function jt(e,t,r,n){const s=parseInt(e);return isNaN(s)||s<t||s>r?{ok:!1,error:`Error: ${n}`}:{ok:!0,value:s}}function Nt(e,t,r,n){const s=parseFloat(e);return isNaN(s)||s<t||s>r?{ok:!1,error:`Error: ${n}`}:{ok:!0,value:s}}function Tt(e){const t=parseInt(e);return isNaN(t)?{ok:!1,error:"Error: Expected a number"}:{ok:!0,value:t}}function Et(e){return{result:e,type:"success"}}function Rt(e){return{result:`Error: ${e}`,type:"error"}}const At=["‚ñÅ","‚ñÉ","‚ñÖ","‚ñá","‚ñà"],It={excellent:5,good:4,fair:3,poor:2,critical:1};class Ft extends te{constructor(){super(...arguments),t(this,"name","ping"),t(this,"description","Ping neighbor (name or 0xXX)"),t(this,"params","{target} [timeout]")}async execute({output:e,rawInput:t}){var r,n,s,a;const o=this.argsAfterName(t).trim(),i=o.split(/\s+/);if("help"===(null==(r=i[0])?void 0:r.toLowerCase()))return void e.write([be("ping"),`  ${we("Send a ping to a neighbor and measure round-trip time, signal quality, and path.")}`,"",xe("ping <name>","ping by node name"),xe("ping 0xAB","ping by hex prefix"),xe("ping <name> 60","ping with custom timeout (seconds)"),"",_e("Default timeout: 30s. Signal bars factor radio config and noise floor.")].join("\n"));const c=i[i.length-1],l=parseInt(c),d=i.length>1&&!isNaN(l)&&l>0,p=d?i.slice(0,-1).join(" "):o,m=d?l:30;if(!p)return void e.write([be("ping"),`  ${we("Send a ping to a neighbor and measure round-trip time.")}`,"",xe("ping <name>","ping by node name"),xe("ping <name> 60","with custom timeout"),"",_e('Run "ping help" for full usage.')].join("\n"));const h=e.write(`Pinging ${p}.`,"system");let f=1;const g=setInterval(()=>{f=f%3+1,e.update(h,`Pinging ${p}${".".repeat(f)}`,"system")},800);try{const[t,r]=await Promise.all([B(p,m),u()]);if(clearInterval(g),t.success&&t.data){const o=t.data,i=null==(n=r.config)?void 0:n.radio,c=(null==i?void 0:i.spreading_factor)&&(null==i?void 0:i.bandwidth)?{sf:i.spreading_factor,bwHz:i.bandwidth}:null,l=r.noise_floor_dbm,u=null!=l&&l>-100?1:0,d=o.rssi-3.5,p=M(o.snr_db,d,c,u),m=(null==p?void 0:p.finalGrade)??"critical",f=function(e){const t=It[e]??0;return At.slice(0,t).map((e,t)=>Te(e,t)).join("")+we(".".repeat(5-t))}(m),g=(null==(s=o.path)?void 0:s.length)?o.path.length:0,$=(null==(a=o.path)?void 0:a.length)?o.path.join(" > "):"direct",y=m.charAt(0).toUpperCase()+m.slice(1),w=[`${f} ${ge("Reply from")} ${ye(o.target_id)}`,"",`  ${ve("RTT",Ce(o.rtt_ms))}`,`  ${ve("RSSI",`${o.rssi} dBm`)}`,`  ${ve("SNR",`${o.snr_db} dB`)}`,`  ${ve("Path",$)}${g>0?we(` (${g} hop${1!==g?"s":""})`):""}`,`  ${ve("Quality",je(y,m))}`],v=[];c&&v.push(`SF${c.sf}/${c.bwHz>=1e3?c.bwHz/1e3+"kHz":c.bwHz+"Hz"}`),v.push("ant 3.5dBi"),null!=l&&v.push(`nf ${l}dBm`),w.push("",we(v.join("  "))),e.update(h,w.join("\n"))}else e.update(h,t.error||"Ping failed","error")}catch($){clearInterval(g),e.update(h,`Error: ${$ instanceof Error?$.message:"Ping failed"}`,"error")}}}class Mt extends te{constructor(){super(...arguments),t(this,"name","convert"),t(this,"description","Convert between hex and base64"),t(this,"params","hex|base64 {value}")}execute({output:e,args:t}){var r;const n=null==(r=t[1])?void 0:r.toLowerCase(),s=t.slice(2).join(" ").trim();"help"!==n&&(n||s)?"hex"===n?this.hexToBase64(e,s):"base64"===n?this.base64ToHex(e,s):e.write([be("convert"),`  ${we("Convert between hex and base64 encodings.")}`,"",xe("convert hex <hex>","hex ‚Üí base64"),xe("convert base64 <b64>","base64 ‚Üí hex")].join("\n")):e.write([be("convert"),`  ${we("Convert between hex and base64 encodings.")}`,"",xe("convert hex <hex>","hex ‚Üí base64"),xe("convert base64 <b64>","base64 ‚Üí hex"),"",_e("Example: convert hex 48656C6C6F")].join("\n"))}hexToBase64(e,t){if(t)if(/^[0-9a-fA-F]+$/.test(t))if(t.length%2==0)try{const r=new Uint8Array(t.length/2);for(let e=0;e<t.length;e+=2)r[e/2]=parseInt(t.substring(e,e+2),16);let n="";const s=8192;for(let e=0;e<r.length;e+=s)n+=String.fromCharCode.apply(null,Array.from(r.subarray(e,Math.min(e+s,r.length))));const a="function"==typeof globalThis.btoa?globalThis.btoa(n):Buffer.from(n,"binary").toString("base64");e.write(`  ${ve("hex",ye(t))}\n  ${ve("base64",ye(a))}`)}catch(r){e.write(`Error: Failed to convert - ${r instanceof Error?r.message:"unknown error"}`,"error")}else e.write("Error: Hex string must have even length","error");else e.write("Error: Input must be a hex string","error");else e.write("Usage: convert hex <hex-string>","error")}base64ToHex(e,t){if(t)try{const r="function"==typeof globalThis.atob?globalThis.atob(t):Buffer.from(t,"base64").toString("binary");let n="";for(let e=0;e<r.length;e++)n+=r.charCodeAt(e).toString(16).padStart(2,"0");e.write(`  ${ve("base64",ye(t))}\n  ${ve("hex",ye(n.toUpperCase()))}`)}catch(r){e.write(`Error: Invalid base64 string - ${r instanceof Error?r.message:"unknown error"}`,"error")}else e.write("Usage: convert base64 <base64-string>","error")}}function Lt(){const e=new Date;return`${e.toISOString().slice(0,10)}_${e.toTimeString().slice(0,8).replace(/:/g,"-")}`}function Dt(e,t){return`pymc-${e.toISOString().slice(0,10)}-${e.toTimeString().slice(0,5).replace(":","")}-${t}s.json`}const Ot=P((e,t)=>({isCapturing:!1,captureStartTime:null,captureStartPacketHashes:new Set,captureTimer:null,reports:[],startCapture:r=>{const{captureTimer:n}=t();n&&clearTimeout(n),e({isCapturing:!0,captureStartTime:new Date,captureStartPacketHashes:new Set(r.map(e=>e.packet_hash))})},stopCapture:r=>{const{isCapturing:n,captureStartTime:s,captureStartPacketHashes:a,captureTimer:o}=t();if(!n||!s)return null;o&&clearTimeout(o);const i=new Date,c=Math.round((i.getTime()-s.getTime())/1e3),l=s.getTime()/1e3,u=r.filter(e=>!a.has(e.packet_hash)&&e.timestamp>=l).sort((e,t)=>e.timestamp-t.timestamp),d={id:Lt(),filename:Dt(s,c),startTime:s,endTime:i,durationSec:c,packetCount:u.length,packets:u,sizeBytes:500*u.length};return e(e=>({isCapturing:!1,captureStartTime:null,captureStartPacketHashes:new Set,captureTimer:null,reports:[d,...e.reports].slice(0,10)})),d},getReport:e=>t().reports.find(t=>t.id===e),_setTimer:t=>e({captureTimer:t})})),Bt=()=>Ot(e=>e.reports);function Pt(e){var t;return(null==(t=e.match(/.{1,2}/g))?void 0:t.join(" ").toUpperCase())||""}function Ht(e){return void 0===e?"UNKNOWN":x[e]??`TYPE_${e}`}function Ut(e){return void 0===e?"UNKNOWN":v[e]??`ROUTE_${e}`}function zt(e,t){switch(e){case 4:return function(e){const t=[];let r=0;if(e.length>=32&&(t.push({name:"public_key",offset:r,length:32,bytes:Pt(w(e.slice(r,r+32))),decoded:{value:w(e.slice(r,r+32))}}),r+=32),e.length>=r+4){const n=e.slice(r,r+4),s=n[0]|n[1]<<8|n[2]<<16|n[3]<<24;t.push({name:"timestamp",offset:r,length:4,bytes:Pt(w(n)),decoded:{value:s>>>0,iso:new Date(1e3*s).toISOString()}}),r+=4}if(e.length>=r+64&&(t.push({name:"signature",offset:r,length:64,bytes:Pt(w(e.slice(r,r+64))),decoded:{value:w(e.slice(r,r+64))}}),r+=64),e.length>r){const n=e[r],s=[];if(1&n&&s.push("CHAT_NODE"),2&n&&s.push("REPEATER"),3&n&&s.push("ROOM_SERVER"),16&n&&s.push("HAS_LOCATION"),128&n&&s.push("HAS_NAME"),t.push({name:"flags",offset:r,length:1,bytes:Pt(w(e.slice(r,r+1))),decoded:{value:n,binary:n.toString(2).padStart(8,"0"),flags:s}}),r+=1,16&n&&e.length>=r+8){const n=e.slice(r,r+8),s=new ArrayBuffer(8);new Uint8Array(s).set(n);const a=new DataView(s),o=a.getInt32(0,!0),i=a.getInt32(4,!0);t.push({name:"location",offset:r,length:8,bytes:Pt(w(n)),decoded:{lat_raw:o,lon_raw:i,latitude:o/1e6,longitude:i/1e6}}),r+=8}if(128&n&&e.length>r){const n=e.slice(r);let s=n.indexOf(0);-1===s&&(s=n.length);const a=(new TextDecoder).decode(n.slice(0,s));t.push({name:"name",offset:r,length:s+(0===n[s]?1:0),bytes:Pt(w(n.slice(0,s+1))),decoded:{value:a,encoding:"utf-8",null_terminated:0===n[s]}})}}return t}(t);case 3:return function(e){if(e.length<4)return[];const t=e.slice(0,4),r=t[0]|t[1]<<8|t[2]<<16|t[3]<<24;return[{name:"crc",offset:0,length:4,bytes:Pt(w(t)),decoded:{value:r>>>0,hex:(r>>>0).toString(16).toUpperCase().padStart(8,"0"),note:"CRC of the acknowledged packet (little-endian)"}}]}(t);case 9:return function(e){const t=[];if(e.length<9)return t;const r=e.slice(0,4),n=r[0]|r[1]<<8|r[2]<<16|r[3]<<24;t.push({name:"trace_tag",offset:0,length:4,bytes:Pt(w(r)),decoded:{value:n>>>0,hex:(n>>>0).toString(16).toUpperCase().padStart(8,"0")}});const s=e.slice(4,8),a=s[0]|s[1]<<8|s[2]<<16|s[3]<<24;if(t.push({name:"auth_code",offset:4,length:4,bytes:Pt(w(s)),decoded:{value:a>>>0}}),t.push({name:"flags",offset:8,length:1,bytes:Pt(w(e.slice(8,9))),decoded:{value:e[8],binary:e[8].toString(2).padStart(8,"0")}}),e.length>9){const r=e.slice(9),n=Array.from(r).map(e=>e.toString(16).toUpperCase().padStart(2,"0"));t.push({name:"target_path",offset:9,length:r.length,bytes:Pt(w(r)),decoded:{hops:n,path_string:n.join("->")}})}return t}(t);case 8:return function(e){if(0===e.length)return[];const t=Array.from(e).map(e=>e.toString(16).toUpperCase().padStart(2,"0"));return[{name:"path_hops",offset:0,length:e.length,bytes:Pt(w(e)),decoded:{hops:t,path_string:t.join("->")}}]}(t);case 5:return function(e){const t=[];if(e.length<1)return t;if(t.push({name:"channel_hash",offset:0,length:1,bytes:Pt(w(e.slice(0,1))),decoded:{value:e[0].toString(16).toUpperCase().padStart(2,"0")}}),e.length>13){const r=12,n=e.length-1-r;t.push({name:"ciphertext",offset:1,length:n,bytes:Pt(w(e.slice(1,1+n))),decoded:{length:n,note:"Encrypted message content"}}),t.push({name:"mac",offset:1+n,length:r,bytes:Pt(w(e.slice(-r))),decoded:{note:"Message authentication code"}})}return t}(t);default:return function(e){return 0===e.length?[]:[{name:"raw_data",offset:0,length:e.length,bytes:Pt(w(e)),decoded:{length:e.length}}]}(t)}}function qt(e){const t=e.type??e.payload_type??0,r=e.route??e.route_type??0,n=e.raw_packet||"";let s,a=null;if(n){const t=H.fromHex(n);if(t.success&&t.packet){const e=t.packet;try{a=U(e)}catch{a=null}const r=y(n);let o=0;const i={offset:0,length:1,bytes:Pt(n.slice(0,2)),decoded:{route_type:e.routeType,route_name:e.routeTypeName,payload_type:e.payloadType,payload_name:e.payloadTypeName,version:e.payloadVersion}};o+=1,e.hasTransportCodes()&&(o+=4);const c={offset:o,length:1,bytes:Pt(w(r.slice(o,o+1))),decoded:{value:e.pathLen}};o+=1;const l=o,u=r.slice(o,o+e.pathLen),d=Array.from(e.path).map(e=>e.toString(16).toUpperCase().padStart(2,"0")),p=9===e.payloadType,m={offset:l,length:e.pathLen,bytes:Pt(w(u)),decoded:{hops:d,path_string:d.length>0?d.join("->"):"(direct)",...p&&{note:"For TRACE packets, path bytes are SNR√ó4 values, not node hashes",snr_values:Array.from(e.path).map(e=>{let t=e;return t>127&&(t-=256),t/4})}}};o+=e.pathLen,s={header:i,path_length:c,path:m,payload:{offset:o,length:e.payload.length,bytes:Pt(e.payloadHex),sections:zt(e.payloadType,e.payload)}}}else s=Wt(e)}else s=Wt(e);return{timestamp:e.timestamp,packet_hash:e.packet_hash,type:t,type_name:Ht(t),route:r,route_name:Ut(r),rssi:e.rssi,snr:e.snr,length:e.length??0,src_hash:e.src_hash,dst_hash:e.dst_hash,transmitted:e.transmitted,drop_reason:e.drop_reason,is_duplicate:e.is_duplicate,lbt_attempts:e.lbt_attempts,lbt_backoff_delays_ms:e.lbt_backoff_delays_ms,lbt_channel_busy:e.lbt_channel_busy,raw_packet:n,structure:s,decoded:a}}function Wt(e){var t;const r=e.type??e.payload_type??0,n=e.route??e.route_type??0,s=e.original_path??e.forwarded_path??[];return{header:{offset:0,length:1,bytes:"??",decoded:{route_type:n,route_name:Ut(n),payload_type:r,payload_name:Ht(r),version:0}},path_length:{offset:1,length:1,bytes:s.length.toString(16).toUpperCase().padStart(2,"0"),decoded:{value:s.length}},path:{offset:2,length:s.length,bytes:s.join(" "),decoded:{hops:s,path_string:s.length>0?s.join("->"):"(direct)"}},payload:{offset:2+s.length,length:(null==(t=e.payload)?void 0:t.length)??0,bytes:e.payload??"",sections:e.payload?zt(r,y(e.payload)):[]}}}function Xt(e,t){const r=function(e,t){var r;return{capture:{start:e.startTime.toISOString(),end:e.endTime.toISOString(),duration_sec:e.durationSec,packet_count:e.packetCount,node_name:(null==t?void 0:t.node_name)??"unknown",local_hash:(null==t?void 0:t.local_hash)??"unknown",pymc_console_version:$,pymc_repeater_version:(null==t?void 0:t.version)??"unknown",radio_config:(null==(r=null==t?void 0:t.config)?void 0:r.radio)?{frequency:t.config.radio.frequency,tx_power:t.config.radio.tx_power,bandwidth:t.config.radio.bandwidth,spreading_factor:t.config.radio.spreading_factor}:null},packets:e.packets.map(qt)}}(e,t),n=JSON.stringify(r,null,2),s=new Blob([n],{type:"application/json"}),a=URL.createObjectURL(s),o=document.createElement("a");o.href=a,o.download=e.filename,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(a)}function Kt(e){return e<1024?`${e} B`:e<1048576?`${(e/1024).toFixed(1)} KB`:`${(e/1048576).toFixed(1)} MB`}class Gt extends te{constructor(){super(...arguments),t(this,"name","cap"),t(this,"description","Packet capture (start/end/list/export)")}matches(e){const t=e.toLowerCase().trim();return"cap"===t||"cap help"===t||t.startsWith("start cap")||t.startsWith("end cap")||t.startsWith("list cap")||t.startsWith("export cap")}async execute({output:e,rawInput:t}){const r=t.toLowerCase().trim();return"cap"===r||"cap help"===r?this.showHelp(e):r.startsWith("start cap")?this.startCapture(e,r):"end cap"===r?this.endCapture(e):"list cap"===r?this.listCaptures(e):r.startsWith("export cap")?this.exportCapture(e,r):void this.showHelp(e)}showHelp(e){const t=Ot.getState(),r=t.isCapturing?`\n${Se('Recording in progress... use "end cap" to stop')}`:"",n=t.reports.length,s=n>0?` (${n} saved)`:"",a=[be("Packet Capture"),"",xe("start cap","Start capture (default: 120s)"),xe("end cap","Stop capture early"),xe("list cap",`List saved captures${s}`),xe("export cap","Download capture by ID"),"",_e("Captures stored in session memory. JSON includes decoded payloads."),r].filter(Boolean);e.write(a.join("\n"))}startCapture(e,t){const r=t.slice(9).trim(),n=r?parseInt(r):120;if(isNaN(n)||n<1||n>3600)return void e.write("Error: Duration must be 1-3600 seconds","error");const s=Ot.getState();if(s.isCapturing)return void e.write('Error: Capture already in progress. Use "end cap" first.',"error");const a=b.getState().packets;s.startCapture(a);let o=n;const i=e.write(Se(`Capturing... ${o}s remaining`),"system"),c=setInterval(()=>{o--;const t=Ot.getState();if(o>=0&&t.isCapturing){const r=b.getState().packets.filter(e=>{if(!t.captureStartTime)return!1;const r=t.captureStartTime.getTime()/1e3;return e.timestamp>=r&&!t.captureStartPacketHashes.has(e.packet_hash)}).length,n=o>0?`${o}s remaining`:"finishing...";e.update(i,Se(`Capturing... ${n} (${r} captured)`),"system")}},1e3),l=setTimeout(()=>{clearInterval(c);const t=Ot.getState();if(t.isCapturing){const r=b.getState().packets,n=t.stopCapture(r);n?e.write(`‚úì Capture complete!\n  Captured: ${n.packetCount} packets\n  Duration: ${n.durationSec}s\n  Size: ~${Kt(n.sizeBytes)}\n\nRun \`export cap ${n.id}\` to download.`,"value"):e.write("Capture completed with no packets.","warning")}},1e3*n);s._setTimer(l)}endCapture(e){const t=Ot.getState();if(!t.isCapturing)return void e.write("No capture in progress.","warning");const r=b.getState().packets,n=t.stopCapture(r);n?e.write(`‚úì Capture stopped!\n  Captured: ${n.packetCount} packets\n  Duration: ${n.durationSec}s\n  Size: ~${Kt(n.sizeBytes)}\n\nRun \`export cap ${n.id}\` to download.`,"value"):e.write("Capture stopped with no packets.","warning")}listCaptures(e){const{reports:t}=Ot.getState();if(0===t.length)return void e.write("No capture reports available.\nStart a capture with: start cap [seconds]","info");const r=t.map((e,t)=>`  ${t+1}. ${e.packetCount} pkts ‚Ä¢ ${e.durationSec}s ‚Ä¢ ~${Kt(e.sizeBytes)} (id: ${e.id})`);e.write(`Capture Reports (${t.length}):\n${r.join("\n")}`,"info")}exportCapture(e,t){const r=t.slice(10).trim(),n=Ot.getState(),s=b.getState().stats;if(!r){if(0===n.reports.length)e.write("No capture reports available.\nStart a capture with: start cap [seconds]","info");else{const t=n.reports.map((e,t)=>`  ${t+1}. ${e.id}`);e.write(`Usage: export cap <id>\n\nAvailable reports:\n${t.join("\n")}`,"info")}return}let a=n.getReport(r);if(!a){const e=parseInt(r)-1;a=n.reports[e]}a?(Xt(a,s),e.write(`‚úì Downloading ${a.filename}...`,"value")):e.write(`Error: Report "${r}" not found.\nUse "list cap" to see available reports.`,"error")}}class Vt extends te{constructor(){super(...arguments),t(this,"name","identities"),t(this,"description","List configured identities"),t(this,"aliases",["id","ids"])}async execute({output:e,rawInput:t}){var r;if("help"===this.argsAfterName(t).toLowerCase().trim())return void e.write([be("identities"),`  ${we("List all configured repeater and room server identities.")}`,"",xe("identities","list identities"),"",be("Aliases"),`  ${we("id, ids")}`].join("\n"));const n=e.write("processing...","system");try{const t=await _();if(!t.success||!t.data)return void e.update(n,t.error||"Failed to fetch identities","error");const s=t.data,a=(null==(r=s.configured)?void 0:r.length)?s.configured:s.registered||[];if(0===a.length)return void e.update(n,"No identities configured.","warning");const o=[be(`Identities (${a.length})`),"",...a.map((e,t)=>{var r;const n=e.name||"Unnamed",s=e.type||"unknown",a=(null==(r=e.hash)?void 0:r.slice(0,8))||"‚Äî";return`  ${we(`${t+1}.`)} ${ge(n)}  ${$e(s)}  ${ye(a)}`})];e.update(n,o.join("\n"))}catch(s){e.update(n,`Error: ${s instanceof Error?s.message:"Command failed"}`,"error")}}}class Jt extends te{constructor(){super(...arguments),t(this,"name","keys"),t(this,"description","List transport keys")}async execute({output:e,rawInput:t}){if("help"===this.argsAfterName(t).toLowerCase().trim())return void e.write([be("keys"),`  ${we("List configured transport encryption keys.")}`,"",xe("keys","list transport keys")].join("\n"));const r=e.write("processing...","system");try{const t=await z();if(!t.success||!t.data)return void e.update(r,t.error||"Failed to fetch transport keys","error");const n=t.data;if(0===n.length)return void e.update(r,"No transport keys configured.","warning");const s=[be(`Transport Keys (${n.length})`),"",...n.map(e=>{const t=e.parent_id?`  ${$e(`parent: ${e.parent_id}`)}`:"";return`  ${ge(e.name)}  ${ve("flood",ye(e.flood_policy))}${t}`})];e.update(r,s.join("\n"))}catch(n){e.update(r,`Error: ${n instanceof Error?n.message:"Command failed"}`,"error")}}}class Yt extends te{constructor(){super(...arguments),t(this,"name","acl"),t(this,"description","Show ACL statistics")}async execute({output:e,rawInput:t}){if("help"===this.argsAfterName(t).toLowerCase().trim())return void e.write([be("acl"),`  ${we("Display access control list statistics.")}`,"",xe("acl","show ACL stats")].join("\n"));const r=e.write("processing...","system");try{const t=await W();if(!t.success||!t.data)return void e.update(r,t.error||"Failed to fetch ACL stats","error");const n=t.data,s=[be("ACL Stats"),"",`  ${ve("Identities",ye(String(n.total_identities)))}`,`  ${ve("Total clients",ye(String(n.total_clients)))}`,`  ${ve("Admin",ye(String(n.admin_clients)))}`,`  ${ve("Guest",ye(String(n.guest_clients)))}`];if(n.by_identity_type){const e=n.by_identity_type.repeater,t=n.by_identity_type.room_server;e&&s.push(`  ${ve("Repeater",`${ye(String(e.count))} ids  ${we(`${e.clients} clients`)}`)}`),t&&s.push(`  ${ve("Room Server",`${ye(String(t.count))} ids  ${we(`${t.clients} clients`)}`)}`)}e.update(r,s.join("\n"))}catch(n){e.update(r,`Error: ${n instanceof Error?n.message:"Command failed"}`,"error")}}}class Qt extends te{constructor(){super(...arguments),t(this,"name","rooms"),t(this,"description","Show room server statistics")}async execute({output:e,rawInput:t}){if("help"===this.argsAfterName(t).toLowerCase().trim())return void e.write([be("rooms"),`  ${we("Display room server statistics and sync status.")}`,"",xe("rooms","list rooms")].join("\n"));const r=e.write("processing...","system");try{const t=await k();if(!t.success||!t.data)return void e.update(r,t.error||"Failed to fetch room stats","error");const n=t.data.rooms||[];if(0===n.length)return void e.update(r,"No room servers configured.","warning");const s=[be(`Rooms (${n.length})`),"",...n.map(e=>[`  ${ge(e.room_name)}`,`    ${ve("msgs",ye(String(e.total_messages)))}  ${ve("clients",`${ye(String(e.active_clients))}${$e(`/${e.total_clients}`)}`)}  ${ve("sync",e.sync_running?ye("running"):$e("idle"))}`]).flat()];e.update(r,s.join("\n"))}catch(n){e.update(r,`Error: ${n instanceof Error?n.message:"Command failed"}`,"error")}}}class Zt extends te{constructor(){super(...arguments),t(this,"name","restart"),t(this,"description","Restart pymc-repeater service"),t(this,"aliases",["reboot"])}async execute({output:e,rawInput:t}){if("help"===this.argsAfterName(t).toLowerCase().trim())return void e.write([be("restart"),`  ${we("Restart the pymc-repeater systemd service.")}`,"",xe("restart","restart the service"),"",be("Aliases"),`  ${we("reboot")}`,"",_e("Requires polkit permissions for the web user."),_e("The page will need a manual refresh after restart.")].join("\n"));const r=e.write("Restarting service...","system");try{const t=await q(AbortSignal.timeout(8e3));if(t.success)return e.update(r,"Service restart initiated.","success"),void this.waitForService(e);const n=t.status;if(403===n||401===n)return void e.update(r,"Error: Permission denied.\n\nThe web user needs polkit permissions to restart the service.\nSee: /etc/polkit-1/localauthority/50-local.d/pymc-repeater.pkla","error");e.update(r,t.error||"Restart failed","error")}catch(n){const t=n instanceof Error?n.message:"";t.includes("ERR_NETWORK")||t.includes("ECONNRESET")||t.includes("Failed to fetch")||t.includes("abort")||t.includes("timeout")||n instanceof DOMException&&"TimeoutError"===n.name||n instanceof DOMException&&"AbortError"===n.name?(e.update(r,"Service is restarting (connection dropped).","success"),this.waitForService(e)):e.update(r,`Error: ${t||"Restart failed"}`,"error")}}waitForService(e){const t=e.write("Waiting for service...","system");let r=0,n=!1;setTimeout(()=>{const s=setInterval(async()=>{if(!n){r++,e.update(t,`Waiting for service... ${r}s`,"system");try{await fetch(`${S}/api/stats`,{signal:AbortSignal.timeout(3e3)}),n=!0,clearInterval(s),e.update(t,`Service connected. (${r+4}s)`,"success")}catch{}!n&&r>=30&&(n=!0,clearInterval(s),e.update(t,"Service did not respond within 34s. Check manually.","warning"))}},1e3)},4e3)}}const er="[",tr=`${er}0m`,rr=`${er}32m`,nr=`${er}33m`,sr=`${er}31m`,ar=`${er}36m`,or=`${er}90m`,ir=`${er}1m`;function cr(e){return e>=1073741824?`${(e/1073741824).toFixed(1)}G`:e>=1048576?`${(e/1048576).toFixed(0)}M`:e>=1024?`${(e/1024).toFixed(0)}K`:`${e}B`}function lr(e){const t=Math.floor(e/86400),r=Math.floor(e%86400/3600),n=Math.floor(e%3600/60);return t>0?`${t}d ${r}h ${n}m`:r>0?`${r}h ${n}m`:`${n}m`}function ur(e,t){const r=" ".repeat(2),n=t-2,s=[];let a="",o=0;for(const i of e){const e=Le(i);0===o?(a=i,o=e):o+2+e<=n?(a+="  "+i,o+=2+e):(s.push(r+a),a=i,o=e)}return o>0&&s.push(r+a),s}function dr(e,t,r){var n,s;const a=e.node_name||"unknown",o=e.version?`v${e.version}`:"",i=(null==(n=t.system)?void 0:n.uptime)?lr(t.system.uptime):"?",c=lr(e.uptime_seconds||0),l=Math.max(3,r-4),u=(null==(s=t.cpu.load_avg)?void 0:s["1min"].toFixed(2))??"?",d=t.cpu.load_avg?`${u} ${t.cpu.load_avg["5min"].toFixed(2)} ${t.cpu.load_avg["15min"].toFixed(2)}`:"?",p=r>=60?d:u;return[`  ${ar}${ir}${a}${tr}  ${or}${o}${tr}`,`  ${or}${"‚îÄ".repeat(l)}${tr}`,...ur([ve("Sys",ye(i)),ve("Svc",ye(c)),ve("Load",ye(p))],r)]}function pr(e,t){const r=Math.max(6,Math.min(30,t-15)),n=t-(15+r)-2,s=[""],a=`${e.cpu.count} core${e.cpu.count>1?"s":""}`,o=`${cr(e.memory.used)}/${cr(e.memory.total)}`,i=`${cr(e.disk.used)}/${cr(e.disk.total)}`,c=(e,t,s)=>{const a=function(e,t){const r=Math.max(0,Math.min(100,e)),n=Math.round(r/100*t),s=t-n,a=r>=90?sr:r>=70?nr:rr;return`[${a}${"‚ñà".repeat(n)}${tr}${or}${"‚ñë".repeat(s)}${tr}] ${a}${`${r.toFixed(1)}%`.padStart(6)}${tr}`}(t,r),o=n>=s.length?`  ${$e(s)}`:"";return`  ${we(e.padEnd(4))}${a}${o}`};s.push(c("CPU",e.cpu.usage_percent,a)),s.push(c("Mem",e.memory.usage_percent,o)),s.push(c("Dsk",e.disk.usage_percent,i));const l=Object.entries(e.temperatures||{});if(l.length>0){const e=l.map(([e,t])=>{return`${$e(e+":")} ${r=t,r>=80?`${sr}${ir}${r.toFixed(1)}¬∞C${tr}`:r>=60?`${nr}${r.toFixed(1)}¬∞C${tr}`:`${rr}${r.toFixed(1)}¬∞C${tr}`}`;var r});s.push(...ur(e,t))}return s}function mr(e,t){var r,n;const s=e.neighbors||{},a=Object.keys(s).length,o=Object.values(s).filter(e=>e.zero_hop).length,i=(null==(n=null==(r=e.config)?void 0:r.repeater)?void 0:n.mode)||"?",c=null!=e.noise_floor_dbm?`${e.noise_floor_dbm}dBm`:"?",l=e.duty_cycle_percent??0,u=["",`  ${or}MESH${tr}`];return u.push(...ur([ve("Mode",ye(i)),ve("Nbrs",`${ye(String(o))}${$e(`/${a}`)}`),ve("Noise",ye(c)),ve("Air",ye(`${l.toFixed(1)}%`))],t)),u.push(...ur([ve("RX",ye(String(e.rx_count??0))),ve("TX",ye(String(e.tx_count??0))),ve("FWD",ye(String(e.forwarded_count??0))),ve("Drop",ye(String(e.dropped_count??0)))],t)),u.push(...ur([ve("RX/h",ye(String(Math.round(e.rx_per_hour??0)))),ve("FWD/h",ye(String(Math.round(e.forwarded_per_hour??0))))],t)),u}function hr(e,t){if(!e.network)return[];const r=["",`  ${or}NET${tr}`];return r.push(...ur([ve("TX",ye(cr(e.network.bytes_sent))),ve("RX",ye(cr(e.network.bytes_recv))),ve("Pkt",`${ye(String(e.network.packets_sent))}${$e("/")}${ye(String(e.network.packets_recv))}`)],t)),r}function fr(e,t){if(0===e.length)return[];const r=t>=50,n=t>=50?6:5,s=t>=50?6:5,a=r?7:0,o=Math.max(4,t-2-a-n-s-4),i=t>=50?8:5,c=["",`  ${or}PROCS${tr}`],l=(r?"PID".padEnd(a):"")+"CPU".padStart(n)+"MEM".padStart(s)+"  NAME";c.push(`  ${$e(l)}`);for(const u of e.slice(0,i)){const e=r?$e(String(u.pid).padEnd(a)):"",i=(t>=50?u.cpu_percent.toFixed(1):u.cpu_percent.toFixed(0)).padStart(n),l=(t>=50?u.memory_percent.toFixed(1):u.memory_percent.toFixed(0)).padStart(s),d=u.name.length>o?u.name.slice(0,o-1)+"‚Ä¶":u.name,p=u.cpu_percent>=50?sr:u.cpu_percent>=20?nr:"",m=p?`${p}${i}${tr}`:i;c.push(`  ${e}${m}${$e(l)}  ${d}`)}return c}function gr(e,t,r,n){return e&&t?[...dr(e,t,n),...pr(t,n),...mr(e,n),...hr(t,n),...fr(r,n),"",`  ${or}${(new Date).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1})}  ¬∑  Ctrl+C to exit${tr}`].join("\n"):`  ${or}Waiting for data‚Ä¶${tr}`}class $r extends te{constructor(){super(...arguments),t(this,"name","top"),t(this,"description","Live system overview (Ctrl+C to exit)"),t(this,"aliases",["htop"])}async execute({output:e,rawInput:t,cols:r,signal:n}){var s,a;if("help"===this.argsAfterName(t).toLowerCase().trim())return void e.write([be("top"),`  ${we("Live-updating system overview combining hardware")}`,`  ${we("stats, mesh metrics, and running processes.")}`,`  ${we("Refreshes every 3s. Press Ctrl+C to exit.")}`,"",xe("top","start live display"),"",be("Sections"),`  ${we("Header     Node name, version, uptime, load average")}`,`  ${we("Gauges     CPU, memory, disk usage with bar charts")}`,`  ${we("Mesh       Mode, neighbors, packet counts, airtime")}`,`  ${we("Network    TCP/IP bytes and packet counters")}`,`  ${we("Processes  Top 8 processes by CPU usage")}`,"",be("Aliases"),`  ${we("htop")}`].join("\n"));let o=b.getState().hardwareStats,i=[],c=b.getState().stats;try{const[e,t]=await Promise.all([d(),C()]);e.success&&e.data&&(o=e.data),t.success&&t.data&&(i=t.data.processes.sort((e,t)=>t.cpu_percent-e.cpu_percent))}catch{}if(!n.aborted){null==(s=e.enterFullscreen)||s.call(e);try{const t=e.write(gr(c,o,i,e.cols??r));await new Promise(s=>{if(n.aborted)return void s();const a=setInterval(()=>{if(n.aborted)return clearInterval(a),void s();(async()=>{c=b.getState().stats;try{const[e,t]=await Promise.all([d(),C()]);e.success&&e.data&&(o=e.data),t.success&&t.data&&(i=t.data.processes.sort((e,t)=>t.cpu_percent-e.cpu_percent))}catch{}n.aborted||e.update(t,gr(c,o,i,e.cols??r))})()},3e3);n.addEventListener("abort",()=>{clearInterval(a),s()},{once:!0})})}finally{null==(a=e.exitFullscreen)||a.call(e)}}}}const yr=P(e=>({entries:[],commandHistory:[],isInitialized:!1,addEntry:t=>{const r="undefined"!=typeof crypto&&crypto.randomUUID?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}),n={...t,id:r,timestamp:Date.now()};return e(e=>({entries:[...e.entries,n]})),r},updateEntry:(t,r)=>{e(e=>({entries:e.entries.map(e=>e.id===t?{...e,...r}:e)}))},addCommand:t=>{e(e=>({commandHistory:[...e.commandHistory,t]}))},clearEntries:()=>{e({entries:[],commandHistory:[]})},setInitialized:t=>{e({isInitialized:t})}}));function wr({isOpen:e,onClose:t}){const n=Bt(),s=b(e=>e.stats);return r.jsxs(j,{open:e,onClose:t,size:"sm",children:[r.jsx(N,{icon:r.jsx(O,{size:20}),title:"Download Captures",onClose:t}),r.jsx(T,{className:"flex flex-col gap-2",children:0===n.length?r.jsxs("div",{className:"flex flex-col items-center gap-2 py-6 text-text-muted",children:[r.jsx(Z,{className:"w-8 h-8 opacity-40"}),r.jsx("p",{className:"text-sm",children:"No captures available."})]}):n.map(e=>r.jsxs("div",{className:"flex items-center gap-3 px-4 py-3 radius-inset bg-bg-elevated/50 border border-border-subtle",children:[r.jsxs("div",{className:"flex-1 min-w-0",children:[r.jsx("p",{className:"text-sm font-medium text-text-primary truncate",children:e.filename}),r.jsxs("p",{className:"text-xs text-text-muted mt-0.5",children:[e.packetCount," packets ¬∑ ",e.durationSec,"s ¬∑ ~",Kt(e.sizeBytes)]})]}),r.jsx(E,{plain:!0,color:"primary",onClick:()=>(e=>{const t=n.find(t=>t.id===e);t&&Xt(t,s)})(e.id),title:"Download",className:"flex-shrink-0",children:r.jsx(O,{"data-slot":"icon"})})]},e.id))})]})}function vr(){const e=Bt(),t=e.length>0,[s,a]=n.useState(!1);return t?r.jsxs(r.Fragment,{children:[r.jsx(X,{icon:r.jsx(K,{size:20}),onClick:()=>a(!0),title:`Download captures (${e.length})`,iconActiveColor:"#E5484D",keycapSrc:"/assets/keycap-red.svg"}),r.jsx(wr,{isOpen:s,onClose:()=>a(!1)})]}):null}const xr=function(){const e=new ee,t=new rt(e);return e.register(t,new nt,new at,new ot,new it,new ut,new dt,new bt,new Ft,new _t,new kt,new Mt,new Gt,new Vt,new Jt,new Yt,new Qt,new Zt,new $r),e}(),br=xr.all().flatMap(e=>[{cmd:e.name,desc:e.description,params:e.params,required:!!e.params},...e.aliases.filter(e=>e.includes(" ")).map(t=>({cmd:t,desc:e.description,params:e.params,required:!!e.params}))]),_r={"set mode":["forward","monitor"],"set duty":["on","off"],"set repeat":["on","off"],"set tx":["10","14","17","20","22"],"set sf":["7","8","9","10","11","12"],"set bw":["125","250","500"],"set af":["0.5","1.0","1.5","2.0"],"set txdelay":["0.5","0.7","1.0","1.5"],"set direct.txdelay":["0.3","0.5","0.7"],"set log":["debug","info","warning"],"start cap":["30","60","120","300"]};function kr(){return/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)||window.innerWidth<640}function Sr(){const e=R(),{addCommand:t}=yr(),c=n.useRef(null),u=n.useRef(null),d=n.useRef(null),p=n.useRef(null),m=n.useRef(""),h=n.useRef(-1),f=n.useRef(""),g=n.useRef(!1),$=n.useRef(null),y=n.useRef(!1),w=n.useRef(!1),v=n.useRef([]),x=n.useRef(()=>{}),b=A(),[_,k]=n.useState({show:!1,options:[],selectedIndex:0,input:""}),S=n.useRef([]),C=n.useRef(0);n.useEffect(()=>{(null==e?void 0:e.neighbors)&&(v.current=Object.values(e.neighbors).map(e=>e.node_name||e.name).filter(e=>!!e).sort())},[null==e?void 0:e.neighbors]);const j=n.useCallback(()=>{var e;null==(e=u.current)||e.write(ke)},[]),N=n.useCallback(()=>{const e=u.current;e&&(e.write(Re),j(),e.write(m.current))},[j]),T=n.useCallback(e=>{const t=function(e,t){const r=e.trim().toLowerCase();if(!r)return[];const n=br.filter(e=>e.cmd.toLowerCase().startsWith(r));if(n.length>0)return n;if(r.includes(" ")){const e=r.lastIndexOf(" "),n=r.substring(0,e),s=r.substring(e+1);if("ping"===n&&t.length>0)return t.filter(e=>e.toLowerCase().startsWith(s)).slice(0,10).map(e=>({cmd:`ping ${e}`,desc:`‚Üí ${e}`}));const a=br.find(e=>e.cmd.toLowerCase()===n);if(a&&_r[a.cmd])return _r[a.cmd].filter(e=>e.toLowerCase().startsWith(s)).map(e=>({cmd:`${a.cmd} ${e}`,desc:`‚Üí ${e}`}))}return[]}(e,v.current);S.current=t,C.current=0;const r=t.length>0&&e.trim().length>0;k({show:r,options:t,selectedIndex:0,input:e.trim()})},[]),E=n.useCallback(()=>{S.current=[],C.current=0,k({show:!1,options:[],selectedIndex:0,input:""})},[]),M=n.useCallback(e=>{var t;const r=S.current[e];r&&(m.current=r.required?r.cmd+" ":r.cmd,N(),r.required?T(m.current):E(),null==(t=u.current)||t.focus())},[N,T,E]),L=n.useCallback(async e=>{const r=u.current;if(!r)return;const n=e.trim();if(!n)return void j();g.current=!0;const s=new AbortController;$.current=s,t(n),h.current=-1;let a=0;const o={get cols(){return r.cols},write(e,t="default"){const n=("default"===t?e:fe(e,t)).split("\n");for(const s of n)r.writeln(s);return a=De(n,r.cols),String(a)},update(e,t,n){if(w.current)r.write("[H");else if(a>0)for(let o=0;o<a;o++)r.write(Ae()),r.write(Re);const s=(n?fe(t,n):t).split("\n");for(const a of s)r.writeln(a);w.current&&r.write("[J"),a=De(s,r.cols)},clear(){r.clear(),a=0},enterFullscreen(){r.write("[?1049h[?25l"),w.current=!0,a=0},exitFullscreen(){r.write(Fe+Ie),w.current=!1,a=0}},i=xr.find(n);if(i){const e=n.split(/\s+/);try{await i.execute({output:o,args:e,rawInput:n,cols:r.cols,signal:s.signal})}catch(c){c instanceof DOMException&&"AbortError"===c.name||o.write(`Error: ${c instanceof Error?c.message:"Command failed"}`,"error")}}else o.write(`Unknown command: ${n}\nType 'help' for available commands.`,"error");$.current=null,g.current=!1,j()},[t,j]),D=n.useCallback(e=>{const t=u.current;if(!t)return;if(g.current){for(let r=0;r<e.length;r++)3===e.charCodeAt(r)&&$.current&&($.current.abort(),t.writeln("^C"));return}const r=yr.getState().commandHistory,n=e=>requestAnimationFrame(()=>{var t;return null==(t=document.querySelector(`[data-ac-index="${e}"]`))?void 0:t.scrollIntoView({block:"nearest"})});for(let s=0;s<e.length;s++){const a=e.charCodeAt(s);if(13===a){if(S.current.length>0){const e=S.current[C.current];e&&(m.current=e.cmd,N())}E();const e=m.current;m.current="",t.writeln(""),L(e);continue}if(127!==a&&8!==a)if(3!==a)if(12!==a)if(9!==a)if(27!==a)a>=32&&(m.current+=e[s],t.write(e[s]),h.current=-1,T(m.current));else{if(91===e.charCodeAt(s+1)){const t=e.charCodeAt(s+2);if(s+=2,65===t){if(S.current.length>0){const e=Math.max(C.current-1,0);C.current=e,k(t=>({...t,selectedIndex:e})),n(e)}else r.length>0&&(-1===h.current&&(f.current=m.current),h.current<r.length-1&&(h.current++,m.current=r[r.length-1-h.current]||"",N()));continue}if(66===t){if(S.current.length>0){const e=Math.min(C.current+1,S.current.length-1);C.current=e,k(t=>({...t,selectedIndex:e})),n(e)}else h.current>0?(h.current--,m.current=r[r.length-1-h.current]||"",N()):0===h.current&&(h.current=-1,m.current=f.current,N());continue}if(67===t||68===t)continue;continue}S.current.length>0&&E()}else S.current.length>0&&M(C.current);else t.clear(),E(),N();else m.current="",E(),t.writeln("^C"),j();else m.current.length>0&&(m.current=m.current.slice(0,-1),t.write("\b \b"),T(m.current))}},[E,T,M,j,N,L]);n.useEffect(()=>{x.current=D},[D]);const O=n.useCallback(async()=>{const e=u.current;if(!e||y.current)return;y.current=!0;const t="[94m",r="[0m",n="‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  ‚ñà‚ñà    ‚ñà‚ñà ‚ñà‚ñà‚ñà    ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà\n‚ñà‚ñà   ‚ñà‚ñà  ‚ñà‚ñà  ‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà ‚ñà‚ñà     \n‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà    ‚ñà‚ñà‚ñà‚ñà   ‚ñà‚ñà ‚ñà‚ñà‚ñà‚ñà ‚ñà‚ñà ‚ñà‚ñà     \n‚ñà‚ñà         ‚ñà‚ñà    ‚ñà‚ñà  ‚ñà‚ñà  ‚ñà‚ñà ‚ñà‚ñà     \n‚ñà‚ñà         ‚ñà‚ñà    ‚ñà‚ñà      ‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà".split("\n");for(const s of n){let t="",n=!1;for(const e of s)"‚ñà"===e?(n||(t+="[104m",n=!0),t+=" "):(n&&(t+=r,n=!1),t+=" ");n&&(t+=r),e.writeln(t)}e.writeln(""),e.write(we("‚óè Initializing terminal...")),await new Promise(e=>setTimeout(e,300)),e.write(Re),e.writeln(`${t}‚úì Initializing terminal...${r}`),e.write(we("‚óè Connecting to repeater...")),await new Promise(e=>setTimeout(e,500)),e.write(Re),"connected"===I.getState().health?e.writeln(`${t}‚úì Connected to repeater${r}`):e.writeln(`${le}~ Connection status unknown${ne}`),e.writeln(we("Ready. Type 'help' for commands.")),e.writeln(""),j()},[j]);n.useEffect(()=>{const e=c.current;if(!e)return;const t=new a({theme:Be(),fontFamily:'"JetBrains Mono", "IBM Plex Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace',fontSize:13,lineHeight:1.4,cursorBlink:!1,cursorStyle:"underline",scrollback:1e4,convertEol:!0,allowTransparency:!0,rightClickSelectsWord:!1}),r=new o;t.loadAddon(r),t.loadAddon(new i),t.open(e),r.fit(),u.current=t,d.current=r;const n=t.onData(e=>x.current(e)),s=function(e){return l.subscribe(()=>{e.options.theme=Be()})}(t),p=new ResizeObserver(()=>{requestAnimationFrame(()=>r.fit())});return p.observe(e),O(),kr()||t.focus(),()=>{var e;null==(e=$.current)||e.abort(),w.current&&(t.write(Fe+Ie),w.current=!1),n.dispose(),s(),p.disconnect(),t.dispose(),u.current=null,d.current=null}},[]);const B=n.useCallback(e=>{const t=e.target.value;t.length>0&&(D(t),e.target.value="")},[D]),P=n.useCallback(e=>{"Enter"===e.key?(e.preventDefault(),D("\r")):"Backspace"===e.key?(e.preventDefault(),D("")):"ArrowUp"===e.key?(e.preventDefault(),D("[A")):"ArrowDown"===e.key&&(e.preventDefault(),D("[B"))},[D]),H=n.useCallback(()=>{var e,t;kr()?null==(e=p.current)||e.focus():null==(t=u.current)||t.focus()},[]);return r.jsxs(V,{children:[r.jsx(J,{title:"Terminal",icon:r.jsx(F,{})}),r.jsx(Y,{children:r.jsxs("div",{className:"terminal-card flex flex-col gap-1.5",children:[r.jsxs("div",{className:"card-terminal-header flex-wrap",children:[r.jsx("span",{className:"seven-seg-panel",children:r.jsx(G,{text:"5hell",minChars:7,size:24})}),r.jsx("div",{className:"header-well self-stretch flex-col",children:r.jsxs("div",{className:"indicator-key"+("connected"===b?" indicator-key--active":"degraded"===b?" indicator-key--sending":""),children:[r.jsx("span",{className:"indicator-key__label",children:"ONLINE"}),r.jsx("span",{className:"indicator-key__led"})]})}),r.jsx("div",{className:"card-terminal-ridge flex-1 min-w-8 hidden sm:block"}),r.jsx("div",{className:"header-well",children:r.jsx(vr,{})})]}),r.jsx(Q,{noPadding:!0,className:"flex flex-col flex-1 min-h-0 overflow-hidden card-terminal",onClick:H,children:r.jsxs("div",{className:"card-terminal-well flex-1 min-h-0 flex flex-col overflow-hidden",children:[r.jsx("div",{className:"flex-1 min-h-0 terminal-gutter",children:r.jsx("div",{ref:c,className:"h-full w-full"})}),_.show&&_.options.length>0&&r.jsxs("div",{className:"flex-shrink-0 overflow-hidden terminal-completions",style:{borderTop:"1px solid var(--terminal-border)",background:"var(--terminal-bg-input)"},children:[r.jsx("div",{className:"overflow-y-auto",style:{maxHeight:"176px"},children:_.options.map((e,t)=>{const n=t===_.selectedIndex,a=_.input.length;return r.jsxs("div",{"data-ac-index":t,onClick:()=>M(t),className:s("flex items-baseline gap-2 px-3 py-0.5 cursor-pointer transition-colors",n?"text-accent-primary":"text-text-primary"),style:{background:n?"var(--terminal-autocomplete-hover)":void 0},onMouseEnter:e=>{n||(e.currentTarget.style.background="var(--terminal-autocomplete-hover)")},onMouseLeave:e=>{n||(e.currentTarget.style.background="")},children:[r.jsx("span",{className:"w-3 shrink-0 text-center text-accent-primary opacity-80",children:n?"‚ñ∏":""}),r.jsxs("span",{className:"min-w-0 truncate flex-1",children:[r.jsx("span",{className:"font-semibold text-accent-primary",children:e.cmd.substring(0,a)}),e.cmd.substring(a)]}),r.jsx("span",{className:"shrink-0 text-[11px] text-text-muted pl-3",children:e.desc})]},e.cmd)})}),r.jsxs("div",{className:"flex justify-between items-center px-3 py-0.5 text-[10px] text-text-muted",style:{borderTop:"1px solid var(--terminal-border)"},children:[r.jsx("span",{children:"Tab ¬∑ ‚Üë‚Üì ¬∑ Esc"}),r.jsxs("span",{children:[_.options.length," match",1!==_.options.length?"es":""]})]})]}),r.jsx("input",{ref:p,type:"text",className:"sr-only",onChange:B,onKeyDown:P,autoComplete:"off",autoCorrect:"off",autoCapitalize:"off",spellCheck:!1,"aria-label":"Terminal input"}),r.jsxs("div",{className:"px-3 sm:px-4 py-1 flex justify-between text-[10px] text-text-muted",style:{borderTop:"1px solid var(--terminal-border)"},children:[r.jsx("span",{className:"hidden sm:inline",children:"‚Üë‚Üì History ¬∑ Tab ¬∑ Esc"}),r.jsx("span",{className:"sm:hidden",children:"Terminal"}),(null==e?void 0:e.version)&&r.jsxs("span",{children:["pyMC v",e.version]})]})]})})]})})]})}export{Sr as default};
