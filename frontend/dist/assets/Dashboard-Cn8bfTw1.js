import{c as e,j as t,u as a,a as n,b as i,d as l,R as r,L as s,e as c,f as o,g as d,h as u,i as m,D as h,k as p,P as v,l as x,M as f,C as g}from"./index-CSdhf7Y1.js";import{b,d as N,L as y,e as k,A as w,C as M,X as C,Y as L,T as B,f as S}from"./recharts-CGff6_7g.js";import{u as A,T as j}from"./TimeRangeSelector-CifvQwCH.js";import{g as R,A as T,P as D,a as F,b as H,C as P}from"./PacketDetailModal-gyRui90M.js";import{C as $}from"./circle-nBPgmefg.js";import{H as E}from"./HashBadge-Cq5f_dip.js";import{T as z,N as W}from"./trending-up-DsTELlWj.js";import{T as q,M as I,Z as V}from"./zap-3T8VQsn0.js";import{C as G,P as K,a as O,b as Q,G as U,c as X}from"./PageLayout-BRt4BPq0.js";import{H as J}from"./house-Cf8LTSOQ.js";import"./maplibre-gl-DsiI67my.js";import"./SignalIndicator-2FfmTLDc.js";import"./triangle-alert-JEH_fId4.js";const _=e("arrow-up-right",[["path",{d:"M7 7h10v10",key:"1tivn9"}],["path",{d:"M7 17 17 7",key:"1vkiza"}]]),Y=e("audio-waveform",[["path",{d:"M2 13a2 2 0 0 0 2-2V7a2 2 0 0 1 4 0v13a2 2 0 0 0 4 0V4a2 2 0 0 1 4 0v13a2 2 0 0 0 4 0v-4a2 2 0 0 1 2-2",key:"57tc96"}]]),Z=e("cross",[["path",{d:"M4 9a2 2 0 0 0-2 2v2a2 2 0 0 0 2 2h4a1 1 0 0 1 1 1v4a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2v-4a1 1 0 0 1 1-1h4a2 2 0 0 0 2-2v-2a2 2 0 0 0-2-2h-4a1 1 0 0 1-1-1V4a2 2 0 0 0-2-2h-2a2 2 0 0 0-2 2v4a1 1 0 0 1-1 1z",key:"1xbrqy"}]]),ee=e("ear-off",[["path",{d:"M6 18.5a3.5 3.5 0 1 0 7 0c0-1.57.92-2.52 2.04-3.46",key:"1qngmn"}],["path",{d:"M6 8.5c0-.75.13-1.47.36-2.14",key:"b06bma"}],["path",{d:"M8.8 3.15A6.5 6.5 0 0 1 19 8.5c0 1.63-.44 2.81-1.09 3.76",key:"g10hsz"}],["path",{d:"M12.5 6A2.5 2.5 0 0 1 15 8.5M10 13a2 2 0 0 0 1.82-1.18",key:"ygzou7"}],["line",{x1:"2",x2:"22",y1:"2",y2:"22",key:"a6p6uj"}]]),te=e("refresh-cw-off",[["path",{d:"M21 8L18.74 5.74A9.75 9.75 0 0 0 12 3C11 3 10.03 3.16 9.13 3.47",key:"1krf6h"}],["path",{d:"M8 16H3v5",key:"1cv678"}],["path",{d:"M3 12C3 9.51 4 7.26 5.64 5.64",key:"ruvoct"}],["path",{d:"m3 16 2.26 2.26A9.75 9.75 0 0 0 12 21c2.49 0 4.74-1 6.36-2.64",key:"19q130"}],["path",{d:"M21 12c0 1-.16 1.97-.47 2.87",key:"4w8emr"}],["path",{d:"M21 3v5h-5",key:"1q7to0"}],["path",{d:"M22 22 2 2",key:"1r8tn9"}]]),ae=e("route",[["circle",{cx:"6",cy:"19",r:"3",key:"1kj8tv"}],["path",{d:"M9 19h8.5a3.5 3.5 0 0 0 0-7h-11a3.5 3.5 0 0 1 0-7H15",key:"1d8sl"}],["circle",{cx:"18",cy:"5",r:"3",key:"gq8acd"}]]),ne=e("square-activity",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}],["path",{d:"M17 12h-2l-2 5-2-10-2 5H7",key:"15hlnc"}]]),ie=e("timer",[["line",{x1:"10",x2:"14",y1:"2",y2:"2",key:"14vaq8"}],["line",{x1:"12",x2:"15",y1:"14",y2:"11",key:"17fdiu"}],["circle",{cx:"12",cy:"14",r:"8",key:"1e1u0o"}]]),le="#39D98A",re="#60A5FA",se="#F9D26F",ce="#FF5C7A",oe="#B0B0C3",de={received:{value:"text-[var(--metric-received)]",barBase:le,barGood:le,barMid:"#2EAE70",barPoor:"#248F5C"},forwarded:{value:"text-[var(--metric-forwarded)]",barBase:re,barGood:re,barMid:"#4B8FE0",barPoor:"#3B7ACC"},transmitted:{value:"text-[var(--metric-transmitted)]",barBase:se,barGood:se,barMid:"#E5BD5E",barPoor:"#CCA84D"},dropped:{value:"text-[var(--metric-dropped)]",barBase:ce,barGood:ce,barMid:"#E54868",barPoor:"#CC3E5C"},neutral:{value:"text-text-secondary",barBase:oe,barGood:oe,barMid:"#9A9AAE",barPoor:"#85859A"}};function ue(e,t){return e>=8?t.barGood:e>=3?t.barMid:t.barPoor}function me({buckets:e,colorType:a,height:n=64}){const i=de[a],{bars:l}=b.useMemo(()=>{var t,n;if(!e||0===e.length)return{bars:[]};const l=[],r=e.length/60;if(r<=1)l.push(...e);else for(let a=0;a<60;a++){const i=Math.floor(a*r),s=Math.floor((a+1)*r),c=e.slice(i,s),o=c.reduce((e,t)=>e+t.count,0),d=c.length>0?c.reduce((e,t)=>e+t.avg_snr,0)/c.length:0;l.push({bucket:a,start:(null==(t=c[0])?void 0:t.start)??0,end:(null==(n=c[c.length-1])?void 0:n.end)??0,count:o,airtime_ms:c.reduce((e,t)=>e+t.airtime_ms,0),avg_snr:d,avg_rssi:0})}const s=Math.max(...l.map(e=>e.count),1),c="dropped"===a;return{bars:l.map(e=>({height:e.count>0?Math.max(e.count/s*100,8):0,color:e.count>0?c?i.barBase:ue(e.avg_snr,i):"transparent",count:e.count,snr:e.avg_snr}))}},[e,i,a]);return e&&0!==e.length?t.jsx("div",{className:"w-full flex items-end gap-[1px]",style:{height:n},children:l.map((e,a)=>{var n;return t.jsx("div",{className:"flex-1 rounded-t-sm",style:{height:`${e.height}%`,backgroundColor:e.color,opacity:e.count>0?.8:.1,minHeight:e.count>0?"4px":"2px",maxWidth:"4px"},title:e.count>0?`${e.count} packets, SNR: ${null==(n=e.snr)?void 0:n.toFixed(1)}dB`:"No packets"},a)})}):t.jsx("div",{className:"w-full flex items-end justify-center gap-[2px] opacity-20",style:{height:n},children:t.jsx("span",{className:"type-data-xs text-text-muted",children:"No data"})})}const he={received:"text-[var(--metric-received)]",forwarded:"text-[var(--metric-forwarded)]",transmitted:"text-[var(--metric-transmitted)]",dropped:"text-[var(--metric-dropped)]",neutral:"text-[var(--accent-primary)]"},pe={sm:"card-sm",md:"card-md",lg:"card-lg",hero:"card-hero",auto:""};function ve({title:e,value:a,color:n="neutral",subtitle:i,buckets:l,timeRangeLabel:r,icon:s,size:c="md"}){const o=de[n],d="string"==typeof a?a:a.toLocaleString();return t.jsxs("div",{className:`data-card flex flex-col ${pe[c]}`,children:[t.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[s&&t.jsx("span",{className:`icon-sm ${he[n]}`,children:s}),t.jsx("span",{className:"type-micro",children:e}),r&&t.jsx("span",{className:"pill-tag",children:r})]}),t.jsx("div",{className:"data-card-value",children:d}),t.jsx("div",{className:"flex-1 py-2 mt-2",children:l?t.jsx(me,{buckets:l,colorType:n,height:64}):t.jsx("div",{className:"w-full h-16 flex items-center justify-center",children:t.jsx("div",{className:"w-full h-0.5 rounded-full",style:{backgroundColor:o.barBase,opacity:.15}})})}),t.jsx("div",{className:"type-label text-text-muted border-t border-border-subtle pt-3 mt-2",children:i||`Total ${e.toLowerCase()}`})]})}function xe(){const e=a(),c=n(),o=i(),d=l(),[u,m]=b.useState(null),[h,p]=b.useState(null),v=b.useRef(0);b.useEffect(()=>{if(d>0&&d!==v.current&&e.length>0){v.current=d;const t=e.find(e=>(e.payload_type_name||R(e.payload_type??e.type)).toLowerCase().includes("advert"));if(t){const e=requestAnimationFrame(()=>m(t.packet_hash)),a=setTimeout(()=>m(null),600);return()=>{cancelAnimationFrame(e),clearTimeout(a)}}}},[d,e]);const x=e.slice(0,15);return t.jsxs("div",{className:"chart-container h-full flex flex-col",children:[t.jsxs("div",{className:"chart-header",children:[t.jsxs("div",{className:"chart-title",children:[t.jsx(r,{className:"chart-title-icon"}),"Recent Packets"]}),t.jsxs("div",{className:"flex items-center gap-3",children:[o&&t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx($,{className:"w-2 h-2 fill-accent-success text-accent-success animate-pulse"}),t.jsx("span",{className:"type-data-xs text-text-muted",children:"LIVE"})]}),t.jsxs(s,{to:"/packets",className:"pill-subtle",children:["View all ",t.jsx(T,{className:"w-3 h-3"})]})]})]}),t.jsxs("div",{className:"sm:hidden flex items-center gap-1.5 px-3 py-1.5 border-b border-border-subtle/50 bg-bg-elevated/20",children:[t.jsx("span",{className:"text-[9px] font-semibold text-text-muted uppercase tracking-wider w-14 flex-shrink-0",children:"Dir"}),t.jsx("span",{className:"text-[9px] font-semibold text-text-muted uppercase tracking-wider w-7 flex-shrink-0",children:"Time"}),t.jsx("span",{className:"text-[9px] font-semibold text-text-muted uppercase tracking-wider w-9 flex-shrink-0",children:"Src"}),t.jsx("span",{className:"text-[9px] font-semibold text-text-muted uppercase tracking-wider flex-1 min-w-0",children:"Type"}),t.jsx("span",{className:"text-[9px] font-semibold text-text-muted uppercase tracking-wider w-14 flex-shrink-0",children:"Route"}),t.jsx("span",{className:"text-[9px] font-semibold text-text-muted uppercase tracking-wider w-10 text-right flex-shrink-0",children:"Signal"})]}),t.jsx("div",{className:"hidden sm:block flex-1 overflow-hidden",children:t.jsx("div",{className:"h-full overflow-y-auto",children:t.jsxs("table",{className:"w-full",children:[t.jsx("thead",{className:"sticky top-0 bg-bg-elevated/95 backdrop-blur-sm",children:t.jsxs("tr",{className:"border-b border-border-subtle/50",children:[t.jsx("th",{className:"text-left py-1.5 px-3 text-[9px] font-semibold text-text-muted uppercase tracking-wider w-16",children:"Dir"}),t.jsx("th",{className:"text-left py-1.5 px-3 text-[9px] font-semibold text-text-muted uppercase tracking-wider",children:"Time"}),t.jsx("th",{className:"text-left py-1.5 px-3 text-[9px] font-semibold text-text-muted uppercase tracking-wider",children:"Source"}),t.jsx("th",{className:"text-left py-1.5 px-3 text-[9px] font-semibold text-text-muted uppercase tracking-wider",children:"Type"}),t.jsx("th",{className:"text-left py-1.5 px-3 text-[9px] font-semibold text-text-muted uppercase tracking-wider",children:"Route"}),t.jsx("th",{className:"text-right py-1.5 px-3 pr-4 text-[9px] font-semibold text-text-muted uppercase tracking-wider",children:"Signal"})]})}),t.jsx("tbody",{className:"divide-y divide-border-subtle/30",children:c&&0===e.length?t.jsx("tr",{children:t.jsx("td",{colSpan:6,className:"text-center py-8 text-text-muted",children:"Loading packets..."})}):0===x.length?t.jsx("tr",{children:t.jsxs("td",{colSpan:6,className:"text-center py-8",children:[t.jsx(r,{className:"w-6 h-6 text-text-muted mx-auto mb-2"}),t.jsx("div",{className:"text-sm text-text-primary",children:"No packets received"}),t.jsx("div",{className:"text-xs text-text-muted",children:"Packets will appear here"})]})}):x.map(e=>{const a=(e.payload_type_name||R(e.payload_type??e.type)).toLowerCase().includes("advert");return t.jsx(D,{packet:e,onClick:p,isFlashing:a&&u===e.packet_hash},e.packet_hash)})})]})})}),t.jsx("div",{className:"sm:hidden flex-1 overflow-y-auto divide-y divide-border-subtle/30",children:c&&0===e.length?t.jsx("div",{className:"p-8 text-center text-text-muted",children:"Loading packets..."}):0===x.length?t.jsxs("div",{className:"p-8 text-center",children:[t.jsx(r,{className:"w-6 h-6 text-text-muted mx-auto mb-2"}),t.jsx("div",{className:"text-sm text-text-primary",children:"No packets received"}),t.jsx("div",{className:"text-xs text-text-muted",children:"Packets will appear here"})]}):x.map(e=>{const a=(e.payload_type_name||R(e.payload_type??e.type)).toLowerCase().includes("advert");return t.jsx(F,{packet:e,onClick:p,isFlashing:a&&u===e.packet_hash},e.packet_hash)})}),t.jsxs("div",{className:"px-3 py-1.5 border-t border-border-subtle/50 text-[10px] text-text-muted bg-bg-elevated/20 text-center",children:["Showing ",x.length," of ",e.length," packets"]}),h&&t.jsx(H,{packet:h,onClose:()=>p(null)})]})}b.memo(function({active:e,payload:a,label:n,formatValue:i,labelKey:l}){var r;if(!e||!a||0===a.length)return null;const s=l&&(null==(r=a[0])?void 0:r.payload)?a[0].payload[l]:n;return t.jsxs("div",{className:"bg-black/90 backdrop-blur-sm border border-white/10 rounded-lg px-4 py-3 shadow-xl",children:[s&&t.jsx("p",{className:"type-data-xs text-white/50 mb-2",children:s}),t.jsx("div",{className:"space-y-1.5",children:a.map((e,a)=>t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("span",{className:"w-2 h-2 rounded-full flex-shrink-0",style:{backgroundColor:e.color}}),t.jsx("span",{className:"type-body-sm text-white/70 capitalize min-w-[60px]",children:e.name}),t.jsx("span",{className:"type-data-sm text-white tabular-nums",children:i?i(e.value,e.name):e.value.toLocaleString()})]},a))})]})});const fe=b.memo(function({active:e,payload:a,color:n,labelKey:i,unit:l=""}){var r,s;if(!e||!a||0===a.length)return null;const c=a[0],o=null==(r=null==c?void 0:c.payload)?void 0:r[i];return t.jsxs("div",{className:"bg-black/90 backdrop-blur-sm border border-white/10 rounded-lg px-3 py-2 shadow-xl",children:[t.jsx("p",{className:"type-data-xs text-white/50 mb-1",children:o}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("span",{className:"w-2 h-2 rounded-full",style:{backgroundColor:n}}),t.jsxs("span",{className:"type-data-sm text-white tabular-nums",children:[null==(s=null==c?void 0:c.value)?void 0:s.toLocaleString(),l]})]})]})});function ge(e,t=1){return Math.floor(5*t*e)}function be(e){const t=.2*Math.round(e/.2);return Math.max(0,Math.min(3,t))}function Ne({stats:e,receivedBuckets:a,droppedBuckets:n,forwardedBuckets:i,bucketDurationSeconds:l,timeRangeLabel:r}){var s,c,o,d;const u=b.useMemo(()=>function(e,t,a,n,i){var l,r;const s=(null==t?void 0:t.reduce((e,t)=>e+t.count,0))??0,c=(null==a?void 0:a.reduce((e,t)=>e+t.count,0))??0,o=(null==n?void 0:n.reduce((e,t)=>e+t.count,0))??0,d=s>0?s:(null==e?void 0:e.rx_count)||1,u=c>0?c:(null==e?void 0:e.dropped_count)||0,m=d>0?u/(d+u)*100:0;let h=0;if(n&&n.length>0&&i)h=100*o/(n.length*i*1e3)*100;else if(e){const t=1e3*(e.uptime_seconds||1);h=(e.total_airtime_ms||e.airtime_used_ms||0)/t*100}const p=(null==e?void 0:e.neighbors)||{},v=Object.values(p).filter(e=>!0===e.zero_hop).length;let x=.7;m<3?x-=.2:m>15?x+=.4:m>10&&(x+=.2),h>5&&(x+=.2),v>10&&(x+=.2);const f=be(x),g=be(.28*f),b=ge(f),N=ge(g),y=ge((null==(r=null==(l=null==e?void 0:e.config)?void 0:l.delays)?void 0:r.tx_delay_factor)??.7);let k;return k=b>y?"increase":b<y?"decrease":"stable",{floodDelaySec:f,directDelaySec:g,floodSlots:b,directSlots:N,adjustment:k,duplicateRate:Math.round(100*m)/100,txUtilization:Math.round(1e3*h)/1e3,zeroHopCount:v,totalReceived:s,totalDropped:c}}(e,a,n,i,l),[e,a,n,i,l]),m=(null==(c=null==(s=null==e?void 0:e.config)?void 0:s.delays)?void 0:c.tx_delay_factor)??null,h=(null==(d=null==(o=null==e?void 0:e.config)?void 0:o.delays)?void 0:d.direct_tx_delay_factor)??null,p=null!==m?ge(m):null,v=null!==p&&u.floodSlots!==p,x="increase"===u.adjustment?z:"decrease"===u.adjustment?q:I;return t.jsxs("div",{className:"data-card flex flex-col min-h-[180px]",children:[t.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[t.jsx(ie,{className:"w-4 h-4 text-[var(--metric-transmitted)]"}),t.jsx("span",{className:"data-card-title",children:"TX DELAY FACTOR"}),r&&t.jsx("span",{className:"pill-tag",children:r}),v&&t.jsxs("span",{className:"pill-tag flex items-center gap-1 "+("increase"===u.adjustment?"bg-accent-warning/20 text-accent-warning border-accent-warning/30":"bg-accent-success/20 text-accent-success border-accent-success/30"),children:[t.jsx(x,{className:"w-3 h-3"}),"increase"===u.adjustment?"+":"-",Math.abs(u.floodSlots-(p??0))," slot",1!==Math.abs(u.floodSlots-(p??0))?"s":""]})]}),t.jsxs("div",{className:"flex items-baseline gap-4",children:[t.jsxs("div",{children:[t.jsxs("div",{className:"type-data-lg tabular-nums text-[var(--metric-transmitted)]",children:["×",u.floodDelaySec.toFixed(1)]}),t.jsxs("div",{className:"type-data-xs text-text-muted",children:["flood ",t.jsxs("span",{className:"text-accent-secondary font-semibold",children:["(",u.floodSlots," slots)"]})]})]}),t.jsxs("div",{children:[t.jsxs("div",{className:"type-data-lg tabular-nums text-[var(--metric-forwarded)]",children:["×",u.directDelaySec.toFixed(1)]}),t.jsxs("div",{className:"type-data-xs text-text-muted",children:["direct ",t.jsxs("span",{className:"text-accent-secondary font-semibold",children:["(",u.directSlots," slots)"]})]})]})]}),t.jsxs("div",{className:"flex-1 mt-4 space-y-1.5",children:[t.jsxs("div",{className:"flex justify-between text-xs",children:[t.jsx("span",{className:"text-text-muted",children:"Dup Rate"}),t.jsxs("span",{className:"tabular-nums "+(u.duplicateRate>10?"text-accent-warning":"text-text-secondary"),children:[u.duplicateRate.toFixed(1),"%"]})]}),t.jsxs("div",{className:"flex justify-between text-xs",children:[t.jsx("span",{className:"text-text-muted",children:"TX Util"}),t.jsxs("span",{className:"tabular-nums text-text-secondary",children:[u.txUtilization.toFixed(2),"%"]})]}),t.jsxs("div",{className:"flex justify-between text-xs",children:[t.jsx("span",{className:"text-text-muted",children:"Zero-hop"}),t.jsx("span",{className:"tabular-nums text-text-secondary",children:u.zeroHopCount})]})]}),t.jsx("div",{className:"data-card-secondary border-t border-border-subtle pt-3 mt-2",children:null!==m?t.jsxs("span",{children:["Current: ×",m.toFixed(1)," (",p," slots) / ×",(null==h?void 0:h.toFixed(1))??"—"]}):t.jsx("span",{children:"Recommended factors (MeshCore slot-aligned)"})})]})}function ye({trend:e}){return"stable"===e?t.jsx("span",{className:"mini-widget-trend stable",children:t.jsx("svg",{className:"w-3 h-3",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 12h14"})})}):"up"===e?t.jsx("span",{className:"mini-widget-trend up",children:t.jsx("svg",{className:"w-3 h-3",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 15l7-7 7 7"})})}):t.jsx("span",{className:"mini-widget-trend down",children:t.jsx("svg",{className:"w-3 h-3",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})})}function ke(){return t.jsx("div",{className:"mini-widget-loading",children:t.jsx("div",{className:"mini-widget-loading-spinner"})})}function we({message:e}){return t.jsx("div",{className:"mini-widget-error",children:t.jsx("span",{title:e,children:"No data"})})}function Me({title:e,icon:a,value:n,unit:i,valueSize:l="md",status:r,subtitle:s,trend:c,children:o,isLoading:d=!1,error:u,className:m="",onClick:h}){const p=["mini-widget-value","lg"===l&&"mini-widget-value-lg","sm"===l&&"mini-widget-value-sm",""].filter(Boolean).join(" "),v=["mini-widget glass-card",h&&"cursor-pointer",m].filter(Boolean).join(" ");return t.jsxs("div",{className:v,onClick:h,role:h?"button":void 0,children:[t.jsxs("div",{className:"mini-widget-header",children:[a,t.jsx("span",{className:"mini-widget-title",children:e}),r&&"unknown"!==r&&t.jsx("div",{className:`mini-widget-status-dot ${r}`}),c&&t.jsx(ye,{trend:c})]}),d?t.jsx(ke,{}):u?t.jsx(we,{message:u}):t.jsxs(t.Fragment,{children:[void 0!==n&&t.jsxs("div",{className:p,children:[n,i&&t.jsx("span",{className:"mini-widget-unit",children:i})]}),s&&t.jsx("div",{className:"mini-widget-subtitle",children:s}),o]})]})}b.memo(function({payload:e}){return e&&0!==e.length?t.jsx("div",{className:"flex items-center justify-center gap-6 mt-4 pt-4 border-t border-white/5",children:e.map((e,a)=>t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("span",{className:"w-2 h-2 rounded-full",style:{backgroundColor:e.color}}),t.jsx("span",{className:"type-body-sm text-white/60 capitalize",children:e.value})]},a))}):null});const Ce=b.createContext({lbtStats:null,noiseFloor:null,linkQuality:null,channelHealth:null,trends:null,stats:null,recentPackets:[],quickNeighbors:[],isLoading:!0,error:null,refresh:async()=>{}});function Le(e){if(!e)return[];try{const t=JSON.parse(e);if(Array.isArray(t))return t.map(Number).filter(e=>!isNaN(e))}catch{}return[]}function Be(e,t,a=2,n=!1){if(null===t)return"stable";const i=e-t;return(0!==t?100*Math.abs(i/t):Math.abs(i))<a?"stable":n?i>0?"up":"down":i>0?"down":"up"}function Se({children:e}){const n=c(),i=a(),l=o(),r=null===n,s=b.useMemo(()=>function(e){const t=Math.floor(Date.now()/1e3),a=t-86400,n=e.filter(e=>e.timestamp>=a&&void 0!==e.lbt_attempts&&e.lbt_attempts>0),i=n.length,l=n.filter(e=>(e.lbt_attempts??0)>1).length,r=i>0?l/i*100:0,s=n.filter(e=>(e.lbt_attempts??0)>1),c=s.length>0?s.reduce((e,t)=>e+(t.lbt_attempts??0),0)/s.length:0,o=n.filter(e=>!0===e.lbt_channel_busy||1===e.lbt_channel_busy).length,d=i>0?o/i*100:0,u=[];for(const x of n){const e=Le(x.lbt_backoff_delays_ms);u.push(...e)}const m=u.reduce((e,t)=>e+t,0),h=u.length>0?m/u.length:0,p=u.length>0?Math.max(...u):0,v=[];for(let x=0;x<24;x++){const e=t-3600*(24-x),a=e+3600,i=n.filter(t=>t.timestamp>=e&&t.timestamp<a),l=i.filter(e=>(e.lbt_attempts??0)>1).length,r=i.length>0?l/i.length*100:0;v.push(r)}return{totalPacketsWithLBT:i,packetsWithRetries:l,retryRate:r,avgRetries:c,channelBusyCount:o,channelBusyRate:d,avgBackoffMs:h,maxBackoffMs:p,totalBackoffMs:m,hourlyRetryRates:v,windowHours:24,packetCount:e.length}}(i),[i]),d=(null==n?void 0:n.noise_floor_dbm)??null,u=null==n?void 0:n.neighbors,m=b.useMemo(()=>u??{},[u]),h=b.useMemo(()=>function(e,t){if(0===e.length)return{neighbors:[],networkScore:0,neighborCount:0,bestLink:null,worstLink:null};const a=e.map(e=>{const a=function(e,t){let a=50;void 0!==e&&(a=e>=10?100:e>=5?80:e>=0?60:e>=-5?40:20);let n=50;return void 0!==t&&(n=t>=-70?100:t>=-80?80:t>=-90?60:t>=-100?40:20),Math.round(.6*a+.4*n)}(e.avgSnr??void 0,e.avgRssi??void 0),n=t[e.hash];return{name:(null==n?void 0:n.name)||(null==n?void 0:n.node_name)||e.prefix,hash:e.hash,rssi:e.avgRssi??-100,snr:e.avgSnr??-10,score:a,advertCount:e.count}});a.sort((e,t)=>t.score-e.score);const n=a.length>0?a.reduce((e,t)=>e+t.score,0)/a.length:0;return{neighbors:a,networkScore:Math.round(n),neighborCount:a.length,bestLink:a.length>0?{name:a[0].name,score:a[0].score}:null,worstLink:a.length>0?{name:a[a.length-1].name,score:a[a.length-1].score}:null}}(l,m),[l,m]),p=b.useMemo(()=>function(e,t,a){const n=e?Math.max(0,Math.min(100,100-5*e.retryRate)):50;let i=50;null!==t&&(i=Math.max(0,Math.min(100,(t+120)/30*100)));const l=(null==a?void 0:a.networkScore)??50,r=Math.round(.35*n+.25*i+.4*l);let s;return s=r>=85?"excellent":r>=70?"good":r>=50?"fair":r>=30?"congested":"critical",{score:r,status:s,components:{lbtHealth:Math.round(n),noiseHealth:Math.round(i),linkHealth:Math.round(l)}}}(s,d,h),[s,d,h]),[v,x]=b.useState({noiseFloor:null,networkScore:null,channelHealth:null}),f=b.useRef(0);b.useEffect(()=>{const e=()=>{const e=Date.now();e-f.current>3e4&&(f.current=e,x({noiseFloor:d,networkScore:(null==h?void 0:h.networkScore)??null,channelHealth:(null==p?void 0:p.score)??null}))};e();const t=setInterval(e,5e3);return()=>clearInterval(t)},[d,null==h?void 0:h.networkScore,null==p?void 0:p.score]);const g=b.useMemo(()=>({noiseFloor:{current:d,previous:v.noiseFloor,trend:null!==d?Be(d,v.noiseFloor,2,!0):"stable"},networkScore:{current:(null==h?void 0:h.networkScore)??0,previous:v.networkScore,trend:Be((null==h?void 0:h.networkScore)??0,v.networkScore,3,!1)},channelHealth:{current:(null==p?void 0:p.score)??0,previous:v.channelHealth,trend:Be((null==p?void 0:p.score)??0,v.channelHealth,3,!1)}}),[d,null==h?void 0:h.networkScore,null==p?void 0:p.score,v]),N={lbtStats:s,noiseFloor:d,linkQuality:h,channelHealth:p,trends:g,stats:n,recentPackets:i,quickNeighbors:l,isLoading:r,error:null,refresh:async()=>{}};return t.jsx(Ce.Provider,{value:N,children:e})}function Ae(){const e=b.useContext(Ce);if(void 0===e)throw new Error("useLBTData must be used within an LBTDataProvider");return e}const je={excellent:"var(--signal-excellent)",good:"var(--signal-good)",fair:"var(--signal-fair)",congested:"var(--signal-poor)",critical:"var(--signal-critical)",unknown:"var(--text-muted)"};function Re(){const{lbtStats:e,isLoading:a,error:n}=Ae(),i=d(),l=(null==e?void 0:e.retryRate)??0,r=(null==e?void 0:e.avgBackoffMs)??0,s=e?(c=l)<2?"excellent":c<5?"good":c<10?"fair":c<20?"congested":"critical":"unknown";var c;const o=null==e?void 0:e.hourlyRetryRates,u=b.useMemo(()=>!o||o.length<2?[]:o.map(e=>({value:e})),[o]),m=je[s];return t.jsx(Me,{title:"LBT Retries",icon:t.jsx(te,{className:"mini-widget-icon"}),value:l.toFixed(1),unit:"%",status:s,subtitle:e?`Avg ${Math.round(r)}ms backoff`:void 0,isLoading:a,error:n,onClick:()=>i("/packets"),children:t.jsx("div",{className:"mini-widget-sparkline",children:u.length>0?t.jsx(N,{width:"100%",height:"100%",children:t.jsx(y,{data:u,margin:{top:2,right:2,bottom:2,left:2},children:t.jsx(k,{type:"monotone",dataKey:"value",stroke:m,strokeWidth:1,dot:!1,isAnimationActive:!1})})}):t.jsx("div",{className:"h-full"})})})}function Te(){const{lbtStats:e,isLoading:a,error:n}=Ae(),i=d(),l=(null==e?void 0:e.channelBusyCount)??0,r=(null==e?void 0:e.totalPacketsWithLBT)??0,s=(null==e?void 0:e.channelBusyRate)??0,c=e?(o=s)<.5?"excellent":o<1?"good":o<2?"fair":o<5?"congested":"critical":"unknown";var o;return t.jsx(Me,{title:"Ch. Busy",icon:t.jsx(ee,{className:"mini-widget-icon"}),value:l,status:c,subtitle:e?`${s.toFixed(2)}% of ${r} TX`:void 0,isLoading:a,error:n,onClick:()=>i("/packets")})}function De(e){return null===e?"No reading":e<-115?"Very quiet":e<-105?"Quiet":e<-95?"Moderate":e<-85?"Elevated":"High interference"}function Fe(){const{noiseFloor:e,trends:a,isLoading:n,error:i}=Ae(),l=null===(r=e)||r<-110?"excellent":r<-100?"good":r<-90?"fair":r<-80?"congested":"critical";var r;const s=null==a?void 0:a.noiseFloor.trend;return t.jsx(Me,{title:"Noise Floor",icon:t.jsx(Y,{className:"mini-widget-icon"}),value:null!==e?Math.round(e):"—",unit:null!==e?"dBm":void 0,status:l,trend:s,subtitle:De(e),isLoading:n,error:i})}function He(){const{linkQuality:e,trends:a,isLoading:n,error:i}=Ae(),l=d(),r=(null==e?void 0:e.networkScore)??0,s=(null==e?void 0:e.neighborCount)??0,c=e?(o=r)>=80?"excellent":o>=60?"good":o>=40?"fair":o>=20?"congested":"critical":"unknown";var o;const u=null==a?void 0:a.networkScore.trend;return t.jsx(Me,{title:"Network Score",icon:t.jsx(W,{className:"mini-widget-icon"}),value:Math.round(r),unit:"/100",status:c,trend:u,subtitle:e?`${s} direct neighbor${1!==s?"s":""}`:void 0,isLoading:n,error:i,onClick:()=>l("/contacts")})}function Pe(e,t=8){return e.length<=t?e:e.substring(0,t-1)+"…"}function $e(){const{linkQuality:e,isLoading:a,error:n}=Ae(),i=d(),l=null==e?void 0:e.bestLink,r=null==e?void 0:e.worstLink,s=r?(c=r.score)>=60?"excellent":c>=40?"good":c>=25?"fair":c>=10?"congested":"critical":"unknown";var c;const o=e&&l&&r?t.jsxs("div",{className:"flex flex-col gap-0.5 mt-auto",children:[t.jsxs("div",{className:"flex items-center justify-between text-xs",children:[t.jsx("span",{className:"text-text-muted",children:"Best:"}),t.jsxs("span",{className:"font-mono text-signal-excellent",children:[Pe(l.name)," (",Math.round(l.score),")"]})]}),t.jsxs("div",{className:"flex items-center justify-between text-xs",children:[t.jsx("span",{className:"text-text-muted",children:"Worst:"}),t.jsxs("span",{className:"font-mono "+(r.score>=40?"text-signal-fair":"text-signal-critical"),children:[Pe(r.name)," (",Math.round(r.score),")"]})]})]}):e&&0===e.neighborCount?t.jsx("div",{className:"flex items-center justify-center text-xs text-text-muted mt-auto",children:"No direct neighbors"}):null;return t.jsx(Me,{title:"Link Range",icon:t.jsx(ae,{className:"mini-widget-icon"}),status:s,isLoading:a,error:n,onClick:()=>i("/contacts"),children:o})}function Ee(){const{lbtStats:e,isLoading:a,error:n}=Ae(),i=e?function(e){const{retryRate:t,channelBusyCount:a,totalPacketsWithLBT:n,avgBackoffMs:i,maxBackoffMs:l}=e;if(0===n)return 0;const r=Math.min(n/10,1),s=Math.log(1+.15*t)/Math.log(16)*40,c=a/n*100,o=Math.min(.5*c,25);let d=0;i>100&&(d=Math.min(8*Math.log10(i/100),15));let u=0;l>500&&i>0&&l>2*i&&(u=Math.min((l-500)/200,5));const m=(s+o+d+u)*r;return Math.min(m,85)}(e):0,l=e?(r=i)<5?"excellent":r<15?"good":r<30?"fair":r<50?"congested":"critical":"unknown";var r;const s=(null==e?void 0:e.maxBackoffMs)??0,c=e?s>200?`Max backoff: ${Math.round(s)}ms`:function(e){return e<5?"Clear channel":e<15?"Light traffic":e<30?"Moderate traffic":e<50?"Heavy traffic":e<70?"Congested":"Severe congestion"}(i):void 0;return t.jsx(Me,{title:"Collision Risk",icon:t.jsx(V,{className:"mini-widget-icon"}),value:i.toFixed(1),unit:"%",status:l,subtitle:c,isLoading:a,error:n})}function ze(e){switch(e){case"excellent":return"Excellent";case"good":return"Good";case"fair":return"Fair";case"congested":return"Congested";case"critical":return"Critical";default:return"Unknown"}}function We(){const{channelHealth:e,trends:a,isLoading:n,error:i}=Ae(),l=(null==e?void 0:e.score)??0,r=(null==e?void 0:e.status)??"excellent",s=null==a?void 0:a.channelHealth.trend,c=e?t.jsx("div",{className:"mini-widget-progress mt-auto",children:t.jsx("div",{className:`mini-widget-progress-bar ${r}`,style:{width:`${l}%`}})}):null;return t.jsx(Me,{title:"Channel Health",icon:t.jsx(Z,{className:"mini-widget-icon"}),value:Math.round(l),unit:"/100",status:r,trend:s,subtitle:e?ze(r):void 0,isLoading:n,error:i,children:c})}function qe(){const[e,a]=b.useState(!1),[n]=b.useState(0),{stats:i,lbtStats:l,isLoading:s}=Ae(),c=b.useMemo(()=>{if(!i)return null;const e=i.airtime_used_ms??0,t=i.max_airtime_ms??1;return{usedMs:e,maxMs:t,remainingMs:i.airtime_remaining_ms??0,utilizationPercent:i.utilization_percent??(t>0?e/t*100:0)}},[i]),o=b.useMemo(()=>{if(!l||0===l.totalPacketsWithLBT)return 100;const e=l.channelBusyCount,t=l.totalPacketsWithLBT;return(t-e)/t*100},[l]),d=(null==c?void 0:c.utilizationPercent)??0,u=(m=d)<30?"excellent":m<50?"good":m<70?"fair":m<90?"congested":"critical";var m;const h=(null==c?void 0:c.remainingMs)??0,p=o<99?`${o.toFixed(0)}% TX success`:((v=h)<1e3?`${Math.round(v)}ms`:v<6e4?`${(v/1e3).toFixed(1)}s`:`${(v/6e4).toFixed(1)}m`)+" remaining";var v;const x=c?t.jsx("div",{className:"mini-widget-progress mt-auto",children:t.jsx("div",{className:`mini-widget-progress-bar ${u}`,style:{width:`${Math.min(d,100)}%`}})}):null;return t.jsx(Me,{title:"Duty Cycle",icon:t.jsx(r,{className:"mini-widget-icon"}),value:d.toFixed(1),unit:"%",status:u,subtitle:p,isLoading:s,children:x})}function Ie({className:e=""}){return t.jsx(Se,{children:t.jsxs("div",{className:`mesh-health-container ${e}`,children:[t.jsxs("div",{className:"mesh-health-header",children:[t.jsx(ne,{className:"w-4 h-4 text-accent-primary"}),t.jsx("span",{className:"type-label text-text-muted",children:"MESH HEALTH"})]}),t.jsxs("div",{className:"widget-row",children:[t.jsx(We,{}),t.jsx(Re,{}),t.jsx(Te,{}),t.jsx(Ee,{}),t.jsx(Fe,{}),t.jsx(He,{}),t.jsx($e,{}),t.jsx(qe,{})]})]})})}function Ve(){var e;const a=c(),n=u(),i=m(),[l,s]=b.useState(0),[o,d]=b.useState(null),[y,k]=b.useState(!1),R=A(l,150),T=h[l],D=b.useMemo(()=>function(e,t){if(!e||0===e.length)return[];const a=t>1440;return e.map(e=>{const t=new Date(1e3*e.start);return{time:a?t.toLocaleDateString([],{weekday:"short",hour:"2-digit",minute:"2-digit",hour12:!1}):t.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hour12:!1}),received:e.count}})}(null==o?void 0:o.received,T.minutes),[null==o?void 0:o.received,T.minutes]),F=b.useMemo(()=>{const e=D.length;return e<=12?0:e<=24?2:e<=48?5:e<=72?8:Math.floor(e/7)},[D.length]),H=b.useCallback(async()=>{try{const e=h[R],t=await p(e.minutes,e.buckets);t.success&&t.data&&d(t.data)}catch{}},[R]);b.useEffect(()=>{const e=new AbortController,t=async()=>{await H()};t();const a=setInterval(()=>{t()},v.charts);return()=>{e.abort(),clearInterval(a)}},[H]),b.useEffect(()=>{if(i>0){const e=requestAnimationFrame(()=>k(!0)),t=setTimeout(()=>k(!1),600);return()=>{cancelAnimationFrame(e),clearTimeout(t)}}},[i]);const $=(null==a?void 0:a.uptime_seconds)?x(a.uptime_seconds):"0m",W=(null==a?void 0:a.node_name)||(null==(e=null==a?void 0:a.config)?void 0:e.node_name)||"Unknown Node",q=b.useMemo(()=>{var e,t,a,n;const i=(null==(e=null==o?void 0:o.received)?void 0:e.reduce((e,t)=>e+t.count,0))??0,l=(null==(t=null==o?void 0:o.forwarded)?void 0:t.reduce((e,t)=>e+t.count,0))??0,r=(null==(a=null==o?void 0:o.dropped)?void 0:a.reduce((e,t)=>e+t.count,0))??0,s=(null==(n=null==o?void 0:o.transmitted)?void 0:n.reduce((e,t)=>e+t.count,0))??0,c=((null==o?void 0:o.time_range_minutes)??T.minutes)/60;return{received:i,forwarded:l,dropped:r,transmitted:s,rxPerHour:c>0?Math.round(i/c):0,fwdPerHour:c>0?Math.round(l/c):0}},[o,T.minutes]);return n?t.jsxs(G,{className:"p-8 text-center",children:[t.jsx("p",{className:"type-subheading text-accent-red mb-2",children:"Failed to connect to backend"}),t.jsx("p",{className:"type-body text-white/50",children:n}),t.jsx("p",{className:"type-data-sm text-white/40 mt-4",children:"Make sure the Python backend is running on port 8000"})]}):t.jsxs(K,{children:[t.jsx(O,{title:W,icon:t.jsx(J,{}),controls:t.jsx(j,{ranges:h,selectedIndex:l,onSelect:s})}),t.jsxs(G,{size:"hero",children:[y&&t.jsx("div",{className:"flash-overlay"}),t.jsx(Q,{icon:t.jsx(z,{}),title:"RECEIVED",badge:T.label,iconColor:"text-accent-success"}),t.jsx("div",{className:"type-hero font-semibold",style:{color:f.received},children:q.received.toLocaleString()}),t.jsxs("div",{className:"type-body-sm text-text-muted mt-1",children:[q.rxPerHour,"/hr rate"]}),D.length>0?t.jsx("div",{className:"h-48 mt-4",children:t.jsx(N,{width:"100%",height:"100%",children:t.jsxs(w,{data:D,children:[t.jsx("defs",{children:t.jsxs("linearGradient",{id:"gradient-received",x1:"0",y1:"0",x2:"0",y2:"1",children:[t.jsx("stop",{offset:"5%",stopColor:f.received,stopOpacity:.3}),t.jsx("stop",{offset:"95%",stopColor:f.received,stopOpacity:0})]})}),t.jsx(M,{strokeDasharray:"3 3",stroke:"rgba(255,255,255,0.06)",vertical:!1}),t.jsx(C,{dataKey:"time",axisLine:!1,tickLine:!1,tick:{fill:"rgba(255,255,255,0.4)",fontSize:10,fontFamily:"'JetBrains Mono', monospace"},dy:8,interval:F,minTickGap:20}),t.jsx(L,{axisLine:!1,tickLine:!1,tick:{fill:"rgba(255,255,255,0.4)",fontSize:10,fontFamily:"'JetBrains Mono', monospace"},dx:-8,width:40}),t.jsx(B,{content:t.jsx(fe,{color:f.received,labelKey:"time",unit:" packets"}),cursor:{stroke:"rgba(255,255,255,0.2)",strokeWidth:1}}),t.jsx(S,{type:"stepAfter",dataKey:"received",stroke:f.received,fill:"url(#gradient-received)",strokeWidth:1,dot:!1,activeDot:{r:4,strokeWidth:0,fill:f.received},isAnimationActive:!1})]})})}):t.jsx("div",{className:"h-48 flex items-center justify-center text-text-muted",children:"No data available for this time range"})]}),t.jsx(Ie,{}),t.jsxs(U,{children:[t.jsx(X,{span:6,md:3,children:t.jsx(ve,{title:"FORWARDED",value:q.forwarded,subtitle:`${q.fwdPerHour}/hr rate`,color:"forwarded",buckets:null==o?void 0:o.forwarded,timeRangeLabel:T.label,icon:t.jsx(_,{className:"w-4 h-4"})})}),t.jsx(X,{span:6,md:3,children:t.jsx(ve,{title:"DROPPED",value:q.dropped,subtitle:"Filtered or duplicate",color:"dropped",buckets:null==o?void 0:o.dropped,timeRangeLabel:T.label,icon:t.jsx(P,{className:"w-4 h-4"})})}),t.jsx(X,{span:6,md:3,children:t.jsx(Ne,{stats:a,receivedBuckets:null==o?void 0:o.received,droppedBuckets:null==o?void 0:o.dropped,forwardedBuckets:null==o?void 0:o.forwarded,bucketDurationSeconds:null==o?void 0:o.bucket_duration_seconds,timeRangeLabel:T.label})}),t.jsx(X,{span:6,md:3,children:t.jsx(ve,{title:"UPTIME",value:$,subtitle:"Since last restart",color:"neutral",icon:t.jsx(g,{className:"w-4 h-4"})})})]}),t.jsx(xe,{}),a&&t.jsxs(G,{children:[t.jsx(Q,{icon:t.jsx(r,{}),title:"Node Information",largeTitle:!0}),t.jsxs(U,{children:[t.jsxs(X,{sm:6,lg:3,children:[t.jsx("span",{className:"type-label text-text-muted",children:"Node Name"}),t.jsx("p",{className:"type-body text-text-primary mt-1",children:W})]}),t.jsxs(X,{sm:6,lg:3,children:[t.jsx("span",{className:"type-label text-text-muted",children:"Version"}),t.jsxs("p",{className:"type-data text-text-primary mt-1",children:["v",a.version]})]}),t.jsxs(X,{sm:6,lg:3,children:[t.jsx("span",{className:"type-label text-text-muted",children:"Core Version"}),t.jsxs("p",{className:"type-data text-text-primary mt-1",children:["v",a.core_version]})]}),t.jsxs(X,{sm:6,lg:3,children:[t.jsx("span",{className:"type-label text-text-muted",children:"Local Hash"}),t.jsx("div",{className:"mt-1",children:a.local_hash?t.jsx(E,{hash:a.local_hash,size:"sm"}):t.jsx("span",{className:"type-data-sm text-text-muted",children:"N/A"})})]})]}),a.public_key&&t.jsxs("div",{className:"mt-4 pt-4 border-t border-border-subtle",children:[t.jsx("span",{className:"type-label text-text-muted",children:"Public Key"}),t.jsx("div",{className:"mt-1",children:t.jsx(E,{hash:a.public_key,prefixLength:12,suffixLength:8})})]})]})]})}export{Ve as default};
