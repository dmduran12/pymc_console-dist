var t=Object.defineProperty,e=(e,a,s)=>((e,a,s)=>a in e?t(e,a,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[a]=s)(e,"symbol"!=typeof a?a+"":a,s);import{as as a,cP as s,cQ as r,cR as n,cS as h,aq as i,cT as c,cU as p,cx as o,cv as l,cw as d,cV as u,cW as y,bX as g,cX as f,cY as m,cZ as x,c_ as T,c$ as H,d0 as C,d1 as w,d2 as L,d3 as S,d4 as N,d5 as b,d6 as _,d7 as A,d8 as $,d9 as V,da as F,db as U,dc as D,cE as E,cD as v,dd as P,cH as k,de as M,df as R,dg as j,dh as O,di as B,dj as I,dk as K,dl as q,dm as W,dn as Q,cF as X,cG as G,dp as Y,dq as Z,dr as z,ds as J,dt as tt}from"./index-a2wAGVcz.js";class et{constructor(){e(this,"header",0),e(this,"transportCodes",[0,0]),e(this,"pathLen",0),e(this,"path",new Uint8Array(0)),e(this,"payload",new Uint8Array(0)),e(this,"decrypted",{}),e(this,"_rssi",0),e(this,"_snr",0)}static fromBytes(t){const e=new et;try{return e.readFrom(t),{success:!0,packet:e}}catch(a){return{success:!1,error:a instanceof Error?a.message:String(a)}}}static fromHex(t){try{const e=a(t);return et.fromBytes(e)}catch(e){return{success:!1,error:e instanceof Error?e.message:String(e)}}}get routeType(){return this.header&s}get routeTypeName(){return r[this.routeType]??`UNKNOWN(${this.routeType})`}get payloadType(){return this.header>>n&h}get payloadTypeName(){return i[this.payloadType]??`UNKNOWN(${this.payloadType})`}get payloadVersion(){return this.header>>c&p}hasTransportCodes(){return o(this.routeType)}isFlood(){return l(this.routeType)}isDirect(){return d(this.routeType)}get pathBytes(){return Array.from(this.path)}get pathString(){return u(this.path)}get pathHexArray(){return Array.from(this.path).map(t=>y(t,!0))}get payloadLen(){return this.payload.length}get payloadHex(){return g(this.payload,!0)}getPayloadAppData(){const t=N+b+_;return this.payload.length>=t?this.payload.slice(t):new Uint8Array(0)}get rssi(){return this._rssi}set rssi(t){this._rssi=t}get snr(){return this._snr}set snr(t){this._snr=t}readFrom(t){let e=0;const a=t.length;f(e,1,a,"Missing header byte"),this.header=t[e++];const s=this.payloadVersion;if(s>m)throw new Error(`Unsupported packet version: ${s}`);if(this.hasTransportCodes()?(f(e,4,a,"Missing transport codes"),this.transportCodes=[x(t,e),x(t,e+2)],e+=4):this.transportCodes=[0,0],f(e,1,a,"Missing path_len"),this.pathLen=t[e++],this.pathLen>T)throw new Error(`path_len too large: ${this.pathLen} > ${T}`);return f(e,this.pathLen,a,"Truncated path"),this.path=t.slice(e,e+this.pathLen),e+=this.pathLen,this.payload=t.slice(e),H(this.payload.length),!0}writeTo(){let t=1;this.hasTransportCodes()&&(t+=4),t+=1,t+=this.path.length,t+=this.payload.length;const e=new Uint8Array(t);let a=0;return e[a++]=this.header,this.hasTransportCodes()&&(C(this.transportCodes[0],e,a),C(this.transportCodes[1],e,a+2),a+=4),e[a++]=this.path.length,e.set(this.path,a),a+=this.path.length,e.set(this.payload,a),e}toHex(){return g(this.writeTo(),!0)}async calculateHash(){return w(this.payloadType,this.pathLen,this.payload)}async calculateHashString(t){return L(this.payloadType,this.pathLen,this.payload,t)}async calculateCRC(){return S(this.payloadType,this.pathLen,this.payload)}getRawLength(){let t=2+this.pathLen+this.payload.length;return this.hasTransportCodes()&&(t+=4),t}getSummary(){return{header:y(this.header,!0),routeType:this.routeTypeName,payloadType:this.payloadTypeName,version:this.payloadVersion,pathLen:this.pathLen,pathStr:this.pathString,transportCodes:this.hasTransportCodes()?[this.transportCodes[0].toString(16).toUpperCase().padStart(4,"0"),this.transportCodes[1].toString(16).toUpperCase().padStart(4,"0")]:null,payloadLen:this.payload.length,payloadHex:this.payloadHex,rawLength:this.getRawLength()}}toString(){const t=[`[${this.routeTypeName}/${this.payloadTypeName} v${this.payloadVersion}]`,`path=${this.pathString||"(empty)"}`,`payload=${this.payload.length}B`];return this.hasTransportCodes()&&t.push(`transport=[${this.transportCodes[0]},${this.transportCodes[1]}]`),t.join(" ")}}function at(t){const e=N+b+_+1;if(t.length<e)return null;let a=0;const s=g(t.slice(a,a+N));a+=N;const r=B(t,a);a+=b;const n=g(t.slice(a,a+_));a+=_;const h=t[a++],i=I(h);let c="unknown";switch(h&tt){case J:c="chat";break;case z:c="repeater";break;case Z:c="room_server";break;case Y:c="sensor"}const p={type:"advert",publicKey:s,timestamp:r,signature:n,flags:h,flagsDescription:i,nodeType:c,rawAppData:g(t.slice(N+b+_))};if(h&K&&a+8<=t.length){const e=t.slice(a,a+8),s=new ArrayBuffer(8);new Uint8Array(s).set(e);const r=new DataView(s),n=r.getInt32(0,!0),h=r.getInt32(4,!0);p.latitude=n/1e6,p.longitude=h/1e6,a+=8}if(h&q&&(a+=2),h&W&&(a+=2),h&Q&&a<t.length){let e=a;for(;e<t.length&&0!==t[e];)e++;e>a&&(p.name=(new TextDecoder).decode(t.slice(a,e)))}return p}function st(t,e){const a=function(t){if(t.length<9)return{type:"trace",traceTag:"00000000",traceTagValue:0,authCode:0,flags:0,pathHashes:[],pathString:"",snrValues:[],isComplete:!1,path:[],targetHash:""};const e=B(t,0),a=e.toString(16).toUpperCase().padStart(8,"0"),s=B(t,4),r=t[8],n=t.slice(9),h=Array.from(n).map(t=>y(t,!0)),i=h.join("->");return{type:"trace",traceTag:a,traceTagValue:e,authCode:s,flags:r,pathHashes:h,pathString:i,snrValues:[],isComplete:!1,path:h,targetHash:h.length>0?h[0]:""}}(t);if(!a)return null;const s=[],r=e instanceof Uint8Array?Array.from(e):e;for(let h=0;h<r.length;h++){let t=r[h];t>127&&(t-=256),s.push(t/4)}const n=s.length>=a.pathHashes.length;return{...a,snrValues:s,isComplete:n}}function rt(t,e=0){const a=e>=1?2:1,s=O,r=2*a+s;if(t.length<r)return null;const n=g(t.slice(0,a),!0),h=g(t.slice(a,2*a),!0),i=2*a,c=g(t.slice(i,i+s)),p=t.slice(i+s);let o="",l=!0;try{const t=new TextDecoder("utf-8",{fatal:!0}).decode(p);/^[\x20-\x7E\u00A0-\uFFFF\n\r\t]*$/.test(t)&&(o=t,l=!1)}catch{}return l&&(o=g(p)),{type:"txt_msg",destHash:n,srcHash:h,cipherMac:c,timestamp:0,text:o,ciphertextHex:l?g(p):void 0,encrypted:l}}async function nt(t,e=0){const a=e>=1?4:O,s=1+a+1;if(t.length<s)return null;const r=t[0],n=y(r,!0),h=t.slice(1,1+a),i=t.slice(1+a),c={type:"grp_txt",channelHash:n,text:g(i),decrypted:!1,ciphertextHex:g(i),macHex:g(h)};try{const t=await X(r,h,i);if(t&&t.plaintext.length>=5){c.channelName=t.channelName;const e=t.plaintext,a=B(e,0),s=e[4],r=new TextDecoder("utf-8",{fatal:!1}).decode(e.slice(5)).replace(/\uFFFD/g,"").replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F-\x9F]/g,"").replace(/\x00+$/,"").trim();c.decrypted=!0,c.isPublicHashChannel=!0,c.timestamp=a,c.flags=s,t.macCorrupted&&(c.macCorrupted=!0);const n=r.indexOf(": ");n>0?(c.senderName=r.slice(0,n),c.text=r.slice(n+2)):c.text=r}else{const t=await G(r);c.isPublicHashChannel=t.length>0}}catch{}return c}async function ht(t){if(t.length<1+O+1)return null;const e=t[0],a=y(e,!0),s=t.slice(1,1+O),r=t.slice(1+O),n={type:"grp_data",channelHash:a,dataHex:g(r),dataLength:r.length,decrypted:!1,macHex:g(s)};try{const t=await X(e,s,r);t&&(n.channelName=t.channelName,n.decrypted=!0,n.decryptedHex=g(t.plaintext))}catch{}return n}function it(t,e,a){return{type:"generic",payloadType:e,payloadTypeName:a,rawHex:g(t),length:t.length}}function ct(t){const{payload:e,payloadType:a,payloadTypeName:s}=t;switch(a){case j:return at(e)??it(e,a,s);case R:return function(t){if(t.length<4)return null;const e=B(t,0);return{type:"ack",crc:e.toString(16).toUpperCase().padStart(8,"0"),crcValue:e}}(e)??it(e,a,s);case M:return function(t){if(0===t.length)return{type:"path",pathLength:0,path:[],pathString:""};const e=t[0];if(t.length<1+e+1){const a=Math.min(e,t.length-1),s=Array.from(t.slice(1,1+a)).map(t=>y(t,!0));return{type:"path",pathLength:e,path:s,pathString:s.join("->")}}const a=Array.from(t.slice(1,1+e)).map(t=>y(t,!0)),s=a.join("->"),r=t[1+e],n=i[r]??`UNKNOWN(${r})`;let h;return t.length>1+e+1&&(h=g(t.slice(1+e+1))),{type:"path",pathLength:e,path:a,pathString:s,extraType:r,extraTypeName:n,extraData:h}}(e)??it(e,a,s);case k:return st(e,t.path)??it(e,a,s);case P:return rt(e,t.payloadVersion)??it(e,a,s);case v:return function(t,e=0){const a=e>=1?4:O,s=1+a+1;if(t.length<s)return null;const r=t[0],n=y(r,!0),h=t.slice(1,1+a),i=t.slice(1+a);return{type:"grp_txt",channelHash:n,text:g(i),decrypted:!1,ciphertextHex:g(i),macHex:g(h)}}(e,t.payloadVersion)??it(e,a,s);case E:return function(t){if(t.length<1+O+1)return null;const e=t[0],a=y(e,!0),s=t.slice(1,1+O),r=t.slice(1+O);return{type:"grp_data",channelHash:a,dataHex:g(r),dataLength:r.length,decrypted:!1,macHex:g(s)}}(e)??it(e,a,s);case D:return function(t){return t.length<4?null:{type:"multipart",messageId:g(t.slice(0,2)),partNumber:t[2],totalParts:t[3],partData:g(t.slice(4))}}(e)??it(e,a,s);case U:return function(t){if(t.length<1)return null;const e=t[0],a=e>>4&15,s=15&e,r={8:"DISCOVER_REQ",9:"DISCOVER_RESP"}[a]??`0x${a.toString(16)}`;return{type:"control",controlType:e,subtype:a,subtypeFlags:s,subtypeName:r,dataHex:g(t.slice(1)),dataLength:t.length-1,isInternal:a>=8}}(e)??it(e,a,s);case F:return function(t){if(t.length<4)return null;const e=y(t[0],!0),a=y(t[1],!0),s=g(t.slice(2,4)),r=t.slice(4);return{type:"req",destHash:e,srcHash:a,cipherMac:s,ciphertextHex:g(r),ciphertextLength:r.length}}(e)??it(e,a,s);case V:return function(t){if(t.length<4)return null;const e=y(t[0],!0),a=y(t[1],!0),s=g(t.slice(2,4)),r=t.slice(4);return{type:"response",destHash:e,srcHash:a,cipherMac:s,ciphertextHex:g(r),ciphertextLength:r.length}}(e)??it(e,a,s);case $:return function(t){if(t.length<35)return null;const e=y(t[0],!0),a=g(t.slice(1,33)),s=g(t.slice(33,35)),r=t.slice(35);return{type:"anon_req",destHash:e,senderPublicKey:a,cipherMac:s,ciphertextHex:g(r),ciphertextLength:r.length}}(e)??it(e,a,s);default:return it(e,a,s)}}export{et as P,nt as a,ht as b,ct as c,rt as d,st as e,at as f};
