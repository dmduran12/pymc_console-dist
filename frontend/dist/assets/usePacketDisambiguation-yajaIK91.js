import{r as e,j as n}from"./vendor-react-Co0R0q1H.js";import{c as t,M as s,C as r,m as a,i as o}from"./TimeRangeStepper-juZ3e1TO.js";import{a7 as l,R as i,B as u,H as c}from"./index-DyhSk8IB.js";import{F as d,M as m}from"./monitor-smartphone-SzhGLeZN.js";import{S as p}from"./search-Dscil2Au.js";import{b as h}from"./prefix-disambiguation-CnguQfzq.js";function f(e,n){const t=new Date(1e3*e),s=e=>e.toString().padStart(2,"0"),r=`${s(t.getHours())}:${s(t.getMinutes())}`;return n<=24?r:`${["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][t.getMonth()]} ${t.getDate()} ${r}`}const x=[{type:"repeater",label:"Repeater",icon:i,buttonColor:"primary"},{type:"companion",label:"Companion",icon:m,buttonColor:"indigo"},{type:"room_server",label:"Room",icon:s,buttonColor:"purple"},{type:"unknown",label:"Unknown",icon:r,buttonColor:"zinc"}],b=60,v=.005;function g({min:t,max:s,valueStart:r,valueEnd:a,onChange:o}){const l=e.useRef(null),[i,u]=e.useState(null),c=e.useRef({valueStart:r,valueEnd:a,min:t,max:s});c.current={valueStart:r,valueEnd:a,min:t,max:s};const d=e.useRef({offset:0,width:0}),m=s-t||1,p=m/3600,h=r??t,x=a??s,g=(h-t)/m*100,y=(x-t)/m*100,w=null!==r||null!==a,j=e.useCallback(e=>{const n=l.current.getBoundingClientRect(),t=Math.max(0,Math.min(1,(e-n.left)/n.width)),{min:s,max:r}=c.current;return Math.round(s+t*(r-s||1))},[]),C=e.useCallback((e,n)=>{n.preventDefault(),n.stopPropagation();const t=n.currentTarget;t.setPointerCapture(n.pointerId),u(e);const s=n=>{const t=j(n.clientX),{valueStart:s,valueEnd:r,min:a,max:l}=c.current,i=l-a||1;if("start"===e){const e=Math.min(t,(r??l)-b);o(e<=a+i*v?null:e,r)}else{const e=Math.max(t,(s??a)+b);o(s,e>=l-i*v?null:e)}},r=()=>{u(null),t.removeEventListener("pointermove",s),t.removeEventListener("pointerup",r),t.removeEventListener("pointercancel",r)};t.addEventListener("pointermove",s),t.addEventListener("pointerup",r),t.addEventListener("pointercancel",r)},[j,o]),M=e.useCallback(e=>{e.preventDefault(),e.stopPropagation();const n=e.currentTarget;n.setPointerCapture(e.pointerId),u("range");const t=c.current.valueStart??c.current.min,s=c.current.valueEnd??c.current.max;d.current={offset:j(e.clientX)-t,width:s-t};const r=e=>{const n=j(e.clientX),{min:t,max:s}=c.current,{offset:r,width:a}=d.current;let l=n-r;l=Math.max(t,Math.min(s-a,l));const i=l+a;o(Math.round(l)<=t?null:Math.round(l),Math.round(i)>=s?null:Math.round(i))},a=()=>{u(null),n.removeEventListener("pointermove",r),n.removeEventListener("pointerup",a),n.removeEventListener("pointercancel",a)};n.addEventListener("pointermove",r),n.addEventListener("pointerup",a),n.addEventListener("pointercancel",a)},[j,o]),k=e.useCallback(e=>{const n=j(e.clientX),{valueStart:t,valueEnd:s,min:r,max:a}=c.current,l=a-r||1,i=t??r,u=s??a;if(Math.abs(n-i)<=Math.abs(n-u)){const e=Math.min(n,u-b);o(e<=r+l*v?null:e,s)}else{const e=Math.max(n,i+b);o(t,e>=a-l*v?null:e)}},[j,o]),N=e.useCallback(()=>o(null,null),[o]),S=e.useCallback((e,n)=>{const t="ArrowRight"===n.key||"ArrowUp"===n.key?1:"ArrowLeft"===n.key||"ArrowDown"===n.key?-1:0;if(!t)return;n.preventDefault();const s=(n.shiftKey?.1:.01)*m,{valueStart:r,valueEnd:a,min:l,max:i}=c.current,u=i-l||1;if("start"===e){const e=Math.max(l,Math.min((r??l)+t*s,(a??i)-b));o(e<=l+u*v?null:e,a)}else{const e=Math.min(i,Math.max((a??i)+t*s,(r??l)+b));o(r,e>=i-u*v?null:e)}},[m,o]),E=e=>{const n=i===e;return["absolute top-1/2 -translate-y-1/2 -translate-x-1/2 w-1 h-4 rounded-full","before:content-[''] before:absolute before:-inset-x-3 before:-inset-y-1","touch-none outline-none",n?"cursor-grabbing":"cursor-ew-resize",n?"bg-sys-blue shadow-[0_0_8px_var(--sys-blue)] scale-x-150 z-20":("start"===e?null!==r:null!==a)?"bg-sys-blue shadow-[0_0_4px_var(--sys-blue)] hover:shadow-[0_0_8px_var(--sys-blue)] hover:scale-x-150 z-10":"bg-edge-subtle hover:bg-fg-muted hover:scale-x-150 z-10",n?"":"transition-[transform,box-shadow,background-color] duration-150 ease-out","focus-visible:ring-2 focus-visible:ring-sys-blue/50"].filter(Boolean).join(" ")};return n.jsxs("div",{className:"flex flex-col gap-0.5 min-w-[160px] sm:min-w-[220px]",children:[n.jsxs("div",{className:"flex items-center justify-between type-data-xs text-fg-muted tabular-nums select-none",children:[n.jsx("span",{className:w&&null!==r?"text-sys-blue":"",children:f(h,p)}),n.jsx("span",{className:w&&null!==a?"text-sys-blue":"",children:f(x,p)})]}),n.jsxs("div",{ref:l,className:"relative h-5 select-none",onPointerDown:k,onDoubleClick:N,children:[n.jsx("div",{className:"absolute inset-x-0 top-1/2 -translate-y-1/2 h-1.5 rounded-full bg-white/[0.06] pointer-events-none"}),w?n.jsx("div",{className:["group/band absolute inset-y-0 touch-none","range"===i?"cursor-grabbing":"cursor-grab"].join(" "),style:{left:`${g}%`,right:100-y+"%"},onPointerDown:M,children:n.jsx("div",{className:["absolute inset-x-0 top-1/2 -translate-y-1/2 h-1.5 rounded-full pointer-events-none transition-colors","range"===i?"bg-sys-blue/40":"bg-sys-blue/25 group-hover/band:bg-sys-blue/35"].join(" ")})}):n.jsx("div",{className:"absolute inset-x-0 top-1/2 -translate-y-1/2 h-1.5 rounded-full bg-white/[0.04] pointer-events-none"}),n.jsx("div",{role:"slider",tabIndex:0,"aria-label":"Range start","aria-valuenow":h,className:E("start"),style:{left:`${g}%`},onPointerDown:e=>C("start",e),onKeyDown:e=>S("start",e)}),n.jsx("div",{role:"slider",tabIndex:0,"aria-label":"Range end","aria-valuenow":x,className:E("end"),style:{left:`${y}%`},onPointerDown:e=>C("end",e),onKeyDown:e=>S("end",e)})]})]})}function y({parentStartTs:s,parentEndTs:r,neighbors:a,filter:o,onChange:i}){const[c,m]=e.useState(""),[h,f]=e.useState(!1),b=e.useRef(null);e.useEffect(()=>{function e(e){b.current&&!b.current.contains(e.target)&&f(!1)}if(h)return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[h]);const v=e.useMemo(()=>Object.entries(a).map(([e,n])=>{const s=t(n);return{hash:e,name:n.name??n.node_name??e.slice(0,8),type:s.type,label:s.label}}).sort((e,n)=>e.name.localeCompare(n.name)),[a]),y=e.useMemo(()=>{if(!c)return v;const e=c.toLowerCase();return v.filter(n=>n.name.toLowerCase().includes(e)||n.hash.toLowerCase().includes(e))},[v,c]),w=null!==o.timeStart||null!==o.timeEnd||o.deviceTypes.size>0||o.nodeIds.size>0,j=e.useCallback((e,n)=>{i({...o,timeStart:e,timeEnd:n})},[o,i]),C=e.useCallback(e=>{const n=new Set(o.deviceTypes);n.has(e)?n.delete(e):n.add(e),i({...o,deviceTypes:n})},[o,i]),M=e.useCallback(e=>{const n=new Set(o.nodeIds);n.has(e)?n.delete(e):n.add(e),i({...o,nodeIds:n}),m("")},[o,i]),k=e.useCallback(e=>{const n=new Set(o.nodeIds);n.delete(e),i({...o,nodeIds:n})},[o,i]),N=e.useCallback(()=>{i({timeStart:null,timeEnd:null,deviceTypes:new Set,nodeIds:new Set}),m("")},[i]),S=e.useMemo(()=>{const e=new Map;for(const n of o.nodeIds){const t=a[n];e.set(n,(null==t?void 0:t.name)??(null==t?void 0:t.node_name)??n.slice(0,8))}return e},[o.nodeIds,a]);return n.jsxs("div",{className:"flex flex-col gap-2 card-padding",children:[n.jsxs("div",{className:"flex items-center gap-3",children:[n.jsxs("div",{className:"flex items-center gap-1.5 text-fg-muted shrink-0",children:[n.jsx(d,{className:"w-3.5 h-3.5"}),n.jsx("span",{className:"type-data-xs font-medium",children:"Filter"})]}),n.jsx("div",{className:"flex-1 min-w-0",children:n.jsx(g,{min:s,max:r,valueStart:o.timeStart,valueEnd:o.timeEnd,onChange:j})}),w&&n.jsxs("button",{type:"button",onClick:N,className:"flex items-center gap-1 px-2 py-0.5 rounded-full type-data-xs text-fg-muted hover:text-fg-primary border border-edge-subtle hover:border-fg-muted/40 transition-colors shrink-0",title:"Clear all filters",children:[n.jsx(l,{className:"w-3 h-3"}),n.jsx("span",{className:"hidden sm:inline",children:"Clear"})]})]}),n.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[n.jsx("div",{className:"flex items-center gap-1.5 overflow-x-auto pb-0.5 -mb-0.5 shrink-0",children:x.map(({type:e,label:t,icon:s,buttonColor:r})=>{const a=o.deviceTypes.has(e);return n.jsxs(u,{color:r,outline:!a,onClick:()=>C(e),title:`Filter by ${t}`,children:[n.jsx(s,{"data-slot":"icon"}),n.jsx("span",{className:"hidden sm:inline",children:t})]},e)})}),n.jsx("div",{className:"w-px h-4 bg-edge-subtle shrink-0 hidden md:block"}),n.jsxs("div",{className:"relative flex items-center gap-1.5 flex-1 min-w-[120px] sm:min-w-[180px] px-2 py-1 rounded-md border border-edge-subtle bg-white/[0.03] transition-colors focus-within:border-sys-blue",ref:b,children:[n.jsx(p,{className:"w-3 h-3 text-fg-muted/50 shrink-0"}),n.jsx("input",{type:"text",className:"flex-1 min-w-[60px] type-data-xs py-0.5 bg-transparent text-fg-secondary placeholder:text-fg-muted/40 border-none focus:outline-none",placeholder:"Search nodes...",value:c,onChange:e=>{m(e.target.value),f(!0)},onFocus:()=>f(!0)}),h&&y.length>0&&n.jsx("div",{className:"absolute top-full left-0 right-0 mt-1 z-[200] surface-popover border border-edge-subtle radius-inner max-h-48 overflow-y-auto",children:y.slice(0,20).map(e=>{const t=o.nodeIds.has(e.hash);return n.jsxs("button",{type:"button",onClick:()=>M(e.hash),className:`\n                      w-full flex items-center gap-2 px-2.5 py-1.5 type-data-xs text-left transition-colors\n                      ${t?"bg-sys-indigo/15 text-sys-indigo":"text-fg-secondary hover:bg-subtle-fill"}\n                    `,children:[n.jsx("span",{className:"flex-1 truncate",children:e.name}),n.jsx("span",{className:"text-fg-muted type-data-xs shrink-0",children:e.label})]},e.hash)})})]})]}),o.nodeIds.size>0&&n.jsx("div",{className:"flex flex-wrap items-center gap-1.5",children:Array.from(o.nodeIds).map(e=>n.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-sys-indigo/15 text-sys-indigo type-data-xs border border-sys-indigo/25 transition-colors hover:bg-sys-indigo/25",children:[S.get(e)??e.slice(0,8),n.jsx("button",{type:"button",onClick:()=>k(e),className:"hover:text-fg-primary transition-colors -mr-0.5",children:n.jsx(l,{className:"w-3 h-3"})})]},e))})]})}function w(){return{timeStart:null,timeEnd:null,deviceTypes:new Set,nodeIds:new Set}}function j(e){return e.name||e.node_name||null}function C(e,n,t,s){return{hash:e,type:n,name:t,isRepeater:"repeater"===n,isCompanion:"companion"===n,confident:s}}const M=Object.freeze(C(null,"unknown",null,!1));function k(n,s){const r=e.useMemo(()=>{const e=new Map,n=new Map,r=new Map,a=new Map;for(const[i,u]of Object.entries(s)){const s=t(u).type;e.set(i,s);const o=(i.startsWith("0x")?i.slice(2):i).toLowerCase();n.set(o,i);const l=c(i),d=j(u);let m=r.get(l);m||(m=[],r.set(l,m)),m.push({hash:i,name:d,type:s});const p=a.get(l)||{repeaters:0,others:0};"repeater"===s?p.repeaters++:p.others++,a.set(l,p)}const o=new Set,l=new Set;for(const[t,s]of a)s.repeaters>0&&s.others>0&&o.add(t),(s.repeaters>=2||s.others>=2)&&l.add(t);return{hashToType:e,pubKeyMap:n,prefixIndex:r,crossClassPrefixes:o,sameClassAmbiguous:l}},[s]),l=e.useMemo(()=>{const e=new Map(r.hashToType),t=new Set(Object.keys(s));for(const s of n){if(null==s._advertNodeType)continue;if(!s.src_hash)continue;if(t.has(s.src_hash)||e.has(s.src_hash))continue;const n=a(s._advertNodeType);"unknown"!==n&&e.set(s.src_hash,n)}return e},[n,r.hashToType,s]),i=e.useRef({map:new Map,fingerprint:""}),u=e.useMemo(()=>{const e=`${Object.keys(s).length}:${n.length}:${r.crossClassPrefixes.size}`;if(e===i.current.fingerprint)return i.current.map;const t=h(n,s);return i.current={map:t,fingerprint:e},t},[n,s,r.crossClassPrefixes.size]),d=e.useRef(new Map);return e.useMemo(()=>{d.current=new Map},[r,l,u]),{resolvePacketSource:e.useCallback(e=>{var n,t,s,a;const i=e.src_hash;if(!i)return M;const m=e.type??e.payload_type??-1,p=e._advertSender?`${i}\0${e._advertSender}`:`${i}\0${m}`,h=d.current.get(p);if(h)return h;const f=c(i),{pubKeyMap:x,prefixIndex:b,crossClassPrefixes:v,sameClassAmbiguous:g}=r;let y;if(e._advertSender){const t=x.get(e._advertSender);if(t){const e=l.get(t)??"unknown",s=null==(n=b.get(f))?void 0:n.find(e=>e.hash===t);return y=C(t,e,(null==s?void 0:s.name)??null,!0),d.current.set(p,y),y}}if(v.has(f)){const n=o(e.type??e.payload_type);if("unknown"!==n){const e=null==(t=b.get(f))?void 0:t.find(e=>e.type===n);if(e)return y=C(e.hash,n,e.name,!0),d.current.set(p,y),y}const s=b.get(f),r=u.get(f),a=r?null==s?void 0:s.find(e=>e.hash===r):null==s?void 0:s[0],i=a?l.get(a.hash)??a.type:"unknown";return y=C((null==a?void 0:a.hash)??null,i,(null==a?void 0:a.name)??null,!1),d.current.set(p,y),y}const w=u.get(f);if(w){const e=l.get(w)??"unknown",n=null==(s=b.get(f))?void 0:s.find(e=>e.hash===w);return y=C(w,e,(null==n?void 0:n.name)??null,!0),d.current.set(p,y),y}if(g.has(f)){const e=null==(a=b.get(f))?void 0:a[0];return y=C((null==e?void 0:e.hash)??null,(null==e?void 0:e.type)??"unknown",(null==e?void 0:e.name)??null,!1),d.current.set(p,y),y}const j=b.get(f);if(1===(null==j?void 0:j.length)){const e=j[0];y=C(e.hash,e.type,e.name,!0)}else y=C(null,o(e.type??e.payload_type),null,!1);return d.current.set(p,y),y},[r,l,u]),neighborContext:r}}export{y as A,w as c,k as u};
