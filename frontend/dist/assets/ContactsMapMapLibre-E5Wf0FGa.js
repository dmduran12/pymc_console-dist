import{r as i,j as t,a as No}from"./vendor-react-CHg3w57L.js";import{u as ze,S as We,L as Se,P as ko,M as Eo,b as Mo}from"./maplibre-gl-B21pqYGi.js";import{u as Ws,r as zs,e as Jn,f as Qn,g as Lo}from"./consumer-registry-CWCmZQuW.js";import{L as $t,c as To}from"./link-scoring-BOldcAf5.js";import{G as Ro,dd as Ao,bb as Ce,Z as De,de as En,df as Us,dg as Io,an as _o,at as Do,J as Ks,b as ut,B as he,ap as Xt,Y as Fo,_ as Oo,dh as qs,m as Po,p as Bo,ba as Ho,di as $o,V as Vs,a6 as Xn,a8 as Go,ar as Wo,ca as Ys,dj as zo,dk as Uo,cs as Zs,H as Ct,aF as Ko,dl as qo,dm as Vo,a1 as Js,h as Me,dn as Qs,ag as Yo,db as Zo,ai as Jo,b3 as Qo,r as Xo,dp as ea,cm as ta,dq as en}from"./index-B4woLUMa.js";import{C as na}from"./ConfirmModal-rLO2D5gF.js";import{g as sa,a as ra,b as oa,D as aa}from"./DeepAnalysisModal-Bv12uRie.js";import{c as Fe,a as Xs,p as ia,f as ca}from"./vendor-core-CgllfypI.js";import{j as la,K as ua,bo as da,aX as er,ah as tr,C as nr,W as ma,Y as fa,bp as fn,d as Mn,c as Ln,bq as ha,aS as ga,aL as pa,b7 as xa,b as sr,aG as ya,br as rr,L as Tn,bs as ba,Z as va,bt as Ca,R as or,X as St,aM as Sa,as as Rn,aR as wa,bu as ja,bh as Na,bv as ka,bw as Ea,a as An,a5 as ar,aK as Ma,U as es,bx as La,D as Ta,o as In,an as Ra,T as Aa,aq as Ia,a1 as _a,by as Da}from"./vendor-icons-rRVc_l7g.js";import{m as ke,A as _e,b as Fa}from"./vendor-motion-CXybMqb1.js";import{A as yt,D as ts,u as Ye}from"./useMapViewStore-Dxt0JgN_.js";import{u as ir,a as Oa,B as Pa}from"./BasemapLayer-VM7R8hCP.js";import{l as Ba,c as cr,a as Ha}from"./vendor-geo-D3MPFrqo.js";import{c as $a}from"./node-types-CTinVm-W.js";import{a as lr,b as hn,c as Ga}from"./easing-DOExzd0X.js";import{H as ns,C as ot,N as Wa,a as za}from"./badge-colors-BNUqIXCA.js";import{L as Ua}from"./LightSparkline-Cju8m-oY.js";import{P as Ka}from"./Contacts-BMTf5rv0.js";import{c as ur}from"./geo-utils-BP1zBK9h.js";import"./cosmograph-RBQGoH9-.js";import"./vendor-charts-DuSK2RSZ.js";import"./vendor-fonts-CgDm-k6O.js";import"./ping-C2srVunZ.js";import"./PageLayout-vzO_WRlt.js";import"./listbox-Cj7yU5AR.js";import"./TimeRangeStepper-CHvn0Aaa.js";import"./chat-utils-pV5FH_xH.js";import"./SignalIndicator-C8dAI7pL.js";import"./CollisionExplorerModal-CSqahLo8.js";import"./DataBox-CbYpEKKd.js";function qa(e,n){return n.filter(r=>r.nodes.includes(e)).sort((r,o)=>o.avgCertainCount-r.avgCertainCount)}function Va(e,n,s){const r=qa(e,n),o=new Set,a=[];for(const c of r)for(const f of c.edgeKeys)if(!o.has(f)){o.add(f);const u=s.get(f);a.push({key:f,certainCount:(u==null?void 0:u.certainCount)??0})}return a.sort((c,f)=>f.certainCount-c.certainCount),{loops:r,highlightedEdgeKeys:o,sortedEdges:a}}function Ya(e){const n=new Map;for(const s of e)for(const r of s.edgeKeys){const o=n.get(r)??[];o.push(s),n.set(r,o)}return n}const Mt={MAX_THICKNESS_AT:300,MIN_VALIDATIONS:5},Za=6,ss=1;function gn(e,n){const s=Math.max(Mt.MIN_VALIDATIONS,Math.min(e,Mt.MAX_THICKNESS_AT)),r=Math.log(Mt.MIN_VALIDATIONS),o=Math.log(Mt.MAX_THICKNESS_AT),c=(Math.log(s)-r)/(o-r);return ss+(Za-ss)*c}function pn(){const e=Ro();return i.useMemo(()=>Ao.getPackets(),[e])}const dr=16,xn=24,Ie=dr,Ja=5,tt={textPrimary:De[900],textSecondary:"#4A4A4A",textMuted:De[500],border:"rgba(0, 0, 0, 0.12)",hoverBg:"rgba(0, 0, 0, 0.06)",disabledText:"rgba(0, 0, 0, 0.25)"},Xe={nodeFill:Ce.blue,nodeStroke:"rgba(255,255,255,0.9)",nodeColor:Ce.indigo,localColor:Ce.amber,hubColor:Ce.purple,gatewayColor:Ce.indigo,mobileColor:Ce.orange,roomServerColor:Ce.pink,neighborColor:Ce.amber,edges:{rest:De[700],restBright:De[600],restDim:De[800],hoverDirect:"#6FBCBD",hoverLoop:"#8B7BAD",hoverStandard:De[400],hoverNeighbor:Ce.amber,neighborRest:De[500],neighborHover:Ce.amber,highlight:"#FFD700"},edgeOpacity:.82};function _n(){if(typeof window>"u")return Xe;const e=En(),n=Us();return{nodeFill:e.nodeFill,nodeStroke:e.nodeStroke,nodeColor:Xe.nodeColor,localColor:e.localColor,hubColor:e.hubColor,gatewayColor:e.gatewayColor,mobileColor:e.mobileColor,roomServerColor:e.roomColor,neighborColor:e.neighborColor,edges:{rest:n.rest,restBright:n.restBright,restDim:n.restDim,hoverDirect:n.hoverDirect,hoverLoop:n.hoverLoop,hoverStandard:n.hoverStandard,hoverNeighbor:n.hoverNeighbor,neighborRest:Xe.edges.neighborRest,neighborHover:Xe.edges.neighborHover,highlight:n.highlight},edgeOpacity:Xe.edgeOpacity}}const Lt=2e3,Tt=750,Qa="#00FF00",Xa=500,rs=500,os=250,ei=150,mr=200,ti=ut.snappy,Le=tt,fr=i.createContext("dark"),Ut=()=>i.useContext(fr);function at({color:e,ring:n}){const s=Ie-2;return t.jsx("span",{className:"shrink-0 rounded-full","aria-hidden":"true",style:{width:s,height:s,backgroundColor:n?"transparent":e,border:n?`${Ja-1}px solid ${e}`:void 0,boxSizing:"border-box"}})}function tn({color:e,pattern:n="solid"}){return t.jsx("svg",{className:"shrink-0","aria-hidden":"true",width:18,height:6,viewBox:"0 0 18 6",children:t.jsx("line",{x1:0,y1:3,x2:18,y2:3,stroke:e,strokeWidth:3,strokeLinecap:"round",strokeDasharray:n==="dashed"?"5,3":n==="dotted"?"2,3":void 0})})}function ve({indicator:e,label:n,tooltip:s}){const r=Ut()==="light";return t.jsxs("div",{className:"flex items-center gap-1.5",children:[e,t.jsx("span",{className:Fe(!r&&"text-fg-secondary"),style:r?{color:Le.textSecondary}:void 0,children:n}),s&&t.jsx(Ks,{content:s,delay:mr,children:t.jsx("span",{className:Fe("cursor-help text-[11px] opacity-75 hover:opacity-100 transition-opacity",!r&&"text-fg-muted"),style:r?{color:Le.textMuted}:void 0,children:"ⓘ"})})]})}function ni(e){return`legend-section-${e.toLowerCase().replace(/\s+/g,"-")}`}function nn({title:e,tooltip:n,isOpen:s,onToggle:r,showDivider:o,children:a}){const c=Ut()==="light",f=ni(e);return t.jsxs("div",{className:o?"mt-2 pt-2 border-t":"",style:o?{borderColor:c?Le.border:"var(--map-ui-border)"}:void 0,children:[t.jsxs("button",{type:"button",onClick:r,"aria-expanded":s,"aria-controls":f,className:Fe("group w-full flex items-center justify-between py-1 min-h-[44px] sm:min-h-0 font-medium transition-colors",!c&&"text-fg-secondary hover:text-fg-primary"),style:c?{color:Le.textSecondary}:void 0,children:[t.jsxs("span",{className:"flex items-center gap-1",children:[e,t.jsx(Ks,{content:n,delay:mr,children:t.jsx("span",{className:Fe("cursor-help text-[11px] opacity-75 group-hover:opacity-100 transition-opacity",!c&&"text-fg-muted"),style:c?{color:Le.textMuted}:void 0,children:"ⓘ"})})]}),t.jsx(ke.span,{animate:{rotate:s?0:-90},transition:{duration:.15},"aria-hidden":"true",children:t.jsx(nr,{className:"w-3 h-3",style:c?{color:Le.textMuted}:{color:"var(--fg-muted)"}})})]}),t.jsx(_e,{initial:!1,children:s&&t.jsx(ke.div,{id:f,role:"region","aria-label":e,initial:{height:0,opacity:0},animate:{height:"auto",opacity:1},exit:{height:0,opacity:0},transition:ti,className:"overflow-hidden",children:t.jsx("div",{className:"flex flex-col gap-1 pt-1.5",children:a})})})]})}function as({label:e,value:n,color:s}){const r=Ut()==="light";return t.jsxs("div",{className:Fe("flex justify-between tabular-nums",!r&&"text-fg-muted"),style:r?{color:Le.textMuted}:void 0,children:[t.jsx("span",{children:e}),t.jsx("span",{style:s?{color:s}:r?{color:Le.textSecondary}:{color:"var(--fg-secondary)"},children:n})]})}function is({icon:e,color:n,title:s,subtitle:r}){const o=Ut()==="light";return t.jsx("div",{className:"mt-1.5 pt-1.5 border-t",style:{borderColor:o?Le.border:"var(--map-ui-border)"},children:t.jsxs("div",{className:"flex items-center gap-1.5",children:[t.jsx("span",{className:"shrink-0",style:{color:n},children:e}),t.jsxs("div",{className:"flex flex-col min-w-0",children:[t.jsx("span",{className:"font-medium truncate",style:{color:n},children:s}),t.jsx("span",{className:Fe("text-[10px] leading-tight",!o&&"text-fg-muted"),style:o?{color:Le.textMuted}:void 0,children:r})]})]})})}function si(e){return e.some(([,n])=>{var r;const s=(r=n.contact_type)==null?void 0:r.toLowerCase();return s==="room server"||s==="room_server"||s==="room"||s==="server"})}function ri(e){let n=0;for(const s of e.txDelayRecommendations.values())s.networkRole==="backbone"&&n++;return n}function oi({showTopology:e,validatedPolylineCount:n,filteredNeighborCount:s,hasLocalNode:r,meshTopology:o,zeroHopNeighbors:a,neighborsWithLocation:c,basemapMode:f="dark"}){const u=Io(),l=_o(),m=Do(),h=l.filter(E=>E.isLikelyReal).length,g=ri(o),p=a.size>0,[x,k]=i.useState(!0),[b,w]=i.useState(!0),[T,L]=i.useState(!0);return t.jsx(fr.Provider,{value:f,children:t.jsxs("div",{className:"map-control-surface p-2.5 text-xs",children:[t.jsxs(nn,{title:"Nodes",tooltip:"Node type shown by shape + color. Yellow = direct RF neighbor.",isOpen:x,onToggle:()=>k(E=>!E),children:[t.jsx(ve,{indicator:t.jsx(at,{color:u.nodeFill}),label:"Node",tooltip:"Standard mesh node. Repeater, client, or companion device."}),t.jsx(ve,{indicator:t.jsx(at,{color:u.hubColor}),label:"Hub",tooltip:"Network hub (≥10% of last-hop traffic)."}),si(c)&&t.jsx(ve,{indicator:t.jsx(la,{className:"w-3 h-3 shrink-0",style:{color:u.roomColor},strokeWidth:2.5}),label:"Room",tooltip:"Room Server identity for client sync."}),t.jsx(ve,{indicator:t.jsx(ua,{className:"w-3 h-3 shrink-0",style:{color:u.localColor},strokeWidth:2.5}),label:"Local",tooltip:"Your repeater running pyMC_Repeater."}),p&&t.jsx(ve,{indicator:t.jsx(at,{color:u.neighborColor}),label:"Neighbor",tooltip:"Zero-hop direct RF contact."}),o.gatewayNodes.length>0&&t.jsx(ve,{indicator:t.jsx(at,{color:u.gatewayColor}),label:"Gateway",tooltip:"Significant forwarder (7-10% traffic)."}),g>0&&t.jsx(ve,{indicator:t.jsx(at,{color:u.hubColor}),label:"Backbone",tooltip:"Critical relay with high centrality."}),o.mobileNodes.length>0&&t.jsx(ve,{indicator:t.jsx(at,{color:u.mobileColor,ring:!0}),label:"Mobile",tooltip:"Volatile node that appears/disappears."}),h>0&&t.jsx(ve,{indicator:t.jsx(da,{className:"w-3 h-3 shrink-0",style:{color:u.ghostColor},strokeWidth:2.5}),label:`Ghost (${h})`,tooltip:"Unknown repeater from Viterbi analysis."})]}),p&&t.jsxs(nn,{title:"Link Quality",tooltip:"Neighbor edge colors based on bidirectional balance.",isOpen:b,onToggle:()=>w(E=>!E),showDivider:!0,children:[t.jsx(ve,{indicator:t.jsx(tn,{color:$t.YELLOW,pattern:"solid"}),label:"2-Way",tooltip:"33-67% balanced. Ideal bidirectional link."}),t.jsx(ve,{indicator:t.jsx(tn,{color:$t.GREEN,pattern:"dashed"}),label:"Listener",tooltip:">67% listener. They hear us well."}),t.jsx(ve,{indicator:t.jsx(tn,{color:$t.RED,pattern:"dotted"}),label:"Loud",tooltip:"<33% listener. They route more to us."})]}),e&&n>0&&t.jsxs(nn,{title:"Topology",tooltip:"Links with 5+ validations. Thickness = strength.",isOpen:T,onToggle:()=>L(E=>!E),showDivider:!0,children:[t.jsx(as,{label:"Nodes",value:s+(r?1:0)}),o.hubNodes.length>0&&t.jsx(as,{label:"Hubs",value:o.hubNodes.length,color:Xe.hubColor}),o.loops.length>0&&t.jsx(is,{icon:t.jsx(er,{className:"w-3 h-3"}),color:Xe.edges.hoverLoop,title:`${o.loops.length} ${o.loops.length===1?"Loop":"Loops"}`,subtitle:"Redundant paths"}),m.totalPaths>0&&t.jsx(is,{icon:t.jsx(tr,{className:"w-3 h-3"}),color:u.ghostColor,title:`${m.totalPaths.toLocaleString()} Viterbi`,subtitle:"HMM decoded paths"})]})]})})}const cs={repeater:"blue",companion:"cyan",room_server:"pink",hubs:"indigo",direct:"green"},Rt={repeater:"Repeaters",companion:"Companions",room_server:"Rooms",hubs:"Hubs",direct:"Direct"},ls={repeater:"Repeater nodes (mesh relays)",companion:"Companion devices (clients)",room_server:"Room server nodes",hubs:"Hub nodes and their connections",direct:"Zero-hop (direct RF) neighbors"},ai=["repeater","companion","room_server"],us=["hubs","direct"],it="!p-2.5 sm:!p-1.5 !rounded-md min-w-[44px] min-h-[44px] sm:min-w-0 sm:min-h-0 shrink-0 flex items-center justify-center",At="!p-2.5 sm:!p-1.5 !rounded-none min-w-[44px] min-h-[44px] sm:min-w-0 sm:min-h-0 shrink-0 flex items-center justify-center",ii=()=>typeof window>"u"?!1:window.innerWidth<640;function ci({mapRef:e,showNeighborLines:n,onToggleNeighborLines:s,hasNeighborPolylines:r,nodeFilters:o,onToggleFilter:a,onToggleAll:c,filterCounts:f,showCoverage:u,onToggleCoverage:l,showMinCut:m=!1,onToggleMinCut:h,hasMinCutData:g=!1,show3DTerrain:p,onToggle3DTerrain:x,basemapMode:k,onToggleBasemap:b,isFullscreen:w,onToggleFullscreen:T,showLinkQuality:L=!1,onToggleLinkQuality:E,hasTraceLinks:A=!1}){const[M,I]=i.useState(()=>!ii()),O=()=>{var P,z;(z=(P=e.current)==null?void 0:P.getMap())==null||z.zoomIn()},_=()=>{var P,z;(z=(P=e.current)==null?void 0:P.getMap())==null||z.zoomOut()},B=()=>{var z;const P=(z=e.current)==null?void 0:z.getMap();P&&P.easeTo({bearing:0,pitch:0,duration:300})},j="w-4 h-4",$=k==="light"?"#525252":"var(--fg-secondary)",H=o.length>=yt.length;return t.jsx(t.Fragment,{children:t.jsxs("div",{className:"absolute top-3 right-3 z-[600] flex flex-col gap-2 sm:top-4 sm:right-4 max-w-[calc(100vw-1.5rem)] sm:max-w-none pr-[env(safe-area-inset-right)]",children:[t.jsxs("div",{className:"map-control-surface flex flex-nowrap items-center gap-0.5 sm:gap-1 p-1 overflow-hidden",children:[r&&t.jsx(he,{plain:!0,color:n?"warning":"muted",onClick:s,title:n?"Hide edge lines":"Show edge lines","aria-label":n?"Hide edge lines":"Show edge lines","aria-pressed":n,className:it,"data-tint":n?"warning":void 0,children:t.jsx(ma,{className:j})}),t.jsx(he,{plain:!0,color:"muted",onClick:()=>I(P=>!P),title:M?"Hide node filters":"Show node filters","aria-label":M?"Collapse node filters":"Expand node filters","aria-expanded":M,className:it,children:t.jsx(fa,{className:j})}),t.jsx(_e,{initial:!1,children:M&&t.jsxs(ke.div,{className:"flex items-center gap-0.5 flex-nowrap overflow-x-auto scrollbar-none max-w-[50vw] sm:max-w-none sm:overflow-visible",role:"group","aria-label":"Node type filters",initial:{width:0,opacity:0},animate:{width:"auto",opacity:1},exit:{width:0,opacity:0},transition:{duration:.2,ease:[.4,0,.2,1]},children:[t.jsx(Xt,{color:H?"green":"zinc",customColor:H?void 0:$,onClick:c,title:"Show all nodes","aria-pressed":H,"aria-label":"Show all node types",className:"shrink-0",children:"All"}),ai.map(P=>{const z=f[P];if(z===0)return null;const y=!H&&o.includes(P);return t.jsx(Xt,{color:y?cs[P]:"zinc",customColor:y?void 0:$,onClick:()=>a(P),title:ls[P],"aria-pressed":y,"aria-label":`${Rt[P]} (${z})`,className:"shrink-0",children:Rt[P]},P)}),us.some(P=>f[P]>0)&&t.jsx("span",{className:"mx-0.5 h-3 w-px bg-[var(--map-ui-border,var(--edge-subtle))] hidden sm:block shrink-0","aria-hidden":"true"}),us.map(P=>{const z=f[P];if(z===0)return null;const y=!H&&o.includes(P);return t.jsx(Xt,{color:y?cs[P]:"zinc",customColor:y?void 0:$,onClick:()=>a(P),title:ls[P],"aria-pressed":y,"aria-label":`${Rt[P]} (${z})`,className:"shrink-0",children:Rt[P]},P)})]})}),g&&h&&t.jsx(he,{plain:!0,color:m?"primary":"muted",onClick:h,title:m?"Hide community partition":"Show community partition","aria-label":m?"Hide community partition":"Show community partition","aria-pressed":m,className:it,"data-tint":m?"primary":void 0,children:t.jsx(fn,{className:j})}),t.jsx(he,{plain:!0,color:k==="light"?"primary":"muted",onClick:b,title:k==="light"?"Switch to dark map":"Switch to light map","aria-label":k==="light"?"Switch to dark map":"Switch to light map","aria-pressed":k==="light",className:it,"data-tint":k==="light"?"primary":void 0,children:k==="light"?t.jsx(Mn,{className:j}):t.jsx(Ln,{className:j})}),t.jsx(he,{plain:!0,color:p?"success":"muted",onClick:x,title:p?"Disable 3D terrain":"Enable 3D terrain","aria-label":p?"Disable 3D terrain":"Enable 3D terrain","aria-pressed":p,className:it,"data-tint":p?"success":void 0,children:t.jsx(ha,{className:j})}),t.jsx(he,{plain:!0,color:"muted",onClick:T,title:w?"Exit fullscreen":"Fullscreen","aria-label":w?"Exit fullscreen":"Enter fullscreen","aria-pressed":w,className:it,children:w?t.jsx(ga,{className:j}):t.jsx(pa,{className:j})})]}),t.jsxs("div",{className:"map-control-surface flex flex-col items-stretch !overflow-hidden self-end !p-0",children:[t.jsx(he,{plain:!0,color:"muted",onClick:O,title:"Zoom in","aria-label":"Zoom in",className:At,children:t.jsx(xa,{className:j})}),t.jsx("div",{className:"h-px bg-border-subtle","aria-hidden":"true"}),t.jsx(he,{plain:!0,color:"muted",onClick:_,title:"Zoom out","aria-label":"Zoom out",className:At,children:t.jsx(sr,{className:j})}),t.jsx("div",{className:"h-px bg-border-subtle","aria-hidden":"true"}),t.jsx(he,{plain:!0,color:"muted",onClick:B,title:"Reset bearing to north","aria-label":"Reset bearing to north",className:At,children:t.jsx(ya,{className:j})})]}),A&&E&&t.jsx("div",{className:"map-control-surface flex flex-col items-stretch !overflow-hidden self-end !p-0",children:t.jsx(he,{plain:!0,color:L?"success":"muted",onClick:E,title:L?"Hide link quality overlay":"Show link quality overlay","aria-label":L?"Hide link quality overlay":"Show link quality overlay","aria-pressed":L,className:At,"data-tint":L?"success":void 0,children:t.jsx(rr,{className:j})})})]})})}const li="#4ADE80",ui="#16A34A",di="rgba(10, 26, 10, 1)",mi="rgba(220, 252, 231, 1)",sn={text:tt.textSecondary,activeText:ui,activeBg:mi},fi={activeBg:di},Ze="DeepAnalysis",hi=700,ds="abcdefghijklmnopqrstuvwxyz0123456789";function gi(){return ds[Math.floor(Math.random()*ds.length)]}function pi({isActive:e,hasAnalyzed:n,isLoading:s,onClick:r,basemapMode:o="dark"}){const a=o==="light",c=a?sn.text:void 0,f=a?sn.activeText:li,[u,l]=i.useState(!1),[m,h]=i.useState(Ze),g=i.useRef(!1),p=i.useRef(null),[x]=i.useState(()=>{var T;return typeof window<"u"&&(((T=window.matchMedia)==null?void 0:T.call(window,"(hover: hover)").matches)??!1)}),k=u&&!e&&!s&&x;i.useEffect(()=>{if(u&&!e&&!s&&!g.current){g.current=!0;const T=performance.now(),L=E=>{const A=E-T,M=Math.min(A/hi,1),I=Math.floor(M*Ze.length);let O="";for(let _=0;_<Ze.length;_++)_<I?O+=Ze[_]:Ze[_]===" "?O+=" ":O+=gi();h(O),M<1?p.current=requestAnimationFrame(L):h(Ze)};p.current=requestAnimationFrame(L)}return u||(p.current&&(cancelAnimationFrame(p.current),p.current=null),g.current=!1,h(Ze)),()=>{p.current&&cancelAnimationFrame(p.current)}},[u,e,s]);const b=s?"Analyzing...":m,w=s?"Analyzing packet history":n?e?"Hide topology edges":"Show topology edges":"Load full packet history and build topology";return t.jsxs("button",{onClick:r,onMouseEnter:()=>x&&l(!0),onMouseLeave:()=>x&&l(!1),onPointerEnter:()=>x&&l(!0),onPointerLeave:()=>x&&l(!1),disabled:s,className:`map-tool-btn flex items-center gap-2 w-full text-left radius-inner transition-base ${s?"cursor-wait":""}`,style:{padding:"0.5rem 0.625rem",...e&&{backgroundColor:a?sn.activeBg:fi.activeBg}},title:w,"aria-label":w,"aria-pressed":e,children:[s?t.jsx(Tn,{className:"w-3.5 h-3.5 shrink-0 animate-spin",style:{color:f}}):t.jsx(ba,{className:`w-3.5 h-3.5 shrink-0 transition-colors ${e?"":"text-fg-secondary"}`,style:{...e&&{color:f},...k&&{color:f},...!e&&!k&&c&&{color:c}}}),t.jsx("span",{className:`${e?"":"text-fg-secondary"}`,"aria-hidden":"true",style:{fontFamily:"ui-monospace, SFMono-Regular, monospace",fontSize:"0.6875rem",fontWeight:e||k?700:500,letterSpacing:"-0.01em",lineHeight:1,...e&&{color:f},...k&&{color:f},...!e&&!k&&c&&{color:c}},children:b})]})}const xi=Ce.teal,yi="#0D7377",bi="rgba(10, 36, 32, 1)",vi="rgba(204, 251, 241, 1)",rn={text:tt.textSecondary,activeTeal:yi,activeBg:vi},Ci={activeBg:bi},ms="LiveTrace",Si=400,fs=100;function wi({isActive:e,onClick:n,basemapMode:s="dark"}){const r=s==="light",o=r?rn.text:void 0,a=r?rn.activeTeal:xi,[c,f]=i.useState(!1),[u,l]=i.useState(0),m=i.useRef(!1),h=i.useRef(null),[g,p]=i.useState(0),x=i.useRef(!1),[k]=i.useState(()=>{var L;return typeof window<"u"&&(((L=window.matchMedia)==null?void 0:L.call(window,"(hover: hover)").matches)??!1)}),b=c&&!e&&k;i.useEffect(()=>{b&&!x.current&&(x.current=!0,p(1),setTimeout(()=>p(2),fs),setTimeout(()=>p(3),fs*2)),c||(x.current=!1,p(0))},[b,c]),i.useEffect(()=>{if(c&&!e&&!m.current){m.current=!0;const L=performance.now(),E=A=>{const M=A-L,I=Math.min(M/Si,1);l(I),I<1&&(h.current=requestAnimationFrame(E))};h.current=requestAnimationFrame(E)}return c||(h.current&&(cancelAnimationFrame(h.current),h.current=null),m.current=!1,l(0)),()=>{h.current&&cancelAnimationFrame(h.current)}},[c,e]);const w=L=>{if(e)return a;if(!b)return o;const E=ms.length,A=u*(E+2);return L>=A-2&&L<A?"#FFFFFF":a},T=e?"Disable live packet tracing":"Enable live packet tracing";return t.jsxs("button",{onClick:n,onMouseEnter:()=>k&&f(!0),onMouseLeave:()=>k&&f(!1),onPointerEnter:()=>k&&f(!0),onPointerLeave:()=>k&&f(!1),className:"map-tool-btn flex items-center gap-2 w-full text-left radius-inner transition-base",style:{padding:"0.5rem 0.625rem",...e&&{backgroundColor:r?rn.activeBg:Ci.activeBg}},title:e?"Disable live packet tracing (reduces CPU usage)":"Enable live packet tracing","aria-label":T,"aria-pressed":e,children:[t.jsx(va,{className:`w-3.5 h-3.5 shrink-0 ${e?"":"text-fg-secondary"}`,fill:g===1?"#FFFFFF":g===3?a:"none",stroke:g===1||g===2?"#FFFFFF":e||b?a:o||"currentColor",style:{transition:"fill 0.05s, stroke 0.05s"}}),t.jsx("span",{className:`${e?"":"text-fg-secondary"}`,"aria-hidden":"true",style:{fontFamily:"ui-monospace, SFMono-Regular, monospace",fontSize:"0.6875rem",fontWeight:e||b?700:500,letterSpacing:"-0.01em",lineHeight:1},children:ms.split("").map((L,E)=>t.jsx("span",{style:{color:w(E)||void 0},children:L},E))})]})}const hs=.2,ji="rgba(26, 20, 8, 1)",Ni="rgba(254, 243, 199, 1)",It={text:tt.textSecondary,activeBg:Ni,disabledText:tt.disabledText},ki={activeBg:ji},on=.01,an=1,gs="#fe8019",Ei="'Wardrive', serif",yn=1.45,Mi=yn*1.1,Li=80;function Ti({isActive:e,onClick:n,brightness:s=.7,onBrightnessChange:r,basemapMode:o="dark"}){const a=o==="light",c=a?It.text:void 0,[f,u]=i.useState(!1),[l,m]=i.useState(!1),[h]=i.useState(()=>{var L;return typeof window<"u"&&(((L=window.matchMedia)==null?void 0:L.call(window,"(hover: hover)").matches)??!1)});i.useEffect(()=>{if(!f||e)return;const L=requestAnimationFrame(()=>m(!0)),E=setTimeout(()=>m(!1),Li);return()=>{cancelAnimationFrame(L),clearTimeout(E)}},[f,e]);const g=Math.max(on,Math.min(an,s)),p=L=>{L.stopPropagation();const E=Math.min(an,g+hs);r==null||r(E)},x=L=>{L.stopPropagation();const E=Math.max(on,g-hs);r==null||r(E)},k=g<an-.001,b=g>on+.001,w=f&&!e&&h,T=e?"Configure wardriving coverage":"Show wardriving coverage";return t.jsxs("button",{onClick:n,onMouseEnter:()=>h&&u(!0),onMouseLeave:()=>h&&u(!1),onPointerEnter:()=>h&&u(!0),onPointerLeave:()=>h&&u(!1),className:"map-tool-btn flex items-center gap-2 w-full text-left radius-inner transition-base",style:{padding:"0.5rem 0.625rem",...e&&{backgroundColor:a?It.activeBg:ki.activeBg}},title:T,"aria-label":T,"aria-pressed":e,children:[t.jsx(Ca,{className:`w-3.5 h-3.5 shrink-0 transition-colors ${e?"text-sys-amber":"text-fg-secondary"}`,style:w?{color:gs}:!e&&c?{color:c}:void 0}),t.jsx("span",{className:`${e?"text-sys-amber":"text-fg-secondary"}`,"aria-hidden":"true",style:{fontFamily:e||w?Ei:"ui-monospace, SFMono-Regular, monospace",fontSize:e||w?"0.75rem":"0.6875rem",fontWeight:500,letterSpacing:"-0.01em",lineHeight:1,transition:"none",transform:e?`scale(${yn})`:w?`scale(${l?Mi:yn})`:void 0,transformOrigin:"left center",...w?{color:gs}:!e&&c?{color:c}:{}},children:"Wardrive"}),e&&r&&t.jsxs("div",{className:"ml-auto flex items-center gap-0.5",children:[t.jsx("button",{onClick:x,disabled:!b,className:`p-1 sm:p-0.5 min-w-[44px] min-h-[44px] sm:min-w-0 sm:min-h-0 flex items-center justify-center rounded transition-colors ${b?"text-sys-amber hover:bg-[var(--map-ui-hover,var(--elevated))] active:bg-[var(--map-ui-active,var(--subtle))]":"cursor-not-allowed"}`,style:b?void 0:{color:a?It.disabledText:"rgba(251, 191, 36, 0.3)"},title:`Decrease opacity (${Math.round(g*100)}%)`,"aria-label":`Decrease opacity, currently ${Math.round(g*100)}%`,children:t.jsx(Mn,{className:"w-3.5 h-3.5"})}),t.jsx("button",{onClick:p,disabled:!k,className:`p-1 sm:p-0.5 min-w-[44px] min-h-[44px] sm:min-w-0 sm:min-h-0 flex items-center justify-center rounded transition-colors ${k?"text-sys-amber hover:bg-[var(--map-ui-hover,var(--elevated))] active:bg-[var(--map-ui-active,var(--subtle))]":"cursor-not-allowed"}`,style:k?void 0:{color:a?It.disabledText:"rgba(251, 191, 36, 0.3)"},title:`Increase opacity (${Math.round(g*100)}%)`,"aria-label":`Increase opacity, currently ${Math.round(g*100)}%`,children:t.jsx(Ln,{className:"w-3.5 h-3.5"})})]})]})}const Ri="0123456789bcdefghjkmnpqrstuvwxyz";function Ai(e){let n=!0,s=-90,r=90,o=-180,a=180;for(const c of e.toLowerCase()){const f=Ri.indexOf(c);if(f!==-1)for(let u=4;u>=0;u--){const l=f>>u&1;if(n){const m=(o+a)/2;l?o=m:a=m}else{const m=(s+r)/2;l?s=m:r=m}n=!n}}return{lat:(s+r)/2,lon:(o+a)/2}}function Ii(e){return Math.exp(-e*Math.LN2/7)}const bn="pymc-wardriving-url",hr="pymc-wardriving-enabled",gr="pymc-wardriving-brightness",ps=.7;function _i(){return typeof localStorage>"u"?"":localStorage.getItem(bn)||""}function xs(e){typeof localStorage>"u"||(e?localStorage.setItem(bn,e):localStorage.removeItem(bn))}function Di(){return typeof localStorage>"u"?!1:localStorage.getItem(hr)==="true"}function _t(e){typeof localStorage>"u"||localStorage.setItem(hr,String(e))}function Fi(){if(typeof localStorage>"u")return ps;const e=localStorage.getItem(gr);if(e){const n=parseFloat(e);if(!isNaN(n)&&n>=.01&&n<=1)return n}return ps}function Oi(e){if(typeof localStorage>"u")return;const n=Math.max(.01,Math.min(1,e));localStorage.setItem(gr,String(n))}const Pi=8e3;async function Bi(e,n={},s=Pi){const r=new AbortController,o=setTimeout(()=>r.abort(),s);try{return await fetch(e,{...n,signal:r.signal})}catch(a){throw a instanceof Error&&a.name==="AbortError"?new Error(`Connection timed out after ${s/1e3}s`):a}finally{clearTimeout(o)}}async function Hi(e){const s=`${e.replace(/\/+$/,"").replace(/\/get-nodes$/,"").replace(/\/get-samples$/,"")}/get-samples`,r=await Bi(s,{headers:{Accept:"application/json"}});if(!r.ok)throw new Error(`Failed to fetch precise samples: ${r.status}`);return r.json()}function $i(e,n=null){if(e!==null){const r=(Math.max(-12,Math.min(12,e))+12)/24;if(n!==null){const a=(Math.max(-120,Math.min(-50,n))+120)/70;return r*.8+a*.2}return r}return n!==null?(Math.max(-120,Math.min(-50,n))+120)/70:.5}function Gi(e){var s;const n=[];for(const r of e.keys){if(!r.observed)continue;const{lat:o,lon:a}=Ai(r.hash),c=parseInt(r.time,10),f=isNaN(c)?30:(Date.now()-c)/(1e3*60*60*24),u=Ii(f),m=$i(r.snr,r.rssi)*(.3+u*.7);n.push({lat:o,lon:a,successRate:r.observed?1:0,weight:m,totalSamples:1,ageDays:f,geohash:r.hash,repeaters:((s=r.path)==null?void 0:s.map(h=>h.toLowerCase()))||[]})}return n}const bt=Xs((e,n)=>({status:"idle",isVisible:Di(),coveragePoints:[],repeaters:[],error:null,stats:{coverageCount:0,repeaterCount:0,lastUpdated:null},url:_i(),brightness:Fi(),isModalOpen:!1,openModal:()=>e({isModalOpen:!0}),closeModal:()=>e({isModalOpen:!1}),setUrl:s=>e({url:s}),setBrightness:s=>{const r=Math.max(.01,Math.min(1,s));Oi(r),e({brightness:r})},toggleVisibility:()=>{const s=!n().isVisible;_t(s),e({isVisible:s})},setVisible:s=>{_t(s),e({isVisible:s})},loadCoverage:async s=>{if(!s.trim())return e({error:"Please enter a URL",status:"error"}),!1;try{new URL(s.trim())}catch{return e({error:"Invalid URL format",status:"error"}),!1}e({error:null,status:"connecting"});try{e({status:"loading"});const r=await Hi(s.trim());if(!r||typeof r!="object")throw new Error("Invalid response from server");if(!Array.isArray(r.keys))throw new Error("No sample data found in response");e({status:"processing"});const o=Gi(r);if(o.length===0)throw new Error("No valid coverage points found");return e({coveragePoints:o,repeaters:[],stats:{coverageCount:o.length,repeaterCount:0,lastUpdated:new Date},status:"success",isVisible:!0,url:s.trim()}),xs(s.trim()),_t(!0),!0}catch(r){const o=r instanceof Error?r.message:"Failed to load coverage data";let a=o;return o.includes("timed out")?a="Connection timed out. Server may be unreachable or slow.":o.includes("Failed to fetch")||o.includes("NetworkError")?a="Could not connect to server. Check the URL and try again.":o.includes("CORS")?a="Server does not allow cross-origin requests.":o.includes("404")?a="Coverage endpoint not found. Check the URL.":(o.includes("ERR_NAME_NOT_RESOLVED")||o.includes("DNS"))&&(a="Server not found. Check the URL for typos."),e({error:a,status:"error"}),!1}},clearCoverage:()=>{e({coveragePoints:[],repeaters:[],stats:{coverageCount:0,repeaterCount:0,lastUpdated:null},status:"idle",error:null,isVisible:!1,url:""}),xs(""),_t(!1)}})),Wi={bg:"#F8F8F8",bgSubtle:"#F0F0F0",bgElevated:"#FFFFFF",bgInput:"#FFFFFF",border:"rgba(0, 0, 0, 0.12)",borderStrong:"rgba(0, 0, 0, 0.20)",borderFocus:"#3B82F6",text:"#1A1A1A",textSecondary:"#4A4A4A",textMuted:"#737373",success:"#059669",successBg:"#ECFDF5",successBorder:"#A7F3D0",error:"#DC2626",errorBg:"#FEF2F2",errorBorder:"#FECACA",info:"#2563EB",infoBg:"#EFF6FF",infoBorder:"#BFDBFE",warning:"#D97706",warningBg:"#FFFBEB",warningBorder:"#FDE68A",primary:"#F59E0B",hoverBg:"rgba(0, 0, 0, 0.04)",sliderTrack:"#E5E7EB",sliderThumb:"#F59E0B"},pr={bg:"var(--surface)",bgSubtle:"var(--subtle)",bgElevated:"var(--elevated)",bgInput:"var(--subtle)",border:"var(--edge-subtle)",borderStrong:"var(--edge-strong)",borderFocus:"var(--sys-blue)",text:"var(--fg-primary)",textSecondary:"var(--fg-secondary)",textMuted:"var(--fg-muted)",success:"var(--sys-green)",successBg:"rgba(74, 222, 128, 0.1)",successBorder:"rgba(74, 222, 128, 0.3)",error:"var(--sys-red)",errorBg:"rgba(239, 68, 68, 0.1)",errorBorder:"rgba(239, 68, 68, 0.3)",info:"var(--sys-indigo)",infoBg:"rgba(249, 210, 111, 0.1)",infoBorder:"rgba(249, 210, 111, 0.3)",warning:"var(--sys-indigo)",warningBg:"rgba(249, 210, 111, 0.1)",warningBorder:"rgba(249, 210, 111, 0.3)",primary:"var(--sys-indigo)",hoverBg:"var(--hover-tint)",sliderTrack:"var(--elevated)",sliderThumb:"var(--sys-indigo)"},xr=i.createContext({theme:pr,isLight:!1});function nt(){return i.useContext(xr)}function zi({status:e,hasData:n}){const{theme:s,isLight:r}=nt(),o=i.useMemo(()=>e==="connecting"||e==="loading"||e==="processing"?{icon:t.jsx(Tn,{className:"w-3.5 h-3.5 animate-spin"}),label:e==="connecting"?"Connecting...":e==="loading"?"Loading...":"Processing...",color:s.warning,bg:s.warningBg}:e==="error"?{icon:t.jsx(ja,{className:"w-3.5 h-3.5"}),label:"Disconnected",color:s.error,bg:s.errorBg}:n?{icon:t.jsx(Na,{className:"w-3.5 h-3.5"}),label:"Connected",color:s.success,bg:s.successBg}:{icon:t.jsx(or,{className:"w-3.5 h-3.5"}),label:"Ready",color:s.textMuted,bg:r?"rgba(0,0,0,0.04)":"rgba(255,255,255,0.04)"},[e,n,s,r]);return t.jsxs(ke.div,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},className:"flex items-center gap-1.5 px-2 py-1 rounded-full text-xs font-medium",style:{backgroundColor:o.bg,color:o.color},children:[o.icon,t.jsx("span",{children:o.label})]},o.label)}function Ui({status:e}){const{theme:n}=nt(),s=i.useMemo(()=>{switch(e){case"connecting":return 25;case"loading":return 60;case"processing":return 90;default:return 0}},[e]);return s===0?null:t.jsx(ke.div,{initial:{opacity:0,scaleY:0},animate:{opacity:1,scaleY:1},exit:{opacity:0,scaleY:0},className:"h-1 rounded-full overflow-hidden origin-top",style:{backgroundColor:n.sliderTrack},children:t.jsx(ke.div,{className:"h-full rounded-full",style:{backgroundColor:n.primary},initial:{width:0},animate:{width:`${s}%`},transition:{duration:.4,ease:"easeOut"}})})}function ys({variant:e,title:n,description:s,onDismiss:r}){const{theme:o}=nt(),a=i.useMemo(()=>{switch(e){case"success":return{icon:t.jsx(An,{className:"w-4 h-4"}),color:o.success,bg:o.successBg,border:o.successBorder};case"error":return{icon:t.jsx(Ea,{className:"w-4 h-4"}),color:o.error,bg:o.errorBg,border:o.errorBorder};case"info":return{icon:t.jsx(ka,{className:"w-4 h-4"}),color:o.info,bg:o.infoBg,border:o.infoBorder}}},[e,o]);return t.jsxs(ke.div,{initial:{opacity:0,y:-8},animate:{opacity:1,y:0},exit:{opacity:0,y:-8},transition:ut.snappy,className:"flex items-start gap-3 p-3 rounded-lg border",style:{backgroundColor:a.bg,borderColor:a.border,color:a.color},children:[t.jsx("div",{className:"shrink-0 mt-0.5",children:a.icon}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsx("p",{className:"text-sm font-medium",children:n}),s&&t.jsx("p",{className:"text-xs mt-0.5 opacity-80",children:s})]}),r&&t.jsx("button",{onClick:r,className:"shrink-0 p-1 rounded hover:bg-black/10 transition-colors","aria-label":"Dismiss",children:t.jsx(St,{className:"w-3.5 h-3.5"})})]})}function Ki({value:e,onChange:n,onSubmit:s,disabled:r}){const{theme:o,isLight:a}=nt(),[c,f]=i.useState(!1),u=l=>{l.key==="Enter"&&!l.shiftKey&&!r&&(l.preventDefault(),s())};return t.jsxs("div",{className:"space-y-1.5",children:[t.jsx("label",{className:"block text-sm font-medium",style:{color:o.textSecondary},children:"Coverage Server URL"}),t.jsxs("div",{className:"relative",children:[t.jsx("input",{type:"url",value:e,onChange:l=>n(l.target.value),onKeyDown:u,onFocus:()=>f(!0),onBlur:()=>f(!1),placeholder:"https://coverage.wcmesh.com",disabled:r,className:Fe("w-full pl-3 pr-10 py-2.5 rounded-lg border text-sm transition-all duration-150","focus:outline-none",r&&"opacity-50 cursor-not-allowed"),style:{backgroundColor:o.bgInput,borderColor:c?o.borderFocus:o.border,color:o.text,boxShadow:c?`0 0 0 3px ${a?"rgba(59, 130, 246, 0.15)":"rgba(139, 92, 246, 0.15)"}`:"none"}}),e&&!r&&t.jsx("button",{onClick:()=>n(""),className:"absolute right-2.5 top-1/2 -translate-y-1/2 p-1 rounded transition-colors",style:{color:o.textMuted},onMouseEnter:l=>l.currentTarget.style.color=o.text,onMouseLeave:l=>l.currentTarget.style.color=o.textMuted,"aria-label":"Clear URL",children:t.jsx(St,{className:"w-4 h-4"})})]}),t.jsx("p",{className:"text-xs",style:{color:o.textMuted},children:"Press Enter to connect, or use the Connect button below"})]})}function qi({value:e,onChange:n}){const{theme:s,isLight:r}=nt(),o=Math.round(e*100);return t.jsx(ke.div,{initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},exit:{opacity:0,height:0},transition:ut.gentle,className:"overflow-hidden",children:t.jsx("div",{className:"p-3 rounded-lg border",style:{backgroundColor:s.bgSubtle,borderColor:s.border},children:t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsxs("div",{className:"relative w-4 h-4",children:[t.jsx(Mn,{className:"w-4 h-4 absolute inset-0 transition-opacity",style:{color:s.textMuted,opacity:e<.5?1:0}}),t.jsx(Ln,{className:"w-4 h-4 absolute inset-0 transition-opacity",style:{color:s.primary,opacity:e>=.5?1:0}})]}),t.jsxs("div",{className:"flex-1",children:[t.jsxs("div",{className:"flex items-center justify-between mb-1.5",children:[t.jsx("span",{className:"text-xs font-medium",style:{color:s.textSecondary},children:"Layer Opacity"}),t.jsxs("span",{className:"text-xs font-mono tabular-nums px-1.5 py-0.5 rounded",style:{color:s.text,backgroundColor:r?"rgba(0,0,0,0.06)":"rgba(255,255,255,0.06)"},children:[o,"%"]})]}),t.jsx("input",{type:"range",min:5,max:100,value:o,onChange:a=>n(Number(a.target.value)/100),className:Fe("w-full h-2 rounded-full appearance-none cursor-pointer","[&::-webkit-slider-thumb]:appearance-none","[&::-webkit-slider-thumb]:w-4","[&::-webkit-slider-thumb]:h-4","[&::-webkit-slider-thumb]:rounded-full","[&::-webkit-slider-thumb]:cursor-pointer","[&::-webkit-slider-thumb]:transition-transform","[&::-webkit-slider-thumb]:hover:scale-110","[&::-webkit-slider-thumb]:shadow-lg","[&::-moz-range-thumb]:appearance-none","[&::-moz-range-thumb]:w-4","[&::-moz-range-thumb]:h-4","[&::-moz-range-thumb]:rounded-full","[&::-moz-range-thumb]:border-0","[&::-moz-range-thumb]:cursor-pointer"),style:{background:`linear-gradient(to right, ${s.primary} ${o}%, ${s.sliderTrack} ${o}%)`,"--thumb-color":s.sliderThumb}}),t.jsx("style",{children:`
              input[type="range"]::-webkit-slider-thumb {
                background-color: ${s.sliderThumb};
              }
              input[type="range"]::-moz-range-thumb {
                background-color: ${s.sliderThumb};
              }
            `})]})]})})})}function Vi({coverageCount:e,repeaterCount:n,lastUpdated:s}){const{theme:r}=nt();return t.jsxs("div",{className:"grid grid-cols-3 gap-2 p-3 rounded-lg border",style:{backgroundColor:r.bgSubtle,borderColor:r.border},children:[t.jsxs("div",{className:"text-center",children:[t.jsx(ts,{value:e,format:{useGrouping:!0,maximumFractionDigits:0},className:"text-lg font-semibold tabular-nums block",style:{color:r.text}}),t.jsx("div",{className:"text-xs mt-0.5",style:{color:r.textMuted},children:"Points"})]}),t.jsxs("div",{className:"text-center border-x",style:{borderColor:r.border},children:[t.jsx(ts,{value:n,format:{useGrouping:!0,maximumFractionDigits:0},className:"text-lg font-semibold tabular-nums block",style:{color:r.text}}),t.jsx("div",{className:"text-xs mt-0.5",style:{color:r.textMuted},children:"Repeaters"})]}),t.jsxs("div",{className:"text-center",children:[t.jsxs("div",{className:"flex items-center justify-center gap-1",children:[t.jsx(ar,{className:"w-3.5 h-3.5",style:{color:r.textMuted}}),t.jsx("span",{className:"text-lg font-semibold tabular-nums",style:{color:r.text},children:s?s.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):"—"})]}),t.jsx("div",{className:"text-xs mt-0.5",style:{color:r.textMuted},children:"Updated"})]})]})}function bs({icon:e,label:n,onClick:s,disabled:r,variant:o="default",active:a}){const{theme:c,isLight:f}=nt(),u=i.useMemo(()=>o==="danger"?{text:c.error,hoverBg:f?"rgba(220, 38, 38, 0.08)":"rgba(239, 68, 68, 0.15)"}:{text:a?c.primary:c.textSecondary,hoverBg:c.hoverBg},[o,a,c,f]);return t.jsxs("button",{onClick:s,disabled:r,className:Fe("flex items-center gap-1.5 px-2.5 py-1.5 rounded-md text-sm font-medium transition-colors",r&&"opacity-50 cursor-not-allowed"),style:{color:u.text},onMouseEnter:l=>!r&&(l.currentTarget.style.backgroundColor=u.hoverBg),onMouseLeave:l=>l.currentTarget.style.backgroundColor="transparent",children:[e,t.jsx("span",{children:n})]})}function Yi(){const e=ir(),n=e==="light",s=n?Wi:pr,{isModalOpen:r,closeModal:o,status:a,isVisible:c,stats:f,error:u,url:l,brightness:m,loadCoverage:h,clearCoverage:g,toggleVisibility:p,setUrl:x,setBrightness:k}=bt(),b=a==="connecting"||a==="loading"||a==="processing",w=f.coverageCount>0,[T,L]=i.useState(!0),[E,A]=i.useState(l);i.useEffect(()=>{A(l)},[l]),i.useEffect(()=>{a==="error"&&L(!0)},[a]);const M=i.useCallback(async()=>{await h(E)},[E,h]),I=i.useCallback(()=>{A(""),g()},[g]),O=i.useCallback(j=>{A(j),x(j)},[x]),_=i.useCallback(()=>{b||o()},[b,o]),B=E.trim().length>0&&!b;return t.jsx(xr.Provider,{value:{theme:s,isLight:n},children:t.jsxs(Fo,{open:r,onClose:_,size:"md",bottomSheet:!0,basemapMode:e,children:[t.jsxs("div",{className:"flex items-center justify-between p-4 border-b",style:{borderColor:s.border},children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("div",{className:"p-2 rounded-lg",style:{backgroundColor:s.bgSubtle,color:s.primary},children:t.jsx(or,{className:"w-5 h-5"})}),t.jsxs("div",{children:[t.jsx("h2",{className:"type-micro",style:{color:s.text},children:"Wardriving Coverage"}),t.jsx("p",{className:"text-xs",style:{color:s.textMuted},children:"RF coverage heatmap overlay"})]})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(zi,{status:a,hasData:w}),!b&&t.jsxs(t.Fragment,{children:[t.jsx("button",{onClick:_,className:"sm:hidden min-h-[44px] min-w-[44px] px-3 flex items-center justify-center text-[15px] font-medium transition-base radius-inner active:bg-subtle-fill",style:{color:s.primary},children:"Done"}),t.jsx("button",{onClick:_,className:"hidden sm:flex items-center justify-center p-2 rounded-lg transition-colors",style:{color:s.textMuted},onMouseEnter:j=>{j.currentTarget.style.color=s.text,j.currentTarget.style.backgroundColor=s.hoverBg},onMouseLeave:j=>{j.currentTarget.style.color=s.textMuted,j.currentTarget.style.backgroundColor="transparent"},"aria-label":"Close",children:t.jsx(St,{className:"w-5 h-5"})})]})]})]}),t.jsx(_e,{children:b&&t.jsx(Ui,{status:a})}),t.jsxs(Oo,{className:"space-y-4",children:[t.jsx(Ki,{value:E,onChange:O,onSubmit:M,disabled:b}),t.jsx(_e,{children:a==="error"&&u&&T&&t.jsx(ys,{variant:"error",title:"Connection Failed",description:u,onDismiss:()=>L(!1)})}),t.jsx(_e,{children:a==="success"&&w&&t.jsx(ys,{variant:"success",title:"Coverage Data Loaded",description:"Adjust opacity below, then close to view on map"})}),t.jsx(_e,{children:w&&!b&&t.jsx(ke.div,{initial:{opacity:0,y:8},animate:{opacity:1,y:0},exit:{opacity:0,y:8},transition:ut.snappy,children:t.jsx(Vi,{coverageCount:f.coverageCount,repeaterCount:f.repeaterCount,lastUpdated:f.lastUpdated})})}),t.jsx(_e,{children:w&&!b&&t.jsx(qi,{value:m,onChange:k})})]}),t.jsxs("div",{className:"flex items-center justify-between p-4 border-t",style:{borderColor:s.border},children:[t.jsx("div",{className:"flex items-center gap-1",children:t.jsx(_e,{children:w&&t.jsxs(ke.div,{initial:{opacity:0,x:-10},animate:{opacity:1,x:0},exit:{opacity:0,x:-10},transition:ut.snappy,className:"flex items-center gap-1",children:[t.jsx(bs,{icon:c?t.jsx(Sa,{className:"w-4 h-4"}):t.jsx(tr,{className:"w-4 h-4"}),label:c?"Hide":"Show",onClick:p,disabled:b,active:c}),t.jsx(bs,{icon:t.jsx(Rn,{className:"w-4 h-4"}),label:"Clear",onClick:I,disabled:b,variant:"danger"})]})})}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(he,{plain:!0,color:"muted",onClick:_,disabled:b,children:w?"Done":"Cancel"}),t.jsx(he,{color:"warning",onClick:M,disabled:!B,children:b?t.jsxs(t.Fragment,{children:[t.jsx(Tn,{"data-slot":"icon",className:"animate-spin"}),a==="connecting"?"Connecting...":a==="loading"?"Loading...":"Processing..."]}):w?t.jsxs(t.Fragment,{children:[t.jsx(er,{"data-slot":"icon"}),"Refresh"]}):t.jsxs(t.Fragment,{children:[t.jsx(wa,{"data-slot":"icon"}),"Connect"]})})]})]})]})})}const Zi={bandwidth:.07,threshold:.1,opacity:1,strokeWidth:4.5},we={...tt,trackBg:tt.border};function Dt({label:e,value:n,min:s,max:r,step:o,unit:a,formatValue:c,onChange:f,isLightMode:u}){const l=c?c(n):n.toFixed(2);return t.jsxs("div",{className:"flex items-center gap-2 sm:gap-2",children:[t.jsx("span",{className:"text-xs font-medium w-14 sm:w-16 shrink-0",style:u?{color:we.textSecondary}:{color:"var(--fg-secondary)"},children:e}),t.jsx("input",{type:"range",min:s,max:r,step:o,value:n,onChange:m=>f(parseFloat(m.target.value)),className:`flex-1 h-1.5 rounded-full appearance-none cursor-pointer
                   [&::-webkit-slider-thumb]:appearance-none
                   [&::-webkit-slider-thumb]:w-3.5
                   [&::-webkit-slider-thumb]:h-3.5
                   [&::-webkit-slider-thumb]:rounded-full
                   [&::-webkit-slider-thumb]:bg-sys-indigo
                   [&::-webkit-slider-thumb]:cursor-pointer
                   [&::-webkit-slider-thumb]:transition-transform
                   [&::-webkit-slider-thumb]:hover:scale-110
                   [&::-webkit-slider-thumb]:shadow-md`,style:u?{backgroundColor:we.trackBg}:{backgroundColor:"var(--elevated)"}}),t.jsxs("span",{className:"text-xs font-mono tabular-nums w-12 sm:w-14 text-right shrink-0",style:u?{color:we.textPrimary}:{color:"var(--fg-muted)"},children:[l,a&&t.jsx("span",{className:"ml-0.5 opacity-70",style:u?{color:we.textMuted}:void 0,children:a})]})]})}function Ft({icon:e,label:n,value:s,subtext:r,isLightMode:o}){return t.jsxs("div",{className:"flex items-center gap-1.5 sm:gap-2 py-0.5 sm:py-1",children:[t.jsx("div",{style:o?{color:we.textMuted}:{color:"var(--fg-muted)"},children:e}),t.jsx("div",{className:"flex-1 min-w-0",children:t.jsx("div",{className:"text-[10px] sm:text-xs truncate",style:o?{color:we.textSecondary}:{color:"var(--fg-secondary)"},children:n})}),t.jsxs("div",{className:"text-right",children:[t.jsx("div",{className:"text-xs font-mono tabular-nums",style:o?{color:we.textPrimary}:{color:"var(--fg-primary)"},children:s}),r&&t.jsx("div",{className:"text-[9px] leading-tight opacity-70",style:o?{color:we.textMuted}:{color:"var(--fg-muted)"},children:r})]})]})}function Ji({visible:e,onClose:n,settings:s,onSettingsChange:r,partition:o,totalNodes:a,basemapMode:c="dark"}){const f=Fa(),u=i.useRef(null),l=c==="light",m=i.useMemo(()=>{if(!o)return{numCommunities:0,avgCommunitySize:0,minCommunitySize:0,maxCommunitySize:0,fiedlerValue:0,modularity:0,coveragePercent:0};const p=Array.from(o.communities.values()).map(k=>k.length),x=p.reduce((k,b)=>k+b,0);return{numCommunities:o.numCommunities,avgCommunitySize:p.length>0?Math.round(x/p.length):0,minCommunitySize:p.length>0?Math.min(...p):0,maxCommunitySize:p.length>0?Math.max(...p):0,fiedlerValue:o.fiedlerValue,modularity:0,coveragePercent:a>0?Math.round(x/a*100):0}},[o,a]),h=(p,x)=>{r({...s,[p]:x})},g=(s.bandwidth*111).toFixed(1);return t.jsx("div",{ref:u,className:"absolute inset-0 z-[600] pointer-events-none",children:t.jsx(_e,{children:e&&t.jsx(ke.div,{drag:!0,dragControls:f,dragConstraints:u,dragElastic:.1,dragMomentum:!1,initial:{opacity:0,scale:.95,y:10},animate:{opacity:1,scale:1,y:0},exit:{opacity:0,scale:.95,y:10},transition:ut.smooth,className:`
              absolute pointer-events-auto
              /* Mobile: bottom sheet style, full width with margins */
              bottom-2 left-2 right-2
              /* sm+: floating panel in bottom-right */
              sm:bottom-16 sm:left-auto sm:right-3 sm:w-64
              /* md+: slightly wider */
              md:w-72
            `,style:{touchAction:"none"},children:t.jsxs("div",{className:`
              map-control-surface rounded-lg overflow-hidden shadow-lg
              /* Mobile: limit height, allow scroll */
              max-h-[45vh] sm:max-h-[calc(100vh-180px)] overflow-y-auto
              /* iOS momentum scrolling */
              overscroll-contain
            `,children:[t.jsxs("div",{className:`
                  flex items-center justify-between 
                  px-3 py-2 sm:px-2.5 sm:py-1.5 
                  border-b 
                  cursor-grab active:cursor-grabbing
                  /* Larger touch target on mobile */
                  min-h-[44px] sm:min-h-0
                `,style:l?{borderColor:we.border}:void 0,onPointerDown:p=>f.start(p),children:[t.jsxs("div",{className:"flex items-center gap-2 sm:gap-1.5",children:[t.jsx(Ma,{className:"w-4 h-4 sm:w-3 sm:h-3",style:l?{color:we.textMuted}:void 0}),t.jsx(fn,{className:"w-4 h-4 sm:w-3.5 sm:h-3.5 text-sys-blue"}),t.jsx("span",{className:"text-sm sm:text-xs font-medium",style:l?{color:we.textPrimary}:void 0,children:"Partition"})]}),t.jsx(he,{plain:!0,color:"muted",onClick:n,className:"!p-1.5 sm:!p-0.5 !rounded min-w-[44px] min-h-[44px] sm:min-w-0 sm:min-h-0 flex items-center justify-center","aria-label":"Close toolbox",children:t.jsx(St,{className:"w-4 h-4 sm:w-3 sm:h-3"})})]}),t.jsx("div",{className:"px-3 py-2 sm:px-2.5 sm:py-1.5 border-b",style:l?{borderColor:we.border}:void 0,children:t.jsxs("div",{className:"grid grid-cols-2 gap-x-4 sm:gap-x-3 gap-y-1 sm:gap-y-0.5",children:[t.jsx(Ft,{icon:t.jsx(fn,{className:"w-3.5 h-3.5 sm:w-3 sm:h-3"}),label:"Communities",value:m.numCommunities,isLightMode:l}),t.jsx(Ft,{icon:t.jsx(es,{className:"w-3.5 h-3.5 sm:w-3 sm:h-3"}),label:"Avg Size",value:m.avgCommunitySize,subtext:`${m.minCommunitySize}–${m.maxCommunitySize}`,isLightMode:l}),t.jsx(Ft,{icon:t.jsx(La,{className:"w-3.5 h-3.5 sm:w-3 sm:h-3"}),label:"Fiedler λ₂",value:m.fiedlerValue.toFixed(3),isLightMode:l}),t.jsx(Ft,{icon:t.jsx(es,{className:"w-3.5 h-3.5 sm:w-3 sm:h-3"}),label:"Coverage",value:`${m.coveragePercent}%`,subtext:`of ${a}`,isLightMode:l})]})}),t.jsx("div",{className:"px-3 py-2 sm:px-2.5 sm:py-1.5",children:t.jsxs("div",{className:"space-y-3 sm:space-y-1.5",children:[t.jsx(Dt,{label:"Bandwidth",value:s.bandwidth,min:.01,max:.15,step:.005,formatValue:()=>g,unit:"km",onChange:p=>h("bandwidth",p),isLightMode:l}),t.jsx(Dt,{label:"Threshold",value:s.threshold,min:.05,max:.5,step:.01,formatValue:p=>`${Math.round((1-p)*100)}%`,unit:"cov",onChange:p=>h("threshold",p),isLightMode:l}),t.jsx(Dt,{label:"Opacity",value:s.opacity,min:.1,max:1,step:.05,formatValue:p=>`${Math.round(p*100)}%`,onChange:p=>h("opacity",p),isLightMode:l}),t.jsx(Dt,{label:"Stroke",value:s.strokeWidth,min:0,max:5,step:.5,unit:"px",formatValue:p=>p.toFixed(1),onChange:p=>h("strokeWidth",p),isLightMode:l})]})})]})})})})}const Qi={excellent:"text-signal-excellent",good:"text-signal-good",fair:"text-signal-fair",poor:"text-signal-poor",critical:"text-signal-critical"};function vt(e,n){return Qi[Ys(e,n)]}const Xi={backgroundColor:"var(--map-ui-hover, var(--elevated))",color:"var(--map-ui-text, var(--fg-primary))",boxShadow:"inset 0 0 0 1px var(--map-ui-border-strong, var(--edge-strong))"},ec={backgroundColor:"var(--map-ui-bg, var(--body))",color:"var(--map-ui-text, var(--fg-primary))",boxShadow:"0 1px 4px rgba(0,0,0,0.15), inset 0 0 0 1px var(--map-ui-border, var(--edge-subtle))"};function ct({prefix:e,name:n}){const s=i.useRef(null),[r,o]=i.useState(!1),[a,c]=i.useState({top:0,left:0}),f=()=>{if(!n||!s.current)return;const u=s.current.getBoundingClientRect();c({top:u.top-4,left:u.left+u.width/2}),o(!0)};return t.jsxs(t.Fragment,{children:[t.jsx("span",{ref:s,className:"inline-flex items-center px-1.5 py-0.5 rounded font-mono text-[10px] font-semibold transition-opacity hover:opacity-80 cursor-default",style:Xi,onMouseEnter:f,onMouseLeave:()=>o(!1),children:e}),n&&r&&No.createPortal(t.jsx("span",{className:"fixed z-[9999] pointer-events-none -translate-x-1/2 -translate-y-full whitespace-nowrap rounded px-1.5 py-0.5 text-[10px] font-medium",style:{...ec,top:a.top,left:a.left},children:n}),document.body)]})}function yr(e){if(e._tracePathHashes)return e._tracePathHashes;if(e.payload&&e.payload.length>=20){const n=e.payload.slice(18),s=[];for(let r=0;r<n.length;r+=2){const o=n.slice(r,r+2).toUpperCase();o.length===2&&s.push(o)}return s.length>0?s:null}return null}function br(e,n){return e.src_hash?[e.src_hash.replace(/^0x/i,"").slice(0,2).toUpperCase(),...n.map(r=>r.toUpperCase())]:n.map(s=>s.toUpperCase())}function tc(e,n,s,r=15){const o=[],a=n.toUpperCase(),c=s.toUpperCase();for(const f of e){if((f.type??f.payload_type)!==Wo.TRACE)continue;const l=yr(f);if(!l||l.length<1)continue;const m=br(f,l);if(!(m.length<2)){for(let h=0;h<m.length-1;h++)if(m[h]===a&&m[h+1]===c||m[h]===c&&m[h+1]===a){o.push(f);break}if(o.length>=r)break}}return o}function nc(e){switch(e){case"improving":return t.jsx(Aa,{className:"w-3 h-3 text-sys-green"});case"degrading":return t.jsx(Ra,{className:"w-3 h-3 text-sys-red"});case"stable":return t.jsx(sr,{className:"w-3 h-3 text-fg-muted"});default:return null}}const sc={backgroundColor:"var(--map-ui-stripe)"};function Gt({label:e,value:n,unit:s,color:r,tooltip:o}){return t.jsxs("div",{className:`flex items-center justify-between gap-2 py-[3px] ${o?"cursor-help":""}`,title:o,children:[t.jsx("span",{className:"type-data-xs text-fg-muted",children:e}),t.jsxs("span",{className:`data-box data-box-compact ${r||""}`,children:[n,s&&t.jsx("span",{className:"text-fg-muted ml-0.5",children:s})]})]})}function vs({stats:e,direction:n,sf:s,noiseFloor:r}){if(!e)return t.jsxs("div",{className:"min-w-0",children:[t.jsx("div",{className:"flex items-center justify-between mb-1.5",children:t.jsx("p",{className:"type-data-xs text-fg-secondary font-medium",children:n})}),t.jsx("p",{className:"type-data-xs text-fg-muted italic px-1.5",children:"No data"})]});const o=e.max-e.min,a=e.median-e.mean,c=zo(s),f=e.mean-c,u=Ys(e.mean,s),l=[`Mean SNR: ${e.mean.toFixed(1)} dB (${u}) from ${e.count} measurement${e.count!==1?"s":""}`,`Variability: ±${e.stdDev.toFixed(1)} dB`,"",`Link budget (SF${s}, 3.5 dBi omni):`,`  Demod threshold: ${c.toFixed(1)} dB`,`  SNR margin: ${f>=0?"+":""}${f.toFixed(1)} dB`];return r!=null&&l.push(`  Noise floor: ${r} dBm`),t.jsxs("div",{className:"min-w-0",children:[t.jsxs("div",{className:"flex items-center justify-between mb-1.5",children:[t.jsx("p",{className:"type-data-xs text-fg-secondary font-medium",children:n}),t.jsxs("span",{className:"type-data-xs text-fg-muted tabular-nums",title:`${e.count} measurement${e.count!==1?"s":""}`,children:["n=",e.count]})]}),t.jsx(Gt,{label:"Mean",value:e.mean.toFixed(1),unit:"dB",color:vt(e.mean,s),tooltip:l.join(`
`)}),t.jsx(Gt,{label:"Median",value:e.median.toFixed(1),unit:"dB",tooltip:`Middle value — less affected by unusual readings than the average.${Math.abs(a)>=.15?`
Differs from mean by ${a>0?"+":""}${a.toFixed(1)} dB`:""}`}),t.jsx(Gt,{label:"Range",value:`${e.min.toFixed(1)}–${e.max.toFixed(1)}`,unit:"dB",tooltip:`Best to worst signal observed. Total spread: ${o.toFixed(1)} dB.`})]})}function rc({pair:e,onClose:n,prefixToName:s}){var A,M,I,O,_,B,j,$,H,P,z,y;const r=qs(),o=Po(),a=Bo(),c=Ho(),[f,u]=i.useState(null),l=((M=(A=a==null?void 0:a.config)==null?void 0:A.radio)==null?void 0:M.spreading_factor)??$o,m=i.useMemo(()=>{const C=`${e.nodeA.hash}>${e.nodeB.hash}`,S=`${e.nodeB.hash}>${e.nodeA.hash}`;return{forward:r.get(C)??null,reverse:r.get(S)??null}},[r,e.nodeA.hash,e.nodeB.hash]),h=i.useMemo(()=>!o||o.length===0?[]:tc(o,e.nodeA.prefix,e.nodeB.prefix),[o,e.nodeA.prefix,e.nodeB.prefix]),g=e.nodeA.name||(s==null?void 0:s.get(e.nodeA.prefix.toUpperCase()))||null,p=e.nodeB.name||(s==null?void 0:s.get(e.nodeB.prefix.toUpperCase()))||null,x=((I=m.forward)==null?void 0:I.trend)??((O=m.reverse)==null?void 0:O.trend)??"insufficient",k=Math.max(((_=m.forward)==null?void 0:_.lastSeen)??0,((B=m.reverse)==null?void 0:B.lastSeen)??0),b=(((j=m.forward)==null?void 0:j.uniqueTraceCount)??0)+((($=m.reverse)==null?void 0:$.uniqueTraceCount)??0),w=x==="insufficient"?"Not enough data to determine trend (need at least 4 measurements).":`Whether signal quality is getting better or worse over time.
Compares older measurements to newer ones.`,T=((H=m.forward)==null?void 0:H.uniqueTraceCount)??0,L=((P=m.reverse)==null?void 0:P.uniqueTraceCount)??0,E=["Number of trace packets that traveled through this link.",`${e.nodeA.prefix}→${e.nodeB.prefix}: ${T}`,`${e.nodeB.prefix}→${e.nodeA.prefix}: ${L}`].join(`
`);return t.jsx("div",{className:`
      absolute z-[700] overflow-hidden
      /* Mobile: full-width bottom sheet with breathing room */
      bottom-2 left-2 right-2
      /* sm+: right-aligned floating panel */
      sm:bottom-16 sm:left-auto sm:right-4 sm:w-[280px]
    `,children:t.jsxs("div",{className:`
        map-control-surface flex flex-col
        /* Mobile: cap at 45vh so map stays visible */
        max-h-[45vh]
        /* sm+: taller allowance */
        sm:max-h-[420px]
      `,children:[t.jsxs("div",{className:"flex items-center justify-between gap-2 px-3 py-2 sm:py-2 min-h-[44px] sm:min-h-0 border-b border-edge-subtle",children:[t.jsxs("div",{className:"flex items-center gap-1.5 min-w-0",children:[t.jsx(rr,{className:"w-4 h-4 sm:w-3.5 sm:h-3.5 text-sys-green shrink-0"}),t.jsx(ct,{prefix:e.nodeA.prefix,name:g}),t.jsx("span",{className:"type-data-xs text-fg-muted",children:"↔"}),t.jsx(ct,{prefix:e.nodeB.prefix,name:p})]}),t.jsxs("div",{className:"flex items-center gap-1.5 shrink-0",children:[k>0&&t.jsx("span",{className:"type-data-xs text-fg-muted",title:Xn(k),children:Vs(k)}),t.jsx(he,{plain:!0,color:"muted",onClick:n,className:"!p-1.5 sm:!p-0.5 !rounded-md min-w-[44px] min-h-[44px] sm:min-w-0 sm:min-h-0 flex items-center justify-center",children:t.jsx(St,{className:"w-4 h-4 sm:w-3.5 sm:h-3.5"})})]})]}),t.jsxs("div",{className:"px-3 py-2.5 border-b border-edge-subtle",children:[t.jsxs("div",{className:"space-y-1.5 mb-2",children:[t.jsxs("div",{className:"flex items-center justify-between cursor-help",title:`${e.nodeA.prefix}→${e.nodeB.prefix}: mean of ${((z=e.aToB)==null?void 0:z.count)??0} measurements`,children:[t.jsxs("span",{className:"flex items-center gap-1",children:[t.jsx(ct,{prefix:e.nodeA.prefix,name:g}),t.jsx("span",{className:"type-data-xs text-fg-muted",children:"→"}),t.jsx(ct,{prefix:e.nodeB.prefix,name:p})]}),e.aToB?t.jsxs("span",{className:`type-data-sm tabular-nums font-semibold ${vt(e.aToB.mean,l)}`,children:[e.aToB.mean.toFixed(1),t.jsx("span",{className:"text-fg-muted font-normal ml-0.5",children:"dB"})]}):t.jsx("span",{className:"type-data-sm text-fg-muted",children:"—"})]}),t.jsxs("div",{className:"flex items-center justify-between cursor-help",title:`${e.nodeB.prefix}→${e.nodeA.prefix}: mean of ${((y=e.bToA)==null?void 0:y.count)??0} measurements`,children:[t.jsxs("span",{className:"flex items-center gap-1",children:[t.jsx(ct,{prefix:e.nodeB.prefix,name:p}),t.jsx("span",{className:"type-data-xs text-fg-muted",children:"→"}),t.jsx(ct,{prefix:e.nodeA.prefix,name:g})]}),e.bToA?t.jsxs("span",{className:`type-data-sm tabular-nums font-semibold ${vt(e.bToA.mean,l)}`,children:[e.bToA.mean.toFixed(1),t.jsx("span",{className:"text-fg-muted font-normal ml-0.5",children:"dB"})]}):t.jsx("span",{className:"type-data-sm text-fg-muted",children:"—"})]})]}),t.jsxs("div",{className:"grid grid-cols-2 gap-0 -mx-3 border-t border-edge-subtle",children:[t.jsx("div",{className:"px-3 pt-2 pb-1 border-r border-edge-subtle",children:t.jsx(vs,{stats:e.aToB,direction:`${e.nodeA.prefix}→${e.nodeB.prefix}`,sf:l,noiseFloor:c})}),t.jsx("div",{className:"px-3 pt-2 pb-1",children:t.jsx(vs,{stats:e.bToA,direction:`${e.nodeB.prefix}→${e.nodeA.prefix}`,sf:l,noiseFloor:c})})]})]}),t.jsxs("div",{className:"px-3 py-1.5 border-b border-edge-subtle",children:[x!=="insufficient"&&t.jsxs("div",{className:"flex items-center justify-between gap-2 py-[3px] cursor-help",title:w,children:[t.jsx("span",{className:"type-data-xs text-fg-muted",children:"Trend"}),t.jsx("span",{className:"data-box data-box-compact",children:t.jsxs("span",{className:"flex items-center gap-1",children:[nc(x),t.jsx("span",{className:"text-fg-secondary capitalize",children:x})]})})]}),b>0&&t.jsx(Gt,{label:"Unique traces",value:b.toString(),tooltip:E})]}),h.length>0&&t.jsxs("div",{className:"px-3 py-2 flex-1 min-h-0 flex flex-col",children:[t.jsxs("p",{className:"type-micro text-fg-secondary mb-1 shrink-0",children:["Source packets (",h.length,")"]}),t.jsx("div",{className:"overflow-y-auto flex-1 min-h-0 overscroll-contain",style:{scrollbarGutter:"stable"},children:h.map((C,S)=>{const R=yr(C),D=R?br(C,R):null,q=D?Math.max(0,D.length-1):0,Y=D?D.map(W=>(s==null?void 0:s.get(W))??W).join(" → "):null,U=f===S,G=C.id??`${C.packet_hash}-${C.timestamp}`;return t.jsxs("div",{className:"rounded-sm",style:S%2===1?sc:void 0,children:[t.jsxs("button",{onClick:()=>u(U?null:S),className:"flex items-center gap-1.5 py-[3px] px-1 w-full text-left text-[10px] font-mono text-fg-secondary hover:text-fg-primary transition-colors group",children:[U?t.jsx(nr,{className:"w-2.5 h-2.5 text-fg-muted shrink-0"}):t.jsx(Ta,{className:"w-2.5 h-2.5 text-fg-muted shrink-0 opacity-0 group-hover:opacity-100 transition-opacity"}),t.jsx("span",{className:"text-fg-muted w-[52px] shrink-0",children:Xn(C.timestamp)}),Y?t.jsx("span",{className:"text-fg-secondary truncate min-w-0",title:D.join(" → "),children:Y}):t.jsx("span",{className:"text-fg-muted truncate min-w-0 italic",children:"path n/a"}),t.jsxs("span",{className:"text-fg-muted shrink-0",children:[q,"h"]}),C.snr!=null&&t.jsx("span",{className:`shrink-0 tabular-nums ${vt(C.snr,l)}`,children:C.snr.toFixed(1)})]}),U&&t.jsxs("div",{className:"mb-1 mt-0.5 mx-1 pl-2 border-l border-edge-subtle space-y-0.5 text-[10px]",children:[C.rssi!=null&&t.jsxs("div",{className:"flex items-center justify-between gap-2",children:[t.jsx("span",{className:"text-fg-muted",children:"RSSI"}),t.jsxs("span",{className:"font-mono tabular-nums text-fg-secondary",children:[C.rssi," dBm"]})]}),C.snr!=null&&t.jsxs("div",{className:"flex items-center justify-between gap-2",children:[t.jsx("span",{className:"text-fg-muted",children:"SNR"}),t.jsxs("span",{className:`font-mono tabular-nums ${vt(C.snr,l)}`,children:[C.snr.toFixed(1)," dB"]})]}),t.jsxs("div",{className:"flex items-center justify-between gap-2",children:[t.jsx("span",{className:"text-fg-muted",children:"Route"}),t.jsx("span",{className:"font-mono text-fg-secondary",children:Go(C.route??C.route_type)})]}),C.packet_hash&&t.jsxs("div",{className:"flex items-center justify-between gap-2",children:[t.jsx("span",{className:"text-fg-muted",children:"Hash"}),t.jsxs("button",{onClick:W=>{W.stopPropagation(),navigator.clipboard.writeText(C.packet_hash)},className:"flex items-center gap-1 font-mono text-fg-secondary hover:text-fg-primary transition-colors",title:"Copy packet hash",children:[t.jsx("span",{className:"truncate max-w-[120px]",children:C.packet_hash}),t.jsx(In,{className:"w-2.5 h-2.5 text-fg-muted shrink-0"})]})]}),C.src_hash&&t.jsxs("div",{className:"flex items-center justify-between gap-2",children:[t.jsx("span",{className:"text-fg-muted",children:"Source"}),t.jsx("span",{className:"font-mono text-fg-secondary truncate max-w-[140px]",title:C.src_hash,children:C.src_hash})]}),D&&D.length>0&&t.jsxs("div",{className:"flex items-center justify-between gap-2",children:[t.jsx("span",{className:"text-fg-muted",children:"Path"}),t.jsx("span",{className:"font-mono text-fg-secondary truncate max-w-[140px]",title:D.join(" → "),children:D.join(" → ")})]})]})]},G)})})]})]})})}const oc={getItem:e=>{try{return localStorage.getItem(e)}catch{return null}},setItem:(e,n)=>{try{localStorage.setItem(e,n)}catch{}},removeItem:e=>{try{localStorage.removeItem(e)}catch{}}},vr=Xs()(ia(e=>({isEnabled:!1,toggle:()=>e(n=>({isEnabled:!n.isEnabled})),setEnabled:n=>e({isEnabled:n})}),{name:"pymc-live-trace",storage:ca(()=>oc)})),ac=()=>vr(e=>e.isEnabled),ic=()=>vr(e=>e.toggle),Je="wardriving-hexagons",Qe="wardriving-hexagons-fill",cc=8,lc=.7,uc=300,Cr=500,dc=[[15,5,30,255],[35,10,55,255],[55,15,75,255],[75,20,90,255],[95,25,100,255],[115,30,105,255],[135,35,100,255],[155,45,90,255],[175,55,75,255],[195,70,60,255],[210,90,50,255],[225,110,45,255],[235,135,45,255],[245,160,50,255],[250,185,60,255],[252,205,80,255],[254,225,105,255],[255,240,135,255],[255,248,170,255],[255,252,200,255],[255,254,225,255],[255,255,240,255],[255,255,250,255],[255,255,255,255]],mc=[[60,20,120,255],[80,30,140,255],[100,40,160,255],[120,50,170,255],[140,60,175,255],[160,70,175,255],[180,60,150,255],[200,55,120,255],[215,55,90,255],[230,65,60,255],[240,80,40,255],[250,100,30,255],[255,130,30,255],[255,155,35,255],[255,175,40,255],[255,195,50,255],[255,210,60,255],[255,225,70,255],[255,200,40,255],[255,185,30,255],[255,170,20,255],[245,155,15,255],[235,140,10,255],[225,125,5,255]];function fc(e="dark"){var s;if(e==="light")return mc;const n=Uo();return n.length===24&&((s=n[0])==null?void 0:s[0])!==0?n:dc}function Cs(e){return`rgb(${e[0]}, ${e[1]}, ${e[2]})`}function hc(e){return e<.15?e/.15*.1:e>.85?.9+(e-.85)/.15*.1:.1+(e-.15)/.7*.8}function Sr(e,n,s,r){const o=s-n;if(o<.001)return Cs(r[12]);const a=Math.max(0,Math.min(1,(e-n)/o)),c=hc(a),f=Math.min(23,Math.floor(c*24));return Cs(r[f])}function gc(e){const n=new Map;for(const a of e){if(typeof a.lat!="number"||typeof a.lon!="number"||isNaN(a.lat)||isNaN(a.lon))continue;const c=Ba(a.lat,a.lon,cc),f=n.get(c),u=a.weight;f?(f.count++,f.qualitySum+=u):n.set(c,{count:1,qualitySum:u})}const s=[];let r=1/0,o=-1/0;for(const[a,c]of n.entries()){const f=c.qualitySum/c.count;s.push({hexId:a,count:c.count,avgQuality:f}),r=Math.min(r,f),o=Math.max(o,f)}return{cells:s,minQuality:s.length>0?r:0,maxQuality:s.length>0?o:0}}function pc(e,n,s,r){const o=[];for(const a of e){const f=cr(a.hexId).map(([l,m])=>[m,l]);f.push(f[0]);const u=Sr(a.avgQuality,n,s,r);o.push({type:"Feature",properties:{color:u,quality:a.avgQuality,count:a.count},geometry:{type:"Polygon",coordinates:[f]}})}return{type:"FeatureCollection",features:o}}async function xc(e,n,s,r,o){const a=[];let c=0;for(;c<e.length;){if(o.aborted)return null;const f=Math.min(c+Cr,e.length);for(;c<f;c++){const u=e[c],m=cr(u.hexId).map(([g,p])=>[p,g]);m.push(m[0]);const h=Sr(u.avgQuality,n,s,r);a.push({type:"Feature",properties:{color:h,quality:u.avgQuality,count:u.count},geometry:{type:"Polygon",coordinates:[m]}})}c<e.length&&await new Promise(u=>requestAnimationFrame(u))}return{type:"FeatureCollection",features:a}}function yc(e,n){const[s,r]=i.useState(e);return i.useEffect(()=>{const o=setTimeout(()=>r(e),n);return()=>clearTimeout(o)},[e,n]),s}function bc({coveragePoints:e,visible:n,terrainEnabled:s=!1,brightness:r=lc,basemapMode:o="dark"}){const{current:a}=ze(),[c,f]=i.useState(null);i.useEffect(()=>{const T=()=>{var M;const A=(M=a==null?void 0:a.getMap)==null?void 0:M.call(a);A&&!c&&f(A)};T();const L=setInterval(T,50),E=setTimeout(()=>clearInterval(L),5e3);return()=>{clearInterval(L),clearTimeout(E)}},[a,c]);const[u,l]=i.useState(null),[m,h]=i.useState(!1),g=i.useRef({aborted:!1}),p=i.useRef(0),x=i.useRef(o),k=yc(e,uc),b=i.useMemo(()=>fc(o),[o]);i.useEffect(()=>{if(!k||!Array.isArray(k)||k.length===0){queueMicrotask(()=>{l(null),p.current=0});return}const T=x.current!==o;if(k.length===p.current&&u&&!T)return;p.current=k.length,x.current=o,g.current.aborted=!0,g.current={aborted:!1};const L=g.current;h(!0);const{cells:E,minQuality:A,maxQuality:M}=gc(k);if(E.length===0){l(null),h(!1);return}if(E.length<Cr){const I=pc(E,A,M,b);L.aborted||(l(I),h(!1));return}return xc(E,A,M,b,L).then(I=>{!L.aborted&&I&&l(I)}).finally(()=>{L.aborted||h(!1)}),()=>{L.aborted=!0}},[k,b]),i.useEffect(()=>{if(!c)return;const T=()=>{var L,E;try{const A=c.getLayer(Qe),M=c.getSource(Je);if(n&&u&&u.features.length>0){if(M?c.getSource(Je).setData(u):c.addSource(Je,{type:"geojson",data:u}),!A){const I=c.getLayer("topology-weak-edges-native"),O=(E=(L=c.getStyle())==null?void 0:L.layers)==null?void 0:E.find(B=>B.type==="symbol"),_=I?"topology-weak-edges-native":O==null?void 0:O.id;c.addLayer({id:Qe,type:"fill",source:Je,paint:{"fill-color":["get","color"],"fill-opacity":r}},_)}}else A&&c.removeLayer(Qe),M&&c.removeSource(Je)}catch(A){console.warn("[WardrivingHexLayerMapLibre] Layer update error:",A)}};c.isStyleLoaded()?T():c.once("style.load",T)},[c,n,u,s]),i.useEffect(()=>{if(!(!c||!n))try{c.getLayer(Qe)&&c.setPaintProperty(Qe,"fill-opacity",r)}catch{}},[c,r,n]),i.useEffect(()=>()=>{if(c)try{c.getLayer(Qe)&&c.removeLayer(Qe),c.getSource(Je)&&c.removeSource(Je)}catch{}},[c]);const w=(u==null?void 0:u.features.length)??0;return w>0&&n?t.jsx("div",{"data-testid":"wardriving-hexlayer-maplibre-active","data-point-count":(e==null?void 0:e.length)||0,"data-cell-count":w,"data-terrain-enabled":s,"data-is-processing":m,style:{display:"none"}}):null}const Ss="https://s3.amazonaws.com/elevation-tiles-prod/terrarium/{z}/{x}/{y}.png",ws="terrarium",js=256,Ns=14,pt={shadowColor:"rgba(10, 10, 10, 0.6)",highlightColor:"rgba(245, 240, 230, 0.4)",accentColor:"rgba(90, 75, 65, 0.3)",illuminationDirection:315,exaggeration:.35},$e="terrain-dem",lt="hillshade-dem",Ot="terrain-hillshade";function vc({enabled:e,exaggeration:n=4}){const{current:s}=ze(),[r,o]=i.useState(null),a=i.useRef(null);return i.useEffect(()=>{const c=()=>{var m;const l=(m=s==null?void 0:s.getMap)==null?void 0:m.call(s);l&&!r&&o(l)};c();const f=setInterval(c,50),u=setTimeout(()=>clearInterval(f),5e3);return()=>{clearInterval(f),clearTimeout(u)}},[s,r]),i.useEffect(()=>{if(!r)return;let c=!0;const f=()=>{var u,l;if(c)try{if(r.getSource(lt)||r.addSource(lt,{type:"raster-dem",tiles:[Ss],encoding:ws,tileSize:js,maxzoom:Ns}),!r.getLayer(Ot)){const m=(l=(u=r.getStyle())==null?void 0:u.layers)==null?void 0:l.find(h=>h.type==="symbol");r.addLayer({id:Ot,type:"hillshade",source:lt,paint:{"hillshade-shadow-color":pt.shadowColor,"hillshade-highlight-color":pt.highlightColor,"hillshade-accent-color":pt.accentColor,"hillshade-illumination-direction":pt.illuminationDirection,"hillshade-exaggeration":pt.exaggeration}},m==null?void 0:m.id)}r.getSource($e)||r.addSource($e,{type:"raster-dem",tiles:[Ss],encoding:ws,tileSize:js,maxzoom:Ns})}catch(m){console.error("[TerrainLayer] Source/layer setup error:",m)}};return r.isStyleLoaded()?f():(r.once("style.load",f),r.once("load",()=>{c&&!r.getSource(lt)&&f()})),()=>{c=!1}},[r]),i.useEffect(()=>{if(!r)return;let c=!0,f=!1;const u=()=>{if(!(!c||!r.getSource($e)))try{e?(r.setCenterClampedToGround(!1),r.setTerrain({source:$e,exaggeration:n}),r.setMaxPitch(70),!f&&r.getPitch()<30&&!r.isMoving()&&(f=!0,a.current!==null&&clearTimeout(a.current),a.current=window.setTimeout(()=>{a.current=null,c&&!r.isMoving()&&r.getPitch()<30&&r.easeTo({pitch:45,duration:1e3})},200))):(r.setTerrain(null),r.setCenterClampedToGround(!0),r.getPitch()>0&&!r.isMoving()&&r.easeTo({pitch:0,duration:800}),r.setMaxPitch(60))}catch(l){console.error("[TerrainLayer] Terrain state error:",l)}};if(r.isStyleLoaded()&&r.getSource($e))u();else{const l=()=>{r.getSource($e)&&u()};r.once("idle",l)}return()=>{c=!1,a.current!==null&&(clearTimeout(a.current),a.current=null)}},[r,e,n]),i.useEffect(()=>()=>{var c;try{(c=r==null?void 0:r.getStyle)!=null&&c.call(r)&&r.isStyleLoaded()&&(r.setTerrain(null),r.getLayer(Ot)&&r.removeLayer(Ot),r.getSource(lt)&&r.removeSource(lt),r.getSource($e)&&r.removeSource($e))}catch{}},[r]),null}const Cc=.03,Sc=.1,wc=2,jc=3,Nc=.02,kc=3;function Ec(e,n=kc){if(e.length<3||n<=0)return e;let s=e;for(let r=0;r<n;r++){const o=[],a=s.length,c=s[0][0]===s[a-1][0]&&s[0][1]===s[a-1][1],f=c?a-1:a;for(let u=0;u<f;u++){const l=s[u],m=s[(u+1)%f],h=.75*l[0]+.25*m[0],g=.75*l[1]+.25*m[1],p=.25*l[0]+.75*m[0],x=.25*l[1]+.75*m[1];o.push([h,g]),o.push([p,x])}c&&o.length>0&&o.push([o[0][0],o[0][1]]),s=o}return s}function Mc(e,n){let s=1/0,r=-1/0,o=1/0,a=-1/0;for(const[c,f]of e)c<s&&(s=c),c>r&&(r=c),f<o&&(o=f),f>a&&(a=f);return s-=n,r+=n,o-=n,a+=n,{minX:s,minY:o,maxX:r,maxY:a,width:r-s,height:a-o}}function Lc(e,n={}){if(e.length<jc)return{coordinates:[],valid:!1};const{bandwidth:s=Cc,threshold:r=Sc,cellSize:o=wc}=n,a=Mc(e,Nc),c=Math.ceil(a.width/(s/2)),f=Math.ceil(a.height/(s/2)),l=Math.min(1,200/Math.max(c,f)),m=Math.max(10,Math.ceil(c*l)),h=Math.max(10,Math.ceil(f*l)),g=w=>(w-a.minX)/a.width*m,p=w=>(w-a.minY)/a.height*h,x=w=>w/m*a.width+a.minX,k=w=>w/h*a.height+a.minY,b=s/a.width*m;try{const T=Ha().x(_=>g(_[0])).y(_=>p(_[1])).size([m,h]).bandwidth(Math.max(5,b)).cellSize(o)(e);if(T.length===0)return{coordinates:[],valid:!1};const E=Math.max(...T.map(_=>_.value))*r;let A=T[0],M=1/0;for(const _ of T){const B=Math.abs(_.value-E);B<M&&(M=B,A=_)}const I=[];for(const _ of A.coordinates){const B=[];for(const j of _){const $=[];for(const H of j){const P=x(H[0]),z=k(H[1]);$.push([P,z])}if($.length>0){const H=$[0],P=$[$.length-1];(H[0]!==P[0]||H[1]!==P[1])&&$.push([H[0],H[1]])}if($.length>=4){const H=Ec($);B.push(H)}}B.length>0&&I.push(B)}const O=[];for(const _ of I)for(const B of _)O.push(B);return{coordinates:I,valid:I.length>0}}catch(w){return console.warn("[KDE Contour] Failed to generate contour:",w),{coordinates:[],valid:!1}}}function Tc(e,n={}){const s=Lc(e,n);return!s.valid||s.coordinates.length===0?null:s.coordinates.length===1?{type:"Polygon",coordinates:s.coordinates[0]}:{type:"MultiPolygon",coordinates:s.coordinates}}const Rc="mincut-partition",Ac="mincut-partition-fill",Ic="mincut-partition-stroke",_c=3,Dc=.05,Fc=.15,Oc=.008,ks=12;function Es(e,n,s){return(n[0]-e[0])*(s[1]-e[1])-(n[1]-e[1])*(s[0]-e[0])}function Pc(e){if(e.length<3)return e;const n=[...e].sort((o,a)=>o[0]-a[0]||o[1]-a[1]),s=[];for(const o of n){for(;s.length>=2&&Es(s[s.length-2],s[s.length-1],o)<=0;)s.pop();s.push(o)}const r=[];for(let o=n.length-1;o>=0;o--){const a=n[o];for(;r.length>=2&&Es(r[r.length-2],r[r.length-1],a)<=0;)r.pop();r.push(a)}return s.pop(),r.pop(),s.concat(r)}function Bc(e,n){if(e.length<3)return e;let s=0,r=0;for(const[o,a]of e)s+=o,r+=a;return s/=e.length,r/=e.length,e.map(([o,a])=>{const c=o-s,f=a-r,u=Math.sqrt(c*c+f*f);if(u<1e-4)return[o,a];const l=(u+n)/u;return[s+c*l,r+f*l]})}function Hc(e,n,s,r,o){const a=o*o,c=a*o;return[.5*(2*n[0]+(-e[0]+s[0])*o+(2*e[0]-5*n[0]+4*s[0]-r[0])*a+(-e[0]+3*n[0]-3*s[0]+r[0])*c),.5*(2*n[1]+(-e[1]+s[1])*o+(2*e[1]-5*n[1]+4*s[1]-r[1])*a+(-e[1]+3*n[1]-3*s[1]+r[1])*c)]}function $c(e){if(e.length<3)return e;const n=[],s=e.length;for(let r=0;r<s;r++){const o=e[(r-1+s)%s],a=e[r],c=e[(r+1)%s],f=e[(r+2)%s];for(let u=0;u<ks;u++)n.push(Hc(o,a,c,f,u/ks))}return n}function Gc(e){let n=Pc(e);if(n.length<3)return null;n=Bc(n,Oc);const s=$c(n);return{type:"Polygon",coordinates:[[...s,s[0]]]}}function Wc(e,n,s,r){const o=[];for(const[a,c]of e.communities){const f=[];for(const l of c){const m=n.get(l);m&&f.push([m[1],m[0]])}if(f.length<_c)continue;let u=Tc(f,{bandwidth:s,threshold:r});u||(u=Gc(f)),u&&o.push({type:"Feature",properties:{community:a,color:ra(a),borderColor:sa(a),nodeCount:c.length},geometry:u})}return{type:"FeatureCollection",features:o}}function zc({partition:e,nodeCoordinates:n,visible:s,opacity:r=.7,bandwidth:o=Dc,threshold:a=Fc,strokeWidth:c=2}){const f=i.useMemo(()=>e?Wc(e,n,o,a):{type:"FeatureCollection",features:[]},[e,n,o,a]),u=s?r:0,l={"fill-color":["get","color"],"fill-opacity":u},m={"line-color":["get","borderColor"],"line-width":c,"line-opacity":u};return t.jsxs(We,{id:Rc,type:"geojson",data:f,children:[t.jsx(Se,{id:Ac,type:"fill",paint:l}),t.jsx(Se,{id:Ic,type:"line",paint:m})]})}function Uc(e,n=!1,s=!1,r=!1,o=.7,a){const c=Us(a);return r?o>=.75?c.restBright:c.rest:o>=.85?c.rest:(o>=.7,c.restDim)}function Ms(e){return[e[1],e[0]]}function Kc(e,n,s,r=12){const[o,a]=e,[c,f]=n,u=[];for(let l=0;l<=r;l++){const m=l/r,h=a+(f-a)*m,g=o+(c-o)*m,p=4*s*m*(1-m);u.push([h,g,p])}return u}function Ls(e,n,s,r,o,a,c,f,u,l,m,h="dark"){const g=_n(),p=[];let x=1/0,k=-1/0;const b=[];for(const T of e){const L=T.edge.avgConfidence??(n?.7:.5),E=T.edge.certainCount/Math.max(c,1),A=L*.7+E*.3+(n?.5:0);b.push({polyline:T,brightnessScore:A}),x=Math.min(x,A),k=Math.max(k,A)}if(b.length===0)return{type:"FeatureCollection",features:[]};const w=k-x||1;b.sort((T,L)=>T.brightnessScore-L.brightnessScore);for(const{polyline:T,brightnessScore:L}of b){const{from:E,to:A,edge:M}=T,I=s.get(M.key)??0;if(I<=0)continue;const O=f.has(M.key),_=u.has(M.key),B=M.avgConfidence??(n?.7:.5),j=l===M.key,$=m[M.fromHash],H=m[M.toHash],P=($==null?void 0:$.node_name)||($==null?void 0:$.name)||M.fromHash.slice(0,8),z=(H==null?void 0:H.node_name)||(H==null?void 0:H.name)||M.toHash.slice(0,8),y=[E[0]+(A[0]-E[0])*I,E[1]+(A[1]-E[1])*I];let C;if(!n)C=1.5;else{const Y=a.get(M.key)??gn(M.certainCount),U=o.get(M.key)??Y;C=U+(Y-U)*r,j?C=Math.max(C*1.6,4.5):_&&(C=C*1.3)}let S;j?S=g.edges.highlight:S=Uc(!1,M.isDirectPathEdge??!1,O,_,B,h);let R;j?R=g.edges.highlight:M.isDirectPathEdge?R=g.edges.hoverDirect:O?R=g.edges.hoverLoop:R=g.edges.hoverStandard;let D;if(!n)D=(.3+B*.3)*I;else{const Y=Math.min(I*1.5,1)*g.edgeOpacity;D=_?Y*1.15:Y}j&&(D=.95);const q=(L-x)/w;p.push({type:"Feature",properties:{key:M.key,baseColor:S,hoverColor:R,baseWidth:C,baseOpacity:D,brightnessScore:q,isLoopEdge:O,isBackbone:_,isDirectPath:M.isDirectPathEdge??!1,isHubConnection:M.isHubConnection??!1,isZeroHop:M.isZeroHop??!1,isValidated:n,certainCount:M.certainCount,confidence:B,symmetryRatio:M.symmetryRatio??1,dominantDirection:M.dominantDirection??"balanced",fromName:P,toName:z,fromHash:M.fromHash,toHash:M.toHash},geometry:{type:"LineString",coordinates:[Ms(E),Ms(y)]}})}return{type:"FeatureCollection",features:p}}const qc=150,Vc=8;function Ts(e,n){const s=_n(),r=[];let o=0;for(const a of e){const c=n.get(a.hash);c&&c.blendedScore>o&&(o=c.blendedScore)}for(const a of e){const{from:c,to:f,hash:u,neighbor:l,lastHopData:m}=a,h=`neighbor-${u}`,g=(m==null?void 0:m.avgRssi)??l.rssi??null,p=(m==null?void 0:m.avgSnr)??l.snr??null,x=(m==null?void 0:m.count)??0,k=(m==null?void 0:m.confidence)??1,b=n.get(u),w=(b==null?void 0:b.listenerScore)??0,T=(b==null?void 0:b.loudScore)??0,L=(b==null?void 0:b.blendedScore)??0,E=o>0?L/o:0,A=a.rxAdvertCount??0,M=a.txProxyCount??0,I=A+M,O=I>0?(M-A)/I:0,_=Kc(c,f,qc,Vc);r.push({type:"Feature",properties:{key:h,hash:u,name:l.node_name||l.name||u.slice(0,8),prefix:u.slice(2,4).toUpperCase(),color:s.neighborColor,width:2.5,opacity:.85,rssi:g,snr:p,packetCount:x,confidence:k,hasAvgRssi:(m==null?void 0:m.avgRssi)!==void 0,hasAvgSnr:(m==null?void 0:m.avgSnr)!==void 0,isNeighborEdge:!0,listenerScore:w,loudScore:T,blendedScore:L,trafficWeight:E,linkAsymmetry:O,rxAdvertCount:A,txProxyCount:M},geometry:{type:"LineString",coordinates:_}})}return{type:"FeatureCollection",features:r}}function Yc({map:e,showTopology:n,validatedPolylines:s,weakPolylines:r,maxCertainCount:o,loopEdgeKeys:a,backboneEdgeKeys:c,highlightedEdgeKey:f,neighbors:u,validatedSourceId:l,weakSourceId:m,neighborPolylines:h=[],showNeighborLines:g=!0,neighborSourceId:p,neighborLinkScores:x=new Map,basemapMode:k}){const b=i.useRef(null);i.useEffect(()=>{const V=e&&"current"in e?e.current:e;b.current=V});const w=i.useRef(new Map),T=i.useRef(1),L=i.useRef(new Map),E=i.useRef(new Map),A=i.useRef(!1),M=i.useRef(null),I=i.useRef(n),O=i.useRef(new Set),_=i.useRef(""),B=i.useRef(new Map),j=i.useRef(""),$=i.useRef(""),H=i.useRef(""),P=i.useRef(s),z=i.useRef(r),y=i.useRef(o),C=i.useRef(a),S=i.useRef(c),R=i.useRef(f),D=i.useRef(u),q=i.useRef(h),Y=i.useRef(g),U=i.useRef(x),G=i.useRef(k);i.useEffect(()=>{P.current=s,z.current=r,y.current=o,C.current=a,S.current=c,R.current=f,D.current=u,q.current=h,Y.current=g,U.current=x,G.current=k},[s,r,o,a,c,f,u,h,g,x,k]);const W=i.useCallback((V=!1)=>{var oe,ne,Q,ae,ye,be,je,st,de,Te;const Z=b.current;if(!Z)return;const te=Z.getSource(l),ue=Z.getSource(m),ee=Z.getSource(p);if(te){const ie=Ls(P.current,!0,w.current,T.current,L.current,E.current,y.current,C.current,S.current,R.current,D.current,G.current),ce=`${ie.features.length}:${((ne=(oe=ie.features[0])==null?void 0:oe.properties)==null?void 0:ne.key)??""}:${((ae=(Q=ie.features[ie.features.length-1])==null?void 0:Q.properties)==null?void 0:ae.key)??""}:${Array.from(w.current.values()).reduce((Re,Ae)=>Re+Ae,0).toFixed(2)}`;(V||ce!==j.current)&&(te.setData(ie),j.current=ce)}if(ue){const ie=Ls(z.current,!1,w.current,T.current,L.current,E.current,y.current,C.current,S.current,R.current,D.current,G.current),ce=`${ie.features.length}:${((be=(ye=ie.features[0])==null?void 0:ye.properties)==null?void 0:be.key)??""}:${((st=(je=ie.features[ie.features.length-1])==null?void 0:je.properties)==null?void 0:st.key)??""}`;(V||ce!==$.current)&&(ue.setData(ie),$.current=ce)}if(ee&&q.current.length>0){const ie=Ts(q.current,U.current),ce=`${ie.features.length}:${((Te=(de=ie.features[0])==null?void 0:de.properties)==null?void 0:Te.hash)??""}`;(V||ce!==H.current)&&(ee.setData(ie),H.current=ce)}},[l,m,p]),re=i.useCallback(()=>{M.current&&(cancelAnimationFrame(M.current),M.current=null),w.current=new Map,T.current=1,L.current=new Map,E.current=new Map,A.current=!1,O.current=new Set,_.current="",B.current=new Map},[]);i.useEffect(()=>{const V=I.current,Z=n;if(I.current=n,!!b.current){if(M.current&&(cancelAnimationFrame(M.current),M.current=null),V&&!Z&&!A.current){A.current=!0;const ue=new Map(w.current);let ee=null;const oe=ne=>{ee||(ee=ne);const Q=ne-ee,ae=Math.min(Q/Xa,1),ye=lr(ae);for(const[be,je]of ue)w.current.set(be,je*(1-ye));W(!0),ae<1?M.current=requestAnimationFrame(oe):(A.current=!1,w.current=new Map,O.current=new Set,_.current="",L.current=new Map,E.current=new Map,M.current=null,W(!0))};M.current=requestAnimationFrame(oe)}!V&&Z&&(w.current=new Map,O.current=new Set,_.current="")}},[n,W]),i.useEffect(()=>{const V=b.current;if(!n||A.current||!V)return;const Z=[...s,...r],te=Z.map(Q=>`${Q.edge.key}:${Q.edge.certainCount}`).sort().join(","),ue=O.current.size===0,ee=_.current!==""&&_.current!==te;if(!ue&&!ee){W();return}const oe=[],ne=[];for(const{edge:Q}of Z)O.current.has(Q.key)?ne.push(Q.key):oe.push(Q.key);ee&&ne.length>0&&(L.current=new Map(B.current),T.current=0),E.current=new Map;for(const{edge:Q}of s){const ae=gn(Q.certainCount);E.current.set(Q.key,ae)}for(const Q of oe)w.current.set(Q,0);for(const Q of ne)w.current.has(Q)||w.current.set(Q,1);if(oe.length>0||ee&&ne.length>0){M.current&&(cancelAnimationFrame(M.current),M.current=null);let Q=null;const ae=Math.min(100,Lt/Math.max(oe.length,1)/2),ye=be=>{Q||(Q=be);const je=be-Q;for(let de=0;de<oe.length;de++){const Te=oe[de],ie=de*ae,ce=Math.max(0,je-ie),Re=Math.min(ce/Lt,1);w.current.set(Te,hn(Re))}if(ee&&ne.length>0){const de=Math.min(je/Lt,1);T.current=hn(de)}W(!0);const st=Lt+(oe.length-1)*ae;je<st?M.current=requestAnimationFrame(ye):M.current=null};M.current=requestAnimationFrame(ye)}else W();for(const Q of oe)O.current.add(Q);for(const{edge:Q}of s){const ae=gn(Q.certainCount);B.current.set(Q.key,ae)}_.current=te},[n,s,r,o,W]),i.useEffect(()=>{const V=b.current;if(!V||!p)return;const Z=()=>{const ee=V.getSource(p);if(!ee)return!1;if(h.length>0){const oe=Ts(h,x);ee.setData(oe)}else ee.setData({type:"FeatureCollection",features:[]});return!0};if(Z())return;const te=ee=>{ee.sourceId===p&&Z()&&V.off("sourcedata",te)};V.on("sourcedata",te);const ue=()=>{Z()&&(V.off("styledata",ue),V.off("sourcedata",te))};return V.on("styledata",ue),()=>{V.off("sourcedata",te),V.off("styledata",ue)}},[p,h,x]);const se=i.useRef(k);return i.useEffect(()=>{k!==se.current&&(se.current=k,j.current="",$.current="",H.current="",W(!0))},[k,W]),i.useEffect(()=>()=>{M.current&&(cancelAnimationFrame(M.current),M.current=null)},[]),{isExiting:A.current,isAnimating:M.current!==null,resetAnimationState:re,weightAnimProgress:T.current,animStartWeights:L.current,animTargetWeights:E.current}}function Zc({activeFilters:e,neighborHashes:n,hubConnectedNodes:s,directNodeSet:r,localConnectedNodes:o,nodeTypeMap:a,showTopology:c}){const[f,u]=i.useState(new Map),l=i.useMemo(()=>[...e].sort().join(","),[e]),m=i.useRef(l),h=i.useRef(!1),g=i.useRef(new Map),p=i.useRef(null),x=i.useRef(s),k=i.useRef(r),b=i.useRef(o),w=i.useRef(a),T=i.useRef(c);return i.useEffect(()=>{x.current=s,k.current=r,b.current=o,w.current=a,T.current=c},[s,r,o,a,c]),i.useEffect(()=>{const E=m.current,A=l;if(m.current=l,E===A)return;p.current&&(cancelAnimationFrame(p.current),p.current=null);const M=new Set(E?E.split(",").filter(Boolean):[]),I=e,O=x.current,_=k.current,B=w.current;for(const y of n)g.current.has(y)||g.current.set(y,Math.random());const j=(y,C)=>{if(C.size===0)return!1;const S=B.get(y)??"unknown";return!!(C.has("repeater")&&S==="repeater"||C.has("companion")&&(S==="companion"||S==="unknown")||C.has("room_server")&&S==="room_server"||C.has("direct")&&_.has(y)||C.has("hubs")&&O.has(y))},$=[];for(const y of n){const C=j(y,M),S=j(y,I);C!==S&&$.push({hash:y,startOpacity:C?1:0,targetOpacity:S?1:0})}if($.length===0)return;h.current=!0,u(y=>{const C=new Map(y);for(const{hash:S,startOpacity:R}of $)C.set(S,R);return C});const H=$;let P=null;const z=y=>{P||(P=y);const C=y-P;let S=!0;u(()=>{const D=new Map;for(const{hash:q,startOpacity:Y,targetOpacity:U}of H){const G=(g.current.get(q)??0)*os,W=Math.max(0,C-G),re=Math.min(W/rs,1),se=hn(re),V=Y+(U-Y)*se;D.set(q,V),re<1&&(S=!1)}return D});const R=rs+os;C<R&&!S?p.current=requestAnimationFrame(z):(p.current=null,h.current=!1,u(new Map))};return p.current=requestAnimationFrame(z),()=>{p.current&&(cancelAnimationFrame(p.current),p.current=null),h.current=!1}},[l,e,n]),{nodeOpacities:f,getNodeOpacity:(E,A)=>h.current&&f.has(E)?f.get(E):A?1:0}}const cn=240,Rs=240;function Jc(e,n){if(e<cn)return .5;if(e<cn+Rs)return 1;const s=cn+Rs,r=n-s,o=(e-s)/r;return Math.max(0,.33*(1-o))}function Qc(e){const n=new Map;for(const s of Object.keys(e)){const r=Ct(s);n.has(r)||n.set(r,s)}return n}function Xc(e,n,s){const r=s?Ct(s):null,o=[];for(const a of e){if(r&&a.toUpperCase()===r){s&&o.push(s);continue}const c=n.get(a.toUpperCase());c&&o.push(c)}return o}function el({neighbors:e,localHash:n,enabled:s=!0}){const[r,o]=i.useState(new Map),a=pn(),c=i.useRef(a);i.useEffect(()=>{c.current=a},[a]);const f=i.useRef(0),u=i.useRef(null),l=i.useRef(new Map),m=i.useRef(new Map);i.useEffect(()=>{m.current=Qc(e)},[e]);const h=i.useRef(null);return i.useEffect(()=>{const g=()=>{const p=performance.now(),x=l.current;if(x.size===0){u.current=null,o(new Map);return}const k=new Map,b=[];for(const[w,{startTime:T,staggerDelay:L}]of x){const E=p-T-L;if(!(E<0))if(E>=Tt)b.push(w);else{const A=Jc(E,Tt);A>0&&k.set(w,A)}}for(const w of b)x.delete(w);o(k),x.size>0&&h.current?u.current=requestAnimationFrame(h.current):u.current=null};h.current=g},[]),i.useEffect(()=>{if(!s)return;const g=c.current;if(g.length===0)return;const p=f.current,x=g.filter(T=>(T.timestamp??0)>p);if(p===0){const T=g.reduce((L,E)=>Math.max(L,E.timestamp??0),0);f.current=T;return}if(x.length===0)return;const k=x.reduce((T,L)=>Math.max(T,L.timestamp??0),0);f.current=k;const b=performance.now();let w=0;for(const T of x){const L=Zs(T,n);if(!L||L.original.length===0)continue;const E=Xc(L.original,m.current,n);if(E.length===0)continue;const A=Tt*.5;for(let M=0;M<E.length;M++){const I=E[M];l.current.has(I)||l.current.set(I,{startTime:b,staggerDelay:w+M*A})}w+=Tt*.3}u.current===null&&h.current&&(u.current=requestAnimationFrame(h.current))},[a,n,s]),i.useEffect(()=>()=>{u.current!==null&&(cancelAnimationFrame(u.current),u.current=null)},[]),{blinkingNodes:r,blinkColor:Qa}}const Ge="edge-blink-source",et="edge-blink-layer",vn=1e3,Cn=1e3,ln=150,tl=175,nl=3e4,sl=Ce.teal,rl="#8B7BAD",ol=2.5,al=1.875,il=.5,zt="node-markers-layer";function cl(e){if(!e.getLayer(et))return;const n=e.getLayer(zt)?zt:void 0;try{e.moveLayer(et,n)}catch{}}function ll(e,n){const s=new Map;for(const r of Object.keys(e)){const o=Ct(r);s.has(o)||s.set(o,r)}if(n){const r=Ct(n);s.set(r,n)}return s}function ul(e){return e<0||e>=vn?0:1-e/vn}function dl(e){if(e<0||e>=Cn)return 0;const n=e/Cn;return Math.pow(1-n,3)}function Pt(e){return[e[1],e[0]]}function ml({map:e,nodeCoordinates:n,packets:s,localHash:r,neighbors:o,meshTopology:a,enabled:c=!0}){const f=i.useRef(null),u=e&&"current"in e?e.current:e;i.useEffect(()=>{f.current=u},[u]);const l=i.useRef(!1),m=i.useRef(null),h=i.useRef([]),g=i.useRef(0),p=i.useRef(!1),[x,k]=i.useState(!1),b=i.useRef(null),w=i.useRef([]),T=i.useRef(new Map),L=i.useRef(n);i.useEffect(()=>{L.current=n},[n]),i.useEffect(()=>{T.current=ll(o,r)},[o,r]),i.useEffect(()=>{if(!c){b.current&&(clearTimeout(b.current),b.current=null),w.current=[],m.current!==null&&(cancelAnimationFrame(m.current),m.current=null),h.current=[];const I=f.current;if(I&&l.current){const O=I.getSource(Ge);O&&O.setData({type:"FeatureCollection",features:[]})}p.current=!1,g.current=0}},[c]),i.useEffect(()=>{const I=u;if(!I)return;let O=null,_=!1;const B=()=>{if(!_&&!l.current)try{I.getLayer(et)&&I.removeLayer(et),I.getSource(Ge)&&I.removeSource(Ge),I.addSource(Ge,{type:"geojson",data:{type:"FeatureCollection",features:[]}});const j=I.getLayer(zt)?zt:void 0;I.addLayer({id:et,type:"line",source:Ge,layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":["case",["any",["==",["get","isSpeculative"],!0],["==",["get","isSpeculative"],"true"]],rl,sl],"line-width":["case",["any",["==",["get","isSpeculative"],!0],["==",["get","isSpeculative"],"true"]],al,ol],"line-opacity":["*",["get","opacityMult"],["interpolate",["linear"],["get","intensity"],0,0,.1,.8,.5,1,1,1]]}},j),l.current=!0,k(!0),O&&(clearInterval(O),O=null)}catch{}};return I.isStyleLoaded()&&B(),I.once("style.load",()=>{B()}),l.current||(O=setInterval(()=>{if(l.current){O&&clearInterval(O);return}B()},100),setTimeout(()=>{O&&(clearInterval(O),O=null)},5e3)),()=>{_=!0,O&&clearInterval(O),m.current!==null&&(cancelAnimationFrame(m.current),m.current=null);const j=f.current;if(j&&l.current){try{j.getLayer(et)&&j.removeLayer(et),j.getSource(Ge)&&j.removeSource(Ge)}catch{}l.current=!1,k(!1)}}},[u]);const E=i.useRef(()=>{});i.useEffect(()=>{E.current=()=>{const I=f.current;if(!I)return;const O=I.getSource(Ge);if(!O)return;const _=performance.now(),B=h.current,j=[],$=[];for(const H of B){const P=_-H.startTime-H.delay,z=H.isSpeculative?Cn:vn;if(P<z){$.push(H);const y=H.isSpeculative?dl(P):ul(P);y>0&&j.push({type:"Feature",properties:{intensity:y,opacityMult:H.isSpeculative?il:1,isSpeculative:H.isSpeculative??!1},geometry:{type:"LineString",coordinates:[H.fromCoord,H.toCoord]}})}}O.setData({type:"FeatureCollection",features:j}),h.current=$,$.length>0?m.current=requestAnimationFrame(()=>E.current()):m.current=null}},[]);const A=i.useCallback(()=>{const I=f.current;I&&cl(I),m.current===null&&(m.current=requestAnimationFrame(()=>E.current()))},[]),M=i.useCallback(()=>{if(!f.current||!l.current)return;const O=w.current;if(w.current=[],b.current=null,O.length===0)return;const _=T.current,B=L.current;if(_.size===0)return;const j=performance.now();let $=0,H=!1;const P=new Set;for(const z of O){const y=Zs(z,r);if(!y||y.original.length<2)continue;const C=y.original;let S=0,R=null;for(let U=0;U<C.length-1;U++){const G=C[U].toUpperCase(),W=C[U+1].toUpperCase(),re=_.get(G),se=_.get(W);if(!re||!se)continue;const V=B.get(re),Z=B.get(se);if(!V||!Z)continue;const te=[re,se].sort().join("-");h.current.push({edgeKey:te,fromCoord:Pt(V),toCoord:Pt(Z),startTime:j,delay:$+S*ln}),P.add(te),R=se,S++,H=!0}const D=z.route??z.route_type;if(Ko(D)&&R&&!(R===r)&&(a!=null&&a.edgeMap)){const U=[];for(const[G,W]of a.edgeMap){if(!(W.fromHash===R||W.toHash===R)||P.has(G))continue;const se=W.fromHash===R?W.toHash:W.fromHash,V=B.get(R),Z=B.get(se);!V||!Z||U.push({edgeKey:G,otherHash:se,confidence:W.avgConfidence??0})}if(U.length>0){U.sort((se,V)=>V.confidence-se.confidence);const G=Math.max(1,Math.ceil(U.length*.25)),W=U.slice(0,G),re=$+S*ln;for(const{edgeKey:se,otherHash:V}of W){const Z=B.get(R),te=B.get(V);h.current.push({edgeKey:se,fromCoord:Pt(Z),toCoord:Pt(te),startTime:j,delay:re,isSpeculative:!0}),P.add(se),H=!0}}}S>0&&($+=S*ln*.5)}H&&A()},[r,a,A]);i.useEffect(()=>{const I=f.current;if(!c||!I||!x||s.length===0)return;const O=Date.now(),_=g.current;if(!p.current){p.current=!0;const $=(O-nl)/1e3,H=s.filter(z=>(z.timestamp??0)>=$);let P=0;for(const z of s){const y=z.timestamp??0;y>P&&(P=y)}if(g.current=P,H.length>0){H.sort((y,C)=>(y.timestamp??0)-(C.timestamp??0));const z=H.slice(-20);w.current.push(...z),M()}return}const B=s.filter($=>($.timestamp??0)>_);if(B.length===0)return;let j=0;for(const $ of B){const H=$.timestamp??0;H>j&&(j=H)}g.current=j,w.current.push(...B),b.current&&clearTimeout(b.current),b.current=setTimeout(M,tl)},[c,s,M,x]),i.useEffect(()=>()=>{b.current&&clearTimeout(b.current)},[])}const wr=[{target:"Sparklines",fn:"sparklines",minStage:2}];zs(wr);const fl=i.memo(function({nodeHash:n,width:s=60,height:r=20,color:o,showArea:a=!0,showTooltip:c=!1,className:f=""}){Ws(wr);const u=qo(n),l=Vo(),h=!Js().backgroundLoadComplete||l,g=typeof s=="number"?s:60;return t.jsx(Ua,{data:u,width:g,height:r,color:o,isLoading:h,className:f})});function hl(e){return e===null?"—":e<1e3?`${Math.round(e)}m`:`${(e/1e3).toFixed(1)}km`}function gl(e){const n=new Date(e*1e3);return`${(n.getMonth()+1).toString().padStart(2,"0")}/${n.getDate().toString().padStart(2,"0")}`}function pl({txDelayRec:e,onRemove:n}){const[s,r]=i.useState(!1),o=e.floodFactor??e.txDelayFactor,a=e.directFactor??e.directTxDelayFactor,c=async()=>{const f=`set txdelay ${o.toFixed(1)}
set direct.txdelay ${a.toFixed(1)}`;try{await navigator.clipboard.writeText(f),r(!0),setTimeout(()=>r(!1),1500)}catch{const l=document.createElement("textarea");l.value=f,l.style.position="fixed",l.style.opacity="0",document.body.appendChild(l),l.select();try{document.execCommand("copy"),r(!0),setTimeout(()=>r(!1),1500)}catch{console.error("Failed to copy")}document.body.removeChild(l)}};return t.jsxs("div",{className:"flex items-center gap-2 text-xs",children:[t.jsxs("button",{onClick:c,className:"flex items-center gap-2 flex-1 py-1 px-1.5 bg-sys-amber/5 hover:bg-sys-amber/10 rounded transition-colors group",title:"Click to copy CLI commands",children:[t.jsx(Da,{className:"w-3 h-3 text-sys-amber shrink-0"}),t.jsx("span",{className:"text-fg-muted",children:"TxDelay"}),t.jsxs("div",{className:"flex gap-2",children:[t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx("span",{className:"text-fg-muted",children:"F"}),t.jsxs("span",{className:"data-box data-box-compact text-sys-amber",children:["×",o.toFixed(1)]})]}),t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx("span",{className:"text-fg-muted",children:"D"}),t.jsxs("span",{className:"data-box data-box-compact text-sys-amber",children:["×",a.toFixed(1)]})]})]}),s?t.jsx(An,{className:"w-3 h-3 text-sys-green ml-auto"}):t.jsx(In,{className:"w-3 h-3 text-fg-muted opacity-0 group-hover:opacity-100 transition-opacity ml-auto"})]}),n&&t.jsx("button",{onClick:n,className:"p-1 text-fg-secondary hover:text-sys-red hover:bg-sys-red/10 rounded transition-colors",title:"Remove from contacts",children:t.jsx(Rn,{className:"w-3.5 h-3.5"})})]})}function xl({hash:e,hashPrefix:n,name:s,isHub:r,isGateway:o,isBackbone:a,isZeroHop:c,isMobile:f,isRoomServer:u,isStale:l,lastSeenTimestamp:m,centrality:h,affinity:g,meanSnr:p,meanRssi:x,neighbor:k,onRemove:b,txDelayRec:w}){const[T,L]=i.useState(!1),E=async()=>{try{await navigator.clipboard.writeText(e),L(!0),setTimeout(()=>L(!1),1500)}catch(_){console.error("Failed to copy hash:",_);const B=document.createElement("textarea");B.value=e,B.style.position="fixed",B.style.opacity="0",document.body.appendChild(B),B.select();try{document.execCommand("copy"),L(!0),setTimeout(()=>L(!1),1500)}catch{console.error("Fallback copy also failed")}document.body.removeChild(B)}},A=c?"Direct":g!=null&&g.typicalHopPosition?`${g.typicalHopPosition}-hop`:null,M=w&&!w.insufficientData,I={hub:"Hub: High-connectivity node that bridges many paths",backbone:"Backbone: Critical relay with high traffic",relay:"Relay: Standard forwarding node",edge:"Edge: Peripheral node"},O={high:"1000+ packets",medium:"500-999 packets",low:"100-499 packets",insufficient:"Insufficient data"};return t.jsxs("div",{className:"w-[240px] pr-2",children:[t.jsx("div",{className:"text-[14px] font-semibold text-fg-primary leading-tight truncate mb-1",children:s}),t.jsxs("div",{className:"flex items-center gap-1 flex-wrap mb-1.5",children:[t.jsx("code",{className:"type-data-xs text-fg-secondary bg-data-box-bg border border-data-box-border px-1 py-0.5 rounded",children:n}),t.jsx("button",{onClick:E,className:"p-0.5 hover:bg-subtle-fill-hover rounded transition-colors",title:"Copy full hash",children:T?t.jsx(An,{className:"w-3 h-3 text-sys-green"}):t.jsx(In,{className:"w-3 h-3 text-fg-secondary"})}),t.jsx(Ka,{hash:e,size:"sm"}),A&&t.jsx(Me,{color:c?ns.direct:ns.multihop,compact:!0,children:A}),k.is_repeater&&t.jsx(Me,{color:ot.repeater,compact:!0,children:"Rptr"}),r&&t.jsx(Me,{color:ot.hub,compact:!0,title:"Hub: ≥10% of last-hop traffic",children:"Hub"}),o&&!r&&t.jsx(Me,{color:ot.gateway,compact:!0,title:"Gateway: 7-10% of last-hop traffic",children:"Gate"}),a&&t.jsx(Me,{color:ot.backbone,compact:!0,title:"Backbone",children:"Bone"}),f&&t.jsx(Me,{color:ot.mobile,compact:!0,children:"Mobile"}),u&&t.jsx(Me,{color:ot.room,compact:!0,children:"Room"}),l&&m&&t.jsxs(Me,{compact:!0,title:"Neighbor not heard in 7+ days",children:["Idle ",gl(m)]})]}),t.jsxs("div",{className:"flex items-center gap-2 text-xs text-fg-secondary mb-1.5",children:[t.jsxs("span",{className:"flex items-center gap-0.5",children:[t.jsx(ar,{className:"w-3 h-3 text-fg-muted shrink-0"}),t.jsx("span",{className:"font-mono",children:Vs(k.last_seen)})]}),(g==null?void 0:g.distanceMeters)&&t.jsxs("span",{className:"flex items-center gap-0.5",children:[t.jsx(Ia,{className:"w-3 h-3 text-fg-muted shrink-0"}),t.jsx("span",{className:"font-mono font-semibold text-fg-primary",children:hl(g.distanceMeters)})]}),k.latitude&&k.longitude&&k.latitude!==0&&k.longitude!==0&&t.jsxs("span",{className:"flex items-center gap-0.5",children:[t.jsx(_a,{className:"w-3 h-3 text-fg-muted shrink-0"}),t.jsxs("span",{className:"font-mono text-fg-muted",children:[k.latitude.toFixed(2),", ",k.longitude.toFixed(2)]})]})]}),t.jsx("div",{className:"mb-1.5",style:{width:224},children:t.jsx(fl,{nodeHash:e,width:224,height:26,showArea:!0,showTooltip:!0})}),t.jsxs("div",{className:"flex gap-3 text-xs mb-1.5",children:[t.jsxs("div",{className:"flex-1 space-y-1",children:[t.jsxs("div",{className:"flex justify-between items-center gap-2",children:[t.jsx("span",{className:"text-fg-muted",children:"Packets"}),t.jsx("span",{className:"data-box data-box-compact",children:(g==null?void 0:g.frequency)||0})]}),c&&p!==void 0&&t.jsxs("div",{className:"flex justify-between items-center gap-2",children:[t.jsx("span",{className:"text-fg-muted",children:"SNR"}),t.jsxs("span",{className:"data-box data-box-compact",children:[p.toFixed(1)," dB"]})]}),M&&w.networkRole&&t.jsxs("div",{className:"flex justify-between items-center gap-2",children:[t.jsx("span",{className:"text-fg-muted",children:"Role"}),t.jsx(Me,{color:Wa[w.networkRole],compact:!0,title:I[w.networkRole],children:w.networkRole})]})]}),t.jsxs("div",{className:"flex-1 space-y-1",children:[t.jsxs("div",{className:"flex justify-between items-center gap-2",children:[t.jsx("span",{className:"text-fg-muted",children:"Adverts"}),t.jsx("span",{className:"data-box data-box-compact",children:k.advert_count||0})]}),c&&x!==void 0&&t.jsxs("div",{className:"flex justify-between items-center gap-2",children:[t.jsx("span",{className:"text-fg-muted",children:"RSSI"}),t.jsxs("span",{className:"data-box data-box-compact",children:[Math.round(x)," dBm"]})]}),M&&w.dataConfidence&&t.jsxs("div",{className:"flex justify-between items-center gap-2",children:[t.jsx("span",{className:"text-fg-muted",children:"Data"}),t.jsx(Me,{color:za[w.dataConfidence],compact:!0,title:O[w.dataConfidence],children:w.dataConfidence})]})]}),!M&&b&&t.jsx("button",{onClick:b,className:"p-1 self-start text-fg-secondary hover:text-sys-red hover:bg-sys-red/10 rounded transition-colors",title:"Remove from contacts",children:t.jsx(Rn,{className:"w-3.5 h-3.5"})})]}),M&&t.jsx(pl,{txDelayRec:w,onRemove:b})]})}const Bt="node-markers-native",Sn="node-markers-layer",wn="node-markers-layer-local",J={standard:"marker-standard",standardNeighbor:"marker-standard-neighbor",hub:"marker-hub",hubNeighbor:"marker-hub-neighbor",gateway:"marker-gateway",gatewayNeighbor:"marker-gateway-neighbor",mobile:"marker-mobile",mobileNeighbor:"marker-mobile-neighbor",roomServer:"marker-room-server",roomServerNeighbor:"marker-room-server-neighbor",local:"marker-local",stale5Day:"marker-stale-5day",stale10Day:"marker-stale-10day",blinkBlack:"marker-blink-black",blinkBlackLocal:"marker-blink-black-local",blink:"marker-blink",blinkLocal:"marker-blink-local"},yl=10,bl=6,vl=5,Cl=10,As={tier1:De[500],tier2:De[700]};function Sl(e){if(!e)return 0;const n=Date.now(),s=e*1e3,r=(n-s)/(1e3*60*60*24);return r>=Cl?2:r>=vl?1:0}const xe=2,wl=dr*xe,Is=xn*xe;function jl(e){const n=En(),s=(f,u,l=0,m=!1)=>{const h=wl,g=document.createElement("canvas");g.width=h,g.height=h;const p=g.getContext("2d",m?{colorSpace:"display-p3"}:void 0),x=h/2,k=h/2,b=h/2-2-l/2;return p.beginPath(),p.arc(x,k,b,0,Math.PI*2),p.fillStyle=f,p.fill(),u&&l>0&&(p.strokeStyle=u,p.lineWidth=l*xe,p.stroke()),p.shadowColor="rgba(0,0,0,0.3)",p.shadowBlur=2*xe,p.shadowOffsetY=1*xe,{data:p.getImageData(0,0,h,h),pixelRatio:xe}},r=(f,u=!1)=>{const l=Is,m=document.createElement("canvas");m.width=l,m.height=l;const h=m.getContext("2d",u?{colorSpace:"display-p3"}:void 0),g=l/2,p=l/2,x=xn*.35*xe;return h.strokeStyle=f,h.lineWidth=2.5*xe,h.lineCap="round",h.lineJoin="round",h.beginPath(),h.moveTo(g-x,p),h.lineTo(g,p-x),h.lineTo(g+x,p),h.stroke(),h.beginPath(),h.moveTo(g-x*.7,p),h.lineTo(g-x*.7,p+x*.7),h.lineTo(g+x*.7,p+x*.7),h.lineTo(g+x*.7,p),h.stroke(),h.beginPath(),h.moveTo(g-x*.2,p+x*.7),h.lineTo(g-x*.2,p+x*.2),h.lineTo(g+x*.2,p+x*.2),h.lineTo(g+x*.2,p+x*.7),h.stroke(),{data:h.getImageData(0,0,l,l),pixelRatio:xe}},o=(f,u)=>{const l=Is,m=document.createElement("canvas");m.width=l,m.height=l;const h=m.getContext("2d"),g=l/2,p=l/2,x=xn*.35*xe;return h.strokeStyle=f,h.lineWidth=2.5*xe,h.lineCap="round",h.lineJoin="round",u&&(h.fillStyle=u),h.beginPath(),h.roundRect(g-x,p-x*.6,x*1.6,x*1.2,3*xe),u&&h.fill(),h.stroke(),h.beginPath(),h.moveTo(g-x*.3,p+x*.6),h.lineTo(g-x*.6,p+x),h.lineTo(g,p+x*.6),h.stroke(),{data:h.getImageData(0,0,l,l),pixelRatio:xe}},a="#00FF00",c={[J.standard]:s(n.nodeFill),[J.standardNeighbor]:s(n.neighborColor),[J.hub]:s(n.hubColor),[J.hubNeighbor]:s(n.neighborColor),[J.gateway]:s(n.gatewayColor),[J.gatewayNeighbor]:s(n.neighborColor),[J.mobile]:s("transparent",n.mobileColor,2.5),[J.mobileNeighbor]:s(n.neighborColor),[J.roomServer]:o(n.roomColor),[J.roomServerNeighbor]:o(n.neighborColor,"#1a1a1c"),[J.local]:r(n.localColor),[J.stale5Day]:s(As.tier1),[J.stale10Day]:s(As.tier2),[J.blinkBlack]:s("#000000"),[J.blinkBlackLocal]:r("#000000"),[J.blink]:s(a,void 0,0,!0),[J.blinkLocal]:r(a,!0)};for(const[f,u]of Object.entries(c))try{e.hasImage(f)&&e.removeImage(f),e.addImage(f,u.data,{pixelRatio:u.pixelRatio})}catch{}}function _s(e){var s;const n=(s=e.contact_type)==null?void 0:s.toLowerCase();return n==="room server"||n==="room_server"||n==="room"||n==="server"}function un(e){return e.startsWith("0x")?e.slice(2,4).toUpperCase():e.slice(0,2).toUpperCase()}function Nl({neighborsWithLocation:e,localNode:n,localHash:s,zeroHopNeighbors:r,lastHopNeighborMap:o,meshTopology:a,hoveredMarker:c,onMarkerHover:f,getNodeOpacity:u,shouldShowNode:l,onRequestRemove:m,openPopupId:h,onOpenPopup:g,onClosePopup:p,onNodeClick:x,blinkingNodes:k}){const{current:b}=ze(),w=i.useRef(!1),[T,L]=i.useState(!1);i.useEffect(()=>{var U;const y=(U=b==null?void 0:b.getMap)==null?void 0:U.call(b);if(!y)return;const C=()=>{try{jl(y),w.current=!0,T||L(!0)}catch(G){console.warn("Failed to load node marker icons:",G)}};y.isStyleLoaded()?C():y.once("style.load",C);const S=()=>{y.hasImage(J.standard)||C()};y.on("styledata",S);const R=()=>{w.current=!1,C()},D=new MutationObserver(G=>{for(const W of G)if(W.attributeName==="data-theme"){setTimeout(R,100);break}});D.observe(document.documentElement,{attributes:!0});const q=document.querySelector("[data-basemap]");let Y=null;return q&&(Y=new MutationObserver(G=>{for(const W of G)if(W.attributeName==="data-basemap"){setTimeout(R,100);break}}),Y.observe(q,{attributes:!0})),()=>{y.off("styledata",S),D.disconnect(),Y==null||Y.disconnect()}},[b,T]);const E=i.useMemo(()=>{var S;const y=[],C=[...e].sort(([R,D],[q,Y])=>{const U=(G,W)=>{var re;return _s(W)?5e3:r.has(G)?3e3:a.hubNodes.includes(G)?2e3:(re=a.gatewayNodes)!=null&&re.includes(G)?1e3:0};return U(R,D)-U(q,Y)});for(const[R,D]of C){if(!D.latitude||!D.longitude)continue;if(s){const ye=s.startsWith("0x")?s.slice(2,4).toLowerCase():s.slice(0,2).toLowerCase(),be=R.startsWith("0x")?R.slice(2,4).toLowerCase():R.slice(0,2).toLowerCase();if(ye===be||R===s)continue}const q=l(R),Y=u(R,q);if(Y<=.01)continue;const U=r.has(R),G=a.hubNodes.includes(R),W=((S=a.gatewayNodes)==null?void 0:S.includes(R))??!1,re=a.mobileNodes.includes(R),se=_s(D),V=a.centrality.get(R)||0,Z=o.get(R),te=D.last_seen||(Z==null?void 0:Z.lastSeen),ue=Sl(te),ee=ue>0;let oe=Y;ue===2?oe=Math.min(Y,.25):ue===1&&(oe=Math.min(Y,.5));let ne="standard";se?ne="roomServer":G?ne="hub":W?ne="gateway":re&&(ne="mobile");const Q=a.fullAffinity.get(R),ae=a.txDelayRecommendations.get(R);y.push({type:"Feature",geometry:{type:"Point",coordinates:[D.longitude,D.latitude]},properties:{hash:R,name:D.node_name||D.name||"Unknown",hashPrefix:un(R),iconType:ne,isNeighbor:U,isHub:G,isGateway:W,isMobile:re,isRoomServer:se,isStale:ee,staleTier:ue,isZeroHop:U,opacity:oe,blinkIntensity:0,lastSeenTimestamp:te,centrality:V,neighborJson:JSON.stringify(D),affinityJson:Q?JSON.stringify(Q):void 0,txDelayRecJson:ae?JSON.stringify(ae):void 0,meanSnr:(Z==null?void 0:Z.avgSnr)??void 0,meanRssi:(Z==null?void 0:Z.avgRssi)??void 0}})}return{type:"FeatureCollection",features:y}},[e,s,r,o,a,u,l]),A=i.useMemo(()=>!(n!=null&&n.latitude)||!(n!=null&&n.longitude)?{type:"FeatureCollection",features:[]}:{type:"FeatureCollection",features:[{type:"Feature",geometry:{type:"Point",coordinates:[n.longitude,n.latitude]},properties:{hash:"local",name:n.name,hashPrefix:s?un(s):"",iconType:"local",isNeighbor:!1,isHub:!1,isGateway:!1,isMobile:!1,isRoomServer:!1,isStale:!1,staleTier:0,isZeroHop:!1,opacity:1,blinkIntensity:0,centrality:0}}]},[n,s]),M=i.useCallback(y=>{var R;if(!y.features||y.features.length===0)return;const S=(R=y.features[0].properties)==null?void 0:R.hash;S&&(g&&g(S),x&&S!=="local"&&x(S))},[g,x]),I=i.useCallback(y=>{var R,D;if(!y.features||y.features.length===0)return;const C=(R=b==null?void 0:b.getMap)==null?void 0:R.call(b);C&&(C.getCanvas().style.cursor="pointer");const S=(D=y.features[0].properties)==null?void 0:D.hash;S&&f(S)},[b,f]),O=i.useCallback(()=>{var C;const y=(C=b==null?void 0:b.getMap)==null?void 0:C.call(b);y&&(y.getCanvas().style.cursor=""),f(null)},[b,f]);i.useEffect(()=>{var S;const y=(S=b==null?void 0:b.getMap)==null?void 0:S.call(b);if(!y||!T)return;const C=[Sn,wn];for(const R of C)y.on("click",R,M),y.on("mouseenter",R,I),y.on("mouseleave",R,O);return()=>{for(const R of C)y.off("click",R,M),y.off("mouseenter",R,I),y.off("mouseleave",R,O)}},[b,T,M,I,O]);const _=i.useRef(E),B=i.useRef(A);i.useEffect(()=>{_.current=E,B.current=A},[E,A]),i.useEffect(()=>{var R;const y=(R=b==null?void 0:b.getMap)==null?void 0:R.call(b);if(!y||!T||!k||k.size===0)return;const C=y.getSource(Bt),S=y.getSource(`${Bt}-local`);if(!(!C&&!S)){if(C){const D=_.current;let q=!1;const Y=D.features.map(U=>{const G=k.get(U.properties.hash)??0;return G!==U.properties.blinkIntensity?(q=!0,{...U,properties:{...U.properties,blinkIntensity:G}}):U});q&&C.setData({type:"FeatureCollection",features:Y})}if(S&&s){const D=k.get(s)??0,q=B.current;q.features.length>0&&q.features[0].properties.blinkIntensity!==D&&S.setData({type:"FeatureCollection",features:[{...q.features[0],properties:{...q.features[0].properties,blinkIntensity:D}}]})}}},[b,T,k,s]);const j=i.useMemo(()=>{if(!h)return null;if(h==="local"&&n)return{longitude:n.longitude,latitude:n.latitude,isLocal:!0,name:n.name,hash:s};const y=E.features.find(R=>R.properties.hash===h);if(!y)return null;const C=y.properties,S=C.txDelayRecJson?JSON.parse(C.txDelayRecJson):void 0;return{longitude:y.geometry.coordinates[0],latitude:y.geometry.coordinates[1],isLocal:!1,hash:C.hash,hashPrefix:C.hashPrefix,name:C.name,isHub:C.isHub,isGateway:C.isGateway,isBackbone:(S==null?void 0:S.networkRole)==="backbone",isZeroHop:C.isZeroHop,isMobile:C.isMobile,isRoomServer:C.isRoomServer,isStale:C.isStale,lastSeenTimestamp:C.lastSeenTimestamp,centrality:C.centrality,neighbor:C.neighborJson?JSON.parse(C.neighborJson):void 0,affinity:C.affinityJson?JSON.parse(C.affinityJson):void 0,txDelayRec:S,meanSnr:C.meanSnr,meanRssi:C.meanRssi}},[h,n,s,E]);if(!T)return null;const $=En(),H=["case",[">",["get","blinkIntensity"],.66],J.blink,[">",["get","blinkIntensity"],.33],J.blinkBlack,["==",["get","staleTier"],2],J.stale10Day,["==",["get","staleTier"],1],J.stale5Day,["==",["get","iconType"],"roomServer"],["case",["get","isNeighbor"],J.roomServerNeighbor,J.roomServer],["==",["get","iconType"],"hub"],["case",["get","isNeighbor"],J.hubNeighbor,J.hub],["==",["get","iconType"],"gateway"],["case",["get","isNeighbor"],J.gatewayNeighbor,J.gateway],["==",["get","iconType"],"mobile"],["case",["get","isNeighbor"],J.mobileNeighbor,J.mobile],["case",["get","isNeighbor"],J.standardNeighbor,J.standard]],P=["interpolate",["linear"],["zoom"],bl,.25,yl,1],z=["get","opacity"];return t.jsxs(t.Fragment,{children:[t.jsx(We,{id:Bt,type:"geojson",data:E,children:t.jsx(Se,{id:Sn,type:"symbol",layout:{"icon-image":H,"icon-size":P,"icon-allow-overlap":!0,"icon-ignore-placement":!0,"symbol-sort-key":["get","opacity"]},paint:{"icon-opacity":z}})}),t.jsx(We,{id:`${Bt}-local`,type:"geojson",data:A,children:t.jsx(Se,{id:wn,type:"symbol",layout:{"icon-image":["case",[">",["get","blinkIntensity"],.66],J.blinkLocal,[">",["get","blinkIntensity"],.33],J.blinkBlackLocal,J.local],"icon-size":P,"icon-allow-overlap":!0,"icon-ignore-placement":!0},paint:{"icon-opacity":1}})}),j&&p&&t.jsx(ko,{longitude:j.longitude,latitude:j.latitude,offset:{center:[0,0],top:[0,Ie/2+4],"top-left":[6,Ie/2+4],"top-right":[-6,Ie/2+4],bottom:[0,-Ie/2-4],"bottom-left":[6,-Ie/2-4],"bottom-right":[-6,-Ie/2-4],left:[Ie/2+4,0],right:[-Ie/2-4,0]},maxWidth:"280px",closeOnClick:!0,onClose:p,className:"maplibre-popup",children:j.isLocal?t.jsxs("div",{className:"text-sm",children:[t.jsx("strong",{className:"text-base",children:j.name}),j.hash&&t.jsx("span",{className:"ml-2 font-mono text-xs text-fg-muted surface-badge px-1.5 py-0.5 rounded",children:un(j.hash)}),t.jsx("br",{}),t.jsx("span",{style:{color:$.localColor},className:"font-medium",children:"This Node (Local)"}),t.jsx("br",{}),n&&t.jsxs("span",{className:"text-xs text-fg-muted",children:[n.latitude.toFixed(5),", ",n.longitude.toFixed(5)]})]}):j.neighbor&&j.hash?t.jsx(xl,{hash:j.hash,hashPrefix:j.hashPrefix,name:j.name,isHub:j.isHub,isGateway:j.isGateway,isBackbone:j.isBackbone,isZeroHop:j.isZeroHop,isMobile:j.isMobile,isRoomServer:j.isRoomServer,isStale:j.isStale,lastSeenTimestamp:j.lastSeenTimestamp,centrality:j.centrality,affinity:j.affinity,meanSnr:j.meanSnr,meanRssi:j.meanRssi,neighbor:j.neighbor,txDelayRec:j.txDelayRec,onRemove:m?()=>m(j.hash,j.name):void 0}):null})]})}const kl=[Sn,wn],jn="topology-validated-edges-native",Nn="topology-weak-edges-native",kn="neighbor-edges-native",Ds="topology-weak-edges-native",Ht="topology-validated-edges-native",dn="neighbor-edges-native",mn={type:"FeatureCollection",features:[]},xt={"line-cap":"round","line-join":"round"},Fs={"line-color":"transparent","line-width":16,"line-opacity":0};function El(e,n,s,r,o,a){const c=_n(),f=e!==null,u=o&&o.size>0,l=a&&a.size>0,m=u?Array.from(o):[],h=l?Array.from(a):[],g=n,p=.5,k=(()=>{if(g<=0)return["get","baseColor"];const $=1-g*.5;return["case",[">=",["get","brightnessScore"],$],"#FFFFFF",["get","baseColor"]]})(),w=g<=0?1:["max",.1,["+",1,["*",g,3,["-",["get","brightnessScore"],p]]]],L=u?["in",["get","key"],["literal",m]]:l?["in",["get","key"],["literal",h]]:f?["==",["get","key"],e]:!1,E=f||u||l,A=c.edges.hoverLoop,M=c.edges.highlight;return{"line-color":E?["case",L,u?A:l?M:["get","hoverColor"],k]:k,"line-width":E?["case",L,["max",["*",["get","baseWidth"],s,1.3],3.5],["*",["get","baseWidth"],s]]:["*",["get","baseWidth"],s],"line-opacity":["case",["<",["get","brightnessScore"],r],0,E?["case",L,["min",["*",["get","baseOpacity"],1.25],1],["*",["get","baseOpacity"],w,.35]]:["*",["get","baseOpacity"],w]]}}const Ml=10,Ll=6;function Tl(e){const n=e!==null,{YELLOW:s,GREEN:r,RED:o,GRAY:a}=$t,c=["to-number",["get","listenerScore"],0],f=["to-number",["get","loudScore"],0],l=["/",c,["max",["+",c,f],1]],m=["case",["all",["==",c,0],["==",f,0]],a,[">=",l,.97],r,["<=",l,.03],o,["interpolate",["linear"],l,.03,o,.5,s,.97,r]],h=.2,b=["*",["+",h,["*",["to-number",["get","trafficWeight"],0],1-h]],8],w=5,T=n?["case",["==",["get","key"],e],["max",b,w],b]:b,L=n?["case",["==",["get","key"],e],["max",["*",b,.25],w*.25],["*",b,.25]]:["*",b,.25];return{"line-color":m,"line-width":["interpolate",["linear"],["zoom"],Ll,L,Ml,T],"line-opacity":n?["case",["==",["get","key"],e],1,.35]:.9}}function Rl({showTopology:e,isExiting:n,hoveredEdgeKey:s,highlightedLoopEdges:r,highlightedFocusEdges:o,onEdgeHover:a,onLoopHover:c,loops:f=[],neighborNames:u={},opacityBias:l=.5,widthMultiplier:m=1,trafficFilter:h=0,showNeighborLines:g=!0,disableHover:p=!1}){const{current:x}=ze(),k=e||n,b=!0,w=g?"visible":"none",T=p||n,L=i.useRef(null),E=i.useRef(T),A=i.useRef(new Map),M=i.useRef(u),I=i.useRef(c);i.useLayoutEffect(()=>{E.current=T,M.current=u,I.current=c});const O=i.useMemo(()=>Ya(f),[f]);i.useLayoutEffect(()=>{A.current=O},[O]);const _=i.useCallback(y=>{var D,q;if(E.current||!y.features||y.features.length===0)return;const S=y.features[0].properties;if(!(S!=null&&S.key))return;const R=S.key;if(R!==L.current){L.current=R;const Y=S.isNeighborEdge===!0||S.isNeighborEdge==="true",U=S.isLoopEdge===!0||S.isLoopEdge==="true";if(Y){const G={key:R,fromName:"Local",toName:S.name,certainCount:Number(S.packetCount)||0,confidence:1,isBackbone:!1,isLoopEdge:!1,isDirectPath:!0,isZeroHop:!0,symmetryRatio:1,dominantDirection:"balanced",isHubConnection:!1};a(R,[y.lngLat.lng,y.lngLat.lat],G),(D=I.current)==null||D.call(I,null)}else if(U&&I.current){const G=A.current.get(R)??[];if(G.length>0){const W=new Set;for(const Z of G)for(const te of Z.edgeKeys)W.add(te);const se=G[0].nodes.map(Z=>M.current[Z]||Z.substring(0,4)),V={loops:G,highlightedEdgeKeys:W,hoveredEdgeKey:R,nodeNames:se};I.current(V,[y.lngLat.lng,y.lngLat.lat]),a(R)}else{const W={key:R,fromName:S.fromName,toName:S.toName,certainCount:Number(S.certainCount),confidence:Number(S.confidence),isBackbone:S.isBackbone===!0||S.isBackbone==="true",isLoopEdge:!0,isDirectPath:S.isDirectPath===!0||S.isDirectPath==="true",isZeroHop:S.isZeroHop===!0||S.isZeroHop==="true",symmetryRatio:Number(S.symmetryRatio),dominantDirection:S.dominantDirection,isHubConnection:S.isHubConnection===!0||S.isHubConnection==="true"};a(R,[y.lngLat.lng,y.lngLat.lat],W)}}else{const G={key:R,fromName:S.fromName,toName:S.toName,certainCount:Number(S.certainCount),confidence:Number(S.confidence),isBackbone:S.isBackbone===!0||S.isBackbone==="true",isLoopEdge:U,isDirectPath:S.isDirectPath===!0||S.isDirectPath==="true",isZeroHop:S.isZeroHop===!0||S.isZeroHop==="true",symmetryRatio:Number(S.symmetryRatio),dominantDirection:S.dominantDirection,isHubConnection:S.isHubConnection===!0||S.isHubConnection==="true"};a(R,[y.lngLat.lng,y.lngLat.lat],G),(q=I.current)==null||q.call(I,null)}}},[a]),B=i.useCallback(()=>{var y;L.current!==null&&(L.current=null,a(null),(y=I.current)==null||y.call(I,null))},[a]);i.useEffect(()=>{var D;const y=(D=x==null?void 0:x.getMap)==null?void 0:D.call(x);if(!y||!k)return;const C="topology-validated-edges-hitarea-native",S=()=>{try{return y.getStyle()&&y.getLayer(C)}catch{return!1}},R=()=>S()?(y.on("mousemove",C,_),y.on("mouseleave",C,B),!0):!1;if(!R()){const q=()=>{R()&&y.off("styledata",q)};return y.on("styledata",q),()=>{try{y.off("styledata",q),S()&&(y.off("mousemove",C,_),y.off("mouseleave",C,B))}catch{}}}return()=>{try{S()&&(y.off("mousemove",C,_),y.off("mouseleave",C,B))}catch{}}},[x,k,_,B]),i.useEffect(()=>{var D;const y=(D=x==null?void 0:x.getMap)==null?void 0:D.call(x);if(!y||!b||!g)return;const C="neighbor-edges-hitarea-native",S=()=>{try{return y.getStyle()&&y.getLayer(C)}catch{return!1}},R=()=>S()?(y.on("mousemove",C,_),y.on("mouseleave",C,B),!0):!1;if(!R()){const q=()=>{R()&&y.off("styledata",q)};return y.on("styledata",q),()=>{try{y.off("styledata",q),S()&&(y.off("mousemove",C,_),y.off("mouseleave",C,B))}catch{}}}return()=>{try{S()&&(y.off("mousemove",C,_),y.off("mouseleave",C,B))}catch{}}},[x,b,g,_,B]),i.useEffect(()=>{var U;const y=(U=x==null?void 0:x.getMap)==null?void 0:U.call(x);if(!y)return;let C=null;const S=(G,W)=>{try{if(y.getLayer(G)&&y.getLayer(W))return y.moveLayer(G,W),!0}catch{}return!1},R=()=>{try{if(!y.getLayer("node-markers-layer"))return;S(dn,"node-markers-layer"),S("neighbor-edges-hitarea-native",dn),(S(Ht,"neighbor-edges-hitarea-native")||S(Ht,"node-markers-layer"))&&S("topology-validated-edges-hitarea-native",Ht),S(Ds,"topology-validated-edges-hitarea-native")}catch{}},D=()=>{C&&clearTimeout(C),C=setTimeout(R,50)},q=setTimeout(R,100);y.on("styledata",D);const Y=G=>{(G.sourceId===jn||G.sourceId===Nn||G.sourceId===kn)&&D()};return y.on("sourcedata",Y),()=>{clearTimeout(q),C&&clearTimeout(C);try{y.off("styledata",D),y.off("sourcedata",Y)}catch{}}},[x,k,b,g]);const j=T?null:s,P=El(j,l,m,h,T?null:r,o??null),z=Tl(j);return t.jsxs(t.Fragment,{children:[k&&t.jsx(We,{id:Nn,type:"geojson",data:mn,children:t.jsx(Se,{id:Ds,type:"line",paint:P,layout:{...xt,visibility:w}})}),k&&t.jsxs(We,{id:jn,type:"geojson",data:mn,children:[t.jsx(Se,{id:"topology-validated-edges-hitarea-native",type:"line",paint:Fs,layout:{...xt,visibility:w}}),t.jsx(Se,{id:Ht,type:"line",paint:P,layout:{...xt,visibility:w}})]}),t.jsxs(We,{id:kn,type:"geojson",data:mn,children:[t.jsx(Se,{id:"neighbor-edges-hitarea-native",type:"line",paint:Fs,layout:{...xt,visibility:w}}),t.jsx(Se,{id:dn,type:"line",paint:z,layout:{...xt,visibility:w}})]})]})}const Al=["topology-validated-edges-hitarea-native","topology-validated-edges-native","topology-weak-edges-native","neighbor-edges-hitarea-native","neighbor-edges-native"];function Il({targetHash:e,nodeCoordinates:n,onComplete:s}){const{current:r}=ze(),o=i.useRef(null);return i.useEffect(()=>{if(!r||!e||e===o.current)return;const a=n.get(e);if(!a)return;const c=r.getMap();c.isMoving()&&c.stop(),o.current=e;const[f,u]=a;r.flyTo({center:[u,f],zoom:10,duration:2500,essential:!0}),setTimeout(()=>{s==null||s()},2600)},[e,n,r,s]),null}function _l({highlightedEdgeKey:e,validatedPolylines:n,weakPolylines:s,onEnsureTopology:r}){const{current:o}=ze(),a=i.useRef(null);return i.useEffect(()=>{if(!o||!e||e===a.current)return;a.current=e,r();const c=n.find(g=>g.edge.key===e)||s.find(g=>g.edge.key===e);if(!c||o.getMap().isMoving())return;const u=(c.from[0]+c.to[0])/2,l=(c.from[1]+c.to[1])/2,m=o.getZoom(),h=Math.max(m,11);o.easeTo({center:[l,u],zoom:h,duration:500})},[e,n,s,o,r]),null}const Os="link-quality-edges",Dl="link-quality-edges-layer",Wt="link-quality-edges-hitarea",Ps={type:"FeatureCollection",features:[]};function Fl(e,n){return e<n?`${e}|${n}`:`${n}|${e}`}function Ol(e,n,s,r,o){const a=[];for(const c of e){if(s&&c.nodeA.hash!==s&&c.nodeB.hash!==s)continue;const f=n.get(c.nodeA.hash),u=n.get(c.nodeB.hash);if(!f||!u)continue;const l=Jo(c.composite.mean,o),m=r[l]||"#888888",h=2+c.confidence*2,g=Fl(c.nodeA.hash,c.nodeB.hash);a.push({type:"Feature",geometry:{type:"LineString",coordinates:[[f[1],f[0]],[u[1],u[0]]]},properties:{key:g,color:m,width:h,quality:c.quality,compositeMeanSnr:c.composite.mean,confidence:c.confidence,fromHash:c.nodeA.hash,toHash:c.nodeB.hash,fromPrefix:c.nodeA.prefix,toPrefix:c.nodeB.prefix,fromName:c.nodeA.name||c.nodeA.prefix,toName:c.nodeB.name||c.nodeB.prefix,asymmetryDb:c.asymmetryDb}})}return{type:"FeatureCollection",features:a}}const Bs={"line-cap":"round","line-join":"round"},Pl={"line-color":["get","color"],"line-width":["get","width"],"line-opacity":.85},Bl={"line-color":"transparent","line-width":16,"line-opacity":0};function Hl({visible:e,nodeCoordinates:n,focusedNodeHash:s=null,basemapMode:r}){const{current:o}=ze(),a=Qs(),c=qs(),f=Yo(),u=i.useMemo(()=>Zo(),[]),l=i.useMemo(()=>!e||a.length===0||c.size===0?Ps:Ol(a,n,s,u,f),[e,a,c.size,n,s,u,f]);i.useEffect(()=>{if(!o)return;const h=o.getMap();if(h)try{const g=h.getSource(Os);g&&"setData"in g&&(g.setData(l),h.triggerRepaint())}catch{}},[l,o]);const m=e?"visible":"none";return t.jsxs(We,{id:Os,type:"geojson",data:Ps,children:[t.jsx(Se,{id:Dl,type:"line",layout:{...Bs,visibility:m},paint:Pl}),t.jsx(Se,{id:Wt,type:"line",layout:{...Bs,visibility:m},paint:Bl})]})}const $l="rgba(167, 139, 250, 0.15)",Hs=500,Gl=.5,$s=2e3,Gs=1500,Wl=1e3;function zl(e,n,s,r=64){const o=[],c=s/6371e3*(180/Math.PI),f=c/Math.cos(n*Math.PI/180);for(let u=0;u<=r;u++){const l=u/r*2*Math.PI,m=e+f*Math.cos(l),h=n+c*Math.sin(l);o.push([m,h])}return{type:"Feature",properties:{},geometry:{type:"Polygon",coordinates:[o]}}}function Ul({ghost:e,neighborCoordinates:n,onHighlightedNeighborsChange:s}){const{current:r}=ze(),o=i.useRef(null),a=i.useRef(null),c=i.useMemo(()=>e?new Set(e.commonNeighbors):new Set,[e]);i.useEffect(()=>{s==null||s(c)},[c,s]);const f=i.useMemo(()=>{if(!(e!=null&&e.commonNeighbors)||e.commonNeighbors.length<2)return $s*4;let m=0;const h=[];for(const g of e.commonNeighbors){const p=n.get(g);p&&h.push(p)}e.estimatedLocation&&h.push([e.estimatedLocation.lat,e.estimatedLocation.lon]);for(let g=0;g<h.length;g++)for(let p=g+1;p<h.length;p++){const x=ur(h[g][0],h[g][1],h[p][0],h[p][1]);x>m&&(m=x)}return Math.max(m,Hs*4)},[e,n]),u=i.useMemo(()=>{if(!(e!=null&&e.estimatedLocation))return{type:"FeatureCollection",features:[]};const{lat:m,lon:h,uncertaintyM:g}=e.estimatedLocation,p=f*Gl,x=g>0?g:$s,k=Math.max(Hs,Math.min(x,p));return{type:"FeatureCollection",features:[zl(h,m,k)]}},[e,f]);if(i.useEffect(()=>{if(!r)return;const m=r.getMap();if(e&&e.prefix!==a.current){if(a.current=e.prefix,!o.current&&m.getZoom()>3){const g=m.getCenter();o.current={center:[g.lng,g.lat],zoom:m.getZoom(),pitch:m.getPitch(),bearing:m.getBearing()}}const h=[];for(const g of e.commonNeighbors){const p=n.get(g);p&&h.push([p[1],p[0]])}if(e.estimatedLocation&&h.push([e.estimatedLocation.lon,e.estimatedLocation.lat]),h.length>0){const g=()=>{var p;if(m.isMoving()){setTimeout(g,100);return}if(h.length===1)r.flyTo({center:h[0],zoom:13,duration:Gs});else{let x=1/0,k=-1/0,b=1/0,w=-1/0;for(const[T,L]of h)x=Math.min(x,T),k=Math.max(k,T),b=Math.min(b,L),w=Math.max(w,L);if((p=e.estimatedLocation)!=null&&p.uncertaintyM){const T=e.estimatedLocation.uncertaintyM/111e3;x-=T,k+=T,b-=T,w+=T}r.fitBounds([[x,b],[k,w]],{padding:{top:60,bottom:60,left:60,right:60},maxZoom:14,duration:Gs})}};setTimeout(g,50)}}if(!e&&a.current!==null&&(a.current=null,o.current)){const h=o.current,g=()=>{if(m.isMoving()){setTimeout(g,100);return}r.flyTo({center:h.center,zoom:h.zoom,pitch:h.pitch,bearing:h.bearing,duration:Wl}),o.current=null};setTimeout(g,50)}},[e,r,n]),!(e!=null&&e.estimatedLocation))return null;const l={"fill-color":$l,"fill-opacity":.8};return t.jsx(We,{id:"ghost-uncertainty-circle",type:"geojson",data:u,children:t.jsx(Se,{id:"ghost-uncertainty-fill",type:"fill",paint:l})})}const jr=[{target:"Map",fn:"gps",minStage:1,when:Jn},{target:"Map",fn:"_advertNodeType",minStage:1,when:Jn},{target:"Topology",fn:"traceHops",minStage:1,when:Qn},{target:"Topology",fn:"path.entries",minStage:1,when:Lo},{target:"Topology",fn:"traceSrc",minStage:1,when:Qn}];zs(jr);const Kl={version:8,sources:{},layers:[],glyphs:"https://demotiles.maplibre.org/font/{fontstack}/{range}.pbf"},ql={longitude:0,latitude:0,zoom:2};function Vl(e,n,s,r){return ur(e,n,s,r)/1e3}function Yl(e,n){if(e.length<=2)return e;let s,r;if(n!=null&&n.latitude&&(n!=null&&n.longitude))s=n.latitude,r=n.longitude;else{let l=0,m=0;for(const[h,g]of e)l+=h,m+=g;s=l/e.length,r=m/e.length}const o=e.map(([l,m])=>({pos:[l,m],dist:Vl(s,r,l,m)}));o.sort((l,m)=>l.dist-m.dist);const a=Math.floor(o.length/2),c=o[a].dist,f=Math.max(c*3,50),u=o.filter(l=>l.dist<=f).map(l=>l.pos);return u.length<e.length*.5?e:u}function Zl(e,n){let s=[...e];if(n!=null&&n.latitude&&(n!=null&&n.longitude)&&s.push([n.latitude,n.longitude]),s.length===0)return null;if(s.length===1){const[p,x]=s[0];return{longitude:x,latitude:p,zoom:14}}s=Yl(s,n);let r=1/0,o=-1/0,a=1/0,c=-1/0;for(const[p,x]of s)r=Math.min(r,x),o=Math.max(o,x),a=Math.min(a,p),c=Math.max(c,p);const f=(r+o)/2,u=(a+c)/2,l=c-a,m=o-r,h=Math.max(l,m);let g=16;return h>0&&(g=Math.floor(Math.log2(360/h*1.2)),g=Math.max(1,Math.min(14,g))),g=Math.min(g+1,12),{longitude:f,latitude:u,zoom:g}}function Jl(e,n,s,r){var o;if(n){const a=n.loops[0],c=n.loops.length,f=[{label:"hops",value:a.size},{label:"seen",value:a.minCertainCount}],u=[];return a.includesLocal&&u.push({text:"★ Includes your node",color:"text-sys-amber"}),c>1&&u.push({text:`+${c-1} overlapping`,color:"text-sys-indigo/70"}),{type:"loop",title:{icon:"⟳",text:`Redundant Path${c>1?"s":""}`,color:"text-sys-indigo"},subtitle:{text:`${n.nodeNames.join(" → ")} → ${n.nodeNames[0]}`,color:"text-fg-secondary",mono:!0},stats:f,badges:u}}if((e==null?void 0:e.type)==="neighbor"){const a=e.properties,c=[];a.rssi!==void 0&&a.rssi!==null&&c.push({label:"RSSI",value:`${Math.round(a.rssi)} dBm`,unit:a.hasAvgRssi?"avg":void 0}),a.snr!==void 0&&a.snr!==null&&c.push({label:"SNR",value:`${Number(a.snr).toFixed(1)} dB`,unit:a.hasAvgSnr?"avg":void 0});const f=a.listenerScore??0,u=a.loudScore??0,l=f>0||u>0;return l&&(c.push({label:"listener",value:f,color:"text-sys-green"}),c.push({label:"loud",value:u,color:"text-sys-red"})),a.packetCount!==void 0&&!l&&c.push({label:"packets",value:Number(a.packetCount).toLocaleString()}),{type:"neighbor",title:{icon:"●",text:a.prefix?`${a.name} (${a.prefix})`:a.name,color:"text-sys-amber"},subtitle:{text:"Direct RF Neighbor",color:"text-sys-amber/70"},stats:c,badges:[]}}if((e==null?void 0:e.type)==="topology"){const a=e.properties,c=s>0?Number(a.certainCount)/s:0,f=[{label:"validations",value:a.certainCount},{label:"of max traffic",value:`${Math.round(c*100)}%`},{label:"confidence",value:`${Math.round(Number(a.confidence)*100)}%`}];if(a.symmetryRatio!==void 0&&a.symmetryRatio<1){const m=a.dominantDirection==="forward"?"→":a.dominantDirection==="reverse"?"←":"↔";f.push({label:"symmetric",value:`${m} ${Math.round(a.symmetryRatio*100)}%`,color:"text-fg-muted"})}const u=(o=r==null?void 0:r.get(a.key))==null?void 0:o.traceQuality;if(u!=null&&u.composite){const m=u.composite;f.push({label:"trace SNR",value:`${m.mean.toFixed(1)} dB`,unit:`n=${m.count}`,color:m.mean>=10?"text-sys-green":m.mean>=0?"text-sys-amber":"text-sys-red"}),u.asymmetryDb!=null&&u.asymmetryDb>1&&f.push({label:"asymmetry",value:`${u.asymmetryDb.toFixed(1)} dB`,color:u.asymmetryDb>5?"text-sys-red":"text-sys-amber"})}const l=[];if(a.isBackbone&&l.push({text:"Backbone",color:"text-zinc-300"}),a.isLoopEdge&&l.push({text:"Redundant",color:"text-sys-indigo"}),a.isDirectPath&&l.push({text:"Direct Path",color:"text-sys-teal"}),u){const m=u.quality==="excellent"||u.quality==="good"?"text-sys-green":u.quality==="fair"?"text-sys-amber":u.quality==="poor"||u.quality==="critical"?"text-sys-red":"text-fg-muted";u.quality!=="unknown"&&l.push({text:`TRACE ${u.quality}`,color:m})}return{type:"topology",title:{icon:"",text:`${a.fromName} ↔ ${a.toName}`,color:"text-fg-primary"},stats:f,badges:l}}return null}function Ql({data:e}){const n=e.subtitle&&e.type==="loop",s=e.subtitle&&e.type!=="loop";return t.jsxs("div",{className:"w-[540px]",children:[t.jsxs("div",{className:"flex items-center justify-between h-5",children:[t.jsxs("div",{className:"flex items-center gap-2 min-w-0",children:[e.title.icon&&t.jsx("span",{className:`${e.title.color} text-base leading-none flex-shrink-0`,children:e.title.icon}),t.jsx("span",{className:`${e.title.color} font-semibold text-[13px] truncate`,children:e.title.text}),s&&t.jsx("span",{className:`${e.subtitle.color} text-[11px] flex-shrink-0`,children:e.subtitle.text})]}),e.badges.length>0&&t.jsx("div",{className:"flex items-center gap-2 flex-shrink-0 ml-3",children:e.badges.map((r,o)=>t.jsx("span",{className:`${r.color} text-[11px] font-medium`,children:r.text},o))})]}),n&&t.jsx("div",{className:"h-4 mt-0.5 overflow-hidden",children:t.jsx("span",{className:"type-data-xs text-fg-muted truncate block",children:e.subtitle.text})}),t.jsx("div",{className:`flex items-center gap-4 h-4 ${n?"mt-1":"mt-1.5"} text-[11px]`,children:e.stats.map((r,o)=>t.jsxs("span",{className:"whitespace-nowrap",children:[t.jsx("span",{className:`font-mono tabular-nums font-semibold ${r.color??"text-fg-primary"}`,children:r.value}),t.jsx("span",{className:"text-fg-muted ml-1",children:r.label}),r.unit&&t.jsx("span",{className:"text-fg-muted/50 ml-0.5",children:r.unit})]},o))})]})}function Lu({neighbors:e,localNode:n,localHash:s,onRemoveNode:r,selectedNodeHash:o,onNodeSelected:a,highlightedEdgeKey:c,highlightedGhost:f}){Ws(jr);const u=i.useRef(null),l=Qo(),m=Xo(),h=Js(),g=ea(),p=ta(),x=Qs(),[k,b]=i.useState(!1),w=Ye(d=>d.viewState),T=Ye(d=>d.toggles),L=Ye(d=>d.hasAnalyzed),E=Ye(d=>d.setViewState),A=Ye(d=>d.setToggle),M=Ye(d=>d.setHasAnalyzed),I=Ye(d=>d.modalMapOpen),O=en(d=>d.preloadFromNodes),_=en(d=>d.isLoading),B=en(d=>d.terrainGrid),j=s??g,$=i.useMemo(()=>{const d=[];for(const[,v]of Object.entries(e))v.latitude&&v.longitude&&d.push([v.latitude,v.longitude]);return d},[e]),H=i.useMemo(()=>Zl($,n),[$,n]),[P,z]=i.useState(()=>w??H??ql),y=i.useCallback(d=>{z(d),queueMicrotask(()=>E(d))},[E]),C=i.useRef(!!w);i.useEffect(()=>{!C.current&&H&&!w?(z(H),queueMicrotask(()=>E(H)),C.current=!0,setTimeout(()=>b(!0),50)):w&&setTimeout(()=>b(!0),50)},[H,w,E]);const[S,R]=i.useState(!1),[D,q]=i.useState(()=>T.showTopology&&!h.topologyLoadComplete?!1:T.showTopology),[Y,U]=i.useState(T.showNeighborLines),[G,W]=i.useState(!1),[re,se]=i.useState(T.showMinCut),[V,Z]=i.useState(Zi),[te,ue]=i.useState(T.show3DTerrain),[ee,oe]=i.useState(T.showLinkQuality),[ne,Q]=i.useState(()=>T.nodeFilters.length>0?T.nodeFilters:[...yt]),ae=i.useCallback(d=>{q(v=>{const N=typeof d=="function"?d(v):d;return queueMicrotask(()=>A("showTopology",N)),N})},[A]),ye=i.useCallback(d=>{U(v=>{const N=typeof d=="function"?d(v):d;return queueMicrotask(()=>A("showNeighborLines",N)),N})},[A]),be=i.useCallback(d=>{se(v=>{const N=typeof d=="function"?d(v):d;return queueMicrotask(()=>A("showMinCut",N)),N})},[A]),je=i.useCallback(d=>{ue(v=>{const N=typeof d=="function"?d(v):d;return queueMicrotask(()=>A("show3DTerrain",N)),N})},[A]),st=i.useCallback(d=>{oe(v=>{const N=typeof d=="function"?d(v):d;return queueMicrotask(()=>A("showLinkQuality",N)),N})},[A]),de=i.useCallback(d=>{Q(d),queueMicrotask(()=>A("nodeFilters",d))},[A]),[Te,ie]=i.useState(null),[ce,Re]=i.useState(null),[Ae,Dn]=i.useState(null),[wt,dt]=i.useState(null),[Nr]=i.useState(0),[kr]=i.useState(.5),[Er]=i.useState(0),[jt,Kt]=i.useState(null),[Mr,Fn]=i.useState(""),[Lr,On]=i.useState(!1),[Pn,Bn]=i.useState(!1),[Oe,Tr]=i.useState(()=>L&&!h.topologyLoadComplete?!1:L);i.useEffect(()=>{if(h.topologyLoadComplete)return;const d=L&&!Oe,v=T.showTopology&&!D;!d&&!v||queueMicrotask(()=>{d&&M(!1),v&&A("showTopology",!1)})},[L,T.showTopology,h.topologyLoadComplete,Oe,D,M,A]);const Rr=i.useCallback(d=>{Tr(d),queueMicrotask(()=>M(d))},[M]),[Ar,qt]=i.useState(null),Ir=i.useCallback(d=>qt(d),[]),_r=i.useCallback(()=>qt(null),[]),[,Dr]=i.useState(new Set),mt=bt(d=>d.coveragePoints),Nt=bt(d=>d.isVisible),Fr=bt(d=>d.brightness),Or=bt(d=>d.openModal),Vt=ac(),Pr=ic(),Ne=ir(),Br=Oa(),Hn=i.useRef(!1);i.useEffect(()=>{mt.length>0&&Nt&&!Hn.current&&(ye(!1),Hn.current=!0)},[mt.length,Nt]);const $n=i.useRef(null);i.useEffect(()=>{if(o&&o!==$n.current){$n.current=o;const d=setTimeout(()=>{qt(o)},1250);return()=>clearTimeout(d)}},[o]);const[ft,Ue]=i.useState(null),[kt,Gn]=i.useState(null),Hr=i.useCallback((d,v,N)=>{Re(d),d&&v&&N?Ue({longitude:v[0],latitude:v[1],type:"topology",properties:{key:N.key,fromName:N.fromName,toName:N.toName,certainCount:N.certainCount,confidence:N.confidence,isBackbone:N.isBackbone,isLoopEdge:N.isLoopEdge,isDirectPath:N.isDirectPath,isHubConnection:N.isHubConnection,symmetryRatio:N.symmetryRatio,dominantDirection:N.dominantDirection}}):d||Ue(null)},[]),$r=i.useCallback((d,v)=>{Gn(d),d&&Ue(null)},[]),Wn=i.useMemo(()=>{var K;if(!D||!Te||ce)return null;const d=l.loops;if(d.length===0)return null;const v=Va(Te,d,l.edgeMap);if(v.loops.length===0)return null;const F=v.loops[0].nodes.map(X=>{var ge,pe;return X===j?"You":((ge=e[X])==null?void 0:ge.node_name)||((pe=e[X])==null?void 0:pe.name)||X.substring(0,4)});return{loops:v.loops,highlightedEdgeKeys:v.highlightedEdgeKeys,hoveredEdgeKey:((K=v.sortedEdges[0])==null?void 0:K.key)||"",nodeNames:F}},[D,Te,ce,l.loops,l.edgeMap,e,j]);i.useEffect(()=>{ce||Gn(Wn)},[Wn,ce]);const Gr=i.useMemo(()=>{const d={};for(const[v,N]of Object.entries(e))d[v]=N.node_name||N.name||v.substring(0,4);return j&&(d[j]="You"),d},[e,j]),Wr=i.useMemo(()=>{const d=new Map;for(const[v,N]of Object.entries(e)){const F=v.slice(0,2).toUpperCase(),K=N.node_name||N.name||F;d.set(F,K)}return j&&d.set(j.slice(0,2).toUpperCase(),"You"),d},[e,j]),Pe=i.useMemo(()=>Object.entries(e).filter(([,d])=>d.latitude&&d.longitude),[e]),le=i.useMemo(()=>{const d=new Map;j&&(n!=null&&n.latitude)&&(n!=null&&n.longitude)&&d.set(j,[n.latitude,n.longitude]);for(const[v,N]of Pe)N.latitude&&N.longitude&&d.set(v,[N.latitude,N.longitude]);return d},[j,n,Pe]),ht=i.useMemo(()=>{const d=new Map;for(const v of m)v.status!=="expired"&&d.set(v.hash,{hash:v.hash,prefix:v.prefix,count:v.count,avgRssi:v.avgRssi,avgSnr:v.avgSnr,lastSeen:v.lastSeen,confidence:1,status:v.status});return d},[m]),me=i.useMemo(()=>{var v,N;const d=new Set;for(const F of ht.keys())(v=e[F])!=null&&v.latitude&&((N=e[F])!=null&&N.longitude)&&d.add(F);return d},[ht,e]),Yt=pn(),zr=i.useMemo(()=>{if(me.size===0||!j)return new Map;if(Yt.length===0)return new Map;const d=Ct(j);return To(Yt,me,d).scores},[me,j,Yt]),Et=i.useCallback(d=>j?!!(d.fromHash===j&&me.has(d.toHash)||d.toHash===j&&me.has(d.fromHash)):!1,[j,me]),rt=i.useMemo(()=>{var v,N;if(m.length===0||!j)return[];if(h.backgroundLoadComplete)return[];const d=[];for(const F of m){if(F.status==="expired"||!((v=e[F.hash])!=null&&v.latitude)||!((N=e[F.hash])!=null&&N.longitude))continue;const K=[j,F.hash].sort(),X=`${K[0]}~${K[1]}`;d.push({fromHash:j,toHash:F.hash,key:X,packetCount:F.count,avgConfidence:1,strength:.8,avgRecency:1,hopDistanceFromLocal:0,isHubConnection:!1,isCertain:!0,certainCount:F.count,isLoopEdge:!1,forwardCount:F.count,reverseCount:0,symmetryRatio:0,dominantDirection:"forward",floodCount:F.count,directCount:0,isDirectPathEdge:!1,isZeroHop:!0,avgRssi:F.avgRssi,avgSnr:F.avgSnr})}return d},[m,j,h.backgroundLoadComplete,e]),Zt=i.useMemo(()=>{const d=[];if(rt.length>0&&!h.backgroundLoadComplete){for(const v of rt){const N=le.get(v.fromHash),F=le.get(v.toHash);N&&F&&d.push({from:N,to:F,edge:v})}return d}for(const v of l.validatedEdges){if(Et(v))continue;const N=le.get(v.fromHash),F=le.get(v.toHash);N&&F&&d.push({from:N,to:F,edge:v})}return d},[l.validatedEdges,le,Et,rt,h.backgroundLoadComplete]),zn=i.useMemo(()=>{const d=[];for(const v of l.weakEdges){if(Et(v))continue;const N=le.get(v.fromHash),F=le.get(v.toHash);N&&F&&d.push({from:N,to:F,edge:v})}return d},[l.weakEdges,le,Et]),Un=i.useMemo(()=>{if(!(n!=null&&n.latitude)||!(n!=null&&n.longitude))return[];const d=[],v=[n.latitude,n.longitude],N=new Map;for(const K of l.lastHopNeighbors)N.set(K.hash,K.count);const F=new Map;for(const K of m)F.set(K.hash,K.count);for(const K of me){const X=e[K];if(!(X!=null&&X.latitude)||!(X!=null&&X.longitude))continue;const ge=F.get(K),pe=N.get(K);d.push({from:v,to:[X.latitude,X.longitude],hash:K,neighbor:X,lastHopData:ht.get(K)??null,rxAdvertCount:ge,txProxyCount:pe})}return d},[n,me,e,ht,l.lastHopNeighbors,m]),Ur=i.useMemo(()=>new Set(l.loopEdgeKeys),[l.loopEdgeKeys]),Kr=i.useMemo(()=>new Set(l.backboneEdges),[l.backboneEdges]),qr=i.useMemo(()=>{if(!Ae)return null;const d=l.validatedEdges.filter(K=>K.fromHash===Ae||K.toHash===Ae);if(d.length===0)return null;const v=[...d].sort((K,X)=>X.certainCount-K.certainCount),N=Math.max(1,Math.ceil(v.length*.2)),F=v.slice(0,N);return new Set(F.map(K=>K.key))},[Ae,l.validatedEdges]),Kn=i.useMemo(()=>{let d=0;if(rt.length>0&&!h.backgroundLoadComplete){for(const v of rt)v.certainCount>d&&(d=v.certainCount);return d||1}for(const v of l.validatedEdges)v.certainCount>d&&(d=v.certainCount);return d||1},[l.validatedEdges,rt,h.backgroundLoadComplete]),Ke=i.useMemo(()=>{if(l.validatedEdges.length===0)return null;const d=new Set;for(const F of l.validatedEdges)d.add(F.fromHash),d.add(F.toHash);const v=Array.from(d).filter(F=>le.has(F)).sort();if(v.length<3)return null;const N=new Map;for(const F of v){const K=le.get(F);K&&N.set(F,K)}return oa(l.validatedEdges,v,N,l.edgeBetweenness)},[l.validatedEdges,le,l.edgeBetweenness]),Vr=i.useCallback(()=>{be(d=>{const v=!d;if(v&&Ke&&u.current){const N=u.current.getMap();if(!N)return v;let F=1/0,K=-1/0,X=1/0,ge=-1/0,pe=!1;for(const[,qe]of Ke.communities)for(const Ve of qe){const Ee=le.get(Ve);if(Ee){const[fe,He]=Ee;X=Math.min(X,fe),ge=Math.max(ge,fe),F=Math.min(F,He),K=Math.max(K,He),pe=!0}}pe&&N.fitBounds([[F,X],[K,ge]],{padding:{top:60,bottom:100,left:60,right:320},duration:800,maxZoom:14})}return v})},[Ke,le]),Jt=i.useRef(null);i.useLayoutEffect(()=>{var d,v;Jt.current=((v=(d=u.current)==null?void 0:d.getMap)==null?void 0:v.call(d))??null});const Yr=pn();ml({map:Jt,nodeCoordinates:le,packets:Yr,localHash:j,neighbors:e,meshTopology:l,enabled:Vt});const{isExiting:Zr,isAnimating:Jr,resetAnimationState:Qr}=Yc({map:Jt,showTopology:D,validatedPolylines:Zt,weakPolylines:zn,maxCertainCount:Kn,loopEdgeKeys:Ur,backboneEdgeKeys:Kr,highlightedEdgeKey:c,neighbors:e,validatedSourceId:jn,weakSourceId:Nn,neighborPolylines:Un,showNeighborLines:Y,neighborSourceId:kn,neighborLinkScores:zr,basemapMode:Ne}),Qt=i.useMemo(()=>{const d=new Set;for(const v of l.hubNodes){d.add(v);for(const N of l.validatedEdges)N.fromHash===v&&d.add(N.toHash),N.toHash===v&&d.add(N.fromHash)}return d},[l.hubNodes,l.validatedEdges]),Xr=i.useMemo(()=>{const d=new Set;if(!s)return d;for(const v of l.validatedEdges)v.fromHash===s&&d.add(v.toHash),v.toHash===s&&d.add(v.fromHash);return d},[s,l.validatedEdges]),gt=i.useMemo(()=>{const d=new Map;for(const[v,N]of Pe)d.set(v,$a(N).type);return d},[Pe]),eo=i.useMemo(()=>{let d=0,v=0,N=0;for(const[,F]of gt)F==="repeater"?d++:F==="companion"||F==="unknown"?v++:F==="room_server"&&N++;return{repeater:d,companion:v,room_server:N,hubs:l.hubNodes.length,direct:me.size}},[gt,l.hubNodes.length,me.size]),Be=i.useMemo(()=>new Set(ne),[ne]),{getNodeOpacity:to}=Zc({activeFilters:Be,neighborHashes:Pe.map(([d])=>d),hubConnectedNodes:Qt,directNodeSet:me,localConnectedNodes:Xr,nodeTypeMap:gt,showTopology:D}),{blinkingNodes:no,blinkColor:so}=el({neighbors:e,localHash:s,enabled:Vt}),ro=i.useCallback(d=>{if(Be.size===0)return!1;const v=gt.get(d)??"unknown";return!!(Be.has("repeater")&&v==="repeater"||Be.has("companion")&&(v==="companion"||v==="unknown")||Be.has("room_server")&&v==="room_server"||Be.has("direct")&&me.has(d)||Be.has("hubs")&&Qt.has(d))},[Be,gt,me,Qt]),qn=i.useCallback(()=>{Bn(!0),On(!0)},[]),oo=i.useCallback(()=>{Oe?ae(d=>!d):qn()},[Oe,qn]),ao=i.useCallback(d=>{y(d.viewState),(d.viewState.pitch??0)>10&&!te&&je(!0)},[te]),io=i.useCallback(()=>{R(d=>{var F,K,X,ge,pe,qe,Ve;const v=!d,N=(X=(K=(F=u.current)==null?void 0:F.getContainer())==null?void 0:K.closest(".map-container-fullscreen, .map-container-16-9"))==null?void 0:X.parentElement;return v?N&&document.fullscreenEnabled?(ge=N.requestFullscreen)==null||ge.call(N).catch(()=>{}):N&&document.webkitFullscreenEnabled&&((pe=N.webkitRequestFullscreen)==null||pe.call(N)):document.fullscreenElement?(qe=document.exitFullscreen)==null||qe.call(document).catch(()=>{}):document.webkitFullscreenElement&&((Ve=document.webkitExitFullscreen)==null||Ve.call(document)),v})},[]),co=i.useCallback(()=>{const d=ne.length>=yt.length;de(d?[]:[...yt])},[ne,de]),lo=i.useCallback(d=>{ne.length>=yt.length?de([d]):ne.includes(d)?de(ne.filter(N=>N!==d)):de([...ne,d])},[ne,de]),uo=i.useCallback(()=>{ye(d=>!d)},[]),mo=i.useCallback(()=>{W(d=>!d)},[]),fo=i.useCallback(()=>{st(d=>{const v=!d;return v||dt(null),v})},[]),ho=i.useCallback(()=>{je(d=>{const v=!d;if(u.current){const N=u.current.getMap();N&&N.stop()}if(v&&u.current){const N=u.current.getMap();N&&N.easeTo({pitch:45,duration:1500,easing:lr})}if(!v&&u.current){const N=u.current.getMap();N&&N.easeTo({pitch:0,bearing:0,duration:800,easing:Ga})}return v})},[]),go=i.useCallback(()=>{D||ae(!0)},[D]),po=i.useCallback((d,v)=>{Kt(d),Fn(v)},[]),xo=i.useCallback(()=>{jt&&r&&r(jt),Kt(null),Fn("")},[jt,r]),yo=i.useMemo(()=>[...Al,...kl,...ee?[Wt]:[]],[ee]),Vn=i.useRef(!1);i.useEffect(()=>{Vn.current="ontouchstart"in window||navigator.maxTouchPoints>0},[]);const bo=i.useCallback(d=>{if(ee&&d.features&&d.features.length>0){const v=d.features.find(N=>{var F;return((F=N.layer)==null?void 0:F.id)===Wt});if(v!=null&&v.properties){const{fromHash:N,toHash:F}=v.properties;if(N&&F){const K=x.find(X=>X.nodeA.hash===N&&X.nodeB.hash===F||X.nodeA.hash===F&&X.nodeB.hash===N);if(K){dt(K);return}}}}(!d.features||d.features.length===0)&&(Vn.current&&ft&&(Ue(null),Re(null)),Ae&&Dn(null),wt&&dt(null))},[ft,Ae,ee,x,wt]),vo=i.useCallback(d=>{Dn(v=>v===d?null:d),dt(null)},[]),Co=i.useCallback(d=>{var pe,qe,Ve;if(!d.features||d.features.length===0)return;if(d.features.some(Ee=>{var fe,He;return(He=(fe=Ee.layer)==null?void 0:fe.id)==null?void 0:He.startsWith("node-markers-")})){ce&&(Re(null),Ue(null));return}if(ee&&d.features.some(Ee=>{var fe;return((fe=Ee.layer)==null?void 0:fe.id)===Wt})){try{(pe=u.current)!=null&&pe.getCanvas()&&(u.current.getCanvas().style.cursor="pointer")}catch{}return}const N=d.features.find(Ee=>{var He;const fe=(He=Ee.layer)==null?void 0:He.id;return(fe==null?void 0:fe.startsWith("topology-"))||(fe==null?void 0:fe.startsWith("neighbor-"))});if(!N)return;const F=(qe=N.layer)==null?void 0:qe.id,K=N.properties;if(!(K!=null&&K.key))return;const X=F==null?void 0:F.startsWith("topology-"),ge=F==null?void 0:F.startsWith("neighbor-");if(X||ge){const Ee=K.key.replace(/-loop[12]$/,"");Re(Ee),d.lngLat&&Ue({longitude:d.lngLat.lng,latitude:d.lngLat.lat,type:X?"topology":"neighbor",properties:K})}try{(Ve=u.current)!=null&&Ve.getCanvas()&&(u.current.getCanvas().style.cursor="pointer")}catch{}},[ce,ee]),So=i.useCallback(()=>{var d;Re(null),Ue(null);try{(d=u.current)!=null&&d.getCanvas()&&(u.current.getCanvas().style.cursor="")}catch{}},[]),wo=S?"map-container-fullscreen":"map-container-16-9",Yn=$.length>0||(n==null?void 0:n.latitude)&&(n==null?void 0:n.longitude),Zn=!k||!Yn,jo=Yn;return t.jsxs("div",{className:`relative ${wo} ${S?"":"rounded-2xl overflow-hidden"}`,role:"application","aria-label":"Mesh network contacts map","aria-describedby":"map-instructions","data-basemap":Ne,children:[t.jsx("span",{id:"map-instructions",className:"sr-only",children:"Interactive map showing mesh network contacts. Use mouse or touch to pan and zoom. Press Tab to navigate map controls. Press Escape to exit fullscreen mode."}),Zn&&t.jsx("div",{className:"absolute inset-0 z-50 surface-base rounded-2xl flex items-center justify-center","aria-hidden":"true",children:t.jsxs("div",{className:"flex flex-col items-center gap-3",children:[t.jsx("div",{className:"w-6 h-6 border-2 border-sys-blue border-t-transparent rounded-full animate-spin"}),t.jsx("span",{className:"text-sm text-fg-muted",children:"Loading map..."})]})}),jo&&t.jsx("div",{className:`relative w-full h-full ${S?"":"rounded-[1.125rem] overflow-hidden"} ${Zn?"opacity-0":"opacity-100 transition-opacity duration-300"}`,style:I?{visibility:"hidden"}:void 0,children:t.jsxs(Eo,{ref:u,...P,onMove:ao,mapStyle:Kl,style:{width:"100%",height:"100%"},attributionControl:!1,interactiveLayerIds:yo,onMouseMove:Co,onMouseLeave:So,onClick:bo,onError:d=>{console.error("MapLibre error:",d.error)},onIdle:()=>{if(!B&&!_&&u.current){const d=u.current.getMap();if(d){const v=Object.values(e).filter(N=>N.latitude&&N.longitude).map(N=>({latitude:N.latitude,longitude:N.longitude}));n!=null&&n.latitude&&(n!=null&&n.longitude)&&v.push({latitude:n.latitude,longitude:n.longitude}),v.length>0&&O(v,d)}}},children:[t.jsx(Mo,{position:"bottom-right"}),t.jsx(Pa,{mode:Ne}),t.jsx(vc,{enabled:te,exaggeration:4}),t.jsx(bc,{coveragePoints:mt,visible:mt.length>0&&Nt,terrainEnabled:te,brightness:Fr,basemapMode:Ne}),t.jsx(zc,{partition:Ke,nodeCoordinates:le,visible:re&&Oe,opacity:V.opacity,bandwidth:V.bandwidth,threshold:V.threshold,strokeWidth:V.strokeWidth}),t.jsx(Rl,{showTopology:D,isExiting:Zr,hoveredEdgeKey:ce,highlightedLoopEdges:kt==null?void 0:kt.highlightedEdgeKeys,highlightedFocusEdges:qr,onEdgeHover:Hr,onLoopHover:$r,loops:l.loops,neighborNames:Gr,opacityBias:Nr,widthMultiplier:kr,trafficFilter:Er,showNeighborLines:Y,disableHover:Jr||Pn}),t.jsx(Hl,{visible:ee,nodeCoordinates:le,focusedNodeHash:Ae,basemapMode:Ne}),o&&t.jsx(Il,{targetHash:o,nodeCoordinates:le,onComplete:a}),c&&t.jsx(_l,{highlightedEdgeKey:c,validatedPolylines:Zt,weakPolylines:zn,onEnsureTopology:go}),t.jsx(Ul,{ghost:f??null,neighborCoordinates:le,onHighlightedNeighborsChange:Dr}),t.jsx(Nl,{neighborsWithLocation:Pe,localNode:n,localHash:s,zeroHopNeighbors:me,lastHopNeighborMap:ht,meshTopology:l,hoveredMarker:Te,onMarkerHover:ie,getNodeOpacity:to,shouldShowNode:ro,onRequestRemove:r?po:void 0,openPopupId:Ar,onOpenPopup:Ir,onClosePopup:_r,onNodeClick:vo,blinkingNodes:no,blinkColor:so})]})}),(()=>{const d=Jl(ft?{type:ft.type,properties:ft.properties}:null,kt,Kn,l.edgeMap);return d&&t.jsx("div",{className:"map-edge-tooltip",children:t.jsx("div",{className:"map-control-surface map-edge-tooltip-inner",children:t.jsx(Ql,{data:d})})})})(),t.jsx(ci,{mapRef:u,showNeighborLines:Y,onToggleNeighborLines:uo,hasNeighborPolylines:Un.length>0,nodeFilters:ne,onToggleFilter:lo,onToggleAll:co,filterCounts:eo,showCoverage:G,onToggleCoverage:mo,showMinCut:re,onToggleMinCut:Vr,hasMinCutData:Oe&&Ke!==null&&Ke.numCommunities>1,show3DTerrain:te,onToggle3DTerrain:ho,basemapMode:Ne,onToggleBasemap:Br,isFullscreen:S,onToggleFullscreen:io,showLinkQuality:ee,onToggleLinkQuality:fo,hasTraceLinks:p}),ee&&wt&&t.jsx(rc,{pair:wt,onClose:()=>dt(null),prefixToName:Wr}),t.jsxs("div",{className:"map-legend-stack",children:[t.jsxs("div",{className:"map-tool-row",children:[t.jsx(pi,{isActive:D,hasAnalyzed:Oe,isLoading:Pn,onClick:oo,basemapMode:Ne}),t.jsx(wi,{isActive:Vt,onClick:Pr,basemapMode:Ne}),t.jsx(Ti,{isActive:mt.length>0&&Nt,onClick:Or,basemapMode:Ne})]}),t.jsx(oi,{showTopology:D,validatedPolylineCount:Zt.length,filteredNeighborCount:Pe.length,hasLocalNode:!!(n!=null&&n.latitude&&(n!=null&&n.longitude)),meshTopology:l,zeroHopNeighbors:me,neighborsWithLocation:Pe,basemapMode:Ne})]}),t.jsx(na,{isOpen:jt!==null,onCancel:()=>Kt(null),onConfirm:xo,title:"Remove Node?",message:`Remove "${Mr}" from the contacts list? This will hide the node until it sends a new packet.`,confirmLabel:"Remove",cancelLabel:"Cancel",variant:"danger"}),t.jsx(aa,{isOpen:Lr,onClose:()=>{On(!1),Bn(!1),Qr(),Rr(!0),setTimeout(()=>ae(!0),ei)}}),t.jsx(Yi,{}),t.jsx(Ji,{visible:re&&Oe,onClose:()=>be(!1),settings:V,onSettingsChange:Z,partition:Ke,totalNodes:Object.keys(e).length,basemapMode:Ne})]})}export{Lu as default};
