import{r as e,j as o}from"./vendor-react-alRNW2nb.js";import{M as t,S as r,L as n,a as s,P as i}from"./maplibre-gl-BwLPRSIs.js";import{c as a}from"./vendor-core-FtpmsTnh.js";import{u as l,B as d}from"./BasemapLayer-CSqjQAiA.js";import{ag as c,ab as u,db as m,Z as p,ai as h,h as g,dc as f}from"./index-D7i6lQrq.js";import{bn as x,K as b}from"./vendor-icons-TO0PZKGR.js";import"./vendor-virt-BytWoLhu.js";import"./cosmograph-DqYT4sUA.js";import"./vendor-charts-C916_-gs.js";import"./vendor-motion-DNp0Qg4F.js";import"./vendor-fonts-CRZaZSFf.js";const v={version:8,sources:{},layers:[],glyphs:"https://demotiles.maplibre.org/font/{fontstack}/{range}.pbf"},y={nodeColor:"#4338CA",localColor:"#4F46E5",hubColor:"#6366F1",edgeColor:"#3B3F4A",ambiguousColor:"#F9D26F",highlightColor:"#B49DFF",sourceColor:"#39D98A",destinationColor:"#B49DFF"};function C(e,o){if(!e)return o;if(e.startsWith("#"))return e;const t=f(e);return t?`#${t.r.toString(16).padStart(2,"0")}${t.g.toString(16).padStart(2,"0")}${t.b.toString(16).padStart(2,"0")}`:o}function j(){if("undefined"==typeof document)return y;const e=document.documentElement,o=getComputedStyle(e);return{nodeColor:C(o.getPropertyValue("--map-node-stroke").trim(),y.nodeColor),localColor:C(o.getPropertyValue("--map-local-color").trim(),y.localColor),hubColor:C(o.getPropertyValue("--map-hub-color").trim(),y.hubColor),edgeColor:C(o.getPropertyValue("--map-edge-rest").trim(),y.edgeColor),ambiguousColor:C(o.getPropertyValue("--sys-indigo").trim(),y.ambiguousColor),highlightColor:C(o.getPropertyValue("--sys-blue").trim(),y.highlightColor),sourceColor:C(o.getPropertyValue("--sys-green").trim(),y.sourceColor),destinationColor:C(o.getPropertyValue("--sys-blue").trim(),y.destinationColor)}}function k({prefix:t,isLocal:r,isSource:n,isDestination:s,isLastHop:i,isHighlighted:l,isWardrive:d,candidate:c,onHover:u,onLeave:m,onClick:p}){const[h,f]=e.useState(!1),v=e.useCallback(()=>{f(!0),u()},[u]),y=e.useCallback(()=>{f(!1),m()},[m]);return d?o.jsxs("div",{className:a("flex items-center cursor-pointer","transition-all duration-150",l&&"ring-2 ring-sys-blue/50 rounded-full",h&&"relative z-50"),onMouseEnter:v,onMouseLeave:y,onClick:p,style:{pointerEvents:"auto"},children:[o.jsx("div",{className:a("flex items-center justify-center","w-7 h-7 rounded-full","bg-sys-orange text-white","shadow-lg border-2 border-sys-orange/50","transition-transform duration-150",h&&"scale-110"),children:o.jsx(x,{className:"w-4 h-4",strokeWidth:2.5})}),h&&o.jsxs(g,{color:"orange",filled:!0,className:"ml-1 type-data-xs shadow-lg",children:[t,c.name&&o.jsx("span",{className:"ml-1 opacity-75",children:c.name})]})]}):o.jsx("div",{className:a("flex items-center cursor-pointer","transition-all duration-150",l&&"ring-2 ring-sys-blue/50 rounded",h&&"relative z-50"),onMouseEnter:v,onMouseLeave:y,onClick:p,style:{pointerEvents:"auto"},children:o.jsxs(g,{color:d?"orange":r?"amber":n?"green":i?"amber":s?"purple":"blue",filled:!0,className:"type-data-xs shadow-lg border border-current/30",children:[r&&o.jsx(b,{className:"w-2.5 h-2.5 mr-1"}),t,h&&c.name&&o.jsx("span",{className:"ml-1 opacity-75",children:c.name})]})})}function N({hopNumber:e,snr:t,edgeColor:r}){return o.jsxs("div",{className:"flex flex-col items-center gap-0.5 pointer-events-none",children:[o.jsx("span",{className:"w-3.5 h-3.5 rounded-full flex items-center justify-center font-mono font-bold tabular-nums shadow-md",style:{backgroundColor:r||p[500],color:"#fff",fontSize:"8px",lineHeight:1,textShadow:"0 1px 1px rgba(0,0,0,0.4)"},children:e}),void 0!==t&&o.jsx(g,{color:"zinc",compact:!0,className:"!text-[9px] font-mono tabular-nums shadow-sm",children:t.toFixed(1)})]})}function S({resolvedPath:a,localNode:g,hubNodes:f=[],hoveredHopIndex:x,onHoverHop:b,traceSnr:y}){const C=void 0!==y&&y.length>0,S=e.useRef(null),w=l(),F=c(),L=e.useMemo(()=>new Set(f),[f]),[M,P]=e.useState(null),D=u(),[E,H]=e.useState(!1),[$,W]=e.useState(0);e.useEffect(()=>{var e;const o=null==(e=S.current)?void 0:e.getMap();if(!o)return;const t=o.getCanvas();if(!t)return;const r=e=>{e.preventDefault(),console.warn("[PathMapMapLibre] WebGL context lost")},n=()=>{W(e=>e+1)};return t.addEventListener("webglcontextlost",r),t.addEventListener("webglcontextrestored",n),()=>{t.removeEventListener("webglcontextlost",r),t.removeEventListener("webglcontextrestored",n)}},[$]);const{positions:V,markers:B,edges:I}=e.useMemo(()=>{const e=[],o=[],t=[],r=[];let n=0,s=!1;return a.hops.forEach((i,a)=>{const l=i.candidates.filter(e=>{return o=e.latitude,t=e.longitude,0!==o||0!==t;var o,t});if(0===l.length)return;const d=[...l].sort((e,o)=>o.probability-e.probability)[0],c=[d.longitude,d.latitude];if(r.push(c),r.length>=2){const e=r[r.length-2],o=r.length-2,n=null==y?void 0:y[o],i=c[0]-e[0],a=c[1]-e[1],l=Math.atan2(i,a)*(180/Math.PI),d=j();let u;u=s?"#F97316":void 0!==n?m()[h(n,F)]||p[500]:d.edgeColor,t.push({from:e,to:c,snrFwd:n,midpoint:[(e[0]+c[0])/2,(e[1]+c[1])/2],bearing:l,color:u,isFromWardrive:s})}const u=!0===i.isSource,g=!0===i.isDestination,f=!0===d.isWardrive;s=f,l.forEach((t,r)=>{const s=[t.latitude,t.longitude];e.push(s);const d=0===r;o.push({position:s,prefix:i.prefix,confidence:i.confidence,candidateCount:l.length,hopIndex:a,candidate:t,isHub:L.has(t.hash),isPrimary:d,isSource:u,isDestination:g,validIndex:n})}),n++}),{positions:e,markers:o,edges:t}},[a,L,y,F]),A=e.useMemo(()=>I.map(e=>({type:"FeatureCollection",features:[{type:"Feature",properties:{},geometry:{type:"LineString",coordinates:[e.from,e.to]}}]})),[I]),z=e.useMemo(()=>{const e=B.filter(e=>e.isPrimary&&(e.confidence>=.5||e.isSource||e.isDestination));if(0===e.length)return null;let o=1/0,t=-1/0,r=1/0,n=-1/0;for(const s of e){const[e,i]=s.position;e<o&&(o=e),e>t&&(t=e),i<r&&(r=i),i>n&&(n=i)}return[[r,o],[n,t]]},[B]),R=e.useMemo(()=>{if(0===V.length)return g?[g.longitude,g.latitude]:[0,0];let e=0,o=0;for(const[t,r]of V)e+=t,o+=r;return[o/V.length,e/V.length]},[V,g]),Z=e.useCallback(()=>{var e;const o=null==(e=S.current)?void 0:e.getMap();o&&z?(o.fitBounds(z,{padding:{top:50,bottom:50,left:50,right:50},maxZoom:15,duration:0}),setTimeout(()=>{H(!0)},50)):H(!0)},[z]),O=e.useMemo(()=>z?`${z[0][0].toFixed(5)},${z[0][1].toFixed(5)},${z[1][0].toFixed(5)},${z[1][1].toFixed(5)}`:"",[z]);e.useEffect(()=>{var e;if(!E)return;const o=null==(e=S.current)?void 0:e.getMap();o&&z&&o.fitBounds(z,{padding:{top:50,bottom:50,left:50,right:50},maxZoom:15,duration:300})},[O,E,z]);const T=D&&E,G=e.useCallback(e=>{P({longitude:e.position[1],latitude:e.position[0],marker:e})},[]);return 0===V.length?o.jsx("div",{className:"h-full flex items-center justify-center text-fg-muted text-sm bg-elevated",children:"No mappable path data"}):o.jsxs("div",{className:"h-full w-full relative",children:[!T&&o.jsx("div",{className:"absolute inset-0 bg-elevated flex items-center justify-center pointer-events-none",children:o.jsx("div",{className:"w-5 h-5 border-2 border-text-muted/30 border-t-text-muted rounded-full animate-spin"})}),o.jsx("div",{className:"h-full w-full transition-opacity duration-300 ease-out",style:{opacity:T?1:0},children:o.jsxs(t,{ref:S,initialViewState:{longitude:R[0],latitude:R[1],zoom:10},onLoad:Z,style:{height:"100%",width:"100%"},mapStyle:v,attributionControl:!1,children:[o.jsx(d,{mode:w}),I.map((e,t)=>o.jsx(r,{id:`edge-${t}`,type:"geojson",data:A[t],children:o.jsx(n,{id:`edge-line-${t}`,type:"line",paint:{"line-color":e.color,"line-width":4,"line-opacity":1},layout:{"line-cap":"round","line-join":"round"}})},`edge-${t}`)),I.map((e,t)=>o.jsx(s,{longitude:e.midpoint[0],latitude:e.midpoint[1],anchor:"center",children:o.jsx(N,{hopNumber:t+1,snr:C?e.snrFwd:void 0,edgeColor:e.color})},`hop-${t}`)),(()=>{const e=B.filter(e=>e.isPrimary),t=e.length>1?e.length-2:-1;return e.map((e,r)=>{const n=x===e.hopIndex,i=r===t&&!e.candidate.isLocal&&!e.isDestination;return o.jsx(s,{longitude:e.position[1],latitude:e.position[0],anchor:"center",children:o.jsx(k,{prefix:e.prefix,isLocal:e.candidate.isLocal||!1,isSource:e.isSource,isDestination:e.isDestination,isLastHop:i,isHighlighted:n,isWardrive:e.candidate.isWardrive||!1,candidate:e.candidate,onHover:()=>null==b?void 0:b(e.hopIndex),onLeave:()=>null==b?void 0:b(null),onClick:()=>G(e)})},`${e.hopIndex}-${e.candidate.hash}`)})})(),M&&o.jsx(i,{longitude:M.longitude,latitude:M.latitude,anchor:"bottom",offset:[0,-12],closeOnClick:!1,onClose:()=>P(null),className:"maplibre-popup",children:o.jsxs("div",{className:"text-xs",children:[o.jsxs("div",{className:"flex items-center gap-1.5",children:[o.jsx("span",{className:"font-semibold",children:M.marker.candidate.name}),(()=>{const e=j();return o.jsxs(o.Fragment,{children:[M.marker.isSource&&o.jsx("span",{className:"px-1 py-0.5 text-[8px] font-bold rounded",style:{backgroundColor:e.sourceColor,color:"#000"},children:"SRC"}),M.marker.isDestination&&o.jsx("span",{className:"px-1 py-0.5 text-[8px] font-bold rounded",style:{backgroundColor:e.destinationColor,color:"#000"},children:"DST"}),M.marker.isHub&&o.jsx("span",{className:"px-1 py-0.5 text-[8px] font-bold rounded",style:{backgroundColor:e.hubColor,color:"#000"},children:"HUB"}),M.marker.candidate.isLocal&&o.jsx("span",{className:"px-1 py-0.5 text-[8px] font-bold rounded",style:{backgroundColor:e.localColor,color:"#fff"},children:"LOCAL"}),M.marker.candidate.isWardrive&&o.jsx("span",{className:"px-1 py-0.5 text-[8px] font-bold rounded",style:{backgroundColor:"#F97316",color:"#fff"},children:"WARDRIVE"})]})})()]}),o.jsxs("div",{className:"text-fg-muted type-data-xs",children:[M.marker.prefix," â€¢ ",M.marker.candidate.hash.slice(0,10),"..."]}),!M.marker.isPrimary&&M.marker.candidateCount>1&&o.jsxs("div",{style:{color:j().ambiguousColor},children:["Alternative (",(100*M.marker.candidate.probability).toFixed(0),"%)"]}),M.marker.isPrimary&&M.marker.candidateCount>1&&o.jsxs("div",{className:"text-fg-muted",children:[M.marker.candidateCount," candidates"]})]})})]},$)})]})}export{S as default};
