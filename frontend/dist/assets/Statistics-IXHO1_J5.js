var e=Object.defineProperty,t=(t,s,a)=>((t,s,a)=>s in t?e(t,s,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[s]=a)(t,"symbol"!=typeof s?s+"":s,a);import{r as s,j as a}from"./vendor-react-SfmO5UG4.js";import{c as n,a3 as l,aH as i,aI as r,aJ as o,aK as c,h as d,aL as m,aM as u,u as h,aN as x,aO as p,aP as g,aQ as f,aR as b,ag as y,aS as j,ai as v,aT as N,aU as w,q as k,aV as M,aW as S,p as C,t as T,r as A,m as F,a0 as P,a1 as L,v as R,W as $,aX as D,aY as _,aZ as z,a_ as E}from"./index-CF53FmhC.js";import{c as H}from"./vendor-core-D1p9zwXj.js";import{a4 as B,aB as O,u as W,aC as q,aD as I,aE as V,aF as G,aG as Y,H as K,I as X,a3 as U,aH as J,a7 as Q,g as Z,ak as ee,R as te}from"./vendor-icons-QG3AVsi5.js";import{u as se,h as ae,r as ne}from"./consumer-registry-DZR4TejQ.js";import{e as le}from"./easing-BJzdCZaI.js";import{T as ie}from"./TimeRangeStepper-CNE7SkDj.js";import{C as re,P as oe,a as ce,B as de}from"./PageLayout-Dk_m6izQ.js";import{D as me}from"./DataBox-CxIna5a0.js";import{A as ue}from"./AnimatedNumber-CJboLyTu.js";import{C as he}from"./CollisionExplorerModal-Di7J1tFx.js";import{L as xe}from"./LightSparkline-CGmustaT.js";import{c as pe,a as ge,A as fe}from"./AnalyzerFilterPanel-DCracTLr.js";import{a as be}from"./usePipelineStore-5LDag23M.js";import{R as ye,C as je}from"./Grid-BL9S-4ma.js";import"./cosmograph-DqYT4sUA.js";import"./vendor-charts-C916_-gs.js";import"./vendor-motion-BUrLkjC7.js";import"./vendor-fonts-CRZaZSFf.js";import"./maplibre-gl-BQ3zr2TW.js";import"./BasemapLayer-D8l93iaQ.js";import"./node-types-CunV9yGl.js";import"./geo-utils-DJn8DnxF.js";const ve={useAbsoluteThresholds:!0,baselinePercentile:6,spikePercentile:50,baselineDbm:-107,spikeDbm:-100,mergeGapSeconds:45,minSequenceLength:16,similarityToleranceDbm:5};function Ne(e,t){if(0===e.length)return 0;const s=t/100*(e.length-1),a=Math.floor(s),n=Math.ceil(s);return a===n?e[a]:e[a]+(e[n]-e[a])*(s-a)}function we(e){if(0===e.length)return{median:0,p90:0,p95:0,p99:0,max:0,min:0};const t=[...e].sort((e,t)=>e-t);return{median:Ne(t,50),p90:Ne(t,90),p95:Ne(t,95),p99:Ne(t,99),max:t[t.length-1],min:t[0]}}function ke(e,t,s){const a=s-t;if(0===a)return"moderate";const n=(e-t)/a;return n>.66?"critical":n>.33?"severe":"moderate"}const Me=Object.entries(l).map(([e,t])=>{const s=parseInt(e,10);return{typeNum:s,key:`TYPE_${s}`,label:t}});function Se({sortedTypes:e,highlightedType:t,onTypeHover:l,aggregateShares:i,hoverData:r}){const o=s.useMemo(()=>{if(!r)return null;const e=new Map;for(const t of r.items)e.set(t.key,t.value);return e},[r]),c=null!==o,d=s.useMemo(()=>{const t=new Set(e.map(e=>e.key));return[...e.map(e=>({typeNum:e.typeNum,key:e.key,label:e.label})),...Me.filter(e=>!t.has(e.key))]},[e]);return a.jsxs("div",{className:"flex-shrink-0 pt-2 sm:pt-3 mt-1 sm:mt-2 px-0 sm:pr-0",children:[a.jsxs("div",{className:"flex items-center gap-2 mx-0 sm:ml-9 sm:mr-0 mb-1 sm:mb-1.5 type-data-xs",children:[a.jsx("span",{className:"text-fg-muted",children:"Packet Types"}),c&&(null==r?void 0:r.timeLabel)&&a.jsx("span",{className:"text-sys-indigo tabular-nums",children:r.timeLabel})]}),a.jsx("div",{className:"flex flex-wrap gap-x-3 sm:gap-x-4 gap-y-1 type-data-xs mx-0 sm:ml-9 sm:mr-0",onMouseLeave:()=>l(null),children:d.map(e=>{const s=n(e.typeNum),r=(null==o?void 0:o.get(e.key))??0,d=i.get(e.key)??0,m=c?r:d,u=m>1e-4,h=i.has(e.key),x=t===e.key,p=t&&!x||c&&r<=1e-4||!c&&!t&&!h;return a.jsxs("div",{className:H("flex items-center gap-1.5 transition-opacity cursor-pointer hover:opacity-80",p&&"opacity-30"),onMouseEnter:()=>l(e.key),children:[a.jsx("div",{className:"shrink-0 w-3 h-3 rounded-xs",style:{backgroundColor:s}}),a.jsx("span",{className:"text-fg-secondary whitespace-nowrap",children:e.label}),u&&a.jsxs("span",{className:H("tabular-nums",c?"text-fg-primary":"text-fg-muted"),children:[(100*m).toFixed(1),"%"]})]},e.key)})})]})}const Ce='ui-monospace, SFMono-Regular, "SF Mono", Menlo, Consolas, monospace';function Te(e,t,s,a,n){const l=e.reduce((e,t)=>e+t,0);if(l<=0||0===e.length)return[];const i=e.map((e,t)=>t).sort((t,s)=>e[s]-e[t]),r=i.map(t=>e[t]),o=new Array(e.length);return Ae(r,i,l,t,s,a,n,o),o}function Ae(e,t,s,a,n,l,i,r){if(0===e.length)return;if(1===e.length)return void(r[t[0]]={x:a,y:n,w:l,h:i,index:t[0]});const o=l*i/s,c=l>=i,d=c?i:l;let m=0,u=1/0,h=0;for(let y=0;y<e.length;y++){const t=m+e[y],s=t*o/d;if(s<=0){h=y+1,m=t;continue}const a=e[0]*o/s,n=e[y]*o/s,l=Math.max(a>s?a/s:s/a,n>s?n/s:s/n);if(!(l<=u))break;u=l,h=y+1,m=t}const x=d>0?m*o/d:0;let p=0;for(let y=0;y<h;y++){const s=(m>0?e[y]/m:0)*d;r[t[y]]=c?{x:a,y:n+p,w:x,h:s,index:t[y]}:{x:a+p,y:n,w:s,h:x,index:t[y]},p+=s}const g=e.slice(h),f=t.slice(h),b=s-m;c?Ae(g,f,b,a+x,n,l-x,i,r):Ae(g,f,b,a,n+x,l,i-x,r)}function Fe(e,t,s,a,l,i){for(const r of t){const t=s[r.index];if(!t)continue;const o=2*i,c=r.x*i+o/2,d=r.y*i+o/2,m=r.w*i-o,u=r.h*i-o;if(m<=0||u<=0)continue;const h=n(t.typeNum),x=null!==l&&l!==r.index;e.save(),e.globalAlpha=x?.4:1;const p=3*i;e.beginPath(),e.moveTo(c+p,d),e.lineTo(c+m-p,d),e.quadraticCurveTo(c+m,d,c+m,d+p),e.lineTo(c+m,d+u-p),e.quadraticCurveTo(c+m,d+u,c+m-p,d+u),e.lineTo(c+p,d+u),e.quadraticCurveTo(c,d+u,c,d+u-p),e.lineTo(c,d+p),e.quadraticCurveTo(c,d,c+p,d),e.closePath(),e.fillStyle=h,e.fill(),e.strokeStyle="rgba(0,0,0,0.2)",e.lineWidth=1*i,e.stroke();const g=4*i,f=r.w>36&&r.h>20,b=r.w>36&&r.h>32;if(f){const s=11*i;if(b){const n=a>0?t.size/a*100:0;e.font=`500 ${8*i}px ${Ce}`,e.fillStyle="rgba(0,0,0,0.6)",e.textBaseline="alphabetic",e.textAlign="left",e.fillText(`${n.toFixed(1)}%`,c+g,d+u-g-s)}e.font=`600 ${9*i}px ${Ce}`,e.fillStyle="rgba(0,0,0,0.85)",e.textBaseline="alphabetic",e.textAlign="left",e.fillText(t.name,c+g,d+u-g)}e.restore()}}function Pe({data:e,total:t,color:s,position:n,containerWidth:l,isAirtime:i}){if(!e||!n)return null;const r=(e.value/t*100).toFixed(1),o=l-n.x<184?Math.max(8,n.x-160-8):n.x+16;return a.jsx("div",{className:"absolute z-50 pointer-events-none",style:{left:o,top:Math.max(8,n.y-60)},children:a.jsxs("div",{className:"bg-tooltip-bg border border-edge-subtle rounded-lg px-3 py-2 shadow-xl min-w-[140px]",children:[a.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[a.jsx("span",{className:"w-2.5 h-2.5 rounded-sm flex-shrink-0",style:{backgroundColor:s}}),a.jsx("span",{className:"type-data-sm font-semibold text-fg-primary",children:e.name})]}),a.jsxs("div",{className:"space-y-0.5 type-data-xs text-fg-muted",children:[a.jsxs("div",{className:"flex justify-between gap-4",children:[a.jsx("span",{children:i?"Airtime":"Count"}),a.jsx("span",{className:"text-fg-primary tabular-nums font-medium",children:i?Le(e.value):e.value.toLocaleString()})]}),a.jsxs("div",{className:"flex justify-between gap-4",children:[a.jsx("span",{children:"Share"}),a.jsxs("span",{className:"text-fg-primary tabular-nums font-medium",children:[r,"%"]})]}),a.jsxs("div",{className:"flex justify-between gap-4",children:[a.jsx("span",{children:"Total"}),a.jsx("span",{className:"text-fg-primary tabular-nums font-medium",children:i?Le(t):t.toLocaleString()})]})]})]})})}function Le(e){return e>=6e4?`${(e/6e4).toFixed(1)}m`:e>=1e3?`${(e/1e3).toFixed(1)}s`:`${Math.round(e)}ms`}function Re({sortedTypes:e,aggregateShares:t,mode:l="share"}){var i,r,o;const[c,d]=s.useState(null),[m,u]=s.useState(null),[h,x]=s.useState(0),[p,g]=s.useState(null),f=s.useRef(null),b=s.useRef(null),y=s.useRef([]),j="airtime"===l,v=s.useMemo(()=>e.reduce((e,t)=>e+(j?t.totalAirtime:t.totalCount),0),[e,j]),N=s.useMemo(()=>e.map((e,t)=>({name:e.label,size:j?e.totalAirtime:e.totalCount,index:t,typeNum:e.typeNum,key:e.key})),[e,j]);s.useEffect(()=>{const e=b.current;if(!e)return;const t=e.parentElement;if(!t)return;const s=t.getBoundingClientRect(),a=s.width,n=s.height;if(a<=0||n<=0)return;const l=window.devicePixelRatio||1;e.width=Math.floor(a*l),e.height=Math.floor(n*l),e.style.width=`${a}px`,e.style.height=`${n}px`;const i=Te(N.map(e=>e.size),0,0,a,n);y.current=i;const r=e.getContext("2d");r&&(r.clearRect(0,0,e.width,e.height),Fe(r,i,N,v,c,l))},[N,v,c]),s.useEffect(()=>{const e=f.current;if(!e)return;const t=new ResizeObserver(()=>{const t=b.current;if(!t)return;const s=e.getBoundingClientRect(),a=s.width,n=s.height;if(a<=0||n<=0)return;const l=window.devicePixelRatio||1;t.width=Math.floor(a*l),t.height=Math.floor(n*l),t.style.width=`${a}px`,t.style.height=`${n}px`;const i=Te(N.map(e=>e.size),0,0,a,n);y.current=i;const r=t.getContext("2d");r&&(r.clearRect(0,0,t.width,t.height),Fe(r,i,N,v,c,l))});return t.observe(e),()=>t.disconnect()},[N,v]);const w=s.useCallback(e=>{const t=f.current;if(!t)return;const s=t.getBoundingClientRect(),a=e.clientX-s.left,n=e.clientY-s.top,l=function(e,t,s){for(const a of e)if(t>=a.x&&t<=a.x+a.w&&s>=a.y&&s<=a.y+a.h)return a.index;return null}(y.current,a,n);d(l),null!==l?(x(s.width),u({x:a,y:n})):u(null)},[]),k=s.useCallback(()=>{d(null),u(null)},[]),M=s.useCallback(e=>{if(g(e),e){const t=N.findIndex(t=>t.key===e);d(t>=0?t:null)}else d(null)},[N]),S=null!==c?{name:(null==(i=N[c])?void 0:i.name)??"",value:(null==(r=N[c])?void 0:r.size)??0}:null,C=null!==c?n(null==(o=N[c])?void 0:o.typeNum):"";return 0===e.length||0===v?a.jsxs("div",{className:"h-full flex items-center justify-center text-fg-muted",children:[a.jsx(B,{className:"w-6 h-6 mr-2 opacity-50"}),a.jsx("span",{children:"No packet type data available"})]}):a.jsxs("div",{className:"flex flex-col h-full",children:[a.jsx("div",{className:"flex-1 min-h-0 relative",children:a.jsxs("div",{className:"absolute overflow-hidden radius-inner ring-1 ring-inset ring-edge-subtle bg-chart-inner",style:{left:32,right:0,top:0,bottom:20},ref:f,onMouseMove:w,onMouseLeave:k,children:[a.jsx("canvas",{ref:b,className:"absolute inset-0",style:{cursor:"default"}}),a.jsx(Pe,{data:S,total:v,color:C,position:m,containerWidth:h,isAirtime:j})]})}),a.jsx("div",{style:{minHeight:80},children:a.jsx(Se,{sortedTypes:e,highlightedType:p,onTypeHover:M,aggregateShares:t})})]})}function $e(e){return e>=1e9?`${(e/1e9).toFixed(1)} Gb`:e>=1e6?`${(e/1e6).toFixed(1)} Mb`:e>=1e3?`${(e/1e3).toFixed(1)} Kb`:`${e.toFixed(0)} B`}function De({packets:e,mode:t,startTs:n,endTs:l,radioConfig:m,bucketCount:u,lockedYMax:h,legendMinH:x}){const p=s.useMemo(()=>i(),[]),g=p.blue,f=p.red,b=p.yellow,[y,j]=s.useState(null),{trendData:v,totals:N}=s.useMemo(()=>{if(0===e.length)return{trendData:[],totals:{rxBytes:0,txBytes:0,rxAirtime:0,txAirtime:0}};const s=l-n,a=Math.min(Math.ceil(s/300),u),i=s/a,c=[];let d=0,h=0,x=0,p=0;for(const t of e){const e=t.timestamp;if(e<n||e>=l)continue;const s=r(t),a=o(t,{spreadingFactor:m.sf,bandwidthHz:m.bw,codingRate:m.cr,preambleLength:m.preamble}),i={timestamp:e,rxAirtime:0,txAirtime:0,rxBytes:0,txBytes:0};t.transmitted?(i.txAirtime=a,i.txBytes=s,h+=s,p+=a):(i.rxAirtime=a,i.rxBytes=s,d+=s,x+=a),c.push(i)}c.sort((e,t)=>e.timestamp-t.timestamp);const g=new Float64Array(c.length+1),f=new Float64Array(c.length+1),b=new Float64Array(c.length+1),y=new Float64Array(c.length+1),j=new Float64Array(c.length);for(let e=0;e<c.length;e++)g[e+1]=g[e]+c[e].rxAirtime,f[e+1]=f[e]+c[e].txAirtime,b[e+1]=b[e]+c[e].rxBytes,y[e+1]=y[e]+c[e].txBytes,j[e]=c[e].timestamp;const v=e=>{let t=0,s=j.length;for(;t<s;){const a=t+s>>>1;j[a]<e?t=a+1:s=a}return t},N=[],w=1e3*i;for(let e=0;e<a;e++){const s=n+e*i,a=s+i,l=v(s),r=v(a);if("share"===t){const e=b[r]-b[l],t=y[r]-y[l];N.push({timestamp:s,rx:e>0?e:null,tx:t>0?t:null})}else{const e=(g[r]-g[l])/w*100,t=(f[r]-f[l])/w*100;N.push({timestamp:s,rx:e>0?e:null,tx:t>0?t:null})}}const k=2/31;let M=null;return{trendData:N.map(e=>{const t=e.rx;return null!==t&&t>0&&(M=null===M?t:k*t+(1-k)*M),{...e,rxSmooth:null!==M&&M>0?M:null}}),totals:{rxBytes:d,txBytes:h,rxAirtime:x,txAirtime:p}}},[e,n,l,u,t,m]),w=s.useMemo(()=>{if(0===v.length)return"share"===t?100:10;let e=0;for(const t of v){const s=t.rx??0,a=t.tx??0;s>e&&(e=s),a>e&&(e=a)}const s=1.1*e;return"share"===t?s<=100?100:s<=500?100*Math.ceil(s/100):s<=1e3?200*Math.ceil(s/200):s<=5e3?500*Math.ceil(s/500):s<=1e4?1e3*Math.ceil(s/1e3):5e3*Math.ceil(s/5e3):Math.max(1,Math.ceil(s))},[v,t]),k=h??w,M=s.useMemo(()=>{if(null!==y&&v[y]){const e=v[y],s=e.rx??0,a=e.tx??0;return"share"===t?{rx:$e(s),tx:$e(a),total:$e(s+a),isHovered:!0}:{rx:`${s.toFixed(2)}%`,tx:`${a.toFixed(2)}%`,total:`${(s+a).toFixed(2)}%`,isHovered:!0}}if("share"===t)return{rx:$e(N.rxBytes),tx:$e(N.txBytes),total:$e(N.rxBytes+N.txBytes),isHovered:!1};{let e=0,t=0,s=0;for(const l of v)null===l.rx&&null===l.tx||(e+=l.rx??0,t+=l.tx??0,s++);const a=s>0?e/s:0,n=s>0?t/s:0;return{rx:`${a.toFixed(2)}%`,tx:`${n.toFixed(2)}%`,total:`${(a+n).toFixed(2)}%`,isHovered:!1}}},[y,v,N,t]),S=s.useMemo(()=>{const e=l-n,t=e/3600;return[0,.25,.5,.75,1].map(s=>{const a=new Date(1e3*(n+e*s)),l=a.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hour12:!1}),i=a.toLocaleDateString([],{weekday:"short"});return{pct:s,label:t>=24?`${i} ${l}`:l,mobileHidden:.25===s||.75===s}})},[n,l]),C=s.useCallback(e=>{j(e)},[]);if(0===v.length)return a.jsxs("div",{className:"h-full flex items-center justify-center text-fg-muted",children:[a.jsx(B,{className:"w-6 h-6 mr-2 opacity-50"}),a.jsx("span",{children:"No packet data available"})]});const T=s.useMemo(()=>"airtime"===t?k<=5?1:k<=10?2:k<=20?5:Math.ceil(k/5):k<=100?25:k<=500?100:k<=1e3?200:k<=5e3?1e3:k<=1e4?2e3:1e3*Math.ceil(k/5e3),[k,t]),A=s.useMemo(()=>{const e=[];for(let s=0;s<=k;s+=T){const a=100*(1-s/k);let n;n="airtime"===t?`${s}%`:s>=1e6?`${(s/1e6).toFixed(1)}M`:s>=1e3?`${(s/1e3).toFixed(0)}K`:`${s}`,e.push({pos:a,label:n})}return e},[k,T,t]);return a.jsxs("div",{className:"flex flex-col h-full",children:[a.jsxs("div",{className:"flex-1 min-h-0 relative",children:[a.jsx("div",{className:"absolute top-0 left-0 flex flex-col justify-between",style:{width:32,bottom:20},children:A.map((e,t)=>a.jsx("span",{className:"type-data-xs text-fg-secondary text-right pr-1.5",style:{position:"absolute",top:`${e.pos}%`,transform:0===t?"translateY(-100%)":t===A.length-1?"none":"translateY(-50%)",right:0},children:e.label},t))}),a.jsx("div",{className:"absolute overflow-hidden radius-inner ring-1 ring-inset ring-edge-subtle bg-chart-inner",style:{left:32,right:0,top:0,bottom:20},children:a.jsx(c,{data:v,yAxisMode:"share"===t?"share":"airtime",yMax:k,onHover:C,startTs:n,endTs:l,externalAxes:!0})}),a.jsx("div",{className:"absolute left-0 right-0 bottom-0 flex items-center pointer-events-none",style:{left:32,height:20,paddingTop:4},children:S.map((e,t)=>a.jsx("span",{className:"absolute type-data-xs text-fg-muted/60 tabular-nums "+(e.mobileHidden?"hidden sm:inline":""),style:{left:100*e.pct+"%",transform:0===e.pct?"translateX(0)":1===e.pct?"translateX(-100%)":"translateX(-50%)"},children:e.label},t))})]}),a.jsxs("div",{className:"flex items-end justify-between pb-1",style:{minHeight:x},children:[a.jsxs("div",{className:"flex items-center gap-3 sm:gap-5 type-data-sm pl-2 sm:pl-11",children:[a.jsxs("div",{className:"flex items-center gap-1.5",children:[a.jsx("div",{className:"w-4 sm:w-5 h-[2px] rounded-full",style:{backgroundColor:g}}),a.jsx("span",{className:"text-fg-secondary",children:"RX"})]}),a.jsxs("div",{className:"flex items-center gap-1.5",children:[a.jsx("div",{className:"w-4 sm:w-5 h-[2px] rounded-full",style:{backgroundColor:f}}),a.jsx("span",{className:"text-fg-secondary",children:"TX"})]}),a.jsxs("div",{className:"hidden sm:flex items-center gap-1.5",children:[a.jsx("div",{className:"w-5 h-[2px] rounded-full",style:{backgroundColor:b}}),a.jsx("span",{className:"text-fg-secondary",children:"Avg"})]})]}),a.jsxs("div",{className:"flex flex-wrap gap-4 sm:gap-8",children:[a.jsxs("div",{className:"flex items-end gap-2",children:[a.jsx("div",{className:"type-data-xl text-fg-primary",children:M.rx}),a.jsx(d,{color:"zinc",className:"mb-0.5 sm:mb-1",children:"RX"})]}),a.jsxs("div",{className:"flex items-end gap-2",children:[a.jsx("div",{className:"type-data-xl text-fg-primary",children:M.tx}),a.jsx(d,{color:"zinc",className:"mb-0.5 sm:mb-1",children:"TX"})]})]})]})]})}const _e=m,ze=new class{constructor(){t(this,"worker",null),t(this,"listeners",new Set),t(this,"currentResult",null),t(this,"isComputing",!1),t(this,"debounceTimer",null),t(this,"debounceMs",250),t(this,"lastCacheKey",null)}ensureWorker(){if(this.worker)return this.worker;if("undefined"==typeof window)return null;try{this.worker=new Worker(new URL("/assets/bucketing.worker-Dmsaoaph.js",import.meta.url),{type:"module"}),this.worker.onmessage=e=>{this.handleWorkerMessage(e.data)},this.worker.onerror=e=>{console.error("[BucketingService] Worker error:",e),this.isComputing=!1,this.notifyListeners()}}catch(e){console.error("[BucketingService] Failed to initialize worker:",e)}return this.worker}handleWorkerMessage(e){if(this.isComputing=!1,"error"===e.type)return this.currentResult=null,void this.notifyListeners();const t=e.payload;this.currentResult={points:t.points,rawValues:t.rawValues,packetTypes:t.packetTypes,timestamps:t.timestamps,count:t.count,minTime:t.minTime,maxTime:t.maxTime,minValue:t.minValue,maxValue:t.maxValue,rawMinValue:t.rawMinValue,rawMaxValue:t.rawMaxValue,unit:"%",stats:{p5:t.p5,p50:t.p50,p95:t.p95,uniqueValues:t.uniqueValues,topValues:t.topValues}},this.notifyListeners()}notifyListeners(){for(const t of this.listeners)try{t(this.currentResult,this.isComputing)}catch(e){console.error("[BucketingService] Listener error:",e)}}isCacheHit(e){return!(!this.lastCacheKey||!this.currentResult)&&this.lastCacheKey.startTs===e.startTs&&this.lastCacheKey.endTs===e.endTs&&this.lastCacheKey.mode===e.mode&&this.lastCacheKey.packetCount===e.packetCount}compute(e,t,s,a,n){if(0===e.length||!n)return this.currentResult=null,void this.notifyListeners();const l={startTs:t,endTs:s,mode:a,packetCount:e.length};this.isCacheHit(l)||(this.debounceTimer&&clearTimeout(this.debounceTimer),this.debounceTimer=setTimeout(()=>{this.debounceTimer=null,this.computeInternal(e,t,s,a,n,l)},this.debounceMs))}computeInternal(e,t,s,a,n,l){const i=this.ensureWorker();if(!i)return;const c=e.length,d=new Float64Array(c),m=new Float64Array(c),u=new Uint16Array(c),h=new Uint8Array(c),x={spreadingFactor:n.sf,bandwidthHz:n.bw,codingRate:n.cr,preambleLength:n.preamble};for(let g=0;g<c;g++){const t=e[g];d[g]=t.timestamp??0,h[g]=255&(t.type??t.payload_type??255),u[g]=Math.min(r(t),65535),m[g]="airtime"===a?o(t,x):1}this.isComputing=!0,this.lastCacheKey=l,this.notifyListeners();const p={type:"compute",payload:{timestamps:d,airtimeMs:m,byteSizes:u,packetTypes:h,startTs:t,endTs:s,mode:a}};i.postMessage(p,[d.buffer,m.buffer,u.buffer,h.buffer])}getResult(){return this.currentResult}isWorking(){return this.isComputing}subscribe(e){return this.listeners.add(e),e(this.currentResult,this.isComputing),()=>{this.listeners.delete(e)}}clear(){this.currentResult=null,this.lastCacheKey=null,this.notifyListeners()}terminate(){this.debounceTimer&&clearTimeout(this.debounceTimer),this.worker&&(this.worker.terminate(),this.worker=null),this.listeners.clear()}};function Ee({mode:e,packets:t,startTs:n,endTs:l,radioConfig:i,sortedTypes:r,aggregateShares:c,noiseFloorAnomalies:d,showNoiseFloorOverlay:m,overlayOpacity:h=.5,startLabel:x,endLabel:p,lockedYMax:g,legendMinH:f,dotSize:b,dotOpacity:y}){const[j,v]=s.useState(null),[N,w]=s.useState(null),k=s.useMemo(()=>(l-n)/3600,[n,l]),M=s.useCallback(e=>{w(e)},[]),S=function(e,t,a,n,l){const[i,r]=s.useState(()=>ze.getResult());return s.useEffect(()=>ze.subscribe(e=>{r(e)}),[]),s.useEffect(()=>{ze.compute(e,t,a,n,l)},[e,t,a,n,l]),i}(t,n,l,"share"===e?"share":"airtime",i),[C,T]=s.useState(null),A=s.useCallback((e,t)=>{v(e),T(t??null)},[]),F=s.useMemo(()=>{if(null===C||!S||0===S.count)return null;const e=n+C*(l-n);let t;t=k>=168?75:k>=72?35:k>=24?15:k>=3?10:5;const s=60*t/2;return{start:e-s,end:e+s}},[C,S,n,l,k]),P=s.useMemo(()=>F?new Date((F.start+F.end)/2*1e3).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hour12:!1}):null,[F]),L=s.useMemo(()=>{if(null===j||!F)return null;const s=P??"",{start:a,end:n}=F,l=t.filter(e=>e.timestamp>=a&&e.timestamp<n);if(0===l.length)return{timestamp:(a+n)/2,timeLabel:s,items:r.map(e=>({key:e.key,label:e.label,value:0,color:_e(e.typeNum)}))};const c=new Map,d=new Map;let m=0,u=0;for(const e of l){const t=`TYPE_${e.type??e.payload_type??-1}`;if(c.set(t,(c.get(t)??0)+1),m++,i){const s=o(e,{spreadingFactor:i.sf,bandwidthHz:i.bw,codingRate:i.cr,preambleLength:i.preamble});d.set(t,(d.get(t)??0)+s),u+=s}}const h=r.map(t=>{let s;return s="airtime"===e?u>0?(d.get(t.key)??0)/u:0:m>0?(c.get(t.key)??0)/m:0,{key:t.key,label:t.label,value:s,color:_e(t.typeNum)}});return{timestamp:(a+n)/2,timeLabel:s,items:h}},[j,F,P,t,r,e,i]),R="share"===e,$=g??(null==S?void 0:S.maxValue)??(R?200:10),D=s.useMemo(()=>{if(!R)return 5;const e=[10,20,25,50,100,200,250,500,1e3],t=$/4.5;for(const s of e)if(s>=t)return s;return $>5e3?1e3*Math.ceil(t/1e3):100*Math.ceil(t/100)},[$,R]),_=s.useMemo(()=>{const e=[];for(let t=0;t<=$;t+=D){const s=100*(1-t/$);e.push({pos:s,label:R?`${t}B`:`${t}%`})}return e},[$,D,R]);return S&&0!==S.count?a.jsxs("div",{className:"flex flex-col h-full",children:[a.jsxs("div",{className:"flex-1 min-h-0 relative",children:[a.jsx("div",{className:"absolute top-0 left-0 flex flex-col justify-between",style:{width:32,bottom:20},children:_.map((e,t)=>a.jsx("span",{className:"type-data-xs text-fg-secondary text-right pr-1.5",style:{position:"absolute",top:`${e.pos}%`,transform:0===t?"translateY(-100%)":t===_.length-1?"none":"translateY(-50%)",right:0},children:e.label},t))}),a.jsxs("div",{className:"absolute overflow-hidden radius-inner ring-1 ring-inset ring-edge-subtle bg-chart-inner",style:{left:32,right:0,top:0,bottom:20},children:[a.jsx(u,{scatterData:S,yAxisMode:"share"===e?"share":"airtime",onHover:A,noiseFloorAnomalies:d,showNoiseFloorOverlay:m,overlayOpacity:h,highlightedType:N,timeRangeHours:k,yAxisMaxOverride:g,dotSize:b,dotOpacity:y,startTs:n,endTs:l,externalAxes:!0}),P&&a.jsx("div",{className:"absolute top-1 right-1 px-2 py-0.5 bg-elevated/90 rounded type-data-xs text-sys-indigo pointer-events-none z-10",children:P})]}),x&&p&&a.jsxs("div",{className:"absolute left-0 right-0 bottom-0 flex justify-between pointer-events-none type-data-xs text-fg-muted/60",style:{left:32,height:20,paddingTop:4},children:[a.jsx("span",{children:x}),a.jsx("span",{children:p})]})]}),a.jsx("div",{style:{minHeight:f},children:a.jsx(Se,{sortedTypes:r,highlightedType:N,onTypeHover:M,aggregateShares:c,hoverData:L})})]}):a.jsxs("div",{className:"h-full flex items-center justify-center text-fg-muted",children:[a.jsx(B,{className:"w-6 h-6 mr-2 opacity-50"}),a.jsx("span",{children:"No packet data available"})]})}function He({mode:e,onChange:t}){return a.jsxs("div",{className:"toggle-group toggle-group-sm",children:[a.jsx("button",{onClick:()=>t("share"),className:"toggle-group-item "+("share"===e?"active":""),children:"Total"}),a.jsx("button",{onClick:()=>t("airtime"),className:"toggle-group-item "+("airtime"===e?"active":""),children:"Airtime"})]})}function Be({smoothing:e,onChange:t}){return a.jsxs("div",{className:"toggle-group toggle-group-sm",children:[a.jsx("button",{onClick:()=>t("stats"),className:"toggle-group-item "+("stats"===e?"active":""),title:"Statistics view (scatter plot)",children:a.jsx(q,{className:"w-3.5 h-3.5"})}),a.jsx("button",{onClick:()=>t("trend"),className:"toggle-group-item "+("trend"===e?"active":""),title:"Trend line chart",children:a.jsx(I,{className:"w-3.5 h-3.5"})}),a.jsx("button",{onClick:()=>t("ema"),className:"toggle-group-item "+("ema"===e?"active":""),title:"Stacked area (moderate smoothing)",children:a.jsx(B,{className:"w-3.5 h-3.5"})}),a.jsx("button",{onClick:()=>t("ultra"),className:"toggle-group-item "+("ultra"===e?"active":""),title:"Stacked area (heavy smoothing)",children:a.jsx(V,{className:"w-3.5 h-3.5"})}),a.jsx("button",{onClick:()=>t("mosaic"),className:"toggle-group-item "+("mosaic"===e?"active":""),title:"Mosaic view (treemap)",children:a.jsx(G,{className:"w-3.5 h-3.5"})})]})}function Oe({enabled:e,onChange:t,anomalyCount:s=0,showTuning:n=!1,onTuningChange:l}){return a.jsxs("div",{className:"relative inline-flex items-center gap-1",children:[e&&l&&a.jsx("button",{onClick:()=>l(!n),className:"toggle-group toggle-group-sm "+(n?"active":""),title:n?"Hide tuning panel":"Show tuning panel",children:a.jsx("span",{className:"toggle-group-item "+(n?"active":""),children:a.jsx(O,{className:"w-3.5 h-3.5"})})}),a.jsx("button",{onClick:()=>t(!e),className:"toggle-group toggle-group-sm "+(e?"active":""),title:e?"Hide noise floor anomalies":"Show noise floor anomalies",children:a.jsx("span",{className:"toggle-group-item "+(e?"active":""),children:a.jsx(W,{className:"w-3.5 h-3.5"})})}),s>0&&a.jsx("span",{className:"absolute -top-2 -right-2 min-w-[18px] h-[18px] px-1 rounded-full bg-sys-red text-white text-xs font-bold flex items-center justify-center pointer-events-none z-10",children:s>99?"99+":s})]})}const We=[{target:"PacketAnalyzer",fn:"type",minStage:1},{target:"PacketAnalyzer",fn:"airtime",minStage:1,when:ae}];ne(We);const qe={sf:10,bw:25e4,cr:5,preamble:8};function Ie(e,t){const s=new Date(1e3*e),a=e=>e.toString().padStart(2,"0"),n=`${a(s.getHours())}:${a(s.getMinutes())}`;return t<24?n:`${["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][s.getMonth()]} ${s.getDate()} ${n}`}function Ve(e){return l[e]??`TYPE_${e.toString(16).toUpperCase()}`}function Ge(e,t,s,a){const n=2*a+1;let l=0;for(let i=0;i<=a;i++)l+=e[Math.min(i,s-1)];for(let i=0;i<a;i++)l+=e[0];for(let i=0;i<s;i++){t[i]=l/n;const r=i-a,o=i+a+1;l-=e[Math.max(0,Math.min(r,s-1))],l+=e[Math.max(0,Math.min(o,s-1))]}}const Ye={ema:1800,ultra:14400},Ke={ema:"sma",ultra:"gaussian"};function Xe(e,t,s){const a=Ye[e],n=Ke[e]??"sma";if(!a)return{sigma:0,window:1,handleSize:0};let l=Math.round(a/t);l=Math.max(3,Math.min(l,Math.floor(s/3))),l%2==0&&(l+=1);const i="gaussian"===n?Math.ceil(l*Math.sqrt(4/12)*3):Math.ceil(l/2);return"gaussian"===n?{sigma:l*Math.sqrt(4/12),window:l,handleSize:i}:{sigma:0,window:l,handleSize:i}}const Ue=s.memo(function({packets:e,allPackets:t,startTs:l,endTs:i,parentStartTs:c,parentEndTs:d,bucketCount:m,radioConfig:u=qe,mode:p="share",smoothing:g="stats",noiseFloorAnomalies:f=null,showNoiseFloorOverlay:b=!1,overlayOpacity:y=.5,dotSize:j,dotOpacity:v}){se(We);const N=h(),[w,k]=s.useState(null),[M,S]=s.useState(null),[C,T]=s.useState([]),A=s.useRef(null),F=s.useRef(0);s.useEffect(()=>{const t=Math.abs(e.length-F.current);if(0===t&&C.length>0)return;A.current&&clearTimeout(A.current);const s=t>100?50:500;return A.current=setTimeout(()=>{F.current=e.length,T(e)},s),()=>{A.current&&clearTimeout(A.current)}},[e,C.length]);const P=s.useMemo(()=>function(e,t){const s=new Map;for(const n of e){const e=n.type??n.payload_type??-1,a=o(n,{spreadingFactor:t.sf,bandwidthHz:t.bw,codingRate:t.cr,preambleLength:t.preamble}),l=s.get(e)??{count:0,airtime:0};s.set(e,{count:l.count+1,airtime:l.airtime+a})}const a=[];for(const[n,l]of s)a.push({typeNum:n,key:`TYPE_${n}`,label:Ve(n),totalCount:l.count,totalAirtime:l.airtime});return a.sort((e,t)=>t.totalCount-e.totalCount)}(C,u),[C,u]),L=s.useMemo(()=>{if("ema"!==g&&"ultra"!==g)return 0;const e=(i-l)/m,{handleSize:t}=Xe(g,e,m);return t},[g,l,i,m]),R=s.useMemo(()=>function(e,t,s,a,n,l,i=0){const r=s-t,c=r/a,d=1e3*c,m=r/3600,u=t-i*c,h=s+i*c,x=a+2*i,p=[];for(let o=0;o<x;o++){const e=u+o*c,t=new Date(1e3*e),s={timestamp:e,time:m>=24?t.toLocaleDateString([],{weekday:"short",hour:"2-digit",minute:"2-digit",hour12:!1}):t.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hour12:!1}),counts:{},shares:{},airtimes:{},total:0,totalAirtime:0,bucketDurationMs:d};for(const a of l)s.counts[a.key]=0,s.airtimes[a.key]=0;p.push(s)}for(const g of e){const e=g.timestamp;if(e<u||e>=h)continue;const t=Math.min(Math.floor((e-u)/c),x-1),s=`TYPE_${g.type??g.payload_type??-1}`;p[t].counts[s]=(p[t].counts[s]??0)+1,p[t].total++;const a=o(g,{spreadingFactor:n.sf,bandwidthHz:n.bw,codingRate:n.cr,preambleLength:n.preamble});p[t].airtimes[s]=(p[t].airtimes[s]??0)+a,p[t].totalAirtime+=a}for(const o of p)for(const e of l)o.shares[e.key]=o.total>0?o.counts[e.key]/o.total*100:0;return{buckets:p,visibleStart:i,visibleEnd:i+a}}(C,l,i,m,u,P,L),[C,l,i,m,u,P,L]),$=s.useMemo(()=>P.reduce((e,t)=>e+t.totalCount,0),[P]),D=s.useMemo(()=>P.reduce((e,t)=>e+t.totalAirtime,0),[P]),{sortedTypes:_,aggregateShares:z}=s.useMemo(()=>{const e=new Map,t="share"===p?$:D;if(t>0)for(const s of P){const a="share"===p?s.totalCount:s.totalAirtime;e.set(s.key,a/t)}return{sortedTypes:[...P].sort((t,s)=>(e.get(s.key)??0)-(e.get(t.key)??0)),aggregateShares:e}},[P,$,D,p]),E=s.useMemo(()=>function(e,t,s,a="ultra",n,l,i){var r;const{buckets:o,visibleStart:c,visibleEnd:d}=e,m=o.length,u=s.length,h=d-c;if(0===m||0===u)return[];const x=i&&void 0!==n&&void 0!==l?(l-n)/i:(null==(r=o[0])?void 0:r.bucketDurationMs)?o[0].bucketDurationMs/1e3:240,p=Array.from({length:u},()=>new Array(m).fill(0));for(let N=0;N<m;N++){const e=o[N];if("share"===t){if(e.total>0)for(let t=0;t<u;t++)p[t][N]=(e.counts[s[t].key]??0)/e.total}else{let t=0;for(let a=0;a<u;a++)t+=e.airtimes[s[a].key]??0;if(t>0)for(let a=0;a<u;a++)p[a][N]=(e.airtimes[s[a].key]??0)/t}}const{sigma:g,window:f}=Xe(a,x,h);let b;b=g>0?p.map(e=>function(e,t){const s=e.length;if(0===s)return[];if(t<.5)return[...e];const a=Math.sqrt(12*t*t/3+1);let n=Math.floor(a);n%2==0&&n--;const l=n+2,i=(12*t*t-3*n*n-12*n-9)/(-4*n-4),r=Math.round(i),o=[r>0?n:l,r>1?n:l,r>2?n:l];let c=new Float32Array(e);const d=new Float32Array(s);for(const m of o){Ge(c,d,s,(m-1)/2);const e=c;c=d,d.set(e)}return Array.from(c)}(e,g)):p.map(e=>function(e,t){if(0===e.length)return[];if(t<=1)return[...e];const s=e.length,a=new Float32Array(s),n=Math.floor(t/2);let l=0,i=0;for(let r=0;r<=Math.min(n,s-1);r++)l+=e[r],i++;for(let r=0;r<s;r++){a[r]=l/i;const t=r-n,o=r+n+1;t>=0&&(l-=e[t],i--),o<s&&(l+=e[o],i++)}return Array.from(a)}(e,f));for(let N=0;N<m;N++){let e=0;for(let t=0;t<u;t++)b[t][N]=Math.max(0,b[t][N]),e+=b[t][N];if(e>0){const t=1/e;for(let e=0;e<u;e++)b[e][N]*=t}}const y=h>360?Math.ceil(h/360):1,j=Math.ceil(h/y),v=[];for(let N=0;N<j;N++){const e=c+N*y,t=Math.min(c+(N+1)*y,d),a=t-e,n=new Array(u).fill(0);for(let s=e;s<t;s++)for(let e=0;e<u;e++)n[e]+=b[e][s];for(let s=0;s<u;s++)n[s]/=a;let l=0;for(let s=0;s<u;s++)l+=n[s];if(l>0){const e=1/l;for(let t=0;t<u;t++)n[t]*=e}const i={timestamp:o[e].timestamp,time:o[e].time};for(let r=0;r<u;r++)i[s[r].key]=n[r];v.push(i)}return v}(R,p,_,g,l,i,m),[R,p,_,g,l,i,m]),H=s.useCallback(e=>k(e),[]),O=s.useCallback(e=>S(e),[]),W=s.useCallback(e=>k(e),[]),q=s.useMemo(()=>{if(null===M||!E[M])return null;const e=E[M];return{timestamp:e.timestamp,timeLabel:e.time,items:_.map(t=>({key:t.key,label:t.label,value:e[t.key]??0,color:n(t.typeNum)}))}},[M,E,_]),I=s.useMemo(()=>({timestamps:E.map(e=>e.timestamp),series:_.map(e=>({key:e.key,label:e.label,color:n(e.typeNum),values:E.map(t=>t[e.key]??0)}))}),[E,_]),V=t&&void 0!==c&&void 0!==d&&(l!==c||i!==d),G=s.useMemo(()=>{if(V&&t&&void 0!==c&&void 0!==d)return function(e,t,s,a,n){const l=Math.max(1,Math.ceil((s-t)/300));if("airtime"===a){const a=new Float64Array(l);for(const r of e){const e=r.timestamp;e<t||e>=s||(a[Math.min(Math.floor((e-t)/300),l-1)]+=o(r,{spreadingFactor:n.sf,bandwidthHz:n.bw,codingRate:n.cr,preambleLength:n.preamble}))}let i=0;for(let e=0;e<l;e++){const t=a[e]/3e5*100;t>i&&(i=t)}return Math.max(1,Math.ceil(1.1*i))}{let a=0;for(const n of e){const e=n.timestamp;if(e<t||e>=s)continue;const l=r(n);l>a&&(a=l)}return a<=200?200:50*Math.ceil(1.1*a/50)}}(t,c,d,p,u)},[V,t,c,d,p,u]);if(0===C.length)return 0===e.length?a.jsxs("div",{className:"h-full flex items-center justify-center text-fg-muted",children:[a.jsx(B,{className:"w-6 h-6 mr-2 opacity-50"}),a.jsx("span",{children:"No packet data available"})]}):null;if("mosaic"===g)return a.jsx(Re,{sortedTypes:_,aggregateShares:z,mode:p});const Y=(i-l)/3600,K=Ie(l,Y),X=Ie(i,Y);return"stats"===g?a.jsx(Ee,{mode:p,packets:C,startTs:l,endTs:i,radioConfig:u,sortedTypes:_,aggregateShares:z,noiseFloorAnomalies:f,showNoiseFloorOverlay:b,overlayOpacity:y,startLabel:K,endLabel:X,lockedYMax:G,legendMinH:80,dotSize:j,dotOpacity:v}):"trend"===g?a.jsx(De,{packets:C,mode:p,startTs:l,endTs:i,radioConfig:u,bucketCount:m,lockedYMax:G,legendMinH:80}):a.jsxs("div",{className:"flex flex-col h-full",children:[a.jsxs("div",{className:"flex-1 min-h-0 relative",children:[a.jsx("div",{className:"absolute top-0 left-0 flex flex-col justify-between",style:{width:32,bottom:20},children:[0,20,40,60,80,100].map((e,t,s)=>a.jsxs("span",{className:"type-data-xs text-fg-secondary text-right pr-1.5",style:{position:"absolute",top:100*(1-e/100)+"%",transform:0===t?"translateY(-100%)":t===s.length-1?"none":"translateY(-50%)",right:0},children:[e,"%"]},e))}),a.jsx("div",{className:"absolute overflow-hidden radius-inner ring-1 ring-inset ring-edge-subtle bg-chart-inner",style:{left:32,right:0,top:0,bottom:20},children:a.jsx(x,{timestamps:I.timestamps,series:I.series,highlightedKey:w,cursorColor:N.cursor,onHover:O,onSeriesHover:W,overlayLine:null,startTs:l,endTs:i,externalAxes:!0})}),a.jsxs("div",{className:"absolute left-0 right-0 bottom-0 flex justify-between pointer-events-none type-data-xs text-fg-muted/60",style:{left:32,height:20,paddingTop:4},children:[a.jsx("span",{children:K}),a.jsx("span",{children:X})]})]}),a.jsx("div",{style:{minHeight:80},children:a.jsx(Se,{sortedTypes:_,highlightedType:w,onTypeHover:H,aggregateShares:z,hoverData:q})})]})}),Je={"1x":1,"2x":2,"4x":4,"8x":8,"16x":16,"36x":36},Qe=[1,5,10,25,50,100,150],Ze=22.5*Math.PI/180,et=Math.sin(Ze),tt=Math.cos(Ze);function st(e,t,s,a){const n=Math.PI/180,l=(a-t)*n,i=e*n,r=s*n,o=Math.sin(l)*Math.cos(r),c=Math.cos(i)*Math.sin(r)-Math.sin(i)*Math.cos(r)*Math.cos(l);return(180*Math.atan2(o,c)/Math.PI+360)%360}function at(e,t,s,a){const n=Math.PI/180,l=(s-e)*n,i=(a-t)*n,r=Math.sin(l/2)**2+Math.cos(e*n)*Math.cos(s*n)*Math.sin(i/2)**2;return 12742*Math.atan2(Math.sqrt(r),Math.sqrt(1-r))}const nt=[{min:10,label:"Excellent"},{min:7,label:"Very Good"},{min:4,label:"Good"},{min:1,label:"Fair+"},{min:-2,label:"Fair"},{min:-5,label:"Fair-"},{min:-8,label:"Poor"},{min:-11,label:"Bad"},{min:-1/0,label:"Critical"}];function lt(e,t,s){return t[v(e,s)]||"#808080"}const it=s.memo(function({neighbors:e,quickNeighbors:t,localLat:n,localLon:l,onStatsChange:r,title:o,badge:c,stats:m}){const[u,h]=s.useState(null),[x,v]=s.useState(new Set),[N,w]=s.useState({width:0,height:0}),[k,M]=s.useState("1x"),[S,C]=s.useState(1),T=s.useRef(null),A=s.useRef({}),F=s.useRef(null),P=s.useRef(S);P.current=S;const L=p(),R=g(),$=f(),D=b(),_=i(),z=y(),E=D?$.primary:$.secondary,H=D?.15:.4,B=D?.08:.25,O=D?_.blue:$.primary;s.useEffect(()=>{const e=F.current;if(!e)return;const t=new ResizeObserver(e=>{for(const t of e){const{width:e,height:s}=t.contentRect;e>0&&s>0&&w({width:e,height:s})}});t.observe(e);const s=e.getBoundingClientRect();return s.width>0&&s.height>0&&w({width:s.width,height:s.height}),()=>t.disconnect()},[]);const W=s.useMemo(()=>{const e=new Set;if(t)for(const s of t)e.add(s.hash);return e},[t]),q=s.useMemo(()=>{const e=new Map;if(t)for(const s of t)e.set(s.hash,{snr:s.avgSnr,rssi:s.avgRssi});return e},[t]),{processedNeighbors:I,maxDistance:V,totalNeighbors:G,zeroHopCount:K}=s.useMemo(()=>{const t=[];for(const[a,i]of Object.entries(e)){if(!i.latitude||!i.longitude||0===i.latitude||0===i.longitude)continue;if(!W.has(a))continue;const e=st(n,l,i.latitude,i.longitude),s=at(n,l,i.latitude,i.longitude),r=q.get(a);t.push({hash:a.slice(0,8),name:i.node_name||i.name||"Unknown",snr:(null==r?void 0:r.snr)??i.snr??null,rssi:(null==r?void 0:r.rssi)??i.rssi??null,bearing:e,distance:s,normalizedDistance:0,lastSeen:i.last_seen,isZeroHop:!0})}const s=1.08*(t.length>0?Math.max(...t.map(e=>e.distance)):0);return t.sort((e,t)=>(e.snr??-1/0)-(t.snr??-1/0)),{processedNeighbors:t,maxDistance:s,totalNeighbors:t.length,zeroHopCount:t.length}},[e,n,l,W,q]);s.useEffect(()=>{null==r||r({zeroHopCount:K,totalCount:G,maxDistanceKm:V})},[K,G,V]),s.useEffect(()=>{const e=Je[k],t=P.current;T.current&&cancelAnimationFrame(T.current);const s=performance.now(),a=n=>{const l=n-s,i=Math.min(l/400,1),r=le(i);C(t+(e-t)*r),T.current=i<1?requestAnimationFrame(a):null};return T.current=requestAnimationFrame(a),()=>{T.current&&cancelAnimationFrame(T.current)}},[k]);const X=V/S,U=s.useMemo(()=>Qe.filter(e=>e<=1.1*X),[X]);s.useEffect(()=>{const e=[];for(const s of I){const t=A.current[s.hash];void 0!==t&&t!==s.lastSeen&&e.push(s.hash),A.current[s.hash]=s.lastSeen}if(0===e.length)return;queueMicrotask(()=>{v(t=>new Set([...t,...e]))});const t=setTimeout(()=>{v(t=>{const s=new Set(t);return e.forEach(e=>s.delete(e)),s})},600);return()=>clearTimeout(t)},[I]);const J=0!==n&&0!==l,Q=s.useMemo(()=>{const{width:e,height:t}=N,s=e/2,a=t/2,n=Math.min(e,t),l=Math.max(10,n/2-6);return{width:e,height:t,centerX:s,centerY:a,radius:Math.max(10,l-8),labelRadius:l}},[N]),{width:Z,height:ee,centerX:te,centerY:se,radius:ae,labelRadius:ne}=Q,ie=s.useId(),re=s.useCallback((e,t)=>{const s=e*Math.PI/180;return{x:te+ae*t*Math.sin(s),y:se-ae*t*Math.cos(s)}},[te,se,ae]),oe=s.useCallback(e=>{const t={N:0,NE:45,E:90,SE:135,S:180,SW:225,W:270,NW:315}[e]*Math.PI/180;return{x:te+ne*Math.sin(t),y:se-ne*Math.cos(t)}},[te,se,ne]),ce=s.useCallback(e=>{h(e)},[]),de=s.useCallback(e=>{M(e)},[]),me=s.useCallback(e=>V<=0?0:e/V*S,[V,S]),ue=e=>`${e}km`,he=s.useMemo(()=>{const e=[{x:te,y:se-ne},{x:te+ne*Math.SQRT1_2,y:se-ne*Math.SQRT1_2}],t=U.map(e=>{const t=e/V*S;return{km:e,scale:t,lx:te+ae*t*et,ly:se-ae*t*tt}}).filter(e=>e.scale<=1.05&&e.scale>=.02).sort((e,t)=>t.km-e.km),s=[];for(const a of t){const t=s.some(e=>{const t=e.lx-a.lx,s=e.ly-a.ly;return Math.sqrt(t*t+s*s)<28}),n=e.some(e=>{const t=e.x-a.lx,s=e.y-a.ly;return Math.sqrt(t*t+s*s)<28});t||n||s.push(a)}return s},[U,V,S,te,se,ae,ne]),xe=N.width>0&&N.height>0;return J?0===G?a.jsxs("div",{ref:F,className:"flex flex-col items-center justify-center h-full text-fg-secondary",children:[a.jsx(Y,{className:"w-8 h-8 mb-2 opacity-50"}),a.jsx("p",{children:"No nodes with location data"})]}):a.jsxs("div",{className:"flex h-full w-full overflow-visible",children:[a.jsxs("div",{ref:F,className:"relative flex-1 min-w-0 h-full overflow-visible -ml-4 sm:-ml-5",children:[xe&&a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"absolute depth-raised",style:{left:te-ae-8-4,top:se-ae-8-4,width:2*(ae+8)+8,height:2*(ae+8)+8,borderRadius:"50%",padding:4,boxSizing:"border-box",backgroundColor:D?"var(--zinc-925)":"var(--zinc-75)"}}),a.jsxs("svg",{width:Z,height:ee,className:"absolute inset-0 z-0",style:{overflow:"visible"},children:[a.jsxs("defs",{children:[a.jsx("style",{children:"\n                @keyframes neighbor-blink-scale {\n                  0%, 100% {\n                    transform: scale(1);\n                    opacity: 0;\n                  }\n                  50% {\n                    transform: scale(1.3);\n                    opacity: 0.8;\n                  }\n                }\n                .neighbor-blink-ring {\n                  transform-origin: center;\n                  animation: neighbor-blink-scale 600ms ease-out forwards;\n                }\n              "}),a.jsx("clipPath",{id:ie,children:a.jsx("circle",{cx:te,cy:se,r:ae})})]}),(()=>{const e=ae+8+12,t=D?"rgba(255, 255, 255, 0.12)":"rgba(0, 0, 0, 0.15)",s=D?"rgba(59, 130, 246, 0.4)":"rgba(59, 130, 246, 0.5)",n=[45,135,225,315];return a.jsxs("g",{className:"radar-frame","aria-hidden":"true",children:[a.jsx("circle",{cx:te,cy:se,r:e,fill:"none",stroke:t,strokeWidth:1,strokeDasharray:"2 6"}),n.map(t=>{const n=t*Math.PI/180,l=Math.cos(n),i=Math.sin(n),r=e+4,o=e+4+16,c=te+r*i,d=se-r*l,m=te+o*i,u=se-o*l;return a.jsxs("g",{children:[a.jsx("line",{x1:c,y1:d,x2:m,y2:u,stroke:s,strokeWidth:1}),a.jsx("line",{x1:m-4*l,y1:u-4*i,x2:m+4*l,y2:u+4*i,stroke:s,strokeWidth:1})]},`corner-${t}`)}),[0,90,180,270].map(s=>{const n=s*Math.PI/180,l=te+(e-6)*Math.sin(n),i=se-(e-6)*Math.cos(n),r=te+(e+2)*Math.sin(n),o=se-(e+2)*Math.cos(n);return a.jsx("line",{x1:l,y1:i,x2:r,y2:o,stroke:t,strokeWidth:1},`tick-cardinal-${s}`)}),n.map(s=>{const n=s*Math.PI/180,l=te+(e-4)*Math.sin(n),i=se-(e-4)*Math.cos(n),r=te+(e+1)*Math.sin(n),o=se-(e+1)*Math.cos(n);return a.jsx("line",{x1:l,y1:i,x2:r,y2:o,stroke:t,strokeWidth:1},`tick-intercardinal-${s}`)})]})})(),(()=>{const e=[(ae+8+4)/ae,...U.map(e=>me(e)).filter(e=>e>.02&&e<=1.05).sort((e,t)=>t-e),0];return e.slice(0,-1).map((t,s)=>{const n=e[s+1],l=ae*t,i=ae*n,r=l-i;return r<=0||s%2!=0?null:a.jsx("circle",{cx:te,cy:se,r:(l+i)/2,fill:"none",stroke:"var(--subtle-fill)",strokeWidth:r,opacity:.8},`band-${s}`)})})(),U.map(e=>{const t=me(e);if(t>1.05||t<.02)return null;const s=he.some(t=>t.km===e),n=te+ae*t*et,l=se-ae*t*tt;return a.jsxs("g",{children:[a.jsx("circle",{cx:te,cy:se,r:ae*t,fill:"none",stroke:E,strokeOpacity:H,strokeWidth:1}),s&&a.jsx("text",{x:n+4,y:l-2,textAnchor:"start",dominantBaseline:"auto",fill:$.secondary,fontSize:10,fontFamily:j,children:ue(e)})]},`ring-${e}`)}),["N","E","S","W"].map(e=>{const t={N:0,E:90,S:180,W:270}[e]*Math.PI/180;return a.jsx("line",{x1:te,y1:se,x2:te+ae*Math.sin(t),y2:se-ae*Math.cos(t),stroke:E,strokeOpacity:H,strokeWidth:1,strokeDasharray:"4 4"},e)}),["NE","SE","SW","NW"].map(e=>{const t={NE:45,SE:135,SW:225,NW:315}[e]*Math.PI/180;return a.jsx("line",{x1:te,y1:se,x2:te+ae*Math.sin(t),y2:se-ae*Math.cos(t),stroke:E,strokeOpacity:B,strokeWidth:1,strokeDasharray:"4 4"},`diag-${e}`)}),["N","E","S","W"].map(e=>{const t=oe(e),s="E"===e?"end":"W"===e?"start":"middle",n="N"===e?"hanging":"S"===e?"auto":"middle";return a.jsx("text",{x:t.x,y:t.y,textAnchor:s,dominantBaseline:n,fill:O,fontSize:10,fontWeight:700,fontFamily:j,"aria-hidden":"true",children:e},e)}),["NE","SE","SW","NW"].map(e=>{const t=oe(e),s="NE"===e||"SE"===e?"end":"start",n="NE"===e||"NW"===e?"hanging":"auto";return a.jsx("text",{x:t.x,y:t.y,textAnchor:s,dominantBaseline:n,fill:O,fontSize:9,fontWeight:600,fontFamily:j,"aria-hidden":"true",children:e},e)}),a.jsx("circle",{cx:te,cy:se,r:5,fill:R.chart6,stroke:D?"rgba(255,255,255,0.3)":"rgba(0,0,0,0.2)",strokeWidth:1,role:"img","aria-label":"Local node"}),a.jsx("g",{clipPath:`url(#${ie})`,children:I.map(e=>{const t=V>0?e.distance/V*S:0;if(t>1)return null;const{x:s,y:n}=re(e.bearing,t),l=null!==e.snr?lt(e.snr,L,z):"#808080",i=(null==u?void 0:u.hash)===e.hash,r=x.has(e.hash);return a.jsxs("g",{role:"img","aria-label":`${e.name}: ${e.distance.toFixed(1)}km ${e.bearing.toFixed(0)}°`,children:[r&&a.jsx("circle",{cx:s,cy:n,r:10.5,fill:"none",stroke:D?"rgba(255,255,255,0.9)":"rgba(0,0,0,0.7)",strokeWidth:2,className:"neighbor-blink-ring"}),i&&a.jsx("circle",{cx:s,cy:n,r:10.5,fill:l,opacity:.3}),a.jsx("circle",{cx:s,cy:n,r:i?7:5,fill:l,stroke:D?"rgba(0,0,0,0.5)":"rgba(0,0,0,0.25)",strokeWidth:1,style:{cursor:"pointer",transition:"r 0.15s"},onMouseEnter:()=>ce(e),onMouseLeave:()=>ce(null)})]},e.hash)})})]})]}),u&&a.jsxs("div",{className:"absolute bg-tooltip-bg border border-edge-subtle rounded-lg px-3 py-2 text-sm pointer-events-none z-10 shadow-xl",style:{left:"50%",bottom:8,transform:"translateX(-50%)"},children:[a.jsx("div",{className:"font-medium text-fg-primary",children:u.name}),a.jsx("div",{className:"type-data-xs text-fg-secondary",children:u.hash}),null!==u.snr?a.jsx("div",{className:"flex gap-3 mt-1 text-xs",children:a.jsxs("span",{children:[a.jsx("span",{className:"text-fg-secondary",children:"SNR:"})," ",a.jsxs("span",{className:"tabular-nums",style:{color:lt(u.snr,L,z)},children:[u.snr.toFixed(1)," dB"]}),a.jsxs("span",{className:"text-fg-secondary ml-1",children:["(",(pe=u.snr,(null==(ge=nt.find(e=>pe>=e.min))?void 0:ge.label)??"Critical"),")"]})]})}):a.jsx("div",{className:"text-xs text-fg-secondary mt-1",children:"No SNR data"}),a.jsxs("div",{className:"flex gap-3 text-xs",children:[a.jsxs("span",{children:[a.jsx("span",{className:"text-fg-secondary",children:"Distance:"})," ",a.jsxs("span",{className:"tabular-nums text-fg-primary",children:[u.distance.toFixed(2)," km"]})]}),a.jsxs("span",{children:[a.jsx("span",{className:"text-fg-secondary",children:"Bearing:"})," ",a.jsxs("span",{className:"tabular-nums text-fg-primary",children:[u.bearing.toFixed(0),"°"]})]})]})]})]}),a.jsxs("div",{className:"flex flex-col gap-1 px-1.5 py-2 flex-shrink-0 depth-raised radius-inset self-stretch",style:{width:"calc(100% / 6)"},children:[o&&a.jsxs("div",{className:"flex flex-col items-center gap-1 pb-2 border-b border-edge-subtle mb-1",children:[a.jsxs("div",{className:"flex items-center gap-1",children:[a.jsx("span",{className:"icon-md flex items-center justify-center text-icon-card-title",children:a.jsx(Y,{className:"w-3.5 h-3.5"})}),c&&a.jsx(d,{color:"zinc",children:c})]}),a.jsx("span",{className:"type-micro text-center text-[10px] leading-tight",children:o})]}),a.jsx("div",{className:"flex flex-col gap-1 flex-1",role:"group","aria-label":"Zoom level",children:["1x","2x","4x","8x","16x","36x"].map(e=>a.jsx("button",{onClick:()=>de(e),"aria-pressed":k===e,className:"flex flex-1 items-center justify-center min-w-[44px] sm:min-w-[32px] text-xs font-medium radius-inner depth-stroke-raised transition-colors "+(k===e?"bg-sys-blue/20 text-sys-blue":"bg-subtle-fill/80 text-fg-secondary hover:bg-subtle-fill-strong hover:text-fg-primary"),children:e},e))})]})]}):a.jsxs("div",{ref:F,className:"flex flex-col items-center justify-center h-full text-fg-secondary",children:[a.jsx(Y,{className:"w-8 h-8 mb-2 opacity-50"}),a.jsx("p",{children:"Local node coordinates not configured"}),a.jsx("p",{className:"text-xs mt-1",children:"Set latitude/longitude in config to enable"})]});var pe,ge}),rt={repeater:"var(--sys-blue)",companion:"var(--sys-cyan)",room_server:"var(--sys-indigo)"};function ot(e){if(e.contact_type){const t=e.contact_type.toLowerCase();if("repeater"===t||"rep"===t)return"repeater";if("room server"===t||"room_server"===t||"room"===t||"server"===t)return"room_server";if("companion"===t||"client"===t||"cli"===t)return"companion"}return e.is_repeater?"repeater":"companion"}const ct=s.memo(function({neighbors:e}){const t=s.useMemo(()=>{const t={repeater:0,companion:0,room_server:0};for(const a of Object.values(e)){const e=ot(a);t[e]=(t[e]||0)+1}const s=Object.values(t).reduce((e,t)=>e+t,0);return{items:[{label:"Repeaters",count:t.repeater,percent:0,color:rt.repeater},{label:"Companions",count:t.companion,percent:0,color:rt.companion},{label:"Room Servers",count:t.room_server,percent:0,color:rt.room_server}].map(e=>({...e,percent:s>0?e.count/s*100:0})).filter(e=>e.count>0).sort((e,t)=>t.count-e.count),total:s}},[e]);return 0===t.total?a.jsx("div",{className:"h-full flex items-center justify-center text-fg-muted type-body-sm",children:"No neighbors discovered yet"}):a.jsxs("div",{className:"h-full flex flex-col",children:[a.jsx("div",{className:"flex-1 flex flex-col justify-evenly",children:t.items.map(e=>a.jsxs("div",{className:"flex flex-col gap-1.5",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsx("span",{className:"type-data-sm text-fg-secondary",children:e.label}),a.jsxs("span",{className:"type-data-sm text-fg-secondary tabular-nums",children:[e.count," ",a.jsxs("span",{className:"text-fg-secondary/60",children:["(",e.percent.toFixed(0),"%)"]})]})]}),a.jsx("div",{className:"h-2.5 bg-subtle-fill/80 overflow-hidden rounded-full depth-stroke-inset",children:a.jsx("div",{className:"h-full rounded-full transition-all duration-500 ease-out",style:{width:`${e.percent}%`,backgroundColor:e.color,minWidth:e.count>0?"4px":"0"}})})]},e.label))}),a.jsxs("div",{className:"flex items-center justify-between pt-2 border-t border-edge-subtle",children:[a.jsx("span",{className:"type-data-xs text-fg-secondary",children:"Total Nodes"}),a.jsx("span",{className:"type-data-sm text-fg-primary font-medium tabular-nums",children:t.total})]})]})});function dt({children:e,minHeight:t="100%",rootMargin:n="200px 0px",keepMounted:l=!0,className:i=""}){const r=s.useRef(null),[o,c]=s.useState(!1),[d,m]=s.useState(!1);s.useEffect(()=>{const e=r.current;if(!e)return;const t=new IntersectionObserver(([e])=>{const t=e.isIntersecting;m(t),t&&c(!0)},{rootMargin:n,threshold:0});return t.observe(e),()=>{t.disconnect()}},[n]);const u=d||l&&o;return a.jsx("div",{ref:r,className:`h-full w-full ${i}`,style:{minHeight:t},children:u?e:a.jsx("div",{className:"h-full w-full flex items-center justify-center text-fg-muted/50",children:a.jsx("div",{className:"animate-pulse text-xs",children:"Loading chart..."})})})}const mt=[{target:"DisambiguationCard",fn:"disambiguation.collisions",minStage:2}];ne(mt);const ut={excellent:"text-signal-excellent",good:"text-signal-good",fair:"text-signal-fair",poor:"text-sys-blue"},ht={excellent:"bg-signal-excellent/10",good:"bg-signal-good/10",fair:"bg-signal-fair/10",poor:"bg-sys-blue/10"};function xt(){se(mt);const e=N(),t=w(),[n,l]=s.useState(null),i=s.useCallback((e,t)=>{l({prefix:e,candidateHashes:t})},[]),r=s.useCallback(()=>{l(null)},[]);if(!t)return a.jsxs(re,{neomorphic:!0,children:[a.jsx(k,{icon:a.jsx(K,{}),title:"Prefix Conflicts"}),a.jsx("div",{className:"flex-1 flex items-center justify-center",children:a.jsxs("div",{className:"text-center text-fg-secondary",children:[a.jsx(X,{className:"w-8 h-8 mx-auto mb-2 opacity-50"}),a.jsx("p",{className:"type-data-xs",children:"No topology data available"}),a.jsx("p",{className:"type-data-xs opacity-70",children:"Run deep analysis to see stats"})]})})]});const o=(c=e.avgConfidence)>=.9?"excellent":c>=.7?"good":c>=.5?"fair":"poor";var c;const m=(u=e.collisionRate)<=10?"excellent":u<=25?"good":"poor";var u;const h="poor"===o||"poor"===m?"poor":"fair"===o||"fair"===m?"fair":"good"===o||"good"===m?"good":"excellent",x="excellent"===h||"good"===h?J:U;return a.jsxs(re,{neomorphic:!0,className:"flex flex-col overflow-hidden",children:[a.jsx(k,{icon:a.jsx(K,{}),title:"Prefix Conflicts",badgeColor:"zinc",actions:"poor"===h?a.jsxs(d,{color:"red",children:[a.jsx(U,{className:"w-3 h-3"}),"Needs Attention"]}):a.jsxs("div",{className:`flex items-center gap-1.5 px-2.5 py-1 rounded-full ${ht[h]}`,children:[a.jsx(x,{className:`w-3.5 h-3.5 ${ut[h]}`}),a.jsx("span",{className:`type-data-xs font-medium ${ut[h]}`,children:"excellent"===h?"Excellent":"good"===h?"Good":"Fair"})]})}),a.jsxs("div",{className:"flex-1 flex flex-col min-h-0",children:[a.jsxs("div",{className:"flex gap-2 sm:gap-3 py-3 sm:py-4",children:[a.jsxs("div",{className:"flex-1 flex flex-col radius-inner depth-stroke-raised bg-subtle-fill/80 px-3 py-2.5 sm:py-3 cursor-help",title:"Total unique 2-character prefixes observed in packet paths.",children:[a.jsx("span",{className:"type-data-xl text-fg-primary",children:a.jsx(ue,{value:e.totalPrefixes,priority:"low"})}),a.jsx("span",{className:"type-micro text-fg-muted mt-0.5 sm:mt-1",children:"Prefixes"})]}),a.jsxs("div",{className:"flex-1 flex flex-col radius-inner depth-stroke-raised bg-subtle-fill/80 px-3 py-2.5 sm:py-3 cursor-help",title:"Prefixes that map to exactly one known node. No disambiguation needed.",children:[a.jsx("span",{className:"type-data-xl text-fg-primary",children:a.jsx(ue,{value:e.unambiguousPrefixes,priority:"low"})}),a.jsx("span",{className:"type-micro text-fg-muted mt-0.5 sm:mt-1",children:"Unique"})]}),a.jsxs("div",{className:"flex-1 flex flex-col radius-inner depth-stroke-raised bg-subtle-fill/80 px-3 py-2.5 sm:py-3 cursor-help",title:"Prefixes matching multiple known nodes. Click a prefix below to explore candidates.",children:[a.jsx("span",{className:"type-data-xl "+(e.collisionPrefixes>0?"text-sys-blue":"text-fg-primary"),children:a.jsx(ue,{value:e.collisionPrefixes,priority:"low"})}),a.jsx("span",{className:"type-micro mt-0.5 sm:mt-1 "+(e.collisionPrefixes>0?"text-sys-blue":"text-fg-muted"),children:"Conflicts"})]})]}),e.highCollisionPrefixes.length>0&&a.jsxs("div",{className:"pt-2",children:[a.jsx("div",{className:"type-data-xs text-fg-secondary mb-1.5",children:"Problem Prefixes"}),a.jsx("div",{className:"flex flex-wrap gap-1.5 content-start",children:e.highCollisionPrefixes.map(({prefix:e,candidateCount:t,candidateHashes:s})=>a.jsxs("button",{type:"button",onClick:()=>i(e,s),className:"inline-flex items-center gap-0.5 group",title:`${t} candidates - click to explore`,children:[a.jsx(me,{children:e}),a.jsxs("span",{className:"text-fg-muted type-data-xs group-hover:text-fg-secondary transition-colors",children:["×",t]})]},e))})]}),0===e.lowConfidencePrefixes.length&&0===e.collisionPrefixes&&a.jsx("div",{className:"flex-1 flex items-center",children:a.jsxs("div",{className:"flex items-center gap-1.5",children:[a.jsx(J,{className:"w-3.5 h-3.5 text-signal-excellent"}),a.jsx("span",{className:"type-data-xs text-signal-excellent",children:"All prefixes uniquely identified"})]})}),a.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-4 mt-auto pt-1.5",children:[a.jsxs("div",{className:"flex items-center gap-2 cursor-help",title:"Average confidence score across all disambiguated prefixes. Higher = more certain node identification.",children:[a.jsx("span",{className:"type-data-xs text-fg-secondary",children:"Confidence"}),a.jsxs("span",{className:`data-box ${ut[o]}`,children:[(100*e.avgConfidence).toFixed(1),"%"]})]}),a.jsxs("div",{className:"flex items-center gap-2 cursor-help",title:"Percentage of 2-character prefixes that match multiple known nodes. Lower is better.",children:[a.jsx("span",{className:"type-data-xs text-fg-secondary",children:"Collisions"}),a.jsxs("span",{className:`data-box ${ut[m]}`,children:[e.collisionRate.toFixed(1),"%"]})]})]})]}),a.jsx(he,{isOpen:!!n,prefix:(null==n?void 0:n.prefix)||"",candidateHashes:(null==n?void 0:n.candidateHashes)||[],onClose:r})]})}const pt=[{target:"PacketHealth",fn:"type",minStage:1},{target:"PacketHealth",fn:"duplicates",minStage:1}];ne(pt);const gt=new Set(["Duplicate","Empty payload","Path too long","Unknown"]),ft={excellent:"bg-status-success",good:"bg-sys-blue",fair:"bg-status-warning",poor:"bg-status-danger"};function bt({packets:e,rangeMinutes:t,rangeHours:n,timeRangeLabel:l,isLoaded:i=!0}){se(pt);const r=s.useMemo(()=>function(e,t){const s=Date.now()/1e3,a=60*t,n=s-a,l=a/24,i=new Array(24).fill(0),r=new Array(24).fill(0);let o=0,c=0,d=0,m=0;for(const h of e){if("tx_local"===h.packet_origin)continue;const e=h.timestamp;if(e<n||e>s)continue;o++;const t=Math.min(23,Math.floor((e-n)/l));r[t]++,h.transmitted||"tx_forward"===h.packet_origin?(c++,i[t]++):(h.is_duplicate||"Duplicate"===h.drop_reason)&&d++,h.drop_reason&&gt.has(h.drop_reason)&&m++}const u=[];for(let h=0;h<24;h++){const e=r[h],t=i[h];u.push({count:e>0?Math.round(t/e*100):0,timestamp:1e3*(n+h*l)})}return{totalRx:o,forwarded:c,duplicates:d,waste:m,efficiency:o>0?c/o*100:0,duplicateRate:o>0?d/o*100:0,wasteRate:o>0?m/o*100:0,sparkline:u}}(e,t),[e,t]),[o,c]=s.useState(null),d=s.useCallback(async()=>{try{const e=await M(n);e.success&&e.data&&c(e.data.count)}catch{}},[n]);s.useEffect(()=>{d()},[d]);const m=(u=r.efficiency)>=90?"excellent":u>=75?"good":u>=60?"fair":"poor";var u;const h=r.totalRx>0;return a.jsx(re,{neomorphic:!0,isLoaded:i,skeletonType:"chart",children:i&&a.jsxs(a.Fragment,{children:[a.jsx(k,{icon:a.jsx(Q,{}),title:"Packet Health",badge:l,badgeColor:"zinc"}),a.jsx(S,{children:a.jsxs("div",{className:"flex flex-col h-full",children:[a.jsxs("div",{className:"flex items-baseline gap-2",children:[a.jsxs("div",{className:"type-data-xl text-fg-primary",children:[h?a.jsx(ue,{value:Math.round(10*r.efficiency)/10,className:"font-mono tabular-nums",priority:"medium",format:{minimumFractionDigits:1,maximumFractionDigits:1}}):a.jsx("span",{className:"opacity-30",children:"—"}),a.jsx("span",{className:"type-data-sm text-fg-muted ml-0.5",children:"%"})]}),h&&a.jsx("div",{className:`w-2 h-2 rounded-full ${ft[m]}`})]}),a.jsx("div",{className:"type-micro mb-2 cursor-help",title:"Forwarded packets / total received. CRC failures, garbled packets, and RF collisions that destroy packets before reaching software are not included in this ratio — see CRC Errors for hardware-level failures.",children:"FORWARDING RATE"}),a.jsx("div",{className:"flex-1 min-h-[28px] max-h-[48px] mb-2",children:a.jsx(xe,{data:r.sparkline,width:9999,height:36,color:"var(--sys-blue)",className:"w-full"})}),a.jsxs("div",{className:"flex gap-2 sm:gap-3 mt-auto",children:[a.jsxs("div",{className:"flex-1 min-w-0",children:[a.jsx("div",{className:"data-box-label",children:"Dupes"}),a.jsx("div",{className:"data-box data-box-fill data-box-left",children:h?`${r.duplicateRate.toFixed(1)}%`:"—"})]}),a.jsxs("div",{className:"flex-1 min-w-0",children:[a.jsx("div",{className:"data-box-label",children:"Waste"}),a.jsx("div",{className:"data-box data-box-fill data-box-left",children:h?`${r.wasteRate.toFixed(1)}%`:"—"})]}),null!==o&&o>0&&a.jsxs("div",{className:"flex-1 min-w-0",children:[a.jsxs("div",{className:"data-box-label flex items-center gap-1",children:[a.jsx(U,{className:"w-3 h-3 text-status-warning"}),"CRC"]}),a.jsx("div",{className:"data-box data-box-fill data-box-left text-status-warning",children:o})]})]})]})})]})})}function yt(){var e,t,n,l,i,r,o,c,d,m,u,h,x,p,g,f,b;const y=C(),j=T(),v=A(),N=F(),w=P(),M=L(),S=null!==y&&w,H=s.useRef(!1);S&&!H.current&&(H.current=!0);const O=H.current,W=R(),q=$(),I=D(),[V,G]=s.useState(null),[,Y]=s.useState(null),[K]=s.useState(null),[X,U]=s.useState(()=>{const e=localStorage.getItem("statistics-view-mode");return"share"===e||"airtime"===e?e:"airtime"});s.useEffect(()=>{localStorage.setItem("statistics-view-mode",X)},[X]);const[J,Q]=s.useState(()=>{const e=localStorage.getItem("statistics-smoothing-mode");return["ema","ultra","mosaic","stats","trend"].includes(e)?e:"stats"});s.useEffect(()=>{localStorage.setItem("statistics-smoothing-mode",J)},[J]);const[se,ae]=s.useState(!1),[ne,le]=s.useState(!1),[me,ue]=s.useState(ve),[he,xe]=s.useState(.5),[Me,Se]=s.useState(pe),[Ce,Te]=s.useState(.8),[Ae,Fe]=s.useState(50),Pe=s.useMemo(()=>({0:0,1:0,2:1,3:2,4:3,5:4,6:5,7:6,8:7,9:8,10:9}[W]??3),[W]),Le=_[Pe].hours,Re=60*Le,$e=_[Pe],De=z(Le),_e=M.isBackgroundLoading,ze=s.useCallback(e=>{q({0:1,1:2,2:3,3:4,4:5,5:6,6:7,7:8,8:9,9:10}[e]??4)},[q]),Ee=s.useMemo(()=>{var e;if(!(null==(e=null==y?void 0:y.config)?void 0:e.radio))return null;const t=y.config.radio;return{sf:t.spreading_factor??10,bw:t.bandwidth??25e4,cr:t.coding_rate??5,preamble:t.preamble_length??8}},[null==(t=null==(e=null==y?void 0:y.config)?void 0:e.radio)?void 0:t.spreading_factor,null==(l=null==(n=null==y?void 0:y.config)?void 0:n.radio)?void 0:l.bandwidth,null==(r=null==(i=null==y?void 0:y.config)?void 0:i.radio)?void 0:r.coding_rate,null==(c=null==(o=null==y?void 0:y.config)?void 0:o.radio)?void 0:c.preamble_length]),We=s.useMemo(()=>0===I.length?{timestamps:[],values:[]}:{timestamps:I.map(e=>e.timestamp),values:I.map(e=>e.noise_floor_dbm)},[I]),qe=s.useMemo(()=>{if(I.length<10)return{anomalies:[],debug:void 0};const e=function(e,t={}){const s={...ve,...t};if(e.length<10)return{anomalies:[],thresholds:we([]),totalSamples:e.length,anomalySamples:0};const a=e.map(e=>e.noise_floor_dbm),n=we(a),l=[...a].sort((e,t)=>e-t);let i,r;s.useAbsoluteThresholds?(i=s.baselineDbm,r=s.spikeDbm):(i=Ne(l,s.baselinePercentile),r=Ne(l,s.spikePercentile));const o=[...e].sort((e,t)=>e.timestamp-t.timestamp),c=[];let d=null,m=0;for(const u of o)if(u.noise_floor_dbm>i&&u.noise_floor_dbm<r)if(m++,d){const e=Math.abs(u.noise_floor_dbm-d.rollingAvg)<=s.similarityToleranceDbm,t=u.timestamp-d.endTs<=s.mergeGapSeconds;e&&t?(d.endTs=u.timestamp,d.values.push(u.noise_floor_dbm),d.timestamps.push(u.timestamp),d.rollingAvg=d.values.reduce((e,t)=>e+t,0)/d.values.length):(d.values.length>=s.minSequenceLength&&c.push(d),d={startTs:u.timestamp,endTs:u.timestamp,values:[u.noise_floor_dbm],timestamps:[u.timestamp],rollingAvg:u.noise_floor_dbm})}else d={startTs:u.timestamp,endTs:u.timestamp,values:[u.noise_floor_dbm],timestamps:[u.timestamp],rollingAvg:u.noise_floor_dbm};else d&&d.values.length>=s.minSequenceLength&&c.push(d),d=null;return d&&d.values.length>=s.minSequenceLength&&c.push(d),0===c.length?{anomalies:[],thresholds:n,totalSamples:e.length,anomalySamples:m,debug:{baselineCutoff:i,spikeCutoff:r,midBandSamples:m}}:{anomalies:c.map(e=>{const t=Math.max(...e.values),s=e.values.reduce((e,t)=>e+t,0)/e.values.length;return{startTs:e.startTs,endTs:e.endTs,peakValue:t,avgValue:s,severity:ke(s,i,r),sampleCount:e.values.length}}),thresholds:n,totalSamples:e.length,anomalySamples:m,debug:{baselineCutoff:i,spikeCutoff:r,midBandSamples:m}}}(I,me);return{anomalies:e.anomalies,debug:e.debug}},[I,me]),Ie=qe.anomalies,Ve=s.useMemo(()=>{const e=(null==y?void 0:y.neighbors)??{};return Object.fromEntries(Object.entries(e).filter(([e])=>!j.has(e)))},[null==y?void 0:y.neighbors,j]),Ge=s.useMemo(()=>{const e=Date.now()/1e3-3600*Le;return Object.fromEntries(Object.entries(Ve).filter(([,t])=>t.last_seen>=e))},[Ve,Le]),Ye=s.useMemo(()=>{const e=60*Re/De,t=Math.floor(Date.now()/1e3),s=Math.floor(t/e)*e;return{start:s-60*Re,end:s}},[Re,De]),Ke=Me.timeStart??Ye.start,Xe=Me.timeEnd??Ye.end,Je=z((Xe-Ke)/3600),Qe=be(),Ze=s.useMemo(()=>ge(N,Me,Qe,Ye),[N,Me,Qe,Ye]);return a.jsxs(oe,{children:[a.jsx(ce,{title:"Statistics",icon:a.jsx(Z,{}),controls:a.jsx(ie,{ranges:_,selectedIndex:Pe,onSelect:ze,isPending:_e})}),K&&a.jsx(re,{className:"border border-sys-red/50 bg-sys-red/10",children:a.jsx("p",{className:"text-sys-red",children:K})}),se&&ne&&a.jsxs(re,{className:"border border-sys-indigo/30 bg-surface/50",children:[a.jsxs("div",{className:"flex items-center justify-between mb-3",children:[a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx("span",{className:"type-label",children:"Anomaly Detection Tuning"}),a.jsxs("span",{className:"type-data-xs text-fg-muted",children:["(",$e.label,")"]})]}),a.jsx("button",{onClick:()=>ue(e=>({...e,useAbsoluteThresholds:!e.useAbsoluteThresholds})),className:"type-data-xs px-2 py-1 rounded transition-colors "+(me.useAbsoluteThresholds?"bg-sys-indigo/30 text-sys-indigo":"bg-elevated text-fg-muted hover:text-fg-secondary"),children:me.useAbsoluteThresholds?"Absolute dBm":"Percentile"})]}),a.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-4 gap-4",children:[a.jsxs("div",{children:[a.jsx("span",{className:"type-micro",children:"Baseline"}),a.jsxs("span",{className:"ml-2 type-data-sm text-status-warning",children:[(null==(m=null==(d=qe.debug)?void 0:d.baselineCutoff)?void 0:m.toFixed(1))??"—"," dBm"]})]}),a.jsxs("div",{children:[a.jsx("span",{className:"type-micro",children:"Spike"}),a.jsxs("span",{className:"ml-2 type-data-sm text-status-warning",children:[(null==(h=null==(u=qe.debug)?void 0:u.spikeCutoff)?void 0:h.toFixed(1))??"—"," dBm"]})]}),a.jsxs("div",{children:[a.jsx("span",{className:"type-micro",children:"Mid-band"}),a.jsx("span",{className:"ml-2 type-data-sm text-sys-indigo",children:(null==(x=qe.debug)?void 0:x.midBandSamples)??0})]}),a.jsxs("div",{children:[a.jsx("span",{className:"type-micro",children:"Anomalies"}),a.jsx("span",{className:"ml-2 type-data-sm text-status-danger",children:Ie.length})]})]}),a.jsxs("div",{className:"mt-4 pt-4 border-t border-edge-subtle space-y-4",children:[me.useAbsoluteThresholds?a.jsxs(a.Fragment,{children:[a.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-4",children:[a.jsxs("div",{children:[a.jsxs("label",{className:"type-micro block mb-1",children:["Baseline (",me.baselineDbm," dBm)"]}),a.jsx("input",{type:"range",min:"-120",max:"-60",value:me.baselineDbm,onChange:e=>ue(t=>({...t,baselineDbm:Number(e.target.value)})),className:"w-full accent-sys-indigo"})]}),a.jsxs("div",{children:[a.jsxs("label",{className:"type-micro block mb-1",children:["Spike (",me.spikeDbm," dBm)"]}),a.jsx("input",{type:"range",min:"-100",max:"-20",value:me.spikeDbm,onChange:e=>ue(t=>({...t,spikeDbm:Number(e.target.value)})),className:"w-full accent-sys-indigo"})]}),a.jsxs("div",{children:[a.jsxs("label",{className:"type-micro block mb-1",children:["Merge Gap (",me.mergeGapSeconds,"s)"]}),a.jsx("input",{type:"range",min:"5",max:"120",step:"5",value:me.mergeGapSeconds,onChange:e=>ue(t=>({...t,mergeGapSeconds:Number(e.target.value)})),className:"w-full accent-sys-indigo"})]})]}),a.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-4",children:[a.jsxs("div",{children:[a.jsxs("label",{className:"type-micro block mb-1",children:["Min Sequence (",me.minSequenceLength,")"]}),a.jsx("input",{type:"range",min:"2",max:"20",value:me.minSequenceLength,onChange:e=>ue(t=>({...t,minSequenceLength:Number(e.target.value)})),className:"w-full accent-sys-indigo"})]}),a.jsxs("div",{children:[a.jsxs("label",{className:"type-micro block mb-1",children:["Similarity (±",me.similarityToleranceDbm," dBm)"]}),a.jsx("input",{type:"range",min:"1",max:"15",value:me.similarityToleranceDbm,onChange:e=>ue(t=>({...t,similarityToleranceDbm:Number(e.target.value)})),className:"w-full accent-sys-indigo"})]}),a.jsxs("div",{children:[a.jsxs("label",{className:"type-micro block mb-1",children:["Opacity (",Math.round(100*he),"%)"]}),a.jsx("input",{type:"range",min:"0.1",max:"1",step:"0.05",value:he,onChange:e=>xe(Number(e.target.value)),className:"w-full accent-sys-indigo"})]})]})]}):a.jsxs(a.Fragment,{children:[a.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-4",children:[a.jsxs("div",{children:[a.jsxs("label",{className:"type-micro block mb-1",children:["Baseline (P",me.baselinePercentile,")"]}),a.jsx("input",{type:"range",min:"1",max:"50",value:me.baselinePercentile,onChange:e=>ue(t=>({...t,baselinePercentile:Number(e.target.value)})),className:"w-full accent-sys-indigo"})]}),a.jsxs("div",{children:[a.jsxs("label",{className:"type-micro block mb-1",children:["Spike (P",me.spikePercentile,")"]}),a.jsx("input",{type:"range",min:"50",max:"99",value:me.spikePercentile,onChange:e=>ue(t=>({...t,spikePercentile:Number(e.target.value)})),className:"w-full accent-sys-indigo"})]}),a.jsxs("div",{children:[a.jsxs("label",{className:"type-micro block mb-1",children:["Merge Gap (",me.mergeGapSeconds,"s)"]}),a.jsx("input",{type:"range",min:"5",max:"120",step:"5",value:me.mergeGapSeconds,onChange:e=>ue(t=>({...t,mergeGapSeconds:Number(e.target.value)})),className:"w-full accent-sys-indigo"})]})]}),a.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-4",children:[a.jsxs("div",{children:[a.jsxs("label",{className:"type-micro block mb-1",children:["Min Sequence (",me.minSequenceLength,")"]}),a.jsx("input",{type:"range",min:"2",max:"20",value:me.minSequenceLength,onChange:e=>ue(t=>({...t,minSequenceLength:Number(e.target.value)})),className:"w-full accent-sys-indigo"})]}),a.jsxs("div",{children:[a.jsxs("label",{className:"type-micro block mb-1",children:["Similarity (±",me.similarityToleranceDbm," dBm)"]}),a.jsx("input",{type:"range",min:"1",max:"15",value:me.similarityToleranceDbm,onChange:e=>ue(t=>({...t,similarityToleranceDbm:Number(e.target.value)})),className:"w-full accent-sys-indigo"})]}),a.jsxs("div",{children:[a.jsxs("label",{className:"type-micro block mb-1",children:["Opacity (",Math.round(100*he),"%)"]}),a.jsx("input",{type:"range",min:"0.1",max:"1",step:"0.05",value:he,onChange:e=>xe(Number(e.target.value)),className:"w-full accent-sys-indigo"})]})]})]}),a.jsxs("div",{className:"mt-4 p-3 bg-elevated radius-inner",children:[a.jsx("div",{className:"type-micro mb-1",children:"Config output"}),a.jsxs("div",{className:"type-data-sm text-status-success",children:[me.useAbsoluteThresholds?`useAbsoluteThresholds: true, baselineDbm: ${me.baselineDbm}, spikeDbm: ${me.spikeDbm}`:`useAbsoluteThresholds: false, baselinePercentile: ${me.baselinePercentile}, spikePercentile: ${me.spikePercentile}`,", mergeGapSeconds: ",me.mergeGapSeconds,", minSequenceLength: ",me.minSequenceLength,", similarityToleranceDbm: ",me.similarityToleranceDbm]})]})]})]}),a.jsxs(de,{children:[a.jsx("div",{className:"sm:hidden",children:_e&&a.jsx(ye,{template:"auto",children:a.jsx(re,{className:"border border-sys-blue/30 bg-sys-blue/5",children:a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsxs("div",{className:"relative flex h-3 w-3",children:[a.jsx("span",{className:"animate-ping absolute inline-flex h-full w-full rounded-full bg-sys-blue opacity-75"}),a.jsx("span",{className:"relative inline-flex rounded-full h-3 w-3 bg-sys-blue"})]}),a.jsxs("div",{className:"flex-1",children:[a.jsxs("p",{className:"type-body-sm text-fg-primary",children:["Loading ",$e.label," data..."]}),M.loadProgress&&a.jsxs("p",{className:"type-data-xs text-fg-muted mt-0.5",children:[M.loadProgress.loaded.toLocaleString()," packets (",M.loadProgress.percent,"%)"]})]})]})})})}),O?a.jsxs(a.Fragment,{children:[a.jsx(ye,{template:"hero-auto",children:a.jsx(re,{neomorphic:!0,isLoaded:O,skeletonType:"chart",children:O&&a.jsxs(a.Fragment,{children:[a.jsx(k,{icon:a.jsx(B,{}),title:"Packet Analyzer",badge:$e.label,badgeColor:"zinc",stackActionsOnMobile:!0,actions:a.jsxs("div",{className:"flex flex-wrap items-center gap-2 justify-end",children:["stats"===J&&a.jsx(Oe,{enabled:se,onChange:ae,anomalyCount:Ie.length,showTuning:ne,onTuningChange:le}),a.jsx(Be,{smoothing:J,onChange:Q}),a.jsx(He,{mode:X,onChange:U})]})}),a.jsx("div",{className:"flex-1 min-h-0",children:a.jsx(Ue,{packets:Ze,allPackets:N,startTs:Ke,endTs:Xe,parentStartTs:Ye.start,parentEndTs:Ye.end,bucketCount:Je,radioConfig:Ee??void 0,mode:X,smoothing:J,noiseFloorAnomalies:Ie,showNoiseFloorOverlay:se,overlayOpacity:he,dotSize:Ce,dotOpacity:Ae/100})})]})})}),a.jsx(ye,{template:"auto",className:"relative z-10",children:a.jsx(re,{neomorphic:!0,noPadding:!0,isLoaded:O,className:"overflow-visible",children:O&&a.jsx(fe,{parentStartTs:Ye.start,parentEndTs:Ye.end,neighbors:Ve,filter:Me,onChange:Se,..."stats"===J?{scatterDotSize:Ce,onScatterDotSizeChange:Te,scatterOpacity:Ae,onScatterOpacityChange:Fe}:{}})})}),a.jsxs(ye,{template:"panel",children:[a.jsx(je,{span:12,md:6,children:a.jsx(re,{neomorphic:!1,isLoaded:O,skeletonType:"chart",noPadding:O,className:"!bg-transparent !ring-0 !shadow-none !overflow-visible -mx-4 sm:mx-0 !px-0 !pr-0",children:O&&a.jsx(dt,{children:a.jsx(it,{neighbors:Ge,quickNeighbors:v,localLat:(null==(g=null==(p=null==y?void 0:y.config)?void 0:p.repeater)?void 0:g.latitude)??0,localLon:(null==(b=null==(f=null==y?void 0:y.config)?void 0:f.repeater)?void 0:b.longitude)??0,onStatsChange:Y,title:"Link Quality",badge:$e.label})})})}),a.jsx(je,{span:12,md:6,children:a.jsx(re,{neomorphic:!0,isLoaded:O,skeletonType:"chart",children:O&&a.jsxs(a.Fragment,{children:[a.jsx(k,{icon:a.jsx(ee,{}),title:"Network Composition",badge:$e.label,badgeColor:"zinc"}),a.jsx("div",{className:"flex-1 min-h-0",children:a.jsx(dt,{children:a.jsx(ct,{neighbors:Ge})})})]})})})]}),a.jsxs(ye,{template:"panel",children:[a.jsx(je,{span:12,md:6,children:a.jsx(xt,{})}),a.jsx(je,{span:12,md:6,children:a.jsx(bt,{packets:N,rangeMinutes:Re,rangeHours:Le,timeRangeLabel:$e.label,isLoaded:O})})]}),a.jsx(ye,{template:"panel",children:a.jsx(je,{span:12,children:a.jsx(re,{neomorphic:!0,isLoaded:O,skeletonType:"chart",children:O&&a.jsxs(a.Fragment,{children:[a.jsx(k,{icon:a.jsx(te,{}),title:"NOISE FLOOR dBm",stackActionsOnMobile:!0,actions:V?a.jsxs("div",{className:"flex items-center gap-2 sm:gap-3",children:[a.jsxs("span",{className:"type-data-xs text-fg-muted whitespace-nowrap",children:["min ",a.jsx("span",{className:"data-box",children:V.min.toFixed(0)})]}),a.jsxs("span",{className:"type-data-xs text-fg-muted whitespace-nowrap",children:["avg ",a.jsx("span",{className:"data-box",children:V.avg.toFixed(0)})]}),a.jsxs("span",{className:"type-data-xs text-fg-muted whitespace-nowrap",children:["max ",a.jsx("span",{className:"data-box",children:V.max.toFixed(0)})]})]}):null}),a.jsx("div",{className:"flex-1 min-h-0",children:a.jsx(dt,{children:a.jsx(E,{timestamps:We.timestamps,values:We.values,onStatsChange:G})})})]})})})})]}):a.jsx(ye,{template:"auto",children:a.jsx(re,{neomorphic:!0,className:"text-center py-12",children:a.jsx("div",{className:"animate-pulse text-fg-muted",children:"Loading statistics..."})})})]})]})}export{yt as default};
