import{r as e,j as t,y as s,T as a,z as n,A as l,p as i,g as r,D as o,x as c,E as d,H as u,I as m,J as x,K as h,O as p,Q as f,Z as v,U as g,V as j,W as b,Y as N}from"./vendor-react-0D__tamq.js";import{u as y,a as k,b as w,c as M,w as _,d as S,L,e as C,f as R,h as D,D as F,j as B,k as T,T as A,m as $,n as P,o as I,p as H,q as E,F as W,v as q}from"./index-By5qf1JJ.js";import{u as O,a as z}from"./useThemeColors-CpkAay3C.js";import{C as G,S as K,a as U,P as J,b as V,c as Q}from"./PageLayout-lVaYU4M5.js";import{P as X,a as Y,b as Z}from"./PacketDetailModal-DUSd79v8.js";import{T as ee}from"./TimeRangeSelector-Ca5VRihy.js";import{D as te}from"./DataBox-CNeTiMGH.js";import{s as se}from"./SignalIndicator-DxpktPZZ.js";import{R as ae,L as ne,Y as le,a as ie,A as re,C as oe,X as ce,T as de,b as ue}from"./recharts-BovJNxPc.js";import{c as me}from"./link-scoring-Ci9bAKKS.js";import{R as xe,C as he}from"./Grid-DgTkKuOC.js";import"./vendor-core-WoOfkQwm.js";import"./deckgl-DTsmDcfs.js";import"./useScientificColormap-D1rg7QOV.js";const pe={received:{barBase:"var(--metric-received)"},forwarded:{barBase:"var(--metric-forwarded)"},transmitted:{barBase:"var(--metric-transmitted)"},dropped:{barBase:"var(--metric-dropped)"},neutral:{barBase:"var(--metric-neutral)"}},fe={sm:"card-sm",md:"card-md",lg:"card-lg",hero:"card-hero",auto:""};function ve({buckets:s,colorType:a}){const n=pe[a].barBase,l=e.useMemo(()=>{if(!(null==s?void 0:s.length))return[];const e=s.length/60,t=e<=1?s:Array.from({length:60},(t,a)=>{var n,l;const i=s.slice(Math.floor(a*e),Math.floor((a+1)*e)),r=i.reduce((e,t)=>e+t.count,0),o=i.length?i.reduce((e,t)=>e+t.avg_snr,0)/i.length:0;return{bucket:a,start:(null==(n=i[0])?void 0:n.start)??0,end:(null==(l=i.at(-1))?void 0:l.end)??0,count:r,airtime_ms:i.reduce((e,t)=>e+t.airtime_ms,0),avg_snr:o,avg_rssi:0}}),a=t.map(e=>e.count).filter(e=>e>0);if(0===a.length)return t.map(()=>({height:0,bottom:0,color:"transparent",count:0,snr:0}));const l=Math.max(...a),i=Math.min(...a),r=l-i;return 0===r?t.map(e=>({height:e.count>0?40:0,bottom:e.count>0?30:0,color:e.count>0?n:"transparent",count:e.count,snr:e.avg_snr})):t.map(e=>{if(0===e.count)return{height:0,bottom:0,color:"transparent",count:0,snr:e.avg_snr};const t=(e.count-i)/r,s=25*t;return{height:Math.max(15,25+60*t),bottom:s,color:n,count:e.count,snr:e.avg_snr}})},[s,n]);return(null==s?void 0:s.length)?t.jsx("div",{className:"w-full h-full relative",children:l.map((e,s)=>{var a;return t.jsx("div",{className:"absolute rounded-full",style:{height:`${e.height}%`,bottom:`${e.bottom}%`,left:7*s+"px",width:"5px",backgroundColor:e.color,opacity:e.count>0?.8:.1},title:e.count>0?`${e.count} packets, SNR: ${null==(a=e.snr)?void 0:a.toFixed(1)}dB`:"No packets"},s)})}):t.jsx("div",{className:"w-full h-full flex items-end justify-center gap-[2px] opacity-20",children:t.jsx("span",{className:"type-data-xs text-text-secondary",children:"No data"})})}function ge({title:s,value:a,color:n="neutral",subtitle:l,buckets:i,receivedCount:r,timeRangeLabel:o,icon:c,size:d="md",isLoaded:u=!0}){const m="string"==typeof a?a:a.toLocaleString(),x=e.useMemo(()=>function(e){if(!(null==e?void 0:e.length))return null;const t=e.reduce((e,t)=>e+t.count,0),s=e[0].start,a=e[e.length-1].end,n=Math.max((a-s)/3600,1),l=Math.round(t/n);let i=0,r=0;for(let d=0;d<e.length;d++)e[d].count>r&&(r=e[d].count,i=d);const o=new Date(1e3*e[i].start).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hour12:!1}),c=e.filter(e=>e.count>0&&0!==e.avg_snr);return{total:t,ratePerHour:l,peakCount:r,peakHour:o,avgSnr:c.length>0?c.reduce((e,t)=>e+t.avg_snr,0)/c.length:null}}(i),[i]),h="number"==typeof a?a:(null==x?void 0:x.total)??0,p=r&&r>0?(h/r*100).toFixed(1):null;return u?t.jsxs("div",{className:`data-card flex flex-col relative ${fe[d]}`,children:[t.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[c&&t.jsx("span",{className:"icon-sm text-icon-card-title",children:c}),t.jsx("span",{className:"type-micro",children:s}),o&&t.jsx("span",{className:"pill-tag",children:o})]}),t.jsx("div",{className:"font-mono text-3xl font-semibold tabular-nums text-text-primary",style:{letterSpacing:"-0.05em"},children:m}),t.jsx("div",{className:"flex-1 mt-1 overflow-hidden min-h-[60px]",children:i?t.jsx(ve,{buckets:i,colorType:n}):t.jsx("div",{className:"w-full h-full flex items-center justify-center",children:t.jsx("div",{className:"w-full h-0.5 rounded-full bg-text-muted/15"})})}),t.jsx("div",{className:"pt-2 mt-1",children:t.jsxs("div",{className:"flex gap-3",children:[t.jsxs("div",{className:"flex-1",children:[t.jsx("div",{className:"data-box-label",children:"Rate"}),t.jsxs("div",{className:"data-box data-box-fill data-box-left",children:[(null==x?void 0:x.ratePerHour)??l??"â€”","/hr"]})]}),null!==p?t.jsxs("div",{className:"flex-1",children:[t.jsx("div",{className:"data-box-label",children:"dropped"===n?"Drop %":"Ratio"}),t.jsxs("div",{className:"data-box data-box-fill data-box-left",children:[p,"%"]})]}):(null==x?void 0:x.peakHour)?t.jsxs("div",{className:"flex-1",children:[t.jsx("div",{className:"data-box-label",children:"Peak"}),t.jsx("div",{className:"data-box data-box-fill data-box-left",children:x.peakHour})]}):null]})})]}):t.jsx("div",{className:`data-card flex flex-col relative ${fe[d]}`,children:t.jsx(G,{})})}const je=.2;function be(e,t=1){return Math.floor(5*t*e)}function Ne(e){const t=Math.round(e/je)*je;return Math.max(0,Math.min(5,t))}function ye({stats:e,receivedBuckets:i,droppedBuckets:r,forwardedBuckets:o,bucketDurationSeconds:c,timeRangeLabel:d,isLoaded:u=!0}){var m,x,h,p;if(!u)return t.jsx("div",{className:"data-card flex flex-col relative",children:t.jsx(G,{})});const f=function(e,t,s,a,n){var l,i;const r=e=>(null==e?void 0:e.reduce((e,t)=>e+t.count,0))??0,o=r(t),c=r(s),d=r(a),u=o||(null==e?void 0:e.rx_count)||1,m=c||(null==e?void 0:e.dropped_count)||0,x=u>0?m/(u+m)*100:0;let h=0;if((null==a?void 0:a.length)&&n)h=100*d/(a.length*n*1e3)*100;else if(e){const t=1e3*(e.uptime_seconds||1);h=(e.total_airtime_ms||e.airtime_used_ms||0)/t*100}const p=(null==e?void 0:e.neighbors)??{},f=Object.values(p).filter(e=>e.zero_hop).length;let v=1;x<3?v-=je:x>15?v+=.4:x>10&&(v+=je),h>5&&(v+=je),f>10&&(v+=je);const g=Ne(v),j=Ne(.28*g),b=be(g),N=be(j),y=be((null==(i=null==(l=null==e?void 0:e.config)?void 0:l.delays)?void 0:i.tx_delay_factor)??1);return{floodFactor:g,directFactor:j,floodSlots:b,directSlots:N,adjustment:b>y?"increase":b<y?"decrease":"stable",duplicateRate:Math.round(100*x)/100,txUtilization:Math.round(1e3*h)/1e3,zeroHopCount:f,totalReceived:o,totalDropped:c}}(e,i,r,o,c),v=(null==(x=null==(m=null==e?void 0:e.config)?void 0:m.delays)?void 0:x.tx_delay_factor)??null,g=(null==(p=null==(h=null==e?void 0:e.config)?void 0:h.delays)?void 0:p.direct_tx_delay_factor)??null,j=null!==v?be(v):null,b=null!==j&&f.floodSlots!==j,N="increase"===f.adjustment?a:"decrease"===f.adjustment?n:l;return t.jsxs("div",{className:"data-card flex flex-col relative",children:[t.jsxs("div",{className:"flex items-center gap-2 mb-3 flex-wrap",children:[t.jsx(s,{className:"w-4 h-4 text-icon-card-title flex-shrink-0"}),t.jsx("span",{className:"type-micro",children:"DELAY DOCTOR"}),d&&t.jsx("span",{className:"pill-tag",children:d}),b&&t.jsxs("span",{className:"pill-tag flex items-center gap-1 "+("increase"===f.adjustment?"bg-accent-warning/20 text-accent-warning border-accent-warning/30":"bg-accent-success/20 text-accent-success border-accent-success/30"),children:[t.jsx(N,{className:"w-3 h-3"}),"increase"===f.adjustment?"+":"-",Math.abs(f.floodSlots-(j??0))]})]}),t.jsxs("div",{className:"flex gap-3 mb-3",children:[t.jsxs("div",{className:"flex-1 flex flex-col",children:[t.jsxs("span",{className:"font-mono text-3xl font-semibold text-text-primary tabular-nums",style:{letterSpacing:"-0.05em"},children:["Ã—",f.floodFactor.toFixed(1)]}),t.jsx("span",{className:"text-xs font-medium text-text-muted uppercase tracking-wide mt-1",children:"Flood"})]}),t.jsxs("div",{className:"flex-1 flex flex-col",children:[t.jsxs("span",{className:"font-mono text-3xl font-semibold text-accent-tertiary tabular-nums",style:{letterSpacing:"-0.05em"},children:["Ã—",f.directFactor.toFixed(1)]}),t.jsx("span",{className:"text-xs font-medium text-text-muted uppercase tracking-wide mt-1",children:"Direct"})]})]}),t.jsx("div",{className:"flex-1 py-2",children:t.jsxs("div",{className:"flex gap-3",children:[t.jsxs("div",{className:"flex-1",children:[t.jsx("div",{className:"data-box-label",children:"Dupe"}),t.jsxs("div",{className:"data-box data-box-fill data-box-left "+(f.duplicateRate>10?"text-accent-warning":""),children:[f.duplicateRate.toFixed(1),"%"]})]}),t.jsxs("div",{className:"flex-1",children:[t.jsx("div",{className:"data-box-label",children:"TX Util"}),t.jsxs("div",{className:"data-box data-box-fill data-box-left",children:[f.txUtilization.toFixed(2),"%"]})]})]})}),t.jsxs("div",{className:"pt-2 mt-2",children:[t.jsx("div",{className:"data-box-label",children:"Current"}),t.jsx("div",{className:"flex gap-2",children:null!==v?t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"data-box",children:["Ã—",v.toFixed(2)]}),t.jsxs("div",{className:"data-box",style:{color:"var(--accent-tertiary)"},children:["Ã—",(null==g?void 0:g.toFixed(2))??"â€”"]})]}):t.jsx("span",{className:"text-sm text-text-muted",children:"No config"})})]})]})}function ke(){const s=y(),a=k(),n=w(),l=M(),[c,d]=e.useState(null),[u,m]=e.useState(null),[x,h]=e.useState([]),p=e.useRef(0);e.useEffect(()=>{const e=_.subscribe(e=>{h(e)});return h(_.getPendingPackets()),e},[]);const f=e.useMemo(()=>{const e=s.length<=100?s:s.slice(-100),t=new Set(e.map(e=>e.packet_hash));return[...x.filter(e=>!t.has(e.packet.packet_hash)).map(e=>({...e.packet,isPending:!0})),...e].sort((e,t)=>(t.timestamp??0)-(e.timestamp??0))},[s,x]),v=e.useMemo(()=>{const e=new Map;if(!(null==l?void 0:l.neighbors))return e;l.local_hash&&e.set(S(l.local_hash),l.local_hash);for(const t of Object.keys(l.neighbors)){const s=S(t);e.has(s)||e.set(s,t)}return e},[l]),g=e.useMemo(()=>f.slice(0,15).map(e=>{if(e.src_hash&&e.src_hash.length<=4){const t=v.get(e.src_hash.toUpperCase());if(t)return{...e,src_hash_full:t}}return e}),[f,v]);e.useEffect(()=>{var e;if(!f.length)return;const t=(null==(e=f[0])?void 0:e.timestamp)??0,s=t>p.current&&p.current>0;if(p.current=t,!s)return;const a=f[0];if(a){const e=requestAnimationFrame(()=>d(a.packet_hash)),t=setTimeout(()=>d(null),600);return()=>{cancelAnimationFrame(e),clearTimeout(t)}}},[f]);const j=()=>t.jsxs(t.Fragment,{children:[t.jsx(i,{className:"w-6 h-6 text-text-muted mx-auto mb-2"}),t.jsx("div",{className:"text-sm text-text-primary",children:"No packets received"}),t.jsx("div",{className:"text-xs text-text-muted",children:"Packets will appear here"})]});return t.jsxs("div",{className:"chart-container h-full flex flex-col",children:[t.jsxs("div",{className:"chart-header",children:[t.jsxs("div",{className:"chart-title",children:[t.jsx(i,{className:"chart-title-icon"}),"Recent Packets"]}),t.jsxs("div",{className:"flex items-center gap-3",children:[n&&t.jsx(L,{showLabel:!0}),t.jsxs(r,{to:"/packets",className:"pill-subtle",children:["View all ",t.jsx(o,{className:"w-3 h-3"})]})]})]}),t.jsxs("div",{className:"sm:hidden flex items-center gap-2 px-3 py-1.5 border-b border-border-subtle/50 bg-bg-elevated/20",children:[t.jsx("span",{className:"text-[9px] font-semibold text-text-muted uppercase tracking-wider flex-shrink-0",children:"Dir"}),t.jsx("span",{className:"text-[9px] font-semibold text-text-muted uppercase tracking-wider flex-shrink-0",children:"Time"}),t.jsx("span",{className:"text-[9px] font-semibold text-text-muted uppercase tracking-wider flex-shrink-0",children:"Src"}),t.jsx("span",{className:"flex-1"}),t.jsx("span",{className:"text-[9px] font-semibold text-text-muted uppercase tracking-wider flex-shrink-0",children:"Type"}),t.jsx("span",{className:"text-[9px] font-semibold text-text-muted uppercase tracking-wider flex-shrink-0",children:"Route"}),t.jsx("span",{className:"text-[9px] font-semibold text-text-muted uppercase tracking-wider flex-shrink-0",children:"Signal"})]}),t.jsx("div",{className:"hidden sm:block flex-1 overflow-hidden",children:t.jsx("div",{className:"h-full overflow-y-auto",children:t.jsxs("table",{className:"w-full",children:[t.jsx("thead",{className:"sticky top-0 bg-bg-elevated/95 backdrop-blur-sm",children:t.jsxs("tr",{className:"border-b border-border-subtle/50",children:[t.jsx("th",{className:"text-left py-1.5 px-3 text-[9px] font-semibold text-text-muted uppercase tracking-wider whitespace-nowrap",children:"Dir"}),t.jsx("th",{className:"text-left py-1.5 px-3 text-[9px] font-semibold text-text-muted uppercase tracking-wider whitespace-nowrap",children:"Time"}),t.jsx("th",{className:"text-left py-1.5 px-3 text-[9px] font-semibold text-text-muted uppercase tracking-wider whitespace-nowrap",children:"Source"}),t.jsx("th",{className:"text-left py-1.5 px-3 text-[9px] font-semibold text-text-muted uppercase tracking-wider whitespace-nowrap",children:"Type"}),t.jsx("th",{className:"text-left py-1.5 px-3 text-[9px] font-semibold text-text-muted uppercase tracking-wider whitespace-nowrap",children:"Route"}),t.jsx("th",{className:"text-right py-1.5 px-3 pr-4 text-[9px] font-semibold text-text-muted uppercase tracking-wider whitespace-nowrap",children:"Signal"})]})}),t.jsx("tbody",{className:"divide-y divide-border-subtle/30",children:a&&0===f.length?t.jsx("tr",{children:t.jsx("td",{colSpan:6,className:"text-center py-8 text-text-muted",children:"Loading packets..."})}):0===g.length?t.jsx("tr",{children:t.jsx("td",{colSpan:6,className:"text-center py-8",children:j()})}):g.map((e,s)=>t.jsx(X,{packet:e,onClick:m,isFlashing:c===e.packet_hash},`${e.packet_hash}_${e.timestamp}_${s}`))})]})})}),t.jsx("div",{className:"sm:hidden flex-1 overflow-y-auto divide-y divide-border-subtle/30",children:a&&0===f.length?t.jsx("div",{className:"p-8 text-center text-text-muted",children:"Loading packets..."}):0===g.length?t.jsx("div",{className:"p-8 text-center",children:j()}):g.map((e,s)=>t.jsx(Y,{packet:e,onClick:m,isFlashing:c===e.packet_hash},`${e.packet_hash}_${e.timestamp}_${s}`))}),t.jsxs("div",{className:"px-3 py-1.5 border-t border-border-subtle/50 text-[10px] text-text-muted bg-bg-elevated/20 text-center",children:["Showing ",g.length," of ",f.length," packets"]}),u&&t.jsx(Z,{packet:u,onClose:()=>m(null)})]})}const we=e.memo(function({active:e,payload:s,label:a,formatValue:n,labelKey:l}){var i;if(!e||!(null==s?void 0:s.length))return null;const r=l&&(null==(i=s[0])?void 0:i.payload)?s[0].payload[l]:a;return t.jsxs("div",{className:"bg-tooltip-bg border border-border-subtle rounded-lg px-4 py-3 shadow-xl",children:[r&&t.jsx("p",{className:"type-data-xs text-white/50 mb-2",children:r}),t.jsx("div",{className:"space-y-1.5",children:s.map((e,s)=>t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("span",{className:"w-2 h-2 rounded-full flex-shrink-0",style:{backgroundColor:e.color}}),t.jsx("span",{className:"type-body-sm text-white/70 capitalize min-w-[60px]",children:e.name}),t.jsx("span",{className:"type-data-sm text-white tabular-nums",children:n?n(e.value,e.name):e.value.toLocaleString()})]},s))})]})});e.memo(function({active:e,payload:s,color:a,labelKey:n,unit:l=""}){var i,r;if(!e||!(null==s?void 0:s.length))return null;const o=s[0],c=null==(i=null==o?void 0:o.payload)?void 0:i[n];return t.jsxs("div",{className:"bg-tooltip-bg border border-border-subtle rounded-lg px-3 py-2 shadow-xl",children:[t.jsx("p",{className:"type-data-xs text-white/50 mb-1",children:c}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("span",{className:"w-2 h-2 rounded-full",style:{backgroundColor:a}}),t.jsxs("span",{className:"type-data-sm text-white tabular-nums",children:[null==(r=null==o?void 0:o.value)?void 0:r.toLocaleString(),l]})]})]})}),e.memo(function({payload:e}){return(null==e?void 0:e.length)?t.jsx("div",{className:"flex items-center justify-center gap-6 mt-4 pt-4 border-t border-white/5",children:e.map((e,s)=>t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("span",{className:"w-2 h-2 rounded-full",style:{backgroundColor:e.color}}),t.jsx("span",{className:"type-body-sm text-white/60 capitalize",children:e.value})]},s))}):null});const Me={stable:"M5 12h14",up:"M5 15l7-7 7 7",down:"M19 9l-7 7-7-7"};function _e({trend:e}){return t.jsx("span",{className:`mini-widget-trend ${e}`,children:t.jsx("svg",{className:"w-3 h-3",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:Me[e]})})})}function Se(){return t.jsx("div",{className:"mini-widget-loading",children:t.jsx("div",{className:"mini-widget-loading-spinner"})})}function Le({message:e}){return t.jsx("div",{className:"mini-widget-error",children:t.jsx("span",{title:e,children:"No data"})})}function Ce({title:e,icon:s,value:a,unit:n,valueSize:l="md",status:i,subtitle:r,trend:o,children:c,isLoading:d=!1,error:u,className:m="",onClick:x}){const h=["mini-widget-value","lg"===l&&"mini-widget-value-lg","sm"===l&&"mini-widget-value-sm"].filter(Boolean).join(" "),p=["mini-widget",x&&"cursor-pointer",m].filter(Boolean).join(" ");return t.jsxs("div",{className:p,onClick:x,role:x?"button":void 0,children:[t.jsxs("div",{className:"mini-widget-header",children:[s,t.jsx("span",{className:"mini-widget-title",children:e}),i&&"unknown"!==i&&t.jsx("div",{className:`mini-widget-status-dot ${i}`}),o&&t.jsx(_e,{trend:o})]}),d?t.jsx(Se,{}):u?t.jsx(Le,{message:u}):t.jsxs(t.Fragment,{children:[void 0!==a&&t.jsxs("div",{className:h,children:[a,n&&t.jsx("span",{className:"mini-widget-unit",children:n})]}),r&&t.jsx("div",{className:"mini-widget-subtitle",children:r}),c]})]})}const Re={DELTA_CRITICAL:10,SLOPE_CRITICAL:4,JITTER_CRITICAL:6,DELTA_WARNING:5,SLOPE_WARNING:2,JITTER_WARNING:4},De={baselineMedian:null,baselineP10:null,baselineP90:null,currentMedian:null,currentSampleCount:0,delta:0,slope:0,jitter:0,penalty:0,penaltyReason:null,computedAt:0,isReliable:!1};function Fe(e,t){if(0===e.length)return null;const s=[...e].sort((e,t)=>e-t),a=t/100*(s.length-1),n=Math.floor(a),l=Math.ceil(a);return n===l?s[n]:s[n]+(s[l]-s[n])*(a-n)}function Be(e){return Fe(e,50)}const Te={lbtStats:null,noiseFloor:null,sparklineNoiseFloor:[],linkQuality:null,channelHealth:null,nfTrend:De,radioConfig:null,trends:null,stats:null,recentPackets:[],quickNeighbors:[],isLoading:!0,error:null,refresh:async()=>{}},Ae=e.createContext(Te);function $e(e){if(!e)return[];try{const t=JSON.parse(e);if(Array.isArray(t))return t.map(Number).filter(e=>!isNaN(e))}catch{}return[]}function Pe(e){return null!=e&&0!==e&&!Object.is(e,-0)&&!(e>-50||e<-130)}function Ie(e,t,s=2,a=!1){if(null===t)return"stable";const n=e-t;return(0!==t?100*Math.abs(n/t):Math.abs(n))<s?"stable":a?n>0?"up":"down":n>0?"down":"up"}function He({children:s}){var a;const n=M(),l=y(),i=C(),r=R(),o=D(),c=F[o],d=Math.max(1,c.minutes/60),u=null===n,m=e.useMemo(()=>function(e,t){const s=3600*t,a=Math.floor(Date.now()/1e3)-s,n=e.filter(e=>e.timestamp>=a&&void 0!==e.lbt_attempts&&e.lbt_attempts>0),l=n.length,i=n.filter(e=>(e.lbt_attempts??0)>1).length,r=l>0?i/l*100:0,o=n.filter(e=>(e.lbt_attempts??0)>1),c=o.length>0?o.reduce((e,t)=>e+(t.lbt_attempts??0),0)/o.length:0,d=n.filter(e=>(e.lbt_attempts??0)>=5).length,u=l>0?d/l*100:0,m=[];for(const b of n){const e=$e(b.lbt_backoff_delays_ms);m.push(...e)}const x=m.reduce((e,t)=>e+t,0),h=m.length>0?x/m.length:0,p=m.length>0?Math.min(...m):0,f=m.length>0?Math.max(...m):0,v=s/24,g=[],j=[];for(let b=0;b<24;b++){const e=a+b*v,t=e+v,s=n.filter(s=>s.timestamp>=e&&s.timestamp<t),l=s.filter(e=>(e.lbt_attempts??0)>1).length,i=s.length>0?l/s.length*100:0,r=[];for(const a of s){const e=$e(a.lbt_backoff_delays_ms);r.push(...e)}const o=r.length>0?r.reduce((e,t)=>e+t,0)/r.length:0;if(g.push(o),0===s.length)j.push(0);else{const e=s.filter(e=>(e.lbt_attempts??0)>=5).length,t=r.length>0?Math.max(...r):0,a=Math.min(s.length/5,1),n=.15,l=Math.log(1+i*n)/Math.log(1+100*n)*40,c=e/s.length*100,d=Math.min(.5*c,25);let u=0;o>100&&(u=Math.min(8*Math.log10(o/100),15));let m=0;t>500&&o>0&&t>2*o&&(m=Math.min((t-500)/200,5));const x=l+d+u+m;j.push(Math.min(x*a,85))}}return{totalPacketsWithLBT:l,packetsWithRetries:i,retryRate:r,avgRetries:c,channelBusyCount:d,channelBusyRate:u,avgBackoffMs:h,minBackoffMs:p,maxBackoffMs:f,totalBackoffMs:x,sparklineBackoff:g,sparklineCollisionRisk:j,windowHours:t,packetCount:e.length}}(l,d),[l,d]),x=(null==n?void 0:n.noise_floor_dbm)??null,h=e.useMemo(()=>Pe(x)?x:null,[x]),p=e.useMemo(()=>{var e;const t=null==(e=null==n?void 0:n.config)?void 0:e.radio;return t?{sf:t.spreading_factor??7,bwHz:t.bandwidth??125e3}:null},[null==(a=null==n?void 0:n.config)?void 0:a.radio]),[f,v]=e.useState([]),g=e.useRef({time:0,hours:0});e.useEffect(()=>{const e=async()=>{var e;const t=Date.now(),s=Math.ceil(d);if(0===g.current.time||g.current.hours!==s||t-g.current.time>=6e4){g.current={time:t,hours:s};try{const t=await B(Math.max(s,24));t.success&&(null==(e=t.data)?void 0:e.history)&&v(t.data.history)}catch{}}};e();const t=setInterval(e,6e4);return()=>clearInterval(t)},[d]);const j=e.useMemo(()=>{if(0===f.length)return[];const e=f.reduce((e,t)=>Math.max(e,t.timestamp),0);if(0===e)return[];const t=3600*d,s=e-t,a=t/24,n=[];for(let l=0;l<24;l++){const e=s+l*a,t=e+a,i=f.filter(s=>s.timestamp>=e&&s.timestamp<t&&Pe(s.noise_floor_dbm));if(i.length>0){const e=i.reduce((e,t)=>e+t.noise_floor_dbm,0)/i.length;n.push(e)}else n.push(n.length>0?n[n.length-1]:-100)}return n},[f,d]),b=null==n?void 0:n.neighbors,N=e.useMemo(()=>{const e=b??{};return Object.fromEntries(Object.entries(e).filter(([e])=>!r.has(e)))},[b,r]),k=e.useMemo(()=>i.filter(e=>!r.has(e.hash)),[i,r]),w=e.useMemo(()=>function(e){if(0===e.length)return{...De,computedAt:Math.floor(Date.now()/1e3)};const t=Math.floor(Date.now()/1e3),s=e.filter(e=>Number.isFinite(e)),a=e.length>0?[e[e.length-1]]:[],n=e.slice(-4).filter(e=>Number.isFinite(e)),l=Be(s),i=Fe(s,10),r=Fe(s,90),o=Be(a),c=null!==o&&null!==i?o-i:0,d=function(e){if(e.length<2)return 0;const t=e.length;let s=0,a=0,n=0,l=0;const i=e[0].timestamp;for(const o of e){const e=(o.timestamp-i)/3600,t=o.value;s+=e,a+=t,n+=e*t,l+=e*e}const r=t*l-s*s;return Math.abs(r)<1e-4?0:(t*n-s*a)/r}(n.map((e,s)=>({timestamp:t-3600*(n.length-1-s),value:e}))),u=function(e){if(e.length<2)return 0;const t=e.reduce((e,t)=>e+t,0)/e.length,s=e.map(e=>Math.pow(e-t,2)).reduce((e,t)=>e+t,0)/e.length;return Math.sqrt(s)}(n),m=s.length>=12,[x,h]=m?function(e,t,s){const a=Re;return e>=a.DELTA_CRITICAL?[2,`Noise floor ${e.toFixed(1)} dB above baseline`]:t>=a.SLOPE_CRITICAL?[2,`Noise floor rising ${t.toFixed(1)} dB/hour`]:s>=a.JITTER_CRITICAL?[2,`Noise floor unstable (Â±${s.toFixed(1)} dB)`]:e>=a.DELTA_WARNING?[1,`Noise floor ${e.toFixed(1)} dB above baseline`]:t>=a.SLOPE_WARNING?[1,`Noise floor rising ${t.toFixed(1)} dB/hour`]:s>=a.JITTER_WARNING?[1,`Noise floor variable (Â±${s.toFixed(1)} dB)`]:[0,null]}(c,d,u):[0,null];return{baselineMedian:l,baselineP10:i,baselineP90:r,currentMedian:o,currentSampleCount:a.length,delta:c,slope:d,jitter:u,penalty:x,penaltyReason:h,computedAt:t,isReliable:m}}(j),[j]),_=e.useMemo(()=>function(e,t,s){if(0===e.length)return{neighbors:[],networkScore:0,neighborCount:0,bestLink:null,worstLink:null};const a=e.map(e=>{const a=function(e,t,s){const a=se(e,t,s,0);if(a)switch(a.finalGrade){case"excellent":return 100;case"good":return 80;case"fair":return 60;case"poor":return 40;case"critical":return 20}const n=void 0===e?50:e>=10?100:e>=5?80:e>=0?60:e>=-5?40:20,l=void 0===t?50:t>=-70?100:t>=-80?80:t>=-90?60:t>=-100?40:20;return Math.round(.6*n+.4*l)}(e.avgSnr??void 0,e.avgRssi??void 0,s),n=t[e.hash];return{name:(null==n?void 0:n.name)||(null==n?void 0:n.node_name)||e.prefix,hash:e.hash,rssi:e.avgRssi??-100,snr:e.avgSnr??-10,score:a,advertCount:e.count}});a.sort((e,t)=>t.score-e.score);const n=a.length>0?a.reduce((e,t)=>e+t.score,0)/a.length:0;return{neighbors:a,networkScore:Math.round(n),neighborCount:a.length,bestLink:a.length>0?{name:a[0].name,score:a[0].score}:null,worstLink:a.length>0?{name:a[a.length-1].name,score:a[a.length-1].score}:null}}(k,N,p),[k,N,p]),S=e.useMemo(()=>function(e,t,s){const a=e?Math.max(0,Math.min(100,100-5*e.retryRate)):50;let n=50;null!==t&&(n=Math.max(0,Math.min(100,(t+120)/30*100)));const l=(null==s?void 0:s.networkScore)??50,i=Math.round(.35*a+.25*n+.4*l);let r;return r=i>=85?"excellent":i>=70?"good":i>=50?"fair":i>=30?"congested":"critical",{score:i,status:r,components:{lbtHealth:Math.round(a),noiseHealth:Math.round(n),linkHealth:Math.round(l)}}}(m,h,_),[m,h,_]),[L,T]=e.useState({noiseFloor:null,networkScore:null,channelHealth:null}),A=e.useRef(0);e.useEffect(()=>{const e=()=>{const e=Date.now();e-A.current>3e4&&(A.current=e,T({noiseFloor:h,networkScore:(null==_?void 0:_.networkScore)??null,channelHealth:(null==S?void 0:S.score)??null}))};e();const t=setInterval(e,5e3);return()=>clearInterval(t)},[h,null==_?void 0:_.networkScore,null==S?void 0:S.score]);const $=e.useMemo(()=>({noiseFloor:{current:h,previous:L.noiseFloor,trend:null!==h?Ie(h,L.noiseFloor,2,!0):"stable"},networkScore:{current:(null==_?void 0:_.networkScore)??0,previous:L.networkScore,trend:Ie((null==_?void 0:_.networkScore)??0,L.networkScore,3,!1)},channelHealth:{current:(null==S?void 0:S.score)??0,previous:L.channelHealth,trend:Ie((null==S?void 0:S.score)??0,L.channelHealth,3,!1)}}),[h,null==_?void 0:_.networkScore,null==S?void 0:S.score,L]),P={lbtStats:m,noiseFloor:h,sparklineNoiseFloor:j,linkQuality:_,channelHealth:S,nfTrend:w,radioConfig:p,trends:$,stats:n,recentPackets:l,quickNeighbors:i,isLoading:u,error:null,refresh:async()=>{}};return t.jsx(Ae.Provider,{value:P,children:s})}function Ee(){const t=e.useContext(Ae);if(void 0===t)throw new Error("useLBTData must be used within an LBTDataProvider");return t}function We(e,t){return 0===e?"No backoffs":`${t.toFixed(0)}% retry rate`}function qe(){const{lbtStats:s,isLoading:a,error:n}=Ee(),l=c(),i=(null==s?void 0:s.avgBackoffMs)??0,r=(null==s?void 0:s.retryRate)??0,o=s?(u=i)<100?"excellent":u<250?"good":u<500?"fair":u<1e3?"congested":"critical":"unknown";var u;const m=null==s?void 0:s.sparklineBackoff,{chartData:x,yDomain:h}=e.useMemo(()=>{if(!m||m.length<2)return{chartData:[],yDomain:[0,100]};const e=m.map(e=>({value:e})),t=m.filter(e=>e>0);if(0===t.length)return{chartData:e,yDomain:[0,100]};const s=Math.min(...t),a=Math.max(...t),n=a-s,l=Math.max(.2*n,.1*a,10);return{chartData:e,yDomain:[Math.max(0,s-l),a+l]}},[m]);return t.jsx(Ce,{title:"LBT Backoff",icon:t.jsx(d,{className:"mini-widget-icon"}),value:Math.round(i),unit:"ms",status:o,subtitle:s?We(i,r):void 0,isLoading:a,error:n,onClick:()=>l("/packets"),children:t.jsx("div",{className:"mini-widget-sparkline",children:x.length>0?t.jsx(ae,{width:"100%",height:24,children:t.jsxs(ne,{data:x,margin:{top:2,right:2,bottom:2,left:2},children:[t.jsx(le,{domain:h,hide:!0}),t.jsx(ie,{type:"monotone",dataKey:"value",stroke:"var(--accent-primary)",strokeWidth:2,dot:!1,isAnimationActive:!1})]})}):t.jsx("div",{className:"h-full"})})})}function Oe(e){return 0===e?"â€”":e<1?"<1":Math.round(e).toString()}function ze(){const{lbtStats:e,isLoading:s,error:a}=Ee(),n=c(),l=(null==e?void 0:e.channelBusyCount)??0,i=(null==e?void 0:e.totalPacketsWithLBT)??0,r=(null==e?void 0:e.channelBusyRate)??0,o=(null==e?void 0:e.retryRate)??0,d=(null==e?void 0:e.avgBackoffMs)??0,m=(null==e?void 0:e.minBackoffMs)??0,x=(null==e?void 0:e.maxBackoffMs)??0,h=o>0?Math.max(0,(o-r)/o*100):100;return t.jsx(Ce,{title:"Ch. Busy",icon:t.jsx(u,{className:"mini-widget-icon"}),isLoading:s,error:a,onClick:()=>n("/packets"),children:t.jsx("div",{className:"flex-1 flex items-end",children:t.jsxs("div",{className:"grid grid-cols-[auto_minmax(0,1fr)_auto_minmax(0,1fr)] gap-x-2 gap-y-2 w-full items-baseline",children:[t.jsx("span",{className:"data-box-label mb-0",title:`${l} packets exceeded max CAD attempts (5) out of ${i} total transmissions.`,children:"Failed:"}),t.jsxs("div",{className:"data-box justify-self-start",title:`${l} packets exceeded max CAD attempts (5) out of ${i} total transmissions.`,children:[l,t.jsx("span",{className:"text-text-muted",children:"/"}),i]}),t.jsx("span",{className:"data-box-label mb-0",title:`${h.toFixed(1)}% of packets that needed LBT retries were sent successfully.`,children:"Sent:"}),t.jsxs("div",{className:"data-box justify-self-start",title:`${h.toFixed(1)}% of packets that needed LBT retries were sent successfully.`,children:[h.toFixed(0),"%"]}),t.jsx("span",{className:"data-box-label mb-0",title:`Average LBT backoff delay: ${d.toFixed(0)}ms.`,children:"Mean:"}),t.jsxs("div",{className:"data-box justify-self-start",title:`Average LBT backoff delay: ${d.toFixed(0)}ms.`,children:[Oe(d),t.jsx("span",{className:"text-text-muted text-xs",children:"ms"})]}),t.jsx("span",{className:"data-box-label mb-0",title:`Backoff range: ${m.toFixed(0)}ms min, ${x.toFixed(0)}ms max.`,children:"Range:"}),t.jsxs("div",{className:"data-box justify-self-start",title:`Backoff range: ${m.toFixed(0)}ms min, ${x.toFixed(0)}ms max.`,children:[Oe(m),t.jsx("span",{className:"text-text-muted",children:"/"}),Oe(x)]})]})})})}function Ge(e){return null===e?"No reading":e<-115?"Very quiet":e<-105?"Quiet":e<-95?"Moderate":e<-85?"Elevated":"High interference"}function Ke(){const{noiseFloor:s,sparklineNoiseFloor:a,trends:n,isLoading:l,error:i}=Ee(),r=null===(o=s)||o<-110?"excellent":o<-100?"good":o<-90?"fair":o<-80?"congested":"critical";var o;const c=null==n?void 0:n.noiseFloor.trend,{chartData:d,yDomain:u}=e.useMemo(()=>{if(!a||a.length<2)return{chartData:[],yDomain:[-120,-90]};const e=a.map(e=>({value:e})),t=a.filter(e=>-100!==e&&e<-50);if(0===t.length)return{chartData:e,yDomain:[-120,-90]};const s=Math.min(...t),n=Math.max(...t),l=n-s,i=Math.max(.2*l,3);return{chartData:e,yDomain:[s-i,n+i]}},[a]);return t.jsx(Ce,{title:"Noise Floor",icon:t.jsx(m,{className:"mini-widget-icon"}),value:null!==s?Math.round(s):"â€”",unit:null!==s?"dBm":void 0,status:r,trend:c,subtitle:Ge(s),isLoading:l,error:i,children:t.jsx("div",{className:"mini-widget-sparkline",children:d.length>0?t.jsx(ae,{width:"100%",height:24,children:t.jsxs(ne,{data:d,margin:{top:2,right:2,bottom:2,left:2},children:[t.jsx(le,{domain:u,hide:!0}),t.jsx(ie,{type:"monotone",dataKey:"value",stroke:"var(--accent-primary)",strokeWidth:2,dot:!1,isAnimationActive:!1})]})}):t.jsx("div",{className:"h-full"})})})}function Ue(){const s=c(),a=C(),n=y(),l=M(),i=D(),r=60*F[i].minutes,o=T(),d=e.useMemo(()=>{if(0===o)return n;const e=o-r;return n.filter(t=>t.timestamp>=e)},[n,r,o]),u=null===l,m=(null==l?void 0:l.local_hash)?S(l.local_hash):"",v=(null==l?void 0:l.neighbors)??{},{neighborHashes:g,neighborNames:j}=e.useMemo(()=>{const e=new Set,t=new Map;for(const s of a){e.add(s.hash);const a=v[s.hash],n=(null==a?void 0:a.name)||(null==a?void 0:a.node_name)||s.prefix;t.set(s.hash,n)}return{neighborHashes:e,neighborNames:t}},[a,v]),b=e.useMemo(()=>{if(0===g.size||0===d.length||!m)return{champion:null,listener:null,loudest:null};const{scores:e}=me(d,g,m),t=[];for(const[l,i]of e)0!==i.blendedScore&&t.push({...i,name:j.get(l)??S(l)});let s=null,a=null,n=null;for(const l of t)(!s||l.blendedScore>s.blendedScore)&&(s=l),(!a||l.listenerScore>a.listenerScore)&&(a=l),(!n||l.loudScore>n.loudScore)&&(n=l);return{champion:s,listener:a,loudest:n}},[d,g,m,j]),{champion:N,listener:k,loudest:w}=b,_=N||k||w?t.jsxs("div",{className:"flex flex-col gap-0.5 mt-auto",children:[N&&t.jsx(A,{content:(L=N,t.jsxs("div",{className:"max-w-[220px]",children:[t.jsxs("div",{className:"font-semibold mb-1",children:["ðŸ† Champion: ",L.name]}),t.jsxs("div",{className:"text-text-muted mb-1",children:["Blended Score: ",L.blendedScore,t.jsx("span",{className:"text-text-muted/60 ml-1",children:"(Listener + Loud)"})]}),t.jsxs("div",{className:"border-t border-border-subtle pt-1 mt-1 space-y-0.5",children:[t.jsxs("div",{children:["Listener: ",L.listenerScore,"/100 (",L.listenerCount," shared paths)"]}),t.jsxs("div",{children:["Loud: ",L.loudScore,"/100 (",L.loudCount," packets relayed)"]})]})]})),children:t.jsxs("div",{className:"flex items-center gap-1 text-sm rounded px-1 -mx-1 hover:bg-white/5 transition-colors cursor-default",children:[t.jsx(x,{className:"w-3 h-3 text-map-neighbor-color flex-shrink-0"}),t.jsx("span",{className:"font-semibold text-map-neighbor-color font-mono truncate flex-1 min-w-0",children:N.name}),t.jsx("span",{className:"text-map-neighbor-color pl-2 tabular-nums flex-shrink-0 w-9 text-right",children:N.blendedScore})]})}),k&&t.jsx(A,{content:(e=>t.jsxs("div",{className:"max-w-[220px]",children:[t.jsxs("div",{className:"font-semibold mb-1",children:["ðŸ‘‚ Best Listener: ",e.name]}),t.jsxs("div",{className:"text-text-muted mb-1",children:["Score: ",e.listenerScore,"/100"]}),t.jsx("div",{className:"border-t border-border-subtle pt-1 mt-1",children:t.jsxs("div",{children:[e.listenerCount," packets where they heard your transmissions"]})})]}))(k),children:t.jsxs("div",{className:"flex items-center gap-1 text-sm rounded px-1 -mx-1 hover:bg-white/5 transition-colors cursor-default",children:[t.jsx(h,{className:"w-3 h-3 text-text-muted flex-shrink-0"}),t.jsx("span",{className:"text-text-muted font-mono truncate flex-1 min-w-0",children:k.name}),t.jsx("span",{className:"text-text-muted pl-2 tabular-nums flex-shrink-0 w-9 text-right",children:k.listenerScore})]})}),w&&t.jsx(A,{content:(e=>t.jsxs("div",{className:"max-w-[220px]",children:[t.jsxs("div",{className:"font-semibold mb-1",children:["ðŸ“¢ Loudest: ",e.name]}),t.jsxs("div",{className:"text-text-muted mb-1",children:["Score: ",e.loudScore,"/100"]}),t.jsx("div",{className:"border-t border-border-subtle pt-1 mt-1",children:t.jsxs("div",{children:[e.loudCount," packets they relayed directly to you"]})})]}))(w),children:t.jsxs("div",{className:"flex items-center gap-1 text-sm rounded px-1 -mx-1 hover:bg-white/5 transition-colors cursor-default",children:[t.jsx(p,{className:"w-3 h-3 text-text-muted flex-shrink-0"}),t.jsx("span",{className:"text-text-muted font-mono truncate flex-1 min-w-0",children:w.name}),t.jsx("span",{className:"text-text-muted pl-2 tabular-nums flex-shrink-0 w-9 text-right",children:w.loudScore})]})})]}):0===a.length?t.jsx("div",{className:"flex items-center justify-center text-sm text-text-muted mt-auto",children:"No direct neighbors"}):t.jsx("div",{className:"flex items-center justify-center text-sm text-text-muted mt-auto",children:"No routing data yet"});var L;return t.jsx(Ce,{title:"Link Leaders",icon:t.jsx(f,{className:"mini-widget-icon"}),isLoading:u,onClick:()=>s("/contacts"),children:_})}function Je(){const{lbtStats:s,isLoading:a,error:n}=Ee(),l=s?function(e){const{retryRate:t,channelBusyCount:s,totalPacketsWithLBT:a,avgBackoffMs:n,maxBackoffMs:l}=e;if(0===a)return 0;const i=Math.min(a/10,1),r=Math.log(1+.15*t)/Math.log(16)*40,o=s/a*100,c=Math.min(.5*o,25);let d=0;n>100&&(d=Math.min(8*Math.log10(n/100),15));let u=0;l>500&&n>0&&l>2*n&&(u=Math.min((l-500)/200,5));const m=(r+c+d+u)*i;return Math.min(m,85)}(s):0,i=s?(r=l)<15?"excellent":r<30?"good":r<45?"fair":r<60?"congested":"critical":"unknown";var r;const o=(null==s?void 0:s.maxBackoffMs)??0,c=s?o>200?`Max backoff: ${Math.round(o)}ms`:function(e){return e<15?"Clear channel":e<30?"Light traffic":e<45?"Moderate traffic":e<60?"Heavy traffic":e<75?"Congested":"Severe congestion"}(l):void 0,d=null==s?void 0:s.sparklineCollisionRisk,{chartData:u,yDomain:m}=e.useMemo(()=>{if(!d||d.length<2)return{chartData:[],yDomain:[0,85]};const e=d.map(e=>({value:e})),t=d.filter(e=>e>0);if(0===t.length)return{chartData:e,yDomain:[0,85]};const s=Math.min(...t),a=Math.max(...t),n=a-s,l=Math.max(.2*n,5);return{chartData:e,yDomain:[Math.max(0,s-l),Math.min(85,a+l)]}},[d]);return t.jsx(Ce,{title:"Collision Risk",icon:t.jsx(v,{className:"mini-widget-icon"}),value:l.toFixed(1),unit:"%",status:i,subtitle:c,isLoading:a,error:n,children:t.jsx("div",{className:"mini-widget-sparkline",children:u.length>0?t.jsx(ae,{width:"100%",height:24,children:t.jsxs(ne,{data:u,margin:{top:2,right:2,bottom:2,left:2},children:[t.jsx(le,{domain:m,hide:!0}),t.jsx(ie,{type:"monotone",dataKey:"value",stroke:"var(--accent-primary)",strokeWidth:2,dot:!1,isAnimationActive:!1})]})}):t.jsx("div",{className:"h-full"})})})}function Ve(){const[s,a]=e.useState(!1),[n]=e.useState(0),{stats:l,lbtStats:r,isLoading:o}=Ee(),c=e.useMemo(()=>{if(!l)return null;const e=l.airtime_used_ms??0,t=l.max_airtime_ms??1;return{usedMs:e,maxMs:t,remainingMs:l.airtime_remaining_ms??0,utilizationPercent:l.utilization_percent??(t>0?e/t*100:0)}},[l]),d=e.useMemo(()=>r&&0!==r.totalPacketsWithLBT?(r.totalPacketsWithLBT-r.packetsWithRetries)/r.totalPacketsWithLBT*100:100,[r]),u=(null==c?void 0:c.utilizationPercent)??0,m=(x=u)<30?"excellent":x<50?"good":x<70?"fair":x<90?"congested":"critical";var x;const h=(null==c?void 0:c.remainingMs)??0,p=d<95?`${d.toFixed(0)}% clean TX`:((f=h)<1e3?`${Math.round(f)}ms`:f<6e4?`${(f/1e3).toFixed(1)}s`:`${(f/6e4).toFixed(1)}m`)+" remaining";var f;const v=c?t.jsx("div",{className:"mini-widget-progress mt-auto",children:t.jsx("div",{className:`mini-widget-progress-bar ${m}`,style:{width:`${Math.min(u,100)}%`}})}):null;return t.jsx(Ce,{title:"Duty Cycle",icon:t.jsx(i,{className:"mini-widget-icon"}),value:u.toFixed(1),unit:"%",status:m,subtitle:p,isLoading:o,children:v})}function Qe(){return t.jsxs("div",{className:"mini-widget",children:[t.jsxs("div",{className:"mini-widget-header",children:[t.jsx(K,{className:"w-4 h-4"}),t.jsx(K,{className:"h-3 w-16"})]}),t.jsx(K,{className:"h-7 w-12 mt-2"}),t.jsx(K,{className:"h-3 w-20 mt-2"})]})}function Xe(){return t.jsx("div",{className:"widget-row",children:Array.from({length:6}).map((e,s)=>t.jsx(Qe,{},s))})}function Ye({className:e="",isLoaded:s=!0}){return t.jsxs("div",{className:`mesh-health-container relative ${e}`,children:[t.jsxs("div",{className:"mesh-health-header",children:[t.jsx(g,{className:"w-4 h-4 text-accent-primary"}),t.jsx("span",{className:"type-label text-text-muted",children:"MESH HEALTH"})]}),s?t.jsx(He,{children:t.jsxs("div",{className:"widget-row",children:[t.jsx(qe,{}),t.jsx(Je,{}),t.jsx(Ke,{}),t.jsx(Ve,{}),t.jsx(ze,{}),t.jsx(Ue,{})]})}):t.jsx(Xe,{})]})}function Ze(){var s,n;const l=M(),r=$(),o=y(),c=P(),d=D(),u=I(),m=H(),x=F[d],h=5===d&&!m.threeDayLoadComplete,p=6===d&&!m.sevenDayLoadComplete,f=7===d&&!m.fourteenDayLoadComplete,v=m.isBackgroundLoading&&(h||p||f),g=O(),k=z(),w=null==(s=null==l?void 0:l.config)?void 0:s.radio,_=e.useMemo(()=>w?{sf:w.spreading_factor??10,bw:w.bandwidth??25e4,cr:w.coding_rate??5,preamble:w.preamble_length??8}:null,[w]),S=o.length,L=e.useMemo(()=>S?E(x.minutes,x.buckets,o,l):null,[S,x.minutes,x.buckets,_]),C=e.useMemo(()=>function(e,t,s){if(!(null==e?void 0:e.length))return[];const a=s>1440?{weekday:"short",hour:"2-digit",minute:"2-digit",hour12:!1}:{hour:"2-digit",minute:"2-digit",hour12:!1};return e.map((e,s)=>{var n;return{time:new Date(1e3*e.start).toLocaleString([],a),received:e.count,unique:(null==(n=null==t?void 0:t[s])?void 0:n.count)??0}})}(null==L?void 0:L.received,null==L?void 0:L.unique_received,x.minutes),[null==L?void 0:L.received,null==L?void 0:L.unique_received,x.minutes]),R=e.useMemo(()=>function(e){if(!e.length)return[0,"auto"];let t=e[0].received,s=e[0].received;for(const n of e)n.received<t&&(t=n.received),n.received>s&&(s=n.received),n.unique<t&&(t=n.unique),n.unique>s&&(s=n.unique);if(t===s)return[Math.max(0,t-1),s+1];const a=.1*(s-t);return[Math.max(0,Math.floor(t-a)),Math.ceil(s+a)]}(C),[C]),B=e.useMemo(()=>{return(e=C.length)<=12?0:e<=24?2:e<=48?5:e<=72?8:Math.floor(e/7);var e},[C.length]),T=e.useMemo(()=>{const e=e=>(null==e?void 0:e.reduce((e,t)=>e+t.count,0))??0,t=e(null==L?void 0:L.received),s=e(null==L?void 0:L.unique_received),a=e(null==L?void 0:L.forwarded),n=e(null==L?void 0:L.dropped),l=e(null==L?void 0:L.transmitted),i=((null==L?void 0:L.time_range_minutes)??x.minutes)/60;return{received:t,uniqueReceived:s,forwarded:a,dropped:n,transmitted:l,rxPerHour:i>0?Math.round(t/i):0,fwdPerHour:i>0?Math.round(a/i):0}},[L,x.minutes]),A=(null==l?void 0:l.node_name)??(null==(n=null==l?void 0:l.config)?void 0:n.node_name)??"Unknown Node";return r?t.jsxs(U,{className:"p-8 text-center",children:[t.jsx("p",{className:"type-subheading text-accent-red mb-2",children:"Failed to connect to backend"}),t.jsx("p",{className:"type-body text-white/50",children:r}),t.jsx("p",{className:"type-data-sm text-white/40 mt-4",children:"Make sure the backend is running on port 8000"})]}):t.jsxs(J,{children:[t.jsx(V,{title:A,icon:t.jsx(j,{}),controls:t.jsx(ee,{ranges:F,selectedIndex:d,onSelect:u,isPending:v})}),t.jsx(xe,{template:"hero",children:t.jsx(U,{isLoaded:c,skeletonType:"chart",compact:!0,children:c&&t.jsxs(t.Fragment,{children:[t.jsx(Q,{icon:t.jsx(a,{}),title:"RECEIVED",badge:x.label,actions:t.jsxs("div",{className:"data-box",children:[T.rxPerHour,"/hr"]})}),t.jsxs("div",{className:"flex gap-8",children:[t.jsxs("div",{className:"flex items-end gap-2",children:[t.jsx("div",{className:"font-mono text-3xl font-semibold tabular-nums text-text-primary leading-none",style:{letterSpacing:"-0.05em"},children:T.received.toLocaleString()}),t.jsx("span",{className:"color-pill mb-1",style:{"--pill-color":g.received},children:"Total RF"})]}),t.jsxs("div",{className:"flex items-end gap-2",children:[t.jsx("div",{className:"font-mono text-3xl font-semibold tabular-nums text-text-primary leading-none",style:{letterSpacing:"-0.05em"},children:T.uniqueReceived.toLocaleString()}),t.jsx("span",{className:"color-pill mb-1",style:{"--pill-color":g.forwarded},children:"Unique"})]})]}),t.jsx("div",{className:"mt-8",children:C.length>0?t.jsx(ae,{width:"100%",height:216,children:t.jsxs(re,{data:C,margin:{left:0,right:8,top:0,bottom:0},children:[t.jsxs("defs",{children:[t.jsxs("linearGradient",{id:"gradient-received",x1:"0",y1:"0",x2:"0",y2:"1",children:[t.jsx("stop",{offset:"5%",stopColor:g.received,stopOpacity:.3}),t.jsx("stop",{offset:"95%",stopColor:g.received,stopOpacity:0})]}),t.jsxs("linearGradient",{id:"gradient-unique",x1:"0",y1:"0",x2:"0",y2:"1",children:[t.jsx("stop",{offset:"5%",stopColor:g.forwarded,stopOpacity:.53}),t.jsx("stop",{offset:"95%",stopColor:g.forwarded,stopOpacity:0})]})]}),t.jsx(oe,{strokeDasharray:"3 3",stroke:k.grid,vertical:!1}),t.jsx(ce,{dataKey:"time",axisLine:!1,tickLine:!1,tick:{fill:k.axisTick,fontSize:10,fontFamily:W},dy:8,interval:B,minTickGap:20}),t.jsx(le,{domain:R,axisLine:!1,tickLine:!1,tick:{fill:k.axisTick,fontSize:10,fontFamily:W},dx:-4,width:28}),t.jsx(de,{content:t.jsx(we,{labelKey:"time"}),cursor:{stroke:k.cursor,strokeWidth:1}}),t.jsx(ue,{type:"stepAfter",dataKey:"received",name:"Total RF",stroke:g.received,fill:"url(#gradient-received)",strokeWidth:1.5,dot:!1,activeDot:{r:4,strokeWidth:0,fill:g.received},isAnimationActive:!1}),t.jsx(ue,{type:"stepAfter",dataKey:"unique",name:"Unique",stroke:g.forwarded,fill:"url(#gradient-unique)",strokeWidth:1.5,dot:!1,activeDot:{r:4,strokeWidth:0,fill:g.forwarded},isAnimationActive:!1})]})}):t.jsx("div",{className:"h-full flex items-center justify-center text-text-muted",children:"No data available for this time range"})})]})})}),t.jsxs(xe,{template:"compact",children:[t.jsx(he,{span:12,md:6,lg:4,children:t.jsx(ge,{title:"FORWARDED",value:T.forwarded,color:"forwarded",buckets:null==L?void 0:L.forwarded,receivedCount:T.received,timeRangeLabel:x.label,icon:t.jsx(b,{className:"w-4 h-4"}),isLoaded:c})}),t.jsx(he,{span:12,md:6,lg:4,children:t.jsx(ge,{title:"DROPPED",value:T.dropped,color:"dropped",buckets:null==L?void 0:L.dropped,receivedCount:T.received,timeRangeLabel:x.label,icon:t.jsx(N,{className:"w-4 h-4"}),isLoaded:c})}),t.jsx(he,{span:12,md:12,lg:4,children:t.jsx(ye,{stats:l,receivedBuckets:null==L?void 0:L.received,droppedBuckets:null==L?void 0:L.dropped,forwardedBuckets:null==L?void 0:L.forwarded,bucketDurationSeconds:null==L?void 0:L.bucket_duration_seconds,timeRangeLabel:x.label,isLoaded:c})})]}),t.jsx(Ye,{isLoaded:c}),t.jsx(ke,{}),l&&t.jsx(xe,{template:"auto",children:t.jsxs(U,{children:[t.jsx(Q,{icon:t.jsx(i,{}),title:"Node Information",largeTitle:!0}),t.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4",children:[t.jsxs("div",{className:"min-w-0",children:[t.jsx("span",{className:"type-label text-text-secondary",children:"Node Name"}),t.jsx("p",{className:"type-body text-text-primary mt-1 truncate",title:A,children:A})]}),t.jsxs("div",{className:"min-w-0",children:[t.jsx("span",{className:"type-label text-text-secondary",children:"Repeater"}),t.jsxs("p",{className:"type-data text-text-primary mt-1 truncate",title:`v${l.version}`,children:["v",l.version]})]}),t.jsxs("div",{className:"min-w-0",children:[t.jsx("span",{className:"type-label text-text-secondary",children:"Core"}),t.jsxs("p",{className:"type-data text-text-primary mt-1 truncate",title:`v${l.core_version}`,children:["v",l.core_version]})]}),t.jsxs("div",{className:"min-w-0",children:[t.jsx("span",{className:"type-label text-text-secondary",children:"Console"}),t.jsxs("p",{className:"type-data text-text-primary mt-1 truncate",title:`v${q}`,children:["v",q]})]}),t.jsxs("div",{className:"min-w-0",children:[t.jsx("span",{className:"type-label text-text-secondary",children:"Local Hash"}),t.jsx("div",{className:"mt-1",children:l.local_hash?t.jsx(te,{copy:!0,size:"compact",children:l.local_hash}):t.jsx("span",{className:"type-data-sm text-text-secondary",children:"N/A"})})]})]}),l.public_key&&t.jsxs("div",{className:"mt-4 pt-4 border-t border-border-subtle",children:[t.jsx("span",{className:"type-label text-text-secondary",children:"Public Key"}),t.jsx("div",{className:"mt-1",children:t.jsx(te,{copy:!0,children:l.public_key})})]})]})})]})}export{Ze as default};
