import{c as e,j as t,u as s,a,b as n,d as r,R as l,L as i,e as o,f as c,g as d,h as u,i as x,D as m,k as h,P as p,l as v,M as g,C as f}from"./index-DJZzIT5o.js";import{b as j,d as b,L as y,e as k,A as N,C as w,X as M,Y as L,T as _,f as C}from"./recharts-bmHCCfxU.js";import{u as S,T as B}from"./TimeRangeSelector-CLHMoFwc.js";import{g as F,A as R,P as A,a as P,b as T,C as H}from"./PacketDetailModal-DVdhBb13.js";import{C as D}from"./circle-kquAvdKJ.js";import{H as E}from"./HashBadge-Bw92Kxy4.js";import{T as $,N as z}from"./trending-up-B0SMYyTs.js";import{T as W,M as q,Z as G}from"./zap-RVsBptYq.js";import{C as I,P as V,a as K,b as O}from"./PageLayout-v625f7fI.js";import{H as U}from"./house-ClJ2ctnj.js";import{R as Q}from"./Grid-DCPS4WnS.js";import"./maplibre-gl-CFO9X1Ek.js";import"./SignalIndicator-TYN_Wy0w.js";import"./triangle-alert-CG0Hcq6I.js";const X=e("arrow-up-right",[["path",{d:"M7 7h10v10",key:"1tivn9"}],["path",{d:"M7 17 17 7",key:"1vkiza"}]]),J=e("audio-waveform",[["path",{d:"M2 13a2 2 0 0 0 2-2V7a2 2 0 0 1 4 0v13a2 2 0 0 0 4 0V4a2 2 0 0 1 4 0v13a2 2 0 0 0 4 0v-4a2 2 0 0 1 2-2",key:"57tc96"}]]),Y=e("cross",[["path",{d:"M4 9a2 2 0 0 0-2 2v2a2 2 0 0 0 2 2h4a1 1 0 0 1 1 1v4a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2v-4a1 1 0 0 1 1-1h4a2 2 0 0 0 2-2v-2a2 2 0 0 0-2-2h-4a1 1 0 0 1-1-1V4a2 2 0 0 0-2-2h-2a2 2 0 0 0-2 2v4a1 1 0 0 1-1 1z",key:"1xbrqy"}]]),Z=e("ear-off",[["path",{d:"M6 18.5a3.5 3.5 0 1 0 7 0c0-1.57.92-2.52 2.04-3.46",key:"1qngmn"}],["path",{d:"M6 8.5c0-.75.13-1.47.36-2.14",key:"b06bma"}],["path",{d:"M8.8 3.15A6.5 6.5 0 0 1 19 8.5c0 1.63-.44 2.81-1.09 3.76",key:"g10hsz"}],["path",{d:"M12.5 6A2.5 2.5 0 0 1 15 8.5M10 13a2 2 0 0 0 1.82-1.18",key:"ygzou7"}],["line",{x1:"2",x2:"22",y1:"2",y2:"22",key:"a6p6uj"}]]),ee=e("refresh-cw-off",[["path",{d:"M21 8L18.74 5.74A9.75 9.75 0 0 0 12 3C11 3 10.03 3.16 9.13 3.47",key:"1krf6h"}],["path",{d:"M8 16H3v5",key:"1cv678"}],["path",{d:"M3 12C3 9.51 4 7.26 5.64 5.64",key:"ruvoct"}],["path",{d:"m3 16 2.26 2.26A9.75 9.75 0 0 0 12 21c2.49 0 4.74-1 6.36-2.64",key:"19q130"}],["path",{d:"M21 12c0 1-.16 1.97-.47 2.87",key:"4w8emr"}],["path",{d:"M21 3v5h-5",key:"1q7to0"}],["path",{d:"M22 22 2 2",key:"1r8tn9"}]]),te=e("route",[["circle",{cx:"6",cy:"19",r:"3",key:"1kj8tv"}],["path",{d:"M9 19h8.5a3.5 3.5 0 0 0 0-7h-11a3.5 3.5 0 0 1 0-7H15",key:"1d8sl"}],["circle",{cx:"18",cy:"5",r:"3",key:"gq8acd"}]]),se=e("square-activity",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}],["path",{d:"M17 12h-2l-2 5-2-10-2 5H7",key:"15hlnc"}]]),ae=e("timer",[["line",{x1:"10",x2:"14",y1:"2",y2:"2",key:"14vaq8"}],["line",{x1:"12",x2:"15",y1:"14",y2:"11",key:"17fdiu"}],["circle",{cx:"12",cy:"14",r:"8",key:"1e1u0o"}]]),ne="#39D98A",re="#60A5FA",le="#F9D26F",ie="#FF5C7A",oe="#B0B0C3",ce={received:{value:"text-[var(--metric-received)]",barBase:ne,barGood:ne,barMid:"#2EAE70",barPoor:"#248F5C"},forwarded:{value:"text-[var(--metric-forwarded)]",barBase:re,barGood:re,barMid:"#4B8FE0",barPoor:"#3B7ACC"},transmitted:{value:"text-[var(--metric-transmitted)]",barBase:le,barGood:le,barMid:"#E5BD5E",barPoor:"#CCA84D"},dropped:{value:"text-[var(--metric-dropped)]",barBase:ie,barGood:ie,barMid:"#E54868",barPoor:"#CC3E5C"},neutral:{value:"text-text-secondary",barBase:oe,barGood:oe,barMid:"#9A9AAE",barPoor:"#85859A"}};function de(e,t){return e>=8?t.barGood:e>=3?t.barMid:t.barPoor}function ue({buckets:e,colorType:s,height:a=64}){const n=ce[s],{bars:r}=j.useMemo(()=>{var t,a;if(!e||0===e.length)return{bars:[]};const r=[],l=e.length/60;if(l<=1)r.push(...e);else for(let s=0;s<60;s++){const n=Math.floor(s*l),i=Math.floor((s+1)*l),o=e.slice(n,i),c=o.reduce((e,t)=>e+t.count,0),d=o.length>0?o.reduce((e,t)=>e+t.avg_snr,0)/o.length:0;r.push({bucket:s,start:(null==(t=o[0])?void 0:t.start)??0,end:(null==(a=o[o.length-1])?void 0:a.end)??0,count:c,airtime_ms:o.reduce((e,t)=>e+t.airtime_ms,0),avg_snr:d,avg_rssi:0})}const i=Math.max(...r.map(e=>e.count),1),o="dropped"===s;return{bars:r.map(e=>({height:e.count>0?Math.max(e.count/i*100,8):0,color:e.count>0?o?n.barBase:de(e.avg_snr,n):"transparent",count:e.count,snr:e.avg_snr}))}},[e,n,s]);return e&&0!==e.length?t.jsx("div",{className:"w-full flex items-end gap-[1px]",style:{height:a},children:r.map((e,s)=>{var a;return t.jsx("div",{className:"flex-1 rounded-t-sm",style:{height:`${e.height}%`,backgroundColor:e.color,opacity:e.count>0?.8:.1,minHeight:e.count>0?"4px":"2px",maxWidth:"4px"},title:e.count>0?`${e.count} packets, SNR: ${null==(a=e.snr)?void 0:a.toFixed(1)}dB`:"No packets"},s)})}):t.jsx("div",{className:"w-full flex items-end justify-center gap-[2px] opacity-20",style:{height:a},children:t.jsx("span",{className:"type-data-xs text-text-muted",children:"No data"})})}const xe={received:"text-[var(--metric-received)]",forwarded:"text-[var(--metric-forwarded)]",transmitted:"text-[var(--metric-transmitted)]",dropped:"text-[var(--metric-dropped)]",neutral:"text-[var(--accent-primary)]"},me={sm:"card-sm",md:"card-md",lg:"card-lg",hero:"card-hero",auto:""};function he({title:e,value:s,color:a="neutral",subtitle:n,buckets:r,timeRangeLabel:l,icon:i,size:o="md"}){const c=ce[a],d="string"==typeof s?s:s.toLocaleString();return t.jsxs("div",{className:`data-card flex flex-col ${me[o]}`,children:[t.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[i&&t.jsx("span",{className:`icon-sm ${xe[a]}`,children:i}),t.jsx("span",{className:"type-micro",children:e}),l&&t.jsx("span",{className:"pill-tag",children:l})]}),t.jsx("div",{className:"data-card-value",children:d}),t.jsx("div",{className:"flex-1 py-2 mt-2",children:r?t.jsx(ue,{buckets:r,colorType:a,height:64}):t.jsx("div",{className:"w-full h-16 flex items-center justify-center",children:t.jsx("div",{className:"w-full h-0.5 rounded-full",style:{backgroundColor:c.barBase,opacity:.15}})})}),t.jsx("div",{className:"type-label text-text-muted border-t border-border-subtle pt-3 mt-2",children:n||`Total ${e.toLowerCase()}`})]})}function pe(){const e=s(),o=a(),c=n(),d=r(),[u,x]=j.useState(null),[m,h]=j.useState(null),p=j.useRef(0);j.useEffect(()=>{if(d>0&&d!==p.current&&e.length>0){p.current=d;const t=e.find(e=>(e.payload_type_name||F(e.payload_type??e.type)).toLowerCase().includes("advert"));if(t){const e=requestAnimationFrame(()=>x(t.packet_hash)),s=setTimeout(()=>x(null),600);return()=>{cancelAnimationFrame(e),clearTimeout(s)}}}},[d,e]);const v=e.slice(0,15);return t.jsxs("div",{className:"chart-container h-full flex flex-col",children:[t.jsxs("div",{className:"chart-header",children:[t.jsxs("div",{className:"chart-title",children:[t.jsx(l,{className:"chart-title-icon"}),"Recent Packets"]}),t.jsxs("div",{className:"flex items-center gap-3",children:[c&&t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(D,{className:"w-2 h-2 fill-accent-success text-accent-success animate-pulse"}),t.jsx("span",{className:"type-data-xs text-text-muted",children:"LIVE"})]}),t.jsxs(i,{to:"/packets",className:"pill-subtle",children:["View all ",t.jsx(R,{className:"w-3 h-3"})]})]})]}),t.jsxs("div",{className:"sm:hidden flex items-center gap-1.5 px-3 py-1.5 border-b border-border-subtle/50 bg-bg-elevated/20",children:[t.jsx("span",{className:"text-[9px] font-semibold text-text-muted uppercase tracking-wider w-14 flex-shrink-0",children:"Dir"}),t.jsx("span",{className:"text-[9px] font-semibold text-text-muted uppercase tracking-wider w-7 flex-shrink-0",children:"Time"}),t.jsx("span",{className:"text-[9px] font-semibold text-text-muted uppercase tracking-wider w-9 flex-shrink-0",children:"Src"}),t.jsx("span",{className:"text-[9px] font-semibold text-text-muted uppercase tracking-wider flex-1 min-w-0",children:"Type"}),t.jsx("span",{className:"text-[9px] font-semibold text-text-muted uppercase tracking-wider w-14 flex-shrink-0",children:"Route"}),t.jsx("span",{className:"text-[9px] font-semibold text-text-muted uppercase tracking-wider w-10 text-right flex-shrink-0",children:"Signal"})]}),t.jsx("div",{className:"hidden sm:block flex-1 overflow-hidden",children:t.jsx("div",{className:"h-full overflow-y-auto",children:t.jsxs("table",{className:"w-full",children:[t.jsx("thead",{className:"sticky top-0 bg-bg-elevated/95 backdrop-blur-sm",children:t.jsxs("tr",{className:"border-b border-border-subtle/50",children:[t.jsx("th",{className:"text-left py-1.5 px-3 text-[9px] font-semibold text-text-muted uppercase tracking-wider w-16",children:"Dir"}),t.jsx("th",{className:"text-left py-1.5 px-3 text-[9px] font-semibold text-text-muted uppercase tracking-wider",children:"Time"}),t.jsx("th",{className:"text-left py-1.5 px-3 text-[9px] font-semibold text-text-muted uppercase tracking-wider",children:"Source"}),t.jsx("th",{className:"text-left py-1.5 px-3 text-[9px] font-semibold text-text-muted uppercase tracking-wider",children:"Type"}),t.jsx("th",{className:"text-left py-1.5 px-3 text-[9px] font-semibold text-text-muted uppercase tracking-wider",children:"Route"}),t.jsx("th",{className:"text-right py-1.5 px-3 pr-4 text-[9px] font-semibold text-text-muted uppercase tracking-wider",children:"Signal"})]})}),t.jsx("tbody",{className:"divide-y divide-border-subtle/30",children:o&&0===e.length?t.jsx("tr",{children:t.jsx("td",{colSpan:6,className:"text-center py-8 text-text-muted",children:"Loading packets..."})}):0===v.length?t.jsx("tr",{children:t.jsxs("td",{colSpan:6,className:"text-center py-8",children:[t.jsx(l,{className:"w-6 h-6 text-text-muted mx-auto mb-2"}),t.jsx("div",{className:"text-sm text-text-primary",children:"No packets received"}),t.jsx("div",{className:"text-xs text-text-muted",children:"Packets will appear here"})]})}):v.map(e=>{const s=(e.payload_type_name||F(e.payload_type??e.type)).toLowerCase().includes("advert");return t.jsx(A,{packet:e,onClick:h,isFlashing:s&&u===e.packet_hash},e.packet_hash)})})]})})}),t.jsx("div",{className:"sm:hidden flex-1 overflow-y-auto divide-y divide-border-subtle/30",children:o&&0===e.length?t.jsx("div",{className:"p-8 text-center text-text-muted",children:"Loading packets..."}):0===v.length?t.jsxs("div",{className:"p-8 text-center",children:[t.jsx(l,{className:"w-6 h-6 text-text-muted mx-auto mb-2"}),t.jsx("div",{className:"text-sm text-text-primary",children:"No packets received"}),t.jsx("div",{className:"text-xs text-text-muted",children:"Packets will appear here"})]}):v.map(e=>{const s=(e.payload_type_name||F(e.payload_type??e.type)).toLowerCase().includes("advert");return t.jsx(P,{packet:e,onClick:h,isFlashing:s&&u===e.packet_hash},e.packet_hash)})}),t.jsxs("div",{className:"px-3 py-1.5 border-t border-border-subtle/50 text-[10px] text-text-muted bg-bg-elevated/20 text-center",children:["Showing ",v.length," of ",e.length," packets"]}),m&&t.jsx(T,{packet:m,onClose:()=>h(null)})]})}j.memo(function({active:e,payload:s,label:a,formatValue:n,labelKey:r}){var l;if(!e||!s||0===s.length)return null;const i=r&&(null==(l=s[0])?void 0:l.payload)?s[0].payload[r]:a;return t.jsxs("div",{className:"bg-black/90 backdrop-blur-sm border border-white/10 rounded-lg px-4 py-3 shadow-xl",children:[i&&t.jsx("p",{className:"type-data-xs text-white/50 mb-2",children:i}),t.jsx("div",{className:"space-y-1.5",children:s.map((e,s)=>t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("span",{className:"w-2 h-2 rounded-full flex-shrink-0",style:{backgroundColor:e.color}}),t.jsx("span",{className:"type-body-sm text-white/70 capitalize min-w-[60px]",children:e.name}),t.jsx("span",{className:"type-data-sm text-white tabular-nums",children:n?n(e.value,e.name):e.value.toLocaleString()})]},s))})]})});const ve=j.memo(function({active:e,payload:s,color:a,labelKey:n,unit:r=""}){var l,i;if(!e||!s||0===s.length)return null;const o=s[0],c=null==(l=null==o?void 0:o.payload)?void 0:l[n];return t.jsxs("div",{className:"bg-black/90 backdrop-blur-sm border border-white/10 rounded-lg px-3 py-2 shadow-xl",children:[t.jsx("p",{className:"type-data-xs text-white/50 mb-1",children:c}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("span",{className:"w-2 h-2 rounded-full",style:{backgroundColor:a}}),t.jsxs("span",{className:"type-data-sm text-white tabular-nums",children:[null==(i=null==o?void 0:o.value)?void 0:i.toLocaleString(),r]})]})]})});j.memo(function({payload:e}){return e&&0!==e.length?t.jsx("div",{className:"flex items-center justify-center gap-6 mt-4 pt-4 border-t border-white/5",children:e.map((e,s)=>t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("span",{className:"w-2 h-2 rounded-full",style:{backgroundColor:e.color}}),t.jsx("span",{className:"type-body-sm text-white/60 capitalize",children:e.value})]},s))}):null});const ge=.2;function fe(e,t=1){return Math.floor(5*t*e)}function je(e){const t=Math.round(e/ge)*ge;return Math.max(0,Math.min(5,t))}function be({stats:e,receivedBuckets:s,droppedBuckets:a,forwardedBuckets:n,bucketDurationSeconds:r,timeRangeLabel:l}){var i,o,c,d;const u=j.useMemo(()=>function(e,t,s,a,n){var r,l;const i=(null==t?void 0:t.reduce((e,t)=>e+t.count,0))??0,o=(null==s?void 0:s.reduce((e,t)=>e+t.count,0))??0,c=(null==a?void 0:a.reduce((e,t)=>e+t.count,0))??0,d=i>0?i:(null==e?void 0:e.rx_count)||1,u=o>0?o:(null==e?void 0:e.dropped_count)||0,x=d>0?u/(d+u)*100:0;let m=0;if(a&&a.length>0&&n)m=100*c/(a.length*n*1e3)*100;else if(e){const t=1e3*(e.uptime_seconds||1);m=(e.total_airtime_ms||e.airtime_used_ms||0)/t*100}const h=(null==e?void 0:e.neighbors)||{},p=Object.values(h).filter(e=>!0===e.zero_hop).length;let v=1;x<3?v-=ge:x>15?v+=.4:x>10&&(v+=ge),m>5&&(v+=ge),p>10&&(v+=ge);const g=je(v),f=je(.28*g),j=fe(g),b=fe(f),y=fe((null==(l=null==(r=null==e?void 0:e.config)?void 0:r.delays)?void 0:l.tx_delay_factor)??1);let k;return k=j>y?"increase":j<y?"decrease":"stable",{floodFactor:g,directFactor:f,floodSlots:j,directSlots:b,adjustment:k,duplicateRate:Math.round(100*x)/100,txUtilization:Math.round(1e3*m)/1e3,zeroHopCount:p,totalReceived:i,totalDropped:o}}(e,s,a,n,r),[e,s,a,n,r]),x=(null==(o=null==(i=null==e?void 0:e.config)?void 0:i.delays)?void 0:o.tx_delay_factor)??null,m=(null==(d=null==(c=null==e?void 0:e.config)?void 0:c.delays)?void 0:d.direct_tx_delay_factor)??null,h=null!==x?fe(x):null,p=null!==h&&u.floodSlots!==h,v="increase"===u.adjustment?$:"decrease"===u.adjustment?W:q;return t.jsxs("div",{className:"data-card flex flex-col min-h-[180px]",children:[t.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[t.jsx(ae,{className:"w-4 h-4 text-[var(--metric-transmitted)]"}),t.jsx("span",{className:"data-card-title",children:"TX DELAY FACTOR"}),l&&t.jsx("span",{className:"pill-tag",children:l}),p&&t.jsxs("span",{className:"pill-tag flex items-center gap-1 "+("increase"===u.adjustment?"bg-accent-warning/20 text-accent-warning border-accent-warning/30":"bg-accent-success/20 text-accent-success border-accent-success/30"),children:[t.jsx(v,{className:"w-3 h-3"}),"increase"===u.adjustment?"+":"-",Math.abs(u.floodSlots-(h??0))," slot",1!==Math.abs(u.floodSlots-(h??0))?"s":""]})]}),t.jsxs("div",{className:"flex items-baseline gap-4",children:[t.jsxs("div",{children:[t.jsxs("div",{className:"type-data-lg tabular-nums text-[var(--metric-transmitted)]",children:["×",u.floodFactor.toFixed(1)]}),t.jsxs("div",{className:"type-data-xs text-text-muted",children:["flood ",t.jsxs("span",{className:"text-accent-secondary font-semibold",children:["(",u.floodSlots," slots)"]})]})]}),t.jsxs("div",{children:[t.jsxs("div",{className:"type-data-lg tabular-nums text-[var(--metric-forwarded)]",children:["×",u.directFactor.toFixed(1)]}),t.jsxs("div",{className:"type-data-xs text-text-muted",children:["direct ",t.jsxs("span",{className:"text-accent-secondary font-semibold",children:["(",u.directSlots," slots)"]})]})]})]}),t.jsxs("div",{className:"flex-1 mt-4 space-y-1.5",children:[t.jsxs("div",{className:"flex justify-between text-xs",children:[t.jsx("span",{className:"text-text-muted",children:"Dup Rate"}),t.jsxs("span",{className:"tabular-nums "+(u.duplicateRate>10?"text-accent-warning":"text-text-secondary"),children:[u.duplicateRate.toFixed(1),"%"]})]}),t.jsxs("div",{className:"flex justify-between text-xs",children:[t.jsx("span",{className:"text-text-muted",children:"TX Util"}),t.jsxs("span",{className:"tabular-nums text-text-secondary",children:[u.txUtilization.toFixed(2),"%"]})]}),t.jsxs("div",{className:"flex justify-between text-xs",children:[t.jsx("span",{className:"text-text-muted",children:"Zero-hop"}),t.jsx("span",{className:"tabular-nums text-text-secondary",children:u.zeroHopCount})]})]}),t.jsx("div",{className:"data-card-secondary border-t border-border-subtle pt-3 mt-2",children:null!==x?t.jsxs("span",{children:["Current: ×",x.toFixed(1)," (",h," slots) / ×",(null==m?void 0:m.toFixed(1))??"—"]}):t.jsx("span",{children:"Recommended factors (MeshCore slot-aligned)"})})]})}function ye({trend:e}){return"stable"===e?t.jsx("span",{className:"mini-widget-trend stable",children:t.jsx("svg",{className:"w-3 h-3",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 12h14"})})}):"up"===e?t.jsx("span",{className:"mini-widget-trend up",children:t.jsx("svg",{className:"w-3 h-3",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 15l7-7 7 7"})})}):t.jsx("span",{className:"mini-widget-trend down",children:t.jsx("svg",{className:"w-3 h-3",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})})}function ke(){return t.jsx("div",{className:"mini-widget-loading",children:t.jsx("div",{className:"mini-widget-loading-spinner"})})}function Ne({message:e}){return t.jsx("div",{className:"mini-widget-error",children:t.jsx("span",{title:e,children:"No data"})})}function we({title:e,icon:s,value:a,unit:n,valueSize:r="md",status:l,subtitle:i,trend:o,children:c,isLoading:d=!1,error:u,className:x="",onClick:m}){const h=["mini-widget-value","lg"===r&&"mini-widget-value-lg","sm"===r&&"mini-widget-value-sm",""].filter(Boolean).join(" "),p=["mini-widget glass-card",m&&"cursor-pointer",x].filter(Boolean).join(" ");return t.jsxs("div",{className:p,onClick:m,role:m?"button":void 0,children:[t.jsxs("div",{className:"mini-widget-header",children:[s,t.jsx("span",{className:"mini-widget-title",children:e}),l&&"unknown"!==l&&t.jsx("div",{className:`mini-widget-status-dot ${l}`}),o&&t.jsx(ye,{trend:o})]}),d?t.jsx(ke,{}):u?t.jsx(Ne,{message:u}):t.jsxs(t.Fragment,{children:[void 0!==a&&t.jsxs("div",{className:h,children:[a,n&&t.jsx("span",{className:"mini-widget-unit",children:n})]}),i&&t.jsx("div",{className:"mini-widget-subtitle",children:i}),c]})]})}const Me=j.createContext({lbtStats:null,noiseFloor:null,linkQuality:null,channelHealth:null,trends:null,stats:null,recentPackets:[],quickNeighbors:[],isLoading:!0,error:null,refresh:async()=>{}});function Le(e){if(!e)return[];try{const t=JSON.parse(e);if(Array.isArray(t))return t.map(Number).filter(e=>!isNaN(e))}catch{}return[]}function _e(e,t,s=2,a=!1){if(null===t)return"stable";const n=e-t;return(0!==t?100*Math.abs(n/t):Math.abs(n))<s?"stable":a?n>0?"up":"down":n>0?"down":"up"}function Ce({children:e}){const a=o(),n=s(),r=c(),l=null===a,i=j.useMemo(()=>function(e){const t=Math.floor(Date.now()/1e3),s=t-86400,a=e.filter(e=>e.timestamp>=s&&void 0!==e.lbt_attempts&&e.lbt_attempts>0),n=a.length,r=a.filter(e=>(e.lbt_attempts??0)>1).length,l=n>0?r/n*100:0,i=a.filter(e=>(e.lbt_attempts??0)>1),o=i.length>0?i.reduce((e,t)=>e+(t.lbt_attempts??0),0)/i.length:0,c=a.filter(e=>!0===e.lbt_channel_busy||1===e.lbt_channel_busy).length,d=n>0?c/n*100:0,u=[];for(const v of a){const e=Le(v.lbt_backoff_delays_ms);u.push(...e)}const x=u.reduce((e,t)=>e+t,0),m=u.length>0?x/u.length:0,h=u.length>0?Math.max(...u):0,p=[];for(let v=0;v<24;v++){const e=t-3600*(24-v),s=e+3600,n=a.filter(t=>t.timestamp>=e&&t.timestamp<s),r=n.filter(e=>(e.lbt_attempts??0)>1).length,l=n.length>0?r/n.length*100:0;p.push(l)}return{totalPacketsWithLBT:n,packetsWithRetries:r,retryRate:l,avgRetries:o,channelBusyCount:c,channelBusyRate:d,avgBackoffMs:m,maxBackoffMs:h,totalBackoffMs:x,hourlyRetryRates:p,windowHours:24,packetCount:e.length}}(n),[n]),d=(null==a?void 0:a.noise_floor_dbm)??null,u=null==a?void 0:a.neighbors,x=j.useMemo(()=>u??{},[u]),m=j.useMemo(()=>function(e,t){if(0===e.length)return{neighbors:[],networkScore:0,neighborCount:0,bestLink:null,worstLink:null};const s=e.map(e=>{const s=function(e,t){let s=50;void 0!==e&&(s=e>=10?100:e>=5?80:e>=0?60:e>=-5?40:20);let a=50;return void 0!==t&&(a=t>=-70?100:t>=-80?80:t>=-90?60:t>=-100?40:20),Math.round(.6*s+.4*a)}(e.avgSnr??void 0,e.avgRssi??void 0),a=t[e.hash];return{name:(null==a?void 0:a.name)||(null==a?void 0:a.node_name)||e.prefix,hash:e.hash,rssi:e.avgRssi??-100,snr:e.avgSnr??-10,score:s,advertCount:e.count}});s.sort((e,t)=>t.score-e.score);const a=s.length>0?s.reduce((e,t)=>e+t.score,0)/s.length:0;return{neighbors:s,networkScore:Math.round(a),neighborCount:s.length,bestLink:s.length>0?{name:s[0].name,score:s[0].score}:null,worstLink:s.length>0?{name:s[s.length-1].name,score:s[s.length-1].score}:null}}(r,x),[r,x]),h=j.useMemo(()=>function(e,t,s){const a=e?Math.max(0,Math.min(100,100-5*e.retryRate)):50;let n=50;null!==t&&(n=Math.max(0,Math.min(100,(t+120)/30*100)));const r=(null==s?void 0:s.networkScore)??50,l=Math.round(.35*a+.25*n+.4*r);let i;return i=l>=85?"excellent":l>=70?"good":l>=50?"fair":l>=30?"congested":"critical",{score:l,status:i,components:{lbtHealth:Math.round(a),noiseHealth:Math.round(n),linkHealth:Math.round(r)}}}(i,d,m),[i,d,m]),[p,v]=j.useState({noiseFloor:null,networkScore:null,channelHealth:null}),g=j.useRef(0);j.useEffect(()=>{const e=()=>{const e=Date.now();e-g.current>3e4&&(g.current=e,v({noiseFloor:d,networkScore:(null==m?void 0:m.networkScore)??null,channelHealth:(null==h?void 0:h.score)??null}))};e();const t=setInterval(e,5e3);return()=>clearInterval(t)},[d,null==m?void 0:m.networkScore,null==h?void 0:h.score]);const f=j.useMemo(()=>({noiseFloor:{current:d,previous:p.noiseFloor,trend:null!==d?_e(d,p.noiseFloor,2,!0):"stable"},networkScore:{current:(null==m?void 0:m.networkScore)??0,previous:p.networkScore,trend:_e((null==m?void 0:m.networkScore)??0,p.networkScore,3,!1)},channelHealth:{current:(null==h?void 0:h.score)??0,previous:p.channelHealth,trend:_e((null==h?void 0:h.score)??0,p.channelHealth,3,!1)}}),[d,null==m?void 0:m.networkScore,null==h?void 0:h.score,p]),b={lbtStats:i,noiseFloor:d,linkQuality:m,channelHealth:h,trends:f,stats:a,recentPackets:n,quickNeighbors:r,isLoading:l,error:null,refresh:async()=>{}};return t.jsx(Me.Provider,{value:b,children:e})}function Se(){const e=j.useContext(Me);if(void 0===e)throw new Error("useLBTData must be used within an LBTDataProvider");return e}const Be={excellent:"var(--signal-excellent)",good:"var(--signal-good)",fair:"var(--signal-fair)",congested:"var(--signal-poor)",critical:"var(--signal-critical)",unknown:"var(--text-muted)"};function Fe(){const{lbtStats:e,isLoading:s,error:a}=Se(),n=d(),r=(null==e?void 0:e.retryRate)??0,l=(null==e?void 0:e.avgBackoffMs)??0,i=e?(o=r)<2?"excellent":o<5?"good":o<10?"fair":o<20?"congested":"critical":"unknown";var o;const c=null==e?void 0:e.hourlyRetryRates,u=j.useMemo(()=>!c||c.length<2?[]:c.map(e=>({value:e})),[c]),x=Be[i];return t.jsx(we,{title:"LBT Retries",icon:t.jsx(ee,{className:"mini-widget-icon"}),value:r.toFixed(1),unit:"%",status:i,subtitle:e?`Avg ${Math.round(l)}ms backoff`:void 0,isLoading:s,error:a,onClick:()=>n("/packets"),children:t.jsx("div",{className:"mini-widget-sparkline",children:u.length>0?t.jsx(b,{width:"100%",height:"100%",children:t.jsx(y,{data:u,margin:{top:2,right:2,bottom:2,left:2},children:t.jsx(k,{type:"monotone",dataKey:"value",stroke:x,strokeWidth:1,dot:!1,isAnimationActive:!1})})}):t.jsx("div",{className:"h-full"})})})}function Re(){const{lbtStats:e,isLoading:s,error:a}=Se(),n=d(),r=(null==e?void 0:e.channelBusyCount)??0,l=(null==e?void 0:e.totalPacketsWithLBT)??0,i=(null==e?void 0:e.channelBusyRate)??0,o=e?(c=i)<.5?"excellent":c<1?"good":c<2?"fair":c<5?"congested":"critical":"unknown";var c;return t.jsx(we,{title:"Ch. Busy",icon:t.jsx(Z,{className:"mini-widget-icon"}),value:r,status:o,subtitle:e?`${i.toFixed(2)}% of ${l} TX`:void 0,isLoading:s,error:a,onClick:()=>n("/packets")})}function Ae(e){return null===e?"No reading":e<-115?"Very quiet":e<-105?"Quiet":e<-95?"Moderate":e<-85?"Elevated":"High interference"}function Pe(){const{noiseFloor:e,trends:s,isLoading:a,error:n}=Se(),r=null===(l=e)||l<-110?"excellent":l<-100?"good":l<-90?"fair":l<-80?"congested":"critical";var l;const i=null==s?void 0:s.noiseFloor.trend;return t.jsx(we,{title:"Noise Floor",icon:t.jsx(J,{className:"mini-widget-icon"}),value:null!==e?Math.round(e):"—",unit:null!==e?"dBm":void 0,status:r,trend:i,subtitle:Ae(e),isLoading:a,error:n})}function Te(){const{linkQuality:e,trends:s,isLoading:a,error:n}=Se(),r=d(),l=(null==e?void 0:e.networkScore)??0,i=(null==e?void 0:e.neighborCount)??0,o=e?(c=l)>=80?"excellent":c>=60?"good":c>=40?"fair":c>=20?"congested":"critical":"unknown";var c;const u=null==s?void 0:s.networkScore.trend;return t.jsx(we,{title:"Network Score",icon:t.jsx(z,{className:"mini-widget-icon"}),value:Math.round(l),unit:"/100",status:o,trend:u,subtitle:e?`${i} direct neighbor${1!==i?"s":""}`:void 0,isLoading:a,error:n,onClick:()=>r("/contacts")})}function He(e,t=8){return e.length<=t?e:e.substring(0,t-1)+"…"}function De(){const{linkQuality:e,isLoading:s,error:a}=Se(),n=d(),r=null==e?void 0:e.bestLink,l=null==e?void 0:e.worstLink,i=l?(o=l.score)>=60?"excellent":o>=40?"good":o>=25?"fair":o>=10?"congested":"critical":"unknown";var o;const c=e&&r&&l?t.jsxs("div",{className:"flex flex-col gap-0.5 mt-auto",children:[t.jsxs("div",{className:"flex items-center justify-between text-xs",children:[t.jsx("span",{className:"text-text-muted",children:"Best:"}),t.jsxs("span",{className:"font-mono text-signal-excellent",children:[He(r.name)," (",Math.round(r.score),")"]})]}),t.jsxs("div",{className:"flex items-center justify-between text-xs",children:[t.jsx("span",{className:"text-text-muted",children:"Worst:"}),t.jsxs("span",{className:"font-mono "+(l.score>=40?"text-signal-fair":"text-signal-critical"),children:[He(l.name)," (",Math.round(l.score),")"]})]})]}):e&&0===e.neighborCount?t.jsx("div",{className:"flex items-center justify-center text-xs text-text-muted mt-auto",children:"No direct neighbors"}):null;return t.jsx(we,{title:"Link Range",icon:t.jsx(te,{className:"mini-widget-icon"}),status:i,isLoading:s,error:a,onClick:()=>n("/contacts"),children:c})}function Ee(){const{lbtStats:e,isLoading:s,error:a}=Se(),n=e?function(e){const{retryRate:t,channelBusyCount:s,totalPacketsWithLBT:a,avgBackoffMs:n,maxBackoffMs:r}=e;if(0===a)return 0;const l=Math.min(a/10,1),i=Math.log(1+.15*t)/Math.log(16)*40,o=s/a*100,c=Math.min(.5*o,25);let d=0;n>100&&(d=Math.min(8*Math.log10(n/100),15));let u=0;r>500&&n>0&&r>2*n&&(u=Math.min((r-500)/200,5));const x=(i+c+d+u)*l;return Math.min(x,85)}(e):0,r=e?(l=n)<5?"excellent":l<15?"good":l<30?"fair":l<50?"congested":"critical":"unknown";var l;const i=(null==e?void 0:e.maxBackoffMs)??0,o=e?i>200?`Max backoff: ${Math.round(i)}ms`:function(e){return e<5?"Clear channel":e<15?"Light traffic":e<30?"Moderate traffic":e<50?"Heavy traffic":e<70?"Congested":"Severe congestion"}(n):void 0;return t.jsx(we,{title:"Collision Risk",icon:t.jsx(G,{className:"mini-widget-icon"}),value:n.toFixed(1),unit:"%",status:r,subtitle:o,isLoading:s,error:a})}function $e(e){switch(e){case"excellent":return"Excellent";case"good":return"Good";case"fair":return"Fair";case"congested":return"Congested";case"critical":return"Critical";default:return"Unknown"}}function ze(){const{channelHealth:e,trends:s,isLoading:a,error:n}=Se(),r=(null==e?void 0:e.score)??0,l=(null==e?void 0:e.status)??"excellent",i=null==s?void 0:s.channelHealth.trend,o=e?t.jsx("div",{className:"mini-widget-progress mt-auto",children:t.jsx("div",{className:`mini-widget-progress-bar ${l}`,style:{width:`${r}%`}})}):null;return t.jsx(we,{title:"Channel Health",icon:t.jsx(Y,{className:"mini-widget-icon"}),value:Math.round(r),unit:"/100",status:l,trend:i,subtitle:e?$e(l):void 0,isLoading:a,error:n,children:o})}function We(){const[e,s]=j.useState(!1),[a]=j.useState(0),{stats:n,lbtStats:r,isLoading:i}=Se(),o=j.useMemo(()=>{if(!n)return null;const e=n.airtime_used_ms??0,t=n.max_airtime_ms??1;return{usedMs:e,maxMs:t,remainingMs:n.airtime_remaining_ms??0,utilizationPercent:n.utilization_percent??(t>0?e/t*100:0)}},[n]),c=j.useMemo(()=>{if(!r||0===r.totalPacketsWithLBT)return 100;const e=r.channelBusyCount,t=r.totalPacketsWithLBT;return(t-e)/t*100},[r]),d=(null==o?void 0:o.utilizationPercent)??0,u=(x=d)<30?"excellent":x<50?"good":x<70?"fair":x<90?"congested":"critical";var x;const m=(null==o?void 0:o.remainingMs)??0,h=c<99?`${c.toFixed(0)}% TX success`:((p=m)<1e3?`${Math.round(p)}ms`:p<6e4?`${(p/1e3).toFixed(1)}s`:`${(p/6e4).toFixed(1)}m`)+" remaining";var p;const v=o?t.jsx("div",{className:"mini-widget-progress mt-auto",children:t.jsx("div",{className:`mini-widget-progress-bar ${u}`,style:{width:`${Math.min(d,100)}%`}})}):null;return t.jsx(we,{title:"Duty Cycle",icon:t.jsx(l,{className:"mini-widget-icon"}),value:d.toFixed(1),unit:"%",status:u,subtitle:h,isLoading:i,children:v})}function qe({className:e=""}){return t.jsx(Ce,{children:t.jsxs("div",{className:`mesh-health-container ${e}`,children:[t.jsxs("div",{className:"mesh-health-header",children:[t.jsx(se,{className:"w-4 h-4 text-accent-primary"}),t.jsx("span",{className:"type-label text-text-muted",children:"MESH HEALTH"})]}),t.jsxs("div",{className:"widget-row",children:[t.jsx(ze,{}),t.jsx(Fe,{}),t.jsx(Re,{}),t.jsx(Ee,{}),t.jsx(Pe,{}),t.jsx(Te,{}),t.jsx(De,{}),t.jsx(We,{})]})]})})}function Ge(){var e;const s=o(),a=u(),n=x(),[r,i]=j.useState(0),[c,d]=j.useState(null),[y,k]=j.useState(!1),F=S(r,150),R=m[r],A=j.useMemo(()=>function(e,t){if(!e||0===e.length)return[];const s=t>1440;return e.map(e=>{const t=new Date(1e3*e.start);return{time:s?t.toLocaleDateString([],{weekday:"short",hour:"2-digit",minute:"2-digit",hour12:!1}):t.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hour12:!1}),received:e.count}})}(null==c?void 0:c.received,R.minutes),[null==c?void 0:c.received,R.minutes]),P=j.useMemo(()=>{const e=A.length;return e<=12?0:e<=24?2:e<=48?5:e<=72?8:Math.floor(e/7)},[A.length]),T=j.useCallback(async()=>{try{const e=m[F],t=await h(e.minutes,e.buckets);t.success&&t.data&&d(t.data)}catch{}},[F]);j.useEffect(()=>{const e=new AbortController,t=async()=>{await T()};t();const s=setInterval(()=>{t()},p.charts);return()=>{e.abort(),clearInterval(s)}},[T]),j.useEffect(()=>{if(n>0){const e=requestAnimationFrame(()=>k(!0)),t=setTimeout(()=>k(!1),600);return()=>{cancelAnimationFrame(e),clearTimeout(t)}}},[n]);const D=(null==s?void 0:s.uptime_seconds)?v(s.uptime_seconds):"0m",z=(null==s?void 0:s.node_name)||(null==(e=null==s?void 0:s.config)?void 0:e.node_name)||"Unknown Node",W=j.useMemo(()=>{var e,t,s,a;const n=(null==(e=null==c?void 0:c.received)?void 0:e.reduce((e,t)=>e+t.count,0))??0,r=(null==(t=null==c?void 0:c.forwarded)?void 0:t.reduce((e,t)=>e+t.count,0))??0,l=(null==(s=null==c?void 0:c.dropped)?void 0:s.reduce((e,t)=>e+t.count,0))??0,i=(null==(a=null==c?void 0:c.transmitted)?void 0:a.reduce((e,t)=>e+t.count,0))??0,o=((null==c?void 0:c.time_range_minutes)??R.minutes)/60;return{received:n,forwarded:r,dropped:l,transmitted:i,rxPerHour:o>0?Math.round(n/o):0,fwdPerHour:o>0?Math.round(r/o):0}},[c,R.minutes]);return a?t.jsxs(I,{className:"p-8 text-center",children:[t.jsx("p",{className:"type-subheading text-accent-red mb-2",children:"Failed to connect to backend"}),t.jsx("p",{className:"type-body text-white/50",children:a}),t.jsx("p",{className:"type-data-sm text-white/40 mt-4",children:"Make sure the Python backend is running on port 8000"})]}):t.jsxs(V,{children:[t.jsx(K,{title:z,icon:t.jsx(U,{}),controls:t.jsx(B,{ranges:m,selectedIndex:r,onSelect:i})}),t.jsx(Q,{template:"hero",children:t.jsxs(I,{className:"relative",children:[y&&t.jsx("div",{className:"flash-overlay"}),t.jsx(O,{icon:t.jsx($,{}),title:"RECEIVED",badge:R.label,iconColor:"text-accent-success"}),t.jsx("div",{className:"type-hero font-semibold",style:{color:g.received},children:W.received.toLocaleString()}),t.jsxs("div",{className:"type-body-sm text-text-muted mt-1",children:[W.rxPerHour,"/hr rate"]}),A.length>0?t.jsx("div",{className:"flex-1 mt-4 min-h-0",children:t.jsx(b,{width:"100%",height:"100%",children:t.jsxs(N,{data:A,children:[t.jsx("defs",{children:t.jsxs("linearGradient",{id:"gradient-received",x1:"0",y1:"0",x2:"0",y2:"1",children:[t.jsx("stop",{offset:"5%",stopColor:g.received,stopOpacity:.3}),t.jsx("stop",{offset:"95%",stopColor:g.received,stopOpacity:0})]})}),t.jsx(w,{strokeDasharray:"3 3",stroke:"rgba(255,255,255,0.06)",vertical:!1}),t.jsx(M,{dataKey:"time",axisLine:!1,tickLine:!1,tick:{fill:"rgba(255,255,255,0.4)",fontSize:10,fontFamily:"'JetBrains Mono', monospace"},dy:8,interval:P,minTickGap:20}),t.jsx(L,{axisLine:!1,tickLine:!1,tick:{fill:"rgba(255,255,255,0.4)",fontSize:10,fontFamily:"'JetBrains Mono', monospace"},dx:-8,width:40}),t.jsx(_,{content:t.jsx(ve,{color:g.received,labelKey:"time",unit:" packets"}),cursor:{stroke:"rgba(255,255,255,0.2)",strokeWidth:1}}),t.jsx(C,{type:"stepAfter",dataKey:"received",stroke:g.received,fill:"url(#gradient-received)",strokeWidth:1,dot:!1,activeDot:{r:4,strokeWidth:0,fill:g.received},isAnimationActive:!1})]})})}):t.jsx("div",{className:"flex-1 flex items-center justify-center text-text-muted",children:"No data available for this time range"})]})}),t.jsx(qe,{}),t.jsxs(Q,{template:"compact",children:[t.jsx(he,{title:"FORWARDED",value:W.forwarded,subtitle:`${W.fwdPerHour}/hr rate`,color:"forwarded",buckets:null==c?void 0:c.forwarded,timeRangeLabel:R.label,icon:t.jsx(X,{className:"w-4 h-4"})}),t.jsx(he,{title:"DROPPED",value:W.dropped,subtitle:"Filtered or duplicate",color:"dropped",buckets:null==c?void 0:c.dropped,timeRangeLabel:R.label,icon:t.jsx(H,{className:"w-4 h-4"})}),t.jsx(be,{stats:s,receivedBuckets:null==c?void 0:c.received,droppedBuckets:null==c?void 0:c.dropped,forwardedBuckets:null==c?void 0:c.forwarded,bucketDurationSeconds:null==c?void 0:c.bucket_duration_seconds,timeRangeLabel:R.label}),t.jsx(he,{title:"UPTIME",value:D,subtitle:"Since last restart",color:"neutral",icon:t.jsx(f,{className:"w-4 h-4"})})]}),t.jsx(pe,{}),s&&t.jsx(Q,{template:"auto",children:t.jsxs(I,{children:[t.jsx(O,{icon:t.jsx(l,{}),title:"Node Information",largeTitle:!0}),t.jsxs("div",{className:"grid grid-cols-2 lg:grid-cols-4 gap-4",children:[t.jsxs("div",{children:[t.jsx("span",{className:"type-label text-text-muted",children:"Node Name"}),t.jsx("p",{className:"type-body text-text-primary mt-1",children:z})]}),t.jsxs("div",{children:[t.jsx("span",{className:"type-label text-text-muted",children:"Version"}),t.jsxs("p",{className:"type-data text-text-primary mt-1",children:["v",s.version]})]}),t.jsxs("div",{children:[t.jsx("span",{className:"type-label text-text-muted",children:"Core Version"}),t.jsxs("p",{className:"type-data text-text-primary mt-1",children:["v",s.core_version]})]}),t.jsxs("div",{children:[t.jsx("span",{className:"type-label text-text-muted",children:"Local Hash"}),t.jsx("div",{className:"mt-1",children:s.local_hash?t.jsx(E,{hash:s.local_hash,size:"sm"}):t.jsx("span",{className:"type-data-sm text-text-muted",children:"N/A"})})]})]}),s.public_key&&t.jsxs("div",{className:"mt-4 pt-4 border-t border-border-subtle",children:[t.jsx("span",{className:"type-label text-text-muted",children:"Public Key"}),t.jsx("div",{className:"mt-1",children:t.jsx(E,{hash:s.public_key,prefixLength:12,suffixLength:8})})]})]})})]})}export{Ge as default};
