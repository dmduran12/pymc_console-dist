import{j as e,W as t,c as s,Z as a,M as n,r as l}from"./vendor-react-j_fHog8x.js";import{a as r,P as i,b as o,B as c}from"./PageLayout-BfBDoTq2.js";import{R as d,C as m}from"./Grid-OFJ4oe0a.js";import{c as x,b8 as u,R as p,V as h,bM as g,W as y,j as v,I as j,cL as f,B as N,an as b,X as k,k as w,cM as C,cN as S,cO as _,cP as M,cQ as T,cR as R,cS as A,cT as D,cU as E,q as L,cG as F,aE as I}from"./index-D2kasICP.js";import{L as P,a as $,b as z}from"./listbox-Dci8iZfN.js";import{P as O,T as K,C as q}from"./ConfirmModal-BQ5EKSgN.js";import{M as H}from"./map-pin-CYyh3ki4.js";import{S as U,K as B,r as G}from"./KeycapButton-KFhkdxCE.js";import{S as V,C as W,M as Q}from"./ChatBubble-BZMyptGE.js";import{C as X}from"./Card-CRBu83RM.js";import{e as Y,g as J,a as Z}from"./chat-utils-DUBGetrL.js";import{W as ee}from"./wifi-Ch0Y45nQ.js";import{K as te}from"./key-round-BXdWb403.js";import{C as se}from"./copy-B1mGiPO3.js";import{U as ae}from"./users-CBjarZrE.js";import"./maplibre-gl-b91ci4Kr.js";import"./vendor-core-CmkNwW1A.js";import"./triangle-alert-Dwx2ngba.js";import"./keycap-sfx-CAsrNe23.js";const ne=x("message-circle",[["path",{d:"M2.992 16.342a2 2 0 0 1 .094 1.167l-1.065 3.29a1 1 0 0 0 1.236 1.168l3.413-.998a2 2 0 0 1 1.099.092 10 10 0 1 0-4.777-4.719",key:"1sd12s"}]]),le=x("message-square-plus",[["path",{d:"M22 17a2 2 0 0 1-2 2H6.828a2 2 0 0 0-1.414.586l-2.202 2.202A.71.71 0 0 1 2 21.286V5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2z",key:"18887p"}],["path",{d:"M12 8v6",key:"1ib9pf"}],["path",{d:"M9 11h6",key:"1fldmi"}]]),re=x("repeat",[["path",{d:"m17 2 4 4-4 4",key:"nntrym"}],["path",{d:"M3 11v-1a4 4 0 0 1 4-4h14",key:"84bu3i"}],["path",{d:"m7 22-4-4 4-4",key:"1wqhfi"}],["path",{d:"M21 13v1a4 4 0 0 1-4 4H3",key:"1rx37r"}]]),ie=x("terminal",[["path",{d:"M12 19h8",key:"baeox8"}],["path",{d:"m4 17 6-6-6-6",key:"1yngyt"}]]),oe=x("user-x",[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["line",{x1:"17",x2:"22",y1:"8",y2:"13",key:"3nzzx3"}],["line",{x1:"22",x2:"17",y1:"8",y2:"13",key:"1swrse"}]]);function ce({disabled:a,className:n,children:l}){return e.jsx(t,{disabled:a,className:s("flex flex-col gap-2",n),children:l})}function de({required:t,className:n,children:l,...r}){return e.jsxs(a,{className:s("text-sm font-medium text-text-primary select-none","data-[disabled]:opacity-50",r.title&&"cursor-help",n),...r,children:[l,t&&e.jsx("span",{className:"text-accent-danger ml-0.5","aria-hidden":"true",children:"*"})]})}function me({className:t,children:a,...l}){return e.jsx(n,{className:s("text-sm text-text-muted","data-[disabled]:opacity-50",t),...l,children:a})}function xe({icon:t,title:a,description:n,onClick:l,accent:r}){return e.jsxs("button",{onClick:l,className:s("flex flex-col items-center gap-3 p-6 rounded-2xl text-center","ring-1 ring-border-subtle hover:ring-2 transition-all duration-150","w-full max-w-[260px]","primary"===r?"hover:ring-accent-primary hover:bg-accent-primary/5":"hover:ring-accent-secondary hover:bg-accent-secondary/5"),children:[e.jsx("div",{className:s("p-3 rounded-xl","primary"===r?"bg-accent-primary/10 text-accent-primary":"bg-accent-secondary/10 text-accent-secondary"),children:t}),e.jsx("p",{className:"type-body-sm font-medium text-text-primary",children:a}),e.jsx("p",{className:"type-data-xs text-text-muted leading-relaxed",children:n})]})}function ue({onCreateRoom:t}){return e.jsxs("div",{className:"flex flex-col items-center justify-center py-16 px-4",children:[e.jsx(u,{className:"w-12 h-12 text-text-muted opacity-30 mb-4"}),e.jsx("p",{className:"type-subheading text-text-secondary mb-1",children:"Add a Room Server"}),e.jsx("p",{className:"type-body-sm text-text-muted mb-8",children:"Choose how this device should operate."}),e.jsxs("div",{className:"flex flex-col sm:flex-row items-center gap-4",children:[e.jsx(xe,{icon:e.jsx(re,{className:"w-6 h-6"}),title:"Repeater + Room Server",description:"Keep forwarding packets and add group messaging.",onClick:()=>t("hybrid"),accent:"primary"}),e.jsx(xe,{icon:e.jsx(p,{className:"w-6 h-6"}),title:"Dedicated Room Server",description:"Stop repeating. Focus entirely on room server duties.",onClick:()=>t("dedicated"),accent:"secondary"})]})]})}function pe({rooms:t,selected:a,onSelect:n,onAdd:l}){const r=l?e.jsx("button",{onClick:l,className:s("flex items-center justify-center px-2 py-1 rounded-md","text-text-muted hover:text-text-primary hover:bg-bg-surface/60","transition-all duration-150"),title:"Add room server",children:e.jsx(O,{className:"w-4 h-4"})}):null;return t.length<=1?r:t.length<=3?e.jsxs("div",{className:"flex items-center gap-0.5 p-0.5 rounded-lg bg-subtle-fill",children:[t.map(t=>e.jsx("button",{onClick:()=>n(t.room_name),className:s("px-3 py-1 rounded-md text-sm font-medium transition-all duration-150",t.room_name===a?"bg-bg-surface text-text-primary shadow-sm":"text-text-muted hover:text-text-secondary"),children:t.room_name},t.room_name)),r]}):e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(P,{value:a??"",onChange:n,children:t.map(t=>e.jsx($,{value:t.room_name,children:e.jsx(z,{children:t.room_name})},t.room_name))}),r]})}function he({open:t,onClose:s,mode:a,identity:n,repeaterConfig:r,onCreate:i,onUpdate:o,onDelete:c,onSendAdvert:d}){var m,x,u,p,k,w,C,S,_;const M="edit"===a&&n,T=`${t}-${(null==n?void 0:n.name)??""}-${a}`,[R,A]=l.useState(""),[D,E]=l.useState(""),[L,F]=l.useState(!1),[I,P]=l.useState(""),[$,z]=l.useState(""),[O,q]=l.useState(""),[U,B]=l.useState(""),[G,V]=l.useState(!1),[W,Q]=l.useState(!1),[X,Y]=l.useState(!1),[J,Z]=l.useState(null),[ee,te]=l.useState(T);if(T!==ee)if(te(T),Z(null),V(!1),Q(!1),Y(!1),M)A((null==(m=n.settings)?void 0:m.node_name)??n.name),E(n.identity_key??""),F(!1),P((null==(x=n.settings)?void 0:x.admin_password)??""),z((null==(u=n.settings)?void 0:u.guest_password)??""),q((null==(k=null==(p=n.settings)?void 0:p.latitude)?void 0:k.toString())??""),B((null==(C=null==(w=n.settings)?void 0:w.longitude)?void 0:C.toString())??"");else{const e=r;A(""),E(""),F(!1),P(""),z(""),q(null!=(null==(S=null==e?void 0:e.repeater)?void 0:S.latitude)?e.repeater.latitude.toString():""),B(null!=(null==(_=null==e?void 0:e.repeater)?void 0:_.longitude)?e.repeater.longitude.toString():"")}const se=l.useCallback(()=>{const e={};return R&&(e.node_name=R),I&&(e.admin_password=I),$&&(e.guest_password=$),""!==O&&(e.latitude=parseFloat(O)),""!==U&&(e.longitude=parseFloat(U)),e},[R,I,$,O,U]),ae=l.useCallback(async()=>{if(!R.trim())return void Z("Room name is required");V(!0),Z(null);const e=M?n.name:function(e){if(!e)return"";const t=e.trim().toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-|-$/g,"");return t?`${t}-room`:""}(R);let t;if(M)t=await o({name:n.name,settings:se()});else{const s={name:e,type:"room_server",settings:se()};D.trim()&&(s.identity_key=D.trim()),t=await i(s)}V(!1),t?s():Z("Failed to save. Check that the name is unique and passwords differ.")},[R,M,n,se,i,o,s]),ne=l.useCallback(async()=>{if(!M)return;Q(!0);const e=await c(n.name);Q(!1),e&&s()},[M,n,c,s]),re=l.useCallback(async()=>{M&&(Y(!0),await d(n.name),Y(!1))},[M,n,d]);return e.jsxs(h,{open:t,onClose:s,size:"md",children:[e.jsx(g,{icon:M?void 0:e.jsx(le,{className:"w-5 h-5"}),title:M?"Edit Room Server":"Add Room Server",onClose:s}),e.jsx(y,{children:e.jsxs("div",{className:"space-y-5",children:[M&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(v,{color:n.registered?"green":"red",children:n.registered?"Active":"Inactive"}),n.identity_key&&e.jsxs("span",{className:"type-data-xs text-text-muted truncate",title:n.identity_key,children:["Key: ",n.identity_key.slice(0,16),"…"]})]}),e.jsxs(ce,{children:[e.jsx(de,{title:"What people see on the mesh",children:"Room Name"}),e.jsx(j,{value:R,onChange:e=>A(e.target.value),placeholder:"Room Name"})]}),!M&&e.jsxs(ce,{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(de,{title:"The unique hex public ID",children:["Identity Key ",e.jsx("span",{className:"text-text-muted font-normal",children:"(Optional)"})]}),e.jsx("button",{type:"button",onClick:()=>F(e=>!e),className:"type-data-xs text-text-muted underline hover:text-text-secondary",children:L?"Hide":"Show"})]}),L&&e.jsxs(e.Fragment,{children:[e.jsx(j,{value:D,onChange:e=>E(e.target.value),placeholder:"Leave empty to auto-generate"}),e.jsx(me,{children:"Leave empty to automatically generate a secure key"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs(ce,{children:[e.jsxs(de,{children:[e.jsx(H,{className:"inline w-3.5 h-3.5 -mt-0.5 mr-1 text-text-muted"}),"Latitude"]}),e.jsx(j,{type:"number",step:"any",value:O,onChange:e=>q(e.target.value),placeholder:"0"})]}),e.jsxs(ce,{children:[e.jsxs(de,{children:[e.jsx(H,{className:"inline w-3.5 h-3.5 -mt-0.5 mr-1 text-text-muted"}),"Longitude"]}),e.jsx(j,{type:"number",step:"any",value:U,onChange:e=>B(e.target.value),placeholder:"0"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs(ce,{children:[e.jsxs(de,{title:"Full access to room server",children:["Admin Password ",e.jsx("span",{className:"text-text-muted font-normal",children:"(Optional)"})]}),e.jsx(j,{type:"password",value:I,onChange:e=>P(e.target.value),placeholder:"None Set"})]}),e.jsxs(ce,{children:[e.jsxs(de,{title:"Can post and read, but not administer the room",children:["Guest Password ",e.jsx("span",{className:"text-text-muted font-normal",children:"(Optional)"})]}),e.jsx(j,{type:"password",value:$,onChange:e=>z(e.target.value),placeholder:"None Set"})]})]}),J&&e.jsx("p",{className:"type-data-xs text-accent-danger",children:J})]})}),e.jsxs(f,{children:[M&&e.jsxs("div",{className:"flex items-center gap-2 mr-auto",children:[e.jsxs(N,{color:"danger",plain:!0,onClick:ne,disabled:W,children:[e.jsx(K,{"data-slot":"icon"}),W?"Deleting…":"Delete"]}),e.jsxs(N,{color:"primary",plain:!0,onClick:re,disabled:X,children:[e.jsx(b,{"data-slot":"icon"}),X?"Sending…":"Send Advert"]})]}),e.jsx(N,{plain:!0,onClick:s,children:"Cancel"}),e.jsx(N,{color:"primary",onClick:ae,disabled:G,children:G?"Saving…":M?"Save Changes":"Create"})]})]})}const ge=l.createContext(null),ye="room-tui";function ve({children:t}){const[s,a]=l.useState(()=>"0"!==localStorage.getItem(ye)),n=l.useCallback(()=>{a(e=>{const t=!e;return localStorage.setItem(ye,t?"1":"0"),t})},[]);return e.jsx(ge.Provider,{value:{terminalMode:s,toggleTerminalMode:n},children:t})}function je(){const e=l.useContext(ge);if(!e)throw new Error("useTerminalMode must be used within RoomTerminalProvider");return e}const fe=e=>"server"===e.author_pubkey||"system"===e.author_pubkey;function Ne({messages:t,onDelete:s,terminalMode:a,serverName:n}){const r=l.useRef(null),[i,o]=l.useState(!1),c=l.useMemo(()=>[...t].sort((e,t)=>e.post_timestamp-t.post_timestamp),[t]);l.useEffect(()=>{!i&&r.current&&(r.current.scrollTop=0)},[c.length,i]);const d=l.useCallback(()=>{r.current&&o(r.current.scrollTop<-100)},[]),m=l.useCallback(()=>{r.current&&r.current.scrollTo({top:0,behavior:"smooth"}),o(!1)},[]);return 0===c.length?e.jsx("div",{className:"flex-1 flex flex-col items-center justify-center py-12 min-h-0"+(a?" font-mono":""),children:a?e.jsx("p",{className:"text-sm font-mono",style:{color:"var(--tui-accent)",opacity:.4},children:"> no messages in buffer_"}):e.jsxs(e.Fragment,{children:[e.jsx(u,{className:"w-10 h-10 text-text-muted opacity-20 mb-2"}),e.jsx("p",{className:"type-data-sm text-text-muted",children:"No messages yet"})]})}):a?e.jsxs("div",{className:"relative flex-1 min-h-0",children:[e.jsx("div",{ref:r,onScroll:d,className:"h-full overflow-y-auto scroll-smooth p-4 font-mono text-sm leading-relaxed flex flex-col-reverse",children:e.jsx("div",{children:c.map(t=>{const a=fe(t),l=new Date(1e3*t.post_timestamp).toLocaleTimeString(void 0,{hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}),r=a?"SYS":t.author_name||t.author_prefix,i=!a&&n&&r===n;return e.jsxs("div",{className:"group flex items-start gap-0 -mx-4 px-4 py-px",style:{"--tw-hover-bg":"var(--tui-hover-bg)"},onMouseEnter:e=>e.currentTarget.style.background="var(--tui-hover-bg)",onMouseLeave:e=>e.currentTarget.style.background="",children:[e.jsxs("span",{className:"select-none shrink-0",style:{color:"var(--tui-muted)"},children:["[",l,"]"]}),e.jsxs("span",{className:"mx-1.5 shrink-0",style:{color:i?"var(--tui-accent-local)":"var(--tui-accent)"},children:["<",r,">"]}),e.jsx("span",{style:{color:a?"var(--tui-system)":i?"var(--tui-body)":"var(--tui-accent)"},className:a?"italic":"",children:t.message_text}),e.jsx("button",{onClick:()=>s(t.id),className:"opacity-0 group-hover:opacity-100 ml-auto pl-2 shrink-0 transition-colors",style:{color:"var(--tui-muted)"},onMouseEnter:e=>e.currentTarget.style.color="var(--tui-danger)",onMouseLeave:e=>e.currentTarget.style.color="var(--tui-muted)",title:"Delete",children:"×"})]},t.id)})})}),i&&e.jsxs("button",{onClick:m,className:"absolute bottom-3 left-1/2 -translate-x-1/2 flex items-center gap-1.5 px-3 py-1 font-mono text-xs transition-colors duration-150",style:{background:"var(--tui-hover-bg)",border:"1px solid var(--tui-muted)",color:"var(--tui-accent)"},children:[e.jsx(k,{className:"w-3 h-3"}),"↓ scroll"]})]}):e.jsxs("div",{className:"relative flex-1 min-h-0",children:[e.jsx("div",{ref:r,onScroll:d,className:"h-full overflow-y-auto scroll-smooth flex flex-col-reverse",children:e.jsx("div",{className:"space-y-3 p-4",children:c.map(t=>fe(t)?e.jsx(V,{text:t.message_text},t.id):e.jsx(W,{senderName:t.author_name||t.author_prefix,text:t.message_text,timestamp:t.post_timestamp,bubbleAccessory:e.jsx("button",{onClick:()=>s(t.id),className:"opacity-0 group-hover:opacity-100 transition-opacity duration-150 p-1 text-text-muted hover:text-accent-danger flex-shrink-0",title:"Delete message",children:e.jsx(K,{className:"w-3.5 h-3.5"})})},t.id))})}),i&&e.jsxs("button",{onClick:m,className:"absolute bottom-3 left-1/2 -translate-x-1/2 flex items-center gap-1.5 px-3 py-1.5 rounded-full bg-bg-surface/90 backdrop-blur-sm ring-1 ring-border-subtle shadow-md text-text-secondary hover:text-text-primary transition-colors duration-150",children:[e.jsx(k,{className:"w-3.5 h-3.5"}),e.jsx("span",{className:"type-data-xs",children:"New messages"})]})]})}function be({roomName:t,onSend:s,disabled:a,terminalMode:n}){const[r,i]=l.useState(""),[o,c]=l.useState(!1),d=l.useRef(null),m=l.useCallback(async()=>{var e;const t=r.trim();if(!t||o)return;c(!0);const a=await s(t);c(!1),a&&(i(""),null==(e=d.current)||e.focus())},[r,o,s]),x=l.useCallback(e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),m())},[m]);return n?e.jsxs("div",{className:"flex items-center gap-0 px-4 py-2 type-data-sm",children:[e.jsx("input",{ref:d,type:"text",value:r,onChange:e=>i(e.target.value),onKeyDown:x,placeholder:"type message...",disabled:a||o,className:"flex-1 bg-transparent outline-none ring-0 shadow-none border-none focus:outline-none focus:ring-0 font-mono tui-input",style:{color:"var(--tui-body)"}}),e.jsx("button",{onClick:m,disabled:!r.trim()||o||a,className:"transition-colors duration-100 px-1 font-mono text-xs disabled:opacity-30",style:{color:"var(--tui-accent)"},title:"Send",children:"[↵]"})]}):e.jsxs("div",{className:"flex items-center gap-2 p-3 border-t border-border-subtle",children:[e.jsx("input",{ref:d,type:"text",value:r,onChange:e=>i(e.target.value),onKeyDown:x,placeholder:`Message ${t}…`,disabled:a||o,className:"flex-1 surface-input radius-inner px-3 py-2 type-body-sm text-text-primary placeholder:text-text-muted outline-none ring-focus"}),e.jsx("button",{onClick:m,disabled:!r.trim()||o||a,className:"p-2 rounded-lg text-accent-primary hover:bg-accent-primary/10 disabled:opacity-30 disabled:hover:bg-transparent transition-colors duration-150",title:"Send message",children:e.jsx(b,{className:"w-4.5 h-4.5"})})]})}function ke({selectedName:t,selectedIdentity:s,messages:a,onSend:n,onDelete:i,onClear:o}){var c;const{terminalMode:d,toggleTerminalMode:m}=je(),[x,u]=l.useState(!1),p=(null==(c=null==s?void 0:s.settings)?void 0:c.node_name)??t??void 0,h=l.useCallback(()=>{u(!1),o()},[o]);return d?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex flex-col h-full gap-1.5",children:[e.jsxs("div",{className:"card-terminal-header flex-shrink-0",children:[e.jsx("span",{className:"seven-seg-panel",children:e.jsx(U,{text:"chat",minChars:7,size:24})}),e.jsx("div",{className:"card-terminal-ridge flex-1"}),e.jsxs("div",{className:"header-well",children:[e.jsx(B,{icon:e.jsx(ie,{className:"!w-5.5 !h-5.5 translate-y-px"}),onClick:m,title:"Exit terminal mode"}),a.length>0&&e.jsx(B,{icon:e.jsx("span",{className:"text-[13px] font-bold font-mono leading-none translate-y-px",children:"DEL"}),onClick:()=>u(!0),title:"Clear all messages",variant:"red",iconActiveColor:"#E5484D"})]})]}),e.jsx(r,{noPadding:!0,className:"flex flex-col flex-1 min-h-0 overflow-hidden card-terminal",children:e.jsxs("div",{className:"card-terminal-well flex-1 min-h-0 flex flex-col overflow-hidden",children:[e.jsx(Ne,{messages:a,onDelete:i,terminalMode:!0,serverName:p}),e.jsx("div",{className:"card-terminal-divider"}),t&&e.jsx(be,{roomName:t,onSend:n,disabled:!(null==s?void 0:s.registered),terminalMode:!0})]})})]}),e.jsx(q,{isOpen:x,title:"Clear All Messages",message:`This will permanently delete all ${a.length} message${1===a.length?"":"s"} from this room. This cannot be undone.`,confirmLabel:"Clear Messages",variant:"danger",onConfirm:h,onCancel:()=>u(!1)})]}):e.jsxs(e.Fragment,{children:[e.jsxs(r,{noPadding:!0,className:"flex flex-col h-full overflow-hidden",children:[e.jsx(X,{listHeader:!0,icon:e.jsx(ne,{className:"icon-sm"}),title:"Messages",actions:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(N,{plain:!0,onClick:m,title:"Terminal mode",children:e.jsx(ie,{"data-slot":"icon",className:"!w-5 !h-5 translate-y-px"})}),a.length>0&&e.jsx(N,{plain:!0,onClick:()=>u(!0),title:"Clear all messages",children:e.jsx("span",{"data-slot":"icon",className:"text-[12px] font-bold font-mono leading-none translate-y-px text-red-400",children:"DEL"})})]})}),e.jsx(Ne,{messages:a,onDelete:i,terminalMode:!1,serverName:p}),t&&e.jsx(be,{roomName:t,onSend:n,disabled:!(null==s?void 0:s.registered),terminalMode:!1})]}),e.jsx(q,{isOpen:x,title:"Clear All Messages",message:`This will permanently delete all ${a.length} message${1===a.length?"":"s"} from this room. This cannot be undone.`,confirmLabel:"Clear Messages",variant:"danger",onConfirm:h,onCancel:()=>u(!1)})]})}function we({pubkey:t,className:s}){const[a,n]=l.useState(!1),r=l.useCallback(()=>{navigator.clipboard.writeText(t),n(!0),setTimeout(()=>n(!1),1500)},[t]);return e.jsxs("button",{onClick:r,title:a?"Copied!":"Copy public key",className:`inline-flex items-center gap-1 type-data-xs leading-tight text-text-muted hover:text-text-secondary transition-colors duration-150 cursor-copy ${s??""}`,children:[e.jsx("span",{className:"truncate min-w-0",children:t.slice(0,8)}),a&&e.jsx(w,{className:"w-2.5 h-2.5 text-accent-success flex-shrink-0"})]})}const Ce=l.memo(function({client:t,resolvedName:a,onRemove:n}){const l=t.name||a,r=0===t.unsynced_count,i=t.last_activity?new Date(1e3*t.last_activity).toLocaleString(void 0,{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}):"Never",{emoji:o,cleanName:c}=l?Y(l):{emoji:null,cleanName:t.pubkey_prefix},d=l?J(c):void 0,m=l?Z(l):t.pubkey_prefix.slice(0,2).toUpperCase();return e.jsxs("div",{className:"group flex items-center gap-3 px-3 py-2.5 radius-inner row-hover transition-base",children:[e.jsxs("div",{className:"relative flex-shrink-0",children:[e.jsx("div",{className:s("w-8 h-8 rounded-full flex items-center justify-center",!d&&"bg-accent-primary/12"),style:d?{backgroundColor:d}:void 0,children:o?e.jsx("span",{className:"text-base leading-none",children:o}):e.jsx("span",{className:s("leading-none",d?"text-white text-[11px] font-bold tracking-tight":"text-accent-primary font-mono text-[11px]"),children:m})}),e.jsx("span",{className:"absolute -bottom-0.5 -right-0.5 w-2.5 h-2.5 rounded-sm ring-2 ring-bg-surface "+(r?"bg-accent-success":"bg-accent-secondary")})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[l?e.jsx("p",{className:"text-[13px] font-medium leading-tight text-text-primary truncate",children:l}):e.jsx("p",{className:"font-mono text-[13px] leading-tight text-text-primary truncate",children:t.pubkey_prefix}),e.jsxs("div",{className:"flex items-center gap-1.5 mt-0.5",children:[l&&e.jsx(we,{pubkey:t.pubkey}),l&&e.jsx("span",{className:"text-xs text-text-muted/40",children:"·"}),e.jsxs("span",{className:"text-xs leading-tight text-text-muted truncate",children:[!r&&e.jsxs("span",{className:"text-accent-secondary",children:[t.unsynced_count," unsynced · "]}),i]})]})]}),e.jsx("button",{onClick:()=>n(t.pubkey),className:"opacity-0 group-hover:opacity-100 transition-opacity duration-150 p-1.5 -mr-1 rounded-md text-text-muted hover:text-accent-danger hover:bg-accent-danger/8",title:"Remove client",children:e.jsx(oe,{className:"w-3.5 h-3.5"})})]})});function Se({clients:t,onRemove:s,messages:a,terminalMode:n}){const r=l.useMemo(()=>{const e=new Map;if(!a)return e;for(let t=a.length-1;t>=0;t--){const s=a[t];s.author_name&&s.author_pubkey&&"server"!==s.author_pubkey&&"system"!==s.author_pubkey&&e.set(s.author_pubkey,s.author_name)}return e},[a]);return 0===t.length?n?e.jsx("p",{className:"type-data-sm text-left px-4 py-4",style:{color:"var(--tui-accent)"},children:"< NO CLIENTS CONNECTED >"}):e.jsx("p",{className:"type-data-xs text-text-muted text-center py-4",children:"No clients connected"}):n?e.jsx("div",{className:"type-data-sm pt-2",children:t.map(t=>{const a=t.name||r.get(t.pubkey),n=0===t.unsynced_count,l=t.pubkey_prefix;return e.jsxs("div",{className:"group flex items-center gap-0 -mx-0 px-4 py-0.5",onMouseEnter:e=>e.currentTarget.style.background="var(--tui-hover-bg)",onMouseLeave:e=>e.currentTarget.style.background="",children:[e.jsx("span",{style:{color:n?"var(--tui-accent)":"var(--tui-warn)"},children:"■"}),e.jsx("span",{className:"ml-2 shrink-0",style:{color:"var(--tui-accent)"},children:a||l}),a&&e.jsxs("span",{className:"ml-1.5 shrink-0",style:{color:"var(--tui-accent)"},children:["[",l,"]"]}),!n&&e.jsxs("span",{className:"ml-1.5",style:{color:"var(--tui-warn)"},children:[t.unsynced_count,"unsync"]}),e.jsx("button",{onClick:()=>s(t.pubkey),className:"opacity-0 group-hover:opacity-100 ml-auto pl-2 shrink-0 transition-colors",style:{color:"var(--tui-muted)"},onMouseEnter:e=>e.currentTarget.style.color="var(--tui-danger)",onMouseLeave:e=>e.currentTarget.style.color="var(--tui-muted)",title:"Remove",children:"×"})]},t.pubkey)})}):e.jsx("div",{className:"space-y-0.5 pt-1",children:t.map(t=>e.jsx(Ce,{client:t,resolvedName:r.get(t.pubkey),onRemove:s},t.pubkey))})}function _e({name:t,onSend:s}){const{terminalMode:a}=je(),[n,r]=l.useState("idle"),i=l.useRef(),o=l.useCallback(async()=>{if("sending"===n)return;r("sending");const e=await s(t);r(e?"sent":"idle"),e&&(i.current=setTimeout(()=>r("idle"),2e3))},[t,s,n]);return l.useEffect(()=>()=>clearTimeout(i.current),[]),a?e.jsxs("button",{className:"btn-terminal",onClick:o,disabled:"sending"===n,children:["idle"===n&&"[ send_advert ]","sending"===n&&"[ broadcasting... ]","sent"===n&&"[ sent ✓ ]"]}):e.jsxs(N,{color:"sent"===n?"success":"primary",className:"w-full",onClick:o,disabled:"sending"===n,children:[e.jsx(ee,{"data-slot":"icon"}),"idle"===n&&"Send Advert","sending"===n&&"Broadcasting…","sent"===n&&"Advert Sent"]})}function Me({identity:t,onSendAdvert:s}){var a,n,r,i,o,c,d,m,x,u,p,h,g,y,j,f,N,b,k,C,S,_,M,T,R,A,D,E,L,F;const{terminalMode:I}=je(),[P,$]=l.useState(!1),z=l.useCallback(()=>{(null==t?void 0:t.identity_key)&&(navigator.clipboard.writeText(t.identity_key),$(!0),setTimeout(()=>$(!1),1500))},[null==t?void 0:t.identity_key]);return I?t?e.jsxs("div",{className:"space-y-1",children:[(null==(a=t.settings)?void 0:a.node_name)&&e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{style:{color:"var(--tui-muted)"},children:"node"}),e.jsx("span",{style:{color:"var(--tui-accent)"},children:t.settings.node_name})]}),(t.address||(null==(n=t.runtime)?void 0:n.address))&&e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{style:{color:"var(--tui-muted)"},children:"addr"}),e.jsx("span",{style:{color:"var(--tui-accent)"},children:t.address||(null==(r=t.runtime)?void 0:r.address)})]}),t.identity_key&&e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{style:{color:"var(--tui-muted)"},children:"key"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"truncate max-w-[140px]",style:{color:"var(--tui-accent)"},title:t.identity_key,children:[t.identity_key.slice(0,16),"…"]}),e.jsx("button",{type:"button",onClick:z,className:"text-xs",style:{color:"var(--tui-muted)"},children:P?"[copied ✓]":"[copy]"})]})]}),(null!=(null==(i=t.settings)?void 0:i.latitude)||null!=(null==(o=t.settings)?void 0:o.longitude))&&e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{style:{color:"var(--tui-muted)"},children:"loc"}),e.jsxs("span",{style:{color:"var(--tui-accent)"},title:`${(null==(c=t.settings)?void 0:c.latitude)??"—"}, ${(null==(d=t.settings)?void 0:d.longitude)??"—"}`,children:[(null==(x=null==(m=t.settings)?void 0:m.latitude)?void 0:x.toFixed(4))??"—",", ",(null==(p=null==(u=t.settings)?void 0:u.longitude)?void 0:p.toFixed(4))??"—"]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{style:{color:"var(--tui-muted)"},children:"pass"}),e.jsxs("span",{className:"flex items-center gap-1.5",children:[e.jsx("span",{style:{color:(null==(h=t.settings)?void 0:h.admin_password)?"var(--tui-accent)":"var(--tui-muted)"},children:(null==(g=t.settings)?void 0:g.admin_password)?"[✓ admin]":"[— admin]"}),e.jsx("span",{style:{color:(null==(y=t.settings)?void 0:y.guest_password)?"var(--tui-accent)":"var(--tui-muted)"},children:(null==(j=t.settings)?void 0:j.guest_password)?"[✓ guest]":"[— guest]"})]})]})]}):e.jsx("span",{style:{color:"var(--tui-muted)"},children:"no identity configured"}):e.jsxs("div",{className:"flex-shrink-0 border-t border-border-subtle",children:[e.jsx(X,{listHeader:!0,icon:e.jsx(Q,{className:"icon-sm"}),title:"Room Info"}),t?e.jsxs("div",{className:"space-y-2 px-4 py-3",children:[(null==(f=t.settings)?void 0:f.node_name)&&e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"type-data-xs text-text-muted",children:"Node"}),e.jsx("span",{className:"type-data-sm text-text-primary",children:t.settings.node_name})]}),(t.address||(null==(N=t.runtime)?void 0:N.address))&&e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"type-data-xs text-text-muted",children:"Address"}),e.jsx("span",{className:"type-data-sm font-mono text-text-primary",children:t.address||(null==(b=t.runtime)?void 0:b.address)})]}),t.identity_key&&e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("span",{className:"type-data-xs text-text-muted flex items-center gap-1",title:"The unique hex public ID",children:[e.jsx(te,{className:"w-3 h-3"}),"Key"]}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsxs("span",{className:"type-data-sm font-mono text-text-primary truncate max-w-[140px]",title:t.identity_key,children:[t.identity_key.slice(0,16),"…"]}),e.jsx("button",{type:"button",onClick:z,className:"inline-flex items-center gap-0.5",children:e.jsx(v,{color:P?"green":"zinc",children:P?e.jsxs(e.Fragment,{children:[e.jsx(w,{className:"w-3 h-3"}),"Copied"]}):e.jsxs(e.Fragment,{children:[e.jsx(se,{className:"w-3 h-3"}),"Copy"]})})})]})]}),(null!=(null==(k=t.settings)?void 0:k.latitude)||null!=(null==(C=t.settings)?void 0:C.longitude))&&e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("span",{className:"type-data-xs text-text-muted flex items-center gap-1",children:[e.jsx(H,{className:"w-3 h-3"}),"Location"]}),e.jsxs("span",{className:"type-data-sm font-mono text-text-primary",title:`${(null==(S=t.settings)?void 0:S.latitude)??"—"}, ${(null==(_=t.settings)?void 0:_.longitude)??"—"}`,children:[(null==(T=null==(M=t.settings)?void 0:M.latitude)?void 0:T.toFixed(4))??"—",", ",(null==(A=null==(R=t.settings)?void 0:R.longitude)?void 0:A.toFixed(4))??"—"]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"type-data-xs text-text-muted",children:"Passwords"}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsxs(v,{color:(null==(D=t.settings)?void 0:D.admin_password)?"green":"zinc",children:[(null==(E=t.settings)?void 0:E.admin_password)&&e.jsx(w,{className:"w-3 h-3"}),"Admin"]}),e.jsxs(v,{color:(null==(L=t.settings)?void 0:L.guest_password)?"green":"zinc",children:[(null==(F=t.settings)?void 0:F.guest_password)&&e.jsx(w,{className:"w-3 h-3"}),"Guest"]})]})]}),e.jsx("div",{className:"pt-3",children:e.jsx(_e,{name:t.name,onSend:s})})]}):e.jsx("p",{className:"type-data-xs text-text-muted text-center py-3",children:"No identity configured"})]})}function Te({selectedIdentity:t,clients:s,messages:a,onSendAdvert:n}){const{terminalMode:i}=je(),o=l.useCallback(async e=>{C.setState(t=>({clients:t.clients.filter(t=>t.pubkey!==e)})),await G({public_key:e})},[]);return i?e.jsxs("div",{className:"flex flex-col h-full gap-1.5",children:[t&&e.jsx("div",{className:"card-terminal-header flex-shrink-0",children:e.jsx("div",{className:"header-well flex-1",children:e.jsx(B,{icon:e.jsx(ee,{}),onPress:()=>n(t.name),title:"Send room server advert",indicators:[{label:"ADVERTISE",trackPress:!0},{label:"ACTIVE",active:t.registered}]})})}),e.jsxs("div",{className:"flex flex-col flex-1 min-h-0 gap-1.5",children:[e.jsx("div",{className:"card-terminal-header flex-shrink-0",children:e.jsx("span",{className:"seven-seg-panel",children:e.jsx(U,{text:`OnLInE ${String(s.length).padStart(3,"0")}`,size:24})})}),e.jsx(r,{noPadding:!0,className:"!h-auto flex flex-col flex-1 min-h-0 overflow-hidden card-terminal",children:e.jsx("div",{className:"card-terminal-well flex-1 min-h-0 overflow-y-auto",children:e.jsx(Se,{clients:s,onRemove:o,messages:a,terminalMode:!0})})}),e.jsx("div",{className:"card-terminal-header flex-shrink-0",children:e.jsx("span",{className:"seven-seg-panel",children:e.jsx(U,{text:"StAtUS "+((null==t?void 0:t.registered)?"On":"OFF"),size:24})})}),e.jsx(r,{noPadding:!0,className:"!h-auto flex-shrink-0 overflow-hidden card-terminal",children:e.jsx("div",{className:"card-terminal-well px-4 py-3 type-data-sm",children:e.jsx(Me,{identity:t,onSendAdvert:n})})})]})]}):e.jsxs(r,{compact:!0,className:"flex-1 min-h-0 flex flex-col overflow-hidden",children:[e.jsx(X,{listHeader:!0,icon:e.jsx(ae,{className:"icon-sm"}),title:"Clients",actions:s.length>0?e.jsx("span",{className:"type-data-xs text-text-muted",children:s.length}):void 0}),e.jsx("div",{className:"flex-1 min-h-0 overflow-y-auto",children:e.jsx(Se,{clients:s,onRemove:o,messages:a,terminalMode:!1})}),e.jsx(Me,{identity:t,onSendAdvert:n})]})}function Re(){const t=S(),s=_(),a=M(),n=T(),r=R(),x=A(),p=D(),h=E(),g=L(),{selectRoom:y,postMessage:j,deleteMessage:f,clearMessages:b,createRoom:k,updateRoom:w,deleteRoom:P,sendAdvert:$,markAsRead:z,startActivePolling:O}=C.getState(),[K,q]=l.useState(!1),[H,U]=l.useState("create"),[B,G]=l.useState("hybrid");l.useEffect(()=>{z()},[s,z]),l.useEffect(()=>O(),[O]);const V=l.useCallback(async e=>!!s&&j({room_name:s,message:e,author_pubkey:"server"}),[s,j]),W=l.useCallback((e="hybrid")=>{G(e),U("create"),q(!0)},[]),Q=l.useCallback(()=>{U("edit"),q(!0)},[]),X=a?e.jsxs("span",{className:"type-data-sm text-text-muted",children:[a.total_messages," messages · ",a.total_clients," clients",n&&e.jsxs(e.Fragment,{children:[" · ",e.jsx(v,{color:n.registered?"green":"red",className:"ml-0.5",children:n.registered?"Active":"Inactive"})]})]}):void 0,Y=e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(pe,{rooms:t,selected:s,onSelect:y,onAdd:()=>W("hybrid")}),t.length>0&&e.jsx(N,{plain:!0,onClick:Q,title:"Manage room server",children:e.jsx(F,{"data-slot":"icon"})})]});return 0!==t.length||0!==p.length||h?e.jsx(ve,{children:e.jsxs(i,{children:[e.jsx(o,{title:"Room Server",icon:e.jsx(u,{}),subtitle:X,controls:Y}),e.jsx(c,{children:e.jsxs(d,{template:"hero-tall",className:"!h-[calc(100vh-11rem)] !min-h-[400px]",children:[e.jsx(m,{span:12,lg:8,className:"h-full",children:e.jsx(ke,{selectedName:s,selectedIdentity:n,messages:r,onSend:V,onDelete:f,onClear:b})}),e.jsx(m,{span:12,lg:4,className:"h-full",children:e.jsx(Te,{selectedIdentity:n,clients:x,messages:r,onSendAdvert:$})})]})}),e.jsx(he,{open:K,onClose:()=>q(!1),mode:H,identity:n,repeaterConfig:null==g?void 0:g.config,onCreate:k,onUpdate:w,onDelete:P,onSendAdvert:$})]})}):e.jsx(ve,{children:e.jsxs(i,{children:[e.jsx(o,{title:"Room Server",icon:e.jsx(u,{})}),e.jsx(ue,{onCreateRoom:e=>W(e)}),e.jsx(he,{open:K,onClose:()=>q(!1),mode:"create",repeaterConfig:null==g?void 0:g.config,onCreate:async e=>{const t=await k(e);return t&&"dedicated"===B&&(await I.getState().setMode("monitor"),I.getState().clearModeMutation()),t},onUpdate:w,onDelete:P,onSendAdvert:$})]})})}export{Re as default};
