const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-DhkG1Nx9.js","assets/index-DySMpv2s.css"])))=>i.map(i=>d[i]);
import{bL as ne,e as re,a7 as te,r as ce,et as ie,a2 as K,eq as Q,eu as de,_ as U}from"./index-DhkG1Nx9.js";import{c as le,m as j,i as E}from"./node-types-CgBRFpS8.js";function oe(e){if(!e||e.length<6)return null;const h=e,n=parseInt(h.slice(0,2),16);if(isNaN(n))return null;const a=n&3;let d=2;if((a===0||a===3)&&(d=10),d+2>h.length)return null;const t=parseInt(h.slice(d,d+2),16);if(isNaN(t)||(d+=2+t*2,d>=h.length))return null;const m=h.slice(d);return m.length>=38?m.slice(0,38):m}function W(e,h="name-only"){const n=e.decoded;if(!n||!n.decrypted)return null;if(n.macCorrupted)switch(h){case"strict":return null;case"name-only":return{senderName:n.senderName||null,channelName:n.channelName||null,channelHash:n.channelHash||null,text:null,corrupted:!0,decrypted:!0}}return{senderName:n.senderName||null,channelName:n.channelName||null,channelHash:n.channelHash||null,text:n.text||null,corrupted:!!n.macCorrupted,decrypted:!0}}function k(e,h){var d;const n=new Map,a=new Map;for(const t of e){const m=t.payload_type??t.type;if(m!==ne.GRP_TXT)continue;const _=h.get(t.packet_hash);if(!((d=_==null?void 0:_.decoded)!=null&&d.decrypted)||_.decoded.macCorrupted)continue;const i=t._payloadHexPrefix??oe(t.raw_packet);i&&!n.has(i)&&n.set(i,_);const y=t.payload_length??t.length??0,s=Math.floor((t.timestamp??0)/60),g=`${m}:${y}:${s}`;a.has(g)||a.set(g,_)}return{byPayload:n,byApprox:a}}function he(e,h,n,a="name-only"){const d=e.payload_type??e.type;if(d!==ne.GRP_TXT)return null;const t=h.get(e.packet_hash);if(t)return W(t,a);const m=e._payloadHexPrefix??oe(e.raw_packet),_=(m?n.byPayload.get(m):null)??n.byApprox.get(`${d}:${e.payload_length??e.length??0}:${Math.floor((e.timestamp??0)/60)}`);return _?W(_,a):null}function ue(e){return e.name||e.node_name||null}function M(e,h,n,a,d,t,m){return{hash:e,type:h,name:n,isRepeater:h==="repeater",isCompanion:h==="companion",confident:a,advertObservations:d,topologyNeighborCount:t,topologyAffinity:m}}const se=Object.freeze(M(null,"unknown",null,!1,0,0,0)),pe=5,fe={disambiguationEnabled:!0,recencyDecayHours:12,zeroHopDecayHours:72,confidenceThreshold:.6,macCorruptedPolicy:"name-only"};function ye(e){const h=new Map,n=new Map,a=new Map,d=new Map,t=new Map,m=new Map,_=new Map;for(const[s,g]of Object.entries(e)){const l=le(g).type;h.set(s,l);const f=(s.startsWith("0x")?s.slice(2):s).toLowerCase();n.set(f,s);const T=K(s),H=ue(g);let b=a.get(T);b||(b=[],a.set(T,b)),b.push({hash:s,name:H,type:l});const N=d.get(T)||{repeaters:0,others:0};if(l==="repeater"?N.repeaters++:N.others++,d.set(T,N),H){m.set(s,H);const P=H.toLowerCase(),I=_.get(P)??0,A=g.last_seen??0;(!t.has(P)||A>I)&&(t.set(P,s),_.set(P,A))}}const i=new Set,y=new Set;for(const[s,g]of d)g.repeaters>0&&g.others>0&&i.add(s),(g.repeaters>=2||g.others>=2)&&y.add(s);return{hashToType:h,pubKeyMap:n,prefixIndex:a,crossClassPrefixes:i,sameClassAmbiguous:y,nameToHash:t,hashToName:m}}function J(e,h,n,a){const d=new Map(h),t=new Map,m=new Map,_=new Map,i=new Map,y=new Map;for(const s of e){const g=s.timestamp??0;if(s._advertSender){const l=n.get(s._advertSender)??s._advertSender,f=y.get(l);(!f||g>f.lastSeen)&&y.set(l,{lastSeen:g,name:s._advertName??(f==null?void 0:f.name)??null,nodeType:s._advertNodeType!=null?j(s._advertNodeType):(f==null?void 0:f.nodeType)??E(s.type??s.payload_type),latitude:s._advertLatitude??(f==null?void 0:f.latitude),longitude:s._advertLongitude??(f==null?void 0:f.longitude)})}else if(s.src_hash&&s.src_hash.length>8){const l=s.src_hash,f=y.get(l);f?g>f.lastSeen&&(f.lastSeen=g):y.set(l,{lastSeen:g,name:null,nodeType:E(s.type??s.payload_type)})}if(s._advertNodeType==null&&!s._advertName)continue;const v=s._advertSender;if(s._advertNodeType!=null){let l;if(v&&(l=n.get(v)),!l&&s.src_hash&&d.has(s.src_hash)&&(l=s.src_hash),l){const f=d.get(l);if(!f||f==="unknown"){const T=j(s._advertNodeType);T!=="unknown"&&d.set(l,T)}}}if(s._advertName&&v){const l=n.get(v)??v,f=s.timestamp??0,T=s._advertName.toLowerCase();if(!a.has(T)){const b=_.get(T)??0;(!t.has(T)||f>b)&&(t.set(T,l),_.set(T,f))}const H=i.get(l)??0;(!m.has(l)||f>H)&&(m.set(l,s._advertName),i.set(l,f))}}for(const[s,g]of y){const v=d.get(s);v&&v!=="unknown"&&g.nodeType==="unknown"&&(g.nodeType=v)}return{extendedHashToType:d,advertNameToHash:t,advertHashToName:m,discoveredNodes:y}}function Z(e,h,n,a,d){var y;const t=new Map,m=new Map;if(h.size===0)return{decryptedNameToHash:t,decryptedHashToName:m};const{prefixIndex:_,nameToHash:i}=n;for(const s of e){if((s.type??s.payload_type)!==pe)continue;const v=h.get(s.packet_hash);if(!((y=v==null?void 0:v.decoded)!=null&&y.decrypted)||v.decoded.macCorrupted)continue;const l=v.decoded.senderName;if(!l)continue;const f=s.src_hash;if(!f)continue;const T=K(f);let H=d.get(T);if(!H){const N=_.get(T);(N==null?void 0:N.length)===1&&(H=N[0].hash)}if(!H&&f.length>4&&(H=f),!H)continue;const b=l.toLowerCase();!i.has(b)&&!a.has(b)&&t.set(b,H),m.has(H)||m.set(H,l)}return{decryptedNameToHash:t,decryptedHashToName:m}}function ge(e,h,n,a,d,t,m,_,i,y,s){var F,z,$,G,R,w,S;const g=e.src_hash,v=_==null?void 0:_.get(e.packet_hash),l=((F=v==null?void 0:v.decoded)==null?void 0:F.senderName)??null,{nameToHash:f}=h;if(!g){const r=e.type??e.payload_type,o=E(r),u=e._advertName??null;if(l){const p=l.toLowerCase(),x=f.get(p)??a.get(p)??i.get(p);if(x){const C=n.get(x)??o;return M(x,C,l,!0)}return M(null,o!=="unknown"?o:"companion",l,!1)}if(e._advertSender){const{pubKeyMap:p,hashToName:x}=h,C=p.get(e._advertSender);if(C){const V=n.get(C)??o,ae=x.get(C)??d.get(C)??y.get(C)??null;return M(C,V,ae,!0)}const D=d.get(e._advertSender);if(D){const V=n.get(e._advertSender)??o;return M(e._advertSender,V,D,!0)}const q=y.get(e._advertSender);if(q){const V=n.get(e._advertSender)??o;return M(e._advertSender,V,q,!0)}}if(o!=="unknown")return M(null,o,u,!1);if(e._advertNodeType!=null){const p=j(e._advertNodeType);if(p!=="unknown")return M(null,p,u,!1)}return u?M(null,"unknown",u,!1):se}const T=e.type??e.payload_type??-1,H=e._advertSender?`${g}\0${e._advertSender}`:`${g}\0${T}\0${l??""}`,b=s.get(H);if(b)return b;const N=K(g),{pubKeyMap:P,prefixIndex:I,crossClassPrefixes:A,sameClassAmbiguous:B}=h;let c;if(e._advertSender){const r=P.get(e._advertSender);if(r){const o=n.get(r)??"unknown",u=(z=I.get(N))==null?void 0:z.find(p=>p.hash===r);c=M(r,o,(u==null?void 0:u.name)??null,!0)}else if(e._advertNodeType!=null){const o=j(e._advertNodeType);o!=="unknown"&&(c=M(e._advertSender,o,e._advertName??null,!0))}else{const o=d.get(e._advertSender);if(o){const u=n.get(e._advertSender)??E(e.type??e.payload_type);c=M(e._advertSender,u,o,!0)}}}if(!c&&l){const r=I.get(N),o=r==null?void 0:r.find(u=>{var p;return((p=u.name)==null?void 0:p.toLowerCase())===l.toLowerCase()});if(o){const u=n.get(o.hash)??o.type;c=M(o.hash,u,o.name,!0)}else{const u=l.toLowerCase(),p=f.get(u)??a.get(u)??i.get(u);if(p){const x=n.get(p)??"unknown",C=($=I.get(K(p)))==null?void 0:$.find(D=>D.hash===p);c=M(p,x,(C==null?void 0:C.name)??l,!0)}}}if(!c&&A.has(N)){const r=E(e.type??e.payload_type);if(r!=="unknown"){const o=(G=I.get(N))==null?void 0:G.find(u=>u.type===r);o&&(c=M(o.hash,r,o.name,!0))}if(!c&&e._advertNodeType!=null){const o=j(e._advertNodeType);if(o!=="unknown"){const u=(R=I.get(N))==null?void 0:R.find(p=>p.type===o);u&&(c=M(u.hash,o,u.name,!0))}}if(!c){const o=I.get(N),u=t.get(N),p=u?o==null?void 0:o.find(D=>D.hash===u):o==null?void 0:o[0],x=p?n.get(p.hash)??p.type:"unknown",C=!!u&&!!p&&p.hash===u;c=M((p==null?void 0:p.hash)??null,x,(p==null?void 0:p.name)??null,C)}}if(!c){const r=t.get(N);if(r){const o=n.get(r)??"unknown",u=(w=I.get(N))==null?void 0:w.find(p=>p.hash===r);c=M(r,o,(u==null?void 0:u.name)??null,!0)}}if(!c&&B.has(N)){const r=(S=I.get(N))==null?void 0:S[0];c=M((r==null?void 0:r.hash)??null,(r==null?void 0:r.type)??"unknown",(r==null?void 0:r.name)??null,!1)}if(!c){const r=I.get(N);if((r==null?void 0:r.length)===1){const o=r[0];c=M(o.hash,o.type,o.name,!0)}else c=M(null,E(T),null,!1)}const O=E(T);if(O!=="unknown"&&O!==c.type&&(c=M(c.hash,O,c.name,c.confident)),c.type==="unknown"&&e._advertNodeType!=null){const r=j(e._advertNodeType);r!=="unknown"&&(c=M(c.hash,r,c.name,c.confident))}if(c.hash){const r=m.get(N);if(r){const o=r.find(u=>u.hash===c.hash);if(o){let u=0;const p=e.original_path??e.forwarded_path;if(p&&Array.isArray(p)&&p.length>0&&o.totalForwarderObservations>0){const x=new Set;for(const C of p){const D=String(C).toUpperCase().slice(0,2);D.length>=2&&D!==N&&x.add(D)}if(x.size>0){let C=0;for(const D of x)o.forwarderPrefixes.has(D)&&C++;u=C/x.size}}c=M(c.hash,c.type,c.name,c.confident,o.advertCount,o.forwarderPrefixes.size,u)}}}if(c.name===null&&c.hash){const r=h.hashToName.get(c.hash)??d.get(c.hash)??y.get(c.hash)??null;r&&(c=M(c.hash,c.type,r,c.confident,c.advertObservations,c.topologyNeighborCount,c.topologyAffinity))}return s.set(H,c),c}const me={hashToType:new Map,pubKeyMap:new Map,prefixIndex:new Map,crossClassPrefixes:new Set,sameClassAmbiguous:new Set,nameToHash:new Map,hashToName:new Map},_e={byPayload:new Map,byApprox:new Map},L=re((e,h)=>({config:fe,neighborContext:me,extendedHashToType:new Map,advertNameToHash:new Map,advertHashToName:new Map,resolverMap:new Map,topologyProfiles:new Map,decryptedNameToHash:new Map,decryptedHashToName:new Map,srcHashResolverMap:new Map,discoveredNodes:new Map,contentInheritanceIndex:_e,_cache:new Map,_neighborFingerprint:"",_resolverFingerprint:"",_advertScanFingerprint:"",_decodedNameFingerprint:"",_inheritanceFingerprint:"",_decodedContentVersion:0,_lastProcessedQuantizedLen:0,resolveSource:n=>{const a=h();return a.config.disambiguationEnabled?ge(n,a.neighborContext,a.extendedHashToType,a.advertNameToHash,a.advertHashToName,a.resolverMap,a.topologyProfiles,X,a.decryptedNameToHash,a.decryptedHashToName,a._cache):se},getDecodedContent:n=>{const a=h(),d=te.getState().messages;return he(n,d,a.contentInheritanceIndex,a.config.macCorruptedPolicy)},setConfig:n=>{const a={...h().config,...n};e({config:a,_cache:new Map}),Y==null||Y()},recompute:(n,a,d)=>{const t=h(),{config:m}=t,_=`${Object.keys(a).length}`;let i=t.neighborContext;const y=_!==t._neighborFingerprint;y&&(i=ye(a));const s=n.length>1e5?500:n.length>1e4?200:50,g=Math.floor(n.length/s)*s,v=t._lastProcessedQuantizedLen??0,l=!y&&v>0&&g>v,f=l?v:0,T=`${_}:${g}`;let H=t.extendedHashToType,b=t.advertNameToHash,N=t.advertHashToName,P=t.discoveredNodes;if(T!==t._advertScanFingerprint||y)if(l&&T!==t._advertScanFingerprint&&!y){const w=n.slice(f),S=J(w,i.hashToType,i.pubKeyMap,i.nameToHash);H=new Map([...t.extendedHashToType,...S.extendedHashToType]),b=new Map([...t.advertNameToHash,...S.advertNameToHash]),N=new Map([...t.advertHashToName,...S.advertHashToName]),P=new Map([...t.discoveredNodes,...S.discoveredNodes])}else{const w=J(n,i.hashToType,i.pubKeyMap,i.nameToHash);H=w.extendedHashToType,b=w.advertNameToHash,N=w.advertHashToName,P=w.discoveredNodes}const I=`${Object.keys(a).length}:${g}:${i.crossClassPrefixes.size}:${m.recencyDecayHours}:${m.zeroHopDecayHours}`;let A=t.resolverMap,B=t.topologyProfiles;if(I!==t._resolverFingerprint){const w=ie(n,a,{recencyDecayHours:m.recencyDecayHours,zeroHopDecayHours:m.zeroHopDecayHours});A=w.resolver,B=w.topologyProfiles}const c=Math.floor(d.size/20)*20,O=`${g}:${c}:${I}`;let F=t.decryptedNameToHash,z=t.decryptedHashToName;if(O!==t._decodedNameFingerprint)if(l&&!y){const w=n.slice(f),S=Z(w,d,i,b,A);F=new Map([...t.decryptedNameToHash,...S.decryptedNameToHash]),z=new Map([...t.decryptedHashToName,...S.decryptedHashToName])}else{const w=Z(n,d,i,b,A);F=w.decryptedNameToHash,z=w.decryptedHashToName}{const w=[];for(const[S,r]of P)if(r.name===null){const o=i.hashToName.get(S)??N.get(S)??z.get(S)??null;o&&w.push([S,o])}if(w.length>0){P=new Map(P);for(const[S,r]of w){const o=P.get(S);P.set(S,{...o,name:r})}}}const $=new Map(A);for(const[w,S]of F){const r=K(S),o=i.prefixIndex.get(r);if(!o||o.length<=1)continue;const u=o.find(p=>{var x;return((x=p.name)==null?void 0:x.toLowerCase())===w});u&&$.get(r)!==u.hash&&$.set(r,u.hash)}for(const[w,S]of b){const r=K(S),o=i.prefixIndex.get(r);if(!o||o.length<=1)continue;const u=o.find(p=>{var x;return((x=p.name)==null?void 0:x.toLowerCase())===w});u&&$.get(r)!==u.hash&&$.set(r,u.hash)}const G=`${g}:${c}`;let R=t.contentInheritanceIndex;if(G!==t._inheritanceFingerprint)if(l&&!y){const w=n.slice(f),S=k(w,d),r=new Map([...S.byPayload,...t.contentInheritanceIndex.byPayload]),o=new Map([...S.byApprox,...t.contentInheritanceIndex.byApprox]);R={byPayload:r,byApprox:o}}else R=k(n,d);de($),Q.active&&Q.emit("pipeline:disambig:recompute",{packets:n.length,neighbors:Object.keys(a).length,decoded:d.size,incremental:l}),e({neighborContext:i,extendedHashToType:H,advertNameToHash:b,advertHashToName:N,resolverMap:A,topologyProfiles:B,decryptedNameToHash:F,decryptedHashToName:z,srcHashResolverMap:$,discoveredNodes:P,contentInheritanceIndex:R,_cache:new Map,_neighborFingerprint:_,_resolverFingerprint:I,_advertScanFingerprint:T,_decodedNameFingerprint:O,_inheritanceFingerprint:G,_decodedContentVersion:t._decodedContentVersion+1,_lastProcessedQuantizedLen:g})}}));let X=new Map,Y=null;function ee(e,h){var d,t,m,_;if(!(h!=null&&h.public_key))return e;const n=h.public_key.toLowerCase(),a=n.startsWith("0x")?n.slice(2):n;for(const i of Object.keys(e))if((i.startsWith("0x")?i.slice(2):i).toLowerCase()===a)return e;return{...e,[h.public_key]:{name:h.node_name,node_name:h.node_name,contact_type:"Repeater",is_repeater:!0,last_seen:Date.now()/1e3,latitude:(t=(d=h.config)==null?void 0:d.repeater)==null?void 0:t.latitude,longitude:(_=(m=h.config)==null?void 0:m.repeater)==null?void 0:_.longitude,zero_hop:!0}}}if(typeof window<"u"){let e=function(){if(!n)return 150;const i=n.useStore.getState().packets.length;return i>1e5?1e3:i>1e4?500:150},h=function(){_&&clearTimeout(_),_=setTimeout(()=>{var l;if(_=null,!n||!a)return;const i=n.useStore.getState(),y=a.useDecodedMessagesStore.getState(),s=i.packets,g=ee(((l=i.stats)==null?void 0:l.neighbors)??{},i.stats),v=y.stableMessages;L.getState().recompute(s,g,v)},e())},n=null,a=null,d=[],t,m=new Map,_=null;Y=h,setTimeout(()=>{U(()=>import("./index-DhkG1Nx9.js").then(i=>i.g1),__vite__mapDeps([0,1])).then(i=>{var g,v;n=i,i.useStore.subscribe(l=>{var H,b;const f=l.packets!==d,T=((H=l.stats)==null?void 0:H.neighbors)!==t;(f||T)&&(d=l.packets,t=(b=l.stats)==null?void 0:b.neighbors,h())});const y=i.useStore.getState();d=y.packets,t=(g=y.stats)==null?void 0:g.neighbors;const s=ee(((v=y.stats)==null?void 0:v.neighbors)??{},y.stats);(d.length>0||Object.keys(s).length>0)&&L.getState().recompute(d,s,new Map)}),U(()=>import("./index-DhkG1Nx9.js").then(i=>i.f$),__vite__mapDeps([0,1])).then(i=>{a=i,X=i.useDecodedMessagesStore.getState().messages,i.useDecodedMessagesStore.subscribe(y=>{y.messages!==X&&(X=y.messages),y.stableMessages!==m&&(m=y.stableMessages,h())})})},0)}const we=L;function Te(){return L(e=>e.resolveSource)}function He(){return L(e=>e.neighborContext)}function Se(){return L(e=>e.topologyProfiles)}function Me(){return L(e=>e.advertNameToHash)}function be(){const e=L(a=>a.getDecodedContent),h=L(a=>a._decodedContentVersion),n=te(a=>a._successCount);return ce.useCallback(a=>e(a),[e,h,n])}function xe(){return L(e=>e.config)}function Ce(){return L(e=>e.srcHashResolverMap)}function Pe(){return L(e=>e.discoveredNodes)}export{fe as DEFAULT_PIPELINE_CONFIG,Me as useAdvertNameToHash,Pe as useDiscoveredNodes,be as useGetDecodedContent,He as useNeighborContext,xe as usePipelineConfig,we as usePipelineStore,Te as useResolveSource,Ce as useSrcHashResolverMap,Se as useTopologyProfiles};
