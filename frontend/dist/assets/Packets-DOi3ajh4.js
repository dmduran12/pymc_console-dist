import{r as e,j as a,H as s,k as l,B as t,U as i,f as r}from"./vendor-react-SfmO5UG4.js";import{c as o}from"./vendor-core-D1p9zwXj.js";import{m as n,p as c,t as d,v as m,W as u,a1 as p,D as x,a3 as h,a4 as b,B as g,q as v,T as j}from"./index-CF53FmhC.js";import{C as f,a as y,V as N,A as w,Q as S,o as k,U as C,Y as P,h as M,X as R}from"./vendor-icons-QG3AVsi5.js";import{g as L,u as D,P as F}from"./PacketList-i4KXNmGw.js";import{u as A,a as T}from"./usePipelineStore-5LDag23M.js";import{c as _,a as H,A as V}from"./AnalyzerFilterPanel-DCracTLr.js";import{u as z,r as B}from"./consumer-registry-DZR4TejQ.js";import{P as q,a as K,B as O,C as E}from"./PageLayout-Dk_m6izQ.js";import{T as G}from"./TimeRangeStepper-CNE7SkDj.js";import{R as I}from"./Grid-BL9S-4ma.js";import"./cosmograph-DqYT4sUA.js";import"./vendor-charts-C916_-gs.js";import"./vendor-motion-BUrLkjC7.js";import"./vendor-fonts-CRZaZSFf.js";import"./primitives-Bm122DQ8.js";import"./payload-decoders-BPu6Liho.js";import"./badge-colors-BxLppqaF.js";import"./chat-utils-BW6gde05.js";import"./SignalIndicator-DLjeV7cj.js";import"./DataBox-CxIna5a0.js";import"./useMapViewStore-BVKSA2gx.js";import"./node-types-CunV9yGl.js";import"./geo-utils-DJn8DnxF.js";function U({options:r,value:n,onChange:c,defaultValue:d,displayValue:m,filter:u,placeholder:p,disabled:x,invalid:h,name:b,"aria-label":g,className:v,children:j}){const[y,N]=e.useState(""),w=m??(e=>null!=e?String(e):""),S=u??((e,a)=>w(e).toLowerCase().includes(a.toLowerCase())),k=e.useMemo(()=>y?r.filter(e=>S(e,y)):r,[r,y,S]);return a.jsx(s,{value:n,onChange:c,defaultValue:d,disabled:x,name:b,onClose:()=>N(""),children:a.jsxs("div",{className:o("relative",v),children:[a.jsxs("div",{className:"relative",children:[a.jsx(l,{"aria-label":g,displayValue:w,onChange:e=>N(e.target.value),placeholder:p,className:o(["w-full radius-inner py-2 pl-3 pr-10","text-sm text-fg-primary placeholder:text-fg-muted","bg-input-bg",h?"border border-sys-red":"border border-input-border","ring-focus-inset","hover:border-edge-strong","disabled:opacity-40 disabled:pointer-events-none disabled:cursor-not-allowed","transition-colors"])}),a.jsx(t,{className:"absolute inset-y-0 right-0 flex items-center pr-3 group",children:a.jsx(f,{className:"w-4 h-4 text-fg-muted transition-transform duration-200 group-data-[open]:rotate-180"})})]}),a.jsx(i,{anchor:"bottom start",transition:!0,className:o(["w-[var(--input-width)] min-w-[180px]","max-h-60 overflow-y-auto overscroll-contain scroll-py-1","radius-inset p-1 mt-1","surface-elevated","focus:outline-none","transition-opacity","data-[closed]:opacity-0","data-[enter]:duration-150 data-[leave]:duration-100","z-50"]),children:0===k.length&&""!==y?a.jsx("div",{className:"px-3 py-2 text-sm text-fg-muted",children:"No results found"}):k.map((s,l)=>a.jsx(e.Fragment,{children:j(s)},l))})]})})}function W({value:s,disabled:l,className:t,children:i}){return a.jsx(r,{as:e.Fragment,value:s,disabled:l,children:({selected:e,focus:s})=>a.jsxs("div",{className:o("flex items-center gap-2 px-3 py-2 radius-control cursor-default","text-sm",s&&"bg-sys-blue text-white",!s&&"text-fg-primary",e&&!s&&"text-sys-blue",l&&"opacity-50 cursor-not-allowed",t),children:[a.jsx("span",{className:"w-4 flex-shrink-0",children:e&&a.jsx(y,{className:"w-4 h-4"})}),a.jsx("span",{className:"truncate flex-1",children:i})]})})}function J({className:e,...s}){return a.jsx("span",{...s,className:o("truncate",e)})}function Q({value:e,onChange:s,options:l,placeholder:t,disabled:i,className:r,"aria-label":o}){const n=l.find(a=>a.value===e);return a.jsx(U,{options:l,value:n,onChange:e=>{e&&s(e.value)},displayValue:e=>(null==e?void 0:e.label)??"",filter:(e,a)=>e.label.toLowerCase().includes(a.toLowerCase()),placeholder:t,disabled:i,className:r,"aria-label":o,children:e=>a.jsx(W,{value:e,disabled:e.disabled,children:a.jsx(J,{children:e.label})})})}const Y=[{target:"PacketStats",fn:"type",minStage:1}];function X({icon:e,label:s,value:l,color:t,percentage:i}){return a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx("div",{className:o("p-1.5 rounded-md",t),children:e}),a.jsxs("div",{className:"flex flex-col",children:[a.jsx("span",{className:"text-sm font-semibold text-fg-primary",children:l.toLocaleString()}),a.jsxs("span",{className:"text-xs text-fg-muted leading-tight",children:[s,void 0!==i&&a.jsxs("span",{className:"ml-1 opacity-70",children:["(",i,"%)"]})]})]})]})}B(Y);const Z=e.memo(function({packets:s}){z(Y);const l=e.useMemo(()=>{let e=0,a=0,l=0;const t=new Set;let i=0,r=0;for(const c of s){switch(L(c)){case"forward":e++;break;case"dropped":a++;break;case"duplicate":l++}c.src_hash&&t.add(c.src_hash),c.rssi&&(i+=c.rssi,r++)}const o=s.length,n=r>0?Math.round(i/r):0;return{total:o,rx:o,fwd:e,dropped:a,duplicate:l,uniqueSources:t.size,avgRssi:n,rxPercent:100,fwdPercent:o>0?Math.round(e/o*100):0,droppedPercent:o>0?Math.round(a/o*100):0}},[s]);return 0===s.length?null:a.jsx("div",{className:"surface-base depth-raised rounded-2xl p-3 pr-4",children:a.jsxs("div",{className:"grid grid-cols-2 gap-3 sm:flex sm:items-center sm:justify-between sm:gap-6",children:[a.jsx(X,{icon:a.jsx(N,{className:"w-3.5 h-3.5 text-sys-blue"}),label:"Received",value:l.rx,color:"bg-sys-blue/10",percentage:l.rxPercent}),a.jsx(X,{icon:a.jsx(w,{className:"w-3.5 h-3.5 text-sys-green"}),label:"Forwarded",value:l.fwd,color:"bg-sys-green/10",percentage:l.fwdPercent}),a.jsx(X,{icon:a.jsx(S,{className:"w-3.5 h-3.5 text-sys-red"}),label:"Dropped",value:l.dropped,color:"bg-sys-red/10",percentage:l.droppedPercent}),a.jsx(X,{icon:a.jsx(k,{className:"w-3.5 h-3.5 text-fg-muted"}),label:"Duplicates",value:l.duplicate,color:"bg-subtle-fill"}),a.jsxs("div",{className:"hidden sm:flex items-center gap-6 ml-auto",children:[a.jsx(X,{icon:a.jsx(C,{className:"w-3.5 h-3.5 text-sys-indigo"}),label:"Sources",value:l.uniqueSources,color:"bg-sys-indigo/10"}),a.jsxs("div",{className:"flex flex-col items-end pr-1",children:[a.jsxs("span",{className:"type-data-sm text-fg-secondary",children:[l.avgRssi," dBm"]}),a.jsx("span",{className:"text-xs text-fg-muted",children:"Avg Signal"})]})]})]})})});function $(){const s=n(),l=c(),t=A(),i=D(e=>e.requestChannel),r=d(),f=null==l?void 0:l.local_hash,y=null==l?void 0:l.neighbors,N=m(),w=u(),S=p().isBackgroundLoading&&N>=5,[k,C]=e.useState(!1),[z,B]=e.useState(!0),U=e.useCallback(e=>B(e),[]),[W,J]=e.useState({limit:500,status:"all"}),[Y,X]=e.useState(_),$=e.useMemo(()=>{const e=Math.floor(Date.now()/1e3);return{start:e-60*x[N].minutes,end:e}},[N]),ee=e.useMemo(()=>{const e=(null==l?void 0:l.neighbors)??{};return Object.fromEntries(Object.entries(e).filter(([e])=>!r.has(e)))},[null==l?void 0:l.neighbors,r]),ae=T(),[se,le]=e.useState(Date.now);e.useEffect(()=>{W.timeRange&&W.timeRange>0&&queueMicrotask(()=>le(Date.now()))},[W.timeRange,s]);const te=e.useMemo(()=>H(s,Y,ae,$),[s,Y,ae,$]),ie=e.useMemo(()=>{const e=W.limit??500;return[...te.length<=e?te:te.slice(-e)].sort((e,a)=>(a.timestamp??0)-(e.timestamp??0))},[te,W.limit]),re=0===s.length,oe=e.useMemo(()=>{let e=ie;if(void 0!==W.type){const a=h[W.type];e=e.filter(e=>{const s=e.type??e.payload_type,l=e.payload_type_name;return s===W.type||l===a})}if(void 0!==W.route){const a=b[W.route];e=e.filter(e=>{const s=e.route??e.route_type,l=e.route_type_name;return s===W.route||l===a})}if(W.status&&"all"!==W.status&&(e=e.filter(e=>L(e)===W.status)),void 0!==W.signalMin&&(e=e.filter(e=>e.rssi>=W.signalMin)),W.timeRange&&W.timeRange>0){const a=se/1e3-3600*W.timeRange;e=e.filter(e=>e.timestamp>=a)}return e},[ie,W.type,W.route,W.status,W.signalMin,W.timeRange,se]),ne=(e,a)=>J(s=>({...s,[e]:a})),ce=void 0!==W.type||void 0!==W.route||W.status&&"all"!==W.status||void 0!==W.signalMin||W.timeRange&&W.timeRange>0;return a.jsxs(q,{children:[a.jsx(K,{title:"Packet History",icon:a.jsx(M,{}),controls:a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsxs(g,{outline:!0,color:ce?"primary":"muted",onClick:()=>C(!k),className:"sm:hidden",children:[a.jsx(P,{"data-slot":"icon"}),ce&&a.jsx("span",{className:"w-1.5 h-1.5 rounded-full bg-sys-blue"})]}),a.jsx(G,{ranges:x,selectedIndex:N,onSelect:w,isPending:S})]})}),a.jsxs(O,{children:[a.jsx(I,{template:"auto",className:"relative z-10",children:a.jsx(E,{neomorphic:!0,className:"overflow-visible",children:a.jsx(V,{parentStartTs:$.start,parentEndTs:$.end,neighbors:ee,filter:Y,onChange:X})})}),a.jsxs(E,{neomorphic:!0,noPadding:!0,className:o("overflow-hidden transition-all duration-200",k?"max-h-96 opacity-100":"max-h-0 opacity-0 sm:max-h-96 sm:opacity-100"),children:[a.jsx(v,{listHeader:!0,icon:a.jsx(P,{className:"icon-sm"}),title:"Filters",actions:ce?a.jsxs(g,{plain:!0,color:"muted",onClick:()=>J({limit:W.limit,status:"all"}),className:"!text-xs !py-0.5 !px-1.5",children:[a.jsx(R,{"data-slot":"icon",className:"!w-3 !h-3"}),"Clear"]}):void 0}),a.jsx("div",{className:"p-3 sm:p-4",children:a.jsxs("div",{className:"grid grid-cols-2 sm:flex sm:flex-wrap gap-3",children:[a.jsxs("div",{className:"flex-1 min-w-[140px]",children:[a.jsx("label",{className:"type-micro block mb-1",children:"Type"}),a.jsx(Q,{value:W.type??"",onChange:e=>ne("type",""===e?void 0:Number(e)),options:[{value:"",label:"All Types"},...Object.entries(h).map(([e,a])=>({value:Number(e),label:a}))],placeholder:"Search types...","aria-label":"Filter by packet type"})]}),a.jsxs("div",{className:"flex-1 min-w-[140px]",children:[a.jsx("label",{className:"type-micro block mb-1",children:"Route"}),a.jsx(Q,{value:W.route??"",onChange:e=>ne("route",""===e?void 0:Number(e)),options:[{value:"",label:"All Routes"},...Object.entries(b).map(([e,a])=>({value:Number(e),label:a}))],placeholder:"Search routes...","aria-label":"Filter by route type"})]}),a.jsxs("div",{className:"flex-1 min-w-[140px]",children:[a.jsx("label",{className:"type-micro block mb-1",children:"Status"}),a.jsx(Q,{value:W.status??"all",onChange:e=>ne("status",e),options:[{value:"all",label:"All Status"},{value:"rx",label:"Received"},{value:"forward",label:"Forwarded"},{value:"dropped",label:"Dropped"},{value:"duplicate",label:"Duplicate"}],placeholder:"Search status...","aria-label":"Filter by status"})]}),a.jsxs("div",{className:"flex-1 min-w-[120px]",children:[a.jsx("label",{className:"type-micro block mb-1",children:"Time"}),a.jsx(Q,{value:W.timeRange??0,onChange:e=>ne("timeRange",0===e?void 0:e),options:[{value:0,label:"All Time"},{value:1,label:"Last 1h"},{value:6,label:"Last 6h"},{value:24,label:"Last 24h"},{value:168,label:"Last 7d"}],placeholder:"Search time...","aria-label":"Filter by time range"})]}),a.jsxs("div",{className:"flex-1 min-w-[130px]",children:[a.jsx("label",{className:"type-micro block mb-1",children:"Signal"}),a.jsx(Q,{value:W.signalMin??"",onChange:e=>ne("signalMin",""===e?void 0:Number(e)),options:[{value:"",label:"Any Signal"},{value:-90,label:"Strong (≥-90)"},{value:-100,label:"Good (≥-100)"},{value:-110,label:"Fair (≥-110)"},{value:-120,label:"Weak (≥-120)"}],placeholder:"Search signal...","aria-label":"Filter by signal strength"})]}),a.jsxs("div",{className:"flex-1 min-w-[100px]",children:[a.jsx("label",{className:"type-micro block mb-1",children:"Limit"}),a.jsx(Q,{value:W.limit??500,onChange:e=>ne("limit",e),options:[{value:100,label:"100"},{value:200,label:"200"},{value:500,label:"500"},{value:1e3,label:"1K"},{value:2e3,label:"2K"},{value:5e3,label:"5K"},{value:1e4,label:"10K"}],placeholder:"Limit...","aria-label":"Packet limit"})]}),a.jsxs("div",{className:"flex-1 min-w-[100px]",children:[a.jsx("label",{className:"type-micro block mb-1",children:"Per Page"}),a.jsx(Q,{value:W.perPage??50,onChange:e=>ne("perPage",e),options:[{value:25,label:"25"},{value:50,label:"50"},{value:100,label:"100"},{value:200,label:"200"},{value:500,label:"500"}],placeholder:"Per page...","aria-label":"Packets per page"})]})]})})]}),a.jsx(Z,{packets:oe}),a.jsxs(E,{neomorphic:!0,noPadding:!0,className:"!overflow-visible",children:[a.jsx(v,{listHeader:!0,icon:a.jsx(M,{className:"icon-sm"}),title:"Packet History",actions:a.jsx(j,{enabled:z,onChange:U,label:"Hide Dupes",size:"sm"})}),a.jsx(F,{packets:oe,allPackets:s,localHash:f,neighbors:y,resolveSource:ae,getDecodedContent:t,onChannelClick:i,loading:re,showPagination:!0,perPage:W.perPage??50,hideDupes:z,emptyMessage:"No packets found"})]})]})]})}export{$ as default};
