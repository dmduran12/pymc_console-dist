import{r as e,j as t,c as s}from"./vendor-react-j_fHog8x.js";import{c as a,e as n,a3 as l,aQ as i,aR as r,aS as o,an as c,aT as d,j as m,aU as u,aV as h,u as x,aW as p,aX as f,aY as g,aZ as y,a_ as b,a$ as v,ar as j,b0 as N,b1 as w,b2 as k,aC as M,b3 as S,b4 as C,aD as T,b5 as A,R as L,a5 as F,t as P,y as E,x as R,p as _,aN as D,a0 as $,z,Q as H,b6 as B,E as q,b7 as I,az as O,G as W,a2 as G,b8 as X}from"./index-DUdBVrkp.js";import{u as V}from"./usePolling-B1kG3uqm.js";import{L as Y}from"./layers-CskHgMFG.js";import{C as U,e as J}from"./easing-DZE3_8sH.js";import{E as K,A as Q,T as Z}from"./TimeRangeSelector-EXAnSrLl.js";import{a as ee,P as te,b as se,B as ae}from"./PageLayout-C3JPWYIE.js";import{D as ne}from"./DataBox-C4M1jydR.js";import{C as le,M as ie}from"./CollisionExplorerModal-D2e9rQi1.js";import{C as re,a as oe}from"./Card-CGepARZ-.js";import{H as ce,R as de}from"./route-Rv87h0JQ.js";import{T as me}from"./triangle-alert-Du1LchcO.js";import{G as ue}from"./git-branch-BsVjl6DI.js";import{L as he}from"./LightSparkline-BCL2qx0n.js";import{A as xe}from"./activity-nY_hFT7-.js";import{c as pe,C as fe,m as ge,i as ye}from"./node-types-DJaKVMvk.js";import{F as be}from"./funnel-Cb33fty-.js";import{M as ve}from"./message-square-vQjwS1YH.js";import{S as je}from"./search-CXJQuHxT.js";import{P as Ne,f as we}from"./payload-decoders-D3xttJsn.js";import{R as ke,C as Me}from"./Grid-OFJ4oe0a.js";import{S as Se}from"./settings-2-J1pnmn4k.js";import{N as Ce}from"./network-CUkUAgWW.js";import"./maplibre-gl-b91ci4Kr.js";import"./vendor-core-CmkNwW1A.js";import"./index-RATkW0Mr.js";import"./copy-BdHlFWoY.js";import"./BasemapLayer-BT1oL_wV.js";import"./map-pin-e7pUaLGl.js";const Te=a("chart-line",[["path",{d:"M3 3v16a2 2 0 0 0 2 2h16",key:"c24i48"}],["path",{d:"m19 9-5 5-4-4-3 3",key:"2osh9i"}]]),Ae=a("circle-check-big",[["path",{d:"M21.801 10A10 10 0 1 1 17 3.335",key:"yps3ct"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]]),Le=a("grid-3x3",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}],["path",{d:"M3 9h18",key:"1pudct"}],["path",{d:"M3 15h18",key:"5xshup"}],["path",{d:"M9 3v18",key:"fh3hqa"}],["path",{d:"M15 3v18",key:"14nvp0"}]]),Fe=a("grip",[["circle",{cx:"12",cy:"5",r:"1",key:"gxeob9"}],["circle",{cx:"19",cy:"5",r:"1",key:"w8mnmm"}],["circle",{cx:"5",cy:"5",r:"1",key:"lttvr7"}],["circle",{cx:"12",cy:"12",r:"1",key:"41hilf"}],["circle",{cx:"19",cy:"12",r:"1",key:"1wjl8i"}],["circle",{cx:"5",cy:"12",r:"1",key:"1pcz8c"}],["circle",{cx:"12",cy:"19",r:"1",key:"lyex9k"}],["circle",{cx:"19",cy:"19",r:"1",key:"shf9b7"}],["circle",{cx:"5",cy:"19",r:"1",key:"bfqh0e"}]]),Pe=a("id-card",[["path",{d:"M16 10h2",key:"8sgtl7"}],["path",{d:"M16 14h2",key:"epxaof"}],["path",{d:"M6.17 15a3 3 0 0 1 5.66 0",key:"n6f512"}],["circle",{cx:"9",cy:"11",r:"2",key:"yxgjnd"}],["rect",{x:"2",y:"5",width:"20",height:"14",rx:"2",key:"qneu4z"}]]),Ee=a("radar",[["path",{d:"M19.07 4.93A10 10 0 0 0 6.99 3.34",key:"z3du51"}],["path",{d:"M4 6h.01",key:"oypzma"}],["path",{d:"M2.29 9.62A10 10 0 1 0 21.31 8.35",key:"qzzz0"}],["path",{d:"M16.24 7.76A6 6 0 1 0 8.23 16.67",key:"1yjesh"}],["path",{d:"M12 18h.01",key:"mhygvu"}],["path",{d:"M17.99 11.66A6 6 0 0 1 15.77 16.67",key:"1u2y91"}],["circle",{cx:"12",cy:"12",r:"2",key:"1c9p78"}],["path",{d:"m13.41 10.59 5.66-5.66",key:"mhq4k0"}]]),Re=a("sparkle",[["path",{d:"M11.017 2.814a1 1 0 0 1 1.966 0l1.051 5.558a2 2 0 0 0 1.594 1.594l5.558 1.051a1 1 0 0 1 0 1.966l-5.558 1.051a2 2 0 0 0-1.594 1.594l-1.051 5.558a1 1 0 0 1-1.966 0l-1.051-5.558a2 2 0 0 0-1.594-1.594l-5.558-1.051a1 1 0 0 1 0-1.966l5.558-1.051a2 2 0 0 0 1.594-1.594z",key:"1s2grr"}]]),_e=a("waves",[["path",{d:"M2 6c.6.5 1.2 1 2.5 1C7 7 7 5 9.5 5c2.6 0 2.4 2 5 2 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1",key:"knzxuh"}],["path",{d:"M2 12c.6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 2.6 0 2.4 2 5 2 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1",key:"2jd2cc"}],["path",{d:"M2 18c.6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 2.6 0 2.4 2 5 2 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1",key:"rd2r6e"}]]),De={useAbsoluteThresholds:!0,baselinePercentile:6,spikePercentile:50,baselineDbm:-107,spikeDbm:-100,mergeGapSeconds:45,minSequenceLength:16,similarityToleranceDbm:5};function $e(e,t){if(0===e.length)return 0;const s=t/100*(e.length-1),a=Math.floor(s),n=Math.ceil(s);return a===n?e[a]:e[a]+(e[n]-e[a])*(s-a)}function ze(e){if(0===e.length)return{median:0,p90:0,p95:0,p99:0,max:0,min:0};const t=[...e].sort((e,t)=>e-t);return{median:$e(t,50),p90:$e(t,90),p95:$e(t,95),p99:$e(t,99),max:t[t.length-1],min:t[0]}}function He(e,t,s){const a=s-t;if(0===a)return"moderate";const n=(e-t)/a;return n>.66?"critical":n>.33?"severe":"moderate"}const Be=Object.entries(l).map(([e,t])=>{const s=parseInt(e,10);return{typeNum:s,key:`TYPE_${s}`,label:t}});function qe({sortedTypes:a,highlightedType:l,onTypeHover:i,aggregateShares:r,hoverData:o}){const c=e.useMemo(()=>{if(!o)return null;const e=new Map;for(const t of o.items)e.set(t.key,t.value);return e},[o]),d=null!==c,m=e.useMemo(()=>{const e=new Set(a.map(e=>e.key));return[...a.map(e=>({typeNum:e.typeNum,key:e.key,label:e.label})),...Be.filter(t=>!e.has(t.key))]},[a]);return t.jsxs("div",{className:"flex-shrink-0 pt-3 mt-2",children:[t.jsxs("div",{className:"flex items-center gap-2 ml-9 mb-1.5 type-data-xs",children:[t.jsx("span",{className:"text-fg-muted",children:"Packet Types"}),d&&(null==o?void 0:o.timeLabel)&&t.jsx("span",{className:"text-sys-indigo tabular-nums",children:o.timeLabel})]}),t.jsx("div",{className:"flex flex-wrap gap-x-4 gap-y-1 type-data-xs ml-9",onMouseLeave:()=>i(null),children:m.map(e=>{const a=n(e.typeNum),o=(null==c?void 0:c.get(e.key))??0,m=r.get(e.key)??0,u=d?o:m,h=u>1e-4,x=r.has(e.key),p=l===e.key,f=l&&!p||d&&o<=1e-4||!d&&!l&&!x;return t.jsxs("div",{className:s("flex items-center gap-1.5 transition-opacity cursor-pointer hover:opacity-80",f&&"opacity-30"),onMouseEnter:()=>i(e.key),children:[t.jsx("div",{className:"shrink-0 w-3 h-3 rounded-xs",style:{backgroundColor:a}}),t.jsx("span",{className:"text-fg-secondary whitespace-nowrap",children:e.label}),h&&t.jsxs("span",{className:s("tabular-nums",d?"text-fg-primary":"text-fg-muted"),children:[(100*u).toFixed(1),"%"]})]},e.key)})})]})}const Ie='ui-monospace, SFMono-Regular, "SF Mono", Menlo, Consolas, monospace';function Oe(e,t,s,a,n){const l=e.reduce((e,t)=>e+t,0);if(l<=0||0===e.length)return[];const i=e.map((e,t)=>t).sort((t,s)=>e[s]-e[t]),r=i.map(t=>e[t]),o=new Array(e.length);return We(r,i,l,t,s,a,n,o),o}function We(e,t,s,a,n,l,i,r){if(0===e.length)return;if(1===e.length)return void(r[t[0]]={x:a,y:n,w:l,h:i,index:t[0]});const o=l*i/s,c=l>=i,d=c?i:l;let m=0,u=1/0,h=0;for(let b=0;b<e.length;b++){const t=m+e[b],s=t*o/d;if(s<=0){h=b+1,m=t;continue}const a=e[0]*o/s,n=e[b]*o/s,l=Math.max(a>s?a/s:s/a,n>s?n/s:s/n);if(!(l<=u))break;u=l,h=b+1,m=t}const x=d>0?m*o/d:0;let p=0;for(let b=0;b<h;b++){const s=(m>0?e[b]/m:0)*d;r[t[b]]=c?{x:a,y:n+p,w:x,h:s,index:t[b]}:{x:a+p,y:n,w:s,h:x,index:t[b]},p+=s}const f=e.slice(h),g=t.slice(h),y=s-m;c?We(f,g,y,a+x,n,l-x,i,r):We(f,g,y,a,n+x,l,i-x,r)}function Ge(e,t,s,a,l,i){for(const r of t){const t=s[r.index];if(!t)continue;const o=2*i,c=r.x*i+o/2,d=r.y*i+o/2,m=r.w*i-o,u=r.h*i-o;if(m<=0||u<=0)continue;const h=n(t.typeNum),x=null!==l&&l!==r.index;e.save(),e.globalAlpha=x?.4:1;const p=3*i;e.beginPath(),e.moveTo(c+p,d),e.lineTo(c+m-p,d),e.quadraticCurveTo(c+m,d,c+m,d+p),e.lineTo(c+m,d+u-p),e.quadraticCurveTo(c+m,d+u,c+m-p,d+u),e.lineTo(c+p,d+u),e.quadraticCurveTo(c,d+u,c,d+u-p),e.lineTo(c,d+p),e.quadraticCurveTo(c,d,c+p,d),e.closePath(),e.fillStyle=h,e.fill(),e.strokeStyle="rgba(0,0,0,0.2)",e.lineWidth=1*i,e.stroke();const f=4*i,g=r.w>36&&r.h>20,y=r.w>36&&r.h>32;if(g){const s=11*i;if(y){const n=a>0?t.size/a*100:0;e.font=`500 ${8*i}px ${Ie}`,e.fillStyle="rgba(0,0,0,0.6)",e.textBaseline="alphabetic",e.textAlign="left",e.fillText(`${n.toFixed(1)}%`,c+f,d+u-f-s)}e.font=`600 ${9*i}px ${Ie}`,e.fillStyle="rgba(0,0,0,0.85)",e.textBaseline="alphabetic",e.textAlign="left",e.fillText(t.name,c+f,d+u-f)}e.restore()}}function Xe({data:e,total:s,color:a,position:n,containerWidth:l,isAirtime:i}){if(!e||!n)return null;const r=(e.value/s*100).toFixed(1),o=l-n.x<184?Math.max(8,n.x-160-8):n.x+16;return t.jsx("div",{className:"absolute z-50 pointer-events-none",style:{left:o,top:Math.max(8,n.y-60)},children:t.jsxs("div",{className:"bg-tooltip-bg border border-edge-subtle rounded-lg px-3 py-2 shadow-xl min-w-[140px]",children:[t.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[t.jsx("span",{className:"w-2.5 h-2.5 rounded-sm flex-shrink-0",style:{backgroundColor:a}}),t.jsx("span",{className:"type-data-sm font-semibold text-fg-primary",children:e.name})]}),t.jsxs("div",{className:"space-y-0.5 type-data-xs text-fg-muted",children:[t.jsxs("div",{className:"flex justify-between gap-4",children:[t.jsx("span",{children:i?"Airtime":"Count"}),t.jsx("span",{className:"text-fg-primary tabular-nums font-medium",children:i?Ve(e.value):e.value.toLocaleString()})]}),t.jsxs("div",{className:"flex justify-between gap-4",children:[t.jsx("span",{children:"Share"}),t.jsxs("span",{className:"text-fg-primary tabular-nums font-medium",children:[r,"%"]})]}),t.jsxs("div",{className:"flex justify-between gap-4",children:[t.jsx("span",{children:"Total"}),t.jsx("span",{className:"text-fg-primary tabular-nums font-medium",children:i?Ve(s):s.toLocaleString()})]})]})]})})}function Ve(e){return e>=6e4?`${(e/6e4).toFixed(1)}m`:e>=1e3?`${(e/1e3).toFixed(1)}s`:`${Math.round(e)}ms`}function Ye({sortedTypes:s,aggregateShares:a,mode:l="share"}){var i,r,o;const[c,d]=e.useState(null),[m,u]=e.useState(null),[h,x]=e.useState(0),[p,f]=e.useState(null),g=e.useRef(null),y=e.useRef(null),b=e.useRef([]),v="airtime"===l,j=e.useMemo(()=>s.reduce((e,t)=>e+(v?t.totalAirtime:t.totalCount),0),[s,v]),N=e.useMemo(()=>s.map((e,t)=>({name:e.label,size:v?e.totalAirtime:e.totalCount,index:t,typeNum:e.typeNum,key:e.key})),[s,v]);e.useEffect(()=>{const e=y.current;if(!e)return;const t=e.parentElement;if(!t)return;const s=t.getBoundingClientRect(),a=s.width,n=s.height;if(a<=0||n<=0)return;const l=window.devicePixelRatio||1;e.width=Math.floor(a*l),e.height=Math.floor(n*l),e.style.width=`${a}px`,e.style.height=`${n}px`;const i=Oe(N.map(e=>e.size),0,0,a,n);b.current=i;const r=e.getContext("2d");r&&(r.clearRect(0,0,e.width,e.height),Ge(r,i,N,j,c,l))},[N,j,c]),e.useEffect(()=>{const e=g.current;if(!e)return;const t=new ResizeObserver(()=>{const t=y.current;if(!t)return;const s=e.getBoundingClientRect(),a=s.width,n=s.height;if(a<=0||n<=0)return;const l=window.devicePixelRatio||1;t.width=Math.floor(a*l),t.height=Math.floor(n*l),t.style.width=`${a}px`,t.style.height=`${n}px`;const i=Oe(N.map(e=>e.size),0,0,a,n);b.current=i;const r=t.getContext("2d");r&&(r.clearRect(0,0,t.width,t.height),Ge(r,i,N,j,c,l))});return t.observe(e),()=>t.disconnect()},[N,j]);const w=e.useCallback(e=>{const t=g.current;if(!t)return;const s=t.getBoundingClientRect(),a=e.clientX-s.left,n=e.clientY-s.top,l=function(e,t,s){for(const a of e)if(t>=a.x&&t<=a.x+a.w&&s>=a.y&&s<=a.y+a.h)return a.index;return null}(b.current,a,n);d(l),null!==l?(x(s.width),u({x:a,y:n})):u(null)},[]),k=e.useCallback(()=>{d(null),u(null)},[]),M=e.useCallback(e=>{if(f(e),e){const t=N.findIndex(t=>t.key===e);d(t>=0?t:null)}else d(null)},[N]),S=null!==c?{name:(null==(i=N[c])?void 0:i.name)??"",value:(null==(r=N[c])?void 0:r.size)??0}:null,C=null!==c?n(null==(o=N[c])?void 0:o.typeNum):"";return 0===s.length||0===j?t.jsxs("div",{className:"h-full flex items-center justify-center text-fg-muted",children:[t.jsx(Y,{className:"w-6 h-6 mr-2 opacity-50"}),t.jsx("span",{children:"No packet type data available"})]}):t.jsxs("div",{className:"flex flex-col h-full",children:[t.jsxs("div",{className:"flex-1 min-h-0 relative",ref:g,onMouseMove:w,onMouseLeave:k,children:[t.jsx("canvas",{ref:y,className:"absolute inset-0",style:{cursor:"default"}}),t.jsx(Xe,{data:S,total:j,color:C,position:m,containerWidth:h,isAirtime:v})]}),t.jsx("div",{style:{minHeight:80},children:t.jsx(qe,{sortedTypes:s,highlightedType:p,onTypeHover:M,aggregateShares:a})})]})}function Ue(e){return e>=1e9?`${(e/1e9).toFixed(1)} Gb`:e>=1e6?`${(e/1e6).toFixed(1)} Mb`:e>=1e3?`${(e/1e3).toFixed(1)} Kb`:`${e.toFixed(0)} B`}function Je({packets:s,mode:a,startTs:n,endTs:l,radioConfig:u,bucketCount:h,lockedYMax:x,legendMinH:p}){const f=e.useMemo(()=>i(),[]),g=f.blue,y=f.red,b=f.yellow,[v,j]=e.useState(null),{trendData:N,totals:w}=e.useMemo(()=>{if(0===s.length)return{trendData:[],totals:{rxBytes:0,txBytes:0,rxAirtime:0,txAirtime:0}};const e=l-n,t=Math.min(Math.ceil(e/300),h),i=e/t,c=[];let d=0,m=0,x=0,p=0;for(const a of s){const e=a.timestamp;if(e<n||e>=l)continue;const t=r(a),s=o(a,{spreadingFactor:u.sf,bandwidthHz:u.bw,codingRate:u.cr,preambleLength:u.preamble}),i={timestamp:e,rxAirtime:0,txAirtime:0,rxBytes:0,txBytes:0};a.transmitted?(i.txAirtime=s,i.txBytes=t,m+=t,p+=s):(i.rxAirtime=s,i.rxBytes=t,d+=t,x+=s),c.push(i)}c.sort((e,t)=>e.timestamp-t.timestamp);const f=new Float64Array(c.length+1),g=new Float64Array(c.length+1),y=new Float64Array(c.length+1),b=new Float64Array(c.length+1),v=new Float64Array(c.length);for(let s=0;s<c.length;s++)f[s+1]=f[s]+c[s].rxAirtime,g[s+1]=g[s]+c[s].txAirtime,y[s+1]=y[s]+c[s].rxBytes,b[s+1]=b[s]+c[s].txBytes,v[s]=c[s].timestamp;const j=e=>{let t=0,s=v.length;for(;t<s;){const a=t+s>>>1;v[a]<e?t=a+1:s=a}return t},N=[],w=1e3*i;for(let s=0;s<t;s++){const e=n+s*i,t=e+i,l=j(e),r=j(t);if("share"===a){const t=y[r]-y[l],s=b[r]-b[l];N.push({timestamp:e,rx:t>0?t:null,tx:s>0?s:null})}else{const t=(f[r]-f[l])/w*100,s=(g[r]-g[l])/w*100;N.push({timestamp:e,rx:t>0?t:null,tx:s>0?s:null})}}const k=2/31;let M=null;return{trendData:N.map(e=>{const t=e.rx;return null!==t&&t>0&&(M=null===M?t:k*t+(1-k)*M),{...e,rxSmooth:null!==M&&M>0?M:null}}),totals:{rxBytes:d,txBytes:m,rxAirtime:x,txAirtime:p}}},[s,n,l,h,a,u]),k=e.useMemo(()=>{if(0===N.length)return"share"===a?100:10;let e=0;for(const s of N){const t=s.rx??0,a=s.tx??0;t>e&&(e=t),a>e&&(e=a)}const t=1.1*e;return"share"===a?t<=100?100:t<=500?100*Math.ceil(t/100):t<=1e3?200*Math.ceil(t/200):t<=5e3?500*Math.ceil(t/500):t<=1e4?1e3*Math.ceil(t/1e3):5e3*Math.ceil(t/5e3):Math.max(1,Math.ceil(t))},[N,a]),M=x??k,S=e.useMemo(()=>{if(null!==v&&N[v]){const e=N[v],t=e.rx??0,s=e.tx??0;return"share"===a?{rx:Ue(t),tx:Ue(s),total:Ue(t+s),isHovered:!0}:{rx:`${t.toFixed(2)}%`,tx:`${s.toFixed(2)}%`,total:`${(t+s).toFixed(2)}%`,isHovered:!0}}if("share"===a)return{rx:Ue(w.rxBytes),tx:Ue(w.txBytes),total:Ue(w.rxBytes+w.txBytes),isHovered:!1};{let e=0,t=0,s=0;for(const l of N)null===l.rx&&null===l.tx||(e+=l.rx??0,t+=l.tx??0,s++);const a=s>0?e/s:0,n=s>0?t/s:0;return{rx:`${a.toFixed(2)}%`,tx:`${n.toFixed(2)}%`,total:`${(a+n).toFixed(2)}%`,isHovered:!1}}},[v,N,w,a]),C=e.useMemo(()=>{const e=l-n,t=e/3600;return[0,.25,.5,.75,1].map(s=>{const a=new Date(1e3*(n+e*s)),l=a.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hour12:!1}),i=a.toLocaleDateString([],{weekday:"short"});return{pct:s,label:t>24?`${i} ${l}`:l,mobileHidden:.25===s||.75===s}})},[n,l]),T=e.useCallback(e=>{j(e)},[]);return 0===N.length?t.jsxs("div",{className:"h-full flex items-center justify-center text-fg-muted",children:[t.jsx(Y,{className:"w-6 h-6 mr-2 opacity-50"}),t.jsx("span",{children:"No packet data available"})]}):t.jsxs("div",{className:"flex flex-col h-full",children:[t.jsxs("div",{className:"flex-1 min-h-0 relative",children:[t.jsx("div",{className:"absolute top-0 left-0 right-0 z-10 flex items-center text-fg-secondary",style:{height:20,paddingLeft:44,paddingRight:8},children:t.jsx("div",{className:"relative w-full h-full flex items-center",children:C.map((e,s)=>t.jsxs("div",{className:"absolute flex items-center gap-0.5 sm:gap-1 type-data-xs "+(e.mobileHidden?"hidden sm:flex":""),style:{left:100*e.pct+"%",transform:0===e.pct?"translateX(0)":1===e.pct?"translateX(-100%)":"translateX(-50%)"},children:[t.jsx(c,{className:"w-2.5 h-2.5 opacity-60 hidden sm:block"}),t.jsx("span",{className:"tabular-nums",children:e.label})]},s))})}),t.jsx("div",{className:"absolute inset-0 rounded-lg overflow-hidden",style:{paddingTop:20},children:t.jsx(d,{data:N,yAxisMode:"share"===a?"share":"airtime",yMax:M,onHover:T,startTs:n,endTs:l})})]}),t.jsxs("div",{className:"flex items-center justify-between mt-1.5 sm:mt-2",style:{minHeight:p},children:[t.jsxs("div",{className:"flex items-center gap-2 sm:gap-4 type-data-xs pl-2 sm:pl-11",children:[t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx("div",{className:"w-3 sm:w-4 h-0.5",style:{backgroundColor:g}}),t.jsx("span",{className:"text-fg-secondary",children:"RX"})]}),t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx("div",{className:"w-3 sm:w-4 h-0.5",style:{backgroundColor:y}}),t.jsx("span",{className:"text-fg-secondary",children:"TX"})]}),t.jsxs("div",{className:"hidden sm:flex items-center gap-1.5",children:[t.jsx("div",{className:"w-4 h-0.5",style:{backgroundColor:b}}),t.jsx("span",{className:"text-fg-secondary",children:"Avg"})]})]}),t.jsxs("div",{className:"flex flex-wrap gap-4 sm:gap-8",children:[t.jsxs("div",{className:"flex items-end gap-2",children:[t.jsx("div",{className:"type-data-xl text-fg-primary",children:S.rx}),t.jsx(m,{color:"zinc",className:"mb-0.5 sm:mb-1",children:"RX"})]}),t.jsxs("div",{className:"flex items-end gap-2",children:[t.jsx("div",{className:"type-data-xl text-fg-primary",children:S.tx}),t.jsx(m,{color:"zinc",className:"mb-0.5 sm:mb-1",children:"TX"})]})]})]})]})}const Ke=u;function Qe({mode:s,packets:a,startTs:n,endTs:l,radioConfig:i,sortedTypes:c,aggregateShares:d,noiseFloorAnomalies:m,showNoiseFloorOverlay:u,overlayOpacity:x=.5,startLabel:p,endLabel:f,yAxisPad:g=28,lockedYMax:y,legendMinH:b}){const[v,j]=e.useState(null),[N,w]=e.useState(null),k=e.useMemo(()=>(l-n)/3600,[n,l]),M=e.useCallback(e=>{w(e)},[]),S=function(t,s,a,n,l){return e.useMemo(()=>{if(0===t.length||!l)return null;const e=t.filter(e=>e.timestamp>=s&&e.timestamp<=a);if(0===e.length)return null;const i=[],c=new Map;for(const t of e){const e=t.type??t.payload_type??-1,a=r(t);let d;if(d="airtime"===n?o(t,{spreadingFactor:l.sf,bandwidthHz:l.bw,codingRate:l.cr,preambleLength:l.preamble}):1,a<=0)continue;const m=Math.floor((t.timestamp-s)/300),u={timestamp:t.timestamp,airtimeMs:d,byteSize:a,packetType:e,bucketIndex:m};i.push(u),c.has(m)||c.set(m,[]),c.get(m).push(u)}if(0===i.length)return null;const d=[],m=[],u=[],h=new Map;if("share"===n)for(const[,t]of c)for(const e of t)h.set(e,e.byteSize);else for(const[,t]of c){const e=t.reduce((e,t)=>e+t.airtimeMs,0)/3e5*100;let s=0;for(const a of t)a.airtimeMs>s&&(s=a.airtimeMs);for(const a of t){const t=a.airtimeMs/s*e;h.set(a,t)}}for(const t of i){const e=h.get(t);void 0!==e&&(d.push(e),m.push(t.timestamp),u.push(t.packetType))}let x=m[0],p=m[0];for(let t=1;t<m.length;t++)m[t]<x&&(x=m[t]),m[t]>p&&(p=m[t]);const f=p-x||1,g=[...d].sort((e,t)=>e-t),y=g[0],b=g[g.length-1],v=Math.floor(.05*g.length),j=Math.floor(.5*g.length),N=Math.min(Math.ceil(.95*g.length),g.length-1),w=g[v],k=g[j],M=g[N],S=new Map;for(const t of d){const e=Math.round(100*t)/100;S.set(e,(S.get(e)??0)+1)}const C=S.size,T=[...S.entries()].sort((e,t)=>t[1]-e[1]).slice(0,5).map(([e,t])=>({value:e,count:t,percent:t/d.length*100}));let A;if("share"===n)A=200;else{const e=5,t=Math.ceil(b/e)*e;A=t<=10?10:t+e}const L=new Float32Array(2*d.length),F=new Float32Array(d.length),P=new Uint8Array(d.length),E=new Float32Array(d.length);for(let t=0;t<d.length;t++){const e=(m[t]-x)/f,s=1-Math.max(0,Math.min(A,d[t]))/A;L[2*t]=e,L[2*t+1]=s,F[t]=d[t],P[t]=u[t]>=0?u[t]:255,E[t]=m[t]}return{points:L,rawValues:F,packetTypes:P,timestamps:E,count:d.length,minTime:x,maxTime:p,minValue:0,maxValue:A,rawMinValue:y,rawMaxValue:b,unit:"%",stats:{p5:w,p50:k,p95:M,uniqueValues:C,topValues:T}}},[t,s,a,n,l])}(a,n,l,"share"===s?"share":"airtime",i),[C,T]=e.useState(null),A=e.useCallback((e,t)=>{j(e),T(t??null)},[]),L=e.useMemo(()=>{if(null===C||!S||0===S.count)return null;const e=S.maxTime-S.minTime||1,t=S.minTime+C*e;let s;s=k>=168?75:k>=72?35:k>=24?15:k>=3?10:5;const a=60*s/2;return{start:t-a,end:t+a}},[C,S,k]),F=e.useMemo(()=>L?new Date((L.start+L.end)/2*1e3).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hour12:!1}):null,[L]),P=e.useMemo(()=>{if(null===v||!L)return null;const e=F??"",{start:t,end:n}=L,l=a.filter(e=>e.timestamp>=t&&e.timestamp<n);if(0===l.length)return{timestamp:(t+n)/2,timeLabel:e,items:c.map(e=>({key:e.key,label:e.label,value:0,color:Ke(e.typeNum)}))};const r=new Map,d=new Map;let m=0,u=0;for(const s of l){const e=`TYPE_${s.type??s.payload_type??-1}`;if(r.set(e,(r.get(e)??0)+1),m++,i){const t=o(s,{spreadingFactor:i.sf,bandwidthHz:i.bw,codingRate:i.cr,preambleLength:i.preamble});d.set(e,(d.get(e)??0)+t),u+=t}}const h=c.map(e=>{let t;return t="airtime"===s?u>0?(d.get(e.key)??0)/u:0:m>0?(r.get(e.key)??0)/m:0,{key:e.key,label:e.label,value:t,color:Ke(e.typeNum)}});return{timestamp:(t+n)/2,timeLabel:e,items:h}},[v,L,F,a,c,s,i]);return S&&0!==S.count?t.jsxs("div",{className:"flex flex-col h-full",children:[t.jsxs("div",{className:"flex-1 min-h-0 relative",children:[t.jsx("div",{className:"absolute inset-0 rounded-lg overflow-hidden",children:t.jsx(h,{scatterData:S,yAxisMode:"share"===s?"share":"airtime",onHover:A,noiseFloorAnomalies:m,showNoiseFloorOverlay:u,overlayOpacity:x,highlightedType:N,timeRangeHours:k,yAxisMaxOverride:y})}),F&&t.jsx("div",{className:"absolute top-1 right-1 px-2 py-0.5 bg-elevated/90 rounded type-data-xs text-sys-indigo pointer-events-none",children:F}),p&&f&&t.jsxs("div",{className:"absolute bottom-0.5 left-0 right-0 flex justify-between pointer-events-none type-data-xs text-fg-muted/60",style:{paddingLeft:g},children:[t.jsx("span",{children:p}),t.jsx("span",{children:f})]})]}),t.jsx("div",{style:{minHeight:b},children:t.jsx(qe,{sortedTypes:c,highlightedType:N,onTypeHover:M,aggregateShares:d,hoverData:P})})]}):t.jsxs("div",{className:"h-full flex items-center justify-center text-fg-muted",children:[t.jsx(Y,{className:"w-6 h-6 mr-2 opacity-50"}),t.jsx("span",{children:"No packet data available"})]})}function Ze({mode:e,onChange:s}){return t.jsxs("div",{className:"toggle-group toggle-group-sm",children:[t.jsx("button",{onClick:()=>s("share"),className:"toggle-group-item "+("share"===e?"active":""),children:"Total"}),t.jsx("button",{onClick:()=>s("airtime"),className:"toggle-group-item "+("airtime"===e?"active":""),children:"Airtime"})]})}function et({smoothing:e,onChange:s}){return t.jsxs("div",{className:"toggle-group toggle-group-sm",children:[t.jsx("button",{onClick:()=>s("stats"),className:"toggle-group-item "+("stats"===e?"active":""),title:"Statistics view (scatter plot)",children:t.jsx(Fe,{className:"w-3.5 h-3.5"})}),t.jsx("button",{onClick:()=>s("trend"),className:"toggle-group-item "+("trend"===e?"active":""),title:"Trend line chart",children:t.jsx(Te,{className:"w-3.5 h-3.5"})}),t.jsx("button",{onClick:()=>s("ema"),className:"toggle-group-item "+("ema"===e?"active":""),title:"Stacked area (moderate smoothing)",children:t.jsx(Y,{className:"w-3.5 h-3.5"})}),t.jsx("button",{onClick:()=>s("ultra"),className:"toggle-group-item "+("ultra"===e?"active":""),title:"Stacked area (heavy smoothing)",children:t.jsx(_e,{className:"w-3.5 h-3.5"})}),t.jsx("button",{onClick:()=>s("mosaic"),className:"toggle-group-item "+("mosaic"===e?"active":""),title:"Mosaic view (treemap)",children:t.jsx(Le,{className:"w-3.5 h-3.5"})})]})}function tt({enabled:e,onChange:s,anomalyCount:a=0,showTuning:n=!1,onTuningChange:l}){return t.jsxs("div",{className:"relative inline-flex items-center gap-1",children:[e&&l&&t.jsx("button",{onClick:()=>l(!n),className:"toggle-group toggle-group-sm "+(n?"active":""),title:n?"Hide tuning panel":"Show tuning panel",children:t.jsx("span",{className:"toggle-group-item "+(n?"active":""),children:t.jsx(Se,{className:"w-3.5 h-3.5"})})}),t.jsx("button",{onClick:()=>s(!e),className:"toggle-group toggle-group-sm "+(e?"active":""),title:e?"Hide noise floor anomalies":"Show noise floor anomalies",children:t.jsx("span",{className:"toggle-group-item "+(e?"active":""),children:t.jsx(K,{className:"w-3.5 h-3.5"})})}),a>0&&t.jsx("span",{className:"absolute -top-2 -right-2 min-w-[18px] h-[18px] px-1 rounded-full bg-sys-red text-white text-xs font-bold flex items-center justify-center pointer-events-none z-10",children:a>99?"99+":a})]})}const st={sf:10,bw:25e4,cr:5,preamble:8};function at(e,t){const s=new Date(1e3*e),a=e=>e.toString().padStart(2,"0"),n=`${a(s.getHours())}:${a(s.getMinutes())}`;return t<=24?n:`${["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][s.getMonth()]} ${s.getDate()} ${n}`}function nt(e){return l[e]??`TYPE_${e.toString(16).toUpperCase()}`}function lt(e,t,s,a){const n=2*a+1;let l=0;for(let i=0;i<=a;i++)l+=e[Math.min(i,s-1)];for(let i=0;i<a;i++)l+=e[0];for(let i=0;i<s;i++){t[i]=l/n;const r=i-a,o=i+a+1;l-=e[Math.max(0,Math.min(r,s-1))],l+=e[Math.max(0,Math.min(o,s-1))]}}const it={ema:1800,ultra:14400},rt={ema:"sma",ultra:"gaussian"};function ot(e,t,s){const a=it[e],n=rt[e]??"sma";if(!a)return{sigma:0,window:1,handleSize:0};let l=Math.round(a/t);l=Math.max(3,Math.min(l,Math.floor(s/3))),l%2==0&&(l+=1);const i="gaussian"===n?Math.ceil(l*Math.sqrt(4/12)*3):Math.ceil(l/2);return"gaussian"===n?{sigma:l*Math.sqrt(4/12),window:l,handleSize:i}:{sigma:0,window:l,handleSize:i}}const ct=e.memo(function({packets:s,allPackets:a,startTs:l,endTs:i,parentStartTs:c,parentEndTs:d,bucketCount:m,radioConfig:u=st,mode:h="share",smoothing:f="stats",noiseFloorAnomalies:g=null,showNoiseFloorOverlay:y=!1,overlayOpacity:b=.5}){const v=x(),[j,N]=e.useState(null),[w,k]=e.useState(null),[M,S]=e.useState([]),C=e.useRef(null),T=e.useRef(0);e.useEffect(()=>{const e=Math.abs(s.length-T.current);if(0===e&&M.length>0)return;C.current&&clearTimeout(C.current);const t=e>100?50:500;return C.current=setTimeout(()=>{T.current=s.length,S(s)},t),()=>{C.current&&clearTimeout(C.current)}},[s,M.length]);const A=e.useMemo(()=>function(e,t){const s=new Map;for(const n of e){const e=n.type??n.payload_type??-1,a=o(n,{spreadingFactor:t.sf,bandwidthHz:t.bw,codingRate:t.cr,preambleLength:t.preamble}),l=s.get(e)??{count:0,airtime:0};s.set(e,{count:l.count+1,airtime:l.airtime+a})}const a=[];for(const[n,l]of s)a.push({typeNum:n,key:`TYPE_${n}`,label:nt(n),totalCount:l.count,totalAirtime:l.airtime});return a.sort((e,t)=>t.totalCount-e.totalCount)}(M,u),[M,u]),L=e.useMemo(()=>{if("ema"!==f&&"ultra"!==f)return 0;const e=(i-l)/m,{handleSize:t}=ot(f,e,m);return t},[f,l,i,m]),F=e.useMemo(()=>function(e,t,s,a,n,l,i=0){const r=s-t,c=r/a,d=1e3*c,m=r/3600,u=t-i*c,h=s+i*c,x=a+2*i,p=[];for(let o=0;o<x;o++){const e=u+o*c,t=new Date(1e3*e),s={timestamp:e,time:m>24?t.toLocaleDateString([],{weekday:"short",hour:"2-digit",minute:"2-digit",hour12:!1}):t.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hour12:!1}),counts:{},shares:{},airtimes:{},total:0,totalAirtime:0,bucketDurationMs:d};for(const a of l)s.counts[a.key]=0,s.airtimes[a.key]=0;p.push(s)}for(const f of e){const e=f.timestamp;if(e<u||e>=h)continue;const t=Math.min(Math.floor((e-u)/c),x-1),s=`TYPE_${f.type??f.payload_type??-1}`;p[t].counts[s]=(p[t].counts[s]??0)+1,p[t].total++;const a=o(f,{spreadingFactor:n.sf,bandwidthHz:n.bw,codingRate:n.cr,preambleLength:n.preamble});p[t].airtimes[s]=(p[t].airtimes[s]??0)+a,p[t].totalAirtime+=a}for(const o of p)for(const e of l)o.shares[e.key]=o.total>0?o.counts[e.key]/o.total*100:0;return{buckets:p,visibleStart:i,visibleEnd:i+a}}(M,l,i,m,u,A,L),[M,l,i,m,u,A,L]),P=e.useMemo(()=>A.reduce((e,t)=>e+t.totalCount,0),[A]),E=e.useMemo(()=>A.reduce((e,t)=>e+t.totalAirtime,0),[A]),{sortedTypes:R,aggregateShares:_}=e.useMemo(()=>{const e=new Map,t="share"===h?P:E;if(t>0)for(const s of A){const a="share"===h?s.totalCount:s.totalAirtime;e.set(s.key,a/t)}return{sortedTypes:[...A].sort((t,s)=>(e.get(s.key)??0)-(e.get(t.key)??0)),aggregateShares:e}},[A,P,E,h]),D=e.useMemo(()=>function(e,t,s,a="ultra",n,l,i){var r;const{buckets:o,visibleStart:c,visibleEnd:d}=e,m=o.length,u=s.length,h=d-c;if(0===m||0===u)return[];const x=i&&void 0!==n&&void 0!==l?(l-n)/i:(null==(r=o[0])?void 0:r.bucketDurationMs)?o[0].bucketDurationMs/1e3:240,p=Array.from({length:u},()=>new Array(m).fill(0));for(let N=0;N<m;N++){const e=o[N];if("share"===t){if(e.total>0)for(let t=0;t<u;t++)p[t][N]=(e.counts[s[t].key]??0)/e.total}else{let t=0;for(let a=0;a<u;a++)t+=e.airtimes[s[a].key]??0;if(t>0)for(let a=0;a<u;a++)p[a][N]=(e.airtimes[s[a].key]??0)/t}}const{sigma:f,window:g}=ot(a,x,h);let y;y=f>0?p.map(e=>function(e,t){const s=e.length;if(0===s)return[];if(t<.5)return[...e];const a=Math.sqrt(12*t*t/3+1);let n=Math.floor(a);n%2==0&&n--;const l=n+2,i=(12*t*t-3*n*n-12*n-9)/(-4*n-4),r=Math.round(i),o=[r>0?n:l,r>1?n:l,r>2?n:l];let c=new Float32Array(e);const d=new Float32Array(s);for(const m of o){lt(c,d,s,(m-1)/2);const e=c;c=d,d.set(e)}return Array.from(c)}(e,f)):p.map(e=>function(e,t){if(0===e.length)return[];if(t<=1)return[...e];const s=e.length,a=new Float32Array(s),n=Math.floor(t/2);let l=0,i=0;for(let r=0;r<=Math.min(n,s-1);r++)l+=e[r],i++;for(let r=0;r<s;r++){a[r]=l/i;const t=r-n,o=r+n+1;t>=0&&(l-=e[t],i--),o<s&&(l+=e[o],i++)}return Array.from(a)}(e,g));for(let N=0;N<m;N++){let e=0;for(let t=0;t<u;t++)y[t][N]=Math.max(0,y[t][N]),e+=y[t][N];if(e>0){const t=1/e;for(let e=0;e<u;e++)y[e][N]*=t}}const b=h>360?Math.ceil(h/360):1,v=Math.ceil(h/b),j=[];for(let N=0;N<v;N++){const e=c+N*b,t=Math.min(c+(N+1)*b,d),a=t-e,n=new Array(u).fill(0);for(let s=e;s<t;s++)for(let e=0;e<u;e++)n[e]+=y[e][s];for(let s=0;s<u;s++)n[s]/=a;let l=0;for(let s=0;s<u;s++)l+=n[s];if(l>0){const e=1/l;for(let t=0;t<u;t++)n[t]*=e}const i={timestamp:o[e].timestamp,time:o[e].time};for(let r=0;r<u;r++)i[s[r].key]=n[r];j.push(i)}return j}(F,h,R,f,l,i,m),[F,h,R,f,l,i,m]),$=e.useCallback(e=>N(e),[]),z=e.useCallback(e=>k(e),[]),H=e.useCallback(e=>N(e),[]),B=e.useMemo(()=>{if(null===w||!D[w])return null;const e=D[w];return{timestamp:e.timestamp,timeLabel:e.time,items:R.map(t=>({key:t.key,label:t.label,value:e[t.key]??0,color:n(t.typeNum)}))}},[w,D,R]),q=e.useMemo(()=>({timestamps:D.map(e=>e.timestamp),series:R.map(e=>({key:e.key,label:e.label,color:n(e.typeNum),values:D.map(t=>t[e.key]??0)}))}),[D,R]),I=a&&void 0!==c&&void 0!==d&&(l!==c||i!==d),O=e.useMemo(()=>{if(I&&a&&void 0!==c&&void 0!==d)return function(e,t,s,a,n){const l=Math.max(1,Math.ceil((s-t)/300));if("airtime"===a){const a=new Float64Array(l);for(const r of e){const e=r.timestamp;e<t||e>=s||(a[Math.min(Math.floor((e-t)/300),l-1)]+=o(r,{spreadingFactor:n.sf,bandwidthHz:n.bw,codingRate:n.cr,preambleLength:n.preamble}))}let i=0;for(let e=0;e<l;e++){const t=a[e]/3e5*100;t>i&&(i=t)}return Math.max(1,Math.ceil(1.1*i))}{let a=0;for(const n of e){const e=n.timestamp;if(e<t||e>=s)continue;const l=r(n);l>a&&(a=l)}return a<=200?200:50*Math.ceil(1.1*a/50)}}(a,c,d,h,u)},[I,a,c,d,h,u]);if(0===M.length)return 0===s.length?t.jsxs("div",{className:"h-full flex items-center justify-center text-fg-muted",children:[t.jsx(Y,{className:"w-6 h-6 mr-2 opacity-50"}),t.jsx("span",{children:"No packet data available"})]}):null;if("mosaic"===f)return t.jsx(Ye,{sortedTypes:R,aggregateShares:_,mode:h});const W=(i-l)/3600,G=at(l,W),X=at(i,W);return"stats"===f?t.jsx(Qe,{mode:h,packets:M,startTs:l,endTs:i,radioConfig:u,sortedTypes:R,aggregateShares:_,noiseFloorAnomalies:g,showNoiseFloorOverlay:y,overlayOpacity:b,startLabel:G,endLabel:X,yAxisPad:28,lockedYMax:O,legendMinH:80}):"trend"===f?t.jsx(Je,{packets:M,mode:h,startTs:l,endTs:i,radioConfig:u,bucketCount:m,lockedYMax:O,legendMinH:80}):t.jsxs("div",{className:"flex flex-col h-full",children:[t.jsxs("div",{className:"flex-1 min-h-0 relative",children:[t.jsx("div",{className:"absolute inset-0 rounded-lg overflow-hidden",children:t.jsx(p,{timestamps:q.timestamps,series:q.series,highlightedKey:j,cursorColor:v.cursor,onHover:z,onSeriesHover:H,overlayLine:null,startTs:l,endTs:i})}),t.jsxs("div",{className:"absolute bottom-0.5 left-0 right-0 flex justify-between pointer-events-none type-data-xs text-fg-muted/60",style:{paddingLeft:32},children:[t.jsx("span",{children:G}),t.jsx("span",{children:X})]})]}),t.jsx("div",{style:{minHeight:80},children:t.jsx(qe,{sortedTypes:R,highlightedType:j,onTypeHover:$,aggregateShares:_,hoverData:B})})]})}),dt={"1x":1,"2x":2,"4x":4,"8x":8,"16x":16,"36x":36},mt=[1,5,10,25,50,100,150],ut=22.5*Math.PI/180,ht=Math.sin(ut),xt=Math.cos(ut);function pt(e,t,s,a){const n=Math.PI/180,l=(a-t)*n,i=e*n,r=s*n,o=Math.sin(l)*Math.cos(r),c=Math.cos(i)*Math.sin(r)-Math.sin(i)*Math.cos(r)*Math.cos(l);return(180*Math.atan2(o,c)/Math.PI+360)%360}function ft(e,t,s,a){const n=Math.PI/180,l=(s-e)*n,i=(a-t)*n,r=Math.sin(l/2)**2+Math.cos(e*n)*Math.cos(s*n)*Math.sin(i/2)**2;return 12742*Math.atan2(Math.sqrt(r),Math.sqrt(1-r))}const gt=[{min:10,label:"Excellent"},{min:7,label:"Very Good"},{min:4,label:"Good"},{min:1,label:"Fair+"},{min:-2,label:"Fair"},{min:-5,label:"Fair-"},{min:-8,label:"Poor"},{min:-11,label:"Bad"},{min:-1/0,label:"Critical"}];function yt(e,t){return t[j(e)]||"#808080"}const bt=e.memo(function({neighbors:s,quickNeighbors:a,localLat:n,localLon:l,onStatsChange:r,title:o,badge:c,stats:d}){const[u,h]=e.useState(null),[x,p]=e.useState(new Set),[j,N]=e.useState({width:0,height:0}),[w,k]=e.useState("1x"),[M,S]=e.useState(1),C=e.useRef(null),T=e.useRef({}),A=e.useRef(null),L=e.useRef(M);L.current=M;const F=f(),P=g(),E=y(),R=b(),_=i(),D=R?E.primary:E.secondary,$=R?.15:.4,z=R?.08:.25,H=R?_.blue:E.primary;e.useEffect(()=>{const e=A.current;if(!e)return;const t=new ResizeObserver(e=>{for(const t of e){const{width:e,height:s}=t.contentRect;e>0&&s>0&&N({width:e,height:s})}});t.observe(e);const s=e.getBoundingClientRect();return s.width>0&&s.height>0&&N({width:s.width,height:s.height}),()=>t.disconnect()},[]);const B=e.useMemo(()=>{const e=new Set;if(a)for(const t of a)e.add(t.hash);return e},[a]),q=e.useMemo(()=>{const e=new Map;if(a)for(const t of a)e.set(t.hash,{snr:t.avgSnr,rssi:t.avgRssi});return e},[a]),{processedNeighbors:I,maxDistance:O,totalNeighbors:W,zeroHopCount:G}=e.useMemo(()=>{const e=[];for(const[a,i]of Object.entries(s)){if(!i.latitude||!i.longitude||0===i.latitude||0===i.longitude)continue;if(!B.has(a))continue;const t=pt(n,l,i.latitude,i.longitude),s=ft(n,l,i.latitude,i.longitude),r=q.get(a);e.push({hash:a.slice(0,8),name:i.node_name||i.name||"Unknown",snr:(null==r?void 0:r.snr)??i.snr??null,rssi:(null==r?void 0:r.rssi)??i.rssi??null,bearing:t,distance:s,normalizedDistance:0,lastSeen:i.last_seen,isZeroHop:!0})}const t=1.08*(e.length>0?Math.max(...e.map(e=>e.distance)):0);return e.sort((e,t)=>(e.snr??-1/0)-(t.snr??-1/0)),{processedNeighbors:e,maxDistance:t,totalNeighbors:e.length,zeroHopCount:e.length}},[s,n,l,B,q]);e.useEffect(()=>{null==r||r({zeroHopCount:G,totalCount:W,maxDistanceKm:O})},[G,W,O]),e.useEffect(()=>{const e=dt[w],t=L.current;C.current&&cancelAnimationFrame(C.current);const s=performance.now(),a=n=>{const l=n-s,i=Math.min(l/400,1),r=J(i);S(t+(e-t)*r),C.current=i<1?requestAnimationFrame(a):null};return C.current=requestAnimationFrame(a),()=>{C.current&&cancelAnimationFrame(C.current)}},[w]);const X=O/M,V=e.useMemo(()=>mt.filter(e=>e<=1.1*X),[X]);e.useEffect(()=>{const e=[];for(const s of I){const t=T.current[s.hash];void 0!==t&&t!==s.lastSeen&&e.push(s.hash),T.current[s.hash]=s.lastSeen}if(0===e.length)return;queueMicrotask(()=>{p(t=>new Set([...t,...e]))});const t=setTimeout(()=>{p(t=>{const s=new Set(t);return e.forEach(e=>s.delete(e)),s})},600);return()=>clearTimeout(t)},[I]);const Y=0!==n&&0!==l,K=e.useMemo(()=>{const{width:e,height:t}=j,s=o?22:0,a=e/2,n=t/2+s,l=t-2*s,i=Math.min(e,l),r=Math.max(10,i/2-6);return{width:e,height:t,centerX:a,centerY:n,radius:Math.max(10,r-8),labelRadius:r}},[j,o]),{width:Q,height:Z,centerX:ee,centerY:te,radius:se,labelRadius:ae}=K,ne=e.useId(),le=e.useCallback((e,t)=>{const s=e*Math.PI/180;return{x:ee+se*t*Math.sin(s),y:te-se*t*Math.cos(s)}},[ee,te,se]),ie=e.useCallback(e=>{const t={N:0,NE:45,E:90,SE:135,S:180,SW:225,W:270,NW:315}[e]*Math.PI/180;return{x:ee+ae*Math.sin(t),y:te-ae*Math.cos(t)}},[ee,te,ae]),re=e.useCallback(e=>{h(e)},[]),oe=e.useCallback(e=>{k(e)},[]),ce=e.useCallback(e=>O<=0?0:e/O*M,[O,M]),de=e=>`${e}km`,me=e.useMemo(()=>{const e=[{x:ee,y:te-ae},{x:ee+ae*Math.SQRT1_2,y:te-ae*Math.SQRT1_2}],t=V.map(e=>{const t=e/O*M;return{km:e,scale:t,lx:ee+se*t*ht,ly:te-se*t*xt}}).filter(e=>e.scale<=1.05&&e.scale>=.02).sort((e,t)=>t.km-e.km),s=[];for(const a of t){const t=s.some(e=>{const t=e.lx-a.lx,s=e.ly-a.ly;return Math.sqrt(t*t+s*s)<28}),n=e.some(e=>{const t=e.x-a.lx,s=e.y-a.ly;return Math.sqrt(t*t+s*s)<28});t||n||s.push(a)}return s},[V,O,M,ee,te,se,ae]),ue=j.width>0&&j.height>0;return Y?0===W?t.jsxs("div",{ref:A,className:"flex flex-col items-center justify-center h-full text-fg-secondary",children:[t.jsx(U,{className:"w-8 h-8 mb-2 opacity-50"}),t.jsx("p",{children:"No nodes with location data"})]}):t.jsxs("div",{className:"flex h-full w-full overflow-hidden",children:[t.jsxs("div",{ref:A,className:"relative flex-1 min-w-0 h-full overflow-hidden",children:[o&&t.jsx("div",{className:"absolute top-0 left-0 right-0 z-20 pointer-events-none",children:t.jsx("div",{className:"flex flex-col gap-1 flex-shrink-0 px-4 pt-4 pb-2 sm:px-5 sm:pt-5",children:t.jsxs("div",{className:"flex items-center justify-between gap-2 min-h-[32px] whitespace-nowrap",children:[t.jsxs("div",{className:"flex items-center gap-3 pointer-events-auto flex-shrink-0",children:[t.jsx("span",{className:"icon-md flex items-center justify-center text-icon-card-title",children:t.jsx(U,{className:"w-4 h-4"})}),t.jsx("span",{className:"type-micro",children:o}),c&&t.jsx(m,{color:"zinc",children:c})]}),d&&t.jsx("div",{className:"pointer-events-auto hidden sm:flex items-center gap-1.5 min-w-0 overflow-hidden",children:d})]})})}),ue&&t.jsxs("svg",{width:Q,height:Z,className:"absolute inset-0 z-0",children:[t.jsxs("defs",{children:[t.jsx("style",{children:"\n                @keyframes neighbor-blink-scale {\n                  0%, 100% {\n                    transform: scale(1);\n                    opacity: 0;\n                  }\n                  50% {\n                    transform: scale(1.3);\n                    opacity: 0.8;\n                  }\n                }\n                .neighbor-blink-ring {\n                  transform-origin: center;\n                  animation: neighbor-blink-scale 600ms ease-out forwards;\n                }\n              "}),t.jsx("clipPath",{id:ne,children:t.jsx("circle",{cx:ee,cy:te,r:se})})]}),V.map(e=>{const s=ce(e);if(s>1.05||s<.02)return null;const a=me.some(t=>t.km===e),n=ee+se*s*ht,l=te-se*s*xt;return t.jsxs("g",{children:[t.jsx("circle",{cx:ee,cy:te,r:se*s,fill:"none",stroke:D,strokeOpacity:$,strokeWidth:1}),a&&t.jsx("text",{x:n+4,y:l-2,textAnchor:"start",dominantBaseline:"auto",fill:E.secondary,fontSize:10,fontFamily:v,children:de(e)})]},`ring-${e}`)}),["N","E","S","W"].map(e=>{const s={N:0,E:90,S:180,W:270}[e]*Math.PI/180;return t.jsx("line",{x1:ee,y1:te,x2:ee+se*Math.sin(s),y2:te-se*Math.cos(s),stroke:D,strokeOpacity:$,strokeWidth:1,strokeDasharray:"4 4"},e)}),["NE","SE","SW","NW"].map(e=>{const s={NE:45,SE:135,SW:225,NW:315}[e]*Math.PI/180;return t.jsx("line",{x1:ee,y1:te,x2:ee+se*Math.sin(s),y2:te-se*Math.cos(s),stroke:D,strokeOpacity:z,strokeWidth:1,strokeDasharray:"4 4"},`diag-${e}`)}),["N","E","S","W"].map(e=>{const s=ie(e),a="E"===e?"end":"W"===e?"start":"middle",n="N"===e?"hanging":"S"===e?"auto":"middle";return t.jsx("text",{x:s.x,y:s.y,textAnchor:a,dominantBaseline:n,fill:H,fontSize:10,fontWeight:700,fontFamily:v,"aria-hidden":"true",children:e},e)}),["NE","SE","SW","NW"].map(e=>{const s=ie(e),a="NE"===e||"SE"===e?"end":"start",n="NE"===e||"NW"===e?"hanging":"auto";return t.jsx("text",{x:s.x,y:s.y,textAnchor:a,dominantBaseline:n,fill:H,fontSize:9,fontWeight:600,fontFamily:v,"aria-hidden":"true",children:e},e)}),t.jsx("circle",{cx:ee,cy:te,r:5,fill:P.chart6,stroke:R?"rgba(255,255,255,0.3)":"rgba(0,0,0,0.2)",strokeWidth:1,role:"img","aria-label":"Local node"}),t.jsx("g",{clipPath:`url(#${ne})`,children:I.map(e=>{const s=O>0?e.distance/O*M:0;if(s>1)return null;const{x:a,y:n}=le(e.bearing,s),l=null!==e.snr?yt(e.snr,F):"#808080",i=(null==u?void 0:u.hash)===e.hash,r=x.has(e.hash);return t.jsxs("g",{role:"img","aria-label":`${e.name}: ${e.distance.toFixed(1)}km ${e.bearing.toFixed(0)}°`,children:[r&&t.jsx("circle",{cx:a,cy:n,r:10.5,fill:"none",stroke:R?"rgba(255,255,255,0.9)":"rgba(0,0,0,0.7)",strokeWidth:2,className:"neighbor-blink-ring"}),i&&t.jsx("circle",{cx:a,cy:n,r:10.5,fill:l,opacity:.3}),t.jsx("circle",{cx:a,cy:n,r:i?7:5,fill:l,stroke:R?"rgba(0,0,0,0.5)":"rgba(0,0,0,0.25)",strokeWidth:1,style:{cursor:"pointer",transition:"r 0.15s"},onMouseEnter:()=>re(e),onMouseLeave:()=>re(null)})]},e.hash)})})]}),u&&t.jsxs("div",{className:"absolute bg-tooltip-bg border border-edge-subtle rounded-lg px-3 py-2 text-sm pointer-events-none z-10 shadow-xl",style:{left:"50%",bottom:8,transform:"translateX(-50%)"},children:[t.jsx("div",{className:"font-medium text-fg-primary",children:u.name}),t.jsx("div",{className:"type-data-xs text-fg-secondary",children:u.hash}),null!==u.snr?t.jsx("div",{className:"flex gap-3 mt-1 text-xs",children:t.jsxs("span",{children:[t.jsx("span",{className:"text-fg-secondary",children:"SNR:"})," ",t.jsxs("span",{className:"tabular-nums",style:{color:yt(u.snr,F)},children:[u.snr.toFixed(1)," dB"]}),t.jsxs("span",{className:"text-fg-secondary ml-1",children:["(",(he=u.snr,(null==(xe=gt.find(e=>he>=e.min))?void 0:xe.label)??"Critical"),")"]})]})}):t.jsx("div",{className:"text-xs text-fg-secondary mt-1",children:"No SNR data"}),t.jsxs("div",{className:"flex gap-3 text-xs",children:[t.jsxs("span",{children:[t.jsx("span",{className:"text-fg-secondary",children:"Distance:"})," ",t.jsxs("span",{className:"tabular-nums text-fg-primary",children:[u.distance.toFixed(2)," km"]})]}),t.jsxs("span",{children:[t.jsx("span",{className:"text-fg-secondary",children:"Bearing:"})," ",t.jsxs("span",{className:"tabular-nums text-fg-primary",children:[u.bearing.toFixed(0),"°"]})]})]})]})]}),t.jsx("div",{className:"flex flex-col gap-1 px-1.5 py-2 flex-shrink-0",role:"group","aria-label":"Zoom level",children:["1x","2x","4x","8x","16x","36x"].map(e=>t.jsx("button",{onClick:()=>oe(e),"aria-pressed":w===e,className:"flex flex-1 items-center justify-center min-w-[44px] sm:min-w-[32px] text-xs font-medium rounded transition-colors "+(w===e?"bg-sys-blue/20 text-sys-blue":"bg-subtle-fill/80 text-fg-secondary hover:bg-subtle-fill-strong hover:text-fg-primary"),children:e},e))})]}):t.jsxs("div",{ref:A,className:"flex flex-col items-center justify-center h-full text-fg-secondary",children:[t.jsx(U,{className:"w-8 h-8 mb-2 opacity-50"}),t.jsx("p",{children:"Local node coordinates not configured"}),t.jsx("p",{className:"text-xs mt-1",children:"Set latitude/longitude in config to enable"})]});var he,xe}),vt={repeater:"var(--sys-blue)",companion:"var(--sys-cyan)",room_server:"var(--sys-indigo)"};function jt(e){if(e.contact_type){const t=e.contact_type.toLowerCase();if("repeater"===t||"rep"===t)return"repeater";if("room server"===t||"room_server"===t||"room"===t||"server"===t)return"room_server";if("companion"===t||"client"===t||"cli"===t)return"companion"}return e.is_repeater?"repeater":"companion"}const Nt=e.memo(function({neighbors:s}){const a=e.useMemo(()=>{const e={repeater:0,companion:0,room_server:0};for(const a of Object.values(s)){const t=jt(a);e[t]=(e[t]||0)+1}const t=Object.values(e).reduce((e,t)=>e+t,0);return{items:[{label:"Repeaters",count:e.repeater,percent:0,color:vt.repeater},{label:"Companions",count:e.companion,percent:0,color:vt.companion},{label:"Room Servers",count:e.room_server,percent:0,color:vt.room_server}].map(e=>({...e,percent:t>0?e.count/t*100:0})).filter(e=>e.count>0).sort((e,t)=>t.count-e.count),total:t}},[s]);return 0===a.total?t.jsx("div",{className:"h-full flex items-center justify-center text-fg-muted type-body-sm",children:"No neighbors discovered yet"}):t.jsxs("div",{className:"h-full flex flex-col",children:[t.jsx("div",{className:"flex-1 flex flex-col justify-evenly",children:a.items.map(e=>t.jsxs("div",{className:"flex flex-col gap-1.5",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("span",{className:"type-data-sm text-fg-secondary",children:e.label}),t.jsxs("span",{className:"type-data-sm text-fg-secondary tabular-nums",children:[e.count," ",t.jsxs("span",{className:"text-fg-secondary/60",children:["(",e.percent.toFixed(0),"%)"]})]})]}),t.jsx("div",{className:"h-2.5 bg-elevated overflow-hidden",children:t.jsx("div",{className:"h-full transition-all duration-500 ease-out",style:{width:`${e.percent}%`,backgroundColor:e.color,minWidth:e.count>0?"4px":"0"}})})]},e.label))}),t.jsxs("div",{className:"flex items-center justify-between pt-2 border-t border-edge-subtle",children:[t.jsx("span",{className:"type-data-xs text-fg-secondary",children:"Total Nodes"}),t.jsx("span",{className:"type-data-sm text-fg-primary font-medium tabular-nums",children:a.total})]})]})});function wt({children:s,minHeight:a="100%",rootMargin:n="200px 0px",keepMounted:l=!0,className:i=""}){const r=e.useRef(null),[o,c]=e.useState(!1),[d,m]=e.useState(!1);e.useEffect(()=>{const e=r.current;if(!e)return;const t=new IntersectionObserver(([e])=>{const t=e.isIntersecting;m(t),t&&c(!0)},{rootMargin:n,threshold:0});return t.observe(e),()=>{t.disconnect()}},[n]);const u=d||l&&o;return t.jsx("div",{ref:r,className:`h-full w-full ${i}`,style:{minHeight:a},children:u?s:t.jsx("div",{className:"h-full w-full flex items-center justify-center text-fg-muted/50",children:t.jsx("div",{className:"animate-pulse text-xs",children:"Loading chart..."})})})}const kt={excellent:"text-signal-excellent",good:"text-signal-good",fair:"text-signal-fair",poor:"text-sys-blue"},Mt={excellent:"bg-signal-excellent/10",good:"bg-signal-good/10",fair:"bg-signal-fair/10",poor:"bg-sys-blue/10"};function St(){const s=N(),a=w(),[n,l]=e.useState(null),i=e.useCallback((e,t)=>{l({prefix:e,candidateHashes:t})},[]),r=e.useCallback(()=>{l(null)},[]);if(!a)return t.jsxs(ee,{neomorphic:!0,children:[t.jsx(re,{icon:t.jsx(ce,{}),title:"Prefix Conflicts"}),t.jsx("div",{className:"flex-1 flex items-center justify-center",children:t.jsxs("div",{className:"text-center text-fg-secondary",children:[t.jsx(k,{className:"w-8 h-8 mx-auto mb-2 opacity-50"}),t.jsx("p",{className:"type-data-xs",children:"No topology data available"}),t.jsx("p",{className:"type-data-xs opacity-70",children:"Run deep analysis to see stats"})]})})]});const o=(c=s.avgConfidence)>=.9?"excellent":c>=.7?"good":c>=.5?"fair":"poor";var c;const d=(u=s.collisionRate)<=10?"excellent":u<=25?"good":"poor";var u;const h="poor"===o||"poor"===d?"poor":"fair"===o||"fair"===d?"fair":"good"===o||"good"===d?"good":"excellent",x="excellent"===h||"good"===h?Ae:me;return t.jsxs(ee,{neomorphic:!0,className:"flex flex-col overflow-hidden",children:[t.jsx(re,{icon:t.jsx(ce,{}),title:"Prefix Conflicts",badgeColor:"zinc",actions:"poor"===h?t.jsxs(m,{color:"red",children:[t.jsx(me,{className:"w-3 h-3"}),"Needs Attention"]}):t.jsxs("div",{className:`flex items-center gap-1.5 px-2.5 py-1 rounded-full ${Mt[h]}`,children:[t.jsx(x,{className:`w-3.5 h-3.5 ${kt[h]}`}),t.jsx("span",{className:`type-data-xs font-medium ${kt[h]}`,children:"excellent"===h?"Excellent":"good"===h?"Good":"Fair"})]})}),t.jsxs("div",{className:"flex-1 flex flex-col min-h-0",children:[t.jsxs("div",{className:"grid grid-cols-3 gap-1.5 sm:gap-2 py-3 sm:py-4",children:[t.jsxs("div",{className:"flex flex-col items-center cursor-help bg-subtle-fill radius-inner sm:radius-inset py-2 sm:py-3 px-1.5 sm:px-2",title:"Total unique 2-character prefixes observed in packet paths.",children:[t.jsx(Q,{value:s.totalPrefixes,className:"type-data-hero text-fg-primary",priority:"low"}),t.jsx("span",{className:"type-data-xs sm:type-data-sm text-fg-secondary mt-0.5 sm:mt-1",children:"Prefixes"})]}),t.jsxs("div",{className:"flex flex-col items-center cursor-help bg-subtle-fill radius-inner sm:radius-inset py-2 sm:py-3 px-1.5 sm:px-2",title:"Prefixes that map to exactly one known node. No disambiguation needed.",children:[t.jsx(Q,{value:s.unambiguousPrefixes,className:"type-data-hero text-fg-primary",priority:"low"}),t.jsx("span",{className:"type-data-xs sm:type-data-sm text-fg-secondary mt-0.5 sm:mt-1",children:"Unique"})]}),t.jsxs("div",{className:"flex flex-col items-center cursor-help radius-inner sm:radius-inset py-2 sm:py-3 px-1.5 sm:px-2 "+(s.collisionPrefixes>0?"bg-sys-blue/15":"bg-subtle-fill"),title:"Prefixes matching multiple known nodes. Click a prefix below to explore candidates.",children:[t.jsx(Q,{value:s.collisionPrefixes,className:"type-data-hero "+(s.collisionPrefixes>0?"text-sys-blue":"text-fg-primary"),priority:"low"}),t.jsx("span",{className:"type-data-xs sm:type-data-sm mt-0.5 sm:mt-1 "+(s.collisionPrefixes>0?"text-sys-blue":"text-fg-secondary"),children:"Conflicts"})]})]}),s.highCollisionPrefixes.length>0&&t.jsxs("div",{children:[t.jsx("div",{className:"type-data-xs text-fg-secondary mb-1.5",children:"Problem Prefixes"}),t.jsx("div",{className:"flex flex-wrap gap-1.5 content-start",children:s.highCollisionPrefixes.map(({prefix:e,candidateCount:s,candidateHashes:a})=>t.jsxs("button",{type:"button",onClick:()=>i(e,a),className:"inline-flex items-center gap-0.5 group",title:`${s} candidates - click to explore`,children:[t.jsx(ne,{children:e}),t.jsxs("span",{className:"text-fg-muted type-data-xs group-hover:text-fg-secondary transition-colors",children:["×",s]})]},e))})]}),0===s.lowConfidencePrefixes.length&&0===s.collisionPrefixes&&t.jsx("div",{className:"flex-1 flex items-center",children:t.jsxs("div",{className:"flex items-center gap-1.5",children:[t.jsx(Ae,{className:"w-3.5 h-3.5 text-signal-excellent"}),t.jsx("span",{className:"type-data-xs text-signal-excellent",children:"All prefixes uniquely identified"})]})}),t.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-4 mt-auto pt-3",children:[t.jsxs("div",{className:"flex items-center gap-2 cursor-help",title:"Average confidence score across all disambiguated prefixes. Higher = more certain node identification.",children:[t.jsx("span",{className:"type-data-xs text-fg-secondary",children:"Confidence"}),t.jsxs("span",{className:`data-box ${kt[o]}`,children:[(100*s.avgConfidence).toFixed(1),"%"]})]}),t.jsxs("div",{className:"flex items-center gap-2 cursor-help",title:"Percentage of 2-character prefixes that match multiple known nodes. Lower is better.",children:[t.jsx("span",{className:"type-data-xs text-fg-secondary",children:"Collisions"}),t.jsxs("span",{className:`data-box ${kt[d]}`,children:[s.collisionRate.toFixed(1),"%"]})]})]})]}),t.jsx(le,{isOpen:!!n,prefix:(null==n?void 0:n.prefix)||"",candidateHashes:(null==n?void 0:n.candidateHashes)||[],onClose:r})]})}function Ct({icon:e,label:s,value:a,sublabel:n,highlight:l,tooltip:i}){return t.jsxs("div",{className:"flex items-center justify-between gap-2 py-1.5 "+(i?"cursor-help":""),title:i,children:[t.jsxs("div",{className:"flex items-center gap-1.5 sm:gap-2 min-w-0",children:[t.jsx("span",{className:"icon-xs text-icon-widget flex-shrink-0",children:e}),t.jsx("span",{className:"type-body-sm text-fg-secondary truncate",children:s})]}),t.jsxs("div",{className:"flex items-center gap-1 sm:gap-1.5 flex-shrink-0",children:[t.jsx("span",{className:"data-box",style:l?{"--data-box-color":"var(--sys-blue)"}:void 0,children:a}),n&&t.jsx("span",{className:"type-data-xs text-fg-secondary hidden sm:inline",children:n})]})]})}function Tt(){const e=M(),s=S().length;if(!e||0===e.totalPaths)return null;const{totalPaths:a,pathsWithGhosts:n,observationOverrideCount:l,tracePacketsProcessed:i,pathPacketsProcessed:r,distantEdgesDiscovered:o,duplicateGroupsFound:c,duplicatePathsUnique:d,echolocationEdgesInferred:m}=e,u=a>0?((a-n)/a*100).toFixed(1):"0",h=a>0?(l/a*100).toFixed(1):"0",x=i+r,p=x>0||o>0,f=c>0||m>0;return t.jsxs(ee,{neomorphic:!0,children:[t.jsx(re,{title:"Path Decoder",icon:t.jsx(de,{}),badge:s>0?`${s} hidden`:void 0,badgeColor:"zinc"}),t.jsxs(oe,{children:[t.jsxs("div",{children:[t.jsx(Ct,{icon:t.jsx(Pe,{className:"w-3.5 h-3.5"}),label:"Traceable",value:`${u}%`,sublabel:`of ${a.toLocaleString()} paths`,tooltip:"Percentage of packet journeys where every hop was identified. Higher = better visibility into how traffic flows through your mesh."}),t.jsx(Ct,{icon:t.jsx(Re,{className:"w-3.5 h-3.5"}),label:"Learning Rate",value:`${h}%`,sublabel:"adapted",tooltip:"How often real traffic patterns improved our predictions over geography alone. Higher values mean the decoder is learning your mesh's actual behavior — which routes are preferred, which nodes are most active."})]}),p&&t.jsxs("div",{className:"mt-3",children:[t.jsx("p",{className:"type-micro mb-2",children:"Beyond Line-of-Sight"}),t.jsxs("div",{children:[t.jsx(Ct,{icon:t.jsx(Ee,{className:"w-3.5 h-3.5"}),label:"Route Reports",value:x.toLocaleString(),sublabel:i>0?`(${i} TRACE)`:void 0,tooltip:"TRACE/PATH packets from distant nodes share their routing tables. This reveals connections we can't directly observe — mapping parts of the mesh we don't touch."}),t.jsx(Ct,{icon:t.jsx(ue,{className:"w-3.5 h-3.5"}),label:"Remote Links",value:o.toLocaleString(),highlight:o>0,tooltip:"Node-to-node connections discovered from route reports. These links exist outside our RF range but help complete the topology picture."})]})]}),f&&t.jsx(Ct,{icon:t.jsx(C,{className:"w-3.5 h-3.5"}),label:"Multi-Path Packets",value:c.toLocaleString(),sublabel:d>0?`(${d} routes)`:void 0,tooltip:"Packets received via multiple paths simultaneously. Like sonar, these 'echoes' reveal redundant routes — important for understanding mesh resilience."}),s>0&&t.jsx(Ct,{icon:t.jsx(T,{className:"w-3.5 h-3.5 text-sys-blue"}),label:"Ghost Repeaters",value:s,highlight:!0,tooltip:"High-confidence hidden repeaters: appear in 10+ paths, have 2+ known neighbors, ≥30% confidence, and plausible location. View them on the Contacts map."})]})]})}const At=new Set(["Duplicate","Empty payload","Path too long","Unknown"]),Lt={excellent:"bg-status-success",good:"bg-sys-blue",fair:"bg-status-warning",poor:"bg-status-danger"};function Ft({packets:s,rangeMinutes:a,rangeHours:n,timeRangeLabel:l,isLoaded:i=!0}){const r=e.useMemo(()=>function(e,t){const s=Date.now()/1e3,a=60*t,n=s-a,l=a/24,i=new Array(24).fill(0),r=new Array(24).fill(0);let o=0,c=0,d=0,m=0;for(const h of e){if("tx_local"===h.packet_origin)continue;const e=h.timestamp;if(e<n||e>s)continue;o++;const t=Math.min(23,Math.floor((e-n)/l));r[t]++,h.transmitted||"tx_forward"===h.packet_origin?(c++,i[t]++):(h.is_duplicate||"Duplicate"===h.drop_reason)&&d++,h.drop_reason&&At.has(h.drop_reason)&&m++}const u=[];for(let h=0;h<24;h++){const e=r[h],t=i[h];u.push({count:e>0?Math.round(t/e*100):0,timestamp:1e3*(n+h*l)})}return{totalRx:o,forwarded:c,duplicates:d,waste:m,efficiency:o>0?c/o*100:0,duplicateRate:o>0?d/o*100:0,wasteRate:o>0?m/o*100:0,sparkline:u}}(s,a),[s,a]),[o,c]=e.useState(null),d=e.useCallback(async()=>{try{const e=await A(n);e.success&&e.data&&c(e.data.count)}catch{}},[n]);e.useEffect(()=>{d()},[d]);const m=(u=r.efficiency)>=90?"excellent":u>=75?"good":u>=60?"fair":"poor";var u;const h=r.totalRx>0;return t.jsx(ee,{neomorphic:!0,isLoaded:i,skeletonType:"chart",children:i&&t.jsxs(t.Fragment,{children:[t.jsx(re,{icon:t.jsx(xe,{}),title:"Packet Health",badge:l,badgeColor:"zinc"}),t.jsx(oe,{children:t.jsxs("div",{className:"flex flex-col h-full",children:[t.jsxs("div",{className:"flex items-baseline gap-2",children:[t.jsxs("div",{className:"type-data-xl text-fg-primary",children:[h?t.jsx(Q,{value:Math.round(10*r.efficiency)/10,className:"font-mono tabular-nums",priority:"medium",format:{minimumFractionDigits:1,maximumFractionDigits:1}}):t.jsx("span",{className:"opacity-30",children:"—"}),t.jsx("span",{className:"type-data-sm text-fg-muted ml-0.5",children:"%"})]}),h&&t.jsx("div",{className:`w-2 h-2 rounded-full ${Lt[m]}`})]}),t.jsx("div",{className:"type-micro mb-2 cursor-help",title:"Forwarded packets / total received. CRC failures, garbled packets, and RF collisions that destroy packets before reaching software are not included in this ratio — see CRC Errors for hardware-level failures.",children:"FORWARDING RATE"}),t.jsx("div",{className:"flex-1 min-h-[28px] max-h-[48px] mb-2",children:t.jsx(he,{data:r.sparkline,width:9999,height:36,color:"var(--sys-blue)",className:"w-full"})}),t.jsxs("div",{className:"flex gap-2 sm:gap-3 mt-auto",children:[t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsx("div",{className:"data-box-label",children:"Dupes"}),t.jsx("div",{className:"data-box data-box-fill data-box-left",children:h?`${r.duplicateRate.toFixed(1)}%`:"—"})]}),t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsx("div",{className:"data-box-label",children:"Waste"}),t.jsx("div",{className:"data-box data-box-fill data-box-left",children:h?`${r.wasteRate.toFixed(1)}%`:"—"})]}),null!==o&&o>0&&t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsxs("div",{className:"data-box-label flex items-center gap-1",children:[t.jsx(me,{className:"w-3 h-3 text-status-warning"}),"CRC"]}),t.jsx("div",{className:"data-box data-box-fill data-box-left text-status-warning",children:o})]})]})]})})]})})}function Pt(e,t){const s=new Date(1e3*e),a=e=>e.toString().padStart(2,"0"),n=`${a(s.getHours())}:${a(s.getMinutes())}`;return t<=24?n:`${["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][s.getMonth()]} ${s.getDate()} ${n}`}const Et=[{type:"repeater",label:"Repeater",icon:L,color:"text-sys-blue"},{type:"companion",label:"Companion",icon:ie,color:"text-fg-muted"},{type:"room_server",label:"Room",icon:ve,color:"text-sys-pink"},{type:"unknown",label:"Unknown",icon:fe,color:"text-sys-amber"}],Rt=60,_t=.005;function Dt({min:s,max:a,valueStart:n,valueEnd:l,onChange:i}){const r=e.useRef(null),[o,c]=e.useState(null),d=e.useRef({valueStart:n,valueEnd:l,min:s,max:a});d.current={valueStart:n,valueEnd:l,min:s,max:a};const m=e.useRef({offset:0,width:0}),u=a-s||1,h=u/3600,x=n??s,p=l??a,f=(x-s)/u*100,g=(p-s)/u*100,y=null!==n||null!==l,b=e.useCallback(e=>{const t=r.current.getBoundingClientRect(),s=Math.max(0,Math.min(1,(e-t.left)/t.width)),{min:a,max:n}=d.current;return Math.round(a+s*(n-a||1))},[]),v=e.useCallback((e,t)=>{t.preventDefault(),t.stopPropagation();const s=t.currentTarget;s.setPointerCapture(t.pointerId),c(e);const a=t=>{const s=b(t.clientX),{valueStart:a,valueEnd:n,min:l,max:r}=d.current,o=r-l||1;if("start"===e){const e=Math.min(s,(n??r)-Rt);i(e<=l+o*_t?null:e,n)}else{const e=Math.max(s,(a??l)+Rt);i(a,e>=r-o*_t?null:e)}},n=()=>{c(null),s.removeEventListener("pointermove",a),s.removeEventListener("pointerup",n),s.removeEventListener("pointercancel",n)};s.addEventListener("pointermove",a),s.addEventListener("pointerup",n),s.addEventListener("pointercancel",n)},[b,i]),j=e.useCallback(e=>{e.preventDefault(),e.stopPropagation();const t=e.currentTarget;t.setPointerCapture(e.pointerId),c("range");const s=d.current.valueStart??d.current.min,a=d.current.valueEnd??d.current.max;m.current={offset:b(e.clientX)-s,width:a-s};const n=e=>{const t=b(e.clientX),{min:s,max:a}=d.current,{offset:n,width:l}=m.current;let r=t-n;r=Math.max(s,Math.min(a-l,r));const o=r+l;i(Math.round(r)<=s?null:Math.round(r),Math.round(o)>=a?null:Math.round(o))},l=()=>{c(null),t.removeEventListener("pointermove",n),t.removeEventListener("pointerup",l),t.removeEventListener("pointercancel",l)};t.addEventListener("pointermove",n),t.addEventListener("pointerup",l),t.addEventListener("pointercancel",l)},[b,i]),N=e.useCallback(e=>{const t=b(e.clientX),{valueStart:s,valueEnd:a,min:n,max:l}=d.current,r=l-n||1,o=s??n,c=a??l;if(Math.abs(t-o)<=Math.abs(t-c)){const e=Math.min(t,c-Rt);i(e<=n+r*_t?null:e,a)}else{const e=Math.max(t,o+Rt);i(s,e>=l-r*_t?null:e)}},[b,i]),w=e.useCallback(()=>i(null,null),[i]),k=e.useCallback((e,t)=>{const s="ArrowRight"===t.key||"ArrowUp"===t.key?1:"ArrowLeft"===t.key||"ArrowDown"===t.key?-1:0;if(!s)return;t.preventDefault();const a=(t.shiftKey?.1:.01)*u,{valueStart:n,valueEnd:l,min:r,max:o}=d.current,c=o-r||1;if("start"===e){const e=Math.max(r,Math.min((n??r)+s*a,(l??o)-Rt));i(e<=r+c*_t?null:e,l)}else{const e=Math.min(o,Math.max((l??o)+s*a,(n??r)+Rt));i(n,e>=o-c*_t?null:e)}},[u,i]),M=e=>{const t=o===e;return["absolute top-1/2 -translate-y-1/2 -translate-x-1/2 w-1 h-4 rounded-full","before:content-[''] before:absolute before:-inset-x-3 before:-inset-y-1","touch-none outline-none",t?"cursor-grabbing":"cursor-ew-resize",t?"bg-sys-blue shadow-[0_0_8px_var(--sys-blue)] scale-x-150 z-20":("start"===e?null!==n:null!==l)?"bg-sys-blue shadow-[0_0_4px_var(--sys-blue)] hover:shadow-[0_0_8px_var(--sys-blue)] hover:scale-x-150 z-10":"bg-edge-subtle hover:bg-fg-muted hover:scale-x-150 z-10",t?"":"transition-[transform,box-shadow,background-color] duration-150 ease-out","focus-visible:ring-2 focus-visible:ring-sys-blue/50"].filter(Boolean).join(" ")};return t.jsxs("div",{className:"flex flex-col gap-0.5 min-w-[160px] sm:min-w-[220px]",children:[t.jsxs("div",{className:"flex items-center justify-between type-data-xs text-fg-muted tabular-nums select-none",children:[t.jsx("span",{className:y&&null!==n?"text-sys-blue":"",children:Pt(x,h)}),t.jsx("span",{className:y&&null!==l?"text-sys-blue":"",children:Pt(p,h)})]}),t.jsxs("div",{ref:r,className:"relative h-5 select-none",onPointerDown:N,onDoubleClick:w,children:[t.jsx("div",{className:"absolute inset-x-0 top-1/2 -translate-y-1/2 h-1.5 rounded-full bg-white/[0.06] pointer-events-none"}),y?t.jsx("div",{className:["group/band absolute inset-y-0 touch-none","range"===o?"cursor-grabbing":"cursor-grab"].join(" "),style:{left:`${f}%`,right:100-g+"%"},onPointerDown:j,children:t.jsx("div",{className:["absolute inset-x-0 top-1/2 -translate-y-1/2 h-1.5 rounded-full pointer-events-none transition-colors","range"===o?"bg-sys-blue/40":"bg-sys-blue/25 group-hover/band:bg-sys-blue/35"].join(" ")})}):t.jsx("div",{className:"absolute inset-x-0 top-1/2 -translate-y-1/2 h-1.5 rounded-full bg-white/[0.04] pointer-events-none"}),t.jsx("div",{role:"slider",tabIndex:0,"aria-label":"Range start","aria-valuenow":x,className:M("start"),style:{left:`${f}%`},onPointerDown:e=>v("start",e),onKeyDown:e=>k("start",e)}),t.jsx("div",{role:"slider",tabIndex:0,"aria-label":"Range end","aria-valuenow":p,className:M("end"),style:{left:`${g}%`},onPointerDown:e=>v("end",e),onKeyDown:e=>k("end",e)})]})]})}function $t({parentStartTs:s,parentEndTs:a,neighbors:n,filter:l,onChange:i}){const[r,o]=e.useState(""),[c,d]=e.useState(!1),m=e.useRef(null);e.useEffect(()=>{function e(e){m.current&&!m.current.contains(e.target)&&d(!1)}if(c)return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[c]);const u=e.useMemo(()=>Object.entries(n).map(([e,t])=>{const s=pe(t);return{hash:e,name:t.name??t.node_name??e.slice(0,8),type:s.type,label:s.label}}).sort((e,t)=>e.name.localeCompare(t.name)),[n]),h=e.useMemo(()=>{if(!r)return u;const e=r.toLowerCase();return u.filter(t=>t.name.toLowerCase().includes(e)||t.hash.toLowerCase().includes(e))},[u,r]),x=null!==l.timeStart||null!==l.timeEnd||l.deviceTypes.size>0||l.nodeIds.size>0,p=e.useCallback((e,t)=>{i({...l,timeStart:e,timeEnd:t})},[l,i]),f=e.useCallback(e=>{const t=new Set(l.deviceTypes);t.has(e)?t.delete(e):t.add(e),i({...l,deviceTypes:t})},[l,i]),g=e.useCallback(e=>{const t=new Set(l.nodeIds);t.has(e)?t.delete(e):t.add(e),i({...l,nodeIds:t}),o("")},[l,i]),y=e.useCallback(e=>{const t=new Set(l.nodeIds);t.delete(e),i({...l,nodeIds:t})},[l,i]),b=e.useCallback(()=>{i({timeStart:null,timeEnd:null,deviceTypes:new Set,nodeIds:new Set}),o("")},[i]),v=e.useMemo(()=>{const e=new Map;for(const t of l.nodeIds){const s=n[t];e.set(t,(null==s?void 0:s.name)??(null==s?void 0:s.node_name)??t.slice(0,8))}return e},[l.nodeIds,n]);return t.jsxs("div",{className:"flex flex-col gap-1.5 px-3 py-2",children:[t.jsxs("div",{className:"flex flex-wrap items-center gap-x-4 gap-y-2",children:[t.jsxs("div",{className:"flex items-center gap-1.5 text-fg-muted shrink-0",children:[t.jsx(be,{className:"w-3.5 h-3.5"}),t.jsx("span",{className:"type-data-xs font-medium",children:"Filter"})]}),t.jsx(Dt,{min:s,max:a,valueStart:l.timeStart,valueEnd:l.timeEnd,onChange:p}),t.jsx("div",{className:"w-px h-4 bg-edge-subtle shrink-0 hidden sm:block"}),t.jsx("div",{className:"flex items-center gap-1 shrink-0",children:Et.map(({type:e,label:s,icon:a,color:n})=>{const i=l.deviceTypes.has(e);return t.jsxs("button",{type:"button",onClick:()=>f(e),className:`\n                  flex items-center gap-1 px-2 py-0.5 rounded-full type-data-xs transition-colors\n                  ${i?"bg-sys-blue/20 text-sys-blue border border-sys-blue/40":"bg-transparent text-fg-muted border border-edge-subtle hover:border-fg-muted/40"}\n                `,title:`Filter by ${s}`,children:[t.jsx(a,{className:`w-3 h-3 ${i?"text-sys-blue":n}`}),t.jsx("span",{className:"hidden sm:inline",children:s})]},e)})}),t.jsx("div",{className:"w-px h-4 bg-edge-subtle shrink-0 hidden sm:block"}),t.jsxs("div",{className:"relative flex items-center gap-1.5 flex-1 min-w-[140px] px-2 py-0.5 rounded-md border border-edge-subtle bg-white/[0.03] transition-colors focus-within:border-sys-blue",ref:m,children:[t.jsx(je,{className:"w-3 h-3 text-fg-muted/50 shrink-0"}),t.jsx("input",{type:"text",className:"flex-1 min-w-[80px] type-data-xs py-0.5 bg-transparent text-fg-secondary placeholder:text-fg-muted/40 border-none focus:outline-none",placeholder:"Search nodes...",value:r,onChange:e=>{o(e.target.value),d(!0)},onFocus:()=>d(!0)}),c&&h.length>0&&t.jsx("div",{className:"absolute top-full left-0 right-0 mt-1 z-[200] surface-popover border border-edge-subtle radius-inner max-h-48 overflow-y-auto",children:h.slice(0,20).map(e=>{const s=l.nodeIds.has(e.hash);return t.jsxs("button",{type:"button",onClick:()=>g(e.hash),className:`\n                      w-full flex items-center gap-2 px-2.5 py-1.5 type-data-xs text-left transition-colors\n                      ${s?"bg-sys-indigo/15 text-sys-indigo":"text-fg-secondary hover:bg-subtle-fill"}\n                    `,children:[t.jsx("span",{className:"flex-1 truncate",children:e.name}),t.jsx("span",{className:"text-fg-muted type-data-xs shrink-0",children:e.label})]},e.hash)})})]}),x&&t.jsxs("button",{type:"button",onClick:b,className:"flex items-center gap-1 px-2 py-0.5 rounded-full type-data-xs text-fg-muted hover:text-fg-primary border border-edge-subtle hover:border-fg-muted/40 transition-colors shrink-0",title:"Clear all filters",children:[t.jsx(F,{className:"w-3 h-3"}),"Clear"]})]}),l.nodeIds.size>0&&t.jsx("div",{className:"flex flex-wrap items-center gap-1.5",children:Array.from(l.nodeIds).map(e=>t.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-sys-indigo/15 text-sys-indigo type-data-xs border border-sys-indigo/25 transition-colors hover:bg-sys-indigo/25",children:[v.get(e)??e.slice(0,8),t.jsx("button",{type:"button",onClick:()=>y(e),className:"hover:text-fg-primary transition-colors -mr-0.5",children:t.jsx(F,{className:"w-3 h-3"})})]},e))})]})}function zt(){return{timeStart:null,timeEnd:null,deviceTypes:new Set,nodeIds:new Set}}function Ht(){var s,a,n,l,i,r,o,c,d,m,u,h,x,p,f,g,y;const b=P(),v=E(),j=R(),N=_(),w=D(),k=$(),M=z(),S=H(),[C,T]=e.useState([]),[A,F]=e.useState(null),[,U]=e.useState(null),[J,K]=e.useState(!0),[Q,ne]=e.useState(null),[le,ie]=e.useState(()=>{const e=localStorage.getItem("statistics-view-mode");return"share"===e||"airtime"===e?e:"airtime"});e.useEffect(()=>{localStorage.setItem("statistics-view-mode",le)},[le]);const[oe,ce]=e.useState(()=>{const e=localStorage.getItem("statistics-smoothing-mode");return["ema","ultra","mosaic","stats","trend"].includes(e)?e:"stats"});e.useEffect(()=>{localStorage.setItem("statistics-smoothing-mode",oe)},[oe]);const[de,me]=e.useState(!1),[ue,he]=e.useState(!1),[xe,fe]=e.useState(De),[be,ve]=e.useState(.5),[je,Se]=e.useState(zt),Te=e.useMemo(()=>({0:0,1:0,2:1,3:2,4:3,5:4,6:5,7:6,8:7,9:8,10:9}[M]??3),[M]),Ae=B[Te].hours,Le=60*Ae,Fe=B[Te],Pe=I(Ae),Ee=k.isBackgroundLoading,Re=e.useCallback(e=>{S({0:1,1:2,2:3,3:4,4:5,5:6,6:7,7:8,8:9,9:10}[e]??4)},[S]),_e=e.useMemo(()=>{var e;if(!(null==(e=null==b?void 0:b.config)?void 0:e.radio))return null;const t=b.config.radio;return{sf:t.spreading_factor??10,bw:t.bandwidth??25e4,cr:t.coding_rate??5,preamble:t.preamble_length??8}},[null==(a=null==(s=null==b?void 0:b.config)?void 0:s.radio)?void 0:a.spreading_factor,null==(l=null==(n=null==b?void 0:b.config)?void 0:n.radio)?void 0:l.bandwidth,null==(r=null==(i=null==b?void 0:b.config)?void 0:i.radio)?void 0:r.coding_rate,null==(c=null==(o=null==b?void 0:b.config)?void 0:o.radio)?void 0:c.preamble_length]);e.useEffect(()=>{!async function(){var e;ne(null);try{const t=await q(Ae);t.success&&(null==(e=t.data)?void 0:e.history)&&T(t.data.history)}catch(t){ne(t instanceof Error?t.message:"Failed to load chart data")}finally{K(!1)}}()},[Ae]);const Be=e.useMemo(()=>Ae>=504?72e5:336===Ae?36e5:168===Ae?18e5:72===Ae?6e5:3e5,[Ae]),qe=e.useCallback(async()=>{var e;try{const t=await q(Ae);t.success&&(null==(e=t.data)?void 0:e.history)&&T(t.data.history)}catch{}},[Ae]);V(qe,Be,!0,!0);const Ie=e.useMemo(()=>0===C.length?{timestamps:[],values:[]}:{timestamps:C.map(e=>e.timestamp),values:C.map(e=>e.noise_floor_dbm)},[C]),Oe=e.useMemo(()=>{if(C.length<10)return{anomalies:[],debug:void 0};const e=function(e,t={}){const s={...De,...t};if(e.length<10)return{anomalies:[],thresholds:ze([]),totalSamples:e.length,anomalySamples:0};const a=e.map(e=>e.noise_floor_dbm),n=ze(a),l=[...a].sort((e,t)=>e-t);let i,r;s.useAbsoluteThresholds?(i=s.baselineDbm,r=s.spikeDbm):(i=$e(l,s.baselinePercentile),r=$e(l,s.spikePercentile));const o=[...e].sort((e,t)=>e.timestamp-t.timestamp),c=[];let d=null,m=0;for(const u of o)if(u.noise_floor_dbm>i&&u.noise_floor_dbm<r)if(m++,d){const e=Math.abs(u.noise_floor_dbm-d.rollingAvg)<=s.similarityToleranceDbm,t=u.timestamp-d.endTs<=s.mergeGapSeconds;e&&t?(d.endTs=u.timestamp,d.values.push(u.noise_floor_dbm),d.timestamps.push(u.timestamp),d.rollingAvg=d.values.reduce((e,t)=>e+t,0)/d.values.length):(d.values.length>=s.minSequenceLength&&c.push(d),d={startTs:u.timestamp,endTs:u.timestamp,values:[u.noise_floor_dbm],timestamps:[u.timestamp],rollingAvg:u.noise_floor_dbm})}else d={startTs:u.timestamp,endTs:u.timestamp,values:[u.noise_floor_dbm],timestamps:[u.timestamp],rollingAvg:u.noise_floor_dbm};else d&&d.values.length>=s.minSequenceLength&&c.push(d),d=null;return d&&d.values.length>=s.minSequenceLength&&c.push(d),0===c.length?{anomalies:[],thresholds:n,totalSamples:e.length,anomalySamples:m,debug:{baselineCutoff:i,spikeCutoff:r,midBandSamples:m}}:{anomalies:c.map(e=>{const t=Math.max(...e.values),s=e.values.reduce((e,t)=>e+t,0)/e.values.length;return{startTs:e.startTs,endTs:e.endTs,peakValue:t,avgValue:s,severity:He(s,i,r),sampleCount:e.values.length}}),thresholds:n,totalSamples:e.length,anomalySamples:m,debug:{baselineCutoff:i,spikeCutoff:r,midBandSamples:m}}}(C,xe);return{anomalies:e.anomalies,debug:e.debug}},[C,xe]),We=Oe.anomalies,Ge=e.useMemo(()=>{const e=(null==b?void 0:b.neighbors)??{};return Object.fromEntries(Object.entries(e).filter(([e])=>!v.has(e)))},[null==b?void 0:b.neighbors,v]),Xe=e.useMemo(()=>{const e=Date.now()/1e3-3600*Ae;return Object.fromEntries(Object.entries(Ge).filter(([,t])=>t.last_seen>=e))},[Ge,Ae]),Ve=e.useMemo(()=>{const e=60*Le/Pe,t=Math.floor(Date.now()/1e3),s=Math.floor(t/e)*e;return{start:s-60*Le,end:s}},[Le,Pe]),Ye=je.timeStart??Ve.start,Ue=je.timeEnd??Ve.end,Je=I((Ue-Ye)/3600),Ke=e.useMemo(()=>{const e=new Map,t=new Map,s=(null==b?void 0:b.neighbors)??{},a=new Set(Object.keys(s));for(const n of N)if((n.type??n.payload_type)===O.ADVERT&&n.src_hash&&n.raw_packet&&!a.has(n.src_hash)&&!e.has(n.src_hash))try{const t=Ne.fromHex(n.raw_packet);if(!t.success||!t.packet)continue;const s=we(t.packet.payload);if(!s)continue;const a=ge(s.nodeType);"unknown"!==a&&e.set(n.src_hash,a)}catch{}for(const[n,l]of Object.entries(s)){const s=pe(l).type;e.set(n,s);const a=W(n),i=t.get(a);void 0===i?t.set(a,s):i!==s&&t.set(a,"ambiguous")}return{hashToType:e,prefixToType:t}},[N,null==b?void 0:b.neighbors]),Qe=e.useMemo(()=>{const{timeStart:e,timeEnd:t,deviceTypes:s,nodeIds:a}=je,n=null!==e||null!==t,l=s.size>0,i=a.size>0;if(!n&&!l&&!i)return N;const{hashToType:r,prefixToType:o}=Ke;let c=null;if(i){c=new Set;for(const e of a)c.add(W(e))}const d=e??Ve.start,m=t??Ve.end;return N.filter(e=>{if(n&&(e.timestamp<d||e.timestamp>m))return!1;if(l){const t=e.src_hash;if(t){let a=r.get(t);if(void 0===a){const e=W(t),s=o.get(e);a=s&&"ambiguous"!==s?s:void 0}if(void 0===a&&(a=ye(e.type??e.payload_type)),!s.has(a))return!1}else{const t=ye(e.type??e.payload_type);if(!s.has(t))return!1}}if(i){const t=e.src_hash;if(!t)return!1;if(!a.has(t)){const e=W(t);if(!c.has(e))return!1}}return!0})},[N,je,Ke,Ve]);return t.jsxs(te,{children:[t.jsx(se,{title:"Statistics",icon:t.jsx(G,{}),controls:t.jsx(Z,{ranges:B,selectedIndex:Te,onSelect:Re,isPending:Ee})}),Q&&t.jsx(ee,{className:"border border-sys-red/50 bg-sys-red/10",children:t.jsx("p",{className:"text-sys-red",children:Q})}),de&&ue&&t.jsxs(ee,{className:"border border-sys-indigo/30 bg-surface/50",children:[t.jsxs("div",{className:"flex items-center justify-between mb-3",children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("span",{className:"type-label",children:"Anomaly Detection Tuning"}),t.jsxs("span",{className:"type-data-xs text-fg-muted",children:["(",Fe.label,")"]})]}),t.jsx("button",{onClick:()=>fe(e=>({...e,useAbsoluteThresholds:!e.useAbsoluteThresholds})),className:"type-data-xs px-2 py-1 rounded transition-colors "+(xe.useAbsoluteThresholds?"bg-sys-indigo/30 text-sys-indigo":"bg-elevated text-fg-muted hover:text-fg-secondary"),children:xe.useAbsoluteThresholds?"Absolute dBm":"Percentile"})]}),t.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-4 gap-4",children:[t.jsxs("div",{children:[t.jsx("span",{className:"type-micro",children:"Baseline"}),t.jsxs("span",{className:"ml-2 type-data-sm text-status-warning",children:[(null==(m=null==(d=Oe.debug)?void 0:d.baselineCutoff)?void 0:m.toFixed(1))??"—"," dBm"]})]}),t.jsxs("div",{children:[t.jsx("span",{className:"type-micro",children:"Spike"}),t.jsxs("span",{className:"ml-2 type-data-sm text-status-warning",children:[(null==(h=null==(u=Oe.debug)?void 0:u.spikeCutoff)?void 0:h.toFixed(1))??"—"," dBm"]})]}),t.jsxs("div",{children:[t.jsx("span",{className:"type-micro",children:"Mid-band"}),t.jsx("span",{className:"ml-2 type-data-sm text-sys-indigo",children:(null==(x=Oe.debug)?void 0:x.midBandSamples)??0})]}),t.jsxs("div",{children:[t.jsx("span",{className:"type-micro",children:"Anomalies"}),t.jsx("span",{className:"ml-2 type-data-sm text-status-danger",children:We.length})]})]}),t.jsxs("div",{className:"mt-4 pt-4 border-t border-edge-subtle space-y-4",children:[xe.useAbsoluteThresholds?t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-4",children:[t.jsxs("div",{children:[t.jsxs("label",{className:"type-micro block mb-1",children:["Baseline (",xe.baselineDbm," dBm)"]}),t.jsx("input",{type:"range",min:"-120",max:"-60",value:xe.baselineDbm,onChange:e=>fe(t=>({...t,baselineDbm:Number(e.target.value)})),className:"w-full accent-sys-indigo"})]}),t.jsxs("div",{children:[t.jsxs("label",{className:"type-micro block mb-1",children:["Spike (",xe.spikeDbm," dBm)"]}),t.jsx("input",{type:"range",min:"-100",max:"-20",value:xe.spikeDbm,onChange:e=>fe(t=>({...t,spikeDbm:Number(e.target.value)})),className:"w-full accent-sys-indigo"})]}),t.jsxs("div",{children:[t.jsxs("label",{className:"type-micro block mb-1",children:["Merge Gap (",xe.mergeGapSeconds,"s)"]}),t.jsx("input",{type:"range",min:"5",max:"120",step:"5",value:xe.mergeGapSeconds,onChange:e=>fe(t=>({...t,mergeGapSeconds:Number(e.target.value)})),className:"w-full accent-sys-indigo"})]})]}),t.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-4",children:[t.jsxs("div",{children:[t.jsxs("label",{className:"type-micro block mb-1",children:["Min Sequence (",xe.minSequenceLength,")"]}),t.jsx("input",{type:"range",min:"2",max:"20",value:xe.minSequenceLength,onChange:e=>fe(t=>({...t,minSequenceLength:Number(e.target.value)})),className:"w-full accent-sys-indigo"})]}),t.jsxs("div",{children:[t.jsxs("label",{className:"type-micro block mb-1",children:["Similarity (±",xe.similarityToleranceDbm," dBm)"]}),t.jsx("input",{type:"range",min:"1",max:"15",value:xe.similarityToleranceDbm,onChange:e=>fe(t=>({...t,similarityToleranceDbm:Number(e.target.value)})),className:"w-full accent-sys-indigo"})]}),t.jsxs("div",{children:[t.jsxs("label",{className:"type-micro block mb-1",children:["Opacity (",Math.round(100*be),"%)"]}),t.jsx("input",{type:"range",min:"0.1",max:"1",step:"0.05",value:be,onChange:e=>ve(Number(e.target.value)),className:"w-full accent-sys-indigo"})]})]})]}):t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-4",children:[t.jsxs("div",{children:[t.jsxs("label",{className:"type-micro block mb-1",children:["Baseline (P",xe.baselinePercentile,")"]}),t.jsx("input",{type:"range",min:"1",max:"50",value:xe.baselinePercentile,onChange:e=>fe(t=>({...t,baselinePercentile:Number(e.target.value)})),className:"w-full accent-sys-indigo"})]}),t.jsxs("div",{children:[t.jsxs("label",{className:"type-micro block mb-1",children:["Spike (P",xe.spikePercentile,")"]}),t.jsx("input",{type:"range",min:"50",max:"99",value:xe.spikePercentile,onChange:e=>fe(t=>({...t,spikePercentile:Number(e.target.value)})),className:"w-full accent-sys-indigo"})]}),t.jsxs("div",{children:[t.jsxs("label",{className:"type-micro block mb-1",children:["Merge Gap (",xe.mergeGapSeconds,"s)"]}),t.jsx("input",{type:"range",min:"5",max:"120",step:"5",value:xe.mergeGapSeconds,onChange:e=>fe(t=>({...t,mergeGapSeconds:Number(e.target.value)})),className:"w-full accent-sys-indigo"})]})]}),t.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-4",children:[t.jsxs("div",{children:[t.jsxs("label",{className:"type-micro block mb-1",children:["Min Sequence (",xe.minSequenceLength,")"]}),t.jsx("input",{type:"range",min:"2",max:"20",value:xe.minSequenceLength,onChange:e=>fe(t=>({...t,minSequenceLength:Number(e.target.value)})),className:"w-full accent-sys-indigo"})]}),t.jsxs("div",{children:[t.jsxs("label",{className:"type-micro block mb-1",children:["Similarity (±",xe.similarityToleranceDbm," dBm)"]}),t.jsx("input",{type:"range",min:"1",max:"15",value:xe.similarityToleranceDbm,onChange:e=>fe(t=>({...t,similarityToleranceDbm:Number(e.target.value)})),className:"w-full accent-sys-indigo"})]}),t.jsxs("div",{children:[t.jsxs("label",{className:"type-micro block mb-1",children:["Opacity (",Math.round(100*be),"%)"]}),t.jsx("input",{type:"range",min:"0.1",max:"1",step:"0.05",value:be,onChange:e=>ve(Number(e.target.value)),className:"w-full accent-sys-indigo"})]})]})]}),t.jsxs("div",{className:"mt-4 p-3 bg-elevated radius-inner",children:[t.jsx("div",{className:"type-micro mb-1",children:"Config output"}),t.jsxs("div",{className:"type-data-sm text-status-success",children:[xe.useAbsoluteThresholds?`useAbsoluteThresholds: true, baselineDbm: ${xe.baselineDbm}, spikeDbm: ${xe.spikeDbm}`:`useAbsoluteThresholds: false, baselinePercentile: ${xe.baselinePercentile}, spikePercentile: ${xe.spikePercentile}`,", mergeGapSeconds: ",xe.mergeGapSeconds,", minSequenceLength: ",xe.minSequenceLength,", similarityToleranceDbm: ",xe.similarityToleranceDbm]})]})]})]}),t.jsxs(ae,{children:[Ee&&t.jsx(ke,{template:"auto",children:t.jsx(ee,{className:"border border-sys-blue/30 bg-sys-blue/5",children:t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsxs("div",{className:"relative flex h-3 w-3",children:[t.jsx("span",{className:"animate-ping absolute inline-flex h-full w-full rounded-full bg-sys-blue opacity-75"}),t.jsx("span",{className:"relative inline-flex rounded-full h-3 w-3 bg-sys-blue"})]}),t.jsxs("div",{className:"flex-1",children:[t.jsxs("p",{className:"type-body-sm text-fg-primary",children:["Loading ",Fe.label," data..."]}),k.loadProgress&&t.jsxs("p",{className:"type-data-xs text-fg-muted mt-0.5",children:[k.loadProgress.loaded.toLocaleString()," packets (",k.loadProgress.percent,"%)"]})]})]})})}),J?t.jsx(ke,{template:"auto",children:t.jsx(ee,{neomorphic:!0,className:"text-center py-12",children:t.jsx("div",{className:"animate-pulse text-fg-muted",children:"Loading statistics..."})})}):t.jsxs(t.Fragment,{children:[t.jsx(ke,{template:"hero-auto",children:t.jsx(ee,{neomorphic:!0,isLoaded:w,skeletonType:"chart",children:w&&t.jsxs(t.Fragment,{children:[t.jsx(re,{icon:t.jsx(Y,{}),title:"Packet Analyzer",badge:Fe.label,badgeColor:"zinc",stackActionsOnMobile:!0,actions:t.jsxs("div",{className:"flex flex-wrap items-center gap-2 justify-end",children:["stats"===oe&&t.jsx(tt,{enabled:de,onChange:me,anomalyCount:We.length,showTuning:ue,onTuningChange:he}),t.jsx(et,{smoothing:oe,onChange:ce}),t.jsx(Ze,{mode:le,onChange:ie})]})}),t.jsx("div",{className:"flex-1 min-h-0",children:t.jsx(ct,{packets:Qe,allPackets:N,startTs:Ye,endTs:Ue,parentStartTs:Ve.start,parentEndTs:Ve.end,bucketCount:Je,radioConfig:_e??void 0,mode:le,smoothing:oe,noiseFloorAnomalies:We,showNoiseFloorOverlay:de,overlayOpacity:be})})]})})}),t.jsx(ke,{template:"auto",className:"relative z-10",children:t.jsx(ee,{neomorphic:!0,isLoaded:w,className:"overflow-visible",children:w&&t.jsx($t,{parentStartTs:Ve.start,parentEndTs:Ve.end,neighbors:Ge,filter:je,onChange:Se})})}),t.jsxs(ke,{template:"panel",children:[t.jsx(Me,{span:12,md:6,children:t.jsx(ee,{neomorphic:!0,isLoaded:w,skeletonType:"chart",noPadding:w,children:w&&t.jsx(wt,{children:t.jsx(bt,{neighbors:Xe,quickNeighbors:j,localLat:(null==(f=null==(p=null==b?void 0:b.config)?void 0:p.repeater)?void 0:f.latitude)??0,localLon:(null==(y=null==(g=null==b?void 0:b.config)?void 0:g.repeater)?void 0:y.longitude)??0,onStatsChange:U,title:"Link Quality",badge:Fe.label})})})}),t.jsx(Me,{span:12,md:6,children:t.jsx(ee,{neomorphic:!0,isLoaded:w,skeletonType:"chart",children:w&&t.jsxs(t.Fragment,{children:[t.jsx(re,{icon:t.jsx(Ce,{}),title:"Network Composition",badge:Fe.label,badgeColor:"zinc"}),t.jsx("div",{className:"flex-1 min-h-0",children:t.jsx(wt,{children:t.jsx(Nt,{neighbors:Xe})})})]})})})]}),t.jsxs(ke,{template:"panel",children:[t.jsx(Me,{span:12,md:6,children:t.jsx(St,{})}),t.jsx(Me,{span:12,md:6,children:t.jsx(Tt,{})})]}),t.jsxs(ke,{template:"panel",children:[t.jsx(Me,{span:12,md:8,children:t.jsx(ee,{neomorphic:!0,isLoaded:w,skeletonType:"chart",children:w&&t.jsxs(t.Fragment,{children:[t.jsx(re,{icon:t.jsx(L,{}),title:"RF Noise Floor",stackActionsOnMobile:!0,actions:A?t.jsxs("div",{className:"flex items-center gap-2 sm:gap-3",children:[t.jsxs("span",{className:"type-data-xs text-fg-muted whitespace-nowrap",children:["min ",t.jsx("span",{className:"text-fg-secondary tabular-nums",children:A.min.toFixed(0)})]}),t.jsxs("span",{className:"type-data-xs text-fg-muted whitespace-nowrap",children:["avg ",t.jsx("span",{className:"text-fg-secondary tabular-nums",children:A.avg.toFixed(0)})]}),t.jsxs("span",{className:"type-data-xs text-fg-muted whitespace-nowrap",children:["max ",t.jsx("span",{className:"text-fg-secondary tabular-nums",children:A.max.toFixed(0)})]}),t.jsx("span",{className:"type-data-xs text-fg-muted",children:"dBm"})]}):t.jsx("span",{className:"type-data-xs text-fg-muted",children:"dBm"})}),t.jsx("div",{className:"flex-1 min-h-0",children:t.jsx(wt,{children:t.jsx(X,{timestamps:Ie.timestamps,values:Ie.values,onStatsChange:F})})})]})})}),t.jsx(Me,{span:12,md:4,children:t.jsx(Ft,{packets:N,rangeMinutes:Le,rangeHours:Ae,timeRangeLabel:Fe.label,isLoaded:w})})]})]})]})]})}export{Ht as default};
