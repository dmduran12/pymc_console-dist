import{c as e,j as t,a as s,b as a,d as n,e as r,R as l,L as i,f as o,g as c,h as d,u,k as m,m as x,D as h,n as p,o as v,p as g,C as f}from"./index-CuXXLMaO.js";import{b as j,d as b,L as y,e as k,A as N,C as w,X as M,Y as L,T as _,f as S}from"./recharts-bmHCCfxU.js";import{u as C,T as B}from"./TimeRangeSelector-CZfyjNIX.js";import{u as F}from"./useThemeColors-Co3IW0xw.js";import{g as R,A as T,P as H,a as P,b as D,C as A}from"./PacketDetailModal-C4rtX_yn.js";import{C as $}from"./circle-B_o4C7_c.js";import{H as z}from"./HashBadge-CoTpHLJU.js";import{T as E,N as W}from"./trending-up-C8WOU9z2.js";import{T as q,M as I,Z as V}from"./zap-2vPF1hLy.js";import{C as O,P as K,a as U,b as Q}from"./PageLayout-BXg37b97.js";import{H as X}from"./house-CAAUh_Ch.js";import{R as G}from"./Grid-Dosy-Ovb.js";import"./maplibre-gl-CFO9X1Ek.js";import"./SignalIndicator-B8iije1Y.js";import"./map-pin-C56R-rTh.js";import"./triangle-alert-DswcOj8t.js";import"./map-C6IQrCh6.js";const J=e("arrow-up-right",[["path",{d:"M7 7h10v10",key:"1tivn9"}],["path",{d:"M7 17 17 7",key:"1vkiza"}]]),Y=e("audio-waveform",[["path",{d:"M2 13a2 2 0 0 0 2-2V7a2 2 0 0 1 4 0v13a2 2 0 0 0 4 0V4a2 2 0 0 1 4 0v13a2 2 0 0 0 4 0v-4a2 2 0 0 1 2-2",key:"57tc96"}]]),Z=e("cross",[["path",{d:"M4 9a2 2 0 0 0-2 2v2a2 2 0 0 0 2 2h4a1 1 0 0 1 1 1v4a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2v-4a1 1 0 0 1 1-1h4a2 2 0 0 0 2-2v-2a2 2 0 0 0-2-2h-4a1 1 0 0 1-1-1V4a2 2 0 0 0-2-2h-2a2 2 0 0 0-2 2v4a1 1 0 0 1-1 1z",key:"1xbrqy"}]]),ee=e("ear-off",[["path",{d:"M6 18.5a3.5 3.5 0 1 0 7 0c0-1.57.92-2.52 2.04-3.46",key:"1qngmn"}],["path",{d:"M6 8.5c0-.75.13-1.47.36-2.14",key:"b06bma"}],["path",{d:"M8.8 3.15A6.5 6.5 0 0 1 19 8.5c0 1.63-.44 2.81-1.09 3.76",key:"g10hsz"}],["path",{d:"M12.5 6A2.5 2.5 0 0 1 15 8.5M10 13a2 2 0 0 0 1.82-1.18",key:"ygzou7"}],["line",{x1:"2",x2:"22",y1:"2",y2:"22",key:"a6p6uj"}]]),te=e("refresh-cw-off",[["path",{d:"M21 8L18.74 5.74A9.75 9.75 0 0 0 12 3C11 3 10.03 3.16 9.13 3.47",key:"1krf6h"}],["path",{d:"M8 16H3v5",key:"1cv678"}],["path",{d:"M3 12C3 9.51 4 7.26 5.64 5.64",key:"ruvoct"}],["path",{d:"m3 16 2.26 2.26A9.75 9.75 0 0 0 12 21c2.49 0 4.74-1 6.36-2.64",key:"19q130"}],["path",{d:"M21 12c0 1-.16 1.97-.47 2.87",key:"4w8emr"}],["path",{d:"M21 3v5h-5",key:"1q7to0"}],["path",{d:"M22 22 2 2",key:"1r8tn9"}]]),se=e("route",[["circle",{cx:"6",cy:"19",r:"3",key:"1kj8tv"}],["path",{d:"M9 19h8.5a3.5 3.5 0 0 0 0-7h-11a3.5 3.5 0 0 1 0-7H15",key:"1d8sl"}],["circle",{cx:"18",cy:"5",r:"3",key:"gq8acd"}]]),ae=e("square-activity",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}],["path",{d:"M17 12h-2l-2 5-2-10-2 5H7",key:"15hlnc"}]]),ne=e("timer",[["line",{x1:"10",x2:"14",y1:"2",y2:"2",key:"14vaq8"}],["line",{x1:"12",x2:"15",y1:"14",y2:"11",key:"17fdiu"}],["circle",{cx:"12",cy:"14",r:"8",key:"1e1u0o"}]]),re={received:{value:"text-[var(--metric-received)]",barBase:"var(--metric-received)"},forwarded:{value:"text-[var(--metric-forwarded)]",barBase:"var(--metric-forwarded)"},transmitted:{value:"text-[var(--metric-transmitted)]",barBase:"var(--metric-transmitted)"},dropped:{value:"text-[var(--metric-dropped)]",barBase:"var(--metric-dropped)"},neutral:{value:"text-text-secondary",barBase:"var(--metric-neutral)"}};function le({buckets:e,colorType:s,height:a=64}){const n=re[s],{bars:r}=j.useMemo(()=>{var t,s;if(!e||0===e.length)return{bars:[]};const a=[],r=e.length/60;if(r<=1)a.push(...e);else for(let n=0;n<60;n++){const l=Math.floor(n*r),i=Math.floor((n+1)*r),o=e.slice(l,i),c=o.reduce((e,t)=>e+t.count,0),d=o.length>0?o.reduce((e,t)=>e+t.avg_snr,0)/o.length:0;a.push({bucket:n,start:(null==(t=o[0])?void 0:t.start)??0,end:(null==(s=o[o.length-1])?void 0:s.end)??0,count:c,airtime_ms:o.reduce((e,t)=>e+t.airtime_ms,0),avg_snr:d,avg_rssi:0})}const l=Math.max(...a.map(e=>e.count),1);return{bars:a.map(e=>({height:e.count>0?Math.max(e.count/l*100,8):0,color:e.count>0?n.barBase:"transparent",count:e.count,snr:e.avg_snr}))}},[e,n]);return e&&0!==e.length?t.jsx("div",{className:"w-full flex items-end gap-[1px]",style:{height:a},children:r.map((e,s)=>{var a;return t.jsx("div",{className:"flex-1 rounded-t-sm",style:{height:`${e.height}%`,backgroundColor:e.color,opacity:e.count>0?.8:.1,minHeight:e.count>0?"4px":"2px",maxWidth:"4px"},title:e.count>0?`${e.count} packets, SNR: ${null==(a=e.snr)?void 0:a.toFixed(1)}dB`:"No packets"},s)})}):t.jsx("div",{className:"w-full flex items-end justify-center gap-[2px] opacity-20",style:{height:a},children:t.jsx("span",{className:"type-data-xs text-text-muted",children:"No data"})})}const ie={received:"text-text-secondary",forwarded:"text-text-secondary",transmitted:"text-text-secondary",dropped:"text-text-secondary",neutral:"text-text-secondary"},oe={sm:"card-sm",md:"card-md",lg:"card-lg",hero:"card-hero",auto:""};function ce({title:e,value:s,color:a="neutral",subtitle:n,buckets:r,timeRangeLabel:l,icon:i,size:o="md"}){const c=re[a],d="string"==typeof s?s:s.toLocaleString();return t.jsxs("div",{className:`data-card flex flex-col ${oe[o]}`,children:[t.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[i&&t.jsx("span",{className:`icon-sm ${ie[a]}`,children:i}),t.jsx("span",{className:"type-micro",children:e}),l&&t.jsx("span",{className:"pill-tag",children:l})]}),t.jsx("div",{className:"data-card-value",children:d}),t.jsx("div",{className:"flex-1 py-2 mt-2",children:r?t.jsx(le,{buckets:r,colorType:a,height:64}):t.jsx("div",{className:"w-full h-16 flex items-center justify-center",children:t.jsx("div",{className:"w-full h-0.5 rounded-full",style:{backgroundColor:c.barBase,opacity:.15}})})}),t.jsx("div",{className:"type-label text-text-muted border-t border-border-subtle pt-3 mt-2",children:n||`Total ${e.toLowerCase()}`})]})}function de(){const e=s(),o=a(),c=n(),d=r(),[u,m]=j.useState(null),[x,h]=j.useState(null),p=j.useRef(0);j.useEffect(()=>{if(d>0&&d!==p.current&&e.length>0){p.current=d;const t=e.find(e=>(e.payload_type_name||R(e.payload_type??e.type)).toLowerCase().includes("advert"));if(t){const e=requestAnimationFrame(()=>m(t.packet_hash)),s=setTimeout(()=>m(null),600);return()=>{cancelAnimationFrame(e),clearTimeout(s)}}}},[d,e]);const v=e.slice(-15).reverse();return t.jsxs("div",{className:"chart-container h-full flex flex-col",children:[t.jsxs("div",{className:"chart-header",children:[t.jsxs("div",{className:"chart-title",children:[t.jsx(l,{className:"chart-title-icon"}),"Recent Packets"]}),t.jsxs("div",{className:"flex items-center gap-3",children:[c&&t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx($,{className:"w-2 h-2 fill-accent-success text-accent-success animate-pulse"}),t.jsx("span",{className:"type-data-xs text-text-muted",children:"LIVE"})]}),t.jsxs(i,{to:"/packets",className:"pill-subtle",children:["View all ",t.jsx(T,{className:"w-3 h-3"})]})]})]}),t.jsxs("div",{className:"sm:hidden flex items-center gap-1.5 px-3 py-1.5 border-b border-border-subtle/50 bg-bg-elevated/20",children:[t.jsx("span",{className:"text-[9px] font-semibold text-text-muted uppercase tracking-wider w-14 flex-shrink-0",children:"Dir"}),t.jsx("span",{className:"text-[9px] font-semibold text-text-muted uppercase tracking-wider w-7 flex-shrink-0",children:"Time"}),t.jsx("span",{className:"text-[9px] font-semibold text-text-muted uppercase tracking-wider w-9 flex-shrink-0",children:"Src"}),t.jsx("span",{className:"text-[9px] font-semibold text-text-muted uppercase tracking-wider flex-1 min-w-0",children:"Type"}),t.jsx("span",{className:"text-[9px] font-semibold text-text-muted uppercase tracking-wider w-14 flex-shrink-0",children:"Route"}),t.jsx("span",{className:"text-[9px] font-semibold text-text-muted uppercase tracking-wider w-10 text-right flex-shrink-0",children:"Signal"})]}),t.jsx("div",{className:"hidden sm:block flex-1 overflow-hidden",children:t.jsx("div",{className:"h-full overflow-y-auto",children:t.jsxs("table",{className:"w-full",children:[t.jsx("thead",{className:"sticky top-0 bg-bg-elevated/95 backdrop-blur-sm",children:t.jsxs("tr",{className:"border-b border-border-subtle/50",children:[t.jsx("th",{className:"text-left py-1.5 px-3 text-[9px] font-semibold text-text-muted uppercase tracking-wider w-16",children:"Dir"}),t.jsx("th",{className:"text-left py-1.5 px-3 text-[9px] font-semibold text-text-muted uppercase tracking-wider",children:"Time"}),t.jsx("th",{className:"text-left py-1.5 px-3 text-[9px] font-semibold text-text-muted uppercase tracking-wider",children:"Source"}),t.jsx("th",{className:"text-left py-1.5 px-3 text-[9px] font-semibold text-text-muted uppercase tracking-wider",children:"Type"}),t.jsx("th",{className:"text-left py-1.5 px-3 text-[9px] font-semibold text-text-muted uppercase tracking-wider",children:"Route"}),t.jsx("th",{className:"text-right py-1.5 px-3 pr-4 text-[9px] font-semibold text-text-muted uppercase tracking-wider",children:"Signal"})]})}),t.jsx("tbody",{className:"divide-y divide-border-subtle/30",children:o&&0===e.length?t.jsx("tr",{children:t.jsx("td",{colSpan:6,className:"text-center py-8 text-text-muted",children:"Loading packets..."})}):0===v.length?t.jsx("tr",{children:t.jsxs("td",{colSpan:6,className:"text-center py-8",children:[t.jsx(l,{className:"w-6 h-6 text-text-muted mx-auto mb-2"}),t.jsx("div",{className:"text-sm text-text-primary",children:"No packets received"}),t.jsx("div",{className:"text-xs text-text-muted",children:"Packets will appear here"})]})}):v.map(e=>{const s=(e.payload_type_name||R(e.payload_type??e.type)).toLowerCase().includes("advert");return t.jsx(H,{packet:e,onClick:h,isFlashing:s&&u===e.packet_hash},e.packet_hash)})})]})})}),t.jsx("div",{className:"sm:hidden flex-1 overflow-y-auto divide-y divide-border-subtle/30",children:o&&0===e.length?t.jsx("div",{className:"p-8 text-center text-text-muted",children:"Loading packets..."}):0===v.length?t.jsxs("div",{className:"p-8 text-center",children:[t.jsx(l,{className:"w-6 h-6 text-text-muted mx-auto mb-2"}),t.jsx("div",{className:"text-sm text-text-primary",children:"No packets received"}),t.jsx("div",{className:"text-xs text-text-muted",children:"Packets will appear here"})]}):v.map(e=>{const s=(e.payload_type_name||R(e.payload_type??e.type)).toLowerCase().includes("advert");return t.jsx(P,{packet:e,onClick:h,isFlashing:s&&u===e.packet_hash},e.packet_hash)})}),t.jsxs("div",{className:"px-3 py-1.5 border-t border-border-subtle/50 text-[10px] text-text-muted bg-bg-elevated/20 text-center",children:["Showing ",v.length," of ",e.length," packets"]}),x&&t.jsx(D,{packet:x,onClose:()=>h(null)})]})}j.memo(function({active:e,payload:s,label:a,formatValue:n,labelKey:r}){var l;if(!e||!s||0===s.length)return null;const i=r&&(null==(l=s[0])?void 0:l.payload)?s[0].payload[r]:a;return t.jsxs("div",{className:"bg-tooltip-bg border border-border-subtle rounded-lg px-4 py-3 shadow-xl",children:[i&&t.jsx("p",{className:"type-data-xs text-white/50 mb-2",children:i}),t.jsx("div",{className:"space-y-1.5",children:s.map((e,s)=>t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("span",{className:"w-2 h-2 rounded-full flex-shrink-0",style:{backgroundColor:e.color}}),t.jsx("span",{className:"type-body-sm text-white/70 capitalize min-w-[60px]",children:e.name}),t.jsx("span",{className:"type-data-sm text-white tabular-nums",children:n?n(e.value,e.name):e.value.toLocaleString()})]},s))})]})});const ue=j.memo(function({active:e,payload:s,color:a,labelKey:n,unit:r=""}){var l,i;if(!e||!s||0===s.length)return null;const o=s[0],c=null==(l=null==o?void 0:o.payload)?void 0:l[n];return t.jsxs("div",{className:"bg-tooltip-bg border border-border-subtle rounded-lg px-3 py-2 shadow-xl",children:[t.jsx("p",{className:"type-data-xs text-white/50 mb-1",children:c}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("span",{className:"w-2 h-2 rounded-full",style:{backgroundColor:a}}),t.jsxs("span",{className:"type-data-sm text-white tabular-nums",children:[null==(i=null==o?void 0:o.value)?void 0:i.toLocaleString(),r]})]})]})});j.memo(function({payload:e}){return e&&0!==e.length?t.jsx("div",{className:"flex items-center justify-center gap-6 mt-4 pt-4 border-t border-white/5",children:e.map((e,s)=>t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("span",{className:"w-2 h-2 rounded-full",style:{backgroundColor:e.color}}),t.jsx("span",{className:"type-body-sm text-white/60 capitalize",children:e.value})]},s))}):null});const me=.2;function xe(e,t=1){return Math.floor(5*t*e)}function he(e){const t=Math.round(e/me)*me;return Math.max(0,Math.min(5,t))}function pe({stats:e,receivedBuckets:s,droppedBuckets:a,forwardedBuckets:n,bucketDurationSeconds:r,timeRangeLabel:l}){var i,o,c,d;const u=j.useMemo(()=>function(e,t,s,a,n){var r,l;const i=(null==t?void 0:t.reduce((e,t)=>e+t.count,0))??0,o=(null==s?void 0:s.reduce((e,t)=>e+t.count,0))??0,c=(null==a?void 0:a.reduce((e,t)=>e+t.count,0))??0,d=i>0?i:(null==e?void 0:e.rx_count)||1,u=o>0?o:(null==e?void 0:e.dropped_count)||0,m=d>0?u/(d+u)*100:0;let x=0;if(a&&a.length>0&&n)x=100*c/(a.length*n*1e3)*100;else if(e){const t=1e3*(e.uptime_seconds||1);x=(e.total_airtime_ms||e.airtime_used_ms||0)/t*100}const h=(null==e?void 0:e.neighbors)||{},p=Object.values(h).filter(e=>!0===e.zero_hop).length;let v=1;m<3?v-=me:m>15?v+=.4:m>10&&(v+=me),x>5&&(v+=me),p>10&&(v+=me);const g=he(v),f=he(.28*g),j=xe(g),b=xe(f),y=xe((null==(l=null==(r=null==e?void 0:e.config)?void 0:r.delays)?void 0:l.tx_delay_factor)??1);let k;return k=j>y?"increase":j<y?"decrease":"stable",{floodFactor:g,directFactor:f,floodSlots:j,directSlots:b,adjustment:k,duplicateRate:Math.round(100*m)/100,txUtilization:Math.round(1e3*x)/1e3,zeroHopCount:p,totalReceived:i,totalDropped:o}}(e,s,a,n,r),[e,s,a,n,r]),m=(null==(o=null==(i=null==e?void 0:e.config)?void 0:i.delays)?void 0:o.tx_delay_factor)??null,x=(null==(d=null==(c=null==e?void 0:e.config)?void 0:c.delays)?void 0:d.direct_tx_delay_factor)??null,h=null!==m?xe(m):null,p=null!==h&&u.floodSlots!==h,v="increase"===u.adjustment?E:"decrease"===u.adjustment?q:I;return t.jsxs("div",{className:"data-card flex flex-col",children:[t.jsxs("div",{className:"flex items-center gap-2 mb-3 flex-wrap",children:[t.jsx(ne,{className:"w-4 h-4 text-[var(--metric-transmitted)] flex-shrink-0"}),t.jsx("span",{className:"type-micro",children:"TX DELAY"}),l&&t.jsx("span",{className:"pill-tag",children:l}),p&&t.jsxs("span",{className:"pill-tag flex items-center gap-1 "+("increase"===u.adjustment?"bg-accent-warning/20 text-accent-warning border-accent-warning/30":"bg-accent-success/20 text-accent-success border-accent-success/30"),children:[t.jsx(v,{className:"w-3 h-3"}),"increase"===u.adjustment?"+":"-",Math.abs(u.floodSlots-(h??0))]})]}),t.jsxs("div",{className:"data-card-value",children:["×",u.floodFactor.toFixed(1)]}),t.jsxs("div",{className:"flex-1 grid grid-cols-2 gap-x-3 gap-y-1 py-2 mt-2 text-xs",children:[t.jsxs("div",{className:"flex justify-between",children:[t.jsx("span",{className:"text-text-muted",children:"Flood"}),t.jsxs("span",{className:"tabular-nums text-accent-secondary font-medium",children:[u.floodSlots," slots"]})]}),t.jsxs("div",{className:"flex justify-between",children:[t.jsx("span",{className:"text-text-muted",children:"Direct"}),t.jsxs("span",{className:"tabular-nums text-accent-secondary font-medium",children:[u.directSlots," slots"]})]}),t.jsxs("div",{className:"flex justify-between",children:[t.jsx("span",{className:"text-text-muted",children:"Dup Rate"}),t.jsxs("span",{className:"tabular-nums "+(u.duplicateRate>10?"text-accent-warning":"text-text-secondary"),children:[u.duplicateRate.toFixed(1),"%"]})]}),t.jsxs("div",{className:"flex justify-between",children:[t.jsx("span",{className:"text-text-muted",children:"TX Util"}),t.jsxs("span",{className:"tabular-nums text-text-secondary",children:[u.txUtilization.toFixed(2),"%"]})]})]}),t.jsx("div",{className:"type-label text-text-muted border-t border-border-subtle pt-3 mt-2 truncate",children:null!==m?t.jsxs("span",{children:["Current: ×",m.toFixed(1)," / ×",(null==x?void 0:x.toFixed(1))??"—"]}):t.jsx("span",{children:"Slot-aligned factors"})})]})}function ve({trend:e}){return"stable"===e?t.jsx("span",{className:"mini-widget-trend stable",children:t.jsx("svg",{className:"w-3 h-3",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 12h14"})})}):"up"===e?t.jsx("span",{className:"mini-widget-trend up",children:t.jsx("svg",{className:"w-3 h-3",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 15l7-7 7 7"})})}):t.jsx("span",{className:"mini-widget-trend down",children:t.jsx("svg",{className:"w-3 h-3",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})})}function ge(){return t.jsx("div",{className:"mini-widget-loading",children:t.jsx("div",{className:"mini-widget-loading-spinner"})})}function fe({message:e}){return t.jsx("div",{className:"mini-widget-error",children:t.jsx("span",{title:e,children:"No data"})})}function je({title:e,icon:s,value:a,unit:n,valueSize:r="md",status:l,subtitle:i,trend:o,children:c,isLoading:d=!1,error:u,className:m="",onClick:x}){const h=["mini-widget-value","lg"===r&&"mini-widget-value-lg","sm"===r&&"mini-widget-value-sm",""].filter(Boolean).join(" "),p=["mini-widget",x&&"cursor-pointer",m].filter(Boolean).join(" ");return t.jsxs("div",{className:p,onClick:x,role:x?"button":void 0,children:[t.jsxs("div",{className:"mini-widget-header",children:[s,t.jsx("span",{className:"mini-widget-title",children:e}),l&&"unknown"!==l&&t.jsx("div",{className:`mini-widget-status-dot ${l}`}),o&&t.jsx(ve,{trend:o})]}),d?t.jsx(ge,{}):u?t.jsx(fe,{message:u}):t.jsxs(t.Fragment,{children:[void 0!==a&&t.jsxs("div",{className:h,children:[a,n&&t.jsx("span",{className:"mini-widget-unit",children:n})]}),i&&t.jsx("div",{className:"mini-widget-subtitle",children:i}),c]})]})}const be=j.createContext({lbtStats:null,noiseFloor:null,linkQuality:null,channelHealth:null,trends:null,stats:null,recentPackets:[],quickNeighbors:[],isLoading:!0,error:null,refresh:async()=>{}});function ye(e){if(!e)return[];try{const t=JSON.parse(e);if(Array.isArray(t))return t.map(Number).filter(e=>!isNaN(e))}catch{}return[]}function ke(e,t,s=2,a=!1){if(null===t)return"stable";const n=e-t;return(0!==t?100*Math.abs(n/t):Math.abs(n))<s?"stable":a?n>0?"up":"down":n>0?"down":"up"}function Ne({children:e}){const a=o(),n=s(),r=c(),l=d(),i=null===a,u=j.useMemo(()=>function(e){const t=Math.floor(Date.now()/1e3),s=t-86400,a=e.filter(e=>e.timestamp>=s&&void 0!==e.lbt_attempts&&e.lbt_attempts>0),n=a.length,r=a.filter(e=>(e.lbt_attempts??0)>1).length,l=n>0?r/n*100:0,i=a.filter(e=>(e.lbt_attempts??0)>1),o=i.length>0?i.reduce((e,t)=>e+(t.lbt_attempts??0),0)/i.length:0,c=a.filter(e=>!0===e.lbt_channel_busy||1===e.lbt_channel_busy).length,d=n>0?c/n*100:0,u=[];for(const v of a){const e=ye(v.lbt_backoff_delays_ms);u.push(...e)}const m=u.reduce((e,t)=>e+t,0),x=u.length>0?m/u.length:0,h=u.length>0?Math.max(...u):0,p=[];for(let v=0;v<24;v++){const e=t-3600*(24-v),s=e+3600,n=a.filter(t=>t.timestamp>=e&&t.timestamp<s),r=n.filter(e=>(e.lbt_attempts??0)>1).length,l=n.length>0?r/n.length*100:0;p.push(l)}return{totalPacketsWithLBT:n,packetsWithRetries:r,retryRate:l,avgRetries:o,channelBusyCount:c,channelBusyRate:d,avgBackoffMs:x,maxBackoffMs:h,totalBackoffMs:m,hourlyRetryRates:p,windowHours:24,packetCount:e.length}}(n),[n]),m=(null==a?void 0:a.noise_floor_dbm)??null,x=null==a?void 0:a.neighbors,h=j.useMemo(()=>{const e=x??{};return Object.fromEntries(Object.entries(e).filter(([e])=>!l.has(e)))},[x,l]),p=j.useMemo(()=>r.filter(e=>!l.has(e.hash)),[r,l]),v=j.useMemo(()=>function(e,t){if(0===e.length)return{neighbors:[],networkScore:0,neighborCount:0,bestLink:null,worstLink:null};const s=e.map(e=>{const s=function(e,t){let s=50;void 0!==e&&(s=e>=10?100:e>=5?80:e>=0?60:e>=-5?40:20);let a=50;return void 0!==t&&(a=t>=-70?100:t>=-80?80:t>=-90?60:t>=-100?40:20),Math.round(.6*s+.4*a)}(e.avgSnr??void 0,e.avgRssi??void 0),a=t[e.hash];return{name:(null==a?void 0:a.name)||(null==a?void 0:a.node_name)||e.prefix,hash:e.hash,rssi:e.avgRssi??-100,snr:e.avgSnr??-10,score:s,advertCount:e.count}});s.sort((e,t)=>t.score-e.score);const a=s.length>0?s.reduce((e,t)=>e+t.score,0)/s.length:0;return{neighbors:s,networkScore:Math.round(a),neighborCount:s.length,bestLink:s.length>0?{name:s[0].name,score:s[0].score}:null,worstLink:s.length>0?{name:s[s.length-1].name,score:s[s.length-1].score}:null}}(p,h),[p,h]),g=j.useMemo(()=>function(e,t,s){const a=e?Math.max(0,Math.min(100,100-5*e.retryRate)):50;let n=50;null!==t&&(n=Math.max(0,Math.min(100,(t+120)/30*100)));const r=(null==s?void 0:s.networkScore)??50,l=Math.round(.35*a+.25*n+.4*r);let i;return i=l>=85?"excellent":l>=70?"good":l>=50?"fair":l>=30?"congested":"critical",{score:l,status:i,components:{lbtHealth:Math.round(a),noiseHealth:Math.round(n),linkHealth:Math.round(r)}}}(u,m,v),[u,m,v]),[f,b]=j.useState({noiseFloor:null,networkScore:null,channelHealth:null}),y=j.useRef(0);j.useEffect(()=>{const e=()=>{const e=Date.now();e-y.current>3e4&&(y.current=e,b({noiseFloor:m,networkScore:(null==v?void 0:v.networkScore)??null,channelHealth:(null==g?void 0:g.score)??null}))};e();const t=setInterval(e,5e3);return()=>clearInterval(t)},[m,null==v?void 0:v.networkScore,null==g?void 0:g.score]);const k=j.useMemo(()=>({noiseFloor:{current:m,previous:f.noiseFloor,trend:null!==m?ke(m,f.noiseFloor,2,!0):"stable"},networkScore:{current:(null==v?void 0:v.networkScore)??0,previous:f.networkScore,trend:ke((null==v?void 0:v.networkScore)??0,f.networkScore,3,!1)},channelHealth:{current:(null==g?void 0:g.score)??0,previous:f.channelHealth,trend:ke((null==g?void 0:g.score)??0,f.channelHealth,3,!1)}}),[m,null==v?void 0:v.networkScore,null==g?void 0:g.score,f]),N={lbtStats:u,noiseFloor:m,linkQuality:v,channelHealth:g,trends:k,stats:a,recentPackets:n,quickNeighbors:r,isLoading:i,error:null,refresh:async()=>{}};return t.jsx(be.Provider,{value:N,children:e})}function we(){const e=j.useContext(be);if(void 0===e)throw new Error("useLBTData must be used within an LBTDataProvider");return e}const Me={excellent:"var(--signal-excellent)",good:"var(--signal-good)",fair:"var(--signal-fair)",congested:"var(--signal-poor)",critical:"var(--signal-critical)",unknown:"var(--text-muted)"};function Le(){const{lbtStats:e,isLoading:s,error:a}=we(),n=u(),r=(null==e?void 0:e.retryRate)??0,l=(null==e?void 0:e.avgBackoffMs)??0,i=e?(o=r)<2?"excellent":o<5?"good":o<10?"fair":o<20?"congested":"critical":"unknown";var o;const c=null==e?void 0:e.hourlyRetryRates,d=j.useMemo(()=>!c||c.length<2?[]:c.map(e=>({value:e})),[c]),m=Me[i];return t.jsx(je,{title:"LBT Retries",icon:t.jsx(te,{className:"mini-widget-icon"}),value:r.toFixed(1),unit:"%",status:i,subtitle:e?`Avg ${Math.round(l)}ms backoff`:void 0,isLoading:s,error:a,onClick:()=>n("/packets"),children:t.jsx("div",{className:"mini-widget-sparkline",children:d.length>0?t.jsx(b,{width:"100%",height:"100%",children:t.jsx(y,{data:d,margin:{top:2,right:2,bottom:2,left:2},children:t.jsx(k,{type:"monotone",dataKey:"value",stroke:m,strokeWidth:1,dot:!1,isAnimationActive:!1})})}):t.jsx("div",{className:"h-full"})})})}function _e(){const{lbtStats:e,isLoading:s,error:a}=we(),n=u(),r=(null==e?void 0:e.channelBusyCount)??0,l=(null==e?void 0:e.totalPacketsWithLBT)??0,i=(null==e?void 0:e.channelBusyRate)??0,o=e?(c=i)<.5?"excellent":c<1?"good":c<2?"fair":c<5?"congested":"critical":"unknown";var c;return t.jsx(je,{title:"Ch. Busy",icon:t.jsx(ee,{className:"mini-widget-icon"}),value:r,status:o,subtitle:e?`${i.toFixed(2)}% of ${l} TX`:void 0,isLoading:s,error:a,onClick:()=>n("/packets")})}function Se(e){return null===e?"No reading":e<-115?"Very quiet":e<-105?"Quiet":e<-95?"Moderate":e<-85?"Elevated":"High interference"}function Ce(){const{noiseFloor:e,trends:s,isLoading:a,error:n}=we(),r=null===(l=e)||l<-110?"excellent":l<-100?"good":l<-90?"fair":l<-80?"congested":"critical";var l;const i=null==s?void 0:s.noiseFloor.trend;return t.jsx(je,{title:"Noise Floor",icon:t.jsx(Y,{className:"mini-widget-icon"}),value:null!==e?Math.round(e):"—",unit:null!==e?"dBm":void 0,status:r,trend:i,subtitle:Se(e),isLoading:a,error:n})}function Be(){const{linkQuality:e,trends:s,isLoading:a,error:n}=we(),r=u(),l=(null==e?void 0:e.networkScore)??0,i=(null==e?void 0:e.neighborCount)??0,o=e?(c=l)>=80?"excellent":c>=60?"good":c>=40?"fair":c>=20?"congested":"critical":"unknown";var c;const d=null==s?void 0:s.networkScore.trend;return t.jsx(je,{title:"Network Score",icon:t.jsx(W,{className:"mini-widget-icon"}),value:Math.round(l),unit:"/100",status:o,trend:d,subtitle:e?`${i} direct neighbor${1!==i?"s":""}`:void 0,isLoading:a,error:n,onClick:()=>r("/contacts")})}function Fe(e,t=8){return e.length<=t?e:e.substring(0,t-1)+"…"}function Re(){const{linkQuality:e,isLoading:s,error:a}=we(),n=u(),r=null==e?void 0:e.bestLink,l=null==e?void 0:e.worstLink,i=l?(o=l.score)>=60?"excellent":o>=40?"good":o>=25?"fair":o>=10?"congested":"critical":"unknown";var o;const c=e&&r&&l?t.jsxs("div",{className:"flex flex-col gap-0.5 mt-auto",children:[t.jsxs("div",{className:"flex items-center justify-between text-xs",children:[t.jsx("span",{className:"text-text-muted",children:"Best:"}),t.jsxs("span",{className:"font-mono text-signal-excellent",children:[Fe(r.name)," (",Math.round(r.score),")"]})]}),t.jsxs("div",{className:"flex items-center justify-between text-xs",children:[t.jsx("span",{className:"text-text-muted",children:"Worst:"}),t.jsxs("span",{className:"font-mono "+(l.score>=40?"text-signal-fair":"text-signal-critical"),children:[Fe(l.name)," (",Math.round(l.score),")"]})]})]}):e&&0===e.neighborCount?t.jsx("div",{className:"flex items-center justify-center text-xs text-text-muted mt-auto",children:"No direct neighbors"}):null;return t.jsx(je,{title:"Link Range",icon:t.jsx(se,{className:"mini-widget-icon"}),status:i,isLoading:s,error:a,onClick:()=>n("/contacts"),children:c})}function Te(){const{lbtStats:e,isLoading:s,error:a}=we(),n=e?function(e){const{retryRate:t,channelBusyCount:s,totalPacketsWithLBT:a,avgBackoffMs:n,maxBackoffMs:r}=e;if(0===a)return 0;const l=Math.min(a/10,1),i=Math.log(1+.15*t)/Math.log(16)*40,o=s/a*100,c=Math.min(.5*o,25);let d=0;n>100&&(d=Math.min(8*Math.log10(n/100),15));let u=0;r>500&&n>0&&r>2*n&&(u=Math.min((r-500)/200,5));const m=(i+c+d+u)*l;return Math.min(m,85)}(e):0,r=e?(l=n)<5?"excellent":l<15?"good":l<30?"fair":l<50?"congested":"critical":"unknown";var l;const i=(null==e?void 0:e.maxBackoffMs)??0,o=e?i>200?`Max backoff: ${Math.round(i)}ms`:function(e){return e<5?"Clear channel":e<15?"Light traffic":e<30?"Moderate traffic":e<50?"Heavy traffic":e<70?"Congested":"Severe congestion"}(n):void 0;return t.jsx(je,{title:"Collision Risk",icon:t.jsx(V,{className:"mini-widget-icon"}),value:n.toFixed(1),unit:"%",status:r,subtitle:o,isLoading:s,error:a})}function He(e){switch(e){case"excellent":return"Excellent";case"good":return"Good";case"fair":return"Fair";case"congested":return"Congested";case"critical":return"Critical";default:return"Unknown"}}function Pe(){const{channelHealth:e,trends:s,isLoading:a,error:n}=we(),r=(null==e?void 0:e.score)??0,l=(null==e?void 0:e.status)??"excellent",i=null==s?void 0:s.channelHealth.trend,o=e?t.jsx("div",{className:"mini-widget-progress mt-auto",children:t.jsx("div",{className:`mini-widget-progress-bar ${l}`,style:{width:`${r}%`}})}):null;return t.jsx(je,{title:"Channel Health",icon:t.jsx(Z,{className:"mini-widget-icon"}),value:Math.round(r),unit:"/100",status:l,trend:i,subtitle:e?He(l):void 0,isLoading:a,error:n,children:o})}function De(){const[e,s]=j.useState(!1),[a]=j.useState(0),{stats:n,lbtStats:r,isLoading:i}=we(),o=j.useMemo(()=>{if(!n)return null;const e=n.airtime_used_ms??0,t=n.max_airtime_ms??1;return{usedMs:e,maxMs:t,remainingMs:n.airtime_remaining_ms??0,utilizationPercent:n.utilization_percent??(t>0?e/t*100:0)}},[n]),c=j.useMemo(()=>{if(!r||0===r.totalPacketsWithLBT)return 100;const e=r.channelBusyCount,t=r.totalPacketsWithLBT;return(t-e)/t*100},[r]),d=(null==o?void 0:o.utilizationPercent)??0,u=(m=d)<30?"excellent":m<50?"good":m<70?"fair":m<90?"congested":"critical";var m;const x=(null==o?void 0:o.remainingMs)??0,h=c<99?`${c.toFixed(0)}% TX success`:((p=x)<1e3?`${Math.round(p)}ms`:p<6e4?`${(p/1e3).toFixed(1)}s`:`${(p/6e4).toFixed(1)}m`)+" remaining";var p;const v=o?t.jsx("div",{className:"mini-widget-progress mt-auto",children:t.jsx("div",{className:`mini-widget-progress-bar ${u}`,style:{width:`${Math.min(d,100)}%`}})}):null;return t.jsx(je,{title:"Duty Cycle",icon:t.jsx(l,{className:"mini-widget-icon"}),value:d.toFixed(1),unit:"%",status:u,subtitle:h,isLoading:i,children:v})}function Ae({className:e=""}){return t.jsx(Ne,{children:t.jsxs("div",{className:`mesh-health-container ${e}`,children:[t.jsxs("div",{className:"mesh-health-header",children:[t.jsx(ae,{className:"w-4 h-4 text-accent-primary"}),t.jsx("span",{className:"type-label text-text-muted",children:"MESH HEALTH"})]}),t.jsxs("div",{className:"widget-row",children:[t.jsx(Pe,{}),t.jsx(Le,{}),t.jsx(_e,{}),t.jsx(Te,{}),t.jsx(Ce,{}),t.jsx(Be,{}),t.jsx(Re,{}),t.jsx(De,{})]})]})})}function $e(){var e;const s=o(),a=m(),n=x(),r=F(),[i,c]=j.useState(0),[d,u]=j.useState(null),[y,k]=j.useState(!1),R=C(i,150),T=h[i],H=j.useMemo(()=>function(e,t){if(!e||0===e.length)return[];const s=t>1440;return e.map(e=>{const t=new Date(1e3*e.start);return{time:s?t.toLocaleDateString([],{weekday:"short",hour:"2-digit",minute:"2-digit",hour12:!1}):t.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hour12:!1}),received:e.count}})}(null==d?void 0:d.received,T.minutes),[null==d?void 0:d.received,T.minutes]),P=j.useMemo(()=>{const e=H.length;return e<=12?0:e<=24?2:e<=48?5:e<=72?8:Math.floor(e/7)},[H.length]),D=j.useCallback(async()=>{try{const e=h[R],t=await p(e.minutes,e.buckets);t.success&&t.data&&u(t.data)}catch{}},[R]);j.useEffect(()=>{const e=new AbortController,t=async()=>{await D()};t();const s=setInterval(()=>{t()},v.charts);return()=>{e.abort(),clearInterval(s)}},[D]),j.useEffect(()=>{if(n>0){const e=requestAnimationFrame(()=>k(!0)),t=setTimeout(()=>k(!1),600);return()=>{cancelAnimationFrame(e),clearTimeout(t)}}},[n]);const $=(null==s?void 0:s.uptime_seconds)?g(s.uptime_seconds):"0m",W=(null==s?void 0:s.node_name)||(null==(e=null==s?void 0:s.config)?void 0:e.node_name)||"Unknown Node",q=j.useMemo(()=>{var e,t,s,a;const n=(null==(e=null==d?void 0:d.received)?void 0:e.reduce((e,t)=>e+t.count,0))??0,r=(null==(t=null==d?void 0:d.forwarded)?void 0:t.reduce((e,t)=>e+t.count,0))??0,l=(null==(s=null==d?void 0:d.dropped)?void 0:s.reduce((e,t)=>e+t.count,0))??0,i=(null==(a=null==d?void 0:d.transmitted)?void 0:a.reduce((e,t)=>e+t.count,0))??0,o=((null==d?void 0:d.time_range_minutes)??T.minutes)/60;return{received:n,forwarded:r,dropped:l,transmitted:i,rxPerHour:o>0?Math.round(n/o):0,fwdPerHour:o>0?Math.round(r/o):0}},[d,T.minutes]);return a?t.jsxs(O,{className:"p-8 text-center",children:[t.jsx("p",{className:"type-subheading text-accent-red mb-2",children:"Failed to connect to backend"}),t.jsx("p",{className:"type-body text-white/50",children:a}),t.jsx("p",{className:"type-data-sm text-white/40 mt-4",children:"Make sure the Python backend is running on port 8000"})]}):t.jsxs(K,{children:[t.jsx(U,{title:W,icon:t.jsx(X,{}),controls:t.jsx(B,{ranges:h,selectedIndex:i,onSelect:c})}),t.jsx(G,{template:"hero",children:t.jsxs(O,{className:"relative",children:[y&&t.jsx("div",{className:"flash-overlay"}),t.jsx(Q,{icon:t.jsx(E,{}),title:"RECEIVED",badge:T.label,iconColor:"text-accent-success"}),t.jsx("div",{className:"type-hero font-semibold",style:{color:r.received},children:q.received.toLocaleString()}),t.jsxs("div",{className:"type-body-sm text-text-muted mt-1",children:[q.rxPerHour,"/hr rate"]}),H.length>0?t.jsx("div",{className:"flex-1 mt-4 min-h-0",children:t.jsx(b,{width:"100%",height:"100%",children:t.jsxs(N,{data:H,children:[t.jsx("defs",{children:t.jsxs("linearGradient",{id:"gradient-received",x1:"0",y1:"0",x2:"0",y2:"1",children:[t.jsx("stop",{offset:"5%",stopColor:r.received,stopOpacity:.3}),t.jsx("stop",{offset:"95%",stopColor:r.received,stopOpacity:0})]})}),t.jsx(w,{strokeDasharray:"3 3",stroke:"rgba(255,255,255,0.06)",vertical:!1}),t.jsx(M,{dataKey:"time",axisLine:!1,tickLine:!1,tick:{fill:"rgba(255,255,255,0.4)",fontSize:10,fontFamily:"'JetBrains Mono', monospace"},dy:8,interval:P,minTickGap:20}),t.jsx(L,{axisLine:!1,tickLine:!1,tick:{fill:"rgba(255,255,255,0.4)",fontSize:10,fontFamily:"'JetBrains Mono', monospace"},dx:-8,width:40}),t.jsx(_,{content:t.jsx(ue,{color:r.received,labelKey:"time",unit:" packets"}),cursor:{stroke:"rgba(255,255,255,0.2)",strokeWidth:1}}),t.jsx(S,{type:"stepAfter",dataKey:"received",stroke:r.received,fill:"url(#gradient-received)",strokeWidth:1,dot:!1,activeDot:{r:4,strokeWidth:0,fill:r.received},isAnimationActive:!1})]})})}):t.jsx("div",{className:"flex-1 flex items-center justify-center text-text-muted",children:"No data available for this time range"})]})}),t.jsxs(G,{template:"compact",children:[t.jsx(ce,{title:"FORWARDED",value:q.forwarded,subtitle:`${q.fwdPerHour}/hr rate`,color:"forwarded",buckets:null==d?void 0:d.forwarded,timeRangeLabel:T.label,icon:t.jsx(J,{className:"w-4 h-4"})}),t.jsx(ce,{title:"DROPPED",value:q.dropped,subtitle:"Filtered or duplicate",color:"dropped",buckets:null==d?void 0:d.dropped,timeRangeLabel:T.label,icon:t.jsx(A,{className:"w-4 h-4"})}),t.jsx(pe,{stats:s,receivedBuckets:null==d?void 0:d.received,droppedBuckets:null==d?void 0:d.dropped,forwardedBuckets:null==d?void 0:d.forwarded,bucketDurationSeconds:null==d?void 0:d.bucket_duration_seconds,timeRangeLabel:T.label}),t.jsx(ce,{title:"UPTIME",value:$,subtitle:"Since last restart",color:"neutral",icon:t.jsx(f,{className:"w-4 h-4"})})]}),t.jsx(Ae,{}),t.jsx(de,{}),s&&t.jsx(G,{template:"auto",children:t.jsxs(O,{children:[t.jsx(Q,{icon:t.jsx(l,{}),title:"Node Information",largeTitle:!0}),t.jsxs("div",{className:"grid grid-cols-2 lg:grid-cols-4 gap-4",children:[t.jsxs("div",{children:[t.jsx("span",{className:"type-label text-text-muted",children:"Node Name"}),t.jsx("p",{className:"type-body text-text-primary mt-1",children:W})]}),t.jsxs("div",{children:[t.jsx("span",{className:"type-label text-text-muted",children:"Version"}),t.jsxs("p",{className:"type-data text-text-primary mt-1",children:["v",s.version]})]}),t.jsxs("div",{children:[t.jsx("span",{className:"type-label text-text-muted",children:"Core Version"}),t.jsxs("p",{className:"type-data text-text-primary mt-1",children:["v",s.core_version]})]}),t.jsxs("div",{children:[t.jsx("span",{className:"type-label text-text-muted",children:"Local Hash"}),t.jsx("div",{className:"mt-1",children:s.local_hash?t.jsx(z,{hash:s.local_hash,size:"sm"}):t.jsx("span",{className:"type-data-sm text-text-muted",children:"N/A"})})]})]}),s.public_key&&t.jsxs("div",{className:"mt-4 pt-4 border-t border-border-subtle",children:[t.jsx("span",{className:"type-label text-text-muted",children:"Public Key"}),t.jsx("div",{className:"mt-1",children:t.jsx(z,{hash:s.public_key,prefixLength:12,suffixLength:8})})]})]})})]})}export{$e as default};
