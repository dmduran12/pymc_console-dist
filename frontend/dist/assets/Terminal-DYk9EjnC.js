var e=Object.defineProperty,t=(t,r,n)=>((t,r,n)=>r in t?e(t,r,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[r]=n)(t,"symbol"!=typeof r?r+"":r,n);import{j as r,r as n,c as s}from"./vendor-react-j_fHog8x.js";import{D as a,o,L as i}from"./xterm-Cq-DlOOL.js";import{bu as c,bv as l,bw as u,bx as d,by as p,bz as m,bA as h,bB as f,b3 as g,a7 as $,bC as y,$ as w,_ as v,aA as b,bD as x,bE as _,bF as k,bn as S,K as C,bG as j,N,n as T,bH as E,bI as R,bJ as A}from"./index-B51aMfiH.js";import{s as I}from"./signal-scoring-CcBiRcks.js";import{h as F,c as M,D as L}from"./geo-utils-n2lfanuR.js";import{a as D}from"./ping-DLWlYTPp.js";import{c as O}from"./vendor-core-CDNU4oKM.js";import{P as B,d as P}from"./payload-decoders-ClAu_OX0.js";import{g as H,r as U}from"./system-BlyXhV8d.js";import{g as z,K as q,F as W,S as X}from"./KeycapButton-edNKeR5-.js";import{P as K,b as G,B as J,a as V}from"./PageLayout-DUXmuiZg.js";import"./maplibre-gl-b91ci4Kr.js";class Y{constructor(){t(this,"commands",[])}register(...e){this.commands.push(...e)}find(e){let t;for(const r of this.commands)r.matches(e)&&(!t||r.name.length>t.name.length)&&(t=r);return t}all(){return this.commands}}class Q{constructor(){t(this,"aliases",[]),t(this,"params")}matches(e){const t=e.toLowerCase().trim(),r=e=>t===e||t.startsWith(e+" ");return r(this.name)||this.aliases.some(r)}argsAfterName(e){const t=e.toLowerCase().trim(),r=[this.name,...this.aliases].sort((e,t)=>t.length-e.length);for(const n of r)if(t.startsWith(n))return e.trim().slice(n.length).trim();return e.trim()}}const Z="[",ee=`${Z}0m`,te=`${Z}1m`,re=`${Z}2m`,ne=`${Z}3m`,se=`${Z}32m`,ae=`${Z}31m`,oe=`${Z}33m`,ie=`${Z}36m`,ce=`${Z}34m`,le=`${Z}90m`,ue=`${Z}92m`,de=`${Z}96m`;function pe(e,t){switch(t){case"success":return`${se}${e}${ee}`;case"error":return`${ae}${e}${ee}`;case"warning":return`${oe}${e}${ee}`;case"info":return`${ie}${e}${ee}`;case"value":return`${ce}${e}${ee}`;case"system":return`${le}${e}${ee}`;default:return e}}function me(e){return`${te}${e}${ee}`}function he(e){return`${re}${e}${ee}`}function fe(e){return`${ce}${e}${ee}`}function ge(e){return`${le}${e}${ee}`}function $e(e,t){return`${le}${e}: ${ee}${ce}${te}${t}${ee}`}function ye(e,t,r=22){const n=e.split(" "),s=n[0];let a=ie;return"get"===s?a=se:"set"===s&&(a=oe),`  ${n.length>1?`${a}${te}${s}${ee} ${ce}${n.slice(1).join(" ")}${ee}`:`${a}${te}${e}${ee}`}${" ".repeat(Math.max(1,r-e.length))}${le}${t}${ee}`}function we(e){return`${te}${ce}${e}${ee}`}function ve(e){return`${le}${ne}${e}${ee}`}const be=`${le}$ ${ee}`;function xe(e){return`${ae}${te}‚óè${ee} ${le}${e}${ee}`}function _e(e){const t=e<1e3?`${e.toFixed(0)}ms`:`${(e/1e3).toFixed(1)}s`;return`${function(e){return e<1500?ue:e<4e3?se:e<8e3?oe:e<15e3?ae:`${ae}${te}`}(e)}${t}${ee}`}function ke(e,t){return`${function(e){switch(e){case"excellent":return de;case"good":return se;case"fair":return oe;case"poor":return ae;case"critical":return`${ae}${te}`;default:return le}}(t)}${e}${ee}`}const Se=[ae,ae,oe,se,de];function Ce(e,t){return`${Se[t]??le}${e}${ee}`}function je(e){return e.replace(/[\p{Emoji_Presentation}\p{Extended_Pictographic}\uFE0F\u200D]/gu,"").trim()}const Ne="[2K\r";function Te(e=1){return`[${e}A`}const Ee="[?1049l",Re="[?25h";function Ae(e){return e.replace(/\x1b\[[0-9;]*m/g,"")}function Ie(e){return Ae(e).length}function Fe(e,t){let r=0;for(const n of e){const e=Ae(n).length;r+=0===e?1:Math.ceil(e/t)}return r}function Me(e,t){const r=function(e){return getComputedStyle(document.documentElement).getPropertyValue(e).trim()}(e);return r||t}function Le(){const e=Me("--terminal-bg","#0d0d0d"),t=Me("--text-primary","#e0e0e0"),r=Me("--accent-primary","#3b82f6"),n=Me("--accent-primary","#3b82f6")+"40",s=Me("--accent-danger","#ef4444"),a=Me("--accent-success","#22c55e"),o=Me("--accent-secondary","#f59e0b"),i=Me("--accent-primary","#3b82f6"),c=Me("--accent-tertiary","#06b6d4"),l=Me("--text-muted","#666666"),u=Me("--text-secondary","#a0a0a0");return{background:e,foreground:t,cursor:r,cursorAccent:e,selectionBackground:n,selectionForeground:t,black:Me("--bg-surface","#1a1a1a"),red:s,green:a,yellow:o,blue:i,magenta:o,cyan:c,white:t,brightBlack:l,brightRed:s,brightGreen:a,brightYellow:o,brightBlue:i,brightMagenta:o,brightCyan:c,brightWhite:u}}const De="[",Oe=`${De}0m`,Be=`${De}1m`,Pe=`${De}2m`,He=`${De}34m`,Ue=`${De}90m`,ze="        ",qe=[{label:"INFORMATION",entries:[{cmd:"status",desc:"Repeater status summary",alias:"st"},{cmd:"top",desc:"Live system overview (Ctrl+C to exit)",alias:"htop"},{cmd:"uptime",desc:"System uptime"},{cmd:"board",desc:"Board / platform info"},{cmd:"packets",desc:"Packet statistics"}]},{label:"NETWORK",entries:[{cmd:"neighbors [sort]",desc:"Direct RF neighbors",alias:"nb",sub:"sig ¬∑ name ¬∑ rssi ¬∑ snr ¬∑ dist ¬∑ heard"},{cmd:"ping {name}",desc:"Ping neighbor (name or 0xXX)"},{cmd:"identities",desc:"List configured identities",alias:"id ids"},{cmd:"keys",desc:"Transport keys"},{cmd:"acl",desc:"ACL statistics"},{cmd:"rooms",desc:"Room statistics"}]},{label:"RADIO",entries:[{cmd:"get {param}",desc:"Read parameter"},{cmd:"set {param} {value}",desc:"Write parameter"},{cmd:"advert",desc:"Send advertisement"}]},{label:"SYSTEM",entries:[{cmd:"restart",desc:"Restart service",alias:"reboot"},{cmd:"start cap [seconds]",desc:"Start packet capture"},{cmd:"end cap",desc:"Stop capture"},{cmd:"list cap",desc:"List captures"},{cmd:"export cap [id]",desc:"Download capture"}]},{label:"TOOLS",entries:[{cmd:"convert hex {value}",desc:"Hex ‚Üí base64"},{cmd:"convert base64 {value}",desc:"Base64 ‚Üí hex"},{cmd:"clear",desc:"Clear terminal",alias:"cls"},{cmd:"help [command]",desc:"Show this help",alias:"? h"}]}],We=[{cat:"Identity",params:["name","role","lat","lon","public.key"]},{cat:"Radio",params:["radio","freq","tx","bw","sf","cr"]},{cat:"Timing",params:["af","txdelay","direct.txdelay","rxdelay"]},{cat:"Repeater",params:["mode","duty","repeat","flood.max","advert.interval"]},{cat:"Advanced",params:["multi.acks","int.thresh","agc.reset.interval"]},{cat:"set only",params:["log","prv.key"]}];function Xe(e){return`${Ue}${"‚îÄ".repeat(e)}${Oe}`}function Ke(e){const t=Math.max(3,e-12-8-6);return`  ${He}${Be}pymc console${Oe} ${Xe(t)} ${Ue}terminal${Oe}`}function Ge(e){return`  ${Ue}${e}${Oe}`}function Je(e,t){const r=[],n=e.alias?`  ${Pe}${e.alias}${Oe}`:"";return 4+Math.max(e.cmd.length,24)+e.desc.length+(e.alias?2+e.alias.length:0)<=t?r.push("  "+ye(e.cmd,e.desc,24)+n):(r.push("  "+ye(e.cmd,"",24)),r.push(ze+ge(e.desc)+n)),e.sub&&r.push(`${ze}${he("‚îî "+e.sub)}`),r}function Ve(e){return e.split(" ¬∑ ").map(e=>`${He}${e}${Oe}`).join(`${Ue} ¬∑ ${Oe}`)}function Ye(e,t){const r=[];let n=[],s=0;for(const a of e){const e=n.length>0?3+a.length:a.length;s+e>t&&n.length>0?(r.push(n),n=[a],s=a.length):(n.push(a),s+=e)}return n.length>0&&r.push(n),r}function Qe(e){const t=["",Ge("GET/SET QUALIFIERS")],r=Math.max(20,e-4-13);for(const n of We){const e=`${Ue}${n.cat.padEnd(13)}${Oe}`,s=Ye(n.params,r),a=" ".repeat(17);t.push(`    ${e}${Ve(s[0].join(" ¬∑ "))}`);for(let r=1;r<s.length;r++)t.push(`${a}${Ve(s[r].join(" ¬∑ "))}`)}return t}class Ze extends Q{constructor(e){super(),t(this,"name","help"),t(this,"description","Show available commands"),t(this,"aliases",["?","h"]),this.registry=e}execute({output:e,rawInput:t,cols:r}){const n=this.argsAfterName(t).toLowerCase().trim();if(n&&"help"!==n){const t=this.registry.find(n+" help")||this.registry.find(n);return t?void t.execute({output:e,rawInput:t.name+" help",args:[t.name,"help"],cols:r,signal:(new AbortController).signal}):void e.write(`Unknown command: ${fe(n)}`,"warning")}const s=[Ke(r),""];for(const a of qe){s.push(Ge(a.label));for(const e of a.entries)s.push(...Je(e,r));"RADIO"===a.label&&s.push(...Qe(r)),s.push("")}s.push(...function(e){return[`  ${Xe(Math.min(e-4,56))}`,`  ${ve("<command> help for detailed usage")}`]}(r)),e.write(s.join("\n"))}}class et extends Q{constructor(){super(...arguments),t(this,"name","clear"),t(this,"description","Clear terminal screen"),t(this,"aliases",["cls"])}execute({output:e,rawInput:t}){"help"!==this.argsAfterName(t).toLowerCase().trim()?e.clear():e.write([we("clear"),`  ${ge("Clear all terminal output.")}`,"",ye("clear","clear the screen"),"",we("Aliases"),`  ${ge("cls")}`].join("\n"))}}function tt(e){const t=Math.floor(e/86400),r=Math.floor(e%86400/3600),n=Math.floor(e%3600/60);return t>0?`${t}d ${r}h ${n}m`:r>0?`${r}h ${n}m`:`${n}m`}class rt extends Q{constructor(){super(...arguments),t(this,"name","status"),t(this,"description","Get repeater status summary"),t(this,"aliases",["st"])}async execute({output:e,rawInput:t}){var r,n,s;if("help"===this.argsAfterName(t).toLowerCase().trim())return void e.write([we("status"),`  ${ge("Show a quick summary of mode, neighbor count, and uptime.")}`,"",ye("status","show summary"),"",we("Aliases"),`  ${ge("st")}`].join("\n"));const a=e.write("processing...","system");try{const t=await l(),o=(null==(n=null==(r=t.config)?void 0:r.repeater)?void 0:n.mode)||"unknown",i=Object.keys(t.neighbors||{}).length,c=Object.values(t.neighbors||{}).filter(e=>e.zero_hop).length,u=(null==(s=t.config)?void 0:s.node_name)||t.node_name||"unknown",d=tt(t.uptime_seconds||0);e.update(a,[`${me(u)}  ${ge("repeater")}`,"",`  ${$e("Mode",fe(o))}`,`  ${$e("Neighbors",`${fe(String(c))} direct  ${ge(`${i} total`)}`)}`,`  ${$e("RX / TX",`${fe(String(t.rx_count??0))} / ${fe(String(t.tx_count??0))}`)}`,`  ${$e("Uptime",fe(d))}`].join("\n"))}catch(o){e.update(a,`Error: ${o instanceof Error?o.message:"Command failed"}`,"error")}}}class nt extends Q{constructor(){super(...arguments),t(this,"name","uptime"),t(this,"description","Show system uptime")}async execute({output:e,rawInput:t}){if("help"===this.argsAfterName(t).toLowerCase().trim())return void e.write([we("uptime"),`  ${ge("Display how long the repeater service has been running.")}`,"",ye("uptime","show uptime")].join("\n"));const r=e.write("processing...","system");try{const t=await l();e.update(r,$e("Uptime",fe(tt(t.uptime_seconds||0))))}catch(n){e.update(r,`Error: ${n instanceof Error?n.message:"Command failed"}`,"error")}}}class st extends Q{constructor(){super(...arguments),t(this,"name","packets"),t(this,"description","Show packet statistics")}async execute({output:e,rawInput:t}){if("help"===this.argsAfterName(t).toLowerCase().trim())return void e.write([we("packets"),`  ${ge("Display packet counters (received, transmitted, forwarded, dropped).")}`,"",ye("packets","show packet stats")].join("\n"));const r=e.write("processing...","system");try{const t=await l(),n=(t.rx_count??0)+(t.tx_count??0);e.update(r,[we("Packet Stats")+`  ${ge(`${n} total`)}`,"",`  ${$e("Received",fe(String(t.rx_count??0)))}`,`  ${$e("Transmitted",fe(String(t.tx_count??0)))}`,`  ${$e("Forwarded",fe(String(t.forwarded_count??0)))}`,`  ${$e("Dropped",fe(String(t.dropped_count??0)))}`].join("\n"))}catch(n){e.update(r,`Error: ${n instanceof Error?n.message:"Command failed"}`,"error")}}}function at(e){return e>=1073741824?`${(e/1073741824).toFixed(1)} GB`:e>=1048576?`${(e/1048576).toFixed(0)} MB`:`${(e/1024).toFixed(0)} KB`}function ot(e){const t=Math.floor(e/86400),r=Math.floor(e%86400/3600),n=Math.floor(e%3600/60);return t>0?`${t}d ${r}h ${n}m`:r>0?`${r}h ${n}m`:`${n}m`}class it extends Q{constructor(){super(...arguments),t(this,"name","board"),t(this,"description","Show board/platform info")}async execute({output:e,rawInput:t}){var r;if("help"===this.argsAfterName(t).toLowerCase().trim())return void e.write([we("board"),`  ${ge("Display platform and hardware information.")}`,"",ye("board","show board info")].join("\n"));const n=e.write("loading...","system");try{const[t,s]=await Promise.all([u(),l()]),a=[];if(a.push(`  ${$e("Node",fe(s.node_name||"Unknown"))}`),a.push(`  ${$e("Runtime",fe(`pyMC_Repeater v${s.version||"?"}`))}`),s.core_version&&a.push(`  ${$e("Core",fe(s.core_version))}`),a.push(""),t.success&&t.data){const e=t.data;a.push(`  ${$e("CPU",fe(`${e.cpu.usage_percent.toFixed(1)}%`))}  ${ge(`${e.cpu.count} core${e.cpu.count>1?"s":""}`)}`),e.cpu.load_avg&&a.push(`  ${$e("Load",fe(`${e.cpu.load_avg["1min"].toFixed(2)} / ${e.cpu.load_avg["5min"].toFixed(2)} / ${e.cpu.load_avg["15min"].toFixed(2)}`))}`);const n=Object.entries(e.temperatures||{});if(n.length>0){const e=n[0];a.push(`  ${$e("Temp",fe(`${e[1].toFixed(1)}¬∞C`))}${n.length>1?`  ${ge(n.slice(1).map(([e,t])=>`${e}: ${t.toFixed(1)}¬∞C`).join(", "))}`:""}`)}a.push(""),a.push(`  ${$e("Memory",fe(`${at(e.memory.used)} / ${at(e.memory.total)}`))}  ${ge(`${e.memory.usage_percent.toFixed(0)}%`)}`),a.push(`  ${$e("Disk",fe(`${at(e.disk.used)} / ${at(e.disk.total)}`))}  ${ge(`${e.disk.usage_percent.toFixed(0)}%`)}`),a.push(""),(null==(r=e.system)?void 0:r.uptime)&&a.push(`  ${$e("System uptime",fe(ot(e.system.uptime)))}`),a.push(`  ${$e("Service uptime",fe(ot(s.uptime_seconds)))}`),e.network&&a.push(`  ${$e("Net TX/RX",fe(`${at(e.network.bytes_sent)} / ${at(e.network.bytes_recv)}`))}`)}else a.push(`  ${$e("Platform",fe("Linux"))}`),a.push(`  ${$e("Service uptime",fe(ot(s.uptime_seconds)))}`),a.push(`  ${ge("Hardware stats unavailable")}`);e.update(n,a.join("\n"),"value")}catch(s){e.update(n,`Error: ${s instanceof Error?s.message:"Failed to load hardware stats"}`,"error")}}}class ct extends Q{constructor(){super(...arguments),t(this,"name","advert"),t(this,"description","Send repeater advertisement")}async execute({output:e,rawInput:t}){if("help"===this.argsAfterName(t).toLowerCase().trim())return void e.write([we("advert"),`  ${ge("Broadcast a repeater advertisement to the mesh network.")}`,"",ye("advert","send advert now"),"",ve("Adverts announce this repeater's presence to neighbors.")].join("\n"));const r=e.write("processing...","system");try{const t=await d();t.success?e.update(r,`‚úì ${fe("Advert sent")}`,"success"):e.update(r,`Error: ${t.error||"Failed"}`,"error")}catch(n){e.update(r,`Error: ${n instanceof Error?n.message:"Command failed"}`,"error")}}}const lt=["sig","name","rssi","snr","dist","heard"],ut={excellent:5,good:4,fair:3,poor:2,critical:1};function dt(e){const t=Math.floor(Date.now()/1e3-e);return t<60?`${t}s ago`:t<3600?`${Math.floor(t/60)}m ago`:t<86400?`${Math.floor(t/3600)}h ago`:`${Math.floor(t/86400)}d ago`}function pt(e){return e<1e3?`${Math.round(e)}m`:`${(e/1e3).toFixed(1)}km`}const mt=["‚ñÅ","‚ñÉ","‚ñÖ","‚ñá","‚ñà"],ht={excellent:5,good:4,fair:3,poor:2,critical:1};function ft(e){const t=ht[e]??0;return mt.slice(0,t).map((e,t)=>Ce(e,t)).join("")+ge(".".repeat(5-t))}function gt(e,t=e=>e){return{text:e,color:t}}function $t(e){return ge("+"+e.map(e=>"-".repeat(e+2)).join("+")+"+")}function yt(e,t){const r=e.map((e,r)=>{if(null!=e.rendered){const n=Math.max(0,t[r]-e.text.length);return" "+e.rendered+" ".repeat(n)+" "}return" "+e.color((n=e.text,s=t[r],n.length>=s?n.slice(0,s):n+" ".repeat(s-n.length)))+" ";var n,s});return ge("|")+r.join(ge("|"))+ge("|")}class wt extends Q{constructor(){super(...arguments),t(this,"name","neighbors"),t(this,"description","Show direct RF neighbors with signal stats"),t(this,"aliases",["nb","get neighbors","get neighbor"]),t(this,"params","[sig|name|rssi|snr|dist|heard]")}async execute(e){const{output:t,cols:r}=e,n=this.argsAfterName(e.rawInput).toLowerCase().trim();if("help"===n)return void this.printUsage(t);const s=lt.includes(n)?n:null,a=t.write("processing...","system");try{const e=await l(),n=e.neighbors||{},o=Object.entries(n).filter(([,e])=>e.zero_hop);if(0===o.length){const e=Object.keys(n).length;return void t.update(a,e>0?`No direct neighbors. ${e} relayed neighbor${1!==e?"s":""} known.`:"No neighbors discovered yet.","warning")}const i=function(e){var t;const r=null==(t=e.config)?void 0:t.radio;return(null==r?void 0:r.spreading_factor)&&(null==r?void 0:r.bandwidth)?{sf:r.spreading_factor,bwHz:r.bandwidth}:null}(e),c=function(e){var t;const r=null==(t=e.config)?void 0:t.repeater;return r&&F(r.latitude,r.longitude)?{lat:r.latitude,lon:r.longitude}:null}(e),u=e.noise_floor_dbm;this.sortNeighbors(o,s,i,c,u);const d=s?`  ${he(`sorted by ${s}`)}`:"",p=[we(`Direct Neighbors (${o.length})`)+d,""];if(r<55)for(const[t,r]of o)p.push(...this.cardLayout(t,r,i,c,u));else{const e=r>=70&&null!=c,t=o.map(([t,r])=>this.buildRow(t,r,i,c,u,e)),n=e?["SIG","NAME","RSSI","SNR","DIST","HEARD"]:["SIG","NAME","RSSI","SNR","HEARD"],s=n.slice(1).map((e,r)=>Math.max(e.length,...t.map(e=>e[r+1].text.length))),a=5,l=s.reduce((e,t)=>e+t+3,0),d=Math.max(4,r-l-a-7),m=[a,Math.min(d,Math.max(4,...t.map(e=>e[1].text.length))),...s.slice(1)];p.push($t(m),...t.map(e=>yt(e,m)),$t(m),yt(n.map(e=>gt(e,me)),m),$t(m)),p.push(this.footer(i,u))}t.update(a,p.join("\n"))}catch(o){t.update(a,`Error: ${o instanceof Error?o.message:"Command failed"}`,"error")}}sortNeighbors(e,t,r,n,s){switch(t){case"sig":e.sort(([,e],[,t])=>(ut[this.gradeNeighbor(e,r,s)]??0)-(ut[this.gradeNeighbor(t,r,s)]??0));break;case"name":e.sort(([e,t],[r,n])=>{const s=(t.name||t.node_name||e.slice(0,8)).toLowerCase(),a=(n.name||n.node_name||r.slice(0,8)).toLowerCase();return s.localeCompare(a)});break;case"rssi":e.sort(([,e],[,t])=>(e.rssi??-999)-(t.rssi??-999));break;case"snr":e.sort(([,e],[,t])=>(e.snr??-999)-(t.snr??-999));break;case"dist":e.sort(([,e],[,t])=>(this.distTo(e,n)??1/0)-(this.distTo(t,n)??1/0));break;case"heard":e.sort(([,e],[,t])=>(e.last_seen||0)-(t.last_seen||0));break;default:e.sort(([,e],[,t])=>(t.last_seen||0)-(e.last_seen||0))}}gradeNeighbor(e,t,r){const n=null!=e.rssi?e.rssi-3.5:null,s=null!=r&&r>-100?1:0,a=I(e.snr??null,n,t,s);return(null==a?void 0:a.finalGrade)??"critical"}distTo(e,t){return t&&F(e.latitude,e.longitude)?M(t.lat,t.lon,e.latitude,e.longitude):null}buildRow(e,t,r,n,s,a){const o=this.gradeNeighbor(t,r,s),i=je(t.name||t.node_name||e.slice(0,8))||e.slice(0,8),c=null!=t.rssi?`${t.rssi} dBm`:"-",l=null!=t.snr?`${t.snr} dB`:"-",u=t.last_seen?dt(t.last_seen):"-",d=[(p=ft(o),{text:"|||||",color:e=>e,rendered:p}),gt(i,me),gt(c,fe),gt(l,fe)];var p;if(a){const e=this.distTo(t,n);d.push(gt(null!=e?pt(e):"-",he))}return d.push(gt(u,he)),d}cardLayout(e,t,r,n,s){const a=this.gradeNeighbor(t,r,s),o=je(t.name||t.node_name||e.slice(0,8))||e.slice(0,8),i=null!=t.rssi?`${t.rssi}`:"-",c=null!=t.snr?`${t.snr}`:"-",l=t.last_seen?dt(t.last_seen):"-",u=this.distTo(t,n),d=null!=u?`  ${ge("dist")} ${fe(pt(u))}`:"";return[`${ft(a)} ${me(o)}`,`  ${ge("rssi")} ${fe(i)}  ${ge("snr")} ${fe(c)}${d}  ${he(l)}`,""]}footer(e,t){const r=[];return e&&r.push(`SF${e.sf}/${e.bwHz>=1e3?e.bwHz/1e3+"kHz":e.bwHz+"Hz"}`),r.push("ant 3.5dBi"),null!=t&&r.push(`nf ${t}dBm`),ge(r.join("  "))}printUsage(e){const t=[we("neighbors"),`  ${ge("Show direct RF neighbors with signal quality, RSSI, SNR, and distance.")}`,"",we("Usage"),ye("neighbors","default sort (most recent)"),ye("neighbors sig","sort by signal grade (weakest first)"),ye("neighbors name","sort alphabetically"),ye("neighbors rssi","sort by RSSI (weakest first)"),ye("neighbors snr","sort by SNR (lowest first)"),ye("neighbors dist","sort by distance (closest first)"),ye("neighbors heard","sort by last seen (oldest first)"),ye("neighbors help","show this help"),"",we("Aliases"),`  ${ge("nb, get neighbors, get neighbor")}`,"",ve("Signal bars factor radio config, noise floor, and 3.5 dBi antenna gain."),ve("Only zero-hop (direct RF) neighbors are shown.")];e.write(t.join("\n"))}}class vt extends Q{constructor(){super(...arguments),t(this,"name","get"),t(this,"description","Get repeater parameter"),t(this,"params","{parameter}")}async execute({output:e,rawInput:t}){const r=this.argsAfterName(t).toLowerCase().trim();if("help"===r||!r)return void e.write([we("get"),`  ${ge("Read a repeater configuration parameter.")}`,"",we("Identity"),ye("get name","node name"),ye("get role","node role"),ye("get public.key","public key"),"",we("Location"),ye("get lat","latitude"),ye("get lon","longitude"),"",we("Radio"),ye("get radio","full radio summary"),ye("get freq","frequency (MHz)"),ye("get tx","TX power (dBm)"),ye("get bw","bandwidth (kHz)"),ye("get sf","spreading factor"),ye("get cr","coding rate"),"",we("Timing"),ye("get txdelay","TX delay factor"),ye("get direct.txdelay","direct TX delay"),ye("get rxdelay","RX delay base"),"",we("Repeater"),ye("get mode","forward or monitor"),ye("get flood.max","max flood hops"),ye("get advert.interval","advert interval"),ye("get duty","duty cycle state"),"",we("Advanced"),ye("get multi.acks","multi-ack count"),ye("get int.thresh","interference threshold (dBm)"),ye("get agc.reset.interval","AGC reset interval")].join("\n"));const n=e.write("processing...","system");try{const t=await l(),{result:s,type:a}=function(e,t){const r=t.config||{},n=r.radio||{},s=r.repeater||{},a=r.delays||{},o=r.duty_cycle||{},i=(e,t)=>({result:$e(e,fe(t)),type:"value"});switch(e){case"name":return i("name",r.node_name||"Unknown");case"role":return i("role","repeater");case"lat":return i("lat",null!=s.latitude?String(s.latitude):"not set");case"lon":return i("lon",null!=s.longitude?String(s.longitude):"not set");case"freq":return i("freq",n.frequency?`${(n.frequency/1e6).toFixed(3)} MHz`:"?");case"tx":return i("tx",null!=n.tx_power?`${n.tx_power} dBm`:"?");case"bw":return i("bw",n.bandwidth?n.bandwidth/1e3+" kHz":"?");case"sf":return i("sf",String(n.spreading_factor??"?"));case"cr":return i("cr",n.coding_rate?`4/${n.coding_rate}`:"?");case"radio":return n.frequency?{result:[`  ${$e("freq",fe(`${(n.frequency/1e6).toFixed(3)} MHz`))}`,`  ${$e("bw",fe(n.bandwidth/1e3+" kHz"))}`,`  ${$e("sf",fe(String(n.spreading_factor)))}`,`  ${$e("cr",fe(`4/${n.coding_rate}`))}`,`  ${$e("tx",fe(`${n.tx_power} dBm`))}`].join("\n"),type:"value"}:i("radio","?");case"af":case"txdelay":return i("txdelay",String(a.tx_delay_factor??"1.0"));case"direct.txdelay":return i("direct.txdelay",String(a.direct_tx_delay_factor??"0.5"));case"rxdelay":return i("rxdelay",String(a.rx_delay_base??"0.0"));case"mode":return i("mode",s.mode||"forward");case"repeat":return i("repeat","forward"===s.mode?"on":"off");case"flood.max":return i("flood.max",String(s.max_flood_hops??"3"));case"flood.advert.interval":return i("flood.advert.interval",null!=s.send_advert_interval_hours?`${s.send_advert_interval_hours}h`:"?");case"advert.interval":return i("advert.interval",null!=s.advert_interval_minutes?`${s.advert_interval_minutes}m`:"120m");case"duty":case"duty.enabled":return i("duty",o.enforcement_enabled?"on":"off");case"duty.max":return i("duty.max",null!=o.max_airtime_percent?`${o.max_airtime_percent}%`:"?");case"multi.acks":return i("multi.acks",String(s.multi_acks??"0"));case"int.thresh":return i("int.thresh",`${s.interference_threshold??-120} dBm`);case"agc.reset.interval":return i("agc.reset.interval",String(s.agc_reset_interval??"0"));case"public.key":return i("public.key",t.public_key||"not available");case"prv.key":return{result:`${ge("Private key stored in /etc/pymc_repeater/config.yaml")}\n\n  ${$e("view",fe("sudo grep identity_key /etc/pymc_repeater/config.yaml"))}\n  ${$e("set",fe("sudo ./convert_firmware_key.sh <64-byte-hex>"))}`,type:"info"};case"guest.password":case"allow.read.only":return{result:`${ge("Security settings not exposed via stats API.")}\n${ge("Check /etc/pymc_repeater/config.yaml")}`,type:"warning"};default:return{result:`Unknown parameter: ${fe(e)}\n${ge('Run "get help" to see available parameters.')}`,type:"error"}}}(r,t);e.update(n,s,a)}catch(s){e.update(n,`Error: ${s instanceof Error?s.message:"Command failed"}`,"error")}}}class bt extends Q{constructor(){super(...arguments),t(this,"name","set"),t(this,"description","Set repeater parameter"),t(this,"params","{parameter} {value}")}async execute({output:e,rawInput:t}){var r;const n=this.argsAfterName(t).split(/\s+/),s=null==(r=n[0])?void 0:r.toLowerCase(),a=n.slice(1).join(" ");if("help"===s||!s)return void e.write([we("set"),`  ${ge("Write a repeater configuration parameter.")}`,"",we("Identity"),ye("set name <name>","node name"),ye("set lat <deg>","latitude (-90 to 90)"),ye("set lon <deg>","longitude (-180 to 180)"),"",we("Radio"),ye("set freq <MHz>","frequency"),ye("set tx <dBm>","TX power (2-22)"),ye("set bw <kHz>","bandwidth"),ye("set sf <5-12>","spreading factor"),ye("set cr <5-8>","coding rate"),"",we("Timing"),ye("set txdelay <0-5>","TX delay factor"),ye("set direct.txdelay <0-5>","direct TX delay"),ye("set rxdelay <n>","RX delay base"),"",we("Repeater"),ye("set mode <fwd|mon>","forward or monitor"),ye("set flood.max <0-64>","max flood hops"),ye("set advert.interval <m>","advert interval (min)"),ye("set duty <on|off>","duty cycle enforcement"),ye("set log <level>","log level"),"",we("Advanced"),ye("set multi.acks <n>","multi-ack count"),ye("set int.thresh <dBm>","interference threshold"),ye("set agc.reset.interval <n>","AGC reset interval (x4)"),"",ve("Some changes require a service restart.")].join("\n"));const o=e.write("processing...","system");try{const{result:r,type:n}=await async function(e,t,r){switch(e){case"mode":return async function(e){const t=e.toLowerCase();return"forward"!==t&&"monitor"!==t?Nt('Mode must be "forward" or "monitor"'):(await f(t)).success?jt(`OK - Mode set to ${t}`):Nt("Failed")}(t);case"duty":return async function(e){const t="on"===e.toLowerCase()||"1"===e;return(await h(t)).success?jt("OK - Duty cycle "+(t?"enabled":"disabled")):Nt("Failed")}(t);case"tx":return xt("tx_power",kt(t,2,22,"TX power must be 2-22 dBm"));case"sf":return xt("spreading_factor",kt(t,5,12,"SF must be 5-12"));case"af":case"txdelay":return xt("tx_delay_factor",St(t,0,5,"TX delay must be 0.0-5.0"));case"direct.txdelay":return xt("direct_tx_delay_factor",St(t,0,5,"Direct TX delay must be 0.0-5.0"));case"rxdelay":return xt("rx_delay_base",function(e){const t=parseFloat(e);return isNaN(t)||t<0?{ok:!1,error:"Error: RX delay must be >= 0"}:{ok:!0,value:t}}(t));case"flood.max":return xt("max_flood_hops",kt(t,0,64,"Max flood hops must be 0-64"));case"log":return async function(e){const t=e.toUpperCase();if(!["DEBUG","INFO","WARNING","ERROR"].includes(t))return Nt("Level must be debug, info, warning, or error");const r=await m(t);return r.success?jt(`OK - Log level set to ${t}`):Nt(r.error||"Failed")}(t);case"multi.acks":return xt("multi_acks",kt(t,0,255,"Multi-acks must be 0-255"));case"int.thresh":return xt("interference_threshold",kt(t,-200,0,"Interference threshold must be -200 to 0 dBm"));case"agc.reset.interval":{const e=Ct(t);if(!e.ok)return Nt(e.error);if(e.value<0)return Nt("AGC reset interval must be >= 0");const r=4*Math.floor(e.value/4);return _t("agc_reset_interval",r,`OK - AGC reset interval set to ${r}${r!==e.value?` (rounded from ${e.value})`:""}`)}case"name":{const e=r.trim().substring(r.toLowerCase().indexOf("name")+5).trim();return e?xt("node_name",{ok:!0,value:e}):Nt("Node name cannot be empty")}case"lat":return xt("latitude",St(t,-90,90,"Latitude must be -90 to 90"));case"lon":return xt("longitude",St(t,-180,180,"Longitude must be -180 to 180"));case"freq":{const e=St(t,100,1e3,"Frequency must be 100-1000 MHz");return e.ok?xt("frequency",{ok:!0,value:1e6*e.value}):Nt(e.error)}case"bw":{const e=[7.8,10.4,15.6,20.8,31.25,41.7,62.5,125,250,500],r=parseFloat(t);return isNaN(r)||!e.includes(r)?Nt(`BW must be one of: ${e.join(", ")} kHz`):xt("bandwidth",{ok:!0,value:1e3*r})}case"cr":return xt("coding_rate",kt(t,5,8,"Coding rate must be 5-8"));case"advert.interval":{const e=Ct(t);return e.ok?0!==e.value&&(e.value<1||e.value>10080)?Nt("Advert interval must be 0 (off) or 1-10080 minutes"):_t("advert_interval_minutes",e.value,0===e.value?"OK - Local adverts disabled":`OK - Local advert interval set to ${e.value}m`):Nt(e.error)}case"flood.advert.interval":{const e=Ct(t);return e.ok?0!==e.value&&(e.value<3||e.value>48)?Nt("Flood advert interval must be 0 (off) or 3-48 hours"):_t("flood_advert_interval_hours",e.value,0===e.value?"OK - Flood adverts disabled":`OK - Flood advert interval set to ${e.value}h`):Nt(e.error)}case"prv.key":{const e=t.trim();return e?/^[0-9a-fA-F]+$/.test(e)?128!==e.length?Nt(`Key must be 64 bytes (128 hex chars), got ${e.length} chars`):{result:`To set this key, run on the Pi:\n\n  sudo ./convert_firmware_key.sh ${e}\n\nThen restart: sudo systemctl restart pymc-repeater`,type:"info"}:Nt("Private key must be a hex string"):Nt("Private key cannot be empty")}default:return Nt(`Unknown parameter: ${e}`)}}(s,a,t);e.update(o,r,n)}catch(i){e.update(o,`Error: ${i instanceof Error?i.message:"Command failed"}`,"error")}}}async function xt(e,t){if(!t.ok)return Nt(t.error);const r=await p({[e]:t.value});if(!r.success)return Nt(r.error||"Failed");let n=`OK - ${e} set to ${t.value}`;return r.restart_required&&(n+="\n‚ö† Service restart required for changes to take effect\nRun: sudo systemctl restart pymc_repeater"),jt(n)}async function _t(e,t,r){const n=await p({[e]:t});if(!n.success)return Nt(n.error||"Failed");let s=r;return n.restart_required&&(s+="\n‚ö† Service restart required for changes to take effect\nRun: sudo systemctl restart pymc_repeater"),jt(s)}function kt(e,t,r,n){const s=parseInt(e);return isNaN(s)||s<t||s>r?{ok:!1,error:`Error: ${n}`}:{ok:!0,value:s}}function St(e,t,r,n){const s=parseFloat(e);return isNaN(s)||s<t||s>r?{ok:!1,error:`Error: ${n}`}:{ok:!0,value:s}}function Ct(e){const t=parseInt(e);return isNaN(t)?{ok:!1,error:"Error: Expected a number"}:{ok:!0,value:t}}function jt(e){return{result:e,type:"success"}}function Nt(e){return{result:`Error: ${e}`,type:"error"}}const Tt=["‚ñÅ","‚ñÉ","‚ñÖ","‚ñá","‚ñà"],Et={excellent:5,good:4,fair:3,poor:2,critical:1};class Rt extends Q{constructor(){super(...arguments),t(this,"name","ping"),t(this,"description","Ping neighbor (name or 0xXX)"),t(this,"params","{target} [timeout]")}async execute({output:e,rawInput:t}){var r,n,s,a;const o=this.argsAfterName(t).trim(),i=o.split(/\s+/);if("help"===(null==(r=i[0])?void 0:r.toLowerCase()))return void e.write([we("ping"),`  ${ge("Send a ping to a neighbor and measure round-trip time, signal quality, and path.")}`,"",ye("ping <name>","ping by node name"),ye("ping 0xAB","ping by hex prefix"),ye("ping <name> 60","ping with custom timeout (seconds)"),"",ve("Default timeout: 30s. Signal bars factor radio config and noise floor.")].join("\n"));const c=i[i.length-1],u=parseInt(c),d=i.length>1&&!isNaN(u)&&u>0,p=d?i.slice(0,-1).join(" "):o,m=d?u:30;if(!p)return void e.write([we("ping"),`  ${ge("Send a ping to a neighbor and measure round-trip time.")}`,"",ye("ping <name>","ping by node name"),ye("ping <name> 60","with custom timeout"),"",ve('Run "ping help" for full usage.')].join("\n"));const h=e.write(`Pinging ${p}.`,"system");let f=1;const g=setInterval(()=>{f=f%3+1,e.update(h,`Pinging ${p}${".".repeat(f)}`,"system")},800);try{const[t,r]=await Promise.all([D(p,m),l()]);if(clearInterval(g),t.success&&t.data){const o=t.data,i=null==(n=r.config)?void 0:n.radio,c=(null==i?void 0:i.spreading_factor)&&(null==i?void 0:i.bandwidth)?{sf:i.spreading_factor,bwHz:i.bandwidth}:null,l=r.noise_floor_dbm,u=null!=l&&l>-100?1:0,d=o.rssi-3.5,p=I(o.snr_db,d,c,u),m=(null==p?void 0:p.finalGrade)??"critical",f=function(e){const t=Et[e]??0;return Tt.slice(0,t).map((e,t)=>Ce(e,t)).join("")+ge(".".repeat(5-t))}(m),g=(null==(s=o.path)?void 0:s.length)?o.path.length:0,$=(null==(a=o.path)?void 0:a.length)?o.path.join(" > "):"direct",y=m.charAt(0).toUpperCase()+m.slice(1),w=[`${f} ${me("Reply from")} ${fe(o.target_id)}`,"",`  ${$e("RTT",_e(o.rtt_ms))}`,`  ${$e("RSSI",`${o.rssi} dBm`)}`,`  ${$e("SNR",`${o.snr_db} dB`)}`,`  ${$e("Path",$)}${g>0?ge(` (${g} hop${1!==g?"s":""})`):""}`,`  ${$e("Quality",ke(y,m))}`],v=[];c&&v.push(`SF${c.sf}/${c.bwHz>=1e3?c.bwHz/1e3+"kHz":c.bwHz+"Hz"}`),v.push("ant 3.5dBi"),null!=l&&v.push(`nf ${l}dBm`),w.push("",ge(v.join("  "))),e.update(h,w.join("\n"))}else e.update(h,t.error||"Ping failed","error")}catch($){clearInterval(g),e.update(h,`Error: ${$ instanceof Error?$.message:"Ping failed"}`,"error")}}}class At extends Q{constructor(){super(...arguments),t(this,"name","convert"),t(this,"description","Convert between hex and base64"),t(this,"params","hex|base64 {value}")}execute({output:e,args:t}){var r;const n=null==(r=t[1])?void 0:r.toLowerCase(),s=t.slice(2).join(" ").trim();"help"!==n&&(n||s)?"hex"===n?this.hexToBase64(e,s):"base64"===n?this.base64ToHex(e,s):e.write([we("convert"),`  ${ge("Convert between hex and base64 encodings.")}`,"",ye("convert hex <hex>","hex ‚Üí base64"),ye("convert base64 <b64>","base64 ‚Üí hex")].join("\n")):e.write([we("convert"),`  ${ge("Convert between hex and base64 encodings.")}`,"",ye("convert hex <hex>","hex ‚Üí base64"),ye("convert base64 <b64>","base64 ‚Üí hex"),"",ve("Example: convert hex 48656C6C6F")].join("\n"))}hexToBase64(e,t){if(t)if(/^[0-9a-fA-F]+$/.test(t))if(t.length%2==0)try{const r=new Uint8Array(t.length/2);for(let e=0;e<t.length;e+=2)r[e/2]=parseInt(t.substring(e,e+2),16);let n="";const s=8192;for(let e=0;e<r.length;e+=s)n+=String.fromCharCode.apply(null,Array.from(r.subarray(e,Math.min(e+s,r.length))));const a="function"==typeof globalThis.btoa?globalThis.btoa(n):Buffer.from(n,"binary").toString("base64");e.write(`  ${$e("hex",fe(t))}\n  ${$e("base64",fe(a))}`)}catch(r){e.write(`Error: Failed to convert - ${r instanceof Error?r.message:"unknown error"}`,"error")}else e.write("Error: Hex string must have even length","error");else e.write("Error: Input must be a hex string","error");else e.write("Usage: convert hex <hex-string>","error")}base64ToHex(e,t){if(t)try{const r="function"==typeof globalThis.atob?globalThis.atob(t):Buffer.from(t,"base64").toString("binary");let n="";for(let e=0;e<r.length;e++)n+=r.charCodeAt(e).toString(16).padStart(2,"0");e.write(`  ${$e("base64",fe(t))}\n  ${$e("hex",fe(n.toUpperCase()))}`)}catch(r){e.write(`Error: Invalid base64 string - ${r instanceof Error?r.message:"unknown error"}`,"error")}else e.write("Usage: convert base64 <base64-string>","error")}}function It(){const e=new Date;return`${e.toISOString().slice(0,10)}_${e.toTimeString().slice(0,8).replace(/:/g,"-")}`}function Ft(e,t){return`pymc-${e.toISOString().slice(0,10)}-${e.toTimeString().slice(0,5).replace(":","")}-${t}s.json`}const Mt=O((e,t)=>({isCapturing:!1,captureStartTime:null,captureStartPacketHashes:new Set,captureTimer:null,reports:[],startCapture:r=>{const{captureTimer:n}=t();n&&clearTimeout(n),e({isCapturing:!0,captureStartTime:new Date,captureStartPacketHashes:new Set(r.map(e=>e.packet_hash))})},stopCapture:r=>{const{isCapturing:n,captureStartTime:s,captureStartPacketHashes:a,captureTimer:o}=t();if(!n||!s)return null;o&&clearTimeout(o);const i=new Date,c=Math.round((i.getTime()-s.getTime())/1e3),l=s.getTime()/1e3,u=r.filter(e=>!a.has(e.packet_hash)&&e.timestamp>=l).sort((e,t)=>e.timestamp-t.timestamp),d={id:It(),filename:Ft(s,c),startTime:s,endTime:i,durationSec:c,packetCount:u.length,packets:u,sizeBytes:500*u.length};return e(e=>({isCapturing:!1,captureStartTime:null,captureStartPacketHashes:new Set,captureTimer:null,reports:[d,...e.reports].slice(0,10)})),d},getReport:e=>t().reports.find(t=>t.id===e),_setTimer:t=>e({captureTimer:t})})),Lt=()=>Mt(e=>e.reports);function Dt(e){var t;return(null==(t=e.match(/.{1,2}/g))?void 0:t.join(" ").toUpperCase())||""}function Ot(e){return void 0===e?"UNKNOWN":v[e]??`TYPE_${e}`}function Bt(e){return void 0===e?"UNKNOWN":w[e]??`ROUTE_${e}`}function Pt(e,t){switch(e){case 4:return function(e){const t=[];let r=0;if(e.length>=32&&(t.push({name:"public_key",offset:r,length:32,bytes:Dt(y(e.slice(r,r+32))),decoded:{value:y(e.slice(r,r+32))}}),r+=32),e.length>=r+4){const n=e.slice(r,r+4),s=n[0]|n[1]<<8|n[2]<<16|n[3]<<24;t.push({name:"timestamp",offset:r,length:4,bytes:Dt(y(n)),decoded:{value:s>>>0,iso:new Date(1e3*s).toISOString()}}),r+=4}if(e.length>=r+64&&(t.push({name:"signature",offset:r,length:64,bytes:Dt(y(e.slice(r,r+64))),decoded:{value:y(e.slice(r,r+64))}}),r+=64),e.length>r){const n=e[r],s=[];if(1&n&&s.push("CHAT_NODE"),2&n&&s.push("REPEATER"),3&n&&s.push("ROOM_SERVER"),16&n&&s.push("HAS_LOCATION"),128&n&&s.push("HAS_NAME"),t.push({name:"flags",offset:r,length:1,bytes:Dt(y(e.slice(r,r+1))),decoded:{value:n,binary:n.toString(2).padStart(8,"0"),flags:s}}),r+=1,16&n&&e.length>=r+8){const n=e.slice(r,r+8),s=new ArrayBuffer(8);new Uint8Array(s).set(n);const a=new DataView(s),o=a.getInt32(0,!0),i=a.getInt32(4,!0);t.push({name:"location",offset:r,length:8,bytes:Dt(y(n)),decoded:{lat_raw:o,lon_raw:i,latitude:o/1e6,longitude:i/1e6}}),r+=8}if(128&n&&e.length>r){const n=e.slice(r);let s=n.indexOf(0);-1===s&&(s=n.length);const a=(new TextDecoder).decode(n.slice(0,s));t.push({name:"name",offset:r,length:s+(0===n[s]?1:0),bytes:Dt(y(n.slice(0,s+1))),decoded:{value:a,encoding:"utf-8",null_terminated:0===n[s]}})}}return t}(t);case 3:return function(e){if(e.length<4)return[];const t=e.slice(0,4),r=t[0]|t[1]<<8|t[2]<<16|t[3]<<24;return[{name:"crc",offset:0,length:4,bytes:Dt(y(t)),decoded:{value:r>>>0,hex:(r>>>0).toString(16).toUpperCase().padStart(8,"0"),note:"CRC of the acknowledged packet (little-endian)"}}]}(t);case 9:return function(e){const t=[];if(e.length<9)return t;const r=e.slice(0,4),n=r[0]|r[1]<<8|r[2]<<16|r[3]<<24;t.push({name:"trace_tag",offset:0,length:4,bytes:Dt(y(r)),decoded:{value:n>>>0,hex:(n>>>0).toString(16).toUpperCase().padStart(8,"0")}});const s=e.slice(4,8),a=s[0]|s[1]<<8|s[2]<<16|s[3]<<24;if(t.push({name:"auth_code",offset:4,length:4,bytes:Dt(y(s)),decoded:{value:a>>>0}}),t.push({name:"flags",offset:8,length:1,bytes:Dt(y(e.slice(8,9))),decoded:{value:e[8],binary:e[8].toString(2).padStart(8,"0")}}),e.length>9){const r=e.slice(9),n=Array.from(r).map(e=>e.toString(16).toUpperCase().padStart(2,"0"));t.push({name:"target_path",offset:9,length:r.length,bytes:Dt(y(r)),decoded:{hops:n,path_string:n.join("->")}})}return t}(t);case 8:return function(e){if(0===e.length)return[];const t=Array.from(e).map(e=>e.toString(16).toUpperCase().padStart(2,"0"));return[{name:"path_hops",offset:0,length:e.length,bytes:Dt(y(e)),decoded:{hops:t,path_string:t.join("->")}}]}(t);case 5:return function(e){const t=[];if(e.length<1)return t;if(t.push({name:"channel_hash",offset:0,length:1,bytes:Dt(y(e.slice(0,1))),decoded:{value:e[0].toString(16).toUpperCase().padStart(2,"0")}}),e.length>13){const r=12,n=e.length-1-r;t.push({name:"ciphertext",offset:1,length:n,bytes:Dt(y(e.slice(1,1+n))),decoded:{length:n,note:"Encrypted message content"}}),t.push({name:"mac",offset:1+n,length:r,bytes:Dt(y(e.slice(-r))),decoded:{note:"Message authentication code"}})}return t}(t);default:return function(e){return 0===e.length?[]:[{name:"raw_data",offset:0,length:e.length,bytes:Dt(y(e)),decoded:{length:e.length}}]}(t)}}function Ht(e){const t=e.type??e.payload_type??0,r=e.route??e.route_type??0,n=e.raw_packet||"";let s,a=null;if(n){const t=B.fromHex(n);if(t.success&&t.packet){const e=t.packet;try{a=P(e)}catch{a=null}const r=$(n);let o=0;const i={offset:0,length:1,bytes:Dt(n.slice(0,2)),decoded:{route_type:e.routeType,route_name:e.routeTypeName,payload_type:e.payloadType,payload_name:e.payloadTypeName,version:e.payloadVersion}};o+=1,e.hasTransportCodes()&&(o+=4);const c={offset:o,length:1,bytes:Dt(y(r.slice(o,o+1))),decoded:{value:e.pathLen}};o+=1;const l=o,u=r.slice(o,o+e.pathLen),d=Array.from(e.path).map(e=>e.toString(16).toUpperCase().padStart(2,"0")),p=9===e.payloadType,m={offset:l,length:e.pathLen,bytes:Dt(y(u)),decoded:{hops:d,path_string:d.length>0?d.join("->"):"(direct)",...p&&{note:"For TRACE packets, path bytes are SNR√ó4 values, not node hashes",snr_values:Array.from(e.path).map(e=>{let t=e;return t>127&&(t-=256),t/4})}}};o+=e.pathLen,s={header:i,path_length:c,path:m,payload:{offset:o,length:e.payload.length,bytes:Dt(e.payloadHex),sections:Pt(e.payloadType,e.payload)}}}else s=Ut(e)}else s=Ut(e);return{timestamp:e.timestamp,packet_hash:e.packet_hash,type:t,type_name:Ot(t),route:r,route_name:Bt(r),rssi:e.rssi,snr:e.snr,length:e.length??0,src_hash:e.src_hash,dst_hash:e.dst_hash,transmitted:e.transmitted,drop_reason:e.drop_reason,is_duplicate:e.is_duplicate,lbt_attempts:e.lbt_attempts,lbt_backoff_delays_ms:e.lbt_backoff_delays_ms,lbt_channel_busy:e.lbt_channel_busy,raw_packet:n,structure:s,decoded:a}}function Ut(e){var t;const r=e.type??e.payload_type??0,n=e.route??e.route_type??0,s=e.original_path??e.forwarded_path??[];return{header:{offset:0,length:1,bytes:"??",decoded:{route_type:n,route_name:Bt(n),payload_type:r,payload_name:Ot(r),version:0}},path_length:{offset:1,length:1,bytes:s.length.toString(16).toUpperCase().padStart(2,"0"),decoded:{value:s.length}},path:{offset:2,length:s.length,bytes:s.join(" "),decoded:{hops:s,path_string:s.length>0?s.join("->"):"(direct)"}},payload:{offset:2+s.length,length:(null==(t=e.payload)?void 0:t.length)??0,bytes:e.payload??"",sections:e.payload?Pt(r,$(e.payload)):[]}}}function zt(e,t){const r=function(e,t){var r;return{capture:{start:e.startTime.toISOString(),end:e.endTime.toISOString(),duration_sec:e.durationSec,packet_count:e.packetCount,node_name:(null==t?void 0:t.node_name)??"unknown",local_hash:(null==t?void 0:t.local_hash)??"unknown",pymc_console_version:g,pymc_repeater_version:(null==t?void 0:t.version)??"unknown",radio_config:(null==(r=null==t?void 0:t.config)?void 0:r.radio)?{frequency:t.config.radio.frequency,tx_power:t.config.radio.tx_power,bandwidth:t.config.radio.bandwidth,spreading_factor:t.config.radio.spreading_factor}:null},packets:e.packets.map(Ht)}}(e,t),n=JSON.stringify(r,null,2),s=new Blob([n],{type:"application/json"}),a=URL.createObjectURL(s),o=document.createElement("a");o.href=a,o.download=e.filename,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(a)}function qt(e){return e<1024?`${e} B`:e<1048576?`${(e/1024).toFixed(1)} KB`:`${(e/1048576).toFixed(1)} MB`}class Wt extends Q{constructor(){super(...arguments),t(this,"name","cap"),t(this,"description","Packet capture (start/end/list/export)")}matches(e){const t=e.toLowerCase().trim();return"cap"===t||"cap help"===t||t.startsWith("start cap")||t.startsWith("end cap")||t.startsWith("list cap")||t.startsWith("export cap")}async execute({output:e,rawInput:t}){const r=t.toLowerCase().trim();return"cap"===r||"cap help"===r?this.showHelp(e):r.startsWith("start cap")?this.startCapture(e,r):"end cap"===r?this.endCapture(e):"list cap"===r?this.listCaptures(e):r.startsWith("export cap")?this.exportCapture(e,r):void this.showHelp(e)}showHelp(e){const t=Mt.getState(),r=t.isCapturing?`\n${xe('Recording in progress... use "end cap" to stop')}`:"",n=t.reports.length,s=n>0?` (${n} saved)`:"",a=[we("Packet Capture"),"",ye("start cap","Start capture (default: 120s)"),ye("end cap","Stop capture early"),ye("list cap",`List saved captures${s}`),ye("export cap","Download capture by ID"),"",ve("Captures stored in session memory. JSON includes decoded payloads."),r].filter(Boolean);e.write(a.join("\n"))}startCapture(e,t){const r=t.slice(9).trim(),n=r?parseInt(r):120;if(isNaN(n)||n<1||n>3600)return void e.write("Error: Duration must be 1-3600 seconds","error");const s=Mt.getState();if(s.isCapturing)return void e.write('Error: Capture already in progress. Use "end cap" first.',"error");const a=b.getState().packets;s.startCapture(a);let o=n;const i=e.write(xe(`Capturing... ${o}s remaining`),"system"),c=setInterval(()=>{o--;const t=Mt.getState();if(o>=0&&t.isCapturing){const r=b.getState().packets.filter(e=>{if(!t.captureStartTime)return!1;const r=t.captureStartTime.getTime()/1e3;return e.timestamp>=r&&!t.captureStartPacketHashes.has(e.packet_hash)}).length,n=o>0?`${o}s remaining`:"finishing...";e.update(i,xe(`Capturing... ${n} (${r} captured)`),"system")}},1e3),l=setTimeout(()=>{clearInterval(c);const t=Mt.getState();if(t.isCapturing){const r=b.getState().packets,n=t.stopCapture(r);n?e.write(`‚úì Capture complete!\n  Captured: ${n.packetCount} packets\n  Duration: ${n.durationSec}s\n  Size: ~${qt(n.sizeBytes)}\n\nRun \`export cap ${n.id}\` to download.`,"success"):e.write("Capture completed with no packets.","warning")}},1e3*n);s._setTimer(l)}endCapture(e){const t=Mt.getState();if(!t.isCapturing)return void e.write("No capture in progress.","warning");const r=b.getState().packets,n=t.stopCapture(r);n?e.write(`‚úì Capture stopped!\n  Captured: ${n.packetCount} packets\n  Duration: ${n.durationSec}s\n  Size: ~${qt(n.sizeBytes)}\n\nRun \`export cap ${n.id}\` to download.`,"success"):e.write("Capture stopped with no packets.","warning")}listCaptures(e){const{reports:t}=Mt.getState();if(0===t.length)return void e.write("No capture reports available.\nStart a capture with: start cap [seconds]","info");const r=t.map((e,t)=>`  ${t+1}. ${e.packetCount} pkts ‚Ä¢ ${e.durationSec}s ‚Ä¢ ~${qt(e.sizeBytes)} (id: ${e.id})`);e.write(`Capture Reports (${t.length}):\n${r.join("\n")}`,"info")}exportCapture(e,t){const r=t.slice(10).trim(),n=Mt.getState(),s=b.getState().stats;if(!r){if(0===n.reports.length)e.write("No capture reports available.\nStart a capture with: start cap [seconds]","info");else{const t=n.reports.map((e,t)=>`  ${t+1}. ${e.id}`);e.write(`Usage: export cap <id>\n\nAvailable reports:\n${t.join("\n")}`,"info")}return}let a=n.getReport(r);if(!a){const e=parseInt(r)-1;a=n.reports[e]}a?(zt(a,s),e.write(`‚úì Downloading ${a.filename}...`,"success")):e.write(`Error: Report "${r}" not found.\nUse "list cap" to see available reports.`,"error")}}class Xt extends Q{constructor(){super(...arguments),t(this,"name","identities"),t(this,"description","List configured identities"),t(this,"aliases",["id","ids"])}async execute({output:e,rawInput:t}){var r;if("help"===this.argsAfterName(t).toLowerCase().trim())return void e.write([we("identities"),`  ${ge("List all configured repeater and room server identities.")}`,"",ye("identities","list identities"),"",we("Aliases"),`  ${ge("id, ids")}`].join("\n"));const n=e.write("processing...","system");try{const t=await x();if(!t.success||!t.data)return void e.update(n,t.error||"Failed to fetch identities","error");const s=t.data,a=(null==(r=s.configured)?void 0:r.length)?s.configured:s.registered||[];if(0===a.length)return void e.update(n,"No identities configured.","warning");const o=[we(`Identities (${a.length})`),"",...a.map((e,t)=>{var r;const n=e.name||"Unnamed",s=e.type||"unknown",a=(null==(r=e.hash)?void 0:r.slice(0,8))||"‚Äî";return`  ${ge(`${t+1}.`)} ${me(n)}  ${he(s)}  ${fe(a)}`})];e.update(n,o.join("\n"))}catch(s){e.update(n,`Error: ${s instanceof Error?s.message:"Command failed"}`,"error")}}}class Kt extends Q{constructor(){super(...arguments),t(this,"name","keys"),t(this,"description","List transport keys")}async execute({output:e,rawInput:t}){if("help"===this.argsAfterName(t).toLowerCase().trim())return void e.write([we("keys"),`  ${ge("List configured transport encryption keys.")}`,"",ye("keys","list transport keys")].join("\n"));const r=e.write("processing...","system");try{const t=await H();if(!t.success||!t.data)return void e.update(r,t.error||"Failed to fetch transport keys","error");const n=t.data;if(0===n.length)return void e.update(r,"No transport keys configured.","warning");const s=[we(`Transport Keys (${n.length})`),"",...n.map(e=>{const t=e.parent_id?`  ${he(`parent: ${e.parent_id}`)}`:"";return`  ${me(e.name)}  ${$e("flood",fe(e.flood_policy))}${t}`})];e.update(r,s.join("\n"))}catch(n){e.update(r,`Error: ${n instanceof Error?n.message:"Command failed"}`,"error")}}}class Gt extends Q{constructor(){super(...arguments),t(this,"name","acl"),t(this,"description","Show ACL statistics")}async execute({output:e,rawInput:t}){if("help"===this.argsAfterName(t).toLowerCase().trim())return void e.write([we("acl"),`  ${ge("Display access control list statistics.")}`,"",ye("acl","show ACL stats")].join("\n"));const r=e.write("processing...","system");try{const t=await z();if(!t.success||!t.data)return void e.update(r,t.error||"Failed to fetch ACL stats","error");const n=t.data,s=[we("ACL Stats"),"",`  ${$e("Identities",fe(String(n.total_identities)))}`,`  ${$e("Total clients",fe(String(n.total_clients)))}`,`  ${$e("Admin",fe(String(n.admin_clients)))}`,`  ${$e("Guest",fe(String(n.guest_clients)))}`];if(n.by_identity_type){const e=n.by_identity_type.repeater,t=n.by_identity_type.room_server;e&&s.push(`  ${$e("Repeater",`${fe(String(e.count))} ids  ${ge(`${e.clients} clients`)}`)}`),t&&s.push(`  ${$e("Room Server",`${fe(String(t.count))} ids  ${ge(`${t.clients} clients`)}`)}`)}e.update(r,s.join("\n"))}catch(n){e.update(r,`Error: ${n instanceof Error?n.message:"Command failed"}`,"error")}}}class Jt extends Q{constructor(){super(...arguments),t(this,"name","rooms"),t(this,"description","Show room server statistics")}async execute({output:e,rawInput:t}){if("help"===this.argsAfterName(t).toLowerCase().trim())return void e.write([we("rooms"),`  ${ge("Display room server statistics and sync status.")}`,"",ye("rooms","list rooms")].join("\n"));const r=e.write("processing...","system");try{const t=await _();if(!t.success||!t.data)return void e.update(r,t.error||"Failed to fetch room stats","error");const n=t.data.rooms||[];if(0===n.length)return void e.update(r,"No room servers configured.","warning");const s=[we(`Rooms (${n.length})`),"",...n.map(e=>[`  ${me(e.room_name)}`,`    ${$e("msgs",fe(String(e.total_messages)))}  ${$e("clients",`${fe(String(e.active_clients))}${he(`/${e.total_clients}`)}`)}  ${$e("sync",e.sync_running?fe("running"):he("idle"))}`]).flat()];e.update(r,s.join("\n"))}catch(n){e.update(r,`Error: ${n instanceof Error?n.message:"Command failed"}`,"error")}}}class Vt extends Q{constructor(){super(...arguments),t(this,"name","restart"),t(this,"description","Restart pymc-repeater service"),t(this,"aliases",["reboot"])}async execute({output:e,rawInput:t}){if("help"===this.argsAfterName(t).toLowerCase().trim())return void e.write([we("restart"),`  ${ge("Restart the pymc-repeater systemd service.")}`,"",ye("restart","restart the service"),"",we("Aliases"),`  ${ge("reboot")}`,"",ve("Requires polkit permissions for the web user."),ve("The page will need a manual refresh after restart.")].join("\n"));const r=e.write("Restarting service...","system");try{const t=await U(AbortSignal.timeout(8e3));if(t.success)return e.update(r,"Service restart initiated.","success"),void this.waitForService(e);const n=t.status;if(403===n||401===n)return void e.update(r,"Error: Permission denied.\n\nThe web user needs polkit permissions to restart the service.\nSee: /etc/polkit-1/localauthority/50-local.d/pymc-repeater.pkla","error");e.update(r,t.error||"Restart failed","error")}catch(n){const t=n instanceof Error?n.message:"";t.includes("ERR_NETWORK")||t.includes("ECONNRESET")||t.includes("Failed to fetch")||t.includes("abort")||t.includes("timeout")||n instanceof DOMException&&"TimeoutError"===n.name||n instanceof DOMException&&"AbortError"===n.name?(e.update(r,"Service is restarting (connection dropped).","success"),this.waitForService(e)):e.update(r,`Error: ${t||"Restart failed"}`,"error")}}waitForService(e){const t=e.write("Waiting for service...","system");let r=0,n=!1;setTimeout(()=>{const s=setInterval(async()=>{if(!n){r++,e.update(t,`Waiting for service... ${r}s`,"system");try{await fetch(`${k}/api/stats`,{signal:AbortSignal.timeout(3e3)}),n=!0,clearInterval(s),e.update(t,`Service connected. (${r+4}s)`,"success")}catch{}!n&&r>=30&&(n=!0,clearInterval(s),e.update(t,"Service did not respond within 34s. Check manually.","warning"))}},1e3)},4e3)}}const Yt="[",Qt=`${Yt}0m`,Zt=`${Yt}32m`,er=`${Yt}33m`,tr=`${Yt}31m`,rr=`${Yt}36m`,nr=`${Yt}90m`,sr=`${Yt}1m`;function ar(e){return e>=1073741824?`${(e/1073741824).toFixed(1)}G`:e>=1048576?`${(e/1048576).toFixed(0)}M`:e>=1024?`${(e/1024).toFixed(0)}K`:`${e}B`}function or(e){const t=Math.floor(e/86400),r=Math.floor(e%86400/3600),n=Math.floor(e%3600/60);return t>0?`${t}d ${r}h ${n}m`:r>0?`${r}h ${n}m`:`${n}m`}function ir(e,t){const r=" ".repeat(2),n=t-2,s=[];let a="",o=0;for(const i of e){const e=Ie(i);0===o?(a=i,o=e):o+2+e<=n?(a+="  "+i,o+=2+e):(s.push(r+a),a=i,o=e)}return o>0&&s.push(r+a),s}function cr(e,t,r){var n,s;const a=e.node_name||"unknown",o=e.version?`v${e.version}`:"",i=(null==(n=t.system)?void 0:n.uptime)?or(t.system.uptime):"?",c=or(e.uptime_seconds||0),l=Math.max(3,r-4),u=(null==(s=t.cpu.load_avg)?void 0:s["1min"].toFixed(2))??"?",d=t.cpu.load_avg?`${u} ${t.cpu.load_avg["5min"].toFixed(2)} ${t.cpu.load_avg["15min"].toFixed(2)}`:"?",p=r>=60?d:u;return[`  ${rr}${sr}${a}${Qt}  ${nr}${o}${Qt}`,`  ${nr}${"‚îÄ".repeat(l)}${Qt}`,...ir([$e("Sys",fe(i)),$e("Svc",fe(c)),$e("Load",fe(p))],r)]}function lr(e,t){const r=Math.max(6,Math.min(30,t-15)),n=t-(15+r)-2,s=[""],a=`${e.cpu.count} core${e.cpu.count>1?"s":""}`,o=`${ar(e.memory.used)}/${ar(e.memory.total)}`,i=`${ar(e.disk.used)}/${ar(e.disk.total)}`,c=(e,t,s)=>{const a=function(e,t){const r=Math.max(0,Math.min(100,e)),n=Math.round(r/100*t),s=t-n,a=r>=90?tr:r>=70?er:Zt;return`[${a}${"‚ñà".repeat(n)}${Qt}${nr}${"‚ñë".repeat(s)}${Qt}] ${a}${`${r.toFixed(1)}%`.padStart(6)}${Qt}`}(t,r),o=n>=s.length?`  ${he(s)}`:"";return`  ${ge(e.padEnd(4))}${a}${o}`};s.push(c("CPU",e.cpu.usage_percent,a)),s.push(c("Mem",e.memory.usage_percent,o)),s.push(c("Dsk",e.disk.usage_percent,i));const l=Object.entries(e.temperatures||{});if(l.length>0){const e=l.map(([e,t])=>{return`${he(e+":")} ${r=t,r>=80?`${tr}${sr}${r.toFixed(1)}¬∞C${Qt}`:r>=60?`${er}${r.toFixed(1)}¬∞C${Qt}`:`${Zt}${r.toFixed(1)}¬∞C${Qt}`}`;var r});s.push(...ir(e,t))}return s}function ur(e,t){var r,n;const s=e.neighbors||{},a=Object.keys(s).length,o=Object.values(s).filter(e=>e.zero_hop).length,i=(null==(n=null==(r=e.config)?void 0:r.repeater)?void 0:n.mode)||"?",c=null!=e.noise_floor_dbm?`${e.noise_floor_dbm}dBm`:"?",l=e.duty_cycle_percent??0,u=["",`  ${nr}MESH${Qt}`];return u.push(...ir([$e("Mode",fe(i)),$e("Nbrs",`${fe(String(o))}${he(`/${a}`)}`),$e("Noise",fe(c)),$e("Air",fe(`${l.toFixed(1)}%`))],t)),u.push(...ir([$e("RX",fe(String(e.rx_count??0))),$e("TX",fe(String(e.tx_count??0))),$e("FWD",fe(String(e.forwarded_count??0))),$e("Drop",fe(String(e.dropped_count??0)))],t)),u.push(...ir([$e("RX/h",fe(String(Math.round(e.rx_per_hour??0)))),$e("FWD/h",fe(String(Math.round(e.forwarded_per_hour??0))))],t)),u}function dr(e,t){if(!e.network)return[];const r=["",`  ${nr}NET${Qt}`];return r.push(...ir([$e("TX",fe(ar(e.network.bytes_sent))),$e("RX",fe(ar(e.network.bytes_recv))),$e("Pkt",`${fe(String(e.network.packets_sent))}${he("/")}${fe(String(e.network.packets_recv))}`)],t)),r}function pr(e,t){if(0===e.length)return[];const r=t>=50,n=t>=50?6:5,s=t>=50?6:5,a=r?7:0,o=Math.max(4,t-2-a-n-s-4),i=t>=50?8:5,c=["",`  ${nr}PROCS${Qt}`],l=(r?"PID".padEnd(a):"")+"CPU".padStart(n)+"MEM".padStart(s)+"  NAME";c.push(`  ${he(l)}`);for(const u of e.slice(0,i)){const e=r?he(String(u.pid).padEnd(a)):"",i=(t>=50?u.cpu_percent.toFixed(1):u.cpu_percent.toFixed(0)).padStart(n),l=(t>=50?u.memory_percent.toFixed(1):u.memory_percent.toFixed(0)).padStart(s),d=u.name.length>o?u.name.slice(0,o-1)+"‚Ä¶":u.name,p=u.cpu_percent>=50?tr:u.cpu_percent>=20?er:"",m=p?`${p}${i}${Qt}`:i;c.push(`  ${e}${m}${he(l)}  ${d}`)}return c}function mr(e,t,r,n){return e&&t?[...cr(e,t,n),...lr(t,n),...ur(e,n),...dr(t,n),...pr(r,n),"",`  ${nr}${(new Date).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1})}  ¬∑  Ctrl+C to exit${Qt}`].join("\n"):`  ${nr}Waiting for data‚Ä¶${Qt}`}class hr extends Q{constructor(){super(...arguments),t(this,"name","top"),t(this,"description","Live system overview (Ctrl+C to exit)"),t(this,"aliases",["htop"])}async execute({output:e,rawInput:t,cols:r,signal:n}){var s,a;if("help"===this.argsAfterName(t).toLowerCase().trim())return void e.write([we("top"),`  ${ge("Live-updating system overview combining hardware")}`,`  ${ge("stats, mesh metrics, and running processes.")}`,`  ${ge("Refreshes every 3s. Press Ctrl+C to exit.")}`,"",ye("top","start live display"),"",we("Sections"),`  ${ge("Header     Node name, version, uptime, load average")}`,`  ${ge("Gauges     CPU, memory, disk usage with bar charts")}`,`  ${ge("Mesh       Mode, neighbors, packet counts, airtime")}`,`  ${ge("Network    TCP/IP bytes and packet counters")}`,`  ${ge("Processes  Top 8 processes by CPU usage")}`,"",we("Aliases"),`  ${ge("htop")}`].join("\n"));let o=b.getState().hardwareStats,i=[],c=b.getState().stats;try{const[e,t]=await Promise.all([u(),S()]);e.success&&e.data&&(o=e.data),t.success&&t.data&&(i=t.data.processes.sort((e,t)=>t.cpu_percent-e.cpu_percent))}catch{}if(!n.aborted){null==(s=e.enterFullscreen)||s.call(e);try{const t=e.write(mr(c,o,i,e.cols??r));await new Promise(s=>{if(n.aborted)return void s();const a=setInterval(()=>{if(n.aborted)return clearInterval(a),void s();(async()=>{c=b.getState().stats;try{const[e,t]=await Promise.all([u(),S()]);e.success&&e.data&&(o=e.data),t.success&&t.data&&(i=t.data.processes.sort((e,t)=>t.cpu_percent-e.cpu_percent))}catch{}n.aborted||e.update(t,mr(c,o,i,e.cols??r))})()},3e3);n.addEventListener("abort",()=>{clearInterval(a),s()},{once:!0})})}finally{null==(a=e.exitFullscreen)||a.call(e)}}}}const fr=O(e=>({entries:[],commandHistory:[],isInitialized:!1,addEntry:t=>{const r="undefined"!=typeof crypto&&crypto.randomUUID?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}),n={...t,id:r,timestamp:Date.now()};return e(e=>({entries:[...e.entries,n]})),r},updateEntry:(t,r)=>{e(e=>({entries:e.entries.map(e=>e.id===t?{...e,...r}:e)}))},addCommand:t=>{e(e=>({commandHistory:[...e.commandHistory,t]}))},clearEntries:()=>{e({entries:[],commandHistory:[]})},setInitialized:t=>{e({isInitialized:t})}}));function gr({isOpen:e,onClose:t}){const n=Lt(),s=b(e=>e.stats);return r.jsxs(C,{open:e,onClose:t,size:"lg",children:[r.jsx(j,{icon:r.jsx(L,{size:20}),title:"Download Captures",onClose:t}),r.jsx(N,{children:r.jsx("div",{className:"flex flex-col gap-3",children:0===n.length?r.jsx("p",{className:"text-text-secondary",children:"No captures available."}):n.map(e=>r.jsxs("div",{className:"flex items-center justify-between p-2 rounded-md bg-bg-surface-elevated",children:[r.jsxs("div",{children:[r.jsx("p",{className:"font-semibold",children:e.filename}),r.jsxs("p",{className:"text-sm text-text-secondary",children:[e.packetCount," packets ‚Ä¢ ",e.durationSec,"s ‚Ä¢ ~",qt(e.sizeBytes)]})]}),r.jsx("button",{onClick:()=>(e=>{const t=n.find(t=>t.id===e);t&&zt(t,s)})(e.id),className:"p-2 text-text-secondary hover:text-text-primary hover:bg-bg-subtle rounded-md transition-colors",title:"Download",children:r.jsx(L,{size:18})})]},e.id))})})]})}function $r(){const e=Lt(),t=e.length>0,[s,a]=n.useState(!1);return t?r.jsxs(r.Fragment,{children:[r.jsx(q,{icon:r.jsx(W,{size:20}),onClick:()=>a(!0),title:`Download captures (${e.length})`,iconActiveColor:"#E5484D",keycapSrc:"/assets/keycap-red.svg"}),r.jsx(gr,{isOpen:s,onClose:()=>a(!1)})]}):null}const yr=function(){const e=new Y,t=new Ze(e);return e.register(t,new et,new rt,new nt,new st,new it,new ct,new wt,new Rt,new vt,new bt,new At,new Wt,new Xt,new Kt,new Gt,new Jt,new Vt,new hr),e}(),wr=yr.all().flatMap(e=>[{cmd:e.name,desc:e.description,params:e.params,required:!!e.params},...e.aliases.filter(e=>e.includes(" ")).map(t=>({cmd:t,desc:e.description,params:e.params,required:!!e.params}))]),vr={"set mode":["forward","monitor"],"set duty":["on","off"],"set repeat":["on","off"],"set tx":["10","14","17","20","22"],"set sf":["7","8","9","10","11","12"],"set bw":["125","250","500"],"set af":["0.5","1.0","1.5","2.0"],"set txdelay":["0.5","0.7","1.0","1.5"],"set direct.txdelay":["0.3","0.5","0.7"],"set log":["debug","info","warning"],"start cap":["30","60","120","300"]};function br(){return/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)||window.innerWidth<640}function xr(){const e=T(),{addCommand:t}=fr(),l=n.useRef(null),u=n.useRef(null),d=n.useRef(null),p=n.useRef(null),m=n.useRef(""),h=n.useRef(-1),f=n.useRef(""),g=n.useRef(!1),$=n.useRef(null),y=n.useRef(!1),w=n.useRef(!1),v=n.useRef([]),b=n.useRef(()=>{}),x=E(),[_,k]=n.useState({show:!1,options:[],selectedIndex:0,input:""}),S=n.useRef([]),C=n.useRef(0);n.useEffect(()=>{(null==e?void 0:e.neighbors)&&(v.current=Object.values(e.neighbors).map(e=>e.node_name||e.name).filter(e=>!!e).sort())},[null==e?void 0:e.neighbors]);const j=n.useCallback(()=>{var e;null==(e=u.current)||e.write(be)},[]),N=n.useCallback(()=>{const e=u.current;e&&(e.write(Ne),j(),e.write(m.current))},[j]),I=n.useCallback(e=>{const t=function(e,t){const r=e.trim().toLowerCase();if(!r)return[];const n=wr.filter(e=>e.cmd.toLowerCase().startsWith(r));if(n.length>0)return n;if(r.includes(" ")){const e=r.lastIndexOf(" "),n=r.substring(0,e),s=r.substring(e+1);if("ping"===n&&t.length>0)return t.filter(e=>e.toLowerCase().startsWith(s)).slice(0,10).map(e=>({cmd:`ping ${e}`,desc:`‚Üí ${e}`}));const a=wr.find(e=>e.cmd.toLowerCase()===n);if(a&&vr[a.cmd])return vr[a.cmd].filter(e=>e.toLowerCase().startsWith(s)).map(e=>({cmd:`${a.cmd} ${e}`,desc:`‚Üí ${e}`}))}return[]}(e,v.current);S.current=t,C.current=0;const r=t.length>0&&e.trim().length>0;k({show:r,options:t,selectedIndex:0,input:e.trim()})},[]),F=n.useCallback(()=>{S.current=[],C.current=0,k({show:!1,options:[],selectedIndex:0,input:""})},[]),M=n.useCallback(e=>{var t;const r=S.current[e];r&&(m.current=r.required?r.cmd+" ":r.cmd,N(),r.required?I(m.current):F(),null==(t=u.current)||t.focus())},[N,I,F]),L=n.useCallback(async e=>{const r=u.current;if(!r)return;const n=e.trim();if(!n)return void j();g.current=!0;const s=new AbortController;$.current=s,t(n),h.current=-1;let a=0;const o={get cols(){return r.cols},write(e,t="default"){const n=("default"===t?e:pe(e,t)).split("\n");for(const s of n)r.writeln(s);return a=Fe(n,r.cols),String(a)},update(e,t,n){if(w.current)r.write("[H");else if(a>0)for(let o=0;o<a;o++)r.write(Te()),r.write(Ne);const s=(n?pe(t,n):t).split("\n");for(const a of s)r.writeln(a);w.current&&r.write("[J"),a=Fe(s,r.cols)},clear(){r.clear(),a=0},enterFullscreen(){r.write("[?1049h[?25l"),w.current=!0,a=0},exitFullscreen(){r.write(Re+Ee),w.current=!1,a=0}},i=yr.find(n);if(i){const e=n.split(/\s+/);try{await i.execute({output:o,args:e,rawInput:n,cols:r.cols,signal:s.signal})}catch(c){c instanceof DOMException&&"AbortError"===c.name||o.write(`Error: ${c instanceof Error?c.message:"Command failed"}`,"error")}}else o.write(`Unknown command: ${n}\nType 'help' for available commands.`,"error");$.current=null,g.current=!1,j()},[t,j]),D=n.useCallback(e=>{const t=u.current;if(!t)return;if(g.current){for(let r=0;r<e.length;r++)3===e.charCodeAt(r)&&$.current&&($.current.abort(),t.writeln("^C"));return}const r=fr.getState().commandHistory,n=e=>requestAnimationFrame(()=>{var t;return null==(t=document.querySelector(`[data-ac-index="${e}"]`))?void 0:t.scrollIntoView({block:"nearest"})});for(let s=0;s<e.length;s++){const a=e.charCodeAt(s);if(13===a){if(S.current.length>0){const e=S.current[C.current];e&&(m.current=e.cmd,N())}F();const e=m.current;m.current="",t.writeln(""),L(e);continue}if(127!==a&&8!==a)if(3!==a)if(12!==a)if(9!==a)if(27!==a)a>=32&&(m.current+=e[s],t.write(e[s]),h.current=-1,I(m.current));else{if(91===e.charCodeAt(s+1)){const t=e.charCodeAt(s+2);if(s+=2,65===t){if(S.current.length>0){const e=Math.max(C.current-1,0);C.current=e,k(t=>({...t,selectedIndex:e})),n(e)}else r.length>0&&(-1===h.current&&(f.current=m.current),h.current<r.length-1&&(h.current++,m.current=r[r.length-1-h.current]||"",N()));continue}if(66===t){if(S.current.length>0){const e=Math.min(C.current+1,S.current.length-1);C.current=e,k(t=>({...t,selectedIndex:e})),n(e)}else h.current>0?(h.current--,m.current=r[r.length-1-h.current]||"",N()):0===h.current&&(h.current=-1,m.current=f.current,N());continue}if(67===t||68===t)continue;continue}S.current.length>0&&F()}else S.current.length>0&&M(C.current);else t.clear(),F(),N();else m.current="",F(),t.writeln("^C"),j();else m.current.length>0&&(m.current=m.current.slice(0,-1),t.write("\b \b"),I(m.current))}},[F,I,M,j,N,L]);n.useEffect(()=>{b.current=D},[D]);const O=n.useCallback(async()=>{const e=u.current;if(!e||y.current)return;y.current=!0;const t="[94m",r="[0m",n="‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  ‚ñà‚ñà    ‚ñà‚ñà ‚ñà‚ñà‚ñà    ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà\n‚ñà‚ñà   ‚ñà‚ñà  ‚ñà‚ñà  ‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà ‚ñà‚ñà     \n‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà    ‚ñà‚ñà‚ñà‚ñà   ‚ñà‚ñà ‚ñà‚ñà‚ñà‚ñà ‚ñà‚ñà ‚ñà‚ñà     \n‚ñà‚ñà         ‚ñà‚ñà    ‚ñà‚ñà  ‚ñà‚ñà  ‚ñà‚ñà ‚ñà‚ñà     \n‚ñà‚ñà         ‚ñà‚ñà    ‚ñà‚ñà      ‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà".split("\n");for(const s of n)e.writeln(`${t}${s}${r}`);e.writeln(""),e.write(ge("‚óè Initializing terminal...")),await new Promise(e=>setTimeout(e,300)),e.write(Ne),e.writeln(`${t}‚úì Initializing terminal...${r}`),e.write(ge("‚óè Connecting to repeater...")),await new Promise(e=>setTimeout(e,500)),e.write(Ne),"connected"===R.getState().health?e.writeln(`${t}‚úì Connected to repeater${r}`):e.writeln(`${oe}~ Connection status unknown${ee}`),e.writeln(ge("Ready. Type 'help' for commands.")),e.writeln(""),j()},[j]);n.useEffect(()=>{const e=l.current;if(!e)return;const t=new a({theme:Le(),fontFamily:'"JetBrains Mono", "IBM Plex Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace',fontSize:13,lineHeight:1.4,cursorBlink:!1,cursorStyle:"underline",scrollback:1e4,convertEol:!0,allowTransparency:!0,rightClickSelectsWord:!1}),r=new o;t.loadAddon(r),t.loadAddon(new i),t.open(e),r.fit(),u.current=t,d.current=r;const n=t.onData(e=>b.current(e)),s=function(e){return c.subscribe(()=>{e.options.theme=Le()})}(t),p=new ResizeObserver(()=>{requestAnimationFrame(()=>r.fit())});return p.observe(e),O(),br()||t.focus(),()=>{var e;null==(e=$.current)||e.abort(),w.current&&(t.write(Re+Ee),w.current=!1),n.dispose(),s(),p.disconnect(),t.dispose(),u.current=null,d.current=null}},[]);const B=n.useCallback(e=>{const t=e.target.value;t.length>0&&(D(t),e.target.value="")},[D]),P=n.useCallback(e=>{"Enter"===e.key?(e.preventDefault(),D("\r")):"Backspace"===e.key?(e.preventDefault(),D("")):"ArrowUp"===e.key?(e.preventDefault(),D("[A")):"ArrowDown"===e.key&&(e.preventDefault(),D("[B"))},[D]),H=n.useCallback(()=>{var e,t;br()?null==(e=p.current)||e.focus():null==(t=u.current)||t.focus()},[]);return r.jsxs(K,{children:[r.jsx(G,{title:"Terminal",icon:r.jsx(A,{})}),r.jsx(J,{children:r.jsxs("div",{className:"terminal-card flex flex-col gap-1.5",children:[r.jsxs("div",{className:"card-terminal-header flex-wrap",children:[r.jsx("span",{className:"seven-seg-panel",children:r.jsx(X,{text:"5hell",minChars:7,size:24})}),r.jsx("div",{className:"keycap-well self-stretch flex flex-col",children:r.jsxs("div",{className:"indicator-key"+("connected"===x?" indicator-key--active":"degraded"===x?" indicator-key--sending":""),children:[r.jsx("span",{className:"indicator-key__label",children:"ONLINE"}),r.jsx("span",{className:"indicator-key__led"})]})}),r.jsx("div",{className:"card-terminal-ridge flex-1 min-w-8 hidden sm:block"}),r.jsx("div",{className:"keycap-well keycap-well--rounded flex items-center gap-1",children:r.jsx($r,{})})]}),r.jsx(V,{noPadding:!0,className:"flex flex-col flex-1 min-h-0 overflow-hidden card-terminal",onClick:H,children:r.jsxs("div",{className:"card-terminal-well flex-1 min-h-0 flex flex-col overflow-hidden",children:[r.jsx("div",{className:"flex-1 min-h-0 terminal-gutter",children:r.jsx("div",{ref:l,className:"h-full w-full"})}),_.show&&_.options.length>0&&r.jsxs("div",{className:"flex-shrink-0 overflow-hidden terminal-completions",style:{borderTop:"1px solid var(--terminal-border)",background:"var(--terminal-bg-input)"},children:[r.jsx("div",{className:"overflow-y-auto",style:{maxHeight:"176px"},children:_.options.map((e,t)=>{const n=t===_.selectedIndex,a=_.input.length;return r.jsxs("div",{"data-ac-index":t,onClick:()=>M(t),className:s("flex items-baseline gap-2 px-3 py-0.5 cursor-pointer transition-colors",n?"text-accent-primary":"text-text-primary"),style:{background:n?"var(--terminal-autocomplete-hover)":void 0},onMouseEnter:e=>{n||(e.currentTarget.style.background="var(--terminal-autocomplete-hover)")},onMouseLeave:e=>{n||(e.currentTarget.style.background="")},children:[r.jsx("span",{className:"w-3 shrink-0 text-center text-accent-primary opacity-80",children:n?"‚ñ∏":""}),r.jsxs("span",{className:"min-w-0 truncate flex-1",children:[r.jsx("span",{className:"font-semibold text-accent-primary",children:e.cmd.substring(0,a)}),e.cmd.substring(a)]}),r.jsx("span",{className:"shrink-0 text-[11px] text-text-muted pl-3",children:e.desc})]},e.cmd)})}),r.jsxs("div",{className:"flex justify-between items-center px-3 py-0.5 text-[10px] text-text-muted",style:{borderTop:"1px solid var(--terminal-border)"},children:[r.jsx("span",{children:"Tab ¬∑ ‚Üë‚Üì ¬∑ Esc"}),r.jsxs("span",{children:[_.options.length," match",1!==_.options.length?"es":""]})]})]}),r.jsx("input",{ref:p,type:"text",className:"sr-only",onChange:B,onKeyDown:P,autoComplete:"off",autoCorrect:"off",autoCapitalize:"off",spellCheck:!1,"aria-label":"Terminal input"}),r.jsxs("div",{className:"px-3 sm:px-4 py-1 flex justify-between text-[10px] text-text-muted",style:{borderTop:"1px solid var(--terminal-border)"},children:[r.jsx("span",{className:"hidden sm:inline",children:"‚Üë‚Üì History ¬∑ Tab ¬∑ Esc"}),r.jsx("span",{className:"sm:hidden",children:"Terminal"}),(null==e?void 0:e.version)&&r.jsxs("span",{children:["pyMC v",e.version]})]})]})})]})})]})}export{xr as default};
