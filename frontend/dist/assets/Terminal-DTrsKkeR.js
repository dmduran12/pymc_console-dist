var e=Object.defineProperty,t=(t,r,n)=>((t,r,n)=>r in t?e(t,r,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[r]=n)(t,"symbol"!=typeof r?r+"":r,n);import{j as r,r as n,c as s}from"./vendor-react-j_fHog8x.js";import{D as a,o,L as i}from"./xterm-Cq-DlOOL.js";import{bu as c,bv as l,bw as u,bx as d,by as p,bz as m,bA as h,bB as f,b3 as g,a7 as y,bC as $,$ as w,_ as b,aA as v,bD as x,bE as _,bF as k,K as S,bG as C,N as j,n as N,bH as T,bI as R,bJ as E}from"./index-CImKXCRQ.js";import{s as A}from"./signal-scoring-CcBiRcks.js";import{h as I,c as L,D as F}from"./geo-utils-qEuqoaud.js";import{a as M}from"./ping-C1JzD5-V.js";import{c as O}from"./vendor-core-CDNU4oKM.js";import{P as B,d as D}from"./payload-decoders-BbTIgSA8.js";import{g as H,r as z}from"./system-nunPUnlB.js";import{g as U,K as P,F as q,S as W}from"./KeycapButton-DjJYg-26.js";import{P as K,b as X,B as G,a as V}from"./PageLayout-CBx7rIBL.js";import"./maplibre-gl-b91ci4Kr.js";class J{constructor(){t(this,"commands",[])}register(...e){this.commands.push(...e)}find(e){let t;for(const r of this.commands)r.matches(e)&&(!t||r.name.length>t.name.length)&&(t=r);return t}all(){return this.commands}}class Y{constructor(){t(this,"aliases",[]),t(this,"params")}matches(e){const t=e.toLowerCase().trim(),r=e=>t===e||t.startsWith(e+" ");return r(this.name)||this.aliases.some(r)}argsAfterName(e){const t=e.toLowerCase().trim(),r=[this.name,...this.aliases].sort((e,t)=>t.length-e.length);for(const n of r)if(t.startsWith(n))return e.trim().slice(n.length).trim();return e.trim()}}const Q="[",Z=`${Q}0m`,ee=`${Q}1m`,te=`${Q}2m`,re=`${Q}3m`,ne=`${Q}32m`,se=`${Q}31m`,ae=`${Q}33m`,oe=`${Q}36m`,ie=`${Q}34m`,ce=`${Q}90m`,le=`${Q}92m`,ue=`${Q}96m`;function de(e,t){switch(t){case"success":return`${ne}${e}${Z}`;case"error":return`${se}${e}${Z}`;case"warning":return`${ae}${e}${Z}`;case"info":return`${oe}${e}${Z}`;case"value":return`${ie}${e}${Z}`;case"system":return`${ce}${e}${Z}`;default:return e}}function pe(e){return`${ee}${e}${Z}`}function me(e){return`${te}${e}${Z}`}function he(e){return`${ne}${e}${Z}`}function fe(e){return`${ie}${e}${Z}`}function ge(e){return`${ce}${e}${Z}`}function ye(e,t){return`${ce}${e}: ${Z}${ie}${ee}${t}${Z}`}function $e(e,t,r=22){const n=e.split(" "),s=n[0];let a=oe;return"get"===s?a=ne:"set"===s&&(a=ae),`  ${n.length>1?`${a}${ee}${s}${Z} ${ie}${n.slice(1).join(" ")}${Z}`:`${a}${ee}${e}${Z}`}${" ".repeat(Math.max(1,r-e.length))}${ce}${t}${Z}`}function we(e){return`${ee}${ie}${e}${Z}`}function be(e){return`${ce}${re}${e}${Z}`}const ve=`${ce}$ ${Z}`;function xe(e){return`${se}${ee}‚óè${Z} ${ce}${e}${Z}`}function _e(e){const t=e<1e3?`${e.toFixed(0)}ms`:`${(e/1e3).toFixed(1)}s`;return`${function(e){return e<1500?le:e<4e3?ne:e<8e3?ae:e<15e3?se:`${se}${ee}`}(e)}${t}${Z}`}function ke(e,t){return`${function(e){switch(e){case"excellent":return ue;case"good":return ne;case"fair":return ae;case"poor":return se;case"critical":return`${se}${ee}`;default:return ce}}(t)}${e}${Z}`}const Se=[se,se,ae,ne,ue];function Ce(e,t){return`${Se[t]??ce}${e}${Z}`}function je(e){return e.replace(/[\p{Emoji_Presentation}\p{Extended_Pictographic}\uFE0F\u200D]/gu,"").trim()}const Ne="[2K\r";function Te(e=1){return`[${e}A`}function Re(e,t){const r=function(e){return getComputedStyle(document.documentElement).getPropertyValue(e).trim()}(e);return r||t}function Ee(){const e=Re("--terminal-bg","#0d0d0d"),t=Re("--text-primary","#e0e0e0"),r=Re("--accent-primary","#3b82f6"),n=Re("--accent-primary","#3b82f6")+"40",s=Re("--accent-danger","#ef4444"),a=Re("--accent-success","#22c55e"),o=Re("--accent-secondary","#f59e0b"),i=Re("--accent-primary","#3b82f6"),c=Re("--accent-tertiary","#06b6d4"),l=Re("--text-muted","#666666"),u=Re("--text-secondary","#a0a0a0");return{background:e,foreground:t,cursor:r,cursorAccent:e,selectionBackground:n,selectionForeground:t,black:Re("--bg-surface","#1a1a1a"),red:s,green:a,yellow:o,blue:i,magenta:o,cyan:c,white:t,brightBlack:l,brightRed:s,brightGreen:a,brightYellow:o,brightBlue:i,brightMagenta:o,brightCyan:c,brightWhite:u}}const Ae="[",Ie=`${Ae}0m`,Le=`${Ae}1m`,Fe=`${Ae}2m`,Me=`${Ae}34m`,Oe=`${Ae}90m`,Be="        ",De=[{label:"INFORMATION",entries:[{cmd:"status",desc:"Repeater status summary",alias:"st"},{cmd:"uptime",desc:"System uptime"},{cmd:"board",desc:"Board / platform info"},{cmd:"packets",desc:"Packet statistics"}]},{label:"NETWORK",entries:[{cmd:"neighbors [sort]",desc:"Direct RF neighbors",alias:"nb",sub:"sig ¬∑ name ¬∑ rssi ¬∑ snr ¬∑ dist ¬∑ heard"},{cmd:"ping {name}",desc:"Ping neighbor (name or 0xXX)"},{cmd:"identities",desc:"List configured identities",alias:"id ids"},{cmd:"keys",desc:"Transport keys"},{cmd:"acl",desc:"ACL statistics"},{cmd:"rooms",desc:"Room statistics"}]},{label:"RADIO",entries:[{cmd:"get {param}",desc:"Read parameter"},{cmd:"set {param} {value}",desc:"Write parameter"},{cmd:"advert",desc:"Send advertisement"}]},{label:"SYSTEM",entries:[{cmd:"restart",desc:"Restart service",alias:"reboot"},{cmd:"start cap [seconds]",desc:"Start packet capture"},{cmd:"end cap",desc:"Stop capture"},{cmd:"list cap",desc:"List captures"},{cmd:"export cap [id]",desc:"Download capture"}]},{label:"TOOLS",entries:[{cmd:"convert hex {value}",desc:"Hex ‚Üí base64"},{cmd:"convert base64 {value}",desc:"Base64 ‚Üí hex"},{cmd:"clear",desc:"Clear terminal",alias:"cls"},{cmd:"help [command]",desc:"Show this help",alias:"? h"}]}],He=[{cat:"Identity",params:["name","role","lat","lon","public.key"]},{cat:"Radio",params:["radio","freq","tx","bw","sf","cr"]},{cat:"Timing",params:["af","txdelay","direct.txdelay","rxdelay"]},{cat:"Repeater",params:["mode","duty","repeat","flood.max","advert.interval"]},{cat:"Advanced",params:["multi.acks","int.thresh","agc.reset.interval"]},{cat:"set only",params:["log","prv.key"]}];function ze(e){return`${Oe}${"‚îÄ".repeat(e)}${Ie}`}function Ue(e){const t=Math.max(3,e-12-8-6);return`  ${Me}${Le}pymc console${Ie} ${ze(t)} ${Oe}terminal${Ie}`}function Pe(e){return`  ${Oe}${e}${Ie}`}function qe(e,t){const r=[],n=e.alias?`  ${Fe}${e.alias}${Ie}`:"";return 4+Math.max(e.cmd.length,24)+e.desc.length+(e.alias?2+e.alias.length:0)<=t?r.push("  "+$e(e.cmd,e.desc,24)+n):(r.push("  "+$e(e.cmd,"",24)),r.push(Be+ge(e.desc)+n)),e.sub&&r.push(`${Be}${me("‚îî "+e.sub)}`),r}function We(e){return e.split(" ¬∑ ").map(e=>`${Me}${e}${Ie}`).join(`${Oe} ¬∑ ${Ie}`)}function Ke(e,t){const r=[];let n=[],s=0;for(const a of e){const e=n.length>0?3+a.length:a.length;s+e>t&&n.length>0?(r.push(n),n=[a],s=a.length):(n.push(a),s+=e)}return n.length>0&&r.push(n),r}function Xe(e){const t=["",Pe("GET/SET QUALIFIERS")],r=Math.max(20,e-4-13);for(const n of He){const e=`${Oe}${n.cat.padEnd(13)}${Ie}`,s=Ke(n.params,r),a=" ".repeat(17);t.push(`    ${e}${We(s[0].join(" ¬∑ "))}`);for(let r=1;r<s.length;r++)t.push(`${a}${We(s[r].join(" ¬∑ "))}`)}return t}class Ge extends Y{constructor(e){super(),t(this,"name","help"),t(this,"description","Show available commands"),t(this,"aliases",["?","h"]),this.registry=e}execute({output:e,rawInput:t,cols:r}){const n=this.argsAfterName(t).toLowerCase().trim();if(n&&"help"!==n){const t=this.registry.find(n+" help")||this.registry.find(n);return t?void t.execute({output:e,rawInput:t.name+" help",args:[t.name,"help"],cols:r}):void e.write(`Unknown command: ${fe(n)}`,"warning")}const s=[Ue(r),""];for(const a of De){s.push(Pe(a.label));for(const e of a.entries)s.push(...qe(e,r));"RADIO"===a.label&&s.push(...Xe(r)),s.push("")}s.push(...function(e){return[`  ${ze(Math.min(e-4,56))}`,`  ${be("<command> help for detailed usage")}`]}(r)),e.write(s.join("\n"))}}class Ve extends Y{constructor(){super(...arguments),t(this,"name","clear"),t(this,"description","Clear terminal screen"),t(this,"aliases",["cls"])}execute({output:e,rawInput:t}){"help"!==this.argsAfterName(t).toLowerCase().trim()?e.clear():e.write([we("clear"),`  ${ge("Clear all terminal output.")}`,"",$e("clear","clear the screen"),"",we("Aliases"),`  ${ge("cls")}`].join("\n"))}}function Je(e){const t=Math.floor(e/86400),r=Math.floor(e%86400/3600),n=Math.floor(e%3600/60);return t>0?`${t}d ${r}h ${n}m`:r>0?`${r}h ${n}m`:`${n}m`}class Ye extends Y{constructor(){super(...arguments),t(this,"name","status"),t(this,"description","Get repeater status summary"),t(this,"aliases",["st"])}async execute({output:e,rawInput:t}){var r,n,s;if("help"===this.argsAfterName(t).toLowerCase().trim())return void e.write([we("status"),`  ${ge("Show a quick summary of mode, neighbor count, and uptime.")}`,"",$e("status","show summary"),"",we("Aliases"),`  ${ge("st")}`].join("\n"));const a=e.write("processing...","system");try{const t=await l(),o=(null==(n=null==(r=t.config)?void 0:r.repeater)?void 0:n.mode)||"unknown",i=Object.keys(t.neighbors||{}).length,c=Object.values(t.neighbors||{}).filter(e=>e.zero_hop).length,u=(null==(s=t.config)?void 0:s.node_name)||t.node_name||"unknown",d=Je(t.uptime_seconds||0);e.update(a,[`${pe(u)}  ${ge("repeater")}`,"",`  ${ye("Mode",fe(o))}`,`  ${ye("Neighbors",`${fe(String(c))} direct  ${ge(`${i} total`)}`)}`,`  ${ye("RX / TX",`${fe(String(t.rx_count??0))} / ${fe(String(t.tx_count??0))}`)}`,`  ${ye("Uptime",fe(d))}`].join("\n"))}catch(o){e.update(a,`Error: ${o instanceof Error?o.message:"Command failed"}`,"error")}}}class Qe extends Y{constructor(){super(...arguments),t(this,"name","uptime"),t(this,"description","Show system uptime")}async execute({output:e,rawInput:t}){if("help"===this.argsAfterName(t).toLowerCase().trim())return void e.write([we("uptime"),`  ${ge("Display how long the repeater service has been running.")}`,"",$e("uptime","show uptime")].join("\n"));const r=e.write("processing...","system");try{const t=await l();e.update(r,ye("Uptime",fe(Je(t.uptime_seconds||0))))}catch(n){e.update(r,`Error: ${n instanceof Error?n.message:"Command failed"}`,"error")}}}class Ze extends Y{constructor(){super(...arguments),t(this,"name","packets"),t(this,"description","Show packet statistics")}async execute({output:e,rawInput:t}){if("help"===this.argsAfterName(t).toLowerCase().trim())return void e.write([we("packets"),`  ${ge("Display packet counters (received, transmitted, forwarded, dropped).")}`,"",$e("packets","show packet stats")].join("\n"));const r=e.write("processing...","system");try{const t=await l(),n=(t.rx_count??0)+(t.tx_count??0);e.update(r,[we("Packet Stats")+`  ${ge(`${n} total`)}`,"",`  ${ye("Received",fe(String(t.rx_count??0)))}`,`  ${ye("Transmitted",fe(String(t.tx_count??0)))}`,`  ${ye("Forwarded",fe(String(t.forwarded_count??0)))}`,`  ${ye("Dropped",fe(String(t.dropped_count??0)))}`].join("\n"))}catch(n){e.update(r,`Error: ${n instanceof Error?n.message:"Command failed"}`,"error")}}}function et(e){return e>=1073741824?`${(e/1073741824).toFixed(1)} GB`:e>=1048576?`${(e/1048576).toFixed(0)} MB`:`${(e/1024).toFixed(0)} KB`}function tt(e){const t=Math.floor(e/86400),r=Math.floor(e%86400/3600),n=Math.floor(e%3600/60);return t>0?`${t}d ${r}h ${n}m`:r>0?`${r}h ${n}m`:`${n}m`}class rt extends Y{constructor(){super(...arguments),t(this,"name","board"),t(this,"description","Show board/platform info")}async execute({output:e,rawInput:t}){var r;if("help"===this.argsAfterName(t).toLowerCase().trim())return void e.write([we("board"),`  ${ge("Display platform and hardware information.")}`,"",$e("board","show board info")].join("\n"));const n=e.write("loading...","system");try{const[t,s]=await Promise.all([u(),l()]),a=[];if(a.push(`  ${ye("Node",fe(s.node_name||"Unknown"))}`),a.push(`  ${ye("Runtime",fe(`pyMC_Repeater v${s.version||"?"}`))}`),s.core_version&&a.push(`  ${ye("Core",fe(s.core_version))}`),a.push(""),t.success&&t.data){const e=t.data;a.push(`  ${ye("CPU",fe(`${e.cpu.usage_percent.toFixed(1)}%`))}  ${ge(`${e.cpu.count} core${e.cpu.count>1?"s":""}`)}`),e.cpu.load_avg&&a.push(`  ${ye("Load",fe(`${e.cpu.load_avg["1min"].toFixed(2)} / ${e.cpu.load_avg["5min"].toFixed(2)} / ${e.cpu.load_avg["15min"].toFixed(2)}`))}`);const n=Object.entries(e.temperatures||{});if(n.length>0){const e=n[0];a.push(`  ${ye("Temp",fe(`${e[1].toFixed(1)}¬∞C`))}${n.length>1?`  ${ge(n.slice(1).map(([e,t])=>`${e}: ${t.toFixed(1)}¬∞C`).join(", "))}`:""}`)}a.push(""),a.push(`  ${ye("Memory",fe(`${et(e.memory.used)} / ${et(e.memory.total)}`))}  ${ge(`${e.memory.usage_percent.toFixed(0)}%`)}`),a.push(`  ${ye("Disk",fe(`${et(e.disk.used)} / ${et(e.disk.total)}`))}  ${ge(`${e.disk.usage_percent.toFixed(0)}%`)}`),a.push(""),(null==(r=e.system)?void 0:r.uptime)&&a.push(`  ${ye("System uptime",fe(tt(e.system.uptime)))}`),a.push(`  ${ye("Service uptime",fe(tt(s.uptime_seconds)))}`),e.network&&a.push(`  ${ye("Net TX/RX",fe(`${et(e.network.bytes_sent)} / ${et(e.network.bytes_recv)}`))}`)}else a.push(`  ${ye("Platform",fe("Linux"))}`),a.push(`  ${ye("Service uptime",fe(tt(s.uptime_seconds)))}`),a.push(`  ${ge("Hardware stats unavailable")}`);e.update(n,a.join("\n"),"value")}catch(s){e.update(n,`Error: ${s instanceof Error?s.message:"Failed to load hardware stats"}`,"error")}}}class nt extends Y{constructor(){super(...arguments),t(this,"name","advert"),t(this,"description","Send repeater advertisement")}async execute({output:e,rawInput:t}){if("help"===this.argsAfterName(t).toLowerCase().trim())return void e.write([we("advert"),`  ${ge("Broadcast a repeater advertisement to the mesh network.")}`,"",$e("advert","send advert now"),"",be("Adverts announce this repeater's presence to neighbors.")].join("\n"));const r=e.write("processing...","system");try{const t=await d();t.success?e.update(r,`‚úì ${fe("Advert sent")}`,"success"):e.update(r,`Error: ${t.error||"Failed"}`,"error")}catch(n){e.update(r,`Error: ${n instanceof Error?n.message:"Command failed"}`,"error")}}}const st=["sig","name","rssi","snr","dist","heard"],at={excellent:5,good:4,fair:3,poor:2,critical:1};function ot(e){const t=Math.floor(Date.now()/1e3-e);return t<60?`${t}s ago`:t<3600?`${Math.floor(t/60)}m ago`:t<86400?`${Math.floor(t/3600)}h ago`:`${Math.floor(t/86400)}d ago`}function it(e){return e<1e3?`${Math.round(e)}m`:`${(e/1e3).toFixed(1)}km`}const ct=["‚ñÅ","‚ñÉ","‚ñÖ","‚ñá","‚ñà"],lt={excellent:5,good:4,fair:3,poor:2,critical:1};function ut(e){const t=lt[e]??0;return ct.slice(0,t).map((e,t)=>Ce(e,t)).join("")+ge(".".repeat(5-t))}function dt(e,t=e=>e){return{text:e,color:t}}function pt(e){return ge("+"+e.map(e=>"-".repeat(e+2)).join("+")+"+")}function mt(e,t){const r=e.map((e,r)=>{if(null!=e.rendered){const n=Math.max(0,t[r]-e.text.length);return" "+e.rendered+" ".repeat(n)+" "}return" "+e.color((n=e.text,s=t[r],n.length>=s?n.slice(0,s):n+" ".repeat(s-n.length)))+" ";var n,s});return ge("|")+r.join(ge("|"))+ge("|")}class ht extends Y{constructor(){super(...arguments),t(this,"name","neighbors"),t(this,"description","Show direct RF neighbors with signal stats"),t(this,"aliases",["nb","get neighbors","get neighbor"]),t(this,"params","[sig|name|rssi|snr|dist|heard]")}async execute(e){const{output:t,cols:r}=e,n=this.argsAfterName(e.rawInput).toLowerCase().trim();if("help"===n)return void this.printUsage(t);const s=st.includes(n)?n:null,a=t.write("processing...","system");try{const e=await l(),n=e.neighbors||{},o=Object.entries(n).filter(([,e])=>e.zero_hop);if(0===o.length){const e=Object.keys(n).length;return void t.update(a,e>0?`No direct neighbors. ${e} relayed neighbor${1!==e?"s":""} known.`:"No neighbors discovered yet.","warning")}const i=function(e){var t;const r=null==(t=e.config)?void 0:t.radio;return(null==r?void 0:r.spreading_factor)&&(null==r?void 0:r.bandwidth)?{sf:r.spreading_factor,bwHz:r.bandwidth}:null}(e),c=function(e){var t;const r=null==(t=e.config)?void 0:t.repeater;return r&&I(r.latitude,r.longitude)?{lat:r.latitude,lon:r.longitude}:null}(e),u=e.noise_floor_dbm;this.sortNeighbors(o,s,i,c,u);const d=s?`  ${me(`sorted by ${s}`)}`:"",p=[we(`Direct Neighbors (${o.length})`)+d,""];if(r<55)for(const[t,r]of o)p.push(...this.cardLayout(t,r,i,c,u));else{const e=r>=70&&null!=c,t=o.map(([t,r])=>this.buildRow(t,r,i,c,u,e)),n=e?["SIG","NAME","RSSI","SNR","DIST","HEARD"]:["SIG","NAME","RSSI","SNR","HEARD"],s=n.slice(1).map((e,r)=>Math.max(e.length,...t.map(e=>e[r+1].text.length))),a=5,l=s.reduce((e,t)=>e+t+3,0),d=Math.max(4,r-l-a-7),m=[a,Math.min(d,Math.max(4,...t.map(e=>e[1].text.length))),...s.slice(1)];p.push(pt(m),...t.map(e=>mt(e,m)),pt(m),mt(n.map(e=>dt(e,pe)),m),pt(m)),p.push(this.footer(i,u))}t.update(a,p.join("\n"))}catch(o){t.update(a,`Error: ${o instanceof Error?o.message:"Command failed"}`,"error")}}sortNeighbors(e,t,r,n,s){switch(t){case"sig":e.sort(([,e],[,t])=>(at[this.gradeNeighbor(e,r,s)]??0)-(at[this.gradeNeighbor(t,r,s)]??0));break;case"name":e.sort(([e,t],[r,n])=>{const s=(t.name||t.node_name||e.slice(0,8)).toLowerCase(),a=(n.name||n.node_name||r.slice(0,8)).toLowerCase();return s.localeCompare(a)});break;case"rssi":e.sort(([,e],[,t])=>(e.rssi??-999)-(t.rssi??-999));break;case"snr":e.sort(([,e],[,t])=>(e.snr??-999)-(t.snr??-999));break;case"dist":e.sort(([,e],[,t])=>(this.distTo(e,n)??1/0)-(this.distTo(t,n)??1/0));break;case"heard":e.sort(([,e],[,t])=>(e.last_seen||0)-(t.last_seen||0));break;default:e.sort(([,e],[,t])=>(t.last_seen||0)-(e.last_seen||0))}}gradeNeighbor(e,t,r){const n=null!=e.rssi?e.rssi-3.5:null,s=null!=r&&r>-100?1:0,a=A(e.snr??null,n,t,s);return(null==a?void 0:a.finalGrade)??"critical"}distTo(e,t){return t&&I(e.latitude,e.longitude)?L(t.lat,t.lon,e.latitude,e.longitude):null}buildRow(e,t,r,n,s,a){const o=this.gradeNeighbor(t,r,s),i=je(t.name||t.node_name||e.slice(0,8))||e.slice(0,8),c=null!=t.rssi?`${t.rssi} dBm`:"-",l=null!=t.snr?`${t.snr} dB`:"-",u=t.last_seen?ot(t.last_seen):"-",d=[(p=ut(o),{text:"|||||",color:e=>e,rendered:p}),dt(i,pe),dt(c,fe),dt(l,fe)];var p;if(a){const e=this.distTo(t,n);d.push(dt(null!=e?it(e):"-",me))}return d.push(dt(u,me)),d}cardLayout(e,t,r,n,s){const a=this.gradeNeighbor(t,r,s),o=je(t.name||t.node_name||e.slice(0,8))||e.slice(0,8),i=null!=t.rssi?`${t.rssi}`:"-",c=null!=t.snr?`${t.snr}`:"-",l=t.last_seen?ot(t.last_seen):"-",u=this.distTo(t,n),d=null!=u?`  ${ge("dist")} ${fe(it(u))}`:"";return[`${ut(a)} ${pe(o)}`,`  ${ge("rssi")} ${fe(i)}  ${ge("snr")} ${fe(c)}${d}  ${me(l)}`,""]}footer(e,t){const r=[];return e&&r.push(`SF${e.sf}/${e.bwHz>=1e3?e.bwHz/1e3+"kHz":e.bwHz+"Hz"}`),r.push("ant 3.5dBi"),null!=t&&r.push(`nf ${t}dBm`),ge(r.join("  "))}printUsage(e){const t=[we("neighbors"),`  ${ge("Show direct RF neighbors with signal quality, RSSI, SNR, and distance.")}`,"",we("Usage"),$e("neighbors","default sort (most recent)"),$e("neighbors sig","sort by signal grade (weakest first)"),$e("neighbors name","sort alphabetically"),$e("neighbors rssi","sort by RSSI (weakest first)"),$e("neighbors snr","sort by SNR (lowest first)"),$e("neighbors dist","sort by distance (closest first)"),$e("neighbors heard","sort by last seen (oldest first)"),$e("neighbors help","show this help"),"",we("Aliases"),`  ${ge("nb, get neighbors, get neighbor")}`,"",be("Signal bars factor radio config, noise floor, and 3.5 dBi antenna gain."),be("Only zero-hop (direct RF) neighbors are shown.")];e.write(t.join("\n"))}}class ft extends Y{constructor(){super(...arguments),t(this,"name","get"),t(this,"description","Get repeater parameter"),t(this,"params","{parameter}")}async execute({output:e,rawInput:t}){const r=this.argsAfterName(t).toLowerCase().trim();if("help"===r||!r)return void e.write([we("get"),`  ${ge("Read a repeater configuration parameter.")}`,"",we("Identity"),$e("get name","node name"),$e("get role","node role"),$e("get public.key","public key"),"",we("Location"),$e("get lat","latitude"),$e("get lon","longitude"),"",we("Radio"),$e("get radio","full radio summary"),$e("get freq","frequency (MHz)"),$e("get tx","TX power (dBm)"),$e("get bw","bandwidth (kHz)"),$e("get sf","spreading factor"),$e("get cr","coding rate"),"",we("Timing"),$e("get txdelay","TX delay factor"),$e("get direct.txdelay","direct TX delay"),$e("get rxdelay","RX delay base"),"",we("Repeater"),$e("get mode","forward or monitor"),$e("get flood.max","max flood hops"),$e("get advert.interval","advert interval"),$e("get duty","duty cycle state"),"",we("Advanced"),$e("get multi.acks","multi-ack count"),$e("get int.thresh","interference threshold (dBm)"),$e("get agc.reset.interval","AGC reset interval")].join("\n"));const n=e.write("processing...","system");try{const t=await l(),{result:s,type:a}=function(e,t){const r=t.config||{},n=r.radio||{},s=r.repeater||{},a=r.delays||{},o=r.duty_cycle||{},i=(e,t)=>({result:ye(e,fe(t)),type:"value"});switch(e){case"name":return i("name",r.node_name||"Unknown");case"role":return i("role","repeater");case"lat":return i("lat",null!=s.latitude?String(s.latitude):"not set");case"lon":return i("lon",null!=s.longitude?String(s.longitude):"not set");case"freq":return i("freq",n.frequency?`${(n.frequency/1e6).toFixed(3)} MHz`:"?");case"tx":return i("tx",null!=n.tx_power?`${n.tx_power} dBm`:"?");case"bw":return i("bw",n.bandwidth?n.bandwidth/1e3+" kHz":"?");case"sf":return i("sf",String(n.spreading_factor??"?"));case"cr":return i("cr",n.coding_rate?`4/${n.coding_rate}`:"?");case"radio":return n.frequency?{result:[`  ${ye("freq",fe(`${(n.frequency/1e6).toFixed(3)} MHz`))}`,`  ${ye("bw",fe(n.bandwidth/1e3+" kHz"))}`,`  ${ye("sf",fe(String(n.spreading_factor)))}`,`  ${ye("cr",fe(`4/${n.coding_rate}`))}`,`  ${ye("tx",fe(`${n.tx_power} dBm`))}`].join("\n"),type:"value"}:i("radio","?");case"af":case"txdelay":return i("txdelay",String(a.tx_delay_factor??"1.0"));case"direct.txdelay":return i("direct.txdelay",String(a.direct_tx_delay_factor??"0.5"));case"rxdelay":return i("rxdelay",String(a.rx_delay_base??"0.0"));case"mode":return i("mode",s.mode||"forward");case"repeat":return i("repeat","forward"===s.mode?"on":"off");case"flood.max":return i("flood.max",String(s.max_flood_hops??"3"));case"flood.advert.interval":return i("flood.advert.interval",null!=s.send_advert_interval_hours?`${s.send_advert_interval_hours}h`:"?");case"advert.interval":return i("advert.interval",null!=s.advert_interval_minutes?`${s.advert_interval_minutes}m`:"120m");case"duty":case"duty.enabled":return i("duty",o.enforcement_enabled?"on":"off");case"duty.max":return i("duty.max",null!=o.max_airtime_percent?`${o.max_airtime_percent}%`:"?");case"multi.acks":return i("multi.acks",String(s.multi_acks??"0"));case"int.thresh":return i("int.thresh",`${s.interference_threshold??-120} dBm`);case"agc.reset.interval":return i("agc.reset.interval",String(s.agc_reset_interval??"0"));case"public.key":return i("public.key",t.public_key||"not available");case"prv.key":return{result:`${ge("Private key stored in /etc/pymc_repeater/config.yaml")}\n\n  ${ye("view",fe("sudo grep identity_key /etc/pymc_repeater/config.yaml"))}\n  ${ye("set",fe("sudo ./convert_firmware_key.sh <64-byte-hex>"))}`,type:"info"};case"guest.password":case"allow.read.only":return{result:`${ge("Security settings not exposed via stats API.")}\n${ge("Check /etc/pymc_repeater/config.yaml")}`,type:"warning"};default:return{result:`Unknown parameter: ${fe(e)}\n${ge('Run "get help" to see available parameters.')}`,type:"error"}}}(r,t);e.update(n,s,a)}catch(s){e.update(n,`Error: ${s instanceof Error?s.message:"Command failed"}`,"error")}}}class gt extends Y{constructor(){super(...arguments),t(this,"name","set"),t(this,"description","Set repeater parameter"),t(this,"params","{parameter} {value}")}async execute({output:e,rawInput:t}){var r;const n=this.argsAfterName(t).split(/\s+/),s=null==(r=n[0])?void 0:r.toLowerCase(),a=n.slice(1).join(" ");if("help"===s||!s)return void e.write([we("set"),`  ${ge("Write a repeater configuration parameter.")}`,"",we("Identity"),$e("set name <name>","node name"),$e("set lat <deg>","latitude (-90 to 90)"),$e("set lon <deg>","longitude (-180 to 180)"),"",we("Radio"),$e("set freq <MHz>","frequency"),$e("set tx <dBm>","TX power (2-22)"),$e("set bw <kHz>","bandwidth"),$e("set sf <5-12>","spreading factor"),$e("set cr <5-8>","coding rate"),"",we("Timing"),$e("set txdelay <0-5>","TX delay factor"),$e("set direct.txdelay <0-5>","direct TX delay"),$e("set rxdelay <n>","RX delay base"),"",we("Repeater"),$e("set mode <fwd|mon>","forward or monitor"),$e("set flood.max <0-64>","max flood hops"),$e("set advert.interval <m>","advert interval (min)"),$e("set duty <on|off>","duty cycle enforcement"),$e("set log <level>","log level"),"",we("Advanced"),$e("set multi.acks <n>","multi-ack count"),$e("set int.thresh <dBm>","interference threshold"),$e("set agc.reset.interval <n>","AGC reset interval (x4)"),"",be("Some changes require a service restart.")].join("\n"));const o=e.write("processing...","system");try{const{result:r,type:n}=await async function(e,t,r){switch(e){case"mode":return async function(e){const t=e.toLowerCase();return"forward"!==t&&"monitor"!==t?_t('Mode must be "forward" or "monitor"'):(await f(t)).success?xt(`OK - Mode set to ${t}`):_t("Failed")}(t);case"duty":return async function(e){const t="on"===e.toLowerCase()||"1"===e;return(await h(t)).success?xt("OK - Duty cycle "+(t?"enabled":"disabled")):_t("Failed")}(t);case"tx":return yt("tx_power",wt(t,2,22,"TX power must be 2-22 dBm"));case"sf":return yt("spreading_factor",wt(t,5,12,"SF must be 5-12"));case"af":case"txdelay":return yt("tx_delay_factor",bt(t,0,5,"TX delay must be 0.0-5.0"));case"direct.txdelay":return yt("direct_tx_delay_factor",bt(t,0,5,"Direct TX delay must be 0.0-5.0"));case"rxdelay":return yt("rx_delay_base",function(e){const t=parseFloat(e);return isNaN(t)||t<0?{ok:!1,error:"Error: RX delay must be >= 0"}:{ok:!0,value:t}}(t));case"flood.max":return yt("max_flood_hops",wt(t,0,64,"Max flood hops must be 0-64"));case"log":return async function(e){const t=e.toUpperCase();if(!["DEBUG","INFO","WARNING","ERROR"].includes(t))return _t("Level must be debug, info, warning, or error");const r=await m(t);return r.success?xt(`OK - Log level set to ${t}`):_t(r.error||"Failed")}(t);case"multi.acks":return yt("multi_acks",wt(t,0,255,"Multi-acks must be 0-255"));case"int.thresh":return yt("interference_threshold",wt(t,-200,0,"Interference threshold must be -200 to 0 dBm"));case"agc.reset.interval":{const e=vt(t);if(!e.ok)return _t(e.error);if(e.value<0)return _t("AGC reset interval must be >= 0");const r=4*Math.floor(e.value/4);return $t("agc_reset_interval",r,`OK - AGC reset interval set to ${r}${r!==e.value?` (rounded from ${e.value})`:""}`)}case"name":{const e=r.trim().substring(r.toLowerCase().indexOf("name")+5).trim();return e?yt("node_name",{ok:!0,value:e}):_t("Node name cannot be empty")}case"lat":return yt("latitude",bt(t,-90,90,"Latitude must be -90 to 90"));case"lon":return yt("longitude",bt(t,-180,180,"Longitude must be -180 to 180"));case"freq":{const e=bt(t,100,1e3,"Frequency must be 100-1000 MHz");return e.ok?yt("frequency",{ok:!0,value:1e6*e.value}):_t(e.error)}case"bw":{const e=[7.8,10.4,15.6,20.8,31.25,41.7,62.5,125,250,500],r=parseFloat(t);return isNaN(r)||!e.includes(r)?_t(`BW must be one of: ${e.join(", ")} kHz`):yt("bandwidth",{ok:!0,value:1e3*r})}case"cr":return yt("coding_rate",wt(t,5,8,"Coding rate must be 5-8"));case"advert.interval":{const e=vt(t);return e.ok?0!==e.value&&(e.value<1||e.value>10080)?_t("Advert interval must be 0 (off) or 1-10080 minutes"):$t("advert_interval_minutes",e.value,0===e.value?"OK - Local adverts disabled":`OK - Local advert interval set to ${e.value}m`):_t(e.error)}case"flood.advert.interval":{const e=vt(t);return e.ok?0!==e.value&&(e.value<3||e.value>48)?_t("Flood advert interval must be 0 (off) or 3-48 hours"):$t("flood_advert_interval_hours",e.value,0===e.value?"OK - Flood adverts disabled":`OK - Flood advert interval set to ${e.value}h`):_t(e.error)}case"prv.key":{const e=t.trim();return e?/^[0-9a-fA-F]+$/.test(e)?128!==e.length?_t(`Key must be 64 bytes (128 hex chars), got ${e.length} chars`):{result:`To set this key, run on the Pi:\n\n  sudo ./convert_firmware_key.sh ${e}\n\nThen restart: sudo systemctl restart pymc-repeater`,type:"info"}:_t("Private key must be a hex string"):_t("Private key cannot be empty")}default:return _t(`Unknown parameter: ${e}`)}}(s,a,t);e.update(o,r,n)}catch(i){e.update(o,`Error: ${i instanceof Error?i.message:"Command failed"}`,"error")}}}async function yt(e,t){if(!t.ok)return _t(t.error);const r=await p({[e]:t.value});if(!r.success)return _t(r.error||"Failed");let n=`OK - ${e} set to ${t.value}`;return r.restart_required&&(n+="\n‚ö† Service restart required for changes to take effect\nRun: sudo systemctl restart pymc_repeater"),xt(n)}async function $t(e,t,r){const n=await p({[e]:t});if(!n.success)return _t(n.error||"Failed");let s=r;return n.restart_required&&(s+="\n‚ö† Service restart required for changes to take effect\nRun: sudo systemctl restart pymc_repeater"),xt(s)}function wt(e,t,r,n){const s=parseInt(e);return isNaN(s)||s<t||s>r?{ok:!1,error:`Error: ${n}`}:{ok:!0,value:s}}function bt(e,t,r,n){const s=parseFloat(e);return isNaN(s)||s<t||s>r?{ok:!1,error:`Error: ${n}`}:{ok:!0,value:s}}function vt(e){const t=parseInt(e);return isNaN(t)?{ok:!1,error:"Error: Expected a number"}:{ok:!0,value:t}}function xt(e){return{result:e,type:"success"}}function _t(e){return{result:`Error: ${e}`,type:"error"}}const kt=["‚ñÅ","‚ñÉ","‚ñÖ","‚ñá","‚ñà"],St={excellent:5,good:4,fair:3,poor:2,critical:1};class Ct extends Y{constructor(){super(...arguments),t(this,"name","ping"),t(this,"description","Ping neighbor (name or 0xXX)"),t(this,"params","{target} [timeout]")}async execute({output:e,rawInput:t}){var r,n,s,a;const o=this.argsAfterName(t).trim(),i=o.split(/\s+/);if("help"===(null==(r=i[0])?void 0:r.toLowerCase()))return void e.write([we("ping"),`  ${ge("Send a ping to a neighbor and measure round-trip time, signal quality, and path.")}`,"",$e("ping <name>","ping by node name"),$e("ping 0xAB","ping by hex prefix"),$e("ping <name> 60","ping with custom timeout (seconds)"),"",be("Default timeout: 30s. Signal bars factor radio config and noise floor.")].join("\n"));const c=i[i.length-1],u=parseInt(c),d=i.length>1&&!isNaN(u)&&u>0,p=d?i.slice(0,-1).join(" "):o,m=d?u:30;if(!p)return void e.write([we("ping"),`  ${ge("Send a ping to a neighbor and measure round-trip time.")}`,"",$e("ping <name>","ping by node name"),$e("ping <name> 60","with custom timeout"),"",be('Run "ping help" for full usage.')].join("\n"));const h=e.write(`Pinging ${p}.`,"system");let f=1;const g=setInterval(()=>{f=f%3+1,e.update(h,`Pinging ${p}${".".repeat(f)}`,"system")},800);try{const[t,r]=await Promise.all([M(p,m),l()]);if(clearInterval(g),t.success&&t.data){const o=t.data,i=null==(n=r.config)?void 0:n.radio,c=(null==i?void 0:i.spreading_factor)&&(null==i?void 0:i.bandwidth)?{sf:i.spreading_factor,bwHz:i.bandwidth}:null,l=r.noise_floor_dbm,u=null!=l&&l>-100?1:0,d=o.rssi-3.5,p=A(o.snr_db,d,c,u),m=(null==p?void 0:p.finalGrade)??"critical",f=function(e){const t=St[e]??0;return kt.slice(0,t).map((e,t)=>Ce(e,t)).join("")+ge(".".repeat(5-t))}(m),g=(null==(s=o.path)?void 0:s.length)?o.path.length:0,y=(null==(a=o.path)?void 0:a.length)?o.path.join(" > "):"direct",$=m.charAt(0).toUpperCase()+m.slice(1),w=[`${f} ${pe("Reply from")} ${fe(o.target_id)}`,"",`  ${ye("RTT",_e(o.rtt_ms))}`,`  ${ye("RSSI",`${o.rssi} dBm`)}`,`  ${ye("SNR",`${o.snr_db} dB`)}`,`  ${ye("Path",y)}${g>0?ge(` (${g} hop${1!==g?"s":""})`):""}`,`  ${ye("Quality",ke($,m))}`],b=[];c&&b.push(`SF${c.sf}/${c.bwHz>=1e3?c.bwHz/1e3+"kHz":c.bwHz+"Hz"}`),b.push("ant 3.5dBi"),null!=l&&b.push(`nf ${l}dBm`),w.push("",ge(b.join("  "))),e.update(h,w.join("\n"))}else e.update(h,t.error||"Ping failed","error")}catch(y){clearInterval(g),e.update(h,`Error: ${y instanceof Error?y.message:"Ping failed"}`,"error")}}}class jt extends Y{constructor(){super(...arguments),t(this,"name","convert"),t(this,"description","Convert between hex and base64"),t(this,"params","hex|base64 {value}")}execute({output:e,args:t}){var r;const n=null==(r=t[1])?void 0:r.toLowerCase(),s=t.slice(2).join(" ").trim();"help"!==n&&(n||s)?"hex"===n?this.hexToBase64(e,s):"base64"===n?this.base64ToHex(e,s):e.write([we("convert"),`  ${ge("Convert between hex and base64 encodings.")}`,"",$e("convert hex <hex>","hex ‚Üí base64"),$e("convert base64 <b64>","base64 ‚Üí hex")].join("\n")):e.write([we("convert"),`  ${ge("Convert between hex and base64 encodings.")}`,"",$e("convert hex <hex>","hex ‚Üí base64"),$e("convert base64 <b64>","base64 ‚Üí hex"),"",be("Example: convert hex 48656C6C6F")].join("\n"))}hexToBase64(e,t){if(t)if(/^[0-9a-fA-F]+$/.test(t))if(t.length%2==0)try{const r=new Uint8Array(t.length/2);for(let e=0;e<t.length;e+=2)r[e/2]=parseInt(t.substring(e,e+2),16);let n="";const s=8192;for(let e=0;e<r.length;e+=s)n+=String.fromCharCode.apply(null,Array.from(r.subarray(e,Math.min(e+s,r.length))));const a="function"==typeof globalThis.btoa?globalThis.btoa(n):Buffer.from(n,"binary").toString("base64");e.write(`  ${ye("hex",fe(t))}\n  ${ye("base64",fe(a))}`)}catch(r){e.write(`Error: Failed to convert - ${r instanceof Error?r.message:"unknown error"}`,"error")}else e.write("Error: Hex string must have even length","error");else e.write("Error: Input must be a hex string","error");else e.write("Usage: convert hex <hex-string>","error")}base64ToHex(e,t){if(t)try{const r="function"==typeof globalThis.atob?globalThis.atob(t):Buffer.from(t,"base64").toString("binary");let n="";for(let e=0;e<r.length;e++)n+=r.charCodeAt(e).toString(16).padStart(2,"0");e.write(`  ${ye("base64",fe(t))}\n  ${ye("hex",fe(n.toUpperCase()))}`)}catch(r){e.write(`Error: Invalid base64 string - ${r instanceof Error?r.message:"unknown error"}`,"error")}else e.write("Usage: convert base64 <base64-string>","error")}}function Nt(){const e=new Date;return`${e.toISOString().slice(0,10)}_${e.toTimeString().slice(0,8).replace(/:/g,"-")}`}function Tt(e,t){return`pymc-${e.toISOString().slice(0,10)}-${e.toTimeString().slice(0,5).replace(":","")}-${t}s.json`}const Rt=O((e,t)=>({isCapturing:!1,captureStartTime:null,captureStartPacketHashes:new Set,captureTimer:null,reports:[],startCapture:r=>{const{captureTimer:n}=t();n&&clearTimeout(n),e({isCapturing:!0,captureStartTime:new Date,captureStartPacketHashes:new Set(r.map(e=>e.packet_hash))})},stopCapture:r=>{const{isCapturing:n,captureStartTime:s,captureStartPacketHashes:a,captureTimer:o}=t();if(!n||!s)return null;o&&clearTimeout(o);const i=new Date,c=Math.round((i.getTime()-s.getTime())/1e3),l=s.getTime()/1e3,u=r.filter(e=>!a.has(e.packet_hash)&&e.timestamp>=l).sort((e,t)=>e.timestamp-t.timestamp),d={id:Nt(),filename:Tt(s,c),startTime:s,endTime:i,durationSec:c,packetCount:u.length,packets:u,sizeBytes:500*u.length};return e(e=>({isCapturing:!1,captureStartTime:null,captureStartPacketHashes:new Set,captureTimer:null,reports:[d,...e.reports].slice(0,10)})),d},getReport:e=>t().reports.find(t=>t.id===e),_setTimer:t=>e({captureTimer:t})})),Et=()=>Rt(e=>e.reports);function At(e){var t;return(null==(t=e.match(/.{1,2}/g))?void 0:t.join(" ").toUpperCase())||""}function It(e){return void 0===e?"UNKNOWN":b[e]??`TYPE_${e}`}function Lt(e){return void 0===e?"UNKNOWN":w[e]??`ROUTE_${e}`}function Ft(e,t){switch(e){case 4:return function(e){const t=[];let r=0;if(e.length>=32&&(t.push({name:"public_key",offset:r,length:32,bytes:At($(e.slice(r,r+32))),decoded:{value:$(e.slice(r,r+32))}}),r+=32),e.length>=r+4){const n=e.slice(r,r+4),s=n[0]|n[1]<<8|n[2]<<16|n[3]<<24;t.push({name:"timestamp",offset:r,length:4,bytes:At($(n)),decoded:{value:s>>>0,iso:new Date(1e3*s).toISOString()}}),r+=4}if(e.length>=r+64&&(t.push({name:"signature",offset:r,length:64,bytes:At($(e.slice(r,r+64))),decoded:{value:$(e.slice(r,r+64))}}),r+=64),e.length>r){const n=e[r],s=[];if(1&n&&s.push("CHAT_NODE"),2&n&&s.push("REPEATER"),3&n&&s.push("ROOM_SERVER"),16&n&&s.push("HAS_LOCATION"),128&n&&s.push("HAS_NAME"),t.push({name:"flags",offset:r,length:1,bytes:At($(e.slice(r,r+1))),decoded:{value:n,binary:n.toString(2).padStart(8,"0"),flags:s}}),r+=1,16&n&&e.length>=r+8){const n=e.slice(r,r+8),s=new ArrayBuffer(8);new Uint8Array(s).set(n);const a=new DataView(s),o=a.getInt32(0,!0),i=a.getInt32(4,!0);t.push({name:"location",offset:r,length:8,bytes:At($(n)),decoded:{lat_raw:o,lon_raw:i,latitude:o/1e6,longitude:i/1e6}}),r+=8}if(128&n&&e.length>r){const n=e.slice(r);let s=n.indexOf(0);-1===s&&(s=n.length);const a=(new TextDecoder).decode(n.slice(0,s));t.push({name:"name",offset:r,length:s+(0===n[s]?1:0),bytes:At($(n.slice(0,s+1))),decoded:{value:a,encoding:"utf-8",null_terminated:0===n[s]}})}}return t}(t);case 3:return function(e){if(e.length<4)return[];const t=e.slice(0,4),r=t[0]|t[1]<<8|t[2]<<16|t[3]<<24;return[{name:"crc",offset:0,length:4,bytes:At($(t)),decoded:{value:r>>>0,hex:(r>>>0).toString(16).toUpperCase().padStart(8,"0"),note:"CRC of the acknowledged packet (little-endian)"}}]}(t);case 9:return function(e){const t=[];if(e.length<9)return t;const r=e.slice(0,4),n=r[0]|r[1]<<8|r[2]<<16|r[3]<<24;t.push({name:"trace_tag",offset:0,length:4,bytes:At($(r)),decoded:{value:n>>>0,hex:(n>>>0).toString(16).toUpperCase().padStart(8,"0")}});const s=e.slice(4,8),a=s[0]|s[1]<<8|s[2]<<16|s[3]<<24;if(t.push({name:"auth_code",offset:4,length:4,bytes:At($(s)),decoded:{value:a>>>0}}),t.push({name:"flags",offset:8,length:1,bytes:At($(e.slice(8,9))),decoded:{value:e[8],binary:e[8].toString(2).padStart(8,"0")}}),e.length>9){const r=e.slice(9),n=Array.from(r).map(e=>e.toString(16).toUpperCase().padStart(2,"0"));t.push({name:"target_path",offset:9,length:r.length,bytes:At($(r)),decoded:{hops:n,path_string:n.join("->")}})}return t}(t);case 8:return function(e){if(0===e.length)return[];const t=Array.from(e).map(e=>e.toString(16).toUpperCase().padStart(2,"0"));return[{name:"path_hops",offset:0,length:e.length,bytes:At($(e)),decoded:{hops:t,path_string:t.join("->")}}]}(t);case 5:return function(e){const t=[];if(e.length<1)return t;if(t.push({name:"channel_hash",offset:0,length:1,bytes:At($(e.slice(0,1))),decoded:{value:e[0].toString(16).toUpperCase().padStart(2,"0")}}),e.length>13){const r=12,n=e.length-1-r;t.push({name:"ciphertext",offset:1,length:n,bytes:At($(e.slice(1,1+n))),decoded:{length:n,note:"Encrypted message content"}}),t.push({name:"mac",offset:1+n,length:r,bytes:At($(e.slice(-r))),decoded:{note:"Message authentication code"}})}return t}(t);default:return function(e){return 0===e.length?[]:[{name:"raw_data",offset:0,length:e.length,bytes:At($(e)),decoded:{length:e.length}}]}(t)}}function Mt(e){const t=e.type??e.payload_type??0,r=e.route??e.route_type??0,n=e.raw_packet||"";let s,a=null;if(n){const t=B.fromHex(n);if(t.success&&t.packet){const e=t.packet;try{a=D(e)}catch{a=null}const r=y(n);let o=0;const i={offset:0,length:1,bytes:At(n.slice(0,2)),decoded:{route_type:e.routeType,route_name:e.routeTypeName,payload_type:e.payloadType,payload_name:e.payloadTypeName,version:e.payloadVersion}};o+=1,e.hasTransportCodes()&&(o+=4);const c={offset:o,length:1,bytes:At($(r.slice(o,o+1))),decoded:{value:e.pathLen}};o+=1;const l=o,u=r.slice(o,o+e.pathLen),d=Array.from(e.path).map(e=>e.toString(16).toUpperCase().padStart(2,"0")),p=9===e.payloadType,m={offset:l,length:e.pathLen,bytes:At($(u)),decoded:{hops:d,path_string:d.length>0?d.join("->"):"(direct)",...p&&{note:"For TRACE packets, path bytes are SNR√ó4 values, not node hashes",snr_values:Array.from(e.path).map(e=>{let t=e;return t>127&&(t-=256),t/4})}}};o+=e.pathLen,s={header:i,path_length:c,path:m,payload:{offset:o,length:e.payload.length,bytes:At(e.payloadHex),sections:Ft(e.payloadType,e.payload)}}}else s=Ot(e)}else s=Ot(e);return{timestamp:e.timestamp,packet_hash:e.packet_hash,type:t,type_name:It(t),route:r,route_name:Lt(r),rssi:e.rssi,snr:e.snr,length:e.length??0,src_hash:e.src_hash,dst_hash:e.dst_hash,transmitted:e.transmitted,drop_reason:e.drop_reason,is_duplicate:e.is_duplicate,lbt_attempts:e.lbt_attempts,lbt_backoff_delays_ms:e.lbt_backoff_delays_ms,lbt_channel_busy:e.lbt_channel_busy,raw_packet:n,structure:s,decoded:a}}function Ot(e){var t;const r=e.type??e.payload_type??0,n=e.route??e.route_type??0,s=e.original_path??e.forwarded_path??[];return{header:{offset:0,length:1,bytes:"??",decoded:{route_type:n,route_name:Lt(n),payload_type:r,payload_name:It(r),version:0}},path_length:{offset:1,length:1,bytes:s.length.toString(16).toUpperCase().padStart(2,"0"),decoded:{value:s.length}},path:{offset:2,length:s.length,bytes:s.join(" "),decoded:{hops:s,path_string:s.length>0?s.join("->"):"(direct)"}},payload:{offset:2+s.length,length:(null==(t=e.payload)?void 0:t.length)??0,bytes:e.payload??"",sections:e.payload?Ft(r,y(e.payload)):[]}}}function Bt(e,t){const r=function(e,t){var r;return{capture:{start:e.startTime.toISOString(),end:e.endTime.toISOString(),duration_sec:e.durationSec,packet_count:e.packetCount,node_name:(null==t?void 0:t.node_name)??"unknown",local_hash:(null==t?void 0:t.local_hash)??"unknown",pymc_console_version:g,pymc_repeater_version:(null==t?void 0:t.version)??"unknown",radio_config:(null==(r=null==t?void 0:t.config)?void 0:r.radio)?{frequency:t.config.radio.frequency,tx_power:t.config.radio.tx_power,bandwidth:t.config.radio.bandwidth,spreading_factor:t.config.radio.spreading_factor}:null},packets:e.packets.map(Mt)}}(e,t),n=JSON.stringify(r,null,2),s=new Blob([n],{type:"application/json"}),a=URL.createObjectURL(s),o=document.createElement("a");o.href=a,o.download=e.filename,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(a)}function Dt(e){return e<1024?`${e} B`:e<1048576?`${(e/1024).toFixed(1)} KB`:`${(e/1048576).toFixed(1)} MB`}class Ht extends Y{constructor(){super(...arguments),t(this,"name","cap"),t(this,"description","Packet capture (start/end/list/export)")}matches(e){const t=e.toLowerCase().trim();return"cap"===t||"cap help"===t||t.startsWith("start cap")||t.startsWith("end cap")||t.startsWith("list cap")||t.startsWith("export cap")}async execute({output:e,rawInput:t}){const r=t.toLowerCase().trim();return"cap"===r||"cap help"===r?this.showHelp(e):r.startsWith("start cap")?this.startCapture(e,r):"end cap"===r?this.endCapture(e):"list cap"===r?this.listCaptures(e):r.startsWith("export cap")?this.exportCapture(e,r):void this.showHelp(e)}showHelp(e){const t=Rt.getState(),r=t.isCapturing?`\n${xe('Recording in progress... use "end cap" to stop')}`:"",n=t.reports.length,s=n>0?` (${n} saved)`:"",a=[we("Packet Capture"),"",$e("start cap","Start capture (default: 120s)"),$e("end cap","Stop capture early"),$e("list cap",`List saved captures${s}`),$e("export cap","Download capture by ID"),"",be("Captures stored in session memory. JSON includes decoded payloads."),r].filter(Boolean);e.write(a.join("\n"))}startCapture(e,t){const r=t.slice(9).trim(),n=r?parseInt(r):120;if(isNaN(n)||n<1||n>3600)return void e.write("Error: Duration must be 1-3600 seconds","error");const s=Rt.getState();if(s.isCapturing)return void e.write('Error: Capture already in progress. Use "end cap" first.',"error");const a=v.getState().packets;s.startCapture(a);let o=n;const i=e.write(xe(`Capturing... ${o}s remaining`),"system"),c=setInterval(()=>{o--;const t=Rt.getState();if(o>=0&&t.isCapturing){const r=v.getState().packets.filter(e=>{if(!t.captureStartTime)return!1;const r=t.captureStartTime.getTime()/1e3;return e.timestamp>=r&&!t.captureStartPacketHashes.has(e.packet_hash)}).length,n=o>0?`${o}s remaining`:"finishing...";e.update(i,xe(`Capturing... ${n} (${r} captured)`),"system")}},1e3),l=setTimeout(()=>{clearInterval(c);const t=Rt.getState();if(t.isCapturing){const r=v.getState().packets,n=t.stopCapture(r);n?e.write(`‚úì Capture complete!\n  Captured: ${n.packetCount} packets\n  Duration: ${n.durationSec}s\n  Size: ~${Dt(n.sizeBytes)}\n\nRun \`export cap ${n.id}\` to download.`,"success"):e.write("Capture completed with no packets.","warning")}},1e3*n);s._setTimer(l)}endCapture(e){const t=Rt.getState();if(!t.isCapturing)return void e.write("No capture in progress.","warning");const r=v.getState().packets,n=t.stopCapture(r);n?e.write(`‚úì Capture stopped!\n  Captured: ${n.packetCount} packets\n  Duration: ${n.durationSec}s\n  Size: ~${Dt(n.sizeBytes)}\n\nRun \`export cap ${n.id}\` to download.`,"success"):e.write("Capture stopped with no packets.","warning")}listCaptures(e){const{reports:t}=Rt.getState();if(0===t.length)return void e.write("No capture reports available.\nStart a capture with: start cap [seconds]","info");const r=t.map((e,t)=>`  ${t+1}. ${e.packetCount} pkts ‚Ä¢ ${e.durationSec}s ‚Ä¢ ~${Dt(e.sizeBytes)} (id: ${e.id})`);e.write(`Capture Reports (${t.length}):\n${r.join("\n")}`,"info")}exportCapture(e,t){const r=t.slice(10).trim(),n=Rt.getState(),s=v.getState().stats;if(!r){if(0===n.reports.length)e.write("No capture reports available.\nStart a capture with: start cap [seconds]","info");else{const t=n.reports.map((e,t)=>`  ${t+1}. ${e.id}`);e.write(`Usage: export cap <id>\n\nAvailable reports:\n${t.join("\n")}`,"info")}return}let a=n.getReport(r);if(!a){const e=parseInt(r)-1;a=n.reports[e]}a?(Bt(a,s),e.write(`‚úì Downloading ${a.filename}...`,"success")):e.write(`Error: Report "${r}" not found.\nUse "list cap" to see available reports.`,"error")}}class zt extends Y{constructor(){super(...arguments),t(this,"name","identities"),t(this,"description","List configured identities"),t(this,"aliases",["id","ids"])}async execute({output:e,rawInput:t}){var r;if("help"===this.argsAfterName(t).toLowerCase().trim())return void e.write([we("identities"),`  ${ge("List all configured repeater and room server identities.")}`,"",$e("identities","list identities"),"",we("Aliases"),`  ${ge("id, ids")}`].join("\n"));const n=e.write("processing...","system");try{const t=await x();if(!t.success||!t.data)return void e.update(n,t.error||"Failed to fetch identities","error");const s=t.data,a=(null==(r=s.configured)?void 0:r.length)?s.configured:s.registered||[];if(0===a.length)return void e.update(n,"No identities configured.","warning");const o=[we(`Identities (${a.length})`),"",...a.map((e,t)=>{var r;const n=e.name||"Unnamed",s=e.type||"unknown",a=(null==(r=e.hash)?void 0:r.slice(0,8))||"‚Äî";return`  ${ge(`${t+1}.`)} ${pe(n)}  ${me(s)}  ${fe(a)}`})];e.update(n,o.join("\n"))}catch(s){e.update(n,`Error: ${s instanceof Error?s.message:"Command failed"}`,"error")}}}class Ut extends Y{constructor(){super(...arguments),t(this,"name","keys"),t(this,"description","List transport keys")}async execute({output:e,rawInput:t}){if("help"===this.argsAfterName(t).toLowerCase().trim())return void e.write([we("keys"),`  ${ge("List configured transport encryption keys.")}`,"",$e("keys","list transport keys")].join("\n"));const r=e.write("processing...","system");try{const t=await H();if(!t.success||!t.data)return void e.update(r,t.error||"Failed to fetch transport keys","error");const n=t.data;if(0===n.length)return void e.update(r,"No transport keys configured.","warning");const s=[we(`Transport Keys (${n.length})`),"",...n.map(e=>{const t=e.parent_id?`  ${me(`parent: ${e.parent_id}`)}`:"";return`  ${pe(e.name)}  ${ye("flood",fe(e.flood_policy))}${t}`})];e.update(r,s.join("\n"))}catch(n){e.update(r,`Error: ${n instanceof Error?n.message:"Command failed"}`,"error")}}}class Pt extends Y{constructor(){super(...arguments),t(this,"name","acl"),t(this,"description","Show ACL statistics")}async execute({output:e,rawInput:t}){if("help"===this.argsAfterName(t).toLowerCase().trim())return void e.write([we("acl"),`  ${ge("Display access control list statistics.")}`,"",$e("acl","show ACL stats")].join("\n"));const r=e.write("processing...","system");try{const t=await U();if(!t.success||!t.data)return void e.update(r,t.error||"Failed to fetch ACL stats","error");const n=t.data,s=[we("ACL Stats"),"",`  ${ye("Identities",fe(String(n.total_identities)))}`,`  ${ye("Total clients",fe(String(n.total_clients)))}`,`  ${ye("Admin",fe(String(n.admin_clients)))}`,`  ${ye("Guest",fe(String(n.guest_clients)))}`];if(n.by_identity_type){const e=n.by_identity_type.repeater,t=n.by_identity_type.room_server;e&&s.push(`  ${ye("Repeater",`${fe(String(e.count))} ids  ${ge(`${e.clients} clients`)}`)}`),t&&s.push(`  ${ye("Room Server",`${fe(String(t.count))} ids  ${ge(`${t.clients} clients`)}`)}`)}e.update(r,s.join("\n"))}catch(n){e.update(r,`Error: ${n instanceof Error?n.message:"Command failed"}`,"error")}}}class qt extends Y{constructor(){super(...arguments),t(this,"name","rooms"),t(this,"description","Show room server statistics")}async execute({output:e,rawInput:t}){if("help"===this.argsAfterName(t).toLowerCase().trim())return void e.write([we("rooms"),`  ${ge("Display room server statistics and sync status.")}`,"",$e("rooms","list rooms")].join("\n"));const r=e.write("processing...","system");try{const t=await _();if(!t.success||!t.data)return void e.update(r,t.error||"Failed to fetch room stats","error");const n=t.data.rooms||[];if(0===n.length)return void e.update(r,"No room servers configured.","warning");const s=[we(`Rooms (${n.length})`),"",...n.map(e=>[`  ${pe(e.room_name)}`,`    ${ye("msgs",fe(String(e.total_messages)))}  ${ye("clients",`${fe(String(e.active_clients))}${me(`/${e.total_clients}`)}`)}  ${ye("sync",e.sync_running?fe("running"):me("idle"))}`]).flat()];e.update(r,s.join("\n"))}catch(n){e.update(r,`Error: ${n instanceof Error?n.message:"Command failed"}`,"error")}}}class Wt extends Y{constructor(){super(...arguments),t(this,"name","restart"),t(this,"description","Restart pymc-repeater service"),t(this,"aliases",["reboot"])}async execute({output:e,rawInput:t}){if("help"===this.argsAfterName(t).toLowerCase().trim())return void e.write([we("restart"),`  ${ge("Restart the pymc-repeater systemd service.")}`,"",$e("restart","restart the service"),"",we("Aliases"),`  ${ge("reboot")}`,"",be("Requires polkit permissions for the web user."),be("The page will need a manual refresh after restart.")].join("\n"));const r=e.write("Restarting service...","system");try{const t=await z(AbortSignal.timeout(8e3));if(t.success)return e.update(r,"Service restart initiated.","success"),void this.waitForService(e);const n=t.status;if(403===n||401===n)return void e.update(r,"Error: Permission denied.\n\nThe web user needs polkit permissions to restart the service.\nSee: /etc/polkit-1/localauthority/50-local.d/pymc-repeater.pkla","error");e.update(r,t.error||"Restart failed","error")}catch(n){const t=n instanceof Error?n.message:"";t.includes("ERR_NETWORK")||t.includes("ECONNRESET")||t.includes("Failed to fetch")||t.includes("abort")||t.includes("timeout")||n instanceof DOMException&&"TimeoutError"===n.name||n instanceof DOMException&&"AbortError"===n.name?(e.update(r,"Service is restarting (connection dropped).","success"),this.waitForService(e)):e.update(r,`Error: ${t||"Restart failed"}`,"error")}}waitForService(e){const t=e.write("Waiting for service...","system");let r=0,n=!1;setTimeout(()=>{const s=setInterval(async()=>{if(!n){r++,e.update(t,`Waiting for service... ${r}s`,"system");try{await fetch(`${k}/api/stats`,{signal:AbortSignal.timeout(3e3)}),n=!0,clearInterval(s),e.update(t,`Service connected. (${r+4}s)`,"success")}catch{}!n&&r>=30&&(n=!0,clearInterval(s),e.update(t,"Service did not respond within 34s. Check manually.","warning"))}},1e3)},4e3)}}const Kt=O(e=>({entries:[],commandHistory:[],isInitialized:!1,addEntry:t=>{const r="undefined"!=typeof crypto&&crypto.randomUUID?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}),n={...t,id:r,timestamp:Date.now()};return e(e=>({entries:[...e.entries,n]})),r},updateEntry:(t,r)=>{e(e=>({entries:e.entries.map(e=>e.id===t?{...e,...r}:e)}))},addCommand:t=>{e(e=>({commandHistory:[...e.commandHistory,t]}))},clearEntries:()=>{e({entries:[],commandHistory:[]})},setInitialized:t=>{e({isInitialized:t})}}));function Xt({isOpen:e,onClose:t}){const n=Et(),s=v(e=>e.stats);return r.jsxs(S,{open:e,onClose:t,size:"lg",children:[r.jsx(C,{icon:r.jsx(F,{size:20}),title:"Download Captures",onClose:t}),r.jsx(j,{children:r.jsx("div",{className:"flex flex-col gap-3",children:0===n.length?r.jsx("p",{className:"text-text-secondary",children:"No captures available."}):n.map(e=>r.jsxs("div",{className:"flex items-center justify-between p-2 rounded-md bg-bg-surface-elevated",children:[r.jsxs("div",{children:[r.jsx("p",{className:"font-semibold",children:e.filename}),r.jsxs("p",{className:"text-sm text-text-secondary",children:[e.packetCount," packets ‚Ä¢ ",e.durationSec,"s ‚Ä¢ ~",Dt(e.sizeBytes)]})]}),r.jsx("button",{onClick:()=>(e=>{const t=n.find(t=>t.id===e);t&&Bt(t,s)})(e.id),className:"p-2 text-text-secondary hover:text-text-primary hover:bg-bg-subtle rounded-md transition-colors",title:"Download",children:r.jsx(F,{size:18})})]},e.id))})})]})}function Gt(){const e=Et(),t=e.length>0,[s,a]=n.useState(!1);return t?r.jsxs(r.Fragment,{children:[r.jsx(P,{icon:r.jsx(q,{size:20}),onClick:()=>a(!0),title:`Download captures (${e.length})`,iconActiveColor:"#E5484D",keycapSrc:"/assets/keycap-red.svg"}),r.jsx(Xt,{isOpen:s,onClose:()=>a(!1)})]}):null}const Vt=function(){const e=new J,t=new Ge(e);return e.register(t,new Ve,new Ye,new Qe,new Ze,new rt,new nt,new ht,new Ct,new ft,new gt,new jt,new Ht,new zt,new Ut,new Pt,new qt,new Wt),e}(),Jt=Vt.all().flatMap(e=>[{cmd:e.name,desc:e.description,params:e.params,required:!!e.params},...e.aliases.filter(e=>e.includes(" ")).map(t=>({cmd:t,desc:e.description,params:e.params,required:!!e.params}))]),Yt={"set mode":["forward","monitor"],"set duty":["on","off"],"set repeat":["on","off"],"set tx":["10","14","17","20","22"],"set sf":["7","8","9","10","11","12"],"set bw":["125","250","500"],"set af":["0.5","1.0","1.5","2.0"],"set txdelay":["0.5","0.7","1.0","1.5"],"set direct.txdelay":["0.3","0.5","0.7"],"set log":["debug","info","warning"],"start cap":["30","60","120","300"]};function Qt(){return/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)||window.innerWidth<640}function Zt(){const e=N(),{addCommand:t}=Kt(),l=n.useRef(null),u=n.useRef(null),d=n.useRef(null),p=n.useRef(null),m=n.useRef(""),h=n.useRef(-1),f=n.useRef(""),g=n.useRef(!1),y=n.useRef(!1),$=n.useRef([]),w=n.useRef(()=>{}),b=T(),[v,x]=n.useState({show:!1,options:[],selectedIndex:0,input:""}),_=n.useRef([]),k=n.useRef(0);n.useEffect(()=>{(null==e?void 0:e.neighbors)&&($.current=Object.values(e.neighbors).map(e=>e.node_name||e.name).filter(e=>!!e).sort())},[null==e?void 0:e.neighbors]);const S=n.useCallback(()=>{var e;null==(e=u.current)||e.write(ve)},[]),C=n.useCallback(()=>{const e=u.current;e&&(e.write(Ne),S(),e.write(m.current))},[S]),j=n.useCallback(e=>{const t=function(e,t){const r=e.trim().toLowerCase();if(!r)return[];const n=Jt.filter(e=>e.cmd.toLowerCase().startsWith(r));if(n.length>0)return n;if(r.includes(" ")){const e=r.lastIndexOf(" "),n=r.substring(0,e),s=r.substring(e+1);if("ping"===n&&t.length>0)return t.filter(e=>e.toLowerCase().startsWith(s)).slice(0,10).map(e=>({cmd:`ping ${e}`,desc:`‚Üí ${e}`}));const a=Jt.find(e=>e.cmd.toLowerCase()===n);if(a&&Yt[a.cmd])return Yt[a.cmd].filter(e=>e.toLowerCase().startsWith(s)).map(e=>({cmd:`${a.cmd} ${e}`,desc:`‚Üí ${e}`}))}return[]}(e,$.current);_.current=t,k.current=0;const r=t.length>0&&e.trim().length>0;x({show:r,options:t,selectedIndex:0,input:e.trim()})},[]),A=n.useCallback(()=>{_.current=[],k.current=0,x({show:!1,options:[],selectedIndex:0,input:""})},[]),I=n.useCallback(e=>{var t;const r=_.current[e];r&&(m.current=r.required?r.cmd+" ":r.cmd,C(),r.required?j(m.current):A(),null==(t=u.current)||t.focus())},[C,j,A]),L=n.useCallback(async e=>{const r=u.current;if(!r)return;const n=e.trim();if(!n)return void S();g.current=!0,t(n),h.current=-1;let s=0;const a={write(e,t="default"){const n=("default"===t?e:de(e,t)).split("\n");for(const s of n)r.writeln(s);return s=n.length,String(s)},update(e,t,n){if(s>0)for(let o=0;o<s;o++)r.write(Te()),r.write(Ne);const a=(n?de(t,n):t).split("\n");for(const s of a)r.writeln(s);s=a.length},clear(){r.clear(),s=0}},o=Vt.find(n);if(o){const e=n.split(/\s+/);try{await o.execute({output:a,args:e,rawInput:n,cols:r.cols})}catch(i){a.write(`Error: ${i instanceof Error?i.message:"Command failed"}`,"error")}}else a.write(`Unknown command: ${n}\nType 'help' for available commands.`,"error");g.current=!1,S()},[t,S]),F=n.useCallback(e=>{const t=u.current;if(!t||g.current)return;const r=Kt.getState().commandHistory,n=e=>requestAnimationFrame(()=>{var t;return null==(t=document.querySelector(`[data-ac-index="${e}"]`))?void 0:t.scrollIntoView({block:"nearest"})});for(let s=0;s<e.length;s++){const a=e.charCodeAt(s);if(13===a){if(_.current.length>0){const e=_.current[k.current];e&&(m.current=e.cmd,C())}A();const e=m.current;m.current="",t.writeln(""),L(e);continue}if(127!==a&&8!==a)if(3!==a)if(12!==a)if(9!==a)if(27!==a)a>=32&&(m.current+=e[s],t.write(e[s]),h.current=-1,j(m.current));else{if(91===e.charCodeAt(s+1)){const t=e.charCodeAt(s+2);if(s+=2,65===t){if(_.current.length>0){const e=Math.max(k.current-1,0);k.current=e,x(t=>({...t,selectedIndex:e})),n(e)}else r.length>0&&(-1===h.current&&(f.current=m.current),h.current<r.length-1&&(h.current++,m.current=r[r.length-1-h.current]||"",C()));continue}if(66===t){if(_.current.length>0){const e=Math.min(k.current+1,_.current.length-1);k.current=e,x(t=>({...t,selectedIndex:e})),n(e)}else h.current>0?(h.current--,m.current=r[r.length-1-h.current]||"",C()):0===h.current&&(h.current=-1,m.current=f.current,C());continue}if(67===t||68===t)continue;continue}_.current.length>0&&A()}else _.current.length>0&&I(k.current);else t.clear(),A(),C();else m.current="",A(),t.writeln("^C"),S();else m.current.length>0&&(m.current=m.current.slice(0,-1),t.write("\b \b"),j(m.current))}},[A,j,I,S,C,L]);n.useEffect(()=>{w.current=F},[F]);const M=n.useCallback(async()=>{const e=u.current;if(!e||y.current)return;y.current=!0;const t="‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  ‚ñà‚ñà    ‚ñà‚ñà ‚ñà‚ñà‚ñà    ‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà\n‚ñà‚ñà   ‚ñà‚ñà  ‚ñà‚ñà  ‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà ‚ñà‚ñà     \n‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà    ‚ñà‚ñà‚ñà‚ñà   ‚ñà‚ñà ‚ñà‚ñà‚ñà‚ñà ‚ñà‚ñà ‚ñà‚ñà     \n‚ñà‚ñà         ‚ñà‚ñà    ‚ñà‚ñà  ‚ñà‚ñà  ‚ñà‚ñà ‚ñà‚ñà     \n‚ñà‚ñà         ‚ñà‚ñà    ‚ñà‚ñà      ‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà".split("\n");for(const r of t)e.writeln(fe(r));e.writeln(""),e.write(ge("‚óè Initializing terminal...")),await new Promise(e=>setTimeout(e,300)),e.write(Ne),e.writeln(he("‚úì Initializing terminal...")),e.write(ge("‚óè Connecting to repeater...")),await new Promise(e=>setTimeout(e,500)),e.write(Ne),"connected"===R.getState().health?e.writeln(he("‚úì Connected to repeater")):e.writeln(`${ae}~ Connection status unknown${Z}`),e.writeln(ge("Ready. Type 'help' for commands.")),e.writeln(""),S()},[S]);n.useEffect(()=>{const e=l.current;if(!e)return;const t=new a({theme:Ee(),fontFamily:'"JetBrains Mono", "IBM Plex Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace',fontSize:13,lineHeight:1.4,cursorBlink:!1,cursorStyle:"underline",scrollback:1e4,convertEol:!0,allowTransparency:!0,rightClickSelectsWord:!1}),r=new o;t.loadAddon(r),t.loadAddon(new i),t.open(e),r.fit(),u.current=t,d.current=r;const n=t.onData(e=>w.current(e)),s=function(e){return c.subscribe(()=>{e.options.theme=Ee()})}(t),p=new ResizeObserver(()=>{requestAnimationFrame(()=>r.fit())});return p.observe(e),M(),Qt()||t.focus(),()=>{n.dispose(),s(),p.disconnect(),t.dispose(),u.current=null,d.current=null}},[]);const O=n.useCallback(e=>{const t=e.target.value;t.length>0&&(F(t),e.target.value="")},[F]),B=n.useCallback(e=>{"Enter"===e.key?(e.preventDefault(),F("\r")):"Backspace"===e.key?(e.preventDefault(),F("")):"ArrowUp"===e.key?(e.preventDefault(),F("[A")):"ArrowDown"===e.key&&(e.preventDefault(),F("[B"))},[F]),D=n.useCallback(()=>{var e,t;Qt()?null==(e=p.current)||e.focus():null==(t=u.current)||t.focus()},[]);return r.jsxs(K,{children:[r.jsx(X,{title:"Terminal",icon:r.jsx(E,{})}),r.jsx(G,{children:r.jsxs("div",{className:"terminal-card flex flex-col gap-1.5",children:[r.jsxs("div",{className:"card-terminal-header flex-wrap",children:[r.jsx("span",{className:"seven-seg-panel",children:r.jsx(W,{text:"5hell",minChars:7,size:24})}),r.jsx("div",{className:"keycap-well self-stretch flex flex-col",children:r.jsxs("div",{className:"indicator-key"+("connected"===b?" indicator-key--active":"degraded"===b?" indicator-key--sending":""),children:[r.jsx("span",{className:"indicator-key__label",children:"ONLINE"}),r.jsx("span",{className:"indicator-key__led"})]})}),r.jsx("div",{className:"card-terminal-ridge flex-1 min-w-8 hidden sm:block"}),r.jsx("div",{className:"keycap-well keycap-well--rounded flex items-center gap-1",children:r.jsx(Gt,{})})]}),r.jsx(V,{noPadding:!0,className:"flex flex-col flex-1 min-h-0 overflow-hidden card-terminal",onClick:D,children:r.jsxs("div",{className:"card-terminal-well flex-1 min-h-0 flex flex-col overflow-hidden",children:[r.jsx("div",{className:"flex-1 min-h-0 terminal-gutter",children:r.jsx("div",{ref:l,className:"h-full w-full"})}),v.show&&v.options.length>0&&r.jsxs("div",{className:"flex-shrink-0 overflow-hidden terminal-completions",style:{borderTop:"1px solid var(--terminal-border)",background:"var(--terminal-bg-input)"},children:[r.jsx("div",{className:"overflow-y-auto",style:{maxHeight:"176px"},children:v.options.map((e,t)=>{const n=t===v.selectedIndex,a=v.input.length;return r.jsxs("div",{"data-ac-index":t,onClick:()=>I(t),className:s("flex items-baseline gap-2 px-3 py-0.5 cursor-pointer transition-colors",n?"text-accent-primary":"text-text-primary"),style:{background:n?"var(--terminal-autocomplete-hover)":void 0},onMouseEnter:e=>{n||(e.currentTarget.style.background="var(--terminal-autocomplete-hover)")},onMouseLeave:e=>{n||(e.currentTarget.style.background="")},children:[r.jsx("span",{className:"w-3 shrink-0 text-center text-accent-primary opacity-80",children:n?"‚ñ∏":""}),r.jsxs("span",{className:"min-w-0 truncate flex-1",children:[r.jsx("span",{className:"font-semibold text-accent-primary",children:e.cmd.substring(0,a)}),e.cmd.substring(a)]}),r.jsx("span",{className:"shrink-0 text-[11px] text-text-muted pl-3",children:e.desc})]},e.cmd)})}),r.jsxs("div",{className:"flex justify-between items-center px-3 py-0.5 text-[10px] text-text-muted",style:{borderTop:"1px solid var(--terminal-border)"},children:[r.jsx("span",{children:"Tab ¬∑ ‚Üë‚Üì ¬∑ Esc"}),r.jsxs("span",{children:[v.options.length," match",1!==v.options.length?"es":""]})]})]}),r.jsx("input",{ref:p,type:"text",className:"sr-only",onChange:O,onKeyDown:B,autoComplete:"off",autoCorrect:"off",autoCapitalize:"off",spellCheck:!1,"aria-label":"Terminal input"}),r.jsxs("div",{className:"px-3 sm:px-4 py-1 flex justify-between text-[10px] text-text-muted",style:{borderTop:"1px solid var(--terminal-border)"},children:[r.jsx("span",{className:"hidden sm:inline",children:"‚Üë‚Üì History ¬∑ Tab ¬∑ Esc"}),r.jsx("span",{className:"sm:hidden",children:"Terminal"}),(null==e?void 0:e.version)&&r.jsxs("span",{children:["pyMC v",e.version]})]})]})})]})})]})}export{Zt as default};
