var __defProp=Object.defineProperty,__defNormalProp=(e,t,n)=>t in e?__defProp(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,__publicField=(e,t,n)=>__defNormalProp(e,"symbol"!=typeof t?t+"":t,n);!function(){"use strict";const e=.6;function t(e){return 1===e||0===e}function n(e){return 2===e||3===e}function o(e){return e.startsWith("0x")||e.startsWith("0X")?e.slice(2,4).toUpperCase():e.slice(0,2).toUpperCase()}function s(e,t){let n=e.forwarded_path??e.original_path;if("string"==typeof n)try{n=JSON.parse(n)}catch{return null}if(!n||!Array.isArray(n)||0===n.length)return null;const s=n.map(e=>String(e).toUpperCase()),i=t?o(t):null,r=s[s.length-1],a=null!==i&&r===i,c=a?s.slice(0,-1):[...s];return{effective:c,original:s,hadLocal:a,effectiveLength:c.length}}function i(e,t){return t-e}function r(e){return e}function a(e,t,n,o){const s=(n-e)*Math.PI/180,i=(o-t)*Math.PI/180,r=Math.sin(s/2)*Math.sin(s/2)+Math.cos(e*Math.PI/180)*Math.cos(n*Math.PI/180)*Math.sin(i/2)*Math.sin(i/2);return 2*Math.atan2(Math.sqrt(r),Math.sqrt(1-r))*6371e3}function c(e){return e<500?1:e<2e3?.8:e<5e3?.6:e<1e4?.4:e<2e4?.2:.1}function u(e,t){return void 0!==e&&void 0!==t&&(0!==e||0!==t)}function l(e){if(e.contact_type){const t=e.contact_type.toLowerCase();if("repeater"===t||"rep"===t)return!0;if("companion"===t||"client"===t||"cli"===t)return!1;if("room server"===t||"room_server"===t||"room"===t||"server"===t)return!1}return!0===e.is_repeater||(e.is_repeater,!1)}function f(e,t){if(!e||e<=0)return.1;const n=(Math.floor(Date.now()/1e3)-e)/3600;return n<0?1:Math.exp(-n/12)}function h(e){return!(!e||e<=0)&&(Math.floor(Date.now()/1e3)-e)/3600>336}function d(e,t,n){const o=t.toUpperCase(),s=e.get(o);if(!s||0===s.candidates.length)return{hash:null,confidence:0};if(null==n?void 0:n.isLastHop)return{hash:s.bestMatch,confidence:s.confidence};if(1===(null==n?void 0:n.position))return{hash:s.bestMatch,confidence:s.confidence};if((null==n?void 0:n.position)&&s.bestMatchForPosition.has(n.position)){const e=s.bestMatchForPosition.get(n.position),t=Math.max(e.confidence,s.confidence);return{hash:e.hash,confidence:t}}if((null==n?void 0:n.adjacentPrefixes)&&n.adjacentPrefixes.length>0){let e=s.bestMatch,t=0;for(const o of s.candidates){let s=0;for(const e of n.adjacentPrefixes)s+=o.adjacentPrefixCounts.get(e.toUpperCase())||0;const i=o.combinedScore+s/Math.max(1,o.totalAdjacentObservations)*.3;i>t&&(t=i,e=o.hash)}return{hash:e,confidence:s.confidence}}return{hash:s.bestMatch,confidence:s.confidence}}function p(e){return!e||e<=0||(Math.floor(Date.now()/1e3)-e)/3600>168}function g(e){var t;if(e.length<=1)return{isReplacement:!1,activeCandidates:e,staleReplacements:[]};const n=new Map,o=[];for(const a of e){const e=null==(t=a.name)?void 0:t.trim().toLowerCase();if(e){const t=n.get(e)||[];t.push(a),n.set(e,t)}else o.push(a)}const s=[],i=[];let r=!1;for(const[,a]of n)if(a.length>1){const e=a.filter(e=>!p(e.lastSeenTimestamp)),t=a.filter(e=>p(e.lastSeenTimestamp));if(e.length>=1&&t.length>=1){r=!0,e.sort((e,t)=>t.recencyScore-e.recencyScore),s.push(e[0]),i.push(...t);for(let t=1;t<e.length;t++)s.push(e[t])}else s.push(...a)}else s.push(...a);return s.push(...o),{isReplacement:r,activeCandidates:s,staleReplacements:i}}function m(e){return"known"===e.type}const v=[0,.25,.5,.75,1];function y(e,t,n){if(!e)return 0;const o=(n-e.origin[1])/e.cellSize,s=(t-e.origin[0])/e.cellSize;if(o<0||o>=e.width-1||s<0||s>=e.height-1)return 0;const i=Math.floor(o),r=Math.floor(s),a=o-i,c=s-r,u=r*e.width+i,l=r*e.width+i+1,f=(r+1)*e.width+i,h=(r+1)*e.width+i+1;return((e.elevations[u]??0)*(1-a)+(e.elevations[l]??0)*a)*(1-c)+((e.elevations[f]??0)*(1-a)+(e.elevations[h]??0)*a)*c}function C(e,t,n,o,s){return[e+(n-e)*s,t+(o-t)*s]}function b(e,t,n,o){const s=e+(t-e)*n,i=2*Math.abs(n-.5);return s-P(o)*(1-i*i)}function M(e,t,n=915){const o=299792458/(1e6*n),s=1e3*e,i=1e3*(t-e);return s<=0||i<=0?0:Math.sqrt(o*s*i/(s+i))}function S(e,t,n){const o=void 0!==e.latitude&&void 0!==e.longitude&&(0!==e.latitude||0!==e.longitude),s=void 0!==t.latitude&&void 0!==t.longitude&&(0!==t.latitude||0!==t.longitude);if(!o||!s)return{theoreticallyPossible:!0,losConfidence:.3,worstClearance:0,sampleCount:0,reason:"no_terrain",distanceKm:0,earthBulgeM:0};const i=_(e.latitude,e.longitude,t.latitude,t.longitude);if(i>150)return{theoreticallyPossible:!1,losConfidence:1,worstClearance:-1/0,sampleCount:0,reason:"distance_limit",distanceKm:i,earthBulgeM:P(i)};if(i<.5)return{theoreticallyPossible:!0,losConfidence:.95,worstClearance:100,sampleCount:0,reason:"too_close",distanceKm:i,earthBulgeM:P(i)};if(!n){const e=P(i),t=20-e;return{theoreticallyPossible:t>0||i<30,losConfidence:.4,worstClearance:t,sampleCount:0,reason:t>10?"likely_clear":"marginal",distanceKm:i,earthBulgeM:e}}const r=e.elevation??y(n,e.latitude,e.longitude),a=t.elevation??y(n,t.latitude,t.longitude),c=r+(e.antennaHeight??10),u=a+(t.antennaHeight??10);let l=1/0,f=1;for(const d of v){const[o,s]=C(e.latitude,e.longitude,t.latitude,t.longitude,d),r=y(n,o,s),a=b(c,u,d,i)-r;a<l&&(l=a,f=a/(.6*M(d*i,i)))}const h=function(e,t,n){return e>20&&t>1?"clear":e>5&&t>.6?"likely_clear":e>-5&&t>.3?"marginal":e>-20||n<10?"likely_blocked":"blocked"}(l,f,i);return{theoreticallyPossible:"blocked"!==h&&"distance_limit"!==h,losConfidence:.7,worstClearance:l,sampleCount:v.length,reason:h,distanceKm:i,earthBulgeM:P(i)}}function w(e){const{terrainFeasibility:t,observationCount:n,observationConfidence:o}=e;if(t.theoreticallyPossible)return!0;const s=function(e){switch(e){case"clear":case"likely_clear":case"too_close":return{minCount:0,minConfidence:0};case"marginal":return{minCount:5,minConfidence:.6};case"likely_blocked":default:return{minCount:10,minConfidence:.7};case"blocked":return{minCount:20,minConfidence:.8};case"distance_limit":return{minCount:1/0,minConfidence:1};case"no_terrain":return{minCount:3,minConfidence:.5}}}(t.reason);return"distance_limit"!==t.reason&&n>=s.minCount&&o>=s.minConfidence}function k(e,t){return e<t?`${e}|${t}`:`${t}|${e}`}class x{constructor(){__publicField(this,"cache",new Map)}getOrCompute(e,t,n){const o=k(e.hash,t.hash);let s=this.cache.get(o);if(!s){s={terrainFeasibility:S(e,t,n),observationCount:0,observationConfidence:0,lastObserved:0,isOverridden:!1},this.cache.set(o,s)}return s}recordObservation(e,t,n,o){const s=k(e,t),i=this.cache.get(s);if(i){const e=function(e,t,n){const o=e.observationCount+1,s=(e.observationConfidence*e.observationCount+t)/o,i={...e,observationCount:o,observationConfidence:s,lastObserved:Math.max(e.lastObserved,n)};return i.isOverridden=!e.terrainFeasibility.theoreticallyPossible&&w(i),i}(i,n,o);return this.cache.set(s,e),e}}get(e,t){return this.cache.get(k(e,t))}isFeasible(e,t){const n=this.get(e,t);return!n||w(n)}getOverriddenLinks(){const e=[];for(const[t,n]of this.cache)n.isOverridden&&e.push({key:t,evidence:n});return e}clear(){this.cache.clear()}getStats(){let e=0,t=0,n=0;for(const o of this.cache.values())w(o)?(e++,o.isOverridden&&n++):t++;return{totalLinks:this.cache.size,possibleLinks:e,blockedLinks:t,overriddenLinks:n}}}const H=6371;function _(e,t,n,o){const s=e*Math.PI/180,i=t*Math.PI/180,r=n*Math.PI/180,a=r-s,c=o*Math.PI/180-i,u=Math.sin(a/2)**2+Math.cos(s)*Math.cos(r)*Math.sin(c/2)**2,l=2*Math.atan2(Math.sqrt(u),Math.sqrt(1-u));return H*l}function P(e){if(e<=0)return 0;const t=1e3*e;return t*t/(1e3*H*8)}function L(e,t){const n=void 0!==e.latitude&&void 0!==e.longitude&&(0!==e.latitude||0!==e.longitude),o=void 0!==t.latitude&&void 0!==t.longitude&&(0!==t.latitude||0!==t.longitude);return n&&o?function(e,t,n,o){const s=_(e,t,n,o);if(s>150)return 1/0;if(s<.1)return.01;const i=P(s);var r,a;const c=(r=s,1/(1+Math.exp(.15*(r-60)))*(a=i,1/(1+Math.exp(.5*(a-40)))));return c<1e-10?1e3:-Math.log(c)}(e.latitude,e.longitude,t.latitude,t.longitude):3}function E(e,t,n){if(n>=.8&&t>0){const e=Math.log(1+Math.min(t,50)/5);return Math.max(.01,.5-e)}if(n>=.5&&t>0){const n=Math.log(1+t/10);return.3*e+.7*Math.max(.1,e-n)}if(t>0){const n=Math.log(1+t/20);return.7*e+.3*Math.max(.1,e-n)}return e}function R(e,t){return e<t?`${e}-${t}`:`${t}-${e}`}function A(e,t,n,o=[],s){const i=[];let r=0;for(const c of t){const t=-Math.log(Math.max(c.recencyScore,.01));let n=Math.min(t,5);c.confidence>=.8?n=Math.max(0,n-2):c.confidence>=.5&&(n=Math.max(0,n-1)),i.push({stateIdx:r,hash:c.hash,prefix:e,isGhost:!1,latitude:c.latitude,longitude:c.longitude,priorCost:n,disambiguationConfidence:c.confidence}),r++}const a=function(e,t,n){for(const o of e){const e=void 0!==o.latitude&&void 0!==o.longitude,t=o.recencyScore>=.35,n=o.confidence>=.3;if(e&&t&&n)return!0}if(n&&e.length>0&&t.length>0)for(const o of e)for(const e of t){const t=R(o.hash,e);if((n.edgeCounts.get(t)??0)>=5)return!0}return!1}(t,o,s);if(n&&!a){const n=function(e){if(0===e.length)return 5;const t=Math.max(...e.map(e=>e.confidence));return t>=.6?20:t>=.3?15:12}(t);i.push({stateIdx:r,hash:null,prefix:e,isGhost:!0,priorCost:n,disambiguationConfidence:0})}return i}function $(e,t,n){var o,s,i;const r=n.minEdgeObservationsForHistory??3;if(e.isGhost||t.isGhost)return 15;const a=R(e.hash,t.hash),c=(null==(o=n.edgeHistory)?void 0:o.edgeCounts.get(a))??0,u=(null==(s=n.edgeHistory)?void 0:s.edgeConfidence.get(a))??0,l=Math.sqrt(e.disambiguationConfidence*t.disambiguationConfidence),f=c>=r?Math.max(l,u):l;if(n.enableTerrainAware??void 0!==n.terrainGrid){const o={hash:e.hash,latitude:e.latitude,longitude:e.longitude},s={hash:t.hash,latitude:t.latitude,longitude:t.longitude},r=null==(i=n.feasibilityCache)?void 0:i.get(e.hash,t.hash),a=function(e,t,n,o,s,i){const r=function(e,t,n,o){let s,i;if(o?(s=o.terrainFeasibility,i=w(o)):(s=S(e,t,n),i=s.theoreticallyPossible),"distance_limit"===s.reason)return 1/0;if(!i)return 1/0;const r=L({latitude:e.latitude,longitude:e.longitude},{latitude:t.latitude,longitude:t.longitude});let a=0;switch(s.reason){case"clear":case"too_close":case"no_terrain":a=0;break;case"likely_clear":a=.5;break;case"marginal":a=2;break;case"likely_blocked":a=(null==o?void 0:o.isOverridden)?2:5;break;case"blocked":a=(null==o?void 0:o.isOverridden)?2:8}if((null==o?void 0:o.isOverridden)&&o.observationCount>0){const e=Math.log(1+o.observationCount/10);a=Math.max(0,a-e)}return r+a}(e,t,n,o);if(r===1/0){if(i>=.8&&s>=20){const e=Math.log(1+s/5);return Math.max(.5,2-e)}return 1/0}return E(r,s,i)}(o,s,n.terrainGrid,r,c,f);return n.feasibilityCache&&a!==1/0&&f>.3&&n.feasibilityCache.recordObservation(e.hash,t.hash,f,Date.now()),a}return E(L({latitude:e.latitude,longitude:e.longitude},{latitude:t.latitude,longitude:t.longitude}),c,f)}function D(e,t,n={}){const o=n.enableGhostNodes??!0;if(0===t.length)return{nodes:[],totalCost:0,confidence:1,hasGhostNodes:!1,ghostPrefixes:[],originalPrefixes:[],usedObservationOverride:!1};const s=t.length,i=[];for(let m=0;m<s;m++){const n=t[m].toUpperCase();i.push(e.get(n)??[])}const r=[];for(let m=0;m<s;m++){const e=t[m].toUpperCase(),a=i[m],c=[];m>0&&c.push(...i[m-1].map(e=>e.hash)),m<s-1&&c.push(...i[m+1].map(e=>e.hash));const u=A(e,a,o,c,n.edgeHistory);if(0===u.length)return O(t);r.push(u)}const a=[];a[0]=r[0].map(e=>({cost:e.priorCost,prevStateIdx:null,state:e}));let c=!1;for(let m=1;m<s;m++){const e=r[m],t=a[m-1];a[m]=e.map(e=>{let o=1/0,s=null;for(let i=0;i<t.length;i++){const r=t[i],a=r.state;if(r.cost===1/0)continue;const u=$(a,e,n);if(e.isGhost||a.isGhost||Math.sqrt(a.disambiguationConfidence*e.disambiguationConfidence)>=(n.observationOverrideThreshold??.8)&&(c=!0),u===1/0)continue;const l=r.cost+u+e.priorCost;l<o&&(o=l,s=i)}return{cost:o,prevStateIdx:s,state:e}})}const u=a[s-1];let l=1/0,f=0;for(let m=0;m<u.length;m++)u[m].cost<l&&(l=u[m].cost,f=m);if(l===1/0)return O(t);const h=[],d=[];let p=f;for(let m=s-1;m>=0;m--){const e=a[m][p],t=e.state;if(t.isGhost){const e={type:"ghost",prefix:t.prefix};h.unshift(e),d.unshift(t.prefix)}else{const e={type:"known",hash:t.hash,prefix:t.prefix,confidence:t.disambiguationConfidence,latitude:t.latitude,longitude:t.longitude};h.unshift(e)}m>0&&null!==e.prevStateIdx&&(p=e.prevStateIdx)}var g;return{nodes:h,totalCost:l,confidence:(g=s>0?l/s:l)===1/0?0:Math.exp(-g),hasGhostNodes:d.length>0,ghostPrefixes:d,originalPrefixes:t,usedObservationOverride:c}}function O(e){return{nodes:e.map(e=>({type:"ghost",prefix:e.toUpperCase()})),totalCost:1/0,confidence:0,hasGhostNodes:!0,ghostPrefixes:e.map(e=>e.toUpperCase()),originalPrefixes:e,usedObservationOverride:!1}}function N(e,t,n){if(!e.hasGhostNodes)return[];const o=[];for(let s=0;s<e.nodes.length;s++){const i=e.nodes[s];if("ghost"!==i.type)continue;let r=null,a=null;for(let t=s-1;t>=0;t--)if("known"===e.nodes[t].type){r=e.nodes[t];break}for(let t=s+1;t<e.nodes.length;t++)if("known"===e.nodes[t].type){a=e.nodes[t];break}o.push({prefix:i.prefix,beforeNodeHash:(null==r?void 0:r.hash)??null,afterNodeHash:(null==a?void 0:a.hash)??null,beforeLocation:void 0!==(null==r?void 0:r.latitude)&&void 0!==(null==r?void 0:r.longitude)?{lat:r.latitude,lon:r.longitude}:void 0,afterLocation:void 0!==(null==a?void 0:a.latitude)&&void 0!==(null==a?void 0:a.longitude)?{lat:a.latitude,lon:a.longitude}:void 0,timestamp:t,packetHash:n})}return o}function j(e){const t=new Map,n=new Map;for(const[o,s]of e)t.set(o,s.count),n.set(o,s.count>0?s.confidenceSum/s.count:0);return{edgeCounts:t,edgeConfidence:n}}const F=6048e5;function T(e,t){if(!e||e<=0)return.1;const n=(t-1e3*e)/36e5;return n<0?1:Math.exp(-n/168)}function U(e,t,n){const o=new Map,s=[];let i,r=1/0,a=0;for(const d of t)if(d.beforeNodeHash&&o.set(d.beforeNodeHash,(o.get(d.beforeNodeHash)??0)+1),d.afterNodeHash&&o.set(d.afterNodeHash,(o.get(d.afterNodeHash)??0)+1),r=Math.min(r,d.timestamp),a=Math.max(a,d.timestamp),d.beforeLocation&&d.afterLocation){const e=_(d.beforeLocation.lat,d.beforeLocation.lon,d.afterLocation.lat,d.afterLocation.lon);if(e>50)continue;const t=(d.beforeLocation.lat+d.afterLocation.lat)/2,o=(d.beforeLocation.lon+d.afterLocation.lon)/2,i=n-1e3*d.timestamp,r=i<F?1-i/F*.5:.5;s.push({lat:t,lon:o,weight:r,anchorDistanceKm:e})}if(s.length>0){const e=s.reduce((e,t)=>e+t.weight,0),t=s.reduce((e,t)=>e+t.lat*t.weight,0)/e,n=s.reduce((e,t)=>e+t.lon*t.weight,0)/e,o=s.map(e=>e.anchorDistanceKm).sort((e,t)=>e-t),r=1e3*o[Math.floor(o.length/2)]*.5,a=s.map(e=>_(t,n,e.lat,e.lon)),c=1e3*Math.max(...a),u=Math.sqrt(r**2+c**2),l=Math.min(Math.max(u,500),25e3);i={lat:t,lon:n,uncertaintyM:l}}const c=.2*t.length,u=new Set;for(const[d,p]of o)p>=c&&u.add(d);const l=function(e,t,n,o,s){const i=s-1e3*o;return Math.min(.4,e/30*.4)+Math.min(.3,t/4*.3)+(n<1/0?Math.max(0,.2*(1-n/1e4)):0)+(i<F?.1*(1-i/F):0)}(t.length,u.size,(null==i?void 0:i.uncertaintyM)??1/0,a,n),f=function(e,t,n,o,s,i){const r=e>=50,a=e>=200,c=t>=.5,u=t>=.7,l=n>=2,f=void 0!==o,h=f&&o.uncertaintyM<1e4,d=i-1e3*s<F,p={hasHighObservations:r,hasVeryHighObservations:a,hasGoodConfidence:c,hasHighConfidence:u,hasCommonNeighbors:l,hasLocation:f,hasGoodLocation:h,isRecent:d};if(a&&u)return{tier:"confirmed",reason:`${e} observations at ${(100*t).toFixed(0)}% confidence`,criteria:p};if(r&&u&&l&&h)return{tier:"confirmed",reason:"Strong multi-factor evidence with verified location",criteria:p};if(r&&c&&l)return{tier:"likely",reason:f?`${e} observations with ${n} common neighbors`:`${e} observations, ${n} neighbors (no location)`,criteria:p};if(e>=10&&c&&h)return{tier:"likely",reason:`Consistent location (±${(o.uncertaintyM/1e3).toFixed(1)}km)`,criteria:p};if(a&&c)return{tier:"likely",reason:`${e} observations suggests real node`,criteria:p};if(e>=10&&(c||l||f)){const e=[];return l||e.push("few neighbors"),f||e.push("no location"),c||e.push("low confidence"),d||e.push("stale"),{tier:"possible",reason:e.length>0?`Needs: ${e.join(", ")}`:"Moderate evidence",criteria:p}}return{tier:"noise",reason:e<10?`Only ${e} observations`:"Insufficient corroborating evidence",criteria:p}}(t.length,l,u.size,i,a,n),h="confirmed"===f.tier||"likely"===f.tier;return{prefix:e,observations:t,observationCount:t.length,estimatedLocation:i,confidence:l,commonNeighbors:u,firstSeen:r,lastSeen:a,isLikelyReal:h,classification:f}}function G(e,t){return`${t}:${e.join(">")}`}function q(e,t){return`${e}→${t}`}function I(e){const o=e.route??e.route_type;return t(o)?"flood":n(o)?"direct":"unknown"}function V(e,t){return e.toUpperCase()===(t.startsWith("0x")?t.slice(2,4).toUpperCase():t.slice(0,2).toUpperCase())}function z(e,t){return[e,t].sort().join("-")}function K(e){return e<=2?.4:e<=5?.6:e<=8?.8:e<=12?1:1.2}function W(e){return e<=5?0:e<=10?.2:.4}function B(e){return e>=.6?1:e<=0?0:e/.6}function Q(e,t,n){return t+(e-t)*n}function Z(e,t){let n=0;for(let o=0;o<e.length;o++)n+=e[o]*t[o];return n}function J(e){const t=function(e){return Math.sqrt(Z(e,e))}(e);if(t>0)for(let n=0;n<e.length;n++)e[n]/=t}function X(e,t){const n=Z(e,t);for(let o=0;o<e.length;o++)e[o]-=n*t[o]}function Y(e,t){const n=e.length,o=new Array(n).fill(0);for(let s=0;s<n;s++)for(let i=0;i<n;i++)o[s]+=e[s][i]*t[i];return o}function ee(e){const t=Math.exp(-e/30);return Math.max(.05,t)}function te(e,t){if(e.length<2)return 0;const n=[];for(const r of e){const e=t.get(r);e&&n.push(e)}if(n.length<2)return 0;const o=Math.min(n.length,20),s=n.length<=o?n:function(e,t){if(t>=e.length)return e;const n=[],o=e.length/t;for(let s=0;s<t;s++)n.push(e[Math.floor(s*o)]);return n}(n,o);let i=0;for(let r=0;r<s.length;r++)for(let e=r+1;e<s.length;e++){const t=a(s[r][0],s[r][1],s[e][0],s[e][1])/1e3;i=Math.max(i,t)}return i}function ne(e,t,n,o){const s=t.length;if(s<3)return null;const i=new Set(t),r=e.filter(e=>i.has(e.fromHash)&&i.has(e.toHash));if(0===r.length)return null;const c=function(e,t,n,o){const s=t.length,i=new Map(t.map((e,t)=>[e,t])),r=Array(s).fill(null).map(()=>Array(s).fill(0));for(const c of e){const e=i.get(c.fromHash),t=i.get(c.toHash);if(void 0!==e&&void 0!==t&&e!==t){const s=c.strength*c.certainCount;let i=1;if(n){const e=n.get(c.fromHash),t=n.get(c.toHash);e&&t&&(i=ee(a(e[0],e[1],t[0],t[1])/1e3))}let u=1;if(o){const e=[c.fromHash,c.toHash].sort().join("-");u=1-.7*(o.get(e)??0)}const l=.3+.7*(c.symmetryRatio??0),f=Math.pow(s,.7)*Math.pow(i,.3)*u*l;r[e][t]=f,r[t][e]=f}}return r}(r,t,n,o),u=function(e){const t=e.length,n=Array(t).fill(null).map(()=>Array(t).fill(0));for(let o=0;o<t;o++){let s=0;for(let i=0;i<t;i++)s+=e[o][i],n[o][i]=-e[o][i];n[o][o]=s}return n}(c),{vector:l,eigenvalue:f}=function(e){const t=e.length,n=Array(t).fill(1/Math.sqrt(t));let o=0;for(let a=0;a<t;a++){let n=0;for(let o=0;o<t;o++)n+=Math.abs(e[a][o]);o=Math.max(o,n)}const s=Array(t).fill(null).map(()=>Array(t).fill(0));for(let a=0;a<t;a++){for(let n=0;n<t;n++)s[a][n]=-e[a][n];s[a][a]=o+s[a][a]}let i=Array(t).fill(0).map((e,t)=>43758.5453*Math.sin(12.9898*t)%1-.5);X(i,n),J(i);let r=0;for(let a=0;a<100;a++){const e=Y(s,i);X(e,n);const t=Z(e,e)/Z(i,e);if(J(e),i=e,Math.abs(t-r)<1e-8)return{vector:i,eigenvalue:o-t};r=t}return{vector:i,eigenvalue:o-r}}(u);if(f<.001)return null;const h=[],d=[];for(let a=0;a<s;a++)l[a]<0?h.push(t[a]):d.push(t[a]);return h.length<5||d.length<5?null:{group0:h,group1:d,fiedlerValue:f}}function oe(e,t){if(e<=0)return"inactive";const n=t-e;return n<3600?"active":n<86400?"recent":n<604800?"stale":"inactive"}function se(e,t){if(e<=0)return 0;const n=(t-e)/3600;return n<0?1:Math.exp(-n/12)}function ie(e,t,n,o,s,i,r,a){return e===t?"local":n.includes(e)?"hub":o.includes(e)?"gateway":s.has(e)?"backbone":i.has(e)?"neighbor":r.includes(e)?"mobile":a.has(e)?"ghost":"standard"}function re(e,t,n,s,i,r,a,c,l,f,h,d,p,g,m,v){var y;const C=Math.floor(Date.now()/1e3),{communities:b,count:M}=function(e,t,n){const o=new Set;for(const c of e)o.add(c.fromHash),o.add(c.toHash);const s=Array.from(o);if(s.length<3){const e=new Map;for(const t of s)e.set(t,0);return{communities:e,count:1}}const i=new Map;for(const[c,l]of Object.entries(t))u(l.latitude,l.longitude)&&i.set(c,[l.latitude,l.longitude]);const r=function(e,t,n,o){const s=t.length;if(s<3)return{communities:new Map([[0,t]]),nodePartitions:t.map(e=>({hash:e,community:0,fiedlerValue:0})),numCommunities:1,fiedlerValue:0,isConnected:s<=1};const i=[];let r=1/0;const a=[[t,0]];for(;a.length>0;){const[t,s]=a.shift();if((n?te(t,n):0)>20&&s<4&&t.length>=10){const i=ne(e,t,n,o);if(i){r=Math.min(r,i.fiedlerValue),a.push([i.group0,s+1]),a.push([i.group1,s+1]);continue}}i.push(t)}const c=new Map,u=[],l=new Map;for(let f=0;f<i.length;f++){c.set(f,i[f]);for(const e of i[f])l.set(e,f)}for(const f of t)u.push({hash:f,community:l.get(f)??0,fiedlerValue:0});return{communities:c,nodePartitions:u,numCommunities:i.length,fiedlerValue:r===1/0?0:r,isConnected:!0}}(e,s,i.size>0?i:void 0,n),a=new Map;for(const c of r.nodePartitions)a.set(c.hash,c.community);return{communities:a,count:r.numCommunities}}(e,d,v),S=function(e,t){const n=new Set;for(const o of e){const e=t.get(o);e&&(n.add(e.fromHash),n.add(e.toHash))}return n}(r,t),w=function(e,t){const n=new Set;for(const o of e){const e=t.get(o);e&&(n.add(e.fromHash),n.add(e.toHash))}return n}(a,t),k=new Set;for(const o of h)o.isLikelyReal&&k.add(o.prefix);const x=new Set,H=new Map,_=new Map,P=new Map;for(const o of e){_.set(o.fromHash,(_.get(o.fromHash)??0)+1),H.set(o.toHash,(H.get(o.toHash)??0)+1);const e=P.get(o.fromHash)??0,t=P.get(o.toHash)??0;P.set(o.fromHash,e+o.packetCount),P.set(o.toHash,t+o.packetCount)}const L=new Set;for(const o of e)L.add(o.fromHash),L.add(o.toHash);p&&L.add(p);const E=new Map;for(const o of f.paths){const e=new Set;for(const t of o.hops)e.add(t);for(const t of e)E.set(t,(E.get(t)??0)+1)}const R=new Map;for(const u of L){const e=o(u),t=d[u],r=l.get(u),a=(null==g?void 0:g.has(u))??!1,f=null==m?void 0:m.get(e),h=(null==f?void 0:f.confidence)??1,v=!!f&&!f.isUnambiguous,M=(null==(y=null==f?void 0:f.candidates)?void 0:y.length)??1,k=H.get(u)??0,L=_.get(u)??0,A=k+L,$=(null==t?void 0:t.last_seen)??(null==r?void 0:r.lastSeen)??0,D=E.get(e)??0,O=ie(u,p,s,i,S,g??new Set,c,x),N={hash:u,prefix:e,name:(null==t?void 0:t.name)??(null==t?void 0:t.node_name)??null,nodeClass:O,communityId:b.get(u)??0,degree:A,inDegree:k,outDegree:L,betweenness:n.get(u)??0,pathDiversity:D,packetCount:P.get(u)??0,lastSeen:$,activityLevel:oe($,C),recencyScore:se($,C),avgRssi:(null==t?void 0:t.rssi)??null,avgSnr:(null==t?void 0:t.snr)??null,isZeroHop:a,prefixConfidence:h,hasCollision:v,collisionCandidates:M,traceSnrAggregate:null,traceEdgeCoverage:0,traceReliability:"unknown",isLocal:u===p,isHub:s.includes(u),isGateway:i.includes(u),isBackbone:S.has(u),isMobile:c.includes(u),isGhost:x.has(u),isInLoop:w.has(u),latitude:(null==t?void 0:t.latitude)??null,longitude:(null==t?void 0:t.longitude)??null,contactType:(null==t?void 0:t.contact_type)??null};R.set(u,N)}return{nodeMetrics:R,communityCount:M,backboneNodes:Array.from(S)}}function ae(e,t){return(e[t]|e[t+1]<<8|e[t+2]<<16|e[t+3]<<24)>>>0}const ce={5:-2.5,6:-5,7:-7.5,8:-10,9:-12.5,10:-15,11:-17.5,12:-20};function ue(e,t){const n=function(e){const t=Math.max(5,Math.min(12,Math.round(e)));return ce[t]??ce[7]}(t??7),o=e-n;return o>=6?"excellent":o>=3?"good":o>=0?"fair":o>=-3?"poor":"critical"}function le(e){const t=e.length;if(0===t)return{mean:0,median:0,min:0,max:0,stdDev:0,count:0};const n=e.reduce((e,t)=>e+t,0)/t,o=Math.min(...e),s=Math.max(...e),i=e.reduce((e,t)=>e+(t-n)**2,0)/t,r=Math.sqrt(i),a=[...e].sort((e,t)=>e-t),c=t%2==1?a[Math.floor(t/2)]:(a[t/2-1]+a[t/2])/2;return{mean:n,median:c,min:o,max:s,stdDev:r,count:t}}function fe(e,t){return`${e}>${t}`}function he(e){if(!e.payload){const t=e._traceTag,n=e._tracePathHashes,o=e._traceSnrPath;if(!t||!n||0===n.length||!o||0===o.length)return null;const s=[];for(const e of o){let t=e;t>127&&(t-=256),s.push(t/4)}return{traceTag:t,pathHashes:n,snrValues:s,timestamp:e.timestamp??0,srcHash:e.src_hash}}try{const t=function(e){const t=e.replace(/^0x/i,"").replace(/\s/g,"");if(t.length%2!=0)throw new Error("Invalid hex string: odd number of characters");const n=new Uint8Array(t.length/2);for(let o=0;o<n.length;o++){const e=parseInt(t.substr(2*o,2),16);if(isNaN(e))throw new Error("Invalid hex character at position "+2*o);n[o]=e}return n}(e.payload),n=function(e){if(null!=e._traceSnrPath&&e._traceSnrPath.length>0)return e._traceSnrPath;const t=e.original_path||e.forwarded_path||[];if("string"==typeof t)try{const e=JSON.parse(t);if(Array.isArray(e))return e.map(e=>parseInt(e,16))}catch{return[]}else if(Array.isArray(t))return t.map(e=>parseInt(String(e),16));return[]}(e),o=function(e,t){const n=function(e){if(e.length<9)return{type:"trace",traceTag:"00000000",traceTagValue:0,authCode:0,flags:0,pathHashes:[],pathString:"",snrValues:[],isComplete:!1,path:[],targetHash:""};const t=ae(e,0),n=t.toString(16).toUpperCase().padStart(8,"0"),o=ae(e,4),s=e[8],i=e.slice(9),r=Array.from(i).map(e=>function(e,t=!0){const n=(255&e).toString(16).padStart(2,"0");return t?n.toUpperCase():n}(e,!0)),a=r.join("->");return{type:"trace",traceTag:n,traceTagValue:t,authCode:o,flags:s,pathHashes:r,pathString:a,snrValues:[],isComplete:!1,path:r,targetHash:r.length>0?r[0]:""}}(e);if(!n)return null;const o=[],s=t instanceof Uint8Array?Array.from(t):t;for(let r=0;r<s.length;r++){let e=s[r];e>127&&(e-=256),o.push(e/4)}const i=o.length>=n.pathHashes.length;return{...n,snrValues:o,isComplete:i}}(t,n);return o&&0!==o.pathHashes.length&&0!==o.snrValues.length?{traceTag:o.traceTag,pathHashes:o.pathHashes,snrValues:o.snrValues,timestamp:e.timestamp??0,srcHash:e.src_hash}:null}catch{return null}}function de(e,t,n,o,s,i,r,a){const c=e.toUpperCase();if(a){const e=a.get(c);if(e&&e.observationCount>=3&&e.confidence>=.7)return{hash:e.hash,confidence:e.confidence}}if(r){const e=r.confirmedResolutions.get(c);if(e&&e.observationCount>=3&&e.confidence>=.7)return{hash:e.hash,confidence:e.confidence}}if(t){const e=null==s?void 0:s.get(c);if(e)return{hash:e,confidence:.8};if(i){const e=d(i,c,{position:n,adjacentPrefixes:o});if(e.hash)return{hash:e.hash,confidence:e.confidence}}}else{if(i){const e=d(i,c,{position:n,adjacentPrefixes:o});if(e.hash)return{hash:e.hash,confidence:e.confidence}}const e=null==s?void 0:s.get(c);if(e)return{hash:e,confidence:.6}}return{hash:`~${c}`,confidence:0}}function pe(e,t,n,o,s){const i=e.get(t);i?i.hash===n?(i.observationCount++,i.avgSnrEvidence=(i.avgSnrEvidence*(i.observationCount-1)+s)/i.observationCount,i.confidence=Math.max(i.confidence,o)):o>i.confidence&&e.set(t,{hash:n,confidence:o,observationCount:1,avgSnrEvidence:s}):e.set(t,{hash:n,confidence:o,observationCount:1,avgSnrEvidence:s})}function ge(e,t,n){if(0===e.length)return 0;if(t.length!==e.length)return e.reduce((e,t)=>e+t,0)/e.length;let o=0,s=0;for(let i=0;i<e.length;i++){const r=Math.max(0,n-t[i]),a=Math.exp(-r*Math.LN2/43200);o+=e[i]*a,s+=a}return s>0?o/s:e.reduce((e,t)=>e+t,0)/e.length}function me(e){if(e.length<4)return"insufficient";const t=Math.floor(e.length/2),n=e.slice(0,t).reduce((e,t)=>e+t,0)/t,o=e.slice(t).reduce((e,t)=>e+t,0)/(e.length-t)-n;return o>1.5?"improving":o<-1.5?"degrading":"stable"}function ve(e,t,n,s){const i=`${e}>${t}`,r=`${t}>${e}`;let a=n.get(i),c=n.get(r);if(!a&&!c){const s=o(e),i=o(t),r=fe(s,i),u=fe(i,s);a=n.get(r),c=n.get(u)}if(!a&&!c)return null;const u=(null==a?void 0:a.snr)??null,l=(null==c?void 0:c.snr)??null;let f=null;f=u&&l?function(e,t){const n=e.count+t.count;if(0===n)return{mean:0,median:0,min:0,max:0,stdDev:0,count:0};const o=(e.mean*e.count+t.mean*t.count)/n,s=(e.median*e.count+t.median*t.count)/n,i=Math.min(e.min,t.min),r=Math.max(e.max,t.max),a=e.stdDev**2,c=t.stdDev**2,u=(e.count*(a+(e.mean-o)**2)+t.count*(c+(t.mean-o)**2))/n;return{mean:o,median:s,min:i,max:r,stdDev:Math.sqrt(u),count:n}}(u,l):u??l;const h=u&&l?Math.abs(u.mean-l.mean):null;let d="unknown";return u&&l?d=ue(Math.min(u.mean,l.mean),s):u?d=ue(u.mean,s):l&&(d=ue(l.mean,s)),{forward:u,reverse:l,composite:f,asymmetryDb:h,quality:d}}function ye(e,t,n,o,s,i={}){const{windowHours:r}=i,a=function(e,t){const n=t instanceof Map?{prefixToHash:t}:t??{},{prefixToHash:o,prefixLookup:s,srcHashResolver:i,windowHours:r,previousTraceEvidence:a}=n;let c=o;if(!c&&s){c=new Map;for(const[e,t]of s)t.bestMatch&&c.set(e,t.bestMatch)}const u=!(!s&&!i),l=[];let f=0;for(const b of e){if(9!==(b.type??b.payload_type))continue;const e=b.timestamp??0;e>f&&(f=e);const t=he(b);t&&l.push(t)}let h=l;if(null!=r&&r>0&&f>0){const e=f-3600*r;h=l.filter(t=>t.timestamp>=e)}const d={confirmedResolutions:new Map,confirmedLinks:[]};if(0===h.length)return{traceLinks:new Map,feedback:d};const p=new Map;for(const b of h){const e=p.get(b.traceTag);(!e||b.snrValues.length>e.snrValues.length)&&p.set(b.traceTag,b)}const g=new Map,m=new Map,v=[...p.values()].sort((e,t)=>e.timestamp-t.timestamp);for(const b of v){const{pathHashes:e,snrValues:t,traceTag:n,timestamp:o,srcHash:r}=b,l=[];for(let h=0;h<e.length;h++){const t=e[h].toUpperCase(),n=0===h&&!!r,o=[];if(h>0&&o.push(e[h-1].toUpperCase()),h<e.length-1&&o.push(e[h+1].toUpperCase()),u){const r=de(t,n,e.length-h,o,i,s,a,m);l.push({prefix:t,...r})}else{const e=(null==c?void 0:c.get(t))??`~${t}`;l.push({prefix:t,hash:e,confidence:e.startsWith("~")?0:.5})}}let f=null;if(r){const t=r.replace(/^0x/i,"").slice(0,2).toUpperCase();if(u){const n=e.length>0?[e[0].toUpperCase()]:[];f={prefix:t,...de(t,!0,e.length+1,n,i,s,a,m)}}else if(r.replace(/^0x/i,"").length>=8)f={prefix:t,hash:r,confidence:1};else{const e=(null==c?void 0:c.get(t))??`~${t}`;f={prefix:t,hash:e,confidence:e.startsWith("~")?0:.5}}}for(let s=0;s<t.length&&s<l.length;s++){const e=l[s];let i;if(0===s){if(!f)continue;i=f}else i=l[s-1];if(i.prefix===e.prefix)continue;const r=`${i.hash}>${e.hash}`;let a=g.get(r);a||(a={fromPrefix:i.prefix,toPrefix:e.prefix,fromHash:i.hash,toHash:e.hash,snrValues:[],timestamps:[],traceTags:new Set,lastSeen:0},g.set(r,a)),a.snrValues.push(t[s]),a.timestamps.push(o),a.traceTags.add(n),a.lastSeen=Math.max(a.lastSeen,o)}f&&f.confidence>=.7&&!f.hash.startsWith("~")&&pe(m,f.prefix,f.hash,f.confidence,t[0]??0);for(let s=0;s<l.length;s++){const e=l[s];if(e.confidence>=.7&&!e.hash.startsWith("~")){const n=s<t.length?t[s]:0;pe(m,e.prefix,e.hash,e.confidence,n)}}}const y=new Map;for(const[b,M]of g){if(0===M.snrValues.length)continue;const e=le(M.snrValues),t=M.fromHash.startsWith("~"),o=M.toHash.startsWith("~"),s=t||o?null:z(M.fromHash,M.toHash),i=ge(M.snrValues,M.timestamps,M.lastSeen),r=me(M.snrValues),a=`${M.toHash}>${M.fromHash}`,c=g.has(a),u=M.lastSeen>0?Math.exp(-(f-M.lastSeen)/43200):.5,l=Math.min(1,e.count/10)*u*(c?1:.7);y.set(b,{fromPrefix:M.fromPrefix,toPrefix:M.toPrefix,fromHash:M.fromHash,toHash:M.toHash,directedKey:b,edgeKey:s,snr:e,uniqueTraceCount:M.traceTags.size,quality:ue(e.mean,n.spreadingFactor),lastSeen:M.lastSeen,confidence:l,recencyWeightedSnr:i,trend:r})}const C=function(e,t){const n=[];for(const o of t.values())!o.fromHash.startsWith("~")&&!o.toHash.startsWith("~")&&o.confidence>=.5&&n.push({fromHash:o.fromHash,toHash:o.toHash,avgSnr:o.snr.mean,count:o.snr.count});return{confirmedResolutions:new Map(e),confirmedLinks:n}}(m,y);return{traceLinks:y,feedback:C}}(e,i),c=a.traceLinks,u=a.feedback;if(c.size>0){const e=i.spreadingFactor;for(const n of t){const t=ve(n.fromHash,n.toHash,c,e);t&&(n.traceQuality=t)}}const l=function(e,t=null){const n={improving:0,stable:0,degrading:0,insufficient:0},o={excellent:0,good:0,fair:0,poor:0,critical:0};if(0===e.size)return{totalDirectedLinks:0,totalTraces:0,totalObservations:0,bidirectionalLinks:0,meanSnr:0,medianSnr:0,avgConfidence:0,trendCounts:n,qualityCounts:o,windowHours:t};let s=0,i=0,r=0;const a=[],c={...o},u={...n},l=new Set;for(const v of e.values())s+=v.snr.count,i+=v.snr.mean*v.snr.count,a.push(v.snr.mean),r+=v.confidence,c[v.quality]++,u[v.trend]++,l.add(v.directedKey);let f=0;const h=new Set;for(const v of e.values()){const e=fe(v.toPrefix,v.fromPrefix);l.has(e)&&!h.has(v.directedKey)&&(f++,h.add(v.directedKey),h.add(e))}let d=0;for(const v of e.values())d+=v.uniqueTraceCount;d=Math.ceil(d/2);const p=s>0?i/s:0,g=[...a].sort((e,t)=>e-t),m=g.length%2==1?g[Math.floor(g.length/2)]:g.length>0?(g[g.length/2-1]+g[g.length/2])/2:0;return{totalDirectedLinks:e.size,totalTraces:d,totalObservations:s,bidirectionalLinks:f,meanSnr:p,medianSnr:m,avgConfidence:e.size>0?r/e.size:0,trendCounts:u,qualityCounts:c,windowHours:t}}(c,r);var f,h;return function(e,t,n){var o;if(0!==e.size)for(const s of t){if(!s.weakestLinkKey)continue;const e=n.get(s.weakestLinkKey);(null==(o=null==e?void 0:e.traceQuality)?void 0:o.composite)&&(s.weakestLinkTraceSnr=e.traceQuality.composite.mean)}}(c,o,n),function(e,t,n){var o,s;if(0!==e.size)for(const[i,r]of n){let e=0,n=0,a=0,c=0;for(const s of t)s.fromHash!==i&&s.toHash!==i||(a++,(null==(o=s.traceQuality)?void 0:o.composite)&&(e+=s.traceQuality.composite.mean,n++,c++));if(n>0){const o=[];for(const e of t)e.fromHash!==i&&e.toHash!==i||(null==(s=e.traceQuality)?void 0:s.composite)&&o.push(e.traceQuality.composite.mean);if(o.length>0){const e=o.reduce((e,t)=>e+t,0)/o.length,t=Math.min(...o),n=Math.max(...o),s=[...o].sort((e,t)=>e-t),i=s.length%2==1?s[Math.floor(s.length/2)]:(s[s.length/2-1]+s[s.length/2])/2,a=o.reduce((t,n)=>t+(n-e)**2,0)/o.length;r.traceSnrAggregate={mean:e,median:i,min:t,max:n,stdDev:Math.sqrt(a),count:o.length}}r.traceEdgeCoverage=a>0?c/a:0;const u=e/n;r.traceReliability=u>=5?"high":u>=0?"medium":"low"}}}(c,t,s),{traceLinks:c,traceLinkSummary:l,traceDisambiguationFeedback:u,tokens:(f=l,h=u,[{fn:"traceLinks.directed",value:String(f.totalDirectedLinks),group:"worker",color:"teal"},{fn:"traceLinks.bidir",value:String(f.bidirectionalLinks),group:"worker",color:"teal"},{fn:"traceSummary.meanSnr",value:`${f.meanSnr.toFixed(1)} dB`,group:"analysis",color:f.meanSnr>=5?"green":f.meanSnr>=0?"amber":"red"},{fn:"traceSummary.medianSnr",value:`${f.medianSnr.toFixed(1)} dB`,group:"analysis",color:"zinc"},{fn:"traceSummary.confidence",value:`${(100*f.avgConfidence).toFixed(0)}%`,group:"analysis",color:"zinc"},{fn:"feedback.confirmed",value:String(h.confirmedResolutions.size),group:"worker",color:"teal"},{fn:"feedback.links",value:String(h.confirmedLinks.length),group:"worker",color:"teal"}])}}function Ce(u,p,v,y=.4,C,b,M,S,w,k,H,_,P,L){const E=[...u].sort((e,t)=>(e.timestamp??0)-(t.timestamp??0)),R=new Map;for(const e of E){if(!e.packet_hash)continue;const t=R.get(e.packet_hash);t?t.push(e):R.set(e.packet_hash,[e])}let A=0,$=0,O=0;const F=new Map;for(const[,e]of R){if(e.length<2)continue;A++;const t=new Map,n=new Set;for(const o of e){const e=o.original_path??o.forwarded_path;if(!e||!Array.isArray(e)||0===e.length)continue;const s=e.map(e=>String(e).toUpperCase()).join("-");t.has(s)||(t.set(s,e.map(e=>String(e).toUpperCase())),$++);const i=String(e[e.length-1]).toUpperCase();n.add(i)}if(n.size>=2){const e=Array.from(n);for(let t=0;t<e.length;t++)for(let n=t+1;n<e.length;n++){const o=e[t]<e[n]?`${e[t]}-${e[n]}`:`${e[n]}-${e[t]}`,s=F.get(o);s?(s.count++,s.confidence=Math.min(.95,s.confidence+.05)):F.set(o,{count:1,confidence:.6})}}}const Z=function(e,t,n,r,c){const u=new Map,d=function(e){const t={};for(const[n,o]of Object.entries(e))l(o)&&(t[n]=o);return t}(t),p=new Map,g=void 0!==r&&void 0!==c&&(0!==r||0!==c);if(n){const e=o(n),t={hash:n,prefix:e,positionCounts:new Array(5).fill(0),totalAppearances:0,typicalPosition:0,positionConsistency:0,adjacentPrefixCounts:new Map,totalAdjacentObservations:0,latitude:r,longitude:c,distanceToLocal:0,srcGeoEvidenceScore:0,srcGeoEvidenceCount:0,lastSeenTimestamp:Math.floor(Date.now()/1e3),recencyScore:1,positionScore:0,cooccurrenceScore:0,geographicScore:1,combinedScore:0};p.set(e,[t])}for(const[s,i]of Object.entries(d)){const e=o(s),t=i.last_seen??0;if(h(t))continue;let n;const u=!0===i.zero_hop;g&&i.latitude&&i.longitude&&(0!==i.latitude||0!==i.longitude)&&(n=a(r,c,i.latitude,i.longitude));let l=.2;void 0!==n?l=n<500?1:n<2e3?.8:n<5e3?.6:n<1e4?.4:n<2e4?.2:.1:i.latitude&&i.longitude&&(l=.5);const d=f(t);if(u&&d>.01){const e=t>0?(Math.floor(Date.now()/1e3)-t)/3600:1/0,n=Math.exp(-e/72);l=Math.max(l,.95*n)}const m={hash:s,prefix:e,name:i.name||i.node_name,positionCounts:new Array(5).fill(0),totalAppearances:0,typicalPosition:0,positionConsistency:0,adjacentPrefixCounts:new Map,totalAdjacentObservations:0,latitude:i.latitude,longitude:i.longitude,distanceToLocal:n,srcGeoEvidenceScore:0,srcGeoEvidenceCount:0,lastSeenTimestamp:t,recencyScore:d,positionScore:0,cooccurrenceScore:0,geographicScore:l,combinedScore:0},v=p.get(e)||[];v.push(m),p.set(e,v)}for(const o of e){const e=s(o,n);if(!e||0===e.effectiveLength)continue;const r=e.effective,c=o.src_hash,u=c?t[c]:void 0,l=(null==u?void 0:u.latitude)&&(null==u?void 0:u.longitude)&&(0!==u.latitude||0!==u.longitude);for(let t=0;t<r.length;t++){const n=r[t],o=p.get(n);if(!o)continue;const s=i(t,e.effectiveLength),c=Math.min(s-1,4);for(const e of o){if(e.positionCounts[c]++,e.totalAppearances++,1===s&&o.length>1&&l&&e.latitude&&e.longitude){const t=a(u.latitude,u.longitude,e.latitude,e.longitude);let n=0;n=t<500?1:t<2e3?.8:t<5e3?.5:t<1e4?.3:.1,void 0!==e.distanceToLocal&&(e.distanceToLocal<500?n*=1.2:e.distanceToLocal<2e3?n*=1:n*=.8),e.srcGeoEvidenceScore+=n,e.srcGeoEvidenceCount++}if(t>0&&o.length>1&&e.latitude&&e.longitude){const n=r[t-1],o=p.get(n);if(o&&o.length>0){let t,n,s=0;if(1===o.length){const e=o[0];e.latitude&&e.longitude&&(t=e.latitude,n=e.longitude,s=1)}else{const e=[...o].sort((e,t)=>t.combinedScore-e.combinedScore),i=e[0],r=e[1];if(i.latitude&&i.longitude&&i.combinedScore>0){const e=r?(i.combinedScore-r.combinedScore)/i.combinedScore:1;s=Math.min(1,e+.3),s>.4&&(t=i.latitude,n=i.longitude)}}if(void 0!==t&&void 0!==n){const o=a(e.latitude,e.longitude,t,n);let i=0;i=o<500?1:o<2e3?.8:o<5e3?.5:o<1e4?.3:.1,i*=s,e.srcGeoEvidenceScore+=i,e.srcGeoEvidenceCount++}}}if(s>1&&o.length>1&&e.latitude&&e.longitude){const n=t+1;if(n<r.length){const t=r[n],o=p.get(t);if(o&&o.length>0){let t,n,s=0;if(1===o.length){const e=o[0];e.latitude&&e.longitude&&(t=e.latitude,n=e.longitude,s=1)}else{const e=[...o].sort((e,t)=>t.combinedScore-e.combinedScore),i=e[0],r=e[1];if(i.latitude&&i.longitude&&i.combinedScore>0){const e=r?(i.combinedScore-r.combinedScore)/i.combinedScore:1;s=Math.min(1,e+.3),s>.4&&(t=i.latitude,n=i.longitude)}}if(void 0!==t&&void 0!==n){const o=a(e.latitude,e.longitude,t,n);let i=0;i=o<500?1:o<2e3?.8:o<5e3?.5:o<1e4?.3:.1,i*=s,e.srcGeoEvidenceScore+=i,e.srcGeoEvidenceCount++}}}}if(t>0){const n=r[t-1];e.adjacentPrefixCounts.set(n,(e.adjacentPrefixCounts.get(n)||0)+1),e.totalAdjacentObservations++}if(t<r.length-1){const n=r[t+1];e.adjacentPrefixCounts.set(n,(e.adjacentPrefixCounts.get(n)||0)+1),e.totalAdjacentObservations++}}}}let m=1,v=1;for(const o of p.values())for(const e of o)m=Math.max(m,e.totalAppearances),v=Math.max(v,e.totalAdjacentObservations);for(const o of p.values())for(const e of o){if(e.totalAppearances>0){let t=0,n=1;for(let s=0;s<5;s++)e.positionCounts[s]>t&&(t=e.positionCounts[s],n=s+1);e.typicalPosition=n,e.positionConsistency=t/e.totalAppearances;const o=e.totalAppearances/m;e.positionScore=.6*e.positionConsistency+.4*o}if(e.totalAdjacentObservations>0&&(e.cooccurrenceScore=e.totalAdjacentObservations/v),e.combinedScore=.15*e.positionScore+.15*e.cooccurrenceScore+.35*e.geographicScore+.35*e.recencyScore,e.srcGeoEvidenceCount>0){const t=e.srcGeoEvidenceScore/e.srcGeoEvidenceCount*Math.min(e.srcGeoEvidenceCount/50,1)*.3;e.combinedScore+=t}}for(const[o,s]of p){s.sort((e,t)=>t.combinedScore-e.combinedScore);const e=s.length>0?s[0].hash:null;let t=0;if(1===s.length)t=1;else if(s.length>1){const e=s[0].combinedScore,n=s[1].combinedScore;e>0&&(t=Math.min(1,(e-n)/e)),s[0].totalAppearances>2*s[1].totalAppearances&&(t=Math.min(1,t+.2));const o=0,i=s[0].positionCounts[o]||0,r=i+(s[1].positionCounts[o]||0);if(r>=20&&i>=10){const e=i/r;if(e>=.8){const n=.3+1.5*(e-.8);t=Math.min(1,t+n)}}const a=s.reduce((e,t)=>e+t.combinedScore,0);if(a>0){const e=[],n=s.reduce((e,t)=>e+(t.positionCounts[0]||0),0);for(const t of s){const o=n*(t.combinedScore/a);e.push(o)}const o=e[0],i=o+(e[1]||0);if(i>=20&&o>=10){const e=o/i;if(e>=.6){const n=.2+1*(e-.6);t=Math.min(1,t+n)}}}const c=s[0].srcGeoEvidenceScore,u=s[1].srcGeoEvidenceScore;if(s[0].srcGeoEvidenceCount>=10&&c>1.5*u){const e=u>0?c/(c+u):1,n=Math.min(.3,.6*(e-.5));t=Math.min(1,t+n)}}const n=new Map;for(let o=1;o<=5;o++){const e=[...s].sort((e,t)=>{const n=e.positionCounts[o-1]||0;return(t.positionCounts[o-1]||0)-n});if(e.length>0&&e[0].positionCounts[o-1]>0){const t=e[0];let s=1;if(e.length>1){const n=t.positionCounts[o-1],i=n+(e[1].positionCounts[o-1]||0);s=i>0?n/i:0}n.set(o,{hash:t.hash,confidence:s})}}const i={prefix:o,candidates:s,bestMatch:e,confidence:t,isUnambiguous:1===s.length,bestMatchForPosition:n};u.set(o,i)}return u}(E,p,v,C,b),J=function(e,t,n,o,r,u){const l=new Map,f=void 0!==n&&void 0!==o&&(0!==n||0!==o);for(const[s,i]of Object.entries(t)){let e=null,t=.5;f&&i.latitude&&i.longitude&&(0!==i.latitude||0!==i.longitude)&&(e=a(n,o,i.latitude,i.longitude),t=c(e)),i.zero_hop&&(t=Math.max(t,.9)),l.set(s,{hash:s,frequency:0,directForwardCount:0,distanceMeters:e,proximityScore:t,hopPositionCounts:[0,0,0,0,0],avgHopDistance:0,typicalHopPosition:0,hopConsistencyScore:0,frequencyScore:0,combinedScore:0,avgDisambiguationConfidence:0,collisionCount:0,resolutionCount:0})}const h=new Map;for(const a of e){const e=s(a,r);if(e&&e.effectiveLength>=1){const t=e.effective;for(let n=0;n<t.length;n++){const o=t[n],s=i(n,e.effectiveLength);if(u){const e=d(u,o,{position:s,adjacentPrefixes:[...n>0?[t[n-1]]:[],...n<t.length-1?[t[n+1]]:[]],isLastHop:1===s});if(e.hash){const t=l.get(e.hash);if(t){t.frequency++,t.resolutionCount++;const n=h.get(e.hash)||0;h.set(e.hash,n+e.confidence);const i=u.get(o.toUpperCase());i&&!i.isUnambiguous&&t.collisionCount++;const r=Math.min(s-1,4);t.hopPositionCounts[r]++,1===s&&t.directForwardCount++}}}else for(const[e,t]of l)if(V(o,e)){t.frequency++;const e=Math.min(s-1,4);t.hopPositionCounts[e]++,1===s&&t.directForwardCount++}}}if((!e||0===e.effectiveLength)&&a.src_hash){const e=l.get(a.src_hash);if(e){e.frequency++,e.directForwardCount++,e.hopPositionCounts[0]++,e.resolutionCount++;const t=h.get(a.src_hash)||0;h.set(a.src_hash,t+1)}}}let p=0;for(const s of l.values())p=Math.max(p,s.frequency);for(const s of l.values()){let e=0,t=0,n=0,o=1;for(let r=0;r<s.hopPositionCounts.length;r++){const i=s.hopPositionCounts[r],a=r+1;e+=i,t+=i*a,i>n&&(n=i,o=a)}s.avgHopDistance=e>0?t/e:0,s.typicalHopPosition=o,e>0&&n>0&&(s.hopConsistencyScore=n/e),s.frequencyScore=p>0?s.frequency/p:0;const i=h.get(s.hash)||0;s.avgDisambiguationConfidence=s.resolutionCount>0?i/s.resolutionCount:0,s.combinedScore=.3*s.proximityScore+.3*s.hopConsistencyScore+.4*s.frequencyScore}return l}(E,p,C,b,v,Z),X=v?o(v):null,Y=new Map;for(const[e,t]of J)Y.set(e,t.combinedScore);const ee=new Map,te=k??void 0!==w?new x:void 0,ne=new Map,oe=new Map,se=new Map,ie=new Map,ae=Math.floor(Date.now()/1e3),ce=(e,o,s,i,r,a,c,u,l)=>{const f=z(e,o),h=ee.get(f),[d,p]=e<o?[e,o]:[o,e],g=e===d,m=t(a)||void 0===a,v=n(a),y=(e=>{if(!e||e<=0)return.1;const t=(ae-e)/3600;return t<0?1:Math.exp(-t/12)})(c);if(h)h.count++,h.confidenceSum+=s,h.recencySum+=y,h.minHopDistance=Math.min(h.minHopDistance,r),r<h.hopDistanceCounts.length&&h.hopDistanceCounts[r]++,i?h.certainCount++:h.uncertainCount++,l||(g?h.forwardCount++:h.reverseCount++),m?h.floodCount++:v&&h.directCount++,void 0!==u&&u>0&&(h.viterbiConfidenceSum+=u,h.viterbiObservationCount++);else{const e=[0,0,0,0,0,0,0,0,0,0];r<e.length&&e[r]++,ee.set(f,{fromHash:d,toHash:p,key:f,count:1,confidenceSum:s,minHopDistance:r,hopDistanceCounts:e,certainCount:i?1:0,uncertainCount:i?0:1,forwardCount:!l&&g?1:0,reverseCount:l||g?0:1,floodCount:m?1:0,directCount:v?1:0,recencySum:y,viterbiConfidenceSum:u??0,viterbiObservationCount:void 0!==u&&u>0?1:0})}},ue=function(e){const t=new Map;for(const[n,o]of e){const e=o.candidates.map(e=>({hash:e.hash,prefix:e.prefix,latitude:e.latitude,longitude:e.longitude,confidence:e.combinedScore,recencyScore:e.recencyScore}));t.set(n,e)}return t}(Z),le=[];let fe=0,he=0,de=0,pe=0;const ge=new Set,me=new Map;let ve=0,Ce=0,be=0;for(const t of E){const n=s(t,v);if(!n)continue;const o=n.effective,a=n.effectiveLength,c=n.original,u=new Set;if(t.src_hash&&c.length>=1){const e=c[0],n=t.src_hash.toUpperCase();if(n!==e){const o=d(Z,n,{position:a+1,adjacentPrefixes:[e]}),s=d(Z,e,{position:a,adjacentPrefixes:[n,...c.length>1?[c[1]]:[]]});if(o.hash&&s.hash&&o.hash!==s.hash){const e=Object.keys(p).includes(o.hash),n=o.confidence*s.confidence,i=n>=.6&&e,r=n*(e?1:.8),c=a+1,l=t.route??t.route_type;ce(o.hash,s.hash,r,i,c,l,t.timestamp,void 0,t.is_duplicate),u.add(o.hash),u.add(s.hash)}}}const l=4===(t.type??t.payload_type);if(l&&0===a&&t.src_hash&&v){const e=d(Z,t.src_hash.toUpperCase(),{position:1,isLastHop:!0});if(e.hash&&e.hash!==v){const n=t.route??t.route_type;ce(e.hash,v,1,!0,0,n,t.timestamp,void 0,t.is_duplicate),u.add(e.hash),u.add(v),se.set(e.hash,(se.get(e.hash)||0)+1)}}if(v&&a>=1){const e=a-1,n=o[e];if(l){const e=ie.get(n);e?(e.count++,"number"!=typeof t.rssi||isNaN(t.rssi)||(e.rssiSum+=t.rssi,e.rssiCount++),"number"!=typeof t.snr||isNaN(t.snr)||(e.snrSum+=t.snr,e.snrCount++),e.lastSeen=Math.max(e.lastSeen,t.timestamp??0)):ie.set(n,{prefix:n,count:1,rssiSum:"number"!=typeof t.rssi||isNaN(t.rssi)?0:t.rssi,rssiCount:"number"!=typeof t.rssi||isNaN(t.rssi)?0:1,snrSum:"number"!=typeof t.snr||isNaN(t.snr)?0:t.snr,snrCount:"number"!=typeof t.snr||isNaN(t.snr)?0:1,lastSeen:t.timestamp??0,resolvedHashes:new Map})}const s=d(Z,n,{position:1,adjacentPrefixes:e>0?[o[e-1]]:[],isLastHop:!0});if(l&&s.hash){const e=ie.get(n);if(e){const t=e.resolvedHashes.get(s.hash);t?(t.count++,t.confidenceSum+=s.confidence):e.resolvedHashes.set(s.hash,{count:1,confidenceSum:s.confidence})}}if(s.hash&&s.hash!==v){const e=!0,n=s.confidence,o=t.route??t.route_type;ce(s.hash,v,n,e,0,o,t.timestamp,void 0,t.is_duplicate),u.add(s.hash),u.add(v),se.set(s.hash,(se.get(s.hash)||0)+1)}}if(a>=2){const n=D(ue,o,{edgeHistory:j(ee),observationOverrideThreshold:.8,enableGhostNodes:!0,minEdgeObservationsForHistory:3,terrainGrid:w,feasibilityCache:te,enableTerrainAware:k??void 0!==w}),s=t.packet_hash,c=t.timestamp??0,l=(c>0?(ae-c)/3600:1/0)<=336,f=s&&!ge.has(s);if(f&&l?(ge.add(s),fe++,n.hasGhostNodes&&he++,n.usedObservationOverride&&de++,n.totalCost!==1/0&&(pe+=n.confidence)):f&&ge.add(s),n.hasGhostNodes&&l){const e=N(n,c,t.packet_hash);le.push(...e)}for(let o=0;o<n.nodes.length-1;o++){const s=n.nodes[o],c=n.nodes[o+1];if(!m(s)||!m(c))continue;const l=s.hash,f=c.hash;if(l===f)continue;const h=s.confidence,d=c.confidence,p=i(o+1,a),g=d>=.9,v=h>=e&&d>=e||g||1===p&&d>=e;u.add(l),u.add(f),o>0&&o<n.nodes.length-1&&oe.set(l,(oe.get(l)||0)+1);const C=g?d:h*d;!v&&C<y||ce(l,f,C,v,r(p),t.route??t.route_type,t.timestamp,n.confidence,t.is_duplicate)}const h=n.nodes.filter(m);if(h.length>=3)for(let e=0;e<h.length-2;e++){const t=h[e].hash,o=h[e+2].hash,s=h[e+1].hash;if(t===o)continue;const i=t<o?`${t}-${o}`:`${o}-${t}`,r=me.get(i);if(r)r.count++,r.totalConfidence+=n.confidence,r.intermediates.set(s,(r.intermediates.get(s)||0)+1);else{const e=new Map;e.set(s,1),me.set(i,{endpointA:t<o?t:o,endpointB:t<o?o:t,intermediates:e,totalConfidence:n.confidence,count:1})}}}else if(1===a){const e=d(Z,o[0],{position:1,isLastHop:!0});e.hash&&u.add(e.hash)}for(const e of u)ne.set(e,(ne.get(e)||0)+1)}for(const t of E){const n=t.type??t.payload_type;if(9!==n&&8!==n)continue;const o=t.original_path??t.forwarded_path;if(!o||!Array.isArray(o)||o.length<2)continue;const s=o.map(e=>String(e).toUpperCase());9===n?Ce++:be++;for(let i=0;i<s.length-1;i++){const n=s[i],o=s[i+1];if(n===o)continue;const r=d(Z,n,{position:s.length-i,adjacentPrefixes:i>0?[s[i-1]]:[]}),a=d(Z,o,{position:s.length-i-1,adjacentPrefixes:[n,...i+2<s.length?[s[i+2]]:[]]});if(!r.hash||!a.hash)continue;if(r.hash===a.hash)continue;const c=r.confidence*a.confidence,u=r.confidence>=e&&a.confidence>=e,l=r.hash===v,f=a.hash===v,h=Object.keys(p).includes(r.hash),g=Object.keys(p).includes(a.hash);let m;m=l||f?0:h||g?1:Math.max(2,Math.min(i+1,5));const y=2;ce(r.hash,a.hash,c,u,m,y,t.timestamp,.8*c,t.is_duplicate),ve++,ne.set(r.hash,(ne.get(r.hash)||0)+1),ne.set(a.hash,(ne.get(a.hash)||0)+1),i>0&&i<s.length-2&&oe.set(r.hash,(oe.get(r.hash)||0)+1)}}const Me=new Map;let Se=0;for(const[e,t]of ne){const n=oe.get(e)||0,o=t>0?n/t:0;Me.set(e,o),Se=Math.max(Se,o)}if(Se>0)for(const[e,t]of Me)Me.set(e,t/Se);const we=new Set,ke=new Set,xe=[...se.values()].reduce((e,t)=>e+t,0);for(const[e,t]of se){if(e===v)continue;const n=xe>0?t/xe:0;if(n>=.1){we.add(e);const t=Me.get(e)||0;Me.set(e,Math.max(t,n))}else if(n>=.07){ke.add(e);const t=Me.get(e)||0;Me.set(e,Math.max(t,n))}}const He=Array.from(we),_e=Array.from(ke);for(const e of me.values()){if(e.count<5)continue;if(e.totalConfidence/e.count<.5)continue;const t=z(e.endpointA,e.endpointB);if(ee.has(t)){const n=ee.get(t);n.count+=Math.floor(.5*e.count),n.confidenceSum+=.5*e.totalConfidence,n.viterbiConfidenceSum+=e.totalConfidence,n.viterbiObservationCount+=e.count}else{const n=[0,0,0,0,0,0,0,0,0,0];n[2]=e.count,ee.set(t,{fromHash:e.endpointA,toHash:e.endpointB,key:t,count:e.count,confidenceSum:.7*e.totalConfidence,minHopDistance:2,hopDistanceCounts:n,certainCount:0,uncertainCount:e.count,forwardCount:Math.floor(e.count/2),reverseCount:Math.ceil(e.count/2),floodCount:e.count,directCount:0,recencySum:.5*e.count,viterbiConfidenceSum:e.totalConfidence,viterbiObservationCount:e.count})}}for(const[t,n]of F){if(n.count<3)continue;if(n.confidence<.6)continue;const[o,s]=t.split("-"),i=d(Z,o,{position:1,isLastHop:!0}),r=d(Z,s,{position:1,isLastHop:!0});if(!i.hash||!r.hash)continue;if(i.hash===r.hash)continue;const a=z(i.hash,r.hash),c=ee.get(a),u=n.confidence*Math.min(i.confidence,r.confidence);if(c)c.count+=n.count,c.confidenceSum+=u*n.count,c.recencySum+=.7*n.count,u>=e?c.certainCount+=Math.floor(.5*n.count):c.uncertainCount+=n.count,O++;else{const t=[0,0,0,0,0,0,0,0,0,0];t[1]=n.count;const[o,s]=i.hash<r.hash?[i.hash,r.hash]:[r.hash,i.hash];ee.set(a,{fromHash:o,toHash:s,key:a,count:n.count,confidenceSum:u*n.count,minHopDistance:1,hopDistanceCounts:t,certainCount:u>=e?Math.floor(.3*n.count):0,uncertainCount:n.count,forwardCount:Math.floor(n.count/2),reverseCount:Math.ceil(n.count/2),floodCount:n.count,directCount:0,recencySum:.7*n.count,viterbiConfidenceSum:0,viterbiObservationCount:0}),O++}}const Pe=[],Le=[],Ee=[];let Re=0,Ae=0;const $e=new Set(He),De=new Set;for(const e of ee.values()){const t=e.confidenceSum/e.count;Re=Math.max(Re,e.count),Ae=Math.max(Ae,e.certainCount);const n=$e.has(e.fromHash)||$e.has(e.toHash),o=e.certainCount>=5,s=e.forwardCount+e.reverseCount,i=s>0?Math.min(e.forwardCount,e.reverseCount)/Math.max(e.forwardCount,e.reverseCount):0;let r="balanced";i<.7&&s>0&&(r=e.forwardCount>e.reverseCount?"forward":"reverse");const a=e.floodCount+e.directCount>0&&e.directCount>e.floodCount,c=e.count>0?e.recencySum/e.count:0,u={fromHash:e.fromHash,toHash:e.toHash,key:e.key,packetCount:e.count,avgConfidence:t,strength:0,avgRecency:c,hopDistanceFromLocal:e.minHopDistance,isHubConnection:n,isCertain:o,certainCount:e.certainCount,forwardCount:e.forwardCount,reverseCount:e.reverseCount,symmetryRatio:i,dominantDirection:r,floodCount:e.floodCount,directCount:e.directCount,isDirectPathEdge:a};Pe.push(u),o&&(Le.push(u),De.add(e.key))}for(const e of Pe)!De.has(e.key)&&e.packetCount>=2&&Ee.push(e);if(S&&S.length>0&&v)for(const e of S){if(e.hash===v)continue;const t=z(v,e.hash),n=Pe.find(e=>e.key===t);if(n)n.isZeroHop=!0,n.isCertain=!0,n.avgConfidence=Math.max(n.avgConfidence,.95),null!=e.avgRssi&&(n.avgRssi=e.avgRssi),null!=e.avgSnr&&(n.avgSnr=e.avgSnr),De.has(t)||(Le.push(n),De.add(t));else{const[n,o]=v<e.hash?[v,e.hash]:[e.hash,v],s={fromHash:n,toHash:o,key:t,packetCount:e.advertCount,avgConfidence:1,strength:1,avgRecency:1,hopDistanceFromLocal:0,isHubConnection:$e.has(e.hash),isCertain:!0,certainCount:e.advertCount,forwardCount:0,reverseCount:e.advertCount,symmetryRatio:0,dominantDirection:"reverse",floodCount:e.advertCount,directCount:0,isDirectPathEdge:!1,isZeroHop:!0,avgRssi:e.avgRssi,avgSnr:e.avgSnr};if(e.lastSeen&&e.lastSeen>0){const t=(ae-e.lastSeen)/3600;s.avgRecency=t>=0?Math.exp(-t/12):1}Pe.push(s),Le.push(s),De.add(t)}}for(const e of Pe){const t=ee.get(e.key),n=t&&t.viterbiObservationCount>0?t.viterbiConfidenceSum/t.viterbiObservationCount:0,o=Re>0?e.packetCount/Re:0;e.strength=.3*o+.3*e.avgConfidence+.25*n+.15*e.avgRecency}Pe.sort((e,t)=>t.certainCount-e.certainCount),Le.sort((e,t)=>{const n=e.certainCount+(e.isHubConnection?1e3:0);return t.certainCount+(t.isHubConnection?1e3:0)-n}),Ee.sort((e,t)=>e.packetCount-t.packetCount);const Oe=Le.slice(0,100),Ne=Ee.slice(0,100),je=new Map(Pe.map(e=>[e.key,e])),{loops:Fe,loopEdgeKeys:Te}=function(e,t,n=1){if(e.length<3)return{loops:[],loopEdgeKeys:new Set};const o=new Map,s=new Map;for(const u of e)s.set(u.key,u),o.has(u.fromHash)||o.set(u.fromHash,new Set),o.has(u.toHash)||o.set(u.toHash,new Set),o.get(u.fromHash).add(u.toHash),o.get(u.toHash).add(u.fromHash);const i=[],r=new Set,a=new Set;function c(e,t,n){if(e===t)return[e];const s=new Set([e]),i=[{node:e,path:[e]}];for(;i.length>0;){const{node:e,path:r}=i.shift(),a=o.get(e);if(a)for(const o of a)if(z(e,o)!==n){if(o===t)return[...r,o];s.has(o)||(s.add(o),i.push({node:o,path:[...r,o]}))}}return null}for(const u of e){const e=c(u.fromHash,u.toHash,u.key);if(e&&e.length>=2){const o=e,c=[u.key];for(let t=0;t<e.length-1;t++){const n=z(e[t],e[t+1]);c.push(n)}const l=[...o].sort().join(",");if(a.has(l))continue;a.add(l);let f=0,h=1/0;for(const e of c){const t=s.get(e);t&&(f+=t.certainCount,h=Math.min(h,t.certainCount),r.add(e))}const d=c.length>0?f/c.length:0,p=!!t&&o.includes(t),g={id:`loop-${i.length}`,edgeKeys:c,nodes:o,size:c.length,avgCertainCount:d,minCertainCount:h===1/0?0:h,includesLocal:p,strength:n>0?h===1/0?0:h/n:0};i.push(g)}}return i.sort((e,t)=>e.includesLocal!==t.includesLocal?e.includesLocal?-1:1:t.strength-e.strength),{loops:i,loopEdgeKeys:r}}(Le,v,Ae);for(const e of Pe)e.isLoopEdge=Te.has(e.key);const Ue=function(e,t){const n=new Map,o=new Map;let s=0;for(const a of e){if(!a.src_hash)continue;const e=a.original_path??a.forwarded_path;if(!e||!Array.isArray(e)||0===e.length)continue;const o=e.map(e=>"string"==typeof e?e.toUpperCase().slice(0,2):String(e).toUpperCase().slice(0,2)),i=t||"unknown",r=a.src_hash,c=G(o,r);let u=n.get(c);u||(u={id:c,hops:o,srcHash:r,dstHash:i,observationCount:0,firstSeen:a.timestamp,lastSeen:a.timestamp,routeType:I(a),hopCount:o.length},n.set(c,u)),u.observationCount++,u.lastSeen=Math.max(u.lastSeen,a.timestamp),u.firstSeen=Math.min(u.firstSeen,a.timestamp),s++,"direct"===I(a)&&"direct"!==u.routeType&&(u.routeType="direct")}const i=Array.from(n.values());for(const a of i){const e=q(a.srcHash,a.dstHash),t=o.get(e)||[];t.push(a),o.set(e,t)}for(const a of o.values())a.sort((e,t)=>t.observationCount-e.observationCount);const r=new Map;for(const[a,c]of o)c.length>0&&r.set(a,c[0]);return{paths:i,byEndpoints:o,canonicalPaths:r,totalObservations:s,uniquePathCount:i.length}}(E,v),Ge=function(e,t,n,o){const s=new Map;if(0===e.length||0===n.length)return s;const i=e=>{const t=.2*Math.round(e/.2);return Math.max(0,Math.min(2,t))},r=e=>Math.floor(5*e),a=new Set;for(const g of e)a.add(g.fromHash),a.add(g.toHash);const c=n.map(e=>e.timestamp).filter(e=>void 0!==e&&e>0).sort((e,t)=>e-t),u=c.length>=2?(c[c.length-1]-c[0])/60:1,l=new Map;for(const g of e)l.has(g.fromHash)||l.set(g.fromHash,[]),l.has(g.toHash)||l.set(g.toHash,[]),l.get(g.fromHash).push(g),l.get(g.toHash).push(g);const f=new Map;for(const g of a){const e=l.get(g)||[];if(0===e.length)continue;const t=g.startsWith("0x")?g.slice(2,4).toUpperCase():g.slice(0,2).toUpperCase(),n=new Set;let s=0,i=0,r=0,a=0;for(const o of e){const e=o.fromHash===g?o.toHash:o.fromHash;n.add(e),s+=o.packetCount,i+=o.certainCount,r+=o.symmetryRatio,a+=o.floodCount}const c=n.size,h=e.length>0?r/e.length:0,d=e.length>0?i/e.length:0,p=o.paths.filter(e=>e.hops.some(e=>e.toUpperCase()===t)).length;f.set(g,{neighborCount:c,totalEdgePackets:s,avgEdgeCertainCount:d,avgSymmetry:h,floodForwardRatio:s>0?a/s:0,trafficRate:u>0?s/u:0,pathCount:p})}const h=new Map;for(const g of a){const e=f.get(g);if(!e||e.totalEdgePackets<100)continue;const t=K(e.neighborCount),o=W(e.neighborCount),s=B(e.avgSymmetry),r=Q(t,.5,s),a=Q(o,.2,s),c=i(Math.min(r,2)),u=i(Math.min(a,1));let l;l=e.neighborCount>=6&&e.pathCount>=5?"backbone":e.neighborCount>=4?"hub":e.neighborCount>=2?"relay":"edge";const d=.3*Math.min(e.avgEdgeCertainCount/10,1)+.3*Math.min(n.length/1e3,1)+.4*e.avgSymmetry;let p;p=n.length<100?"insufficient":n.length<500?"low":n.length<1e3?"medium":"high",h.set(g,{floodFactor:c,directFactor:u,networkRole:l,damping:s,avgSymmetry:e.avgSymmetry,trafficRate:e.trafficRate,floodForwardRatio:e.floodForwardRatio,pathCount:e.pathCount,confidence:d,dataConfidence:p})}const d=new Map;for(const[g,m]of h){const e=r(m.floodFactor);d.has(e)||d.set(e,[]),d.get(e).push(g)}const p=new Map;for(const[,g]of d){if(g.length<=1){1===g.length&&p.set(g[0],h.get(g[0]).floodFactor);continue}const e=[...g].sort((e,t)=>{const n=f.get(e),o=f.get(t);return((null==n?void 0:n.neighborCount)??0)-((null==o?void 0:o.neighborCount)??0)});for(let t=0;t<e.length;t++){const n=e[t],o=h.get(n),s=t%3*.2;p.set(n,i(o.floodFactor+s))}}for(const g of a){const e=f.get(g);if(!e||e.totalEdgePackets<100){s.set(g,{floodFactor:0,directFactor:0,floodSlots:0,directSlots:0,floodDelaySec:0,directDelaySec:0,txDelayFactor:0,directTxDelayFactor:0,trafficIntensity:0,directNeighborCount:(null==e?void 0:e.neighborCount)??0,collisionRisk:0,confidence:0,insufficientData:!0,networkRole:"edge",rationale:"Insufficient data (<100 packets observed)",adjustment:"stable",avgPathPosition:0,pathPositionVariance:0,floodParticipationRate:0,pathDiversity:0,positionDelayMs:0,observationSymmetry:(null==e?void 0:e.avgSymmetry)??0,dataConfidence:"insufficient"});continue}const t=h.get(g),n=p.get(g)??t.floodFactor,i=t.directFactor,a=r(n),c=r(i),u=e.neighborCount;let l=`${u} edge${1!==u?"s":""} observed`;t.avgSymmetry>=.5?l+=`, ${Math.round(100*t.avgSymmetry)}% symmetric`:t.avgSymmetry<.3?l+=`. ⚠️ Low symmetry (${Math.round(100*t.avgSymmetry)}%) — dampened toward default`:l+=`, ${Math.round(100*t.avgSymmetry)}% symmetric — partial damping`,"low"===t.dataConfidence&&(l+=". Limited data");const d=r(.5);let m;m=a>d?"increase":a<d?"decrease":"stable";const v=g.startsWith("0x")?g.slice(2,4).toUpperCase():g.slice(0,2).toUpperCase(),y=o.paths.filter(e=>e.hops.some(e=>e.toUpperCase()===v)).flatMap(e=>{const t=e.hops.findIndex(e=>e.toUpperCase()===v);return t>=0?[t+1]:[]}),C=y.length>0?y.reduce((e,t)=>e+t,0)/y.length:0;let b=0;y.length>1&&(b=y.reduce((e,t)=>e+Math.pow(t-C,2),0)/y.length),s.set(g,{floodFactor:n,directFactor:i,floodSlots:a,directSlots:c,floodDelaySec:n,directDelaySec:i,txDelayFactor:n,directTxDelayFactor:i,trafficIntensity:Math.round(10*t.trafficRate)/10,directNeighborCount:e.neighborCount,collisionRisk:0,confidence:t.confidence,insufficientData:!1,networkRole:t.networkRole,rationale:l,adjustment:m,avgPathPosition:Math.round(10*C)/10,pathPositionVariance:Math.round(100*b)/100,floodParticipationRate:Math.round(100*t.floodForwardRatio)/100,pathDiversity:t.pathCount,positionDelayMs:0,observationSymmetry:Math.round(100*t.avgSymmetry)/100,dataConfidence:t.dataConfidence})}return s}(Pe,0,E,Ue),qe=function(e,t){const n=new Map,s=new Map(t.map(e=>[e.key,e]));for(const o of t)n.set(o.key,0);if(0===e.paths.length)return n;for(const r of e.paths)for(let e=0;e<r.hops.length-1;e++){const s=r.hops[e],i=r.hops[e+1];for(const e of t){const t=o(e.fromHash),a=o(e.toHash);if(t===s&&a===i||t===i&&a===s){const t=n.get(e.key)||0;n.set(e.key,t+r.observationCount);break}}}const i=Math.max(...n.values(),1);for(const[o,r]of n)n.set(o,r/i);for(const[o,r]of n){const e=s.get(o);if(e){const t=.5+.5*e.symmetryRatio;n.set(o,r*t)}}return n}(Ue,Pe),Ie=function(e,t=3,n=.3){return[...e.entries()].filter(([,e])=>e>=n).sort((e,t)=>t[1]-e[1]).slice(0,t).map(([e])=>e)}(qe,3,.3),{nodeMobility:Ve,mobileNodes:ze}=function(e,t){const n=new Map,o=[];if(0===e.paths.length)return{nodeMobility:n,mobileNodes:o};const s=36e5,i=e.paths.map(e=>e.lastSeen).sort((e,t)=>e-t),r=i[0],a=i[i.length-1],c=Math.ceil((a-r)/s)||1,u=new Map;for(const l of e.paths){const e=Math.floor((l.lastSeen-r)/s);for(const n of l.hops){let o=n;for(const[e]of Object.entries(t))if((e.startsWith("0x")?e.slice(2,4).toUpperCase():e.slice(0,2).toUpperCase())===n.toUpperCase()){o=e;break}let s=u.get(o);s||(s={paths:new Set,firstSeen:l.firstSeen,lastSeen:l.lastSeen,windowPresence:new Set},u.set(o,s)),s.paths.add(l.id),s.firstSeen=Math.min(s.firstSeen,l.firstSeen),s.lastSeen=Math.max(s.lastSeen,l.lastSeen),s.windowPresence.add(e)}}for(const[l,f]of u){const e=f.paths.size,t=f.lastSeen-f.firstSeen,s=t>0?t/36e5:0,i=c>0?f.windowPresence.size/c:1,r=(1-i)*(1-.5*Math.min(e/10,1)),a=r>.3,u={hash:l,pathVolatility:r,pathDiversity:e,avgPathLifespanHours:s,isMobile:a,lastSeen:f.lastSeen,activeWindowRatio:i};n.set(l,u),a&&o.push(l)}return o.sort((e,t)=>{var o,s;const i=(null==(o=n.get(e))?void 0:o.pathVolatility)??0;return((null==(s=n.get(t))?void 0:s.pathVolatility)??0)-i}),{nodeMobility:n,mobileNodes:o}}(Ue,p),Ke=function(e,t,n,s=20){const i=[];if(0===e.paths.length)return i;const r=new Map;for(const f of t){const e=o(f.fromHash),t=o(f.toHash);r.set(`${e}>${t}`,f),r.set(`${t}>${e}`,f)}const a=new Set;for(const f of n)a.add(o(f));const c=new Map;for(const o of e.paths){if(0===o.hops.length)continue;const e=o.hops[o.hops.length-1],t=c.get(e)||[];t.push(o.id),c.set(e,t)}const u=[...e.paths].sort((e,t)=>t.observationCount-e.observationCount),l=Date.now();for(const o of u.slice(0,s)){if(o.hops.length<2)continue;let e=0,t=1/0,n=null,s=0,u=!1;for(let i=0;i<o.hops.length-1;i++){const c=o.hops[i],l=o.hops[i+1],f=`${c}>${l}`,h=r.get(f);if(h){const o=h.packetCount>0?h.certainCount/h.packetCount:0;e+=o,s++,o<t&&(t=o,n=h.key)}else e+=.1,s++,.1<t&&(t=.1,n=z(c,l));(a.has(c)||a.has(l))&&(u=!0)}const f=s>0?e/s:0,h=t===1/0?0:t,d=(l-o.lastSeen)/36e5,p=Math.exp(-d/24),g=o.observationCount>10&&d<12?.5+.5*(1-d/12):d>48?-.5:0,m=o.hops[o.hops.length-1],v=c.get(m)||[],y=Math.max(0,v.length-1),C="direct"===o.routeType?20:30,b=o.hops.length*C,M=.4*f,S=.3*p,w=(g+1)/2*.15,k=.15*Math.min(y/3,1),x=Math.round(100*(M+S+w+k))/100;i.push({pathKey:o.id,hops:[...o.hops],healthScore:x,weakestLinkKey:n,weakestLinkConfidence:Math.round(100*h)/100,weakestLinkTraceSnr:null,avgEdgeCertainty:Math.round(100*f)/100,observationTrend:Math.round(100*g)/100,alternatePathsCount:y,estimatedLatencyMs:b,observationCount:o.observationCount,routeType:"unknown"===o.routeType?"mixed":o.routeType,lastSeen:o.lastSeen,involvesHub:u})}return i.sort((e,t)=>t.healthScore-e.healthScore),i}(Ue,Pe,He,20),We=[];for(const e of ie.values()){let t=null,n=0,o=0;for(const[s,i]of e.resolvedHashes){if(s===v)continue;const e=i.count>0?i.confidenceSum/i.count:0,r=i.count*e;r>n&&(n=r,t=s,o=e)}t&&We.push({hash:t,prefix:e.prefix,count:e.count,confidence:o,avgRssi:e.rssiCount>0?e.rssiSum/e.rssiCount:null,avgSnr:e.snrCount>0?e.snrSum/e.snrCount:null,lastSeen:e.lastSeen})}We.sort((e,t)=>t.count-e.count);let Be=0,Qe=0;const Ze=[],Je=[];let Xe=0;for(const[e,t]of Z){if(Be+=t.confidence,!t.isUnambiguous){const{isReplacement:n,activeCandidates:o}=g(t.candidates);if(n&&o.length<=1);else{const n=o.length;if(n>1){Qe++;const s=o.map(e=>e.hash);Je.push({prefix:e,candidateCount:n,candidateHashes:s}),t.confidence<.5&&Ze.push(e)}}}for(const t of J.values())if(t.hash.toUpperCase().startsWith(e)||t.hash.slice(2).toUpperCase().startsWith(e)){Xe+=t.resolutionCount;break}}Je.sort((e,t)=>t.candidateCount-e.candidateCount);const Ye=Je.slice(0,5),et={totalPrefixes:Z.size,unambiguousPrefixes:Z.size-Qe,collisionPrefixes:Qe,collisionRate:Z.size>0?Math.round(Qe/Z.size*1e3)/10:0,avgConfidence:Z.size>0?Math.round(Be/Z.size*1e3)/1e3:0,lowConfidencePrefixes:Ze,highCollisionPrefixes:Ye,totalResolutions:Xe},tt=function(e,t){const n=t??Date.now(),o=new Map;for(const i of e){const e=i.prefix.toUpperCase(),t=T(i.timestamp,n),s=o.get(e);s?(s.observations.push(i),s.weightedCount+=t):o.set(e,{observations:[i],weightedCount:t})}const s=[];for(const[i,r]of o){const e=r.observations.length>=10,t=r.weightedCount>=5;if(!e&&!t)continue;const o=U(i,r.observations,n);o&&s.push(o)}return s.sort((e,t)=>t.confidence-e.confidence),s}(le,1e3*ae),nt=S?new Set(S.map(e=>e.hash)):new Set,{nodeMetrics:ot,communityCount:st,backboneNodes:it}=re(Pe,je,Me,He,_e,Ie,Te,ze,Ve,Ue,tt,p,v,nt,Z,qe),rt=ye(E,Pe,je,Ke,ot,{prefixLookup:Z,srcHashResolver:H,neighbors:p,windowHours:_,previousTraceEvidence:P,spreadingFactor:L}),{traceLinks:at,traceLinkSummary:ct,traceDisambiguationFeedback:ut}=rt,lt=fe-he;return{edges:Pe,validatedEdges:Oe,weakEdges:Ne,certainEdges:Oe,uncertainEdges:[],edgeMap:je,maxPacketCount:Re,maxCertainCount:Ae,neighborAffinity:Y,fullAffinity:J,localPrefix:X,centrality:Me,hubNodes:He,gatewayNodes:_e,loops:Fe,loopEdgeKeys:Te,txDelayRecommendations:Ge,pathRegistry:Ue,edgeBetweenness:qe,backboneEdges:Ie,nodeMobility:Ve,mobileNodes:ze,pathHealth:Ke,lastHopNeighbors:We,disambiguationStats:et,discoveredNodes:tt,viterbiStats:{totalPaths:fe,pathsWithGhosts:he,observationOverrideCount:de,avgPathConfidence:lt>0?pe/lt:0,avgPathCost:0,tracePacketsProcessed:Ce,pathPacketsProcessed:be,distantEdgesDiscovered:ve,duplicateGroupsFound:A,duplicatePathsUnique:$,echolocationEdgesInferred:O},nodeMetrics:ot,communityCount:st,backboneNodes:it,traceLinks:at,traceLinkSummary:ct,traceDisambiguationFeedback:ut}}var be,Me,Se={exports:{}},we={};Me||(Me=1,Se.exports=function(){if(be)return we;be=1;var e=Symbol.for("react.element"),t=Symbol.for("react.portal"),n=Symbol.for("react.fragment"),o=Symbol.for("react.strict_mode"),s=Symbol.for("react.profiler"),i=Symbol.for("react.provider"),r=Symbol.for("react.context"),a=Symbol.for("react.forward_ref"),c=Symbol.for("react.suspense"),u=Symbol.for("react.memo"),l=Symbol.for("react.lazy"),f=Symbol.iterator,h={isMounted:function(){return!1},enqueueForceUpdate:function(){},enqueueReplaceState:function(){},enqueueSetState:function(){}},d=Object.assign,p={};function g(e,t,n){this.props=e,this.context=t,this.refs=p,this.updater=n||h}function m(){}function v(e,t,n){this.props=e,this.context=t,this.refs=p,this.updater=n||h}g.prototype.isReactComponent={},g.prototype.setState=function(e,t){if("object"!=typeof e&&"function"!=typeof e&&null!=e)throw Error("setState(...): takes an object of state variables to update or a function which returns an object of state variables.");this.updater.enqueueSetState(this,e,t,"setState")},g.prototype.forceUpdate=function(e){this.updater.enqueueForceUpdate(this,e,"forceUpdate")},m.prototype=g.prototype;var y=v.prototype=new m;y.constructor=v,d(y,g.prototype),y.isPureReactComponent=!0;var C=Array.isArray,b=Object.prototype.hasOwnProperty,M={current:null},S={key:!0,ref:!0,__self:!0,__source:!0};function w(t,n,o){var s,i={},r=null,a=null;if(null!=n)for(s in void 0!==n.ref&&(a=n.ref),void 0!==n.key&&(r=""+n.key),n)b.call(n,s)&&!S.hasOwnProperty(s)&&(i[s]=n[s]);var c=arguments.length-2;if(1===c)i.children=o;else if(1<c){for(var u=Array(c),l=0;l<c;l++)u[l]=arguments[l+2];i.children=u}if(t&&t.defaultProps)for(s in c=t.defaultProps)void 0===i[s]&&(i[s]=c[s]);return{$$typeof:e,type:t,key:r,ref:a,props:i,_owner:M.current}}function k(t){return"object"==typeof t&&null!==t&&t.$$typeof===e}var x=/\/+/g;function H(e,t){return"object"==typeof e&&null!==e&&null!=e.key?function(e){var t={"=":"=0",":":"=2"};return"$"+e.replace(/[=:]/g,function(e){return t[e]})}(""+e.key):t.toString(36)}function _(n,o,s,i,r){var a=typeof n;"undefined"!==a&&"boolean"!==a||(n=null);var c=!1;if(null===n)c=!0;else switch(a){case"string":case"number":c=!0;break;case"object":switch(n.$$typeof){case e:case t:c=!0}}if(c)return r=r(c=n),n=""===i?"."+H(c,0):i,C(r)?(s="",null!=n&&(s=n.replace(x,"$&/")+"/"),_(r,o,s,"",function(e){return e})):null!=r&&(k(r)&&(r=function(t,n){return{$$typeof:e,type:t.type,key:n,ref:t.ref,props:t.props,_owner:t._owner}}(r,s+(!r.key||c&&c.key===r.key?"":(""+r.key).replace(x,"$&/")+"/")+n)),o.push(r)),1;if(c=0,i=""===i?".":i+":",C(n))for(var u=0;u<n.length;u++){var l=i+H(a=n[u],u);c+=_(a,o,s,l,r)}else if(l=function(e){return null===e||"object"!=typeof e?null:"function"==typeof(e=f&&e[f]||e["@@iterator"])?e:null}(n),"function"==typeof l)for(n=l.call(n),u=0;!(a=n.next()).done;)c+=_(a=a.value,o,s,l=i+H(a,u++),r);else if("object"===a)throw o=String(n),Error("Objects are not valid as a React child (found: "+("[object Object]"===o?"object with keys {"+Object.keys(n).join(", ")+"}":o)+"). If you meant to render a collection of children, use an array instead.");return c}function P(e,t,n){if(null==e)return e;var o=[],s=0;return _(e,o,"","",function(e){return t.call(n,e,s++)}),o}function L(e){if(-1===e._status){var t=e._result;(t=t()).then(function(t){0!==e._status&&-1!==e._status||(e._status=1,e._result=t)},function(t){0!==e._status&&-1!==e._status||(e._status=2,e._result=t)}),-1===e._status&&(e._status=0,e._result=t)}if(1===e._status)return e._result.default;throw e._result}var E={current:null},R={transition:null},A={ReactCurrentDispatcher:E,ReactCurrentBatchConfig:R,ReactCurrentOwner:M};function $(){throw Error("act(...) is not supported in production builds of React.")}return we.Children={map:P,forEach:function(e,t,n){P(e,function(){t.apply(this,arguments)},n)},count:function(e){var t=0;return P(e,function(){t++}),t},toArray:function(e){return P(e,function(e){return e})||[]},only:function(e){if(!k(e))throw Error("React.Children.only expected to receive a single React element child.");return e}},we.Component=g,we.Fragment=n,we.Profiler=s,we.PureComponent=v,we.StrictMode=o,we.Suspense=c,we.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=A,we.act=$,we.cloneElement=function(t,n,o){if(null==t)throw Error("React.cloneElement(...): The argument must be a React element, but you passed "+t+".");var s=d({},t.props),i=t.key,r=t.ref,a=t._owner;if(null!=n){if(void 0!==n.ref&&(r=n.ref,a=M.current),void 0!==n.key&&(i=""+n.key),t.type&&t.type.defaultProps)var c=t.type.defaultProps;for(u in n)b.call(n,u)&&!S.hasOwnProperty(u)&&(s[u]=void 0===n[u]&&void 0!==c?c[u]:n[u])}var u=arguments.length-2;if(1===u)s.children=o;else if(1<u){c=Array(u);for(var l=0;l<u;l++)c[l]=arguments[l+2];s.children=c}return{$$typeof:e,type:t.type,key:i,ref:r,props:s,_owner:a}},we.createContext=function(e){return(e={$$typeof:r,_currentValue:e,_currentValue2:e,_threadCount:0,Provider:null,Consumer:null,_defaultValue:null,_globalName:null}).Provider={$$typeof:i,_context:e},e.Consumer=e},we.createElement=w,we.createFactory=function(e){var t=w.bind(null,e);return t.type=e,t},we.createRef=function(){return{current:null}},we.forwardRef=function(e){return{$$typeof:a,render:e}},we.isValidElement=k,we.lazy=function(e){return{$$typeof:l,_payload:{_status:-1,_result:e},_init:L}},we.memo=function(e,t){return{$$typeof:u,type:e,compare:void 0===t?null:t}},we.startTransition=function(e){var t=R.transition;R.transition={};try{e()}finally{R.transition=t}},we.unstable_act=$,we.useCallback=function(e,t){return E.current.useCallback(e,t)},we.useContext=function(e){return E.current.useContext(e)},we.useDebugValue=function(){},we.useDeferredValue=function(e){return E.current.useDeferredValue(e)},we.useEffect=function(e,t){return E.current.useEffect(e,t)},we.useId=function(){return E.current.useId()},we.useImperativeHandle=function(e,t,n){return E.current.useImperativeHandle(e,t,n)},we.useInsertionEffect=function(e,t){return E.current.useInsertionEffect(e,t)},we.useLayoutEffect=function(e,t){return E.current.useLayoutEffect(e,t)},we.useMemo=function(e,t){return E.current.useMemo(e,t)},we.useReducer=function(e,t,n){return E.current.useReducer(e,t,n)},we.useRef=function(e){return E.current.useRef(e)},we.useState=function(e){return E.current.useState(e)},we.useSyncExternalStore=function(e,t,n){return E.current.useSyncExternalStore(e,t,n)},we.useTransition=function(){return E.current.useTransition()},we.version="18.3.1",we}()),Se.exports,self.onmessage=e=>{const{type:t,payload:n}=e.data;if("compute"!==t)return void self.postMessage({type:"error",error:`Unknown message type: ${t}`});const o=performance.now();try{const{packets:e,neighbors:t,localHash:i,localLat:r,localLon:a,airtimeMs:c,zeroHopNeighbors:u,terrainGrid:l,enableTerrainAware:f,srcHashResolverEntries:h,windowHours:d,spreadingFactor:p,previousTraceEvidenceSerialized:g}=n,m=Ce(e,t,i,.5,r,a,0,u,l,f,h&&h.length>0?new Map(h):void 0,d,g?{confirmedResolutions:new Map(g.confirmedResolutions),confirmedLinks:g.confirmedLinks}:void 0,p),v=l?{enabled:!0,totalLinks:0,feasibleLinks:0,blockedLinks:0,overriddenLinks:0,reasonCounts:{}}:void 0,y={type:"result",payload:{edges:m.edges,validatedEdges:m.validatedEdges,weakEdges:m.weakEdges,certainEdges:m.certainEdges,uncertainEdges:m.uncertainEdges,maxPacketCount:m.maxPacketCount,maxCertainCount:m.maxCertainCount,localPrefix:m.localPrefix,hubNodes:m.hubNodes,gatewayNodes:m.gatewayNodes,edgeMapEntries:Array.from(m.edgeMap.entries()),neighborAffinityEntries:Array.from(m.neighborAffinity.entries()),fullAffinityEntries:Array.from(m.fullAffinity.entries()),centralityEntries:Array.from(m.centrality.entries()),loops:m.loops,loopEdgeKeyEntries:Array.from(m.loopEdgeKeys),txDelayRecommendationEntries:Array.from(m.txDelayRecommendations.entries()),pathRegistry:(s=m.pathRegistry,{paths:s.paths,byEndpointsEntries:Array.from(s.byEndpoints.entries()),canonicalPathsEntries:Array.from(s.canonicalPaths.entries()),totalObservations:s.totalObservations,uniquePathCount:s.uniquePathCount}),edgeBetweennessEntries:Array.from(m.edgeBetweenness.entries()),backboneEdges:m.backboneEdges,nodeMobilityEntries:Array.from(m.nodeMobility.entries()),mobileNodes:m.mobileNodes,pathHealth:m.pathHealth,lastHopNeighbors:m.lastHopNeighbors,disambiguationStats:m.disambiguationStats,discoveredNodes:m.discoveredNodes,viterbiStats:m.viterbiStats,nodeMetricsEntries:Array.from(m.nodeMetrics.entries()),communityCount:m.communityCount,backboneNodes:m.backboneNodes,traceLinkEntries:Array.from(m.traceLinks.entries()),traceLinkSummary:m.traceLinkSummary,traceDisambiguationFeedbackEntries:{confirmedResolutions:Array.from(m.traceDisambiguationFeedback.confirmedResolutions.entries()),confirmedLinks:m.traceDisambiguationFeedback.confirmedLinks},terrainStats:v},computeTimeMs:performance.now()-o};self.postMessage(y)}catch(i){const e={type:"error",error:i instanceof Error?i.message:"Unknown error in topology worker"};self.postMessage(e)}var s}}();
