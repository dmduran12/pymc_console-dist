import{j as e,r as t,at as s,o as a,au as n,av as i,aw as l,ax as r,ay as o,az as c,a4 as d,J as m,h,aa as x,aA as u,aB as p,a8 as f,p as g,aC as j,C as b,T as y,aD as v,ak as N}from"./vendor-react-nG6Am_s0.js";import{L as w,n as k,M,N as C,y as S,I as $,d as T,f as P,e as R,u as F,S as E,j as A,O as L,g as W}from"./index-BIZ3jtzu.js";import{T as D}from"./TimeRangeSelector-DIcUrVyb.js";import{u as _}from"./usePolling-CkFZwcUi.js";import{b as H,a as z,c as B,u as O,d as U,e as q,s as X}from"./useThemeColors-C9IVL-ly.js";import{c as I,R as Y,e as G,A as J,C as K,X as Q,Y as V,T as Z,b as ee,L as te,a as se}from"./recharts-BJXKa0n8.js";import{C as ae,b as ne,P as ie,a as le}from"./PageLayout-D3aCCXDi.js";import{C as re}from"./CollisionExplorerModal-DDHyPIHs.js";import{R as oe,C as ce}from"./Grid-IJFBFvdm.js";import"./vendor-core-XI_xDZ-M.js";import"./deckgl-MTXp-Y3t.js";import"./leaflet-ChRwnWLk.js";function de({children:t,centered:s,className:a}){return e.jsx("div",{className:I("flex-1 min-h-0",s&&"flex items-center justify-center",a),children:t})}function me(e){const t=e.match(/\(([^)]+)\)\s*$/);return t?t[1]:e.length>10?e.slice(0,10):e}function he({x:t,y:s,width:a,height:n,name:i,size:l,index:r,colors:o,depth:c,hoveredIndex:d,onHover:m,total:h}){if(1!==c)return null;const x=null!==d&&!(d===r),u=o[r%o.length],p=h>0?l/h*100:0,f=a>36&&n>20,g=a>36&&n>32,j=me(i);return e.jsxs("g",{onMouseEnter:e=>m(r,e),onMouseLeave:()=>m(null),style:{cursor:"default"},children:[e.jsx("rect",{x:t,y:s,width:a,height:n,fill:u,opacity:x?.4:1,stroke:"rgba(0,0,0,0.2)",strokeWidth:1,rx:3,style:{transition:"opacity 150ms ease"}}),f&&e.jsxs(e.Fragment,{children:[g&&e.jsxs("text",{x:t+4,y:s+n-4-11,textAnchor:"start",dominantBaseline:"auto",fill:"rgba(0,0,0,0.6)",fontSize:8,fontFamily:"'JetBrains Mono', monospace",fontWeight:500,style:{pointerEvents:"none"},children:[p.toFixed(1),"%"]}),e.jsx("text",{x:t+4,y:s+n-4,textAnchor:"start",dominantBaseline:"auto",fill:"rgba(0,0,0,0.85)",fontSize:9,fontFamily:"'JetBrains Mono', monospace",fontWeight:600,style:{pointerEvents:"none"},children:j})]})]})}function xe({data:t,total:s,color:a,position:n,containerWidth:i}){if(!t||!n)return null;const l=(t.value/s*100).toFixed(1),r=i-n.x<184?Math.max(8,n.x-160-8):n.x+16;return e.jsx("div",{className:"absolute z-50 pointer-events-none",style:{left:r,top:Math.max(8,n.y-60)},children:e.jsxs("div",{className:"bg-tooltip-bg border border-border-subtle rounded-lg px-3 py-2 shadow-xl min-w-[140px]",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:"w-2.5 h-2.5 rounded-sm flex-shrink-0",style:{backgroundColor:a}}),e.jsx("span",{className:"type-data-sm font-semibold text-text-primary",children:me(t.name)})]}),e.jsxs("div",{className:"space-y-0.5 type-data-xs text-text-muted",children:[e.jsxs("div",{className:"flex justify-between gap-4",children:[e.jsx("span",{children:"Count"}),e.jsx("span",{className:"text-text-primary tabular-nums font-medium",children:t.value.toLocaleString()})]}),e.jsxs("div",{className:"flex justify-between gap-4",children:[e.jsx("span",{children:"Share"}),e.jsxs("span",{className:"text-text-primary tabular-nums font-medium",children:[l,"%"]})]}),e.jsxs("div",{className:"flex justify-between gap-4",children:[e.jsx("span",{children:"Total"}),e.jsx("span",{className:"text-text-primary tabular-nums font-medium",children:s.toLocaleString()})]})]})]})})}const ue=t.memo(function({data:s}){var a,n;const[i,l]=t.useState(null),[r,o]=t.useState(null),[c,d]=t.useState(0),m=t.useRef(null),h=H(),{treemapData:x,total:u}=t.useMemo(()=>{const e=s.reduce((e,t)=>e+t.value,0);return{treemapData:[...s].sort((e,t)=>t.value-e.value).filter(t=>e>0&&t.value/e*100>=.5).map((e,t)=>({name:e.name,size:e.value,index:t})),total:e}},[s]),p=t.useCallback((e,t)=>{if(l(e),t&&null!==e){const e=m.current;if(e){const s=e.getBoundingClientRect();d(s.width),o({x:t.clientX-s.left,y:t.clientY-s.top})}}else o(null)},[]),f=null!==i?{name:(null==(a=x[i])?void 0:a.name)??"",value:(null==(n=x[i])?void 0:n.size)??0}:null,g=null!==i?h[i%h.length]:"";return 0===s.length||0===u?e.jsx("div",{className:"h-56 flex items-center justify-center text-text-muted",children:"No packet type data available"}):e.jsxs("div",{className:"relative treemap-container",style:{height:224},ref:m,children:[e.jsx(Y,{width:"100%",height:224,minWidth:1,minHeight:1,children:e.jsx(G,{data:x,dataKey:"size",aspectRatio:4/3,stroke:"none",isAnimationActive:!1,content:e.jsx(he,{x:0,y:0,width:0,height:0,name:"",value:0,size:0,index:0,colors:h,depth:0,hoveredIndex:i,onHover:p,total:u})})}),e.jsx(xe,{data:f,total:u,color:g,position:r,containerWidth:c})]})});function pe(e){return k[e]??`TYPE_${e.toString(16).toUpperCase()}`}const fe={sf:10,bw:25e4,cr:5,preamble:8};function ge(e,t=60){if(0===e.length)return[];const s=1-Math.pow(.5,1/t),a=Math.min(e.length,Math.max(10,Math.floor(t/3)));let n=0;for(let i=0;i<a;i++)n+=e[i];return n/=a,e.map(e=>(n=s*e+(1-s)*n,n))}function je({active:t,payload:s,label:a,mode:n,bucketData:i}){if(!t||!s||0===s.length)return null;const l="share"===n||"stream"===n,r=l?100:1,o=l?1e-4:.01,c=s.filter(e=>e.value>o).sort((e,t)=>t.value-e.value);if(0===c.length)return null;const d=c.reduce((e,t)=>e+t.value,0)*r,m="share"===n?"share":"airtime";return e.jsxs("div",{className:"bg-tooltip-bg border border-border-subtle rounded-lg px-3 py-2 shadow-xl min-w-[160px]",children:[e.jsx("div",{className:"font-medium text-text-primary mb-2 type-data-sm font-mono",children:a}),e.jsx("div",{className:"space-y-1",children:c.map(t=>{const s=t.value*r;return e.jsxs("div",{className:"flex items-center justify-between gap-3 type-data-xs",children:[e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("div",{className:"w-2.5 h-2.5 rounded-sm flex-shrink-0",style:{backgroundColor:t.color}}),e.jsx("span",{className:"text-text-secondary",children:t.name})]}),e.jsxs("span",{className:"text-text-primary tabular-nums font-mono",children:[s.toFixed(1),"%"]})]},t.dataKey)})}),e.jsxs("div",{className:"mt-2 pt-2 border-t border-border-subtle flex justify-between type-data-xs",children:[e.jsxs("span",{className:"text-text-muted",children:["Total ",m]}),e.jsxs("span",{className:"text-text-primary tabular-nums font-mono font-medium",children:[d.toFixed(1),"%"]})]}),i&&"share"===n&&e.jsxs("div",{className:"flex justify-between type-data-xs text-text-muted",children:[e.jsx("span",{children:"Packets"}),e.jsx("span",{className:"tabular-nums font-mono",children:i.total})]})]})}function be({mode:t,onChange:s}){return e.jsxs("div",{className:"toggle-group toggle-group-sm",children:[e.jsx("button",{onClick:()=>s("share"),className:"toggle-group-item "+("share"===t?"active":""),children:"Share"}),e.jsx("button",{onClick:()=>s("stream"),className:"toggle-group-item "+("stream"===t?"active":""),children:"Stream"}),e.jsx("button",{onClick:()=>s("airtime"),className:"toggle-group-item "+("airtime"===t?"active":""),children:"Airtime"})]})}const ye=t.memo(function({packets:a,startTs:n,endTs:i,bucketCount:l,radioConfig:r=fe,mode:o="share"}){const c=z(),d=B(),[m,h]=t.useState(a),x=t.useRef(null);t.useEffect(()=>(x.current&&clearTimeout(x.current),x.current=setTimeout(()=>{h(a)},500),()=>{x.current&&clearTimeout(x.current)}),[a]);const u=t.useMemo(()=>function(e){const t=new Map;for(const a of e){const e=a.type??a.payload_type??-1;t.set(e,(t.get(e)??0)+1)}const s=[];for(const[a,n]of t)s.push({typeNum:a,key:`TYPE_${a}`,label:pe(a),totalCount:n});return s.sort((e,t)=>t.totalCount-e.totalCount)}(m),[m]),p=t.useMemo(()=>function(e,t,s,a,n,i){const l=s-t,r=l/a,o=1e3*r,c=[];for(let d=0;d<a;d++){const e=t+d*r,s=new Date(1e3*e),a=l/3600>24?s.toLocaleDateString([],{weekday:"short",hour:"2-digit",minute:"2-digit",hour12:!1}):s.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hour12:!1});c.push({timestamp:e,time:a,counts:{},shares:{},airtimes:{},total:0,totalAirtime:0,bucketDurationMs:o});for(const t of i)c[d].counts[t.key]=0,c[d].airtimes[t.key]=0}for(const d of e){const e=d.timestamp;if(e<t||e>=s)continue;const i=Math.min(Math.floor((e-t)/r),a-1),l=`TYPE_${d.type??d.payload_type??-1}`;c[i].counts[l]=(c[i].counts[l]??0)+1,c[i].total++;const o=d.length??d.payload_length??32,m=w(o,{spreadingFactor:n.sf,bandwidthHz:n.bw,codingRate:n.cr,preambleLength:n.preamble});c[i].airtimes[l]=(c[i].airtimes[l]??0)+m,c[i].totalAirtime+=m}for(const d of c)for(const e of i)d.total>0?d.shares[e.key]=d.counts[e.key]/d.total*100:d.shares[e.key]=0;return c}(m,n,i,l,r,u),[m,n,i,l,r,u]),f=t.useMemo(()=>function(e,t,s){const a=function(e,t,s){if(e.length<=360)return e;const a=Math.ceil(e.length/360),n=[];for(let i=0;i<e.length;i+=a){const t=e.slice(i,Math.min(i+a,e.length));if(0===t.length)continue;const l={timestamp:t[0].timestamp,time:t[0].time,counts:{},shares:{},airtimes:{},total:0,totalAirtime:0,bucketDurationMs:t[0].bucketDurationMs*t.length};for(const e of t){l.total+=e.total,l.totalAirtime+=e.totalAirtime;for(const t of s)l.counts[t.key]=(l.counts[t.key]??0)+(e.counts[t.key]??0),l.airtimes[t.key]=(l.airtimes[t.key]??0)+(e.airtimes[t.key]??0)}for(const e of s)l.shares[e.key]=l.total>0?l.counts[e.key]/l.total*100:0;n.push(l)}return n}(e,0,s),n={};for(const o of s)n[o.key]=[];for(const o of a)for(const e of s)if("share"===t){const t=o.total>0?(o.counts[e.key]??0)/o.total:0;n[e.key].push(t)}else{const t=o.airtimes[e.key]??0,s=o.bucketDurationMs>0?t/o.bucketDurationMs*100:0;n[e.key].push(s)}const i="share"===t?Math.max(5,Math.floor(20*a.length/e.length)):Math.max(10,Math.floor(60*a.length/e.length)),l={};for(const o of s)l[o.key]=ge(n[o.key],i);let r=0;if("stream"===t)for(let o=0;o<a.length;o++){let e=0;for(const t of s)e+=l[t.key][o]??0;e>r&&(r=e)}return a.map((e,a)=>{const n={timestamp:e.timestamp,time:e.time};if("share"===t){let e=0;for(const t of s)e+=l[t.key][a]??0;for(const t of s)n[t.key]=e>0?(l[t.key][a]??0)/e:0}else if("stream"===t)for(const t of s){const e=l[t.key][a]??0;n[t.key]=r>0?e/r:0}else for(const t of s)n[t.key]=l[t.key][a]??0;return n})}(p,o,u),[p,o,u]),g=t.useMemo(()=>{if("share"===o)return 100;let e=0;for(const t of f){let s=0;for(const e of u)s+=t[e.key]??0;s>e&&(e=s)}return Math.max(1,Math.ceil(1.1*e))},[o,f,u]),j=t.useCallback(e=>p.find(t=>t.timestamp===e),[p]),b=t.useMemo(()=>[d.chart1,d.chart2,d.chart3,d.chart4,d.chart5,d.chart6,d.chart7,d.chart8],[d]);return 0===a.length?e.jsxs("div",{className:"h-full flex items-center justify-center text-text-muted",children:[e.jsx(s,{className:"w-6 h-6 mr-2 opacity-50"}),e.jsx("span",{children:"No packet data available"})]}):e.jsxs("div",{className:"flex flex-col h-full min-h-0",children:[e.jsx("div",{className:"flex-1 min-h-0",children:e.jsx(Y,{width:"100%",height:"100%",minWidth:1,minHeight:1,children:e.jsxs(J,{data:f,margin:{top:4,right:8,bottom:0,left:0},stackOffset:"stream"===o?"wiggle":"none",children:[e.jsx(K,{strokeDasharray:"3 3",stroke:c.grid,vertical:!1}),e.jsx(Q,{dataKey:"timestamp",type:"number",domain:[n,i],axisLine:!1,tickLine:!1,tick:{fill:c.axisTick,fontSize:10,fontFamily:"'JetBrains Mono', monospace"},dy:8,tickCount:6,tickFormatter:e=>{const t=new Date(1e3*e),s=(i-n)/3600,a=t.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hour12:!1});return s>24?`${t.toLocaleDateString([],{weekday:"short"})} ${a}`:a}}),e.jsx(V,{domain:"share"===o||"stream"===o?[0,1]:[0,g],axisLine:!1,tickLine:!1,tick:{fill:c.axisTick,fontSize:10,fontFamily:"'JetBrains Mono', monospace"},dx:-8,width:40,tickFormatter:e=>"share"===o||"stream"===o?`${Math.round(100*e)}%`:`${e}%`}),e.jsx(Z,{content:({active:t,payload:s,label:a})=>{var n,i;const l=null==(i=null==(n=null==s?void 0:s[0])?void 0:n.payload)?void 0:i.timestamp,r=l?j(l):void 0;return e.jsx(je,{active:t,payload:s,label:a,mode:o,bucketData:r})},cursor:{stroke:c.cursor,strokeWidth:1}}),[...u].reverse().map((t,s)=>{const a=u.length-1-s,n=b[a%b.length];return e.jsx(ee,{type:"stepAfter",dataKey:t.key,name:t.label,stackId:"1",stroke:n,fill:n,fillOpacity:1,strokeWidth:"stream"===o?0:.5,strokeOpacity:.7,dot:!1,isAnimationActive:!1},t.key)})]})})}),e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:flex lg:flex-wrap items-center gap-x-3 gap-y-1 pt-2 lg:pl-10 type-data-xs flex-shrink-0",children:u.map((t,s)=>{const a=b[s%b.length];return e.jsxs("div",{className:"flex items-center gap-1 min-w-0",children:[e.jsx("div",{className:"w-2.5 h-2.5 rounded-sm flex-shrink-0",style:{backgroundColor:a}}),e.jsx("span",{className:"text-text-muted truncate",children:t.label})]},t.key)})})]})}),ve="airtimeSpectrumBlur";function Ne({active:t,payload:s,label:a}){if(!t||!s||0===s.length)return null;const n=s.filter(e=>null!==e.value&&void 0!==e.value);if(0===n.length)return null;const i=a?new Date(1e3*a).toLocaleString([],{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit",hour12:!1}):"";return e.jsxs("div",{className:"bg-tooltip-bg border border-border-subtle rounded-lg px-3 py-2 text-sm shadow-xl",children:[e.jsx("div",{className:"font-medium text-text-primary mb-1 font-mono",children:i}),n.map((t,s)=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-0.5",style:{backgroundColor:t.color}}),e.jsxs("span",{className:"text-text-muted",children:[t.name,":"]}),e.jsxs("span",{className:"text-text-primary tabular-nums font-mono",children:[Number(t.value).toFixed(2),"%"]})]},s))]})}function we({payload:t,showDensityScale:s=!1}){return t?e.jsxs("div",{className:"flex items-center gap-4 justify-start text-xs font-mono pl-11",children:[t.map((t,s)=>e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("div",{className:"w-4 h-0.5",style:{backgroundColor:t.color}}),e.jsx("span",{className:"text-text-muted",children:t.value})]},s)),s&&e.jsxs("div",{className:"flex items-center gap-1.5 ml-2",children:[e.jsx("div",{className:"w-16 h-2 rounded-sm",style:{background:"linear-gradient(to right, \n                rgb(1,26,51), \n                rgb(53,82,85), \n                rgb(85,121,74), \n                rgb(150,149,53), \n                rgb(228,168,98), \n                rgb(250,195,165)\n              )"}}),e.jsx("span",{className:"text-text-muted",children:"Density"})]})]}):null}const ke=[[1,26,51],[20,43,67],[38,62,79],[53,82,85],[67,102,83],[85,121,74],[112,137,62],[150,149,53],[192,156,58],[228,168,98],[250,195,165]];function Me(e){const t=Math.max(0,Math.min(1,e))*(ke.length-1),s=Math.floor(t),a=Math.min(s+1,ke.length-1),n=t-s;return`rgb(${Math.round(ke[s][0]+n*(ke[a][0]-ke[s][0]))},${Math.round(ke[s][1]+n*(ke[a][1]-ke[s][1]))},${Math.round(ke[s][2]+n*(ke[a][2]-ke[s][2]))})`}const Ce=t.memo(function({samples:s,startTs:n,endTs:i,yMax:l}){const r=O(),o=U(),c=t.useMemo(()=>void 0!==l?l:function(e){if(0===e.length)return 10;let t=0;for(const n of e){const e=n.rxRolling??n.rxUtilW;e>t&&(t=e)}const s=1.05*t,a=Math.ceil(s);return Math.max(1,a)}(s),[l,s]),d=o.critical,m=r.neutral,{cells:h,cellWidth:x,cellHeight:u}=t.useMemo(()=>function(e,t,s,a,n=120,i=30){const l=100/n+.5+"%",r=100/i+.5+"%";if(0===e.length||s<=t)return{cells:[],cellWidth:l,cellHeight:r};const o=s-t,c=i*n,d=new Float32Array(c),m=new Float32Array(c),h=(e,t)=>e*n+t;for(let y=0;y<e.length;y++){const l=e[y];if(l.timestamp<t||l.timestamp>s)continue;const r=Math.floor((l.timestamp-t)/o*(n-1)),c=Math.max(0,Math.min(n-1,r));if(l.rxUtilW>0){const e=Math.min(l.rxUtilW/a,1),t=Math.floor((1-e)*(i-1));for(let s=t;s<i;s++){const e=i-1-t,a=e>0?1-(s-t)/e*.7:1;d[h(s,c)]+=a}}if(l.txUtilW>0){const e=Math.min(l.txUtilW/a,1),t=Math.floor((1-e)*(i-1));for(let s=t;s<i;s++){const e=i-1-t,a=e>0?1-(s-t)/e*.7:1;m[h(s,c)]+=a}}}const x=[];for(let y=0;y<c;y++)d[y]>0&&x.push(d[y]),m[y]>0&&x.push(m[y]);x.sort((e,t)=>e-t);const u=x.length>0?x[Math.floor(.95*x.length)]:1,p=new Array(n),f=new Array(i),g=100/n,j=100/i;for(let y=0;y<n;y++)p[y]=y*g+"%";for(let y=0;y<i;y++)f[y]=y*j+"%";const b=[];for(let y=0;y<i;y++)for(let e=0;e<n;e++){const t=h(y,e),s=d[t]+.3*m[t];if(s>0&&u>0){const t=Math.min(s/u,1.5),a=Math.sqrt(t/1.5);b.push({xPct:p[e],yPct:f[y],intensity:a})}}return{cells:b,cellWidth:l,cellHeight:r}}(s,n,i,100,200,20),[s,n,i]),p=t.useMemo(()=>0===s.length?[]:s.filter(e=>"number"==typeof e.timestamp&&!isNaN(e.timestamp)).map(e=>{const t=e.rxRolling??e.rxUtilW,s=e.txRolling??e.txUtilW;return{timestamp:e.timestamp,rx:"number"!=typeof t||isNaN(t)?0:t,tx:"number"!=typeof s||isNaN(s)?0:s}}),[s]),f=t.useMemo(()=>{const e=i-n,t=e/3600;return[0,.25,.5,.75,1].map(s=>{const a=new Date(1e3*(n+e*s)),i=a.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hour12:!1}),l=a.toLocaleDateString([],{weekday:"short"});return{pct:s,label:t>24?`${l} ${i}`:i}})},[n,i]);return 0===s.length?e.jsx("div",{className:"h-full flex items-center justify-center text-text-muted",children:"No traffic data available"}):e.jsxs("div",{className:"flex flex-col h-full min-h-0",children:[e.jsx("div",{className:"flex items-center flex-shrink-0 text-text-muted",style:{height:20,paddingLeft:44,paddingRight:8},children:e.jsx("div",{className:"relative w-full h-full flex items-center",children:f.map((t,s)=>e.jsxs("div",{className:"absolute flex items-center gap-1 type-data-xs",style:{left:100*t.pct+"%",transform:0===t.pct?"translateX(0)":1===t.pct?"translateX(-100%)":"translateX(-50%)"},children:[e.jsx(a,{className:"w-2.5 h-2.5 opacity-60"}),e.jsx("span",{className:"tabular-nums",children:t.label})]},s))})}),e.jsx("div",{className:"relative",style:{height:160},children:e.jsx(Y,{width:"100%",height:160,minWidth:1,minHeight:1,children:e.jsxs(te,{data:p,margin:{top:4,right:8,bottom:0,left:0},children:[e.jsx(K,{strokeDasharray:"3 3",stroke:"rgba(255,255,255,0.04)",vertical:!1}),e.jsx(Q,{dataKey:"timestamp",type:"number",domain:[n,i],axisLine:!1,tickLine:!1,tick:!1,height:0}),e.jsx(V,{axisLine:!1,tickLine:!1,tick:{fill:"rgba(255,255,255,0.4)",fontSize:10,fontFamily:"'JetBrains Mono', monospace"},dx:-8,width:44,tickFormatter:e=>`${e.toFixed(0)}%`,domain:[0,c]}),e.jsx(Z,{content:e.jsx(Ne,{})}),e.jsx(se,{type:"linear",dataKey:"rx",name:"RX Avg",stroke:d,strokeWidth:2.5,strokeOpacity:.9,dot:!1,connectNulls:!1,isAnimationActive:!1}),e.jsx(se,{type:"linear",dataKey:"tx",name:"TX Avg",stroke:m,strokeWidth:2.5,strokeOpacity:.9,dot:!1,connectNulls:!1,isAnimationActive:!1})]})})}),e.jsx("div",{className:"relative overflow-hidden",style:{height:32,marginLeft:44,marginRight:8},children:e.jsxs("svg",{className:"absolute inset-0 w-full h-full",preserveAspectRatio:"none","aria-hidden":"true",children:[e.jsx("defs",{children:e.jsx("filter",{id:ve,x:"-100%",y:"-100%",width:"300%",height:"300%",children:e.jsx("feGaussianBlur",{in:"SourceGraphic",stdDeviation:"1 3"})})}),e.jsx("g",{filter:`url(#${ve})`,children:h.map((t,s)=>e.jsx("rect",{x:t.xPct,y:t.yPct,width:x,height:u,fill:Me(t.intensity),opacity:.9},`cell-${s}`))})]})}),e.jsx("div",{className:"flex-shrink-0",style:{height:24,marginTop:8},children:e.jsx(we,{payload:[{value:"RX Avg",color:d},{value:"TX Avg",color:m}],showDensityScale:!0})})]})}),Se={"1x":1,"2x":2,"4x":4,"8x":8,"16x":16,"36x":36},$e="rgba(255,255,255,0.08)",Te=[1,5,10,25,50,100,150];function Pe(e,t,s,a){const n=Math.PI/180,i=(a-t)*n,l=e*n,r=s*n,o=Math.sin(i)*Math.cos(r),c=Math.cos(l)*Math.sin(r)-Math.sin(l)*Math.cos(r)*Math.cos(i);return(180*Math.atan2(o,c)/Math.PI+360)%360}function Re(e,t,s,a){const n=Math.PI/180,i=(s-e)*n,l=(a-t)*n,r=Math.sin(i/2)**2+Math.cos(e*n)*Math.cos(s*n)*Math.sin(l/2)**2;return 12742*Math.atan2(Math.sqrt(r),Math.sqrt(1-r))}const Fe=[{min:10,label:"Excellent"},{min:7,label:"Very Good"},{min:4,label:"Good"},{min:1,label:"Fair+"},{min:-2,label:"Fair"},{min:-5,label:"Fair-"},{min:-8,label:"Poor"},{min:-11,label:"Bad"},{min:-1/0,label:"Critical"}];function Ee(e,t){return t[X(e)]||"#808080"}const Ae=t.memo(function({neighbors:s,quickNeighbors:a,localLat:i,localLon:l,onStatsChange:r}){const[o,c]=t.useState(null),[d,m]=t.useState(new Set),[h,x]=t.useState({width:0,height:0}),[u,p]=t.useState("1x"),[f,g]=t.useState(1),j=t.useRef(null),b=t.useRef({}),y=t.useRef(null),v=t.useRef(null),N=t.useRef(f);N.current=f;const w=q(),k=U(),M=B();t.useEffect(()=>{const e=v.current;if(!e)return;const t=new ResizeObserver(e=>{for(const t of e){const{width:e,height:s}=t.contentRect;e>0&&s>0&&x({width:e,height:s})}});t.observe(e);const s=e.getBoundingClientRect();return s.width>0&&s.height>0&&x({width:s.width,height:s.height}),()=>t.disconnect()},[]);const C=t.useMemo(()=>{const e=new Set;if(a)for(const t of a)e.add(t.hash);return e},[a]),S=t.useMemo(()=>{const e=new Map;if(a)for(const t of a)e.set(t.hash,{snr:t.avgSnr,rssi:t.avgRssi});return e},[a]),{processedNeighbors:$,maxDistance:T,totalNeighbors:P,zeroHopCount:R}=t.useMemo(()=>{const e=[];for(const[a,n]of Object.entries(s)){if(!n.latitude||!n.longitude||0===n.latitude||0===n.longitude)continue;if(!C.has(a))continue;const t=Pe(i,l,n.latitude,n.longitude),s=Re(i,l,n.latitude,n.longitude),r=S.get(a);e.push({hash:a.slice(0,8),name:n.node_name||n.name||"Unknown",snr:(null==r?void 0:r.snr)??n.snr??null,rssi:(null==r?void 0:r.rssi)??n.rssi??null,bearing:t,distance:s,normalizedDistance:0,lastSeen:n.last_seen,isZeroHop:!0})}const t=e.length>0?Math.max(...e.map(e=>e.distance)):0;return e.sort((e,t)=>(e.snr??-1/0)-(t.snr??-1/0)),{processedNeighbors:e,maxDistance:t,totalNeighbors:e.length,zeroHopCount:e.length}},[s,i,l,C,S]);t.useEffect(()=>{null==r||r({zeroHopCount:R,totalCount:P,maxDistanceKm:T})},[R,P,T]),t.useEffect(()=>{const e=Se[u],t=N.current;j.current&&cancelAnimationFrame(j.current);const s=performance.now(),a=n=>{const i=n-s,l=Math.min(i/400,1),r=(o=l)<.5?8*o*o*o*o:1-Math.pow(-2*o+2,4)/2;var o;g(t+(e-t)*r),j.current=l<1?requestAnimationFrame(a):null};return j.current=requestAnimationFrame(a),()=>{j.current&&cancelAnimationFrame(j.current)}},[u]);const F=T/f,E=t.useMemo(()=>Te.filter(e=>e<=1.1*F),[F]);t.useEffect(()=>{const e=[];for(const s of $){const t=b.current[s.hash];void 0!==t&&t!==s.lastSeen&&e.push(s.hash),b.current[s.hash]=s.lastSeen}if(0===e.length)return;queueMicrotask(()=>{m(t=>new Set([...t,...e]))});const t=setTimeout(()=>{m(t=>{const s=new Set(t);return e.forEach(e=>s.delete(e)),s})},600);return()=>clearTimeout(t)},[$]);const A=0!==i&&0!==l,L=t.useMemo(()=>{const{width:e,height:t}=h,s=e/2,a=t/2,n=Math.max(10,e/2-12),i=Math.max(10,t/2-12);return{width:e,height:t,centerX:s,centerY:a,maxRadiusX:n,maxRadiusY:i,cornerRadius:.2*Math.min(n,i)}},[h]),{width:W,height:D,centerX:_,centerY:H,maxRadiusX:z,maxRadiusY:O,cornerRadius:X}=L,I=t.useCallback((e,t=1)=>{const s=z*t,a=O*t,n=Math.min(X*t,s,a),i=(e%360+360)%360,l=i*Math.PI/180,r=180*Math.atan2(a-n,s-n)/Math.PI;let o,c;if(i<=45-r||i>315+r){const e=Math.tan(l);o=Math.max(_-s+n,Math.min(_+s-n,_+a*e*(s/a))),c=H-a}else if(i>45-r&&i<=45+r)o=_+s-n+n*Math.sin(l),c=H-a+n-n*Math.cos(l);else if(i>45+r&&i<=135-r){const e=1/Math.tan(l);c=Math.max(H-a+n,Math.min(H+a-n,H-s*e*(a/s))),o=_+s}else if(i>135-r&&i<=135+r)o=_+s-n+n*Math.sin(l),c=H+a-n-n*Math.cos(l);else if(i>135+r&&i<=225-r){const e=Math.tan(l);o=Math.max(_-s+n,Math.min(_+s-n,_-a*e*(s/a))),c=H+a}else if(i>225-r&&i<=225+r)o=_-s+n+n*Math.sin(l),c=H+a-n-n*Math.cos(l);else if(i>225+r&&i<=315-r){const e=1/Math.tan(l);c=Math.max(H-a+n,Math.min(H+a-n,H-s*e*(a/s))),o=_-s}else o=_-s+n+n*Math.sin(l),c=H-a+n-n*Math.cos(l);return{x:o,y:c}},[_,H,z,O,X]),Y=t.useCallback((e,t)=>{const s=I(e,1);return{x:_+(s.x-_)*t,y:H+(s.y-H)*t}},[I,_,H]),G=t.useCallback((e,t)=>{const s=I(e,1),a=Math.hypot(s.x-_,s.y-H);if(a<=0)return Math.min(t,.97);const n=Math.min(12/a,.08),i=Math.min(t,1-n,.97);return Math.max(0,i)},[I,_,H]),J=t.useCallback(e=>({N:{x:_,y:H-O},S:{x:_,y:H+O},E:{x:_+z,y:H},W:{x:_-z,y:H},NE:{x:_+z,y:H-O},SE:{x:_+z,y:H+O},SW:{x:_-z,y:H+O},NW:{x:_-z,y:H-O}}[e]),[_,H,z,O]),K=t.useCallback(e=>{const t=z*e,s=O*e,a=Math.min(X*e,t,s),n=_-t,i=_+t,l=H-s,r=H+s;return[`M ${n+a} ${l}`,`L ${i-a} ${l}`,`Q ${i} ${l} ${i} ${l+a}`,`L ${i} ${r-a}`,`Q ${i} ${r} ${i-a} ${r}`,`L ${n+a} ${r}`,`Q ${n} ${r} ${n} ${r-a}`,`L ${n} ${l+a}`,`Q ${n} ${l} ${n+a} ${l}`,"Z"].join(" ")},[_,H,z,O,X]),Q=t.useCallback(e=>{c(e)},[]),V=t.useCallback(e=>{p(e)},[]),Z=t.useCallback(e=>T<=0?0:e/T*f,[T,f]),ee=e=>`${e}km`,te=t.useMemo(()=>{const e=E.map(e=>{const t=e/T*f;return{km:e,scale:t,labelY:H-O*t*.71}}).filter(e=>e.scale<=1.05&&e.scale>=.02).sort((e,t)=>t.km-e.km),t=[];for(const s of e)t.some(e=>Math.abs(e.labelY-s.labelY)<28)||t.push(s);return t},[E,T,f,H,O]),se=h.width>0&&h.height>0;return A?0===P?e.jsxs("div",{ref:y,className:"flex flex-col items-center justify-center h-full text-text-muted",children:[e.jsx(n,{className:"w-8 h-8 mb-2 opacity-50"}),e.jsx("p",{children:"No nodes with location data"})]}):e.jsxs("div",{ref:y,className:"relative h-full w-full flex overflow-hidden",children:[e.jsx("div",{ref:v,className:"relative flex-1 min-w-0 h-full",children:se&&e.jsxs("svg",{width:W,height:D,className:"absolute inset-0 z-0",children:[e.jsxs("defs",{children:[e.jsx("style",{children:"\n                @keyframes neighbor-blink-scale {\n                  0%, 100% {\n                    transform: scale(1);\n                    opacity: 0;\n                  }\n                  50% {\n                    transform: scale(1.3);\n                    opacity: 0.8;\n                  }\n                }\n                .neighbor-blink-ring {\n                  transform-origin: center;\n                  animation: neighbor-blink-scale 600ms ease-out forwards;\n                }\n              "}),e.jsx("clipPath",{id:"radar-clip",children:e.jsx("path",{d:K(1)})})]}),E.map(t=>{const s=Z(t);if(s>1.05||s<.02)return null;const a=te.some(e=>e.km===t),n=_+z*s*.71,i=H-O*s*.71;return e.jsxs("g",{children:[e.jsx("path",{d:K(s),fill:"none",stroke:$e,strokeWidth:1}),a&&e.jsx("text",{x:n+4,y:i-2,textAnchor:"start",dominantBaseline:"auto",className:"fill-text-secondary",fontSize:10,fontFamily:"'JetBrains Mono', monospace",children:ee(t)})]},`ring-${t}`)}),["N","E","S","W"].map(t=>{const s="N"===t||"S"===t,a=s?_:"E"===t?_+z:_-z,n=s?"N"===t?H-O:H+O:H;return e.jsx("line",{x1:_,y1:H,x2:a,y2:n,stroke:$e,strokeWidth:1,strokeDasharray:"4 4"},t)}),["NE","SE","SW","NW"].map(t=>{const s=J(t);return e.jsx("line",{x1:_,y1:H,x2:s.x,y2:s.y,stroke:$e,strokeWidth:1,strokeDasharray:"4 4",strokeOpacity:.5},`diag-${t}`)}),["N","E","S","W"].map(t=>{const s=J(t),a="E"===t?"end":"W"===t?"start":"middle",n="N"===t?"hanging":"S"===t?"auto":"middle";return e.jsx("text",{x:s.x,y:s.y,textAnchor:a,dominantBaseline:n,fill:k.critical,fontSize:16,fontWeight:600,fontFamily:"'JetBrains Mono', monospace","aria-hidden":"true",children:t},t)}),["NE","SE","SW","NW"].map(t=>{const s=J(t),a="NE"===t||"SE"===t?"end":"start",n="NE"===t||"NW"===t?"hanging":"auto";return e.jsx("text",{x:s.x,y:s.y,textAnchor:a,dominantBaseline:n,fill:k.critical,fontSize:16,fontWeight:600,fontFamily:"'JetBrains Mono', monospace","aria-hidden":"true",children:t},t)}),e.jsx("circle",{cx:_,cy:H,r:5,fill:M.chart6,stroke:"rgba(255,255,255,0.3)",strokeWidth:1,role:"img","aria-label":"Local node"}),e.jsx("g",{clipPath:"url(#radar-clip)",children:$.map(t=>{const s=T>0?t.distance/T*f:0;if(s>1)return null;const a=G(t.bearing,s),{x:n,y:i}=Y(t.bearing,a),l=null!==t.snr?Ee(t.snr,w):"#808080",r=(null==o?void 0:o.hash)===t.hash,c=d.has(t.hash);return e.jsxs("g",{role:"img","aria-label":`${t.name}: ${t.distance.toFixed(1)}km ${t.bearing.toFixed(0)}°`,children:[c&&e.jsx("circle",{cx:n,cy:i,r:10.5,fill:"none",stroke:"rgba(255,255,255,0.9)",strokeWidth:2,className:"neighbor-blink-ring"}),r&&e.jsx("circle",{cx:n,cy:i,r:10.5,fill:l,opacity:.3}),e.jsx("circle",{cx:n,cy:i,r:r?7:5,fill:l,stroke:"rgba(0,0,0,0.5)",strokeWidth:1,style:{cursor:"pointer",transition:"r 0.15s"},onMouseEnter:()=>Q(t),onMouseLeave:()=>Q(null)})]},t.hash)})})]})}),e.jsx("div",{className:"flex flex-col h-full items-stretch gap-1 py-2 pl-2 flex-shrink-0",role:"group","aria-label":"Zoom level",children:["1x","2x","4x","8x","16x","36x"].map(t=>e.jsx("button",{onClick:()=>V(t),"aria-pressed":u===t,className:"flex flex-1 items-center justify-center px-1.5 text-xs font-medium rounded transition-colors "+(u===t?"bg-accent-primary/20 text-accent-primary":"bg-white/5 text-text-muted hover:bg-white/10 hover:text-text-secondary"),children:t},t))}),o&&e.jsxs("div",{className:"absolute bg-tooltip-bg border border-border-subtle rounded-lg px-3 py-2 text-sm pointer-events-none z-10 shadow-xl",style:{left:"50%",bottom:8,transform:"translateX(-50%)"},children:[e.jsx("div",{className:"font-medium text-text-primary",children:o.name}),e.jsx("div",{className:"text-text-muted text-xs font-mono",children:o.hash}),null!==o.snr?e.jsx("div",{className:"flex gap-3 mt-1 text-xs",children:e.jsxs("span",{children:[e.jsx("span",{className:"text-text-muted",children:"SNR:"})," ",e.jsxs("span",{className:"tabular-nums",style:{color:Ee(o.snr,w)},children:[o.snr.toFixed(1)," dB"]}),e.jsxs("span",{className:"text-text-muted ml-1",children:["(",(ae=o.snr,(null==(ne=Fe.find(e=>ae>=e.min))?void 0:ne.label)??"Critical"),")"]})]})}):e.jsx("div",{className:"text-xs text-text-muted mt-1",children:"No SNR data"}),e.jsxs("div",{className:"flex gap-3 text-xs",children:[e.jsxs("span",{children:[e.jsx("span",{className:"text-text-muted",children:"Distance:"})," ",e.jsxs("span",{className:"tabular-nums text-text-secondary",children:[o.distance.toFixed(2)," km"]})]}),e.jsxs("span",{children:[e.jsx("span",{className:"text-text-muted",children:"Bearing:"})," ",e.jsxs("span",{className:"tabular-nums text-text-secondary",children:[o.bearing.toFixed(0),"°"]})]})]})]})]}):e.jsxs("div",{ref:y,className:"flex flex-col items-center justify-center h-full text-text-muted",children:[e.jsx(n,{className:"w-8 h-8 mb-2 opacity-50"}),e.jsx("p",{children:"Local node coordinates not configured"}),e.jsx("p",{className:"text-xs mt-1",children:"Set latitude/longitude in config to enable"})]});var ae,ne});function Le(e,t){if(0===e.length)return 0;const s=t/100*(e.length-1),a=Math.floor(s),n=Math.ceil(s);return a===n?e[a]:e[a]+(e[n]-e[a])*(s-a)}const We=t.memo(function({timestamps:s,values:a,onStatsChange:n}){var r,o;const c=U(),[d,m]=t.useState(!0),h=t.useMemo(()=>{if(0===a.length)return null;const e=Math.min(...a),t=Math.max(...a),s=a.reduce((e,t)=>e+t,0)/a.length,n=[...a].sort((e,t)=>e-t);return{min:e,max:t,avg:s,p5:Le(n,5),p95:Le(n,95)}},[a]);t.useEffect(()=>{null==n||n(h)},[h]);const x=t.useCallback(()=>{m(e=>!e)},[]),{heatmapData:u,xLabels:p,yLabels:f}=t.useMemo(()=>{if(0===s.length||0===a.length||!h)return{heatmapData:null,xLabels:[],yLabels:[]};let e,t;if(d){const s=.1*(h.p95-h.p5||1);e=h.p5-s,t=h.p95+s}else{const s=.1*(h.max-h.min||1);e=h.min-s,t=h.max+s}const n=t-e,i=s[0],l=s[s.length-1]-i||1,r=new Float32Array(2*s.length);for(let d=0;d<s.length;d++){const o=(s[d]-i)/l,c=1-(Math.max(e,Math.min(t,a[d]))-e)/n;r[2*d]=o,r[2*d+1]=c}const o=[];for(let s=0;s<=5;s++){const e=i+l*s/5;o.push({pos:s/5*100,label:new Date(1e3*e).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})}const c=[];for(let s=0;s<=4;s++){const t=e+n*s/4;c.push({pos:100*(1-s/4),label:`${Math.round(t)}`})}return{heatmapData:{points:r,count:s.length},xLabels:o,yLabels:c}},[s,a,h,d]),g=t.useRef(null),j=t.useRef(null),[b,y]=t.useState({width:0,height:0}),v=c.critical,N=t.useMemo(()=>{const e=v.replace("#","");return{r:parseInt(e.slice(0,2),16),g:parseInt(e.slice(2,4),16),b:parseInt(e.slice(4,6),16)}},[v]);return t.useEffect(()=>{const e=j.current;if(!e)return;const t=new ResizeObserver(e=>{for(const t of e){const{width:e,height:s}=t.contentRect;e>0&&s>0&&y({width:e,height:s})}});t.observe(e);const s=e.getBoundingClientRect();return s.width>0&&s.height>0&&y({width:s.width,height:s.height}),()=>t.disconnect()},[]),t.useEffect(()=>{const e=g.current;if(!e||!u||0===b.width)return;const t=e.getContext("2d");if(!t)return;const{width:s,height:a}=b,n=window.devicePixelRatio||1;e.width=s*n,e.height=a*n,e.style.width=`${s}px`,e.style.height=`${a}px`,t.scale(n,n),t.clearRect(0,0,s,a);const{points:i,count:l}=u,{r:r,g:o,b:c}=N,d=l/s,m=Math.max(1,Math.min(4,s/l*2)),h=Math.max(2,a/50),x=d>10?.3:d>2?.5:.7;t.fillStyle=`rgba(${r}, ${o}, ${c}, ${x})`;for(let u=0;u<l;u++){const e=i[2*u]*s,n=i[2*u+1]*a;t.fillRect(e,n,m,h)}},[u,b,N]),u?e.jsxs("div",{className:"relative w-full h-full",role:"img","aria-label":`RF noise floor heatmap showing values from ${(null==(r=null==h?void 0:h.min)?void 0:r.toFixed(0))??"N/A"} to ${(null==(o=null==h?void 0:h.max)?void 0:o.toFixed(0))??"N/A"} dBm`,children:[e.jsx("div",{className:"absolute top-0 left-0 flex flex-col justify-between",style:{width:32,bottom:20},"aria-hidden":"true",children:f.map((t,s)=>e.jsx("span",{className:"type-data-xs text-text-muted tabular-nums text-right pr-1.5",style:{position:"absolute",top:`${t.pos}%`,transform:"translateY(-50%)",right:0},children:t.label},s))}),e.jsxs("div",{ref:j,className:"absolute overflow-hidden",style:{left:32,right:0,top:0,bottom:20},children:[e.jsx("svg",{className:"absolute inset-0 w-full h-full",preserveAspectRatio:"none","aria-hidden":"true",children:[0,25,50,75,100].map(t=>e.jsx("line",{x1:"0",y1:`${t}%`,x2:"100%",y2:`${t}%`,stroke:"rgba(255,255,255,0.06)",strokeDasharray:"3 3"},t))}),e.jsx("canvas",{ref:g,className:"absolute inset-0 w-full h-full","aria-hidden":"true"}),e.jsx("button",{type:"button",onClick:x,className:"absolute bottom-1 right-1 p-1.5 rounded bg-tooltip-bg/80 hover:bg-tooltip-bg active:bg-tooltip-bg transition-colors touch-manipulation",title:d?"Show full range (min/max)":"Show trimmed range (P5-P95)","aria-label":d?"Expand to show full data range":"Shrink to show trimmed percentile range","aria-pressed":!d,children:d?e.jsx(i,{className:"w-3.5 h-3.5 text-text-muted","aria-hidden":"true"}):e.jsx(l,{className:"w-3.5 h-3.5 text-text-muted","aria-hidden":"true"})})]}),e.jsx("div",{className:"absolute left-0 right-0 bottom-0",style:{left:32,height:20},"aria-hidden":"true",children:p.map((t,s)=>e.jsx("span",{className:"type-data-xs text-text-muted tabular-nums absolute top-1",style:{left:`${t.pos}%`,transform:"translateX(-50%)"},children:t.label},s))})]}):e.jsx("div",{className:"h-full flex items-center justify-center text-text-muted",children:"No noise floor data available"})}),De={repeater:"var(--signal-critical)",companion:"var(--accent-tertiary)",room_server:"var(--accent-secondary)"};function _e(e){if(e.contact_type){const t=e.contact_type.toLowerCase();if("repeater"===t||"rep"===t)return"repeater";if("room server"===t||"room_server"===t||"room"===t||"server"===t)return"room_server";if("companion"===t||"client"===t||"cli"===t)return"companion"}return e.is_repeater?"repeater":"companion"}const He=t.memo(function({neighbors:s}){const a=t.useMemo(()=>{const e={repeater:0,companion:0,room_server:0};for(const a of Object.values(s)){const t=_e(a);e[t]=(e[t]||0)+1}const t=Object.values(e).reduce((e,t)=>e+t,0);return{items:[{label:"Repeaters",count:e.repeater,percent:0,color:De.repeater},{label:"Companions",count:e.companion,percent:0,color:De.companion},{label:"Room Servers",count:e.room_server,percent:0,color:De.room_server}].map(e=>({...e,percent:t>0?e.count/t*100:0})).filter(e=>e.count>0).sort((e,t)=>t.count-e.count),total:t}},[s]);return 0===a.total?e.jsx("div",{className:"h-full flex items-center justify-center text-text-muted type-body-sm",children:"No neighbors discovered yet"}):e.jsxs("div",{className:"h-full flex flex-col",children:[e.jsx("div",{className:"flex-1 flex flex-col justify-evenly",children:a.items.map(t=>e.jsxs("div",{className:"flex flex-col gap-1.5",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"type-data-sm text-text-secondary",children:t.label}),e.jsxs("span",{className:"type-data-sm text-text-muted tabular-nums",children:[t.count," ",e.jsxs("span",{className:"text-text-muted/60",children:["(",t.percent.toFixed(0),"%)"]})]})]}),e.jsx("div",{className:"h-2.5 bg-bg-elevated rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full rounded-full transition-all duration-500 ease-out",style:{width:`${t.percent}%`,backgroundColor:t.color,minWidth:t.count>0?"4px":"0"}})})]},t.label))}),e.jsxs("div",{className:"flex items-center justify-between pt-2 border-t border-border-subtle",children:[e.jsx("span",{className:"type-data-xs text-text-muted",children:"Total Nodes"}),e.jsx("span",{className:"type-data-sm text-text-primary font-medium tabular-nums",children:a.total})]})]})});function ze(e,t,s,a=!0,n=60){const i=new Map(e.map(e=>[e.start,e])),l=new Map(t.map(e=>[e.start,e])),r=Array.from(new Set([...i.keys(),...l.keys()])).sort((e,t)=>e-t).map(e=>{const t=i.get(e),a=l.get(e);return{timestamp:e,rxUtilW:((null==t?void 0:t.airtime_ms)??0)/s*100,txUtilW:((null==a?void 0:a.airtime_ms)??0)/s*100}});return a&&r.length>1?function(e,t=60){if(0===e.length)return[];const s=1-Math.pow(.5,1/t),a=Math.min(e.length,Math.max(10,Math.floor(t/3)));let n=0,i=0;for(let l=0;l<a;l++)n+=e[l].rxUtilW,i+=e[l].txUtilW;return n/=a,i/=a,e.map(e=>(n=s*e.rxUtilW+(1-s)*n,i=s*e.txUtilW+(1-s)*i,{...e,rxRolling:n,txRolling:i}))}(r,n):r}const Be={excellent:"text-signal-excellent",good:"text-signal-good",fair:"text-signal-fair",poor:"text-signal-critical"},Oe={excellent:"bg-signal-excellent/10",good:"bg-signal-good/10",fair:"bg-signal-fair/10",poor:"bg-signal-critical/10"};function Ue({value:t,status:s}){const a={excellent:"bg-signal-excellent",good:"bg-signal-good",fair:"bg-signal-fair",poor:"bg-signal-critical"}[s];return e.jsx("div",{className:"w-full h-2 bg-surface-elevated rounded-full overflow-hidden",children:e.jsx("div",{className:`h-full ${a} transition-all duration-300`,style:{width:`${Math.min(100,Math.max(0,t))}%`}})})}function qe(){const s=M(),a=C(),[n,i]=t.useState(null),l=t.useCallback((e,t)=>{i({prefix:e,candidateHashes:t})},[]),m=t.useCallback(()=>{i(null)},[]);if(!a)return e.jsxs(ae,{children:[e.jsx(ne,{icon:e.jsx(r,{}),title:"Prefix Conflicts",largeTitle:!0}),e.jsx("div",{className:"flex-1 flex items-center justify-center",children:e.jsxs("div",{className:"text-center text-text-muted",children:[e.jsx(o,{className:"w-8 h-8 mx-auto mb-2 opacity-50"}),e.jsx("p",{className:"type-data-xs",children:"No topology data available"}),e.jsx("p",{className:"type-data-xs opacity-70",children:"Run deep analysis to see stats"})]})})]});const h=(x=s.avgConfidence)>=.9?"excellent":x>=.7?"good":x>=.5?"fair":"poor";var x;const u=(p=s.collisionRate)<=10?"excellent":p<=25?"good":"poor";var p;const f="poor"===h||"poor"===u?"poor":"fair"===h||"fair"===u?"fair":"good"===h||"good"===u?"good":"excellent",g="excellent"===f||"good"===f?c:d;return e.jsxs(ae,{className:"flex flex-col overflow-hidden",children:[e.jsx(ne,{icon:e.jsx(r,{}),title:"Prefix Conflicts",largeTitle:!0,actions:e.jsxs("div",{className:`flex items-center gap-1.5 px-2.5 py-1 rounded-full ${Oe[f]}`,children:[e.jsx(g,{className:`w-3.5 h-3.5 ${Be[f]}`}),e.jsx("span",{className:`type-data-xs font-medium ${Be[f]}`,children:"excellent"===f?"Excellent":"good"===f?"Good":"fair"===f?"Fair":"Needs Attention"})]})}),e.jsxs("div",{className:"flex-1 overflow-y-auto min-h-0",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-3 mb-3",children:[e.jsxs("div",{className:"cursor-help",title:"Average confidence score across all disambiguated prefixes. Higher = more certain node identification. Based on geographic proximity, co-occurrence patterns, and observation recency.",children:[e.jsxs("div",{className:"flex items-baseline justify-between mb-1",children:[e.jsx("span",{className:"type-data-xs text-text-muted",children:"Avg Confidence"}),e.jsxs("span",{className:`type-data-lg font-semibold ${Be[h]}`,children:[(100*s.avgConfidence).toFixed(1),"%"]})]}),e.jsx(Ue,{value:100*s.avgConfidence,status:h})]}),e.jsxs("div",{className:"cursor-help",title:"Percentage of 2-character prefixes that match multiple known nodes. Lower is better. Collisions require disambiguation to determine the correct node.",children:[e.jsxs("div",{className:"flex items-baseline justify-between mb-1",children:[e.jsx("span",{className:"type-data-xs text-text-muted",children:"Collision Rate"}),e.jsxs("span",{className:`type-data-lg font-semibold ${Be[u]}`,children:[s.collisionRate.toFixed(1),"%"]})]}),e.jsx(Ue,{value:s.collisionRate,status:u})]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-2 mb-3 py-2 border-t border-b border-border-subtle",children:[e.jsxs("div",{className:"text-center cursor-help",title:"Total unique 2-character prefixes observed in packet paths. Each prefix represents the first 2 hex digits of a node's full hash.",children:[e.jsx("div",{className:"type-data-lg font-semibold text-text-primary",children:s.totalPrefixes}),e.jsx("div",{className:"type-data-xs text-text-muted",children:"Prefixes"})]}),e.jsxs("div",{className:"text-center cursor-help",title:"Prefixes that map to exactly one known node. No disambiguation needed—these are definitive identifications.",children:[e.jsx("div",{className:"type-data-lg font-semibold text-signal-good",children:s.unambiguousPrefixes}),e.jsx("div",{className:"type-data-xs text-text-muted",children:"Unique"})]}),e.jsxs("div",{className:"text-center cursor-help",title:"Prefixes matching multiple known nodes. Click a prefix below to explore candidates and see how disambiguation scores them.",children:[e.jsx("div",{className:"type-data-lg font-semibold "+(s.collisionPrefixes>0?"text-signal-critical":"text-text-primary"),children:s.collisionPrefixes}),e.jsx("div",{className:"type-data-xs "+(s.collisionPrefixes>0?"text-signal-critical":"text-text-muted"),children:"Collisions"})]})]}),s.highCollisionPrefixes.length>0&&e.jsxs("div",{className:"mb-2",children:[e.jsx("div",{className:"type-data-xs text-text-muted mb-1.5",children:"Highest Collisions"}),e.jsx("div",{className:"flex flex-wrap gap-1",children:s.highCollisionPrefixes.map(({prefix:t,candidateCount:s,candidateHashes:a})=>e.jsxs("button",{type:"button",onClick:()=>l(t,a),className:"inline-flex items-center gap-1 px-1.5 py-0.5 min-h-[24px] rounded bg-surface-elevated text-text-secondary type-data-xs font-mono hover:bg-signal-critical/20 hover:text-signal-critical focus:outline-none focus:ring-2 focus:ring-signal-critical/50 transition-colors cursor-pointer touch-manipulation",title:`Click to explore ${s} candidates matching this prefix`,"aria-label":`Explore prefix ${t} with ${s} colliding candidates`,children:[t,e.jsxs("span",{className:"text-signal-critical",children:["×",s]})]},t))})]}),s.lowConfidencePrefixes.length>0&&e.jsx("div",{className:"mt-auto pt-2 border-t border-border-subtle",children:e.jsxs("div",{className:"flex items-start gap-1.5",children:[e.jsx(d,{className:"w-3.5 h-3.5 text-signal-critical mt-0.5 flex-shrink-0"}),e.jsxs("div",{className:"min-w-0",children:[e.jsxs("div",{className:"type-data-xs text-signal-critical font-medium",children:[e.jsx("span",{className:"text-signal-critical",children:s.lowConfidencePrefixes.length})," prefix",1!==s.lowConfidencePrefixes.length?"es":""," with low confidence"]}),e.jsxs("div",{className:"type-data-xs text-text-muted font-mono truncate",children:[s.lowConfidencePrefixes.slice(0,5).join(", "),s.lowConfidencePrefixes.length>5&&e.jsxs("span",{className:"text-signal-critical",children:[" +",s.lowConfidencePrefixes.length-5," more"]})]})]})]})}),0===s.lowConfidencePrefixes.length&&0===s.collisionPrefixes&&e.jsx("div",{className:"mt-auto pt-2 border-t border-border-subtle",children:e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(c,{className:"w-3.5 h-3.5 text-signal-excellent"}),e.jsx("span",{className:"type-data-xs text-signal-excellent",children:"All prefixes uniquely identified"})]})})]}),e.jsx(re,{isOpen:!!n,prefix:(null==n?void 0:n.prefix)||"",candidateHashes:(null==n?void 0:n.candidateHashes)||[],onClose:m})]})}function Xe({icon:t,label:s,value:a,sublabel:n,highlight:i,tooltip:l}){return e.jsxs("div",{className:"flex items-center justify-between py-2 "+(l?"cursor-help":""),title:l,children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"icon-xs text-icon-widget",children:t}),e.jsx("span",{className:"type-label text-text-secondary",children:s})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("span",{className:"type-data-sm "+(i?"text-accent-tertiary":"text-text-primary"),children:a}),n&&e.jsx("span",{className:"type-data-xs text-text-muted ml-1",children:n})]})]})}function Ie(){const t=S(),s=$().length;if(!t||0===t.totalPaths)return null;const{totalPaths:a,pathsWithGhosts:n,observationOverrideCount:i,tracePacketsProcessed:l,pathPacketsProcessed:r,distantEdgesDiscovered:o,duplicateGroupsFound:c,duplicatePathsUnique:d,echolocationEdgesInferred:b}=t,y=a-n,v=a>0?(y/a*100).toFixed(1):"0",N=a>0?(n/a*100).toFixed(1):"0",w=a>0?(i/a*100).toFixed(1):"0",k=l+r,M=k>0||o>0,C=c>0||b>0;return e.jsxs(ae,{children:[e.jsx(ne,{title:"Viterbi HMM",icon:e.jsx(m,{}),largeTitle:!0,badge:s>0?`${s} GHOSTS`:void 0}),e.jsxs(de,{children:[e.jsxs("div",{className:"divide-y divide-white/5",children:[e.jsx(Xe,{icon:e.jsx(m,{className:"w-3.5 h-3.5"}),label:"Paths Decoded",value:a.toLocaleString(),tooltip:"Total packet paths analyzed by the Viterbi HMM algorithm. Each path is a sequence of node prefixes extracted from received packets."}),e.jsx(Xe,{icon:e.jsx(h,{className:"w-3.5 h-3.5"}),label:"Paths with Ghosts",value:n.toLocaleString(),sublabel:`(${N}%)`,highlight:n>0,tooltip:"Paths containing prefixes that don't match any known node. These 'ghost' prefixes may represent repeaters not yet discovered via direct ADVERT."}),e.jsx(Xe,{icon:e.jsx(x,{className:"w-3.5 h-3.5"}),label:"Observation Override",value:`${w}%`,sublabel:"of paths",tooltip:"Percentage of paths where real-world observations (signal strength, co-occurrence patterns) overrode the expected geographic transition model. Higher values indicate the algorithm is learning from actual mesh behavior."}),e.jsx(Xe,{icon:e.jsx(u,{className:"w-3.5 h-3.5"}),label:"Fully Resolved",value:`${v}%`,sublabel:`(${y.toLocaleString()} paths)`,highlight:parseFloat(v)>=90,tooltip:"Percentage of paths where all node prefixes were successfully matched to known nodes. Higher values indicate better mesh visibility - the algorithm can identify every hop in the packet's journey."})]}),M&&e.jsxs("div",{className:"mt-3 pt-3 border-t border-border-subtle",children:[e.jsx("p",{className:"type-micro mb-2",children:"Distant Topology"}),e.jsxs("div",{className:"divide-y divide-white/5",children:[e.jsx(Xe,{icon:e.jsx(p,{className:"w-3.5 h-3.5"}),label:"TRACE/PATH Packets",value:k.toLocaleString(),sublabel:l>0?`(${l} TRACE)`:void 0,tooltip:"TRACE and PATH packets contain pre-computed routes between distant nodes. These reveal mesh topology beyond what we can directly observe - edges between nodes that may never communicate with us."}),e.jsx(Xe,{icon:e.jsx(f,{className:"w-3.5 h-3.5"}),label:"Distant Edges",value:o.toLocaleString(),highlight:o>0,tooltip:"Edges discovered from TRACE/PATH packet route data. These represent links between distant nodes that we wouldn't see from normal packet forwarding - revealing deeper mesh structure."})]})]}),C&&e.jsxs("div",{className:"mt-3 pt-3 border-t border-border-subtle",children:[e.jsx("p",{className:"type-micro mb-2",children:"Echolocation"}),e.jsxs("div",{className:"divide-y divide-white/5",children:[e.jsx(Xe,{icon:e.jsx(g,{className:"w-3.5 h-3.5"}),label:"Duplicate Groups",value:c.toLocaleString(),sublabel:d>0?`(${d} paths)`:void 0,tooltip:"Packets received multiple times via different paths. Each duplicate is an 'echo' that reveals alternate routing through the mesh - like sonar mapping the network structure."}),e.jsx(Xe,{icon:e.jsx(j,{className:"w-3.5 h-3.5"}),label:"Echo Edges",value:b.toLocaleString(),highlight:b>0,tooltip:"Edges inferred from echolocation analysis. When the same packet arrives via different forwarders, those forwarders are likely within RF range of each other - revealing hidden mesh connectivity."})]})]}),e.jsx("div",{className:"mt-3 pt-3 border-t border-border-subtle cursor-help",title:"Ghost nodes are high-confidence unknown repeaters inferred from path analysis. They appear frequently in packet paths (10+ observations), have consistent neighbor relationships (2+ common neighbors), confidence score ≥30%, and have reasonable location estimates. Check the Contacts page to see them on the map.",children:e.jsxs("p",{className:"type-label text-text-muted",children:[e.jsx("span",{className:"text-accent-tertiary type-data-sm",children:s})," ","unknown repeater",1!==s?"s":""," discovered via HMM analysis"]})})]})]})}const Ye={1:3600,3:5400,12:5400,24:8640,72:14400,168:10080};function Ge(){var a,i,l,r,o;const c=T(),d=P(),m=R(),h=F(),[x,u]=t.useState(null),[p,f]=t.useState([]),[j,w]=t.useState(null),[k,M]=t.useState(null),[C,S]=t.useState(!0),[$,H]=t.useState(null),[z,B]=t.useState(3),[O,U]=t.useState("share"),[q,X]=t.useState(3),[I,Y]=t.useTransition(),G=t.useCallback(e=>{B(e),Y(()=>{X(e)})},[]),J=E[q].hours,K=60*J,Q=Ye[J]??720,V=t.useMemo(()=>0===h.length?null:A(K,Q,h,c),[h,K,Q,c]),{utilSamples:Z,startTs:ee,endTs:te}=t.useMemo(()=>{if(!V)return{utilSamples:[],startTs:0,endTs:0};const{received:e,transmitted:t,forwarded:s,bucket_duration_seconds:a,start_time:n,end_time:i}=V,l=1e3*a,r=function(e,t){const s=new Map;for(const a of e)s.set(a.start,{...a});for(const a of t){const e=s.get(a.start);e?(e.airtime_ms+=a.airtime_ms,e.count+=a.count):s.set(a.start,{...a})}return Array.from(s.values()).sort((e,t)=>e.start-t.start)}(t,s);return{utilSamples:ze(e,r,l),startTs:n,endTs:i}},[V]),se=t.useMemo(()=>0===Z.length?{peak:0,mean:0}:{peak:Math.max(...Z.map(e=>e.rxUtilW)),mean:Z.reduce((e,t)=>e+t.rxUtilW,0)/Z.length},[Z]);t.useEffect(()=>{!async function(){var e;H(null);try{const[t,s]=await Promise.all([L(J),W(J)]);t.success&&t.data&&u(t.data),s.success&&(null==(e=s.data)?void 0:e.history)&&f(s.data.history)}catch(t){H(t instanceof Error?t.message:"Failed to load chart data")}finally{S(!1)}}()},[J]);const re=t.useMemo(()=>{switch(J){case 72:return 6e5;case 168:return 18e5;default:return 3e5}},[J]),de=t.useCallback(async()=>{try{const e=await L(J);e.success&&e.data&&u(e.data)}catch{}},[J]),me=t.useCallback(async()=>{var e;try{const t=await W(J);t.success&&(null==(e=t.data)?void 0:e.history)&&f(t.data.history)}catch{}},[J]);_(de,re,!0,!0),_(me,re,!0,!0);const he=t.useMemo(()=>x&&x.series?x.series.map(e=>({name:e.name,value:e.data.reduce((e,t)=>e+(t[1]??0),0)})).filter(e=>e.value>0):[],[x]),xe=t.useMemo(()=>0===p.length?{timestamps:[],values:[]}:{timestamps:p.map(e=>e.timestamp),values:p.map(e=>e.noise_floor_dbm)},[p]),pe=E[z],fe=t.useMemo(()=>{const e=(null==c?void 0:c.neighbors)??{};return Object.fromEntries(Object.entries(e).filter(([e])=>!d.has(e)))},[null==c?void 0:c.neighbors,d]),ge=t.useMemo(()=>{const e=Date.now()/1e3-3600*J;return Object.fromEntries(Object.entries(fe).filter(([,t])=>t.last_seen>=e))},[fe,J]),je=t.useMemo(()=>{var e;const t=null==(e=null==c?void 0:c.config)?void 0:e.radio;return{sf:(null==t?void 0:t.spreading_factor)??10,bw:(null==t?void 0:t.bandwidth)??25e4,cr:(null==t?void 0:t.coding_rate)??5,preamble:(null==t?void 0:t.preamble_length)??8}},[null==(a=null==c?void 0:c.config)?void 0:a.radio]),ve=t.useMemo(()=>0===h.length||0===ee?[]:h.filter(e=>e.timestamp>=ee&&e.timestamp<te),[h,ee,te]),Ne=Q;return e.jsxs(ie,{children:[e.jsx(le,{title:"Statistics",icon:e.jsx(b,{}),controls:e.jsxs("div",{className:"flex items-center gap-2",children:[I&&e.jsx("span",{className:"text-xs text-text-muted animate-pulse",children:"Loading..."}),e.jsx(D,{ranges:E,selectedIndex:z,onSelect:G})]})}),$&&e.jsx(ae,{className:"border border-accent-red/50 bg-accent-red/10",children:e.jsx("p",{className:"text-accent-red",children:$})}),C?e.jsx(oe,{template:"auto",children:e.jsx(ae,{className:"text-center py-12",children:e.jsx("div",{className:"animate-pulse text-text-muted",children:"Loading statistics..."})})}):e.jsxs(e.Fragment,{children:[e.jsx(oe,{template:"hero",children:e.jsxs(ae,{children:[e.jsx(ne,{icon:e.jsx(s,{}),title:"Type Distribution",badge:pe.label,largeTitle:!0,actions:e.jsx(be,{mode:O,onChange:U})}),e.jsx("div",{className:"flex-1 min-h-0",children:e.jsx(ye,{packets:ve,startTs:ee,endTs:te,bucketCount:Ne,radioConfig:je,mode:O})})]})}),e.jsxs(oe,{template:"panel",children:[e.jsx(ce,{span:12,md:6,children:e.jsxs(ae,{children:[e.jsx(ne,{icon:e.jsx(y,{}),title:"Airtime Utilization",badge:pe.label,largeTitle:!0,actions:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("span",{className:"type-data-xs text-text-muted",children:["Peak ",e.jsxs("span",{className:"text-text-secondary tabular-nums font-medium",children:[se.peak.toFixed(2),"%"]})]}),e.jsxs("span",{className:"type-data-xs text-text-muted",children:["Mean ",e.jsxs("span",{className:"text-text-secondary tabular-nums font-medium",children:[se.mean.toFixed(2),"%"]})]})]})}),e.jsx("div",{className:"flex-1 min-h-0",children:e.jsx(Ce,{samples:Z,startTs:ee,endTs:te})})]})}),e.jsx(ce,{span:12,md:6,children:e.jsxs(ae,{children:[e.jsx(ne,{icon:e.jsx(n,{}),title:"Link Quality",badge:pe.label,largeTitle:!0,actions:k?e.jsxs("div",{className:"flex items-center gap-2 sm:gap-3 type-data-xs text-text-muted",children:[e.jsxs("span",{children:[e.jsx("span",{className:"text-text-secondary tabular-nums font-medium",children:k.zeroHopCount})," nbr"]}),e.jsxs("span",{children:[e.jsx("span",{className:"text-text-secondary tabular-nums font-medium",children:k.totalCount})," obs"]}),e.jsxs("span",{children:[e.jsx("span",{className:"text-text-secondary tabular-nums font-medium",children:k.maxDistanceKm.toFixed(0)})," km"]})]}):null}),e.jsx("div",{className:"flex-1 min-h-0",children:e.jsx(Ae,{neighbors:ge,quickNeighbors:m,localLat:(null==(l=null==(i=null==c?void 0:c.config)?void 0:i.repeater)?void 0:l.latitude)??0,localLon:(null==(o=null==(r=null==c?void 0:c.config)?void 0:r.repeater)?void 0:o.longitude)??0,onStatsChange:M})})]})})]}),e.jsxs(oe,{template:"panel",children:[e.jsx(ce,{span:12,md:6,children:e.jsxs(ae,{children:[e.jsx(ne,{icon:e.jsx(v,{}),title:"Packet Types",largeTitle:!0}),e.jsx("div",{className:"flex-1 min-h-0",children:he.length>0?e.jsx(ue,{data:he}):e.jsx("div",{className:"h-full flex items-center justify-center text-text-muted",children:"No packet type data available"})})]})}),e.jsx(ce,{span:12,md:6,children:e.jsxs(ae,{children:[e.jsx(ne,{icon:e.jsx(N,{}),title:"Network Composition",badge:pe.label,largeTitle:!0}),e.jsx("div",{className:"flex-1 min-h-0",children:e.jsx(He,{neighbors:ge})})]})})]}),e.jsxs(oe,{template:"panel",children:[e.jsx(ce,{span:12,md:6,children:e.jsx(qe,{})}),e.jsx(ce,{span:12,md:6,children:e.jsx(Ie,{})})]}),e.jsx(oe,{template:"panel",children:e.jsx(ce,{span:12,children:e.jsxs(ae,{children:[e.jsx(ne,{icon:e.jsx(g,{}),title:"RF Noise Floor",largeTitle:!0,actions:j?e.jsxs("div",{className:"flex items-center gap-1.5 sm:gap-2 md:gap-3",children:[e.jsxs("span",{className:"type-data-xs text-text-muted whitespace-nowrap",children:["min ",e.jsx("span",{className:"text-text-secondary tabular-nums",children:j.min.toFixed(0)})]}),e.jsxs("span",{className:"type-data-xs text-text-muted whitespace-nowrap",children:["avg ",e.jsx("span",{className:"text-text-secondary tabular-nums",children:j.avg.toFixed(0)})]}),e.jsxs("span",{className:"type-data-xs text-text-muted whitespace-nowrap",children:["max ",e.jsx("span",{className:"text-text-secondary tabular-nums",children:j.max.toFixed(0)})]}),e.jsx("span",{className:"type-data-xs text-text-muted",children:"dBm"})]}):e.jsx("span",{className:"type-data-xs text-text-muted",children:"dBm"})}),e.jsx("div",{className:"flex-1 min-h-0",children:e.jsx(We,{timestamps:xe.timestamps,values:xe.values,onStatsChange:w})})]})})})]})]})}export{Ge as default};
